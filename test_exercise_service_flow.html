<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ØªØ³Øª Ø¬Ø±ÛŒØ§Ù† ØªÙ…Ø±ÛŒÙ† - Exercise Service Flow</title>
    <style>
        body {
            font-family: 'Vazir', 'Tahoma', sans-serif;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            margin: 0;
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 15px;
            box-sizing: border-box;
        }
        .test-container {
            max-width: 1100px;
            width: 100%;
            background: white;
            border-radius: 32px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.2);
        }
        .header {
            background: #2c3e50;
            color: white;
            padding: 25px 30px;
        }
        .header h1 {
            margin: 0;
            font-size: 28px;
            font-weight: 600;
            letter-spacing: 1px;
        }
        .header p {
            margin: 10px 0 0;
            opacity: 0.9;
            font-size: 16px;
        }
        .content {
            padding: 30px;
            background: #f8fafc;
        }
        .section {
            background: white;
            border-radius: 24px;
            padding: 25px;
            margin-bottom: 30px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.05);
            border: 1px solid #e9ecef;
        }
        .section h2 {
            margin: 0 0 20px 0;
            font-size: 22px;
            color: #1e293b;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .section h2:before {
            content: 'ğŸ§ª';
            font-size: 28px;
        }
        .step-indicator {
            background: #f1f5f9;
            border-radius: 100px;
            padding: 15px 25px;
            margin-bottom: 30px;
            display: flex;
            justify-content: space-between;
            border: 1px solid #cbd5e1;
        }
        .step {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
            flex: 1;
        }
        .step-number {
            width: 36px;
            height: 36px;
            background: #94a3b8;
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            transition: all 0.3s;
        }
        .step.active .step-number {
            background: #2563eb;
            transform: scale(1.1);
            box-shadow: 0 0 0 4px rgba(37,99,235,0.2);
        }
        .step.completed .step-number {
            background: #10b981;
        }
        .step-label {
            font-size: 13px;
            font-weight: 500;
            color: #334155;
        }
        .button-grid {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin: 25px 0 15px;
        }
        .btn {
            padding: 14px 28px;
            border: none;
            border-radius: 60px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
            border: 1px solid rgba(255,255,255,0.3);
        }
        .btn-primary {
            background: #2563eb;
            color: white;
        }
        .btn-primary:hover {
            background: #1d4ed8;
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(37,99,235,0.4);
        }
        .btn-success {
            background: #10b981;
            color: white;
        }
        .btn-success:hover {
            background: #059669;
        }
        .btn-warning {
            background: #f59e0b;
            color: white;
        }
        .btn-outline {
            background: transparent;
            border: 2px solid #2563eb;
            color: #2563eb;
            box-shadow: none;
        }
        .btn-outline:hover {
            background: #eef2ff;
        }
        .log-panel {
            background: #0f172a;
            color: #e2e8f0;
            border-radius: 20px;
            padding: 20px;
            font-family: 'Consolas', monospace;
            font-size: 14px;
            direction: ltr;
            text-align: left;
            max-height: 300px;
            overflow-y: auto;
            margin-top: 25px;
            border: 1px solid #334155;
            box-shadow: inset 0 0 10px rgba(0,0,0,0.5);
        }
        .log-entry {
            padding: 8px;
            border-bottom: 1px solid #334155;
            color: #a5f3fc;
        }
        .log-entry:last-child {
            border-bottom: none;
        }
        .log-entry.error {
            color: #fca5a5;
        }
        .log-entry.success {
            color: #86efac;
        }
        .data-view {
            background: #f1f5f9;
            border-radius: 16px;
            padding: 15px;
            font-family: 'Consolas', monospace;
            font-size: 13px;
            direction: ltr;
            border: 1px dashed #64748b;
            margin-top: 15px;
        }
        .flex-row {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            align-items: center;
        }
        .badge {
            background: #e2e8f0;
            padding: 6px 12px;
            border-radius: 40px;
            font-size: 13px;
            font-weight: 600;
            color: #334155;
        }
        hr {
            border: none;
            border-top: 2px dashed #cbd5e1;
            margin: 25px 0;
        }
    </style>
</head>
<body>
    <div class="test-container">
        <div class="header">
            <h1>ğŸ“‹ ØªØ³Øª Ø¬Ø±ÛŒØ§Ù† ØªÙ…Ø±ÛŒÙ† (Exercise Service Flow)</h1>
            <p>Ø´Ø¨ÛŒÙ‡â€ŒØ³Ø§Ø²ÛŒ Ø¯Ø³ØªÛŒ Ú¯Ø§Ù…â€ŒØ¨Ù‡â€ŒÚ¯Ø§Ù… ÙØ±Ø¢ÛŒÙ†Ø¯ ØªÙ…Ø±ÛŒÙ† - Ú©Ø§Ù…Ù„Ø§Ù‹ ØªØ¹Ø§Ù…Ù„ÛŒ Ø¨Ø§ Ø¯Ú©Ù…Ù‡â€ŒÙ‡Ø§</p>
        </div>
        <div class="content">
            <!-- Ù…Ø±Ø­Ù„Ù‡â€ŒÙ†Ù…Ø§ -->
            <div class="step-indicator" id="stepIndicator">
                <div class="step" data-step="1">
                    <span class="step-number">Û±</span>
                    <span class="step-label">Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ</span>
                </div>
                <div class="step" data-step="2">
                    <span class="step-number">Û²</span>
                    <span class="step-label">Ù†ÙˆØ¹ ØªÙ…Ø±ÛŒÙ†</span>
                </div>
                <div class="step" data-step="3">
                    <span class="step-number">Û³</span>
                    <span class="step-label">Ø§Ø¹ØªØ¨Ø§Ø±Ø³Ù†Ø¬ÛŒ</span>
                </div>
                <div class="step" data-step="4">
                    <span class="step-number">Û´</span>
                    <span class="step-label">Ø«Ø¨Øª Ù†ØªÛŒØ¬Ù‡</span>
                </div>
                <div class="step" data-step="5">
                    <span class="step-number">Ûµ</span>
                    <span class="step-label">SRS</span>
                </div>
                <div class="step" data-step="6">
                    <span class="step-number">Û¶</span>
                    <span class="step-label">Ø¨Ø§Ø²Ø®ÙˆØ±Ø¯</span>
                </div>
            </div>

            <!-- Ø¨Ø®Ø´ Û±: Ù…Ø§Ú˜ÙˆÙ„â€ŒÙ‡Ø§ÛŒ Ø¬Ø¹Ù„ÛŒ (Fake Modules) -->
            <div class="section">
                <h2>âš™ï¸ Ù…Ø§Ú˜ÙˆÙ„â€ŒÙ‡Ø§ÛŒ Ø¢Ù…Ø§Ø¯Ù‡</h2>
                <div class="flex-row">
                    <span class="badge">âœ… exerciseService</span>
                    <span class="badge">âœ… exerciseValidator</span>
                    <span class="badge">âœ… multipleChoice</span>
                    <span class="badge">âœ… flashcard</span>
                    <span class="badge">âœ… progressManager</span>
                    <span class="badge">âœ… srsEngine</span>
                </div>
                <div class="data-view" id="moduleStatus">
{
  "exerciseService": "Ø¢Ù…Ø§Ø¯Ù‡",
  "validator": "Ø¢Ù…Ø§Ø¯Ù‡",
  "multipleChoice": "Ø¢Ù…Ø§Ø¯Ù‡",
  "flashcard": "Ø¢Ù…Ø§Ø¯Ù‡",
  "progressManager": "Ø¢Ù…Ø§Ø¯Ù‡",
  "srsEngine": "Ø¢Ù…Ø§Ø¯Ù‡"
}
                </div>
            </div>

            <!-- Ø¨Ø®Ø´ Û²: Ú©Ù†ØªØ±Ù„ ØªØ³Øª -->
            <div class="section">
                <h2>ğŸ® Ú©Ù†ØªØ±Ù„ Ø¬Ø±ÛŒØ§Ù† ØªÙ…Ø±ÛŒÙ†</h2>
                <div class="button-grid">
                    <button class="btn btn-primary" id="loadLessonBtn">ğŸ“¥ Û±. Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø¯Ø±Ø³ Ù†Ù…ÙˆÙ†Ù‡</button>
                    <button class="btn btn-primary" id="selectExerciseBtn">Û². Ø§Ù†ØªØ®Ø§Ø¨ Ù†ÙˆØ¹ ØªÙ…Ø±ÛŒÙ†</button>
                    <button class="btn btn-primary" id="generateExerciseBtn">âš¡ Û³. ØªÙˆÙ„ÛŒØ¯ ØªÙ…Ø±ÛŒÙ†</button>
                    <button class="btn btn-success" id="validateCorrectBtn">âœ… Û´. Ø§Ø±Ø³Ø§Ù„ Ù¾Ø§Ø³Ø® ØµØ­ÛŒØ­</button>
                    <button class="btn btn-warning" id="validateWrongBtn">âŒ Û´. Ø§Ø±Ø³Ø§Ù„ Ù¾Ø§Ø³Ø® ØºÙ„Ø·</button>
                    <button class="btn btn-outline" id="saveProgressBtn">ğŸ’¾ Ûµ. Ø°Ø®ÛŒØ±Ù‡ Ù¾ÛŒØ´Ø±ÙØª</button>
                    <button class="btn btn-outline" id="runSrsBtn">ğŸ§  Û¶. Ø§Ø¹Ù…Ø§Ù„ SRS</button>
                    <button class="btn btn-outline" id="showFeedbackBtn">ğŸ“¢ Û·. Ù†Ù…Ø§ÛŒØ´ Ø¨Ø§Ø²Ø®ÙˆØ±Ø¯</button>
                </div>
                <div class="flex-row" style="margin-top: 20px;">
                    <button class="btn btn-outline" id="resetFlowBtn">âŸ² Ø±ÛŒØ³Øª Ø¬Ø±ÛŒØ§Ù†</button>
                    <button class="btn btn-outline" id="clearLogBtn">ğŸ—‘ Ù¾Ø§Ú© Ú©Ø±Ø¯Ù† Ù„Ø§Ú¯</button>
                </div>

                <!-- Ù†Ù…Ø§ÛŒØ´ ÙˆØ¶Ø¹ÛŒØª ÙØ¹Ù„ÛŒ -->
                <hr>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                    <div>
                        <h3 style="margin: 0 0 10px 0;">ğŸ“Œ ÙˆØ¶Ø¹ÛŒØª Ø¬Ù„Ø³Ù‡</h3>
                        <div class="data-view" id="sessionState">
{
  "currentLesson": null,
  "exerciseType": null,
  "currentExercise": null,
  "lastAnswer": null,
  "isCorrect": null,
  "progress": {}
}
                        </div>
                    </div>
                    <div>
                        <h3 style="margin: 0 0 10px 0;">ğŸ“Š Ø¢Ø®Ø±ÛŒÙ† Ø®Ø±ÙˆØ¬ÛŒ</h3>
                        <div class="data-view" id="lastOutput">
{
  "output": "Ù…Ù†ØªØ¸Ø± Ø¹Ù…Ù„ÛŒØ§Øª..."
}
                        </div>
                    </div>
                </div>
            </div>

            <!-- Ø¨Ø®Ø´ Û³: Ù„Ø§Ú¯ ØªØ³Øª -->
            <div class="section">
                <h2>ğŸ“‹ Ú¯Ø²Ø§Ø±Ø´ Ú¯Ø§Ù…â€ŒØ¨Ù‡â€ŒÚ¯Ø§Ù… (Log)</h2>
                <div class="log-panel" id="logPanel">
                    <div class="log-entry">ğŸŸ¢ Ø¢Ù…Ø§Ø¯Ù‡â€ŒØ³Ø§Ø²ÛŒ Ù…Ø§Ú˜ÙˆÙ„â€ŒÙ‡Ø§ Ø§Ù†Ø¬Ø§Ù… Ø´Ø¯.</div>
                    <div class="log-entry">â³ Ù…Ù†ØªØ¸Ø± ØªØ¹Ø§Ù…Ù„ Ú©Ø§Ø±Ø¨Ø±...</div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ==================== Ù…Ø§Ú˜ÙˆÙ„â€ŒÙ‡Ø§ÛŒ Ø¬Ø¹Ù„ÛŒ Ø­Ø±ÙÙ‡â€ŒØ§ÛŒ ====================
        
        // Û±. Ù…Ø§Ú˜ÙˆÙ„ Ø¯Ø±Ø³ Ù†Ù…ÙˆÙ†Ù‡
        const fakeLessonModule = {
            getSampleLesson: () => ({
                id: 'lesson_1',
                title: 'Lesson 1: Greetings',
                exercises: [
                    { id: 'ex1', type: 'multiple-choice', question: 'Hello', options: ['Ø³Ù„Ø§Ù…', 'Ø®Ø¯Ø§Ø­Ø§ÙØ¸', 'ØµØ¨Ø­ Ø¨Ø®ÛŒØ±', 'Ø´Ø¨ Ø¨Ø®ÛŒØ±'], correct: 0 },
                    { id: 'ex2', type: 'flashcard', front: 'Good morning', back: 'ØµØ¨Ø­ Ø¨Ø®ÛŒØ±' },
                    { id: 'ex3', type: 'multiple-choice', question: 'Goodbye', options: ['Ø³Ù„Ø§Ù…', 'Ø®Ø¯Ø§Ø­Ø§ÙØ¸', 'ØµØ¨Ø­ Ø¨Ø®ÛŒØ±', 'Ø´Ø¨ Ø¨Ø®ÛŒØ±'], correct: 1 },
                ]
            })
        };

        // Û². Ø³Ø±ÙˆÛŒØ³ ØªÙ…Ø±ÛŒÙ† (Exercise Service) - Ø¨Ø§ Ù‚Ø§Ø¨Ù„ÛŒØª ØªØ²Ø±ÛŒÙ‚ ÙˆØ§Ø¨Ø³ØªÚ¯ÛŒ
        const exerciseService = (function() {
            let currentLesson = null;
            let currentExercise = null;
            let exerciseType = 'multiple-choice'; // Ù¾ÛŒØ´â€ŒÙØ±Ø¶
            
            return {
                loadLesson: (lessonId) => {
                    try {
                        currentLesson = fakeLessonModule.getSampleLesson();
                        currentExercise = null;
                        logMessage(`ğŸ“š Ø¯Ø±Ø³ "${currentLesson.title}" Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø´Ø¯ (${currentLesson.exercises.length} ØªÙ…Ø±ÛŒÙ†)`);
                        updateSessionState({ currentLesson, exerciseType: null, currentExercise: null });
                        return { success: true, lesson: currentLesson };
                    } catch (e) {
                        logMessage(`âŒ Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø¯Ø±Ø³: ${e.message}`, 'error');
                        return { success: false, error: e.message };
                    }
                },
                setExerciseType: (type) => {
                    if (!currentLesson) {
                        logMessage('âš ï¸ Ø§Ø¨ØªØ¯Ø§ Ø¯Ø±Ø³ Ø±Ø§ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ú©Ù†ÛŒØ¯', 'error');
                        return { success: false };
                    }
                    if (!['multiple-choice', 'flashcard'].includes(type)) {
                        logMessage('âš ï¸ Ù†ÙˆØ¹ ØªÙ…Ø±ÛŒÙ† Ù†Ø§Ù…Ø¹ØªØ¨Ø±', 'error');
                        return { success: false };
                    }
                    exerciseType = type;
                    // ÙÛŒÙ„ØªØ± ØªÙ…Ø±ÛŒÙ†â€ŒÙ‡Ø§ Ø¨Ø± Ø§Ø³Ø§Ø³ Ù†ÙˆØ¹
                    const available = currentLesson.exercises.filter(ex => ex.type === type);
                    logMessage(`ğŸ¯ Ù†ÙˆØ¹ ØªÙ…Ø±ÛŒÙ† "${type}" Ø§Ù†ØªØ®Ø§Ø¨ Ø´Ø¯ (${available.length} ØªÙ…Ø±ÛŒÙ† Ù…ÙˆØ¬ÙˆØ¯)`);
                    updateSessionState({ exerciseType: type });
                    return { success: true, count: available.length };
                },
                generateExercise: () => {
                    if (!currentLesson) {
                        logMessage('âš ï¸ Ø§Ø¨ØªØ¯Ø§ Ø¯Ø±Ø³ Ø±Ø§ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ú©Ù†ÛŒØ¯', 'error');
                        return { success: false };
                    }
                    const filtered = currentLesson.exercises.filter(ex => ex.type === exerciseType);
                    if (filtered.length === 0) {
                        logMessage(`âš ï¸ ØªÙ…Ø±ÛŒÙ†ÛŒ Ø§Ø² Ù†ÙˆØ¹ "${exerciseType}" ÛŒØ§ÙØª Ù†Ø´Ø¯`, 'error');
                        return { success: false };
                    }
                    // Ø§Ù†ØªØ®Ø§Ø¨ ØªØµØ§Ø¯ÙÛŒ Ø³Ø§Ø¯Ù‡
                    const randomIndex = Math.floor(Math.random() * filtered.length);
                    currentExercise = { ...filtered[randomIndex] }; // Ú©Ù¾ÛŒ
                    logMessage(`ğŸ”§ ØªÙ…Ø±ÛŒÙ† Ø¬Ø¯ÛŒØ¯ ØªÙˆÙ„ÛŒØ¯ Ø´Ø¯: ${currentExercise.question || currentExercise.front}`);
                    updateSessionState({ currentExercise });
                    return { success: true, exercise: currentExercise };
                },
                validateAnswer: (answer) => {
                    if (!currentExercise) {
                        logMessage('âš ï¸ ØªÙ…Ø±ÛŒÙ†ÛŒ ÙØ¹Ø§Ù„ Ù†ÛŒØ³Øª', 'error');
                        return { success: false };
                    }
                    
                    let isValid = false;
                    // Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø§Ø² validator Ø¬Ø¹Ù„ÛŒ
                    if (currentExercise.type === 'multiple-choice') {
                        isValid = (answer === currentExercise.correct);
                        logMessage(`ğŸ“ Ù¾Ø§Ø³Ø® ${isValid ? 'âœ… ØµØ­ÛŒØ­' : 'âŒ ØºÙ„Ø·'} Ø¨Ø±Ø§ÛŒ Ú†Ù†Ø¯Ú¯Ø²ÛŒÙ†Ù‡â€ŒØ§ÛŒ`);
                    } else if (currentExercise.type === 'flashcard') {
                        // Ù…Ù‚Ø§ÛŒØ³Ù‡ Ø³Ø§Ø¯Ù‡ (Ø¯Ø± ÙˆØ§Ù‚Ø¹ÛŒØª Ø¨Ø§ÛŒØ¯ Ø§Ø² validator Ø­Ø±ÙÙ‡â€ŒØ§ÛŒ Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø´ÙˆØ¯)
                        isValid = answer.trim().toLowerCase() === currentExercise.back.trim().toLowerCase();
                        logMessage(`ğŸ“ Ù¾Ø§Ø³Ø® ${isValid ? 'âœ… ØµØ­ÛŒØ­' : 'âŒ ØºÙ„Ø·'} Ø¨Ø±Ø§ÛŒ ÙÙ„Ø´â€ŒÚ©Ø§Ø±Øª`);
                    }
                    
                    updateSessionState({ lastAnswer: answer, isCorrect: isValid });
                    return { success: true, isValid, exercise: currentExercise };
                },
                getCurrentExercise: () => currentExercise,
                getLesson: () => currentLesson
            };
        })();

        // Û³. Ø§Ø¹ØªØ¨Ø§Ø±Ø³Ù†Ø¬ (Validator) - ØªØ§Ø¨Ø¹ Ù…Ø­Ø¶
        const exerciseValidator = {
            validateMultipleChoice: (selectedIndex, correctIndex) => selectedIndex === correctIndex,
            validateFlashcard: (userAnswer, correctAnswer) => userAnswer.trim().toLowerCase() === correctAnswer.trim().toLowerCase(),
            // Ù…ÛŒâ€ŒØªÙˆØ§Ù† Ù„ÙˆÙ†Ø§Ø´ØªØ§ÛŒÙ† Ùˆ... Ø§Ø¶Ø§ÙÙ‡ Ú©Ø±Ø¯
        };

        // Û´. Progress Manager Ø¬Ø¹Ù„ÛŒ
        const progressManager = (function() {
            let progress = { completed: 0, total: 0, lastScore: null };
            return {
                updateProgress: (isCorrect) => {
                    progress.completed += 1;
                    progress.total += 1;
                    progress.lastScore = isCorrect ? 100 : 0;
                    logMessage(`ğŸ“ˆ Ù¾ÛŒØ´Ø±ÙØª Ø¨Ù‡â€ŒØ±ÙˆØ² Ø´Ø¯: ${progress.completed}/${progress.total}`);
                    return progress;
                },
                getProgress: () => ({ ...progress })
            };
        })();

        // Ûµ. SRS Engine Ø¬Ø¹Ù„ÛŒ
        const srsEngine = {
            applyReview: (quality) => {
                // Ú©ÛŒÙÛŒØª Û°-Ûµ
                const intervals = [1, 3, 7, 16, 35, 70]; // Ø±ÙˆØ²
                const nextInterval = intervals[quality] || 1;
                logMessage(`ğŸ§  SRS: Ú©ÛŒÙÛŒØª ${quality} â†’ Ù…Ø±ÙˆØ± Ø¨Ø¹Ø¯ÛŒ ${nextInterval} Ø±ÙˆØ² Ø¯ÛŒÚ¯Ø±`);
                return { nextReviewDays: nextInterval };
            }
        };

        // ==================== ÙˆØ¶Ø¹ÛŒØª Ùˆ UI ====================
        let session = {
            currentLesson: null,
            exerciseType: null,
            currentExercise: null,
            lastAnswer: null,
            isCorrect: null,
            progress: {}
        };

        function updateSessionState(updates) {
            session = { ...session, ...updates };
            document.getElementById('sessionState').innerText = JSON.stringify(session, null, 2);
        }

        function logMessage(msg, type = 'info') {
            const panel = document.getElementById('logPanel');
            const entry = document.createElement('div');
            entry.className = 'log-entry ' + (type === 'error' ? 'error' : (type === 'success' ? 'success' : ''));
            entry.textContent = `[${new Date().toLocaleTimeString()}] ${msg}`;
            panel.appendChild(entry);
            panel.scrollTop = panel.scrollHeight;
            
            // Ù†Ù…Ø§ÛŒØ´ Ø¢Ø®Ø±ÛŒÙ† Ø®Ø±ÙˆØ¬ÛŒ
            document.getElementById('lastOutput').innerText = JSON.stringify({ output: msg, type }, null, 2);
            
            // Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ù…Ø±Ø­Ù„Ù‡â€ŒÙ†Ù…Ø§
            updateStepIndicator();
        }

        function updateStepIndicator() {
            // Ù…Ù†Ø·Ù‚ Ø³Ø§Ø¯Ù‡ Ø¨Ø±Ø§ÛŒ Ù…Ø´Ø®Øµ Ú©Ø±Ø¯Ù† Ù…Ø±Ø­Ù„Ù‡ ÙØ¹Ø§Ù„
            const steps = document.querySelectorAll('.step');
            steps.forEach(s => s.classList.remove('active', 'completed'));
            
            if (session.currentLesson) steps[0]?.classList.add('completed');
            if (session.exerciseType) steps[1]?.classList.add('completed');
            if (session.currentExercise) steps[2]?.classList.add('completed');
            if (session.lastAnswer !== null) steps[3]?.classList.add('completed');
            if (session.progress.completed) steps[4]?.classList.add('completed');
            // Ù…Ø±Ø­Ù„Ù‡ Ûµ (SRS) Ùˆ Û¶ (Ø¨Ø§Ø²Ø®ÙˆØ±Ø¯) Ø¨Ù‡ ØµÙˆØ±Øª Ø¯Ø³ØªÛŒ ØªØ¹ÛŒÛŒÙ† Ù…ÛŒâ€ŒØ´ÙˆØ¯
        }

        // ==================== Event Handlers ====================
        document.getElementById('loadLessonBtn').addEventListener('click', () => {
            const res = exerciseService.loadLesson('lesson_1');
            if (res.success) {
                session.currentLesson = res.lesson;
                updateSessionState({ currentLesson: res.lesson });
                logMessage('âœ… Ø¯Ø±Ø³ Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø´Ø¯', 'success');
            }
        });

        document.getElementById('selectExerciseBtn').addEventListener('click', () => {
            const type = Math.random() > 0.5 ? 'multiple-choice' : 'flashcard';
            const res = exerciseService.setExerciseType(type);
            if (res.success) {
                session.exerciseType = type;
                updateSessionState({ exerciseType: type });
            }
        });

        document.getElementById('generateExerciseBtn').addEventListener('click', () => {
            const res = exerciseService.generateExercise();
            if (res.success) {
                session.currentExercise = res.exercise;
                updateSessionState({ currentExercise: res.exercise });
            }
        });

        document.getElementById('validateCorrectBtn').addEventListener('click', () => {
            const ex = exerciseService.getCurrentExercise();
            if (!ex) { logMessage('âš ï¸ ØªÙ…Ø±ÛŒÙ†ÛŒ ÙˆØ¬ÙˆØ¯ Ù†Ø¯Ø§Ø±Ø¯', 'error'); return; }
            
            let answer;
            if (ex.type === 'multiple-choice') {
                answer = ex.correct; // Ø´Ø§Ø®Øµ ØµØ­ÛŒØ­
            } else {
                answer = ex.back; // Ù¾Ø§Ø³Ø® ØµØ­ÛŒØ­
            }
            
            const res = exerciseService.validateAnswer(answer);
            if (res.success) {
                session.isCorrect = res.isValid;
                session.lastAnswer = answer;
                updateSessionState({ isCorrect: res.isValid, lastAnswer: answer });
                logMessage(`âœ… Ù¾Ø§Ø³Ø® ØµØ­ÛŒØ­ Ø§Ø±Ø³Ø§Ù„ Ø´Ø¯ (Ù†ØªÛŒØ¬Ù‡: ${res.isValid})`, 'success');
            }
        });

        document.getElementById('validateWrongBtn').addEventListener('click', () => {
            const ex = exerciseService.getCurrentExercise();
            if (!ex) { logMessage('âš ï¸ ØªÙ…Ø±ÛŒÙ†ÛŒ ÙˆØ¬ÙˆØ¯ Ù†Ø¯Ø§Ø±Ø¯', 'error'); return; }
            
            let answer;
            if (ex.type === 'multiple-choice') {
                answer = (ex.correct + 1) % ex.options.length; // Ú¯Ø²ÛŒÙ†Ù‡ Ø§Ø´ØªØ¨Ø§Ù‡
            } else {
                answer = 'ØºÙ„Ø·';
            }
            
            const res = exerciseService.validateAnswer(answer);
            if (res.success) {
                session.isCorrect = res.isValid;
                session.lastAnswer = answer;
                updateSessionState({ isCorrect: res.isValid, lastAnswer: answer });
                logMessage(`âŒ Ù¾Ø§Ø³Ø® ØºÙ„Ø· Ø§Ø±Ø³Ø§Ù„ Ø´Ø¯ (Ù†ØªÛŒØ¬Ù‡: ${res.isValid})`, 'error');
            }
        });

        document.getElementById('saveProgressBtn').addEventListener('click', () => {
            if (session.isCorrect === null) {
                logMessage('âš ï¸ Ø§Ø¨ØªØ¯Ø§ Ø¨Ù‡ ØªÙ…Ø±ÛŒÙ† Ù¾Ø§Ø³Ø® Ø¯Ù‡ÛŒØ¯', 'error');
                return;
            }
            const prog = progressManager.updateProgress(session.isCorrect);
            session.progress = prog;
            updateSessionState({ progress: prog });
            logMessage(`ğŸ’¾ Ù¾ÛŒØ´Ø±ÙØª Ø°Ø®ÛŒØ±Ù‡ Ø´Ø¯: ${prog.completed}/${prog.total}`, 'success');
        });

        document.getElementById('runSrsBtn').addEventListener('click', () => {
            if (session.isCorrect === null) {
                logMessage('âš ï¸ Ø¨Ø±Ø§ÛŒ Ø§Ø¹Ù…Ø§Ù„ SRS Ù†ÛŒØ§Ø² Ø¨Ù‡ Ù¾Ø§Ø³Ø® Ø§Ø³Øª', 'error');
                return;
            }
            const quality = session.isCorrect ? 5 : 1; // Ú©ÛŒÙÛŒØª Ø¨Ø± Ø§Ø³Ø§Ø³ ØµØ­Øª
            const srsResult = srsEngine.applyReview(quality);
            logMessage(`ğŸ§  SRS Ø§Ø¹Ù…Ø§Ù„ Ø´Ø¯: Ù…Ø±ÙˆØ± Ø¨Ø¹Ø¯ÛŒ ${srsResult.nextReviewDays} Ø±ÙˆØ² Ø¯ÛŒÚ¯Ø±`, 'success');
        });

        document.getElementById('showFeedbackBtn').addEventListener('click', () => {
            if (session.isCorrect === null) {
                logMessage('â„¹ï¸ Ø¨Ø§Ø²Ø®ÙˆØ±Ø¯: Ù‡Ù†ÙˆØ² Ù¾Ø§Ø³Ø®ÛŒ Ø«Ø¨Øª Ù†Ø´Ø¯Ù‡', 'info');
            } else {
                const msg = session.isCorrect ? 'ğŸ‰ Ø¢ÙØ±ÛŒÙ†! Ù¾Ø§Ø³Ø® Ø´Ù…Ø§ ØµØ­ÛŒØ­ Ø¨ÙˆØ¯.' : 'ğŸ“˜ Ù¾Ø§Ø³Ø® ØµØ­ÛŒØ­ Ø±Ø§ Ù…Ø±ÙˆØ± Ú©Ù†ÛŒØ¯.';
                logMessage(`ğŸ“¢ Ø¨Ø§Ø²Ø®ÙˆØ±Ø¯: ${msg}`, session.isCorrect ? 'success' : 'error');
            }
        });

        document.getElementById('resetFlowBtn').addEventListener('click', () => {
            session = {
                currentLesson: null,
                exerciseType: null,
                currentExercise: null,
                lastAnswer: null,
                isCorrect: null,
                progress: {}
            };
            updateSessionState(session);
            logMessage('ğŸ”„ Ø¬Ø±ÛŒØ§Ù† Ø±ÛŒØ³Øª Ø´Ø¯. Ø§Ø² Ù…Ø±Ø­Ù„Ù‡ Ø§ÙˆÙ„ Ø´Ø±ÙˆØ¹ Ú©Ù†ÛŒØ¯.');
        });

        document.getElementById('clearLogBtn').addEventListener('click', () => {
            document.getElementById('logPanel').innerHTML = '<div class="log-entry">ğŸ§¹ Ù„Ø§Ú¯ Ù¾Ø§Ú© Ø´Ø¯.</div>';
            logMessage('ğŸ”„ Ø¢Ù…Ø§Ø¯Ù‡ Ø¨Ø±Ø§ÛŒ ØªØ³Øª Ø¬Ø¯ÛŒØ¯');
        });

        // Ù…Ù‚Ø¯Ø§Ø±Ø¯Ù‡ÛŒ Ø§ÙˆÙ„ÛŒÙ‡
        updateSessionState({});
        logMessage('ğŸš€ ØªØ³Øª Ø¬Ø±ÛŒØ§Ù† ØªÙ…Ø±ÛŒÙ† Ø¢Ù…Ø§Ø¯Ù‡ Ø§Ø³Øª. Ø¯Ú©Ù…Ù‡â€ŒÙ‡Ø§ Ø±Ø§ Ø¨Ù‡ ØªØ±ØªÛŒØ¨ ÙØ´Ø§Ø± Ø¯Ù‡ÛŒØ¯.');
    </script>
</body>
</html>
