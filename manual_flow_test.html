<!DOCTYPE html>
<html lang="fa">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Farsinglish - Manual Flow Test: Ø¬Ø±ÛŒØ§Ù† Ú©Ø§Ù…Ù„ Ú©Ø§Ø±Ø¨Ø±</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif;
            background: linear-gradient(135deg, #1a2f3f 0%, #2c4a5e 100%);
            color: #e0f2fe;
            padding: 20px;
        }
        .container { 
            max-width: 1000px; 
            margin: 0 auto;
            background: rgba(30, 50, 70, 0.95);
            border-radius: 20px;
            padding: 25px;
            box-shadow: 0 15px 40px rgba(0,0,0,0.6);
            border: 1px solid rgba(100, 180, 255, 0.2);
        }
        h1 { 
            text-align: center; 
            color: #b3e5fc;
            border-bottom: 3px solid #0288d1;
            padding-bottom: 15px;
            margin-bottom: 25px;
            font-size: 1.8rem;
        }
        .flow-card {
            background: rgba(20, 40, 60, 0.8);
            border-radius: 16px;
            padding: 20px;
            margin: 20px 0;
            border: 1px solid #4fc3f7;
            box-shadow: 0 5px 15px rgba(0,150,255,0.1);
        }
        .step {
            background: rgba(30, 60, 90, 0.7);
            margin: 18px 0;
            padding: 18px;
            border-radius: 12px;
            border-left: 6px solid #29b6f6;
            transition: all 0.2s;
        }
        .step:hover {
            background: rgba(40, 80, 120, 0.8);
            transform: translateX(5px);
        }
        .step-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
            font-size: 1.1rem;
            color: #b3e5fc;
        }
        .step-number {
            background: #0288d1;
            padding: 5px 15px;
            border-radius: 25px;
            font-weight: bold;
            color: white;
        }
        .step-title {
            font-weight: 700;
            font-size: 1.1rem;
        }
        .step-content {
            background: rgba(0, 0, 0, 0.3);
            padding: 15px;
            border-radius: 10px;
            font-family: 'Courier New', monospace;
            font-size: 0.9rem;
            color: #e1f5fe;
            margin-top: 10px;
            border: 1px solid #4fc3f7;
        }
        .btn {
            background: linear-gradient(45deg, #0288d1, #29b6f6);
            color: white;
            border: none;
            padding: 12px 28px;
            border-radius: 30px;
            font-size: 1rem;
            cursor: pointer;
            margin: 8px;
            font-weight: 600;
            transition: 0.3s;
            border: 1px solid rgba(255,255,255,0.2);
        }
        .btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(2,136,209,0.4);
        }
        .btn-warning {
            background: linear-gradient(45deg, #f57c00, #ffb74d);
        }
        .btn-success {
            background: linear-gradient(45deg, #2e7d32, #66bb6a);
        }
        .console {
            background: #0a1a1f;
            padding: 18px;
            border-radius: 12px;
            font-family: 'Courier New', monospace;
            font-size: 0.85rem;
            color: #a7ffeb;
            max-height: 300px;
            overflow-y: auto;
            margin-top: 25px;
            border: 1px solid #4dd0e1;
            line-height: 1.6;
        }
        .console-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            color: #80deea;
            font-weight: bold;
        }
        .badge {
            background: #006064;
            padding: 4px 12px;
            border-radius: 15px;
            font-size: 0.8rem;
        }
        .status-box {
            display: flex;
            justify-content: space-around;
            margin: 20px 0;
            padding: 15px;
            background: rgba(0,100,150,0.2);
            border-radius: 12px;
        }
        .status-item {
            text-align: center;
        }
        .status-label {
            font-size: 0.8rem;
            color: #80deea;
        }
        .status-value {
            font-size: 1.3rem;
            font-weight: bold;
            color: #b3e5fc;
        }
        @media (max-width: 600px) {
            .container { padding: 15px; }
            h1 { font-size: 1.5rem; }
            .step-header { flex-direction: column; align-items: flex-start; }
            .step-number { margin-bottom: 8px; }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ§ª ØªØ³Øª Ø¯Ø³ØªÛŒ Ø¬Ø±ÛŒØ§Ù† Ú©Ø§Ù…Ù„ Ú©Ø§Ø±Ø¨Ø± - Farsinglish</h1>
        
        <!-- ÙˆØ¶Ø¹ÛŒØª ÙØ¹Ù„ÛŒ Ø³ÛŒØ³ØªÙ… -->
        <div class="status-box">
            <div class="status-item">
                <div class="status-label">ğŸ‘¤ Ú©Ø§Ø±Ø¨Ø±</div>
                <div class="status-value" id="status-user">Ø®Ø±ÙˆØ¬</div>
            </div>
            <div class="status-item">
                <div class="status-label">ğŸ“š Ø¯Ø±Ø³ Ø¬Ø§Ø±ÛŒ</div>
                <div class="status-value" id="status-lesson">-</div>
            </div>
            <div class="status-item">
                <div class="status-label">ğŸ“Š Ù¾ÛŒØ´Ø±ÙØª</div>
                <div class="status-value" id="status-progress">0%</div>
            </div>
            <div class="status-item">
                <div class="status-label">ğŸ”„ SRS</div>
                <div class="status-value" id="status-srs">-</div>
            </div>
        </div>

        <!-- Ú¯Ø§Ù…â€ŒÙ‡Ø§ÛŒ Ø¬Ø±ÛŒØ§Ù† Ú©Ø§Ø±Ø¨Ø± -->
        <div class="flow-card">
            <h2 style="color: #81d4fa; margin-bottom: 20px;">ğŸ“‹ Ú¯Ø§Ù…â€ŒÙ‡Ø§ÛŒ ØªØ³Øª Ø¯Ø³ØªÛŒ</h2>
            
            <!-- Ú¯Ø§Ù… Û±: Ø§Ø­Ø±Ø§Ø² Ù‡ÙˆÛŒØª -->
            <div class="step" id="step1">
                <div class="step-header">
                    <span class="step-number">Ú¯Ø§Ù… Û±</span>
                    <span class="step-title">ğŸ” Ø§Ø­Ø±Ø§Ø² Ù‡ÙˆÛŒØª - Ø«Ø¨Øªâ€ŒÙ†Ø§Ù… / ÙˆØ±ÙˆØ¯</span>
                </div>
                <div class="step-content" id="step1-content">
                    <strong>ğŸŸ¡ ÙˆØ¶Ø¹ÛŒØª:</strong> Ú©Ø§Ø±Ø¨Ø± ÙˆØ§Ø±Ø¯ Ù†Ø´Ø¯Ù‡ Ø§Ø³Øª<br>
                    <strong>ğŸ“ Ø³Ù†Ø§Ø±ÛŒÙˆ:</strong> Ø«Ø¨Øªâ€ŒÙ†Ø§Ù… Ú©Ø§Ø±Ø¨Ø± Ø¬Ø¯ÛŒØ¯ + ÙˆØ±ÙˆØ¯ Ø®ÙˆØ¯Ú©Ø§Ø±
                </div>
                <div style="margin-top: 15px;">
                    <button class="btn" onclick="FlowTest.register()">ğŸ“ Ø«Ø¨Øªâ€ŒÙ†Ø§Ù… Ú©Ø§Ø±Ø¨Ø± Ø¬Ø¯ÛŒØ¯</button>
                    <button class="btn" onclick="FlowTest.login()">ğŸ”‘ ÙˆØ±ÙˆØ¯ Ú©Ø§Ø±Ø¨Ø± (test-user)</button>
                    <button class="btn btn-warning" onclick="FlowTest.logout()">ğŸšª Ø®Ø±ÙˆØ¬</button>
                </div>
            </div>

            <!-- Ú¯Ø§Ù… Û²: Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø¯Ø±Ø³ -->
            <div class="step" id="step2">
                <div class="step-header">
                    <span class="step-number">Ú¯Ø§Ù… Û²</span>
                    <span class="step-title">ğŸ“– Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø¯Ø±Ø³ Ùˆ ÙˆØ§Ú˜Ú¯Ø§Ù†</span>
                </div>
                <div class="step-content" id="step2-content">
                    <strong>ğŸŸ¡ ÙˆØ¶Ø¹ÛŒØª:</strong> Ø¯Ø±Ø³ÛŒ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ù†Ø´Ø¯Ù‡<br>
                    <strong>ğŸ“š Ø¯Ø±Ø³ Ù†Ù…ÙˆÙ†Ù‡:</strong> Ø­ÛŒÙˆØ§Ù†Ø§Øª (Ø³Ø·Ø­ Û±) - Ûµ ÙˆØ§Ú˜Ù‡
                </div>
                <div style="margin-top: 15px;">
                    <button class="btn" onclick="FlowTest.loadLesson()">ğŸ“‚ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø¯Ø±Ø³ Ù†Ù…ÙˆÙ†Ù‡</button>
                    <button class="btn" onclick="FlowTest.loadVocabulary()">ğŸ“œ Ù†Ù…Ø§ÛŒØ´ ÙˆØ§Ú˜Ú¯Ø§Ù† Ø¯Ø±Ø³</button>
                </div>
            </div>

            <!-- Ú¯Ø§Ù… Û³: ØªÙ…Ø±ÛŒÙ† Ùˆ Ù¾Ø§Ø³Ø®â€ŒØ¯Ù‡ÛŒ -->
            <div class="step" id="step3">
                <div class="step-header">
                    <span class="step-number">Ú¯Ø§Ù… Û³</span>
                    <span class="step-title">âœï¸ Ø§Ù†Ø¬Ø§Ù… ØªÙ…Ø±ÛŒÙ† Ùˆ Ø«Ø¨Øª Ù¾Ø§Ø³Ø®</span>
                </div>
                <div class="step-content" id="step3-content">
                    <strong>ğŸŸ¡ ÙˆØ¶Ø¹ÛŒØª:</strong> ØªÙ…Ø±ÛŒÙ†ÛŒ Ø´Ø±ÙˆØ¹ Ù†Ø´Ø¯Ù‡<br>
                    <strong>ğŸ¯ Ø³Ù†Ø§Ø±ÛŒÙˆ:</strong> Û´ Ù†ÙˆØ¹ ØªÙ…Ø±ÛŒÙ† + ØºÙ„Ø·â€ŒÚ¯ÛŒØ±ÛŒ Ø§Ù…Ù„Ø§ÛŒÛŒ
                </div>
                <div style="margin-top: 15px;">
                    <button class="btn" onclick="FlowTest.startExercise('mc')">âœ… Ú†Ù‡Ø§Ø±Ú¯Ø²ÛŒÙ†Ù‡â€ŒØ§ÛŒ</button>
                    <button class="btn" onclick="FlowTest.startExercise('fb')">ğŸ“ Ø¬Ø§ÛŒâ€ŒØ®Ø§Ù„ÛŒ</button>
                    <button class="btn" onclick="FlowTest.startExercise('tl')">ğŸŒ ØªØ±Ø¬Ù…Ù‡</button>
                    <button class="btn" onclick="FlowTest.startExercise('pr')">ğŸ¤ ØªÙ„ÙØ¸</button>
                </div>
            </div>

            <!-- Ú¯Ø§Ù… Û´: Ø°Ø®ÛŒØ±Ù‡ Ù¾ÛŒØ´Ø±ÙØª Ùˆ SRS -->
            <div class="step" id="step4">
                <div class="step-header">
                    <span class="step-number">Ú¯Ø§Ù… Û´</span>
                    <span class="step-title">ğŸ’¾ Ø°Ø®ÛŒØ±Ù‡ Ù¾ÛŒØ´Ø±ÙØª Ùˆ Ø§Ù„Ú¯ÙˆØ±ÛŒØªÙ… SRS</span>
                </div>
                <div class="step-content" id="step4-content">
                    <strong>ğŸŸ¡ ÙˆØ¶Ø¹ÛŒØª:</strong> Ù¾ÛŒØ´Ø±ÙØªÛŒ Ø«Ø¨Øª Ù†Ø´Ø¯Ù‡<br>
                    <strong>ğŸ§  SRS:</strong> Ù…Ø­Ø§Ø³Ø¨Ù‡ ÙØ§ØµÙ„Ù‡ Ù…Ø±ÙˆØ± Ø¨Ø¹Ø¯ÛŒ
                </div>
                <div style="margin-top: 15px;">
                    <button class="btn" onclick="FlowTest.saveProgress()">ğŸ’¾ Ø°Ø®ÛŒØ±Ù‡ Ù¾ÛŒØ´Ø±ÙØª</button>
                    <button class="btn" onclick="FlowTest.calculateSRS()">ğŸ§® Ù…Ø­Ø§Ø³Ø¨Ù‡ SRS</button>
                    <button class="btn" onclick="FlowTest.showProgress()">ğŸ“Š Ù†Ù…Ø§ÛŒØ´ Ù¾ÛŒØ´Ø±ÙØª</button>
                </div>
            </div>

            <!-- Ú¯Ø§Ù… Ûµ: Ù‡Ù…Ú¯Ø§Ù…â€ŒØ³Ø§Ø²ÛŒ Ùˆ Ù¾Ø§ÛŒØ¯Ø§Ø±ÛŒ -->
            <div class="step" id="step5">
                <div class="step-header">
                    <span class="step-number">Ú¯Ø§Ù… Ûµ</span>
                    <span class="step-title">ğŸ”„ Ù‡Ù…Ú¯Ø§Ù…â€ŒØ³Ø§Ø²ÛŒ Ùˆ Ù¾Ø§ÛŒØ¯Ø§Ø±ÛŒ</span>
                </div>
                <div class="step-content" id="step5-content">
                    <strong>ğŸŸ¡ ÙˆØ¶Ø¹ÛŒØª:</strong> Ù‡Ù…Ú¯Ø§Ù…â€ŒØ³Ø§Ø²ÛŒ Ø§Ù†Ø¬Ø§Ù… Ù†Ø´Ø¯Ù‡<br>
                    <strong>ğŸ“¶ Ø³Ù†Ø§Ø±ÛŒÙˆ:</strong> Ø´Ø¨ÛŒÙ‡â€ŒØ³Ø§Ø²ÛŒ Ø¢ÙÙ„Ø§ÛŒÙ†/Ø¢Ù†Ù„Ø§ÛŒÙ†
                </div>
                <div style="margin-top: 15px;">
                    <button class="btn" onclick="FlowTest.simulateOffline()">ğŸ”Œ Ø´Ø¨ÛŒÙ‡â€ŒØ³Ø§Ø²ÛŒ Ø¢ÙÙ„Ø§ÛŒÙ†</button>
                    <button class="btn" onclick="FlowTest.simulateOnline()">ğŸŒ Ø´Ø¨ÛŒÙ‡â€ŒØ³Ø§Ø²ÛŒ Ø¢Ù†Ù„Ø§ÛŒÙ†</button>
                    <button class="btn btn-success" onclick="FlowTest.syncData()">ğŸ”„ Ù‡Ù…Ú¯Ø§Ù…â€ŒØ³Ø§Ø²ÛŒ</button>
                </div>
            </div>
        </div>

        <!-- Ø¯Ú©Ù…Ù‡â€ŒÙ‡Ø§ÛŒ Ú©Ù†ØªØ±Ù„ Ú©Ù„ÛŒ -->
        <div style="display: flex; justify-content: center; gap: 15px; margin: 30px 0;">
            <button class="btn btn-success" onclick="FlowTest.runFullFlow()">ğŸš€ Ø§Ø¬Ø±Ø§ÛŒ Ø¬Ø±ÛŒØ§Ù† Ú©Ø§Ù…Ù„ Ø®ÙˆØ¯Ú©Ø§Ø±</button>
            <button class="btn btn-warning" onclick="FlowTest.resetAll()">ğŸ§¹ Ø±ÛŒØ³Øª Ú©Ø§Ù…Ù„ Ø³ÛŒØ³ØªÙ…</button>
            <button class="btn" onclick="FlowTest.clearConsole()">ğŸ—‘ï¸ Ù¾Ø§Ú© Ú©Ø±Ø¯Ù† Ú©Ù†Ø³ÙˆÙ„</button>
        </div>

        <!-- Ú©Ù†Ø³ÙˆÙ„ Ù†Ù…Ø§ÛŒØ´ Ù„Ø§Ú¯ -->
        <div class="console">
            <div class="console-header">
                <span>ğŸ“‹ Ú©Ù†Ø³ÙˆÙ„ ØªØ³Øª - Ø¬Ø±ÛŒØ§Ù† Ú©Ø§Ø±Ø¨Ø±</span>
                <span class="badge" id="log-count">0 Ø±ÙˆÛŒØ¯Ø§Ø¯</span>
            </div>
            <div id="console-output">
                [Ø³ÛŒØ³ØªÙ…] Ø¢Ù…Ø§Ø¯Ù‡ Ø§Ø¬Ø±Ø§ÛŒ ØªØ³Øª Ø¯Ø³ØªÛŒ - Ø±ÙˆÛŒ Ø¯Ú©Ù…Ù‡â€ŒÙ‡Ø§ Ú©Ù„ÛŒÚ© Ú©Ù†ÛŒØ¯
            </div>
        </div>
    </div>

    <script>
        // ==================== Ú©Ù„Ø§Ø³â€ŒÙ‡Ø§ÛŒ Ø§ØµÙ„ÛŒ Ø³ÛŒØ³ØªÙ… ====================
        
        // 1. Ø³Ø±ÙˆÛŒØ³ Ø§Ø­Ø±Ø§Ø² Ù‡ÙˆÛŒØª (Auth Service)
        class AuthService {
            constructor() {
                this.currentUser = null;
                this.users = new Map();
                this.loggedIn = false;
            }

            async register(username, password, email) {
                if (this.users.has(username)) {
                    return { success: false, error: 'Ù†Ø§Ù… Ú©Ø§Ø±Ø¨Ø±ÛŒ ØªÚ©Ø±Ø§Ø±ÛŒ Ø§Ø³Øª' };
                }
                
                const user = {
                    id: `user-${Date.now()}`,
                    username,
                    email,
                    password: this.hashPassword(password),
                    createdAt: Date.now(),
                    lastLogin: null
                };
                
                this.users.set(username, user);
                this.currentUser = user;
                this.loggedIn = true;
                user.lastLogin = Date.now();
                
                return { success: true, user: { ...user, password: undefined } };
            }

            async login(username, password) {
                const user = this.users.get(username);
                if (!user) {
                    return { success: false, error: 'Ú©Ø§Ø±Ø¨Ø± ÛŒØ§ÙØª Ù†Ø´Ø¯' };
                }
                
                if (user.password !== this.hashPassword(password)) {
                    return { success: false, error: 'Ø±Ù…Ø² Ø¹Ø¨ÙˆØ± Ø§Ø´ØªØ¨Ø§Ù‡ Ø§Ø³Øª' };
                }
                
                this.currentUser = user;
                this.loggedIn = true;
                user.lastLogin = Date.now();
                
                return { success: true, user: { ...user, password: undefined } };
            }

            logout() {
                this.currentUser = null;
                this.loggedIn = false;
                return { success: true };
            }

            getCurrentUser() {
                return this.currentUser ? { ...this.currentUser, password: undefined } : null;
            }

            isLoggedIn() {
                return this.loggedIn;
            }

            hashPassword(password) {
                let hash = 0;
                for (let i = 0; i < password.length; i++) {
                    const char = password.charCodeAt(i);
                    hash = ((hash << 5) - hash) + char;
                    hash = hash & hash;
                }
                return hash.toString(16);
            }
        }

        // 2. Ø³Ø±ÙˆÛŒØ³ Ø¯Ø±Ø³ (Lesson Service)
        class LessonService {
            constructor() {
                this.lessons = new Map();
                this.currentLesson = null;
                this.vocabulary = new Map();
                this.initSampleLessons();
            }

            initSampleLessons() {
                // Ø¯Ø±Ø³ Ù†Ù…ÙˆÙ†Ù‡: Ø­ÛŒÙˆØ§Ù†Ø§Øª
                const lesson1 = {
                    id: 'L001',
                    title: 'Ø­ÛŒÙˆØ§Ù†Ø§Øª',
                    level: 1,
                    description: 'Ø¢Ù…ÙˆØ²Ø´ Ù†Ø§Ù… Ø­ÛŒÙˆØ§Ù†Ø§Øª Ø¨Ù‡ Ø§Ù†Ú¯Ù„ÛŒØ³ÛŒ',
                    totalWords: 5,
                    completed: false
                };
                
                this.lessons.set(lesson1.id, lesson1);
                
                // ÙˆØ§Ú˜Ú¯Ø§Ù† Ø¯Ø±Ø³
                const vocab = [
                    { id: 'V001', english: 'cat', persian: 'Ú¯Ø±Ø¨Ù‡', difficulty: 'easy', phonetic: '/kÃ¦t/' },
                    { id: 'V002', english: 'dog', persian: 'Ø³Ú¯', difficulty: 'easy', phonetic: '/dÉ’É¡/' },
                    { id: 'V003', english: 'bird', persian: 'Ù¾Ø±Ù†Ø¯Ù‡', difficulty: 'medium', phonetic: '/bÉœËrd/' },
                    { id: 'V004', english: 'fish', persian: 'Ù…Ø§Ù‡ÛŒ', difficulty: 'medium', phonetic: '/fÉªÊƒ/' },
                    { id: 'V005', english: 'horse', persian: 'Ø§Ø³Ø¨', difficulty: 'hard', phonetic: '/hÉ”Ërs/' }
                ];
                
                this.vocabulary.set(lesson1.id, vocab);
                
                // Ø¯Ø±Ø³ Ø¯ÙˆÙ…: Ø±Ù†Ú¯â€ŒÙ‡Ø§
                const lesson2 = {
                    id: 'L002',
                    title: 'Ø±Ù†Ú¯â€ŒÙ‡Ø§',
                    level: 1,
                    description: 'Ø¢Ù…ÙˆØ²Ø´ Ù†Ø§Ù… Ø±Ù†Ú¯â€ŒÙ‡Ø§',
                    totalWords: 4,
                    completed: false
                };
                
                this.lessons.set(lesson2.id, lesson2);
                
                const vocab2 = [
                    { id: 'V006', english: 'red', persian: 'Ù‚Ø±Ù…Ø²', difficulty: 'easy', phonetic: '/red/' },
                    { id: 'V007', english: 'blue', persian: 'Ø¢Ø¨ÛŒ', difficulty: 'easy', phonetic: '/bluË/' },
                    { id: 'V008', english: 'green', persian: 'Ø³Ø¨Ø²', difficulty: 'easy', phonetic: '/É¡riËn/' },
                    { id: 'V009', english: 'yellow', persian: 'Ø²Ø±Ø¯', difficulty: 'medium', phonetic: '/ËˆjeloÊŠ/' }
                ];
                
                this.vocabulary.set(lesson2.id, vocab2);
            }

            async loadLesson(lessonId) {
                const lesson = this.lessons.get(lessonId);
                if (!lesson) {
                    return { success: false, error: 'Ø¯Ø±Ø³ ÛŒØ§ÙØª Ù†Ø´Ø¯' };
                }
                
                this.currentLesson = lesson;
                return { 
                    success: true, 
                    lesson,
                    vocabulary: this.vocabulary.get(lessonId) || []
                };
            }

            getCurrentLesson() {
                return this.currentLesson;
            }

            getVocabulary(lessonId) {
                return this.vocabulary.get(lessonId) || [];
            }

            getAllLessons() {
                return Array.from(this.lessons.values());
            }
        }

        // 3. Ø§Ø¹ØªØ¨Ø§Ø±Ø³Ù†Ø¬ ØªÙ…Ø±ÛŒÙ† (Exercise Validator)
        class ExerciseValidator {
            static validateMultipleChoice(userAnswer, correctIndex, choices) {
                if (!Array.isArray(choices) || choices.length === 0) return false;
                if (typeof userAnswer !== 'number' || userAnswer < 0 || userAnswer >= choices.length) return false;
                if (typeof correctIndex !== 'number' || correctIndex < 0 || correctIndex >= choices.length) return false;
                return userAnswer === correctIndex;
            }

            static validateFillBlank(userAnswer, correctAnswer, caseInsensitive = true, trimSpaces = true) {
                if (typeof userAnswer !== 'string' || typeof correctAnswer !== 'string') return false;
                let u = userAnswer, c = correctAnswer;
                if (trimSpaces) { u = u.trim(); c = c.trim(); }
                if (caseInsensitive) { u = u.toLowerCase(); c = c.toLowerCase(); }
                return u === c;
            }

            static validateTranslation(userAnswer, expectedAnswer, tolerance = 0) {
                if (typeof userAnswer !== 'string' || typeof expectedAnswer !== 'string') return false;
                const u = userAnswer.trim().toLowerCase();
                const e = expectedAnswer.trim().toLowerCase();
                if (u === e) return true;
                if (tolerance > 0) {
                    const distance = this.levenshteinDistance(u, e);
                    return distance <= tolerance;
                }
                return false;
            }

            static levenshteinDistance(a, b) {
                const matrix = [];
                for (let i = 0; i <= b.length; i++) matrix[i] = [i];
                for (let j = 0; j <= a.length; j++) matrix[0][j] = j;
                
                for (let i = 1; i <= b.length; i++) {
                    for (let j = 1; j <= a.length; j++) {
                        if (b.charAt(i-1) === a.charAt(j-1)) {
                            matrix[i][j] = matrix[i-1][j-1];
                        } else {
                            matrix[i][j] = Math.min(
                                matrix[i-1][j-1] + 1,
                                matrix[i][j-1] + 1,
                                matrix[i-1][j] + 1
                            );
                        }
                    }
                }
                return matrix[b.length][a.length];
            }

            static validatePronunciation(userPhonetic, correctPhoneticList) {
                if (typeof userPhonetic !== 'string' || !Array.isArray(correctPhoneticList)) return false;
                const normalizedUser = userPhonetic.trim().replace(/[\/\s]/g, '');
                return correctPhoneticList.some(p => 
                    p.trim().replace(/[\/\s]/g, '') === normalizedUser
                );
            }
        }

        // 4. Ø§Ù„Ú¯ÙˆØ±ÛŒØªÙ… SRS (Ù…Ø±ÙˆØ± Ù‡ÙˆØ´Ù…Ù†Ø¯)
        class SRSEngine {
            constructor() {
                this.reviewHistory = new Map();
            }

            calculateNextReview(quality, oldInterval = null, oldFactor = 2.5) {
                quality = Math.max(0, Math.min(5, quality));
                let newInterval;
                
                if (quality < 3) {
                    newInterval = 1; // ÙØ±Ø¯Ø§ Ù…Ø±ÙˆØ± Ú©Ù†
                } else {
                    if (!oldInterval) {
                        newInterval = 1;
                    } else if (oldInterval === 1) {
                        newInterval = 6;
                    } else {
                        newInterval = Math.round(oldInterval * oldFactor);
                    }
                }
                
                // Ù…Ø­Ø¯ÙˆØ¯ÛŒØª ÙØ§ØµÙ„Ù‡
                newInterval = Math.min(365, Math.max(1, newInterval));
                
                // Ù…Ø­Ø§Ø³Ø¨Ù‡ ÙØ§Ú©ØªÙˆØ± Ø³Ù‡ÙˆÙ„Øª Ø¬Ø¯ÛŒØ¯
                let newFactor = oldFactor + (0.1 - (5 - quality) * (0.08 + (5 - quality) * 0.02));
                newFactor = Math.max(1.3, Math.min(3.5, newFactor));
                
                return {
                    interval: newInterval,
                    factor: newFactor,
                    nextReviewDate: new Date(Date.now() + (newInterval * 86400000)).toLocaleDateString('fa-IR'),
                    quality
                };
            }

            saveReview(wordId, quality) {
                const now = Date.now();
                const history = this.reviewHistory.get(wordId) || [];
                history.push({ quality, timestamp: now });
                this.reviewHistory.set(wordId, history);
                
                return this.calculateNextReview(quality);
            }
        }

        // 5. Ø³Ø±ÙˆÛŒØ³ Ù¾ÛŒØ´Ø±ÙØª Ú©Ø§Ø±Ø¨Ø± (Progress Service)
        class ProgressService {
            constructor() {
                this.userProgress = new Map();
                this.srsEngine = new SRSEngine();
            }

            saveProgress(userId, lessonId, exerciseResults) {
                let progress = this.userProgress.get(userId) || {
                    userId,
                    completedLessons: [],
                    xp: 0,
                    streak: 0,
                    lastActive: null,
                    wordReviews: []
                };
                
                // Ù…Ø­Ø§Ø³Ø¨Ù‡ XP
                const xpGained = exerciseResults.filter(r => r.correct).length * 10;
                progress.xp += xpGained;
                
                // Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ streak
                const today = new Date().toDateString();
                if (progress.lastActive !== today) {
                    progress.streak += 1;
                    progress.lastActive = today;
                }
                
                // Ø¨Ø±Ø±Ø³ÛŒ ØªÚ©Ù…ÛŒÙ„ Ø¯Ø±Ø³
                if (exerciseResults.length > 0) {
                    if (!progress.completedLessons.includes(lessonId)) {
                        progress.completedLessons.push(lessonId);
                    }
                }
                
                // Ø°Ø®ÛŒØ±Ù‡ Ù†ØªØ§ÛŒØ¬ SRS
                exerciseResults.forEach(result => {
                    if (result.wordId) {
                        const srsResult = this.srsEngine.saveReview(result.wordId, result.quality || 4);
                        progress.wordReviews.push({
                            wordId: result.wordId,
                            ...srsResult,
                            timestamp: Date.now()
                        });
                    }
                });
                
                this.userProgress.set(userId, progress);
                
                return {
                    success: true,
                    progress: {
                        xp: progress.xp,
                        streak: progress.streak,
                        completedLessons: progress.completedLessons.length,
                        xpGained
                    },
                    srsResults: exerciseResults
                        .filter(r => r.wordId)
                        .map(r => this.srsEngine.calculateNextReview(r.quality || 4))
                };
            }

            getProgress(userId) {
                return this.userProgress.get(userId) || null;
            }

            calculateLevel(xp) {
                if (xp < 100) return 1;
                if (xp < 300) return 2;
                if (xp < 600) return 3;
                if (xp < 1000) return 4;
                if (xp < 1500) return 5;
                return 6;
            }
        }

        // ==================== Ú©Ù„Ø§Ø³ Ø§ØµÙ„ÛŒ ØªØ³Øª ====================
        const FlowTest = {
            auth: new AuthService(),
            lesson: new LessonService(),
            progress: new ProgressService(),
            
            currentUserId: null,
            currentLessonId: null,
            exerciseResults: [],
            offlineMode: false,
            logEntries: [],

            // Ù„Ø§Ú¯ Ú©Ø±Ø¯Ù†
            log(message, type = 'info') {
                const timestamp = new Date().toLocaleTimeString('fa-IR', { hour12: false });
                const entry = `[${timestamp}] ${message}`;
                this.logEntries.push(entry);
                
                const output = document.getElementById('console-output');
                const countSpan = document.getElementById('log-count');
                
                let color = '#a7ffeb';
                if (type === 'success') color = '#b9f6ca';
                if (type === 'error') color = '#ffcdd2';
                if (type === 'warning') color = '#ffe0b2';
                
                output.innerHTML += `<br><span style="color: ${color};">${entry}</span>`;
                output.scrollTop = output.scrollHeight;
                countSpan.textContent = `${this.logEntries.length} Ø±ÙˆÛŒØ¯Ø§Ø¯`;
                
                console.log(entry);
            },

            // ========== Ú¯Ø§Ù… Û±: Ø§Ø­Ø±Ø§Ø² Ù‡ÙˆÛŒØª ==========
            async register() {
                this.log('ğŸ“ Ø´Ø±ÙˆØ¹ ÙØ±Ø¢ÛŒÙ†Ø¯ Ø«Ø¨Øªâ€ŒÙ†Ø§Ù…...');
                
                const result = await this.auth.register('test-user', '123456', 'test@example.com');
                
                if (result.success) {
                    this.currentUserId = result.user.id;
                    this.updateUserStatus('âœ… ' + result.user.username);
                    this.updateStepContent('step1-content', `
                        <strong style="color: #b9f6ca;">âœ… Ø«Ø¨Øªâ€ŒÙ†Ø§Ù… Ù…ÙˆÙÙ‚</strong><br>
                        ğŸ‘¤ Ú©Ø§Ø±Ø¨Ø±: ${result.user.username}<br>
                        ğŸ†” Ø¢ÛŒØ¯ÛŒ: ${result.user.id}<br>
                        ğŸ“§ Ø§ÛŒÙ…ÛŒÙ„: ${result.user.email}<br>
                        ğŸ“… ØªØ§Ø±ÛŒØ®: ${new Date(result.user.createdAt).toLocaleDateString('fa-IR')}
                    `);
                    this.log('âœ… Ø«Ø¨Øªâ€ŒÙ†Ø§Ù… Ù…ÙˆÙÙ‚ - Ú©Ø§Ø±Ø¨Ø±: test-user', 'success');
                } else {
                    this.log('âŒ Ø®Ø·Ø§ Ø¯Ø± Ø«Ø¨Øªâ€ŒÙ†Ø§Ù…: ' + result.error, 'error');
                }
            },

            async login() {
                this.log('ğŸ”‘ Ø´Ø±ÙˆØ¹ ÙØ±Ø¢ÛŒÙ†Ø¯ ÙˆØ±ÙˆØ¯...');
                
                // Ø§Ú¯Ø± Ú©Ø§Ø±Ø¨Ø± ÙˆØ¬ÙˆØ¯ Ù†Ø¯Ø§Ø±Ø¯ØŒ Ø§Ø¨ØªØ¯Ø§ Ø«Ø¨Øªâ€ŒÙ†Ø§Ù… Ú©Ù†
                if (!this.auth.users.has('test-user')) {
                    await this.register();
                }
                
                const result = await this.auth.login('test-user', '123456');
                
                if (result.success) {
                    this.currentUserId = result.user.id;
                    this.updateUserStatus('âœ… ' + result.user.username);
                    this.updateStepContent('step1-content', `
                        <strong style="color: #b9f6ca;">âœ… ÙˆØ±ÙˆØ¯ Ù…ÙˆÙÙ‚</strong><br>
                        ğŸ‘¤ Ú©Ø§Ø±Ø¨Ø±: ${result.user.username}<br>
                        ğŸ†” Ø¢ÛŒØ¯ÛŒ: ${result.user.id}<br>
                        ğŸ“… Ø¢Ø®Ø±ÛŒÙ† ÙˆØ±ÙˆØ¯: ${new Date(result.user.lastLogin).toLocaleTimeString('fa-IR')}
                    `);
                    this.log('âœ… ÙˆØ±ÙˆØ¯ Ù…ÙˆÙÙ‚ - Ú©Ø§Ø±Ø¨Ø±: test-user', 'success');
                } else {
                    this.log('âŒ Ø®Ø·Ø§ Ø¯Ø± ÙˆØ±ÙˆØ¯: ' + result.error, 'error');
                }
            },

            logout() {
                this.auth.logout();
                this.currentUserId = null;
                this.updateUserStatus('ğŸšª Ø®Ø±ÙˆØ¬');
                this.updateStepContent('step1-content', `
                    <strong style="color: #ffcc80;">ğŸŸ¡ Ú©Ø§Ø±Ø¨Ø± Ø®Ø§Ø±Ø¬ Ø´Ø¯</strong><br>
                    Ø¨Ø±Ø§ÛŒ Ø§Ø¯Ø§Ù…Ù‡ Ø¢Ø²Ù…Ø§ÛŒØ´ØŒ Ø¯ÙˆØ¨Ø§Ø±Ù‡ ÙˆØ§Ø±Ø¯ Ø´ÙˆÛŒØ¯.
                `);
                this.log('ğŸšª Ú©Ø§Ø±Ø¨Ø± Ø§Ø² Ø³ÛŒØ³ØªÙ… Ø®Ø§Ø±Ø¬ Ø´Ø¯', 'warning');
            },

            // ========== Ú¯Ø§Ù… Û²: Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø¯Ø±Ø³ ==========
            async loadLesson() {
                if (!this.auth.isLoggedIn()) {
                    this.log('âŒ Ø§Ø¨ØªØ¯Ø§ Ø¨Ø§ÛŒØ¯ ÙˆØ§Ø±Ø¯ Ø´ÙˆÛŒØ¯', 'error');
                    return;
                }
                
                this.log('ğŸ“‚ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø¯Ø±Ø³ Ù†Ù…ÙˆÙ†Ù‡...');
                
                const result = await this.lesson.loadLesson('L001');
                
                if (result.success) {
                    this.currentLessonId = result.lesson.id;
                    this.updateLessonStatus(result.lesson.title);
                    
                    let vocabHtml = '';
                    result.vocabulary.forEach(v => {
                        vocabHtml += `${v.english} (${v.persian}) - ${v.phonetic}<br>`;
                    });
                    
                    this.updateStepContent('step2-content', `
                        <strong style="color: #b9f6ca;">âœ… Ø¯Ø±Ø³ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø´Ø¯</strong><br>
                        ğŸ“š Ø¹Ù†ÙˆØ§Ù†: ${result.lesson.title}<br>
                        ğŸ“Š Ø³Ø·Ø­: ${result.lesson.level}<br>
                        ğŸ“ ØªÙˆØ¶ÛŒØ­: ${result.lesson.description}<br>
                        ğŸ¯ ØªØ¹Ø¯Ø§Ø¯ ÙˆØ§Ú˜Ú¯Ø§Ù†: ${result.vocabulary.length}<br>
                        <br><strong>ğŸ“– ÙˆØ§Ú˜Ú¯Ø§Ù†:</strong><br>
                        ${vocabHtml}
                    `);
                    this.log(`âœ… Ø¯Ø±Ø³ "${result.lesson.title}" Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø´Ø¯ - ${result.vocabulary.length} ÙˆØ§Ú˜Ù‡`, 'success');
                }
            },

            loadVocabulary() {
                if (!this.currentLessonId) {
                    this.log('âŒ Ø§Ø¨ØªØ¯Ø§ ÛŒÚ© Ø¯Ø±Ø³ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ú©Ù†ÛŒØ¯', 'error');
                    return;
                }
                
                const vocab = this.lesson.getVocabulary(this.currentLessonId);
                let list = '';
                vocab.forEach(v => {
                    list += `ğŸ”¹ ${v.english} = ${v.persian} [${v.phonetic}]\n`;
                });
                
                this.log(`ğŸ“œ ÙˆØ§Ú˜Ú¯Ø§Ù† Ø¯Ø±Ø³ Ø¬Ø§Ø±ÛŒ:\n${list}`);
            },

            // ========== Ú¯Ø§Ù… Û³: ØªÙ…Ø±ÛŒÙ† Ùˆ Ù¾Ø§Ø³Ø®â€ŒØ¯Ù‡ÛŒ ==========
            startExercise(type) {
                if (!this.currentLessonId) {
                    this.log('âŒ Ø§Ø¨ØªØ¯Ø§ ÛŒÚ© Ø¯Ø±Ø³ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ú©Ù†ÛŒØ¯', 'error');
                    return;
                }
                
                const vocab = this.lesson.getVocabulary(this.currentLessonId);
                if (vocab.length === 0) {
                    this.log('âŒ ÙˆØ§Ú˜Ù‡â€ŒØ§ÛŒ Ø¨Ø±Ø§ÛŒ ØªÙ…Ø±ÛŒÙ† ÙˆØ¬ÙˆØ¯ Ù†Ø¯Ø§Ø±Ø¯', 'error');
                    return;
                }
                
                const randomWord = vocab[Math.floor(Math.random() * vocab.length)];
                
                switch(type) {
                    case 'mc':
                        this.runMultipleChoice(randomWord);
                        break;
                    case 'fb':
                        this.runFillBlank(randomWord);
                        break;
                    case 'tl':
                        this.runTranslation(randomWord);
                        break;
                    case 'pr':
                        this.runPronunciation(randomWord);
                        break;
                }
            },

            runMultipleChoice(word) {
                const choices = ['cat', 'dog', 'bird', 'fish'];
                const correctIndex = choices.findIndex(c => c === word.english);
                
                // Ø´Ø¨ÛŒÙ‡â€ŒØ³Ø§Ø²ÛŒ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ø§Ø±Ø¨Ø± (Ø§Ù†ØªØ®Ø§Ø¨ ØµØ­ÛŒØ­)
                const userAnswer = correctIndex;
                const isValid = ExerciseValidator.validateMultipleChoice(userAnswer, correctIndex, choices);
                
                this.exerciseResults.push({
                    wordId: word.id,
                    type: 'multiple-choice',
                    correct: isValid,
                    quality: isValid ? 5 : 2
                });
                
                this.updateStepContent('step3-content', `
                    <strong style="color: #b9f6ca;">âœ… ØªÙ…Ø±ÛŒÙ† Ú†Ù‡Ø§Ø±Ú¯Ø²ÛŒÙ†Ù‡â€ŒØ§ÛŒ</strong><br>
                    ğŸ“ Ø³ÙˆØ§Ù„: Ù…Ø¹Ù†ÛŒ "${word.persian}" Ú†ÛŒØ³ØªØŸ<br>
                    ğŸ”˜ Ú¯Ø²ÛŒÙ†Ù‡â€ŒÙ‡Ø§: ${choices.join('ØŒ ')}<br>
                    ğŸ¯ Ù¾Ø§Ø³Ø® ØµØ­ÛŒØ­: ${word.english} (Ú¯Ø²ÛŒÙ†Ù‡ ${correctIndex + 1})<br>
                    ğŸ‘¤ Ù¾Ø§Ø³Ø® Ú©Ø§Ø±Ø¨Ø±: ${choices[userAnswer]} (Ú¯Ø²ÛŒÙ†Ù‡ ${userAnswer + 1})<br>
                    <strong>ğŸ“Š Ù†ØªÛŒØ¬Ù‡: ${isValid ? 'âœ… ØµØ­ÛŒØ­' : 'âŒ ØºÙ„Ø·'}</strong>
                `);
                
                this.log(`âœ… ØªÙ…Ø±ÛŒÙ† Ú†Ù‡Ø§Ø±Ú¯Ø²ÛŒÙ†Ù‡â€ŒØ§ÛŒ - Ú©Ù„Ù…Ù‡: ${word.english} - Ù†ØªÛŒØ¬Ù‡: ${isValid ? 'ØµØ­ÛŒØ­' : 'ØºÙ„Ø·'}`, isValid ? 'success' : 'warning');
            },

            runFillBlank(word) {
                const sentence = `The ${word.english} is sleeping.`;
                const userAnswer = word.english; // Ù¾Ø§Ø³Ø® ØµØ­ÛŒØ­
                const isValid = ExerciseValidator.validateFillBlank(userAnswer, word.english);
                
                this.exerciseResults.push({
                    wordId: word.id,
                    type: 'fill-blank',
                    correct: isValid,
                    quality: isValid ? 4 : 2
                });
                
                this.updateStepContent('step3-content', `
                    <strong style="color: #b9f6ca;">âœ… ØªÙ…Ø±ÛŒÙ† Ø¬Ø§ÛŒâ€ŒØ®Ø§Ù„ÛŒ</strong><br>
                    ğŸ“ Ø¬Ù…Ù„Ù‡: The __________ is sleeping.<br>
                    ğŸ¯ Ù¾Ø§Ø³Ø® ØµØ­ÛŒØ­: ${word.english}<br>
                    ğŸ‘¤ Ù¾Ø§Ø³Ø® Ú©Ø§Ø±Ø¨Ø±: ${userAnswer}<br>
                    <strong>ğŸ“Š Ù†ØªÛŒØ¬Ù‡: ${isValid ? 'âœ… ØµØ­ÛŒØ­' : 'âŒ ØºÙ„Ø·'}</strong>
                `);
                
                this.log(`âœ… ØªÙ…Ø±ÛŒÙ† Ø¬Ø§ÛŒâ€ŒØ®Ø§Ù„ÛŒ - Ú©Ù„Ù…Ù‡: ${word.english} - Ù†ØªÛŒØ¬Ù‡: ${isValid ? 'ØµØ­ÛŒØ­' : 'ØºÙ„Ø·'}`, isValid ? 'success' : 'warning');
            },

            runTranslation(word) {
                // ØªØ³Øª ØºÙ„Ø·â€ŒÚ¯ÛŒØ±ÛŒ Ø§Ù…Ù„Ø§ÛŒÛŒ - Ú©Ø§Ø±Ø¨Ø± "Ú©Øª" Ù…ÛŒÙ†ÙˆÛŒØ³Ø¯ Ø¨Ù‡ Ø¬Ø§ÛŒ "Ú©ØªØ§Ø¨"
                let userAnswer, expected, tolerance, description;
                
                if (word.english === 'cat') {
                    userAnswer = 'Ú¯Ø±Ø¨Ù‡';
                    expected = 'Ú¯Ø±Ø¨Ù‡';
                    tolerance = 0;
                    description = 'ØªØ±Ø¬Ù…Ù‡ Ø¯Ù‚ÛŒÙ‚';
                } else if (word.english === 'bird') {
                    userAnswer = 'Ù¾Ø±Ù†Ø¯'; // ØºÙ„Ø· Ø§Ù…Ù„Ø§ÛŒÛŒ
                    expected = 'Ù¾Ø±Ù†Ø¯Ù‡';
                    tolerance = 1;
                    description = 'ØºÙ„Ø·â€ŒÚ¯ÛŒØ±ÛŒ Ø§Ù…Ù„Ø§ÛŒÛŒ (Ù¾Ø±Ù†Ø¯ â†’ Ù¾Ø±Ù†Ø¯Ù‡)';
                } else {
                    userAnswer = word.persian;
                    expected = word.persian;
                    tolerance = 0;
                    description = 'ØªØ±Ø¬Ù…Ù‡ Ø¯Ù‚ÛŒÙ‚';
                }
                
                const isValid = ExerciseValidator.validateTranslation(userAnswer, expected, tolerance);
                
                this.exerciseResults.push({
                    wordId: word.id,
                    type: 'translation',
                    correct: isValid,
                    quality: isValid ? 4 : 2
                });
                
                this.updateStepContent('step3-content', `
                    <strong style="color: #b9f6ca;">âœ… ØªÙ…Ø±ÛŒÙ† ØªØ±Ø¬Ù…Ù‡</strong><br>
                    ğŸ“ Ø³ÙˆØ§Ù„: ØªØ±Ø¬Ù…Ù‡ "${word.english}" Ø¨Ù‡ ÙØ§Ø±Ø³ÛŒ<br>
                    ğŸ¯ Ù¾Ø§Ø³Ø® ØµØ­ÛŒØ­: ${expected}<br>
                    ğŸ‘¤ Ù¾Ø§Ø³Ø® Ú©Ø§Ø±Ø¨Ø±: ${userAnswer}<br>
                    ğŸ”§ ØºÙ„Ø·â€ŒÚ¯ÛŒØ±ÛŒ: ${tolerance > 0 ? 'ÙØ¹Ø§Ù„ (tolerance=' + tolerance + ')' : 'ØºÛŒØ±ÙØ¹Ø§Ù„'}<br>
                    <strong>ğŸ“Š Ù†ØªÛŒØ¬Ù‡: ${isValid ? 'âœ… ØµØ­ÛŒØ­' : 'âŒ ØºÙ„Ø·'}</strong>
                    ${isValid && userAnswer !== expected ? 'âš ï¸ Ø¨Ø§ ØºÙ„Ø·â€ŒÚ¯ÛŒØ±ÛŒ Ø§Ù…Ù„Ø§ÛŒÛŒ Ù‚Ø¨ÙˆÙ„ Ø´Ø¯' : ''}
                `);
                
                this.log(`âœ… ØªÙ…Ø±ÛŒÙ† ØªØ±Ø¬Ù…Ù‡ - ${description} - Ù†ØªÛŒØ¬Ù‡: ${isValid ? 'ØµØ­ÛŒØ­' : 'ØºÙ„Ø·'}`, isValid ? 'success' : 'warning');
            },

            runPronunciation(word) {
                const phoneticList = [word.phonetic, '/' + word.english + '/', '/?/'];
                const userAnswer = word.phonetic;
                const isValid = ExerciseValidator.validatePronunciation(userAnswer, phoneticList);
                
                this.exerciseResults.push({
                    wordId: word.id,
                    type: 'pronunciation',
                    correct: isValid,
                    quality: isValid ? 5 : 2
                });
                
                this.updateStepContent('step3-content', `
                    <strong style="color: #b9f6ca;">âœ… ØªÙ…Ø±ÛŒÙ† ØªÙ„ÙØ¸</strong><br>
                    ğŸ“ Ú©Ù„Ù…Ù‡: ${word.english}<br>
                    ğŸ¯ ØªÙ„ÙØ¸ ØµØ­ÛŒØ­: ${word.phonetic}<br>
                    ğŸ‘¤ ØªÙ„ÙØ¸ Ú©Ø§Ø±Ø¨Ø±: ${userAnswer}<br>
                    ğŸ” Ú¯Ø²ÛŒÙ†Ù‡â€ŒÙ‡Ø§ÛŒ Ù…Ø¹ØªØ¨Ø±: ${phoneticList.join('ØŒ ')}<br>
                    <strong>ğŸ“Š Ù†ØªÛŒØ¬Ù‡: ${isValid ? 'âœ… ØµØ­ÛŒØ­' : 'âŒ ØºÙ„Ø·'}</strong>
                `);
                
                this.log(`âœ… ØªÙ…Ø±ÛŒÙ† ØªÙ„ÙØ¸ - Ú©Ù„Ù…Ù‡: ${word.english} - Ù†ØªÛŒØ¬Ù‡: ${isValid ? 'ØµØ­ÛŒØ­' : 'ØºÙ„Ø·'}`, isValid ? 'success' : 'warning');
            },

            // ========== Ú¯Ø§Ù… Û´: Ø°Ø®ÛŒØ±Ù‡ Ù¾ÛŒØ´Ø±ÙØª Ùˆ SRS ==========
            saveProgress() {
                if (!this.currentUserId || !this.currentLessonId) {
                    this.log('âŒ Ú©Ø§Ø±Ø¨Ø± ÙˆØ§Ø±Ø¯ Ù†Ø´Ø¯Ù‡ ÛŒØ§ Ø¯Ø±Ø³ÛŒ Ø§Ù†ØªØ®Ø§Ø¨ Ù†Ø´Ø¯Ù‡', 'error');
                    return;
                }
                
                if (this.exerciseResults.length === 0) {
                    this.log('âš ï¸ Ù‡ÛŒÚ† ØªÙ…Ø±ÛŒÙ†ÛŒ Ø§Ù†Ø¬Ø§Ù… Ù†Ø´Ø¯Ù‡ Ø§Ø³Øª', 'warning');
                    return;
                }
                
                this.log('ğŸ’¾ Ø¯Ø± Ø­Ø§Ù„ Ø°Ø®ÛŒØ±Ù‡ Ù¾ÛŒØ´Ø±ÙØª...');
                
                const result = this.progress.saveProgress(
                    this.currentUserId,
                    this.currentLessonId,
                    this.exerciseResults
                );
                
                if (result.success) {
                    const level = this.progress.calculateLevel(result.progress.xp);
                    
                    this.updateProgressStatus(`${result.progress.completedLessons} Ø¯Ø±Ø³`, result.progress.xp);
                    
                    this.updateStepContent('step4-content', `
                        <strong style="color: #b9f6ca;">âœ… Ù¾ÛŒØ´Ø±ÙØª Ø°Ø®ÛŒØ±Ù‡ Ø´Ø¯</strong><br>
                        ğŸ“Š XP: ${result.progress.xp} (+${result.progress.xpGained})<br>
                        ğŸ”¥ Streak: ${result.progress.streak} Ø±ÙˆØ²<br>
                        ğŸ¯ Ø³Ø·Ø­: ${level}<br>
                        ğŸ“š Ø¯Ø±Ø³â€ŒÙ‡Ø§ÛŒ ØªÚ©Ù…ÛŒÙ„â€ŒØ´Ø¯Ù‡: ${result.progress.completedLessons}<br>
                        <br><strong>ğŸ§  Ù†ØªØ§ÛŒØ¬ SRS:</strong><br>
                        ${result.srsResults.map((r, i) => 
                            `ğŸ”¹ Ù…Ø±ÙˆØ± ${i+1}: ÙØ§ØµÙ„Ù‡ ${r.interval} Ø±ÙˆØ² - Ù…Ø±ÙˆØ± Ø¨Ø¹Ø¯ÛŒ: ${r.nextReviewDate}`
                        ).join('<br>')}
                    `);
                    
                    this.log(`âœ… Ù¾ÛŒØ´Ø±ÙØª Ø°Ø®ÛŒØ±Ù‡ Ø´Ø¯ - XP: ${result.progress.xp} (+${result.progress.xpGained})`, 'success');
                }
            },

            calculateSRS() {
                if (this.exerciseResults.length === 0) {
                    this.log('âš ï¸ Ø§Ø¨ØªØ¯Ø§ ÛŒÚ© ØªÙ…Ø±ÛŒÙ† Ø§Ù†Ø¬Ø§Ù… Ø¯Ù‡ÛŒØ¯', 'warning');
                    return;
                }
                
                const lastResult = this.exerciseResults[this.exerciseResults.length - 1];
                const quality = lastResult.quality || 4;
                
                const srs = this.progress.srsEngine.calculateNextReview(quality);
                
                this.log(`ğŸ§® Ù…Ø­Ø§Ø³Ø¨Ù‡ SRS - Ú©ÛŒÙÛŒØª: ${quality} - ÙØ§ØµÙ„Ù‡: ${srs.interval} Ø±ÙˆØ² - Ù…Ø±ÙˆØ± Ø¨Ø¹Ø¯ÛŒ: ${srs.nextReviewDate}`);
                
                alert(`ğŸ“Š Ù†ØªÛŒØ¬Ù‡ SRS:\n
Ú©ÛŒÙÛŒØª Ù¾Ø§Ø³Ø®: ${quality}
ÙØ§ØµÙ„Ù‡ Ù…Ø±ÙˆØ±: ${srs.interval} Ø±ÙˆØ²
Ù…Ø±ÙˆØ± Ø¨Ø¹Ø¯ÛŒ: ${srs.nextReviewDate}
ÙØ§Ú©ØªÙˆØ± Ø³Ù‡ÙˆÙ„Øª: ${srs.factor.toFixed(2)}`);
            },

            showProgress() {
                if (!this.currentUserId) {
                    this.log('âŒ Ú©Ø§Ø±Ø¨Ø± ÙˆØ§Ø±Ø¯ Ù†Ø´Ø¯Ù‡ Ø§Ø³Øª', 'error');
                    return;
                }
                
                const progress = this.progress.getProgress(this.currentUserId);
                
                if (!progress) {
                    this.log('ğŸ“Š Ù‡ÛŒÚ† Ù¾ÛŒØ´Ø±ÙØªÛŒ Ø«Ø¨Øª Ù†Ø´Ø¯Ù‡ Ø§Ø³Øª', 'warning');
                    return;
                }
                
                const level = this.progress.calculateLevel(progress.xp);
                
                let progressText = `ğŸ“Š Ù¾ÛŒØ´Ø±ÙØª Ú©Ø§Ø±Ø¨Ø± ${this.currentUserId}:\n`;
                progressText += `XP: ${progress.xp} (Ø³Ø·Ø­ ${level})\n`;
                progressText += `Streak: ${progress.streak} Ø±ÙˆØ²\n`;
                progressText += `Ø¯Ø±Ø³â€ŒÙ‡Ø§ÛŒ ØªÚ©Ù…ÛŒÙ„â€ŒØ´Ø¯Ù‡: ${progress.completedLessons.length}\n`;
                progressText += `Ø¢Ø®Ø±ÛŒÙ† ÙØ¹Ø§Ù„ÛŒØª: ${progress.lastActive || 'Ù†Ø¯Ø§Ø±Ø¯'}\n`;
                progressText += `ØªØ¹Ø¯Ø§Ø¯ Ù…Ø±ÙˆØ±Ù‡Ø§ÛŒ SRS: ${progress.wordReviews.length}`;
                
                this.log(progressText);
                
                alert(progressText.replace(/\n/g, '\n'));
            },

            // ========== Ú¯Ø§Ù… Ûµ: Ù‡Ù…Ú¯Ø§Ù…â€ŒØ³Ø§Ø²ÛŒ Ùˆ Ù¾Ø§ÛŒØ¯Ø§Ø±ÛŒ ==========
            simulateOffline() {
                this.offlineMode = true;
                this.updateStepContent('step5-content', `
                    <strong style="color: #ffcc80;">ğŸ”Œ Ø­Ø§Ù„Øª Ø¢ÙÙ„Ø§ÛŒÙ† ÙØ¹Ø§Ù„ Ø´Ø¯</strong><br>
                    âš ï¸ Ù‡Ù…Ú¯Ø§Ù…â€ŒØ³Ø§Ø²ÛŒ ØºÛŒØ±ÙØ¹Ø§Ù„ Ø§Ø³Øª<br>
                    ğŸ“± Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ Ø¨Ù‡ ØµÙˆØ±Øª Ù…Ø­Ù„ÛŒ Ø°Ø®ÛŒØ±Ù‡ Ù…ÛŒâ€ŒØ´ÙˆÙ†Ø¯
                `);
                this.log('ğŸ”Œ Ø´Ø¨ÛŒÙ‡â€ŒØ³Ø§Ø²ÛŒ Ø­Ø§Ù„Øª Ø¢ÙÙ„Ø§ÛŒÙ† - Ù‡Ù…Ú¯Ø§Ù…â€ŒØ³Ø§Ø²ÛŒ ØºÛŒØ±ÙØ¹Ø§Ù„ Ø´Ø¯', 'warning');
            },

            simulateOnline() {
                this.offlineMode = false;
                this.updateStepContent('step5-content', `
                    <strong style="color: #b9f6ca;">ğŸŒ Ø­Ø§Ù„Øª Ø¢Ù†Ù„Ø§ÛŒÙ† ÙØ¹Ø§Ù„ Ø´Ø¯</strong><br>
                    âœ… Ù‡Ù…Ú¯Ø§Ù…â€ŒØ³Ø§Ø²ÛŒ ÙØ¹Ø§Ù„ Ø§Ø³Øª
                `);
                this.log('ğŸŒ Ø´Ø¨ÛŒÙ‡â€ŒØ³Ø§Ø²ÛŒ Ø­Ø§Ù„Øª Ø¢Ù†Ù„Ø§ÛŒÙ† - Ù‡Ù…Ú¯Ø§Ù…â€ŒØ³Ø§Ø²ÛŒ ÙØ¹Ø§Ù„ Ø´Ø¯', 'success');
            },

            async syncData() {
                if (this.offlineMode) {
                    this.log('âŒ Ø¯Ø± Ø­Ø§Ù„Øª Ø¢ÙÙ„Ø§ÛŒÙ† Ø§Ù…Ú©Ø§Ù† Ù‡Ù…Ú¯Ø§Ù…â€ŒØ³Ø§Ø²ÛŒ ÙˆØ¬ÙˆØ¯ Ù†Ø¯Ø§Ø±Ø¯', 'error');
                    return;
                }
                
                this.log('ğŸ”„ Ø´Ø±ÙˆØ¹ Ù‡Ù…Ú¯Ø§Ù…â€ŒØ³Ø§Ø²ÛŒ Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§...');
                
                // Ø´Ø¨ÛŒÙ‡â€ŒØ³Ø§Ø²ÛŒ ØªØ§Ø®ÛŒØ± Ø´Ø¨Ú©Ù‡
                await new Promise(resolve => setTimeout(resolve, 1000));
                
                const progress = this.progress.getProgress(this.currentUserId);
                
                if (progress) {
                    this.updateStepContent('step5-content', `
                        <strong style="color: #b9f6ca;">âœ… Ù‡Ù…Ú¯Ø§Ù…â€ŒØ³Ø§Ø²ÛŒ Ú©Ø§Ù…Ù„ Ø´Ø¯</strong><br>
                        ğŸ“¤ Ø§Ø±Ø³Ø§Ù„ ${progress.wordReviews.length} Ù…Ø±ÙˆØ± SRS<br>
                        ğŸ“¥ Ø¯Ø±ÛŒØ§ÙØª Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒâ€ŒÙ‡Ø§<br>
                        â± Ø²Ù…Ø§Ù†: ${new Date().toLocaleTimeString('fa-IR')}
                    `);
                    this.log(`âœ… Ù‡Ù…Ú¯Ø§Ù…â€ŒØ³Ø§Ø²ÛŒ Ù…ÙˆÙÙ‚ - ${progress.wordReviews.length} Ø¢ÛŒØªÙ… Ù‡Ù…Ú¯Ø§Ù… Ø´Ø¯`, 'success');
                } else {
                    this.log('âš ï¸ Ø¯Ø§Ø¯Ù‡â€ŒØ§ÛŒ Ø¨Ø±Ø§ÛŒ Ù‡Ù…Ú¯Ø§Ù…â€ŒØ³Ø§Ø²ÛŒ ÙˆØ¬ÙˆØ¯ Ù†Ø¯Ø§Ø±Ø¯', 'warning');
                }
            },

            // ========== Ø¬Ø±ÛŒØ§Ù† Ú©Ø§Ù…Ù„ Ø®ÙˆØ¯Ú©Ø§Ø± ==========
            async runFullFlow() {
                this.log('ğŸš€ Ø´Ø±ÙˆØ¹ Ø¬Ø±ÛŒØ§Ù† Ú©Ø§Ù…Ù„ Ú©Ø§Ø±Ø¨Ø± - Ø­Ø§Ù„Øª Ø®ÙˆØ¯Ú©Ø§Ø±', 'success');
                
                // Ú¯Ø§Ù… 1: ÙˆØ±ÙˆØ¯
                await this.login();
                
                // Ú¯Ø§Ù… 2: Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø¯Ø±Ø³
                await this.loadLesson();
                
                // Ú¯Ø§Ù… 3: Ø§Ù†Ø¬Ø§Ù… ØªÙ…Ø±ÛŒÙ†â€ŒÙ‡Ø§
                await new Promise(r => setTimeout(r, 500));
                this.startExercise('mc');
                
                await new Promise(r => setTimeout(r, 500));
                this.startExercise('fb');
                
                await new Promise(r => setTimeout(r, 500));
                this.startExercise('tl');
                
                await new Promise(r => setTimeout(r, 500));
                this.startExercise('pr');
                
                // Ú¯Ø§Ù… 4: Ø°Ø®ÛŒØ±Ù‡ Ù¾ÛŒØ´Ø±ÙØª
                await new Promise(r => setTimeout(r, 800));
                this.saveProgress();
                
                // Ú¯Ø§Ù… 5: Ù…Ø­Ø§Ø³Ø¨Ù‡ SRS
                await new Promise(r => setTimeout(r, 500));
                this.calculateSRS();
                
                this.log('ğŸ¯ Ø¬Ø±ÛŒØ§Ù† Ú©Ø§Ù…Ù„ Ú©Ø§Ø±Ø¨Ø± Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø§Ø¬Ø±Ø§ Ø´Ø¯', 'success');
            },

            // ========== Ø§Ø¨Ø²Ø§Ø±Ù‡Ø§ÛŒ Ú©Ù…Ú©ÛŒ ==========
            updateUserStatus(status) {
                document.getElementById('status-user').textContent = status;
            },

            updateLessonStatus(lessonTitle) {
                document.getElementById('status-lesson').textContent = lessonTitle;
            },

            updateProgressStatus(completed, xp) {
                document.getElementById('status-progress').textContent = `${xp} XP`;
            },

            updateStepContent(stepId, content) {
                const step = document.getElementById(stepId);
                if (step) {
                    step.innerHTML = content;
                }
            },

            resetAll() {
                // Ø±ÛŒØ³Øª Ø³Ø±ÙˆÛŒØ³â€ŒÙ‡Ø§
                this.auth = new AuthService();
                this.lesson = new LessonService();
                this.progress = new ProgressService();
                
                // Ø±ÛŒØ³Øª Ù…ØªØºÛŒØ±Ù‡Ø§
                this.currentUserId = null;
                this.currentLessonId = null;
                this.exerciseResults = [];
                this.offlineMode = false;
                
                // Ø±ÛŒØ³Øª UI
                this.updateUserStatus('Ø®Ø±ÙˆØ¬');
                this.updateLessonStatus('-');
                this.updateProgressStatus('0%', 0);
                
                // Ø±ÛŒØ³Øª Ú¯Ø§Ù…â€ŒÙ‡Ø§
                this.updateStepContent('step1-content', `
                    <strong>ğŸŸ¡ ÙˆØ¶Ø¹ÛŒØª:</strong> Ú©Ø§Ø±Ø¨Ø± ÙˆØ§Ø±Ø¯ Ù†Ø´Ø¯Ù‡ Ø§Ø³Øª<br>
                    <strong>ğŸ“ Ø³Ù†Ø§Ø±ÛŒÙˆ:</strong> Ø«Ø¨Øªâ€ŒÙ†Ø§Ù… Ú©Ø§Ø±Ø¨Ø± Ø¬Ø¯ÛŒØ¯ + ÙˆØ±ÙˆØ¯ Ø®ÙˆØ¯Ú©Ø§Ø±
                `);
                this.updateStepContent('step2-content', `
                    <strong>ğŸŸ¡ ÙˆØ¶Ø¹ÛŒØª:</strong> Ø¯Ø±Ø³ÛŒ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ù†Ø´Ø¯Ù‡<br>
                    <strong>ğŸ“š Ø¯Ø±Ø³ Ù†Ù…ÙˆÙ†Ù‡:</strong> Ø­ÛŒÙˆØ§Ù†Ø§Øª (Ø³Ø·Ø­ Û±) - Ûµ ÙˆØ§Ú˜Ù‡
                `);
                this.updateStepContent('step3-content', `
                    <strong>ğŸŸ¡ ÙˆØ¶Ø¹ÛŒØª:</strong> ØªÙ…Ø±ÛŒÙ†ÛŒ Ø´Ø±ÙˆØ¹ Ù†Ø´Ø¯Ù‡<br>
                    <strong>ğŸ¯ Ø³Ù†Ø§Ø±ÛŒÙˆ:</strong> Û´ Ù†ÙˆØ¹ ØªÙ…Ø±ÛŒÙ† + ØºÙ„Ø·â€ŒÚ¯ÛŒØ±ÛŒ Ø§Ù…Ù„Ø§ÛŒÛŒ
                `);
                this.updateStepContent('step4-content', `
                    <strong>ğŸŸ¡ ÙˆØ¶Ø¹ÛŒØª:</strong> Ù¾ÛŒØ´Ø±ÙØªÛŒ Ø«Ø¨Øª Ù†Ø´Ø¯Ù‡<br>
                    <strong>ğŸ§  SRS:</strong> Ù…Ø­Ø§Ø³Ø¨Ù‡ ÙØ§ØµÙ„Ù‡ Ù…Ø±ÙˆØ± Ø¨Ø¹Ø¯ÛŒ
                `);
                this.updateStepContent('step5-content', `
                    <strong>ğŸŸ¡ ÙˆØ¶Ø¹ÛŒØª:</strong> Ù‡Ù…Ú¯Ø§Ù…â€ŒØ³Ø§Ø²ÛŒ Ø§Ù†Ø¬Ø§Ù… Ù†Ø´Ø¯Ù‡<br>
                    <strong>ğŸ“¶ Ø³Ù†Ø§Ø±ÛŒÙˆ:</strong> Ø´Ø¨ÛŒÙ‡â€ŒØ³Ø§Ø²ÛŒ Ø¢ÙÙ„Ø§ÛŒÙ†/Ø¢Ù†Ù„Ø§ÛŒÙ†
                `);
                
                this.clearConsole();
                this.log('ğŸ§¹ Ø³ÛŒØ³ØªÙ… Ø±ÛŒØ³Øª Ø´Ø¯ - Ø¢Ù…Ø§Ø¯Ù‡ Ø¨Ø±Ø§ÛŒ ØªØ³Øª Ø¬Ø¯ÛŒØ¯', 'warning');
            },

            clearConsole() {
                const output = document.getElementById('console-output');
                output.innerHTML = '[Ø³ÛŒØ³ØªÙ…] Ú©Ù†Ø³ÙˆÙ„ Ù¾Ø§Ú© Ø´Ø¯ - Ø¢Ù…Ø§Ø¯Ù‡ Ø§Ø¬Ø±Ø§ÛŒ ØªØ³Øª Ø¯Ø³ØªÛŒ';
                this.logEntries = [];
                document.getElementById('log-count').textContent = '0 Ø±ÙˆÛŒØ¯Ø§Ø¯';
            }
        };

        // Ù…Ù‚Ø¯Ø§Ø±Ø¯Ù‡ÛŒ Ø§ÙˆÙ„ÛŒÙ‡
        window.onload = () => {
            FlowTest.log('ğŸš€ Ø³ÛŒØ³ØªÙ… ØªØ³Øª Ø¯Ø³ØªÛŒ Ø¢Ù…Ø§Ø¯Ù‡ Ø§Ø³Øª - Ø±ÙˆÛŒ Ø¯Ú©Ù…Ù‡â€ŒÙ‡Ø§ Ú©Ù„ÛŒÚ© Ú©Ù†ÛŒØ¯');
            
            // Ø«Ø¨Øª Ú©Ø§Ø±Ø¨Ø± Ù†Ù…ÙˆÙ†Ù‡
            setTimeout(() => {
                FlowTest.auth.register('test-user', '123456', 'test@example.com');
            }, 500);
        };
    </script>
</body>
</html>
