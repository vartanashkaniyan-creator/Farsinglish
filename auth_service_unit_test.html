<!DOCTYPE html>
<html lang="fa">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ØªØ³Øª ÙˆØ§Ø­Ø¯: Auth Service (JWT, Ù‡Ø´ØŒ Ø§Ø¹ØªØ¨Ø§Ø±Ø³Ù†Ø¬ÛŒ)</title>
    <style>
        body { font-family: system-ui, sans-serif; max-width: 900px; margin: 0 auto; padding: 20px; background: #f5f5f5; }
        .container { background: white; padding: 25px; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        h1 { color: #2c3e50; font-size: 1.8rem; }
        .test-card { background: #f8f9fa; border-radius: 8px; padding: 15px; margin: 15px 0; border-right: 6px solid #2c3e50; }
        .pass { background: #e8f5e9; border-right-color: #4caf50; }
        .fail { background: #ffebee; border-right-color: #f44336; }
        button { background: #2c3e50; color: white; border: none; padding: 12px 24px; border-radius: 6px; font-size: 16px; margin: 5px; cursor: pointer; }
        button:hover { background: #34495e; }
        .result { background: #e9ecef; padding: 15px; border-radius: 6px; margin-top: 15px; font-family: monospace; white-space: pre-wrap; max-height: 300px; overflow-y: auto; }
        .badge { background: #28a745; color: white; padding: 4px 12px; border-radius: 20px; font-size: 14px; display: inline-block; }
        pre { background: #2d2d2d; color: #f8f9fa; padding: 15px; border-radius: 6px; overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; margin-top: 15px; }
        td, th { padding: 10px; border-bottom: 1px solid #dee2e6; text-align: right; }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ” ØªØ³Øª ÙˆØ§Ø­Ø¯: Auth Service</h1>
        <span class="badge">Unit Test</span>
        <span style="background: #6c757d; color: white; padding: 4px 12px; border-radius: 20px; font-size: 14px; margin-right: 10px;">JWT + Ù‡Ø´ + Ø§Ø¹ØªØ¨Ø§Ø±Ø³Ù†Ø¬ÛŒ</span>

        <div style="display: flex; gap: 10px; margin-top: 20px;">
            <button onclick="runAllTests()">ğŸ§ª Ø§Ø¬Ø±Ø§ÛŒ ØªÙ…Ø§Ù… ØªØ³Øªâ€ŒÙ‡Ø§</button>
            <button onclick="resetResults()" style="background: #6c757d;">ğŸ§¹ Ù¾Ø§Ú© Ú©Ø±Ø¯Ù†</button>
        </div>

        <div id="results" class="result">
            ğŸ“‹ Ø¨Ø±Ø§ÛŒ Ø§Ø¬Ø±Ø§ÛŒ ØªØ³Øªâ€ŒÙ‡Ø§ Ø¯Ú©Ù…Ù‡ Ø¨Ø§Ù„Ø§ Ø±Ø§ Ø¨Ø²Ù†ÛŒØ¯.
        </div>

        <div id="summary" style="margin-top: 20px; padding: 15px; background: #2c3e50; color: white; border-radius: 8px; display: none;">
            âœ… Ø®Ù„Ø§ØµÙ‡ ØªØ³Øªâ€ŒÙ‡Ø§: <span id="summary-text"></span>
        </div>
    </div>

    <script>
        // ------------------------------------------------------------
        // Auth Service - Ù¾ÛŒØ§Ø¯Ù‡â€ŒØ³Ø§Ø²ÛŒ Ú©Ø§Ù…Ù„
        // ------------------------------------------------------------
        const AuthService = {
            // --- Ø§Ø¹ØªØ¨Ø§Ø±Ø³Ù†Ø¬ÛŒ ---
            validateUsername: function(username) {
                if (!username || typeof username !== 'string') return false;
                return username.length >= 3 && username.length <= 40 && /^[a-zA-Z0-9_]+$/.test(username);
            },

            validateEmail: function(email) {
                if (!email || typeof email !== 'string') return false;
                const regex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
                return regex.test(email) && email.length <= 100;
            },

            validatePassword: function(password) {
                if (!password || typeof password !== 'string') return false;
                return password.length >= 6 && password.length <= 50;
            },

            // --- Ù‡Ø´ (Ø´Ø¨ÛŒÙ‡â€ŒØ³Ø§Ø²ÛŒ) ---
            hashPassword: function(password) {
                if (!password) return null;
                let hash = 0;
                for (let i = 0; i < password.length; i++) {
                    const char = password.charCodeAt(i);
                    hash = ((hash << 5) - hash) + char;
                    hash = hash & hash;
                }
                return Math.abs(hash).toString(16) + Date.now().toString(16).slice(-4);
            },

            verifyPassword: function(plainPassword, hashedPassword) {
                return this.hashPassword(plainPassword) === hashedPassword;
            },

            // --- JWT (Ø´Ø¨ÛŒÙ‡â€ŒØ³Ø§Ø²ÛŒ Ø´Ø¯Ù‡) ---
            generateToken: function(payload, expiresInHours = 24) {
                const header = btoa(JSON.stringify({ alg: 'HS256', typ: 'JWT' }));
                const encodedPayload = btoa(JSON.stringify({
                    ...payload,
                    exp: Date.now() + (expiresInHours * 60 * 60 * 1000),
                    iat: Date.now(),
                    jti: Math.random().toString(36).substring(2, 15)
                }));
                const signature = btoa('signature_' + payload.userId + '_' + Date.now());
                return `${header}.${encodedPayload}.${signature}`;
            },

            verifyToken: function(token) {
                try {
                    const parts = token.split('.');
                    if (parts.length !== 3) return null;
                    
                    const payload = JSON.parse(atob(parts[1]));
                    if (payload.exp && payload.exp < Date.now()) return null;
                    
                    return payload;
                } catch {
                    return null;
                }
            },

            refreshToken: function(oldToken) {
                const payload = this.verifyToken(oldToken);
                if (!payload) return null;
                
                return this.generateToken(
                    { userId: payload.userId, email: payload.email },
                    24
                );
            },

            // --- Ø«Ø¨Øªâ€ŒÙ†Ø§Ù… Ùˆ ÙˆØ±ÙˆØ¯ ---
            register: function(username, email, password) {
                if (!this.validateUsername(username)) return { success: false, error: 'Ù†Ø§Ù… Ú©Ø§Ø±Ø¨Ø±ÛŒ Ù†Ø§Ù…Ø¹ØªØ¨Ø±' };
                if (!this.validateEmail(email)) return { success: false, error: 'Ø§ÛŒÙ…ÛŒÙ„ Ù†Ø§Ù…Ø¹ØªØ¨Ø±' };
                if (!this.validatePassword(password)) return { success: false, error: 'Ø±Ù…Ø² Ø¹Ø¨ÙˆØ± Ø¨Ø§ÛŒØ¯ Ø¨ÛŒÙ† Û¶ ØªØ§ ÛµÛ° Ú©Ø§Ø±Ø§Ú©ØªØ± Ø¨Ø§Ø´Ø¯' };

                const user = {
                    id: 'usr_' + Date.now(),
                    username,
                    email,
                    passwordHash: this.hashPassword(password),
                    createdAt: new Date().toISOString(),
                    xp: 0,
                    level: 1
                };

                const token = this.generateToken({ userId: user.id, email: user.email });
                return { success: true, user, token };
            },

            login: function(email, password, storedHash) {
                if (!this.validateEmail(email)) return { success: false, error: 'Ø§ÛŒÙ…ÛŒÙ„ Ù†Ø§Ù…Ø¹ØªØ¨Ø±' };
                if (!this.validatePassword(password)) return { success: false, error: 'Ø±Ù…Ø² Ø¹Ø¨ÙˆØ± Ù†Ø§Ù…Ø¹ØªØ¨Ø±' };
                
                if (this.verifyPassword(password, storedHash)) {
                    const token = this.generateToken({ userId: 'usr_' + Date.now(), email });
                    return { success: true, token };
                }
                return { success: false, error: 'Ø§ÛŒÙ…ÛŒÙ„ ÛŒØ§ Ø±Ù…Ø² Ø¹Ø¨ÙˆØ± Ø§Ø´ØªØ¨Ø§Ù‡ Ø§Ø³Øª' };
            }
        };

        // ------------------------------------------------------------
        // ØªØ³Øªâ€ŒÙ‡Ø§ÛŒ ÙˆØ§Ø­Ø¯
        // ------------------------------------------------------------
        const tests = [
            {
                name: 'âœ… Ø§Ø¹ØªØ¨Ø§Ø±Ø³Ù†Ø¬ÛŒ Ù†Ø§Ù… Ú©Ø§Ø±Ø¨Ø±ÛŒ - Ù…Ø¹ØªØ¨Ø±',
                fn: () => AuthService.validateUsername('farsinglish_user') === true
            },
            {
                name: 'âŒ Ø§Ø¹ØªØ¨Ø§Ø±Ø³Ù†Ø¬ÛŒ Ù†Ø§Ù… Ú©Ø§Ø±Ø¨Ø±ÛŒ - Ú©ÙˆØªØ§Ù‡',
                fn: () => AuthService.validateUsername('ab') === false
            },
            {
                name: 'âœ… Ø§Ø¹ØªØ¨Ø§Ø±Ø³Ù†Ø¬ÛŒ Ø§ÛŒÙ…ÛŒÙ„ - Ù…Ø¹ØªØ¨Ø±',
                fn: () => AuthService.validateEmail('user@example.com') === true
            },
            {
                name: 'âŒ Ø§Ø¹ØªØ¨Ø§Ø±Ø³Ù†Ø¬ÛŒ Ø§ÛŒÙ…ÛŒÙ„ - Ø¨Ø¯ÙˆÙ† @',
                fn: () => AuthService.validateEmail('userexample.com') === false
            },
            {
                name: 'âœ… Ø§Ø¹ØªØ¨Ø§Ø±Ø³Ù†Ø¬ÛŒ Ø±Ù…Ø² Ø¹Ø¨ÙˆØ± - Ù…Ø¹ØªØ¨Ø±',
                fn: () => AuthService.validatePassword('123456') === true
            },
            {
                name: 'âŒ Ø§Ø¹ØªØ¨Ø§Ø±Ø³Ù†Ø¬ÛŒ Ø±Ù…Ø² Ø¹Ø¨ÙˆØ± - Ú©ÙˆØªØ§Ù‡',
                fn: () => AuthService.validatePassword('12345') === false
            },
            {
                name: 'ğŸ” Ù‡Ø´ Ú©Ø±Ø¯Ù† Ø±Ù…Ø² Ø¹Ø¨ÙˆØ± - Ø®Ø±ÙˆØ¬ÛŒ ÛŒÚ©Ø³Ø§Ù† Ø¨Ø±Ø§ÛŒ ÙˆØ±ÙˆØ¯ÛŒ ÛŒÚ©Ø³Ø§Ù†',
                fn: () => AuthService.hashPassword('password123') === AuthService.hashPassword('password123')
            },
            {
                name: 'ğŸ” ØªØ£ÛŒÛŒØ¯ Ø±Ù…Ø² Ø¹Ø¨ÙˆØ± - ØµØ­ÛŒØ­',
                fn: () => {
                    const hash = AuthService.hashPassword('mypass');
                    return AuthService.verifyPassword('mypass', hash) === true;
                }
            },
            {
                name: 'ğŸ” ØªØ£ÛŒÛŒØ¯ Ø±Ù…Ø² Ø¹Ø¨ÙˆØ± - Ù†Ø§Ø¯Ø±Ø³Øª',
                fn: () => {
                    const hash = AuthService.hashPassword('mypass');
                    return AuthService.verifyPassword('wrongpass', hash) === false;
                }
            },
            {
                name: 'ğŸ« ØªÙˆÙ„ÛŒØ¯ JWT - Ø³Ø§Ø®ØªØ§Ø± Ø³Ù‡â€ŒÙ‚Ø³Ù…ØªÛŒ',
                fn: () => {
                    const token = AuthService.generateToken({ userId: '123', email: 'test@test.com' });
                    return token.split('.').length === 3;
                }
            },
            {
                name: 'ğŸ« Ø§Ø¹ØªØ¨Ø§Ø±Ø³Ù†Ø¬ÛŒ JWT - Ù…Ø¹ØªØ¨Ø±',
                fn: () => {
                    const token = AuthService.generateToken({ userId: '123', email: 'test@test.com' });
                    const payload = AuthService.verifyToken(token);
                    return payload && payload.userId === '123';
                }
            },
            {
                name: 'ğŸ« Ø§Ø¹ØªØ¨Ø§Ø±Ø³Ù†Ø¬ÛŒ JWT - ØªÙˆÚ©Ù† Ø®Ø±Ø§Ø¨',
                fn: () => AuthService.verifyToken('invalid.token.string') === null
            },
            {
                name: 'ğŸ”„ ØªÙ…Ø¯ÛŒØ¯ JWT - Ù…ÙˆÙÙ‚',
                fn: () => {
                    const token = AuthService.generateToken({ userId: '123', email: 'test@test.com' });
                    const newToken = AuthService.refreshToken(token);
                    return newToken !== null && newToken !== token;
                }
            },
            {
                name: 'ğŸ“ Ø«Ø¨Øªâ€ŒÙ†Ø§Ù… - Ù…ÙˆÙÙ‚',
                fn: () => {
                    const result = AuthService.register('newuser', 'new@test.com', 'password123');
                    return result.success && result.user && result.token;
                }
            },
            {
                name: 'ğŸ“ Ø«Ø¨Øªâ€ŒÙ†Ø§Ù… - Ù†Ø§Ù… Ú©Ø§Ø±Ø¨Ø±ÛŒ ØªÚ©Ø±Ø§Ø±ÛŒ (Ø´Ø¨ÛŒÙ‡â€ŒØ³Ø§Ø²ÛŒ)',
                fn: () => {
                    // Ø§ÛŒÙ† ØªØ³Øª ÙÙ‚Ø· Ø§Ø¹ØªØ¨Ø§Ø±Ø³Ù†Ø¬ÛŒ Ø±Ø§ Ú†Ú© Ù…ÛŒâ€ŒÚ©Ù†Ø¯
                    const result = AuthService.register('us', 'test@test.com', 'pass123');
                    return result.success === false;
                }
            },
            {
                name: 'ğŸ”‘ ÙˆØ±ÙˆØ¯ - Ù…ÙˆÙÙ‚',
                fn: () => {
                    const hash = AuthService.hashPassword('correctpass');
                    const result = AuthService.login('user@test.com', 'correctpass', hash);
                    return result.success === true;
                }
            },
            {
                name: 'ğŸ”‘ ÙˆØ±ÙˆØ¯ - Ø±Ù…Ø² Ø§Ø´ØªØ¨Ø§Ù‡',
                fn: () => {
                    const hash = AuthService.hashPassword('correctpass');
                    const result = AuthService.login('user@test.com', 'wrongpass', hash);
                    return result.success === false;
                }
            }
        ];

        // ------------------------------------------------------------
        // Ø§Ø¬Ø±Ø§ÛŒ ØªØ³Øªâ€ŒÙ‡Ø§
        // ------------------------------------------------------------
        function runAllTests() {
            const resultsDiv = document.getElementById('results');
            const summaryDiv = document.getElementById('summary');
            const summaryText = document.getElementById('summary-text');
            
            let passed = 0;
            let html = '<table><tr><th>#</th><th>Ù†Ø§Ù… ØªØ³Øª</th><th>ÙˆØ¶Ø¹ÛŒØª</th><th>ØªÙˆØ¶ÛŒØ­</th></tr>';
            
            tests.forEach((test, index) => {
                try {
                    const result = test.fn();
                    if (result) {
                        passed++;
                        html += `<tr style="background: #e8f5e9;">
                                    <td>${index + 1}</td>
                                    <td>${test.name}</td>
                                    <td>âœ… Ù¾Ø§Ø³</td>
                                    <td>Ù…ÙˆÙÙ‚</td>
                                </tr>`;
                    } else {
                        html += `<tr style="background: #ffebee;">
                                    <td>${index + 1}</td>
                                    <td>${test.name}</td>
                                    <td>âŒ Ø®Ø·Ø§</td>
                                    <td>Ù…Ù‚Ø¯Ø§Ø± Ø¨Ø§Ø²Ú¯Ø´ØªÛŒ false</td>
                                </tr>`;
                    }
                } catch(e) {
                    html += `<tr style="background: #ffebee;">
                                <td>${index + 1}</td>
                                <td>${test.name}</td>
                                <td>âš ï¸ Ø®Ø·Ø§</td>
                                <td>${e.message}</td>
                            </tr>`;
                }
            });
            
            html += '</table>';
            resultsDiv.innerHTML = html;
            
            summaryDiv.style.display = 'block';
            summaryText.innerHTML = `âœ… ${passed} Ø§Ø² ${tests.length} ØªØ³Øª Ù¾Ø§Ø³ Ø´Ø¯ (${Math.round((passed/tests.length)*100)}%)`;
            
            // Ù†Ù…Ø§ÛŒØ´ Ø¯Ø± Ú©Ù†Ø³ÙˆÙ„
            console.log(`ğŸ” Auth Service Unit Tests: ${passed}/${tests.length} passed`);
            if (passed === tests.length) console.log('ğŸ‰ Ù‡Ù…Ù‡ ØªØ³Øªâ€ŒÙ‡Ø§ Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ù¾Ø§Ø³ Ø´Ø¯Ù†Ø¯!');
        }

        function resetResults() {
            document.getElementById('results').innerHTML = 'ğŸ“‹ Ø¨Ø±Ø§ÛŒ Ø§Ø¬Ø±Ø§ÛŒ ØªØ³Øªâ€ŒÙ‡Ø§ Ø¯Ú©Ù…Ù‡ Ø¨Ø§Ù„Ø§ Ø±Ø§ Ø¨Ø²Ù†ÛŒØ¯.';
            document.getElementById('summary').style.display = 'none';
        }
    </script>
</body>
</html>
