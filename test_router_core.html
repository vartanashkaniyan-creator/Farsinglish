<!DOCTYPE html>
<html lang="fa">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Farsinglish - ØªØ³Øª Ù‡Ø³ØªÙ‡ Ù…Ø³ÛŒØ±ÛŒØ§Ø¨ÛŒ</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif;
            background: linear-gradient(135deg, #1a237e 0%, #283593 100%);
            color: #e3f2fd;
            min-height: 100vh;
            padding: 15px;
        }
        .container { 
            max-width: 800px; 
            margin: 0 auto;
            background: rgba(30, 35, 70, 0.9);
            border-radius: 12px;
            padding: 18px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
            border: 1px solid rgba(100, 150, 255, 0.3);
        }
        h1 { 
            text-align: center; 
            margin-bottom: 20px;
            font-size: 1.6rem;
            color: #82b1ff;
        }
        .test-section { 
            margin: 15px 0;
            padding: 14px;
            background: rgba(40, 45, 80, 0.8);
            border-radius: 8px;
            border-left: 4px solid #4fc3f7;
        }
        .test-header { 
            display: flex; 
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            flex-wrap: wrap;
        }
        .test-title { 
            font-size: 0.95rem; 
            font-weight: 600;
            color: #bb86fc;
            flex: 1;
        }
        .test-result { 
            padding: 4px 10px;
            border-radius: 10px;
            font-size: 0.8rem;
            font-weight: bold;
        }
        .pass { background: #4caf50; }
        .fail { background: #f44336; }
        .details { 
            margin-top: 8px;
            padding: 10px;
            background: rgba(0, 0, 30, 0.6);
            border-radius: 6px;
            font-family: monospace;
            font-size: 0.8rem;
            color: #a5d6a7;
            border: 1px solid rgba(100, 150, 200, 0.3);
        }
        .summary {
            margin-top: 20px;
            padding: 15px;
            background: rgba(40, 45, 80, 0.8);
            border-radius: 8px;
            text-align: center;
            font-size: 0.95rem;
        }
        button {
            background: #2962ff;
            color: white;
            border: none;
            padding: 8px 18px;
            border-radius: 6px;
            font-size: 0.85rem;
            cursor: pointer;
            margin: 5px;
        }
        .controls { text-align: center; margin-top: 15px; }
        .route-tag {
            display: inline-block;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 0.7rem;
            margin-left: 6px;
            background: rgba(100, 150, 255, 0.2);
            color: #82b1ff;
            font-family: monospace;
        }
        @media (max-width: 600px) {
            .test-header { flex-direction: column; align-items: flex-start; }
            .test-title { margin-bottom: 6px; }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ§­ ØªØ³Øª Ù‡Ø³ØªÙ‡ Ù…Ø³ÛŒØ±ÛŒØ§Ø¨ÛŒ - Û¸ ØªØ³Øª</h1>
        
        <div id="test-results"></div>
        
        <div class="summary">
            <p id="summary-text">ØªØ³Øªâ€ŒÙ‡Ø§ÛŒ Ù‡Ø³ØªÙ‡ Ù…Ø³ÛŒØ±ÛŒØ§Ø¨ÛŒ</p>
        </div>
        
        <div class="controls">
            <button onclick="runAllTests()">â–¶ï¸ Ø§Ø¬Ø±Ø§ÛŒ ØªØ³Øªâ€ŒÙ‡Ø§</button>
            <button onclick="clearTests()">ğŸ—‘ï¸ Ù¾Ø§Ú© Ú©Ø±Ø¯Ù†</button>
        </div>
    </div>

    <script>
        // ==================== Router Core ====================
        class RouterCore {
            constructor() {
                this.routes = new Map();
                this.currentRoute = '/';
                this.history = [];
                this.isAuthenticated = false;
                this.userRole = 'guest';
                
                this.initRoutes();
            }
            
            initRoutes() {
                this.routes.set('/', {
                    name: 'Ø®Ø§Ù†Ù‡',
                    requiresAuth: false,
                    roles: ['guest', 'user', 'admin']
                });
                
                this.routes.set('/login', {
                    name: 'ÙˆØ±ÙˆØ¯',
                    requiresAuth: false,
                    roles: ['guest']
                });
                
                this.routes.set('/dashboard', {
                    name: 'Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯',
                    requiresAuth: true,
                    roles: ['user', 'admin']
                });
                
                this.routes.set('/admin', {
                    name: 'Ù…Ø¯ÛŒØ±ÛŒØª',
                    requiresAuth: true,
                    roles: ['admin']
                });
                
                this.routes.set('/404', {
                    name: 'ÛŒØ§ÙØª Ù†Ø´Ø¯',
                    requiresAuth: false,
                    roles: ['guest', 'user', 'admin']
                });
            }
            
            async navigate(toPath, options = {}) {
                // Ø¨Ø±Ø±Ø³ÛŒ ÙˆØ¬ÙˆØ¯ Ù…Ø³ÛŒØ±
                if (!this.routes.has(toPath)) {
                    console.log(`Ù…Ø³ÛŒØ± ${toPath} ÛŒØ§ÙØª Ù†Ø´Ø¯`);
                    return this.navigate('/404', { replace: true });
                }
                
                const to = this.routes.get(toPath);
                const from = this.routes.get(this.currentRoute);
                
                // Guard Ø§Ø­Ø±Ø§Ø² Ù‡ÙˆÛŒØª
                if (to.requiresAuth && !this.isAuthenticated) {
                    console.log('Ù†ÛŒØ§Ø² Ø¨Ù‡ Ø§Ø­Ø±Ø§Ø² Ù‡ÙˆÛŒØª');
                    return this.navigate('/login', { replace: true });
                }
                
                // Guard Ù†Ù‚Ø´ Ú©Ø§Ø±Ø¨Ø±
                if (to.roles && !to.roles.includes(this.userRole)) {
                    console.log('Ø¯Ø³ØªØ±Ø³ÛŒ ØºÛŒØ±Ù…Ø¬Ø§Ø²');
                    return false;
                }
                
                // Guard Ù…Ù‡Ù…Ø§Ù† (Ø¨Ø±Ø§ÛŒ ØµÙØ­Ø§Øª ÙˆØ±ÙˆØ¯/Ø«Ø¨Øªâ€ŒÙ†Ø§Ù…)
                if ((toPath === '/login' || toPath === '/register') && this.isAuthenticated) {
                    console.log('Ú©Ø§Ø±Ø¨Ø± Ù‚Ø¨Ù„Ø§Ù‹ ÙˆØ§Ø±Ø¯ Ø´Ø¯Ù‡');
                    return this.navigate('/dashboard', { replace: true });
                }
                
                // Ø§Ù†Ø¬Ø§Ù… Ù…Ø³ÛŒØ±ÛŒØ§Ø¨ÛŒ
                const previous = this.currentRoute;
                this.currentRoute = toPath;
                
                if (!options.replace && previous !== toPath) {
                    this.history.push(previous);
                }
                
                console.log(`Ù…Ø³ÛŒØ±ÛŒØ§Ø¨ÛŒ: ${previous} â†’ ${toPath}`);
                return true;
            }
            
            goBack() {
                if (this.history.length > 0) {
                    const previous = this.history.pop();
                    return this.navigate(previous, { replace: true });
                }
                return false;
            }
            
            setAuth(authenticated, role = 'user') {
                this.isAuthenticated = authenticated;
                this.userRole = role;
            }
            
            addRoute(path, config) {
                if (this.routes.has(path)) return false;
                this.routes.set(path, config);
                return true;
            }
            
            getParams(path) {
                if (!path.includes(':')) return null;
                const params = [];
                const parts = path.split('/');
                parts.forEach(part => {
                    if (part.startsWith(':')) {
                        params.push(part.substring(1));
                    }
                });
                return params;
            }
        }

        // ==================== ØªØ³Øªâ€ŒÙ‡Ø§ÛŒ Ù‡Ø³ØªÙ‡ ====================
        const coreTests = [
            {
                id: 1,
                title: "Ù…Ø³ÛŒØ±ÛŒØ§Ø¨ÛŒ Ø³Ø§Ø¯Ù‡ Ø¨Ù‡ ØµÙØ­Ù‡ Ø§ØµÙ„ÛŒ",
                route: "/",
                run: async () => {
                    const router = new RouterCore();
                    const result = await router.navigate('/');
                    return result && router.currentRoute === '/';
                }
            },
            {
                id: 2,
                title: "Guard Ø§Ø­Ø±Ø§Ø² - Ø¯Ø³ØªØ±Ø³ÛŒ Ø¨Ù‡ Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯ Ø¨Ø¯ÙˆÙ† Ù„Ø§Ú¯ÛŒÙ†",
                route: "/dashboard",
                run: async () => {
                    const router = new RouterCore();
                    router.setAuth(false, 'guest');
                    const result = await router.navigate('/dashboard');
                    return !result && router.currentRoute === '/login';
                }
            },
            {
                id: 3,
                title: "Guard Ø§Ø­Ø±Ø§Ø² - Ø¯Ø³ØªØ±Ø³ÛŒ Ø¨Ù‡ Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯ Ø¨Ø§ Ù„Ø§Ú¯ÛŒÙ†",
                route: "/dashboard",
                run: async () => {
                    const router = new RouterCore();
                    router.setAuth(true, 'user');
                    const result = await router.navigate('/dashboard');
                    return result && router.currentRoute === '/dashboard';
                }
            },
            {
                id: 4,
                title: "Guard Ù†Ù‚Ø´ - Ú©Ø§Ø±Ø¨Ø± Ø¹Ø§Ø¯ÛŒ Ø¨Ù‡ Ø§Ø¯Ù…ÛŒÙ† Ø¯Ø³ØªØ±Ø³ÛŒ Ù†Ø¯Ø§Ø±Ø¯",
                route: "/admin",
                run: async () => {
                    const router = new RouterCore();
                    router.setAuth(true, 'user');
                    const result = await router.navigate('/admin');
                    return !result && router.currentRoute === '/';
                }
            },
            {
                id: 5,
                title: "ØªØ§Ø±ÛŒØ®Ú†Ù‡ Ù…Ø³ÛŒØ±ÛŒØ§Ø¨ÛŒ Ùˆ Ù‚Ø§Ø¨Ù„ÛŒØª Ø¨Ø§Ø²Ú¯Ø´Øª",
                route: "history",
                run: async () => {
                    const router = new RouterCore();
                    router.setAuth(true, 'user');
                    
                    await router.navigate('/dashboard');
                    await router.navigate('/');
                    
                    const historyCount = router.history.length;
                    const canGoBack = router.goBack();
                    
                    return historyCount === 1 && canGoBack && router.currentRoute === '/';
                }
            },
            {
                id: 6,
                title: "Ù…Ø¯ÛŒØ±ÛŒØª Ù…Ø³ÛŒØ±Ù‡Ø§ÛŒ Ù†Ø§Ù…ÙˆØ¬ÙˆØ¯ (404)",
                route: "/not-found",
                run: async () => {
                    const router = new RouterCore();
                    const result = await router.navigate('/invalid-route');
                    return !result && router.currentRoute === '/404';
                }
            },
            {
                id: 7,
                title: "Ø§ÙØ²ÙˆØ¯Ù† Ù…Ø³ÛŒØ± Ø¯Ø§ÛŒÙ†Ø§Ù…ÛŒÚ©",
                route: "/dynamic",
                run: async () => {
                    const router = new RouterCore();
                    
                    const added = router.addRoute('/user/:id', {
                        name: 'Ú©Ø§Ø±Ø¨Ø±',
                        requiresAuth: true,
                        roles: ['user', 'admin']
                    });
                    
                    const params = router.getParams('/user/:id');
                    const hasParam = params && params.includes('id');
                    
                    return added && hasParam;
                }
            },
            {
                id: 8,
                title: "Ù…Ø³ÛŒØ±ÛŒØ§Ø¨ÛŒ Ø¨Ø§ replace (Ø¨Ø¯ÙˆÙ† ØªØ§Ø±ÛŒØ®Ú†Ù‡)",
                route: "/replace",
                run: async () => {
                    const router = new RouterCore();
                    router.setAuth(true, 'user');
                    
                    await router.navigate('/dashboard');
                    const historyBefore = router.history.length;
                    
                    await router.navigate('/', { replace: true });
                    const historyAfter = router.history.length;
                    
                    return historyBefore === 1 && historyAfter === 1;
                }
            }
        ];

        // ==================== Ø§Ø¬Ø±Ø§ÛŒ ØªØ³Øªâ€ŒÙ‡Ø§ ====================
        let passedTests = 0;
        let failedTests = 0;

        async function runAllTests() {
            passedTests = 0;
            failedTests = 0;
            const resultsDiv = document.getElementById('test-results');
            resultsDiv.innerHTML = '';
            
            for (const test of coreTests) {
                try {
                    const result = await test.run();
                    const testDiv = document.createElement('div');
                    testDiv.className = 'test-section';
                    
                    const testResult = result ? 'pass' : 'fail';
                    const resultText = result ? 'âœ… Ù…ÙˆÙÙ‚' : 'âŒ Ù†Ø§Ù…ÙˆÙÙ‚';
                    
                    if (result) passedTests++;
                    else failedTests++;
                    
                    testDiv.innerHTML = `
                        <div class="test-header">
                            <div class="test-title">
                                ${test.id}. ${test.title}
                                <span class="route-tag">${test.route}</span>
                            </div>
                            <div class="test-result ${testResult}">${resultText}</div>
                        </div>
                    `;
                    
                    resultsDiv.appendChild(testDiv);
                } catch (error) {
                    failedTests++;
                    const testDiv = document.createElement('div');
                    testDiv.className = 'test-section';
                    testDiv.innerHTML = `
                        <div class="test-header">
                            <div class="test-title">${test.id}. ${test.title}</div>
                            <div class="test-result fail">âŒ Ø®Ø·Ø§</div>
                        </div>
                        <div class="details">${error.message}</div>
                    `;
                    resultsDiv.appendChild(testDiv);
                }
                
                updateSummary();
            }
        }

        function clearTests() {
            document.getElementById('test-results').innerHTML = '';
            passedTests = failedTests = 0;
            updateSummary();
        }

        function updateSummary() {
            const summary = document.getElementById('summary-text');
            const total = coreTests.length;
            const percentage = total > 0 ? Math.round((passedTests / total) * 100) : 0;
            
            summary.textContent = 
                `âœ… ${passedTests} Ù…ÙˆÙÙ‚ | âŒ ${failedTests} Ù†Ø§Ù…ÙˆÙÙ‚ | ğŸ“Š ${percentage}% Ù‚Ø¨ÙˆÙ„ÛŒ`;
            
            summary.style.color = percentage >= 90 ? '#4caf50' : 
                                 percentage >= 70 ? '#ff9800' : '#f44336';
        }

        // Ø§Ø¬Ø±Ø§ÛŒ Ø®ÙˆØ¯Ú©Ø§Ø±
        window.onload = () => {
            updateSummary();
            setTimeout(runAllTests, 300);
        };
    </script>
</body>
</html>
