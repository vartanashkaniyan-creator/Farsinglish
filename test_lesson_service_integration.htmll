<!DOCTYPE html>
<html lang="fa">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ØªØ³Øª ÛŒÚ©Ù¾Ø§Ø±Ú†Ú¯ÛŒ: Lesson Service + Mock DB</title>
    <style>
        body { font-family: system-ui, sans-serif; max-width: 900px; margin: 0 auto; padding: 20px; background: #f5f5f5; }
        .container { background: white; padding: 25px; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        h1 { color: #2c3e50; font-size: 1.8rem; }
        .card { background: #f8f9fa; border-radius: 8px; padding: 20px; margin: 20px 0; border: 1px solid #dee2e6; }
        button { background: #2c3e50; color: white; border: none; padding: 10px 20px; border-radius: 6px; font-size: 14px; margin: 5px; cursor: pointer; }
        button:hover { background: #34495e; }
        .result { background: #e9ecef; padding: 15px; border-radius: 6px; margin-top: 15px; font-family: monospace; white-space: pre-wrap; max-height: 300px; overflow-y: auto; }
        .badge { background: #28a745; color: white; padding: 2px 8px; border-radius: 12px; font-size: 12px; }
        pre { background: #2d2d2d; color: #f8f9fa; padding: 15px; border-radius: 6px; overflow-x: auto; }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ§ª ØªØ³Øª ÛŒÚ©Ù¾Ø§Ø±Ú†Ú¯ÛŒ: Lesson Service + Mock IndexedDB</h1>
        <p>Ø´Ø¨ÛŒÙ‡â€ŒØ³Ø§Ø²ÛŒ Ø´Ø¯Ù‡ Ø¨Ø§ Ø¯ÛŒØªØ§Ø¨ÛŒØ³ Ø¬Ø¹Ø¨ÛŒ - <span class="badge">Integration Test</span></p>

        <div class="card">
            <h3>ğŸ“¥ Û±. Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø¯Ø±Ø³â€ŒÙ‡Ø§ Ø§Ø² Mock DB</h3>
            <button onclick="testLoadLessons()">Ø§Ø¬Ø±Ø§</button>
            <div id="result1" class="result">Ø¨Ø±Ø§ÛŒ Ù†Ù…Ø§ÛŒØ´ Ù†ØªÛŒØ¬Ù‡ Ú©Ù„ÛŒÚ© Ú©Ù†</div>
        </div>

        <div class="card">
            <h3>âœ… Û². Ø°Ø®ÛŒØ±Ù‡ Ù¾Ø§Ø³Ø® Ú©Ø§Ø±Ø¨Ø± Ùˆ Ù…Ø­Ø§Ø³Ø¨Ù‡ SRS</h3>
            <button onclick="testSaveAnswer()">Ø§Ø¬Ø±Ø§</button>
            <div id="result2" class="result">Ø¨Ø±Ø§ÛŒ Ù†Ù…Ø§ÛŒØ´ Ù†ØªÛŒØ¬Ù‡ Ú©Ù„ÛŒÚ© Ú©Ù†</div>
        </div>

        <div class="card">
            <h3>ğŸ“Š Û³. Ø¯Ø±ÛŒØ§ÙØª Ù¾ÛŒØ´Ø±ÙØª Ø¯Ø±Ø³</h3>
            <button onclick="testGetProgress()">Ø§Ø¬Ø±Ø§</button>
            <div id="result3" class="result">Ø¨Ø±Ø§ÛŒ Ù†Ù…Ø§ÛŒØ´ Ù†ØªÛŒØ¬Ù‡ Ú©Ù„ÛŒÚ© Ú©Ù†</div>
        </div>

        <div class="card">
            <h3>ğŸ¯ Û´. ØªÙˆÙ„ÛŒØ¯ ØªÙ…Ø±ÛŒÙ† Ù‡ÙˆØ´Ù…Ù†Ø¯ Ø¨Ø± Ø§Ø³Ø§Ø³ SRS</h3>
            <button onclick="testGenerateExercise()">Ø§Ø¬Ø±Ø§</button>
            <div id="result4" class="result">Ø¨Ø±Ø§ÛŒ Ù†Ù…Ø§ÛŒØ´ Ù†ØªÛŒØ¬Ù‡ Ú©Ù„ÛŒÚ© Ú©Ù†</div>
        </div>

        <div class="card">
            <h3>ğŸ”„ Ûµ. Ø¬Ø±ÛŒØ§Ù† Ú©Ø§Ù…Ù„: Ø¯Ø±Ø³ â†’ ØªÙ…Ø±ÛŒÙ† â†’ Ø°Ø®ÛŒØ±Ù‡ â†’ Ù¾ÛŒØ´Ø±ÙØª</h3>
            <button onclick="testFullFlow()">Ø§Ø¬Ø±Ø§ÛŒ Ø³Ù†Ø§Ø±ÛŒÙˆÛŒ Ú©Ø§Ù…Ù„</button>
            <div id="result5" class="result">Ø¨Ø±Ø§ÛŒ Ù†Ù…Ø§ÛŒØ´ Ù†ØªÛŒØ¬Ù‡ Ú©Ù„ÛŒÚ© Ú©Ù†</div>
        </div>

        <div style="display: flex; gap: 10px; margin-top: 20px;">
            <button onclick="clearAll()" style="background: #6c757d;">ğŸ§¹ Ù¾Ø§Ú© Ú©Ø±Ø¯Ù† Ù‡Ù…Ù‡</button>
            <button onclick="runAll()" style="background: #007bff;">âš¡ Ø§Ø¬Ø±Ø§ÛŒ ØªÙ…Ø§Ù… ØªØ³Øªâ€ŒÙ‡Ø§</button>
        </div>
    </div>

    <script>
        // ------------------------------------------------------------
        // Mock IndexedDB (Ø´Ø¨ÛŒÙ‡â€ŒØ³Ø§Ø²ÛŒ Ø´Ø¯Ù‡)
        // ------------------------------------------------------------
        const MockDB = {
            data: {
                lessons: [
                    { id: 'L1', title: 'Ø¯Ø±Ø³ Û±: Greetings', level: 1, vocabCount: 5 },
                    { id: 'L2', title: 'Ø¯Ø±Ø³ Û²: Family', level: 1, vocabCount: 6 },
                    { id: 'L3', title: 'Ø¯Ø±Ø³ Û³: Food', level: 2, vocabCount: 8 }
                ],
                progresses: [
                    { userId: 'user1', lessonId: 'L1', status: 'completed', score: 85, lastReview: '2026-02-10' }
                ],
                reviews: []
            },
            
            get: function(store, id) {
                if (!this.data[store]) return null;
                if (id) return this.data[store].find(item => item.id === id);
                return [...this.data[store]];
            },
            
            save: function(store, item) {
                if (!this.data[store]) this.data[store] = [];
                const index = this.data[store].findIndex(i => i.id === item.id);
                if (index >= 0) this.data[store][index] = item;
                else this.data[store].push(item);
                return { success: true, item };
            },
            
            delete: function(store, id) {
                if (!this.data[store]) return false;
                this.data[store] = this.data[store].filter(i => i.id !== id);
                return true;
            },
            
            clear: function() {
                this.data.lessons = [...this.data.lessons.slice(0, 3)]; // keep original lessons
                this.data.progresses = [];
                this.data.reviews = [];
            }
        };

        // ------------------------------------------------------------
        // SRS Engine (Ø®Ù„Ø§ØµÙ‡ Ø´Ø¯Ù‡)
        // ------------------------------------------------------------
        const SRS = {
            calculateNextReview: function(easeFactor, repetitions, quality) {
                if (quality < 3) return { interval: 1, repetitions: 0, easeFactor: Math.max(1.3, easeFactor - 0.2) };
                let interval = repetitions === 0 ? 1 : repetitions === 1 ? 6 : Math.round(repetitions * easeFactor);
                let newEase = easeFactor + (0.1 - (5 - quality) * (0.08 + (5 - quality) * 0.02));
                newEase = Math.max(1.3, Math.min(2.5, newEase));
                return { interval, repetitions: repetitions + 1, easeFactor: newEase };
            }
        };

        // ------------------------------------------------------------
        // Lesson Service (Ø¨Ø§ ØªØ²Ø±ÛŒÙ‚ ÙˆØ§Ø¨Ø³ØªÚ¯ÛŒ Mock DB)
        // ------------------------------------------------------------
        const LessonService = {
            db: MockDB,
            
            loadLessons: function(level = null) {
                let lessons = this.db.get('lessons');
                if (level) lessons = lessons.filter(l => l.level === level);
                return lessons;
            },
            
            getLessonById: function(lessonId) {
                return this.db.get('lessons', lessonId);
            },
            
            saveAnswer: function(userId, lessonId, vocabId, quality) {
                const now = new Date().toISOString();
                let review = this.db.get('reviews')?.find(r => r.userId === userId && r.vocabId === vocabId);
                
                if (!review) {
                    review = {
                        id: `rev_${Date.now()}`,
                        userId, lessonId, vocabId,
                        easeFactor: 2.5,
                        repetitions: 0,
                        interval: 0,
                        lastReview: null
                    };
                }
                
                const result = SRS.calculateNextReview(review.easeFactor, review.repetitions, quality);
                review.easeFactor = result.easeFactor;
                review.repetitions = result.repetitions;
                review.interval = result.interval;
                review.lastReview = now;
                
                this.db.save('reviews', review);
                
                // Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ù¾ÛŒØ´Ø±ÙØª Ø¯Ø±Ø³
                this.updateProgress(userId, lessonId);
                
                return { success: true, review, nextReviewDate: result.interval };
            },
            
            updateProgress: function(userId, lessonId) {
                const reviews = this.db.get('reviews').filter(r => r.userId === userId && r.lessonId === lessonId);
                const totalVocab = this.db.get('lessons', lessonId)?.vocabCount || 5;
                const mastered = reviews.filter(r => r.interval >= 6).length;
                const score = Math.min(100, Math.round((mastered / totalVocab) * 100));
                
                let progress = this.db.get('progresses')?.find(p => p.userId === userId && p.lessonId === lessonId);
                if (!progress) {
                    progress = { id: `prog_${lessonId}_${userId}`, userId, lessonId, status: 'in_progress', score: 0, lastReview: null };
                }
                
                progress.score = score;
                progress.lastReview = new Date().toISOString();
                if (score >= 80) progress.status = 'completed';
                else if (score > 0) progress.status = 'in_progress';
                
                this.db.save('progresses', progress);
                return progress;
            },
            
            getProgress: function(userId, lessonId) {
                return this.db.get('progresses')?.find(p => p.userId === userId && p.lessonId === lessonId) || 
                       { userId, lessonId, status: 'not_started', score: 0, lastReview: null };
            },
            
            generateExercise: function(lessonId, type = 'multiple-choice') {
                const lesson = this.db.get('lessons', lessonId);
                if (!lesson) return null;
                
                // Ø´Ø¨ÛŒÙ‡â€ŒØ³Ø§Ø²ÛŒ ØªÙ…Ø±ÛŒÙ†
                return {
                    id: `ex_${Date.now()}`,
                    lessonId,
                    type,
                    question: `Ø³ÙˆØ§Ù„ Ù†Ù…ÙˆÙ†Ù‡ Ø¨Ø±Ø§ÛŒ ${lesson.title}`,
                    options: ['Ú¯Ø²ÛŒÙ†Ù‡ Û±', 'Ú¯Ø²ÛŒÙ†Ù‡ Û²', 'Ú¯Ø²ÛŒÙ†Ù‡ Û³', 'Ú¯Ø²ÛŒÙ†Ù‡ Û´'],
                    correctAnswer: 0,
                    vocabId: `vocab_${lessonId}_1`
                };
            }
        };

        // ------------------------------------------------------------
        // ØªØ³Øªâ€ŒÙ‡Ø§ÛŒ Ø¯Ø³ØªÛŒ
        // ------------------------------------------------------------
        function testLoadLessons() {
            MockDB.clear();
            const lessons = LessonService.loadLessons();
            const level1 = LessonService.loadLessons(1);
            
            let log = 'ğŸ“š Ù‡Ù…Ù‡ Ø¯Ø±Ø³â€ŒÙ‡Ø§:\n';
            lessons.forEach(l => log += `- ${l.id}: ${l.title} (Ø³Ø·Ø­ ${l.level})\n`);
            log += `\nğŸ“— Ø¯Ø±Ø³â€ŒÙ‡Ø§ÛŒ Ø³Ø·Ø­ Û±: ${level1.length} Ù…ÙˆØ±Ø¯`;
            
            document.getElementById('result1').innerText = log;
        }

        function testSaveAnswer() {
            MockDB.clear();
            const result = LessonService.saveAnswer('user1', 'L1', 'vocab_L1_1', 5);
            const progress = LessonService.getProgress('user1', 'L1');
            
            let log = 'ğŸ’¾ Ø°Ø®ÛŒØ±Ù‡ Ù¾Ø§Ø³Ø® (Ú©ÛŒÙÛŒØª Ûµ):\n';
            log += `âœ… ÙØ§ØµÙ„Ù‡ Ù…Ø±ÙˆØ±: ${result.review.interval} Ø±ÙˆØ²\n`;
            log += `ğŸ“ˆ Ø¹Ø§Ù…Ù„ Ø³Ù‡ÙˆÙ„Øª: ${result.review.easeFactor.toFixed(3)}\n`;
            log += `ğŸ“Š Ù¾ÛŒØ´Ø±ÙØª Ø¯Ø±Ø³: ${progress.score}% - ${progress.status}`;
            
            document.getElementById('result2').innerText = log;
        }

        function testGetProgress() {
            MockDB.clear();
            LessonService.saveAnswer('user1', 'L1', 'vocab_L1_1', 5);
            LessonService.saveAnswer('user1', 'L1', 'vocab_L1_2', 4);
            
            const progress = LessonService.getProgress('user1', 'L1');
            
            let log = 'ğŸ“Š Ù¾ÛŒØ´Ø±ÙØª Ø¯Ø±Ø³ L1:\n';
            log += `ÙˆØ¶Ø¹ÛŒØª: ${progress.status}\n`;
            log += `Ø§Ù…ØªÛŒØ§Ø²: ${progress.score}%\n`;
            log += `Ø¢Ø®Ø±ÛŒÙ† Ù…Ø±ÙˆØ±: ${progress.lastReview?.split('T')[0] || 'Ù†Ø¯Ø§Ø±Ø¯'}`;
            
            document.getElementById('result3').innerText = log;
        }

        function testGenerateExercise() {
            const exercise = LessonService.generateExercise('L1', 'multiple-choice');
            
            let log = 'ğŸ¯ ØªÙ…Ø±ÛŒÙ† ØªÙˆÙ„ÛŒØ¯ Ø´Ø¯Ù‡:\n';
            log += `Ø³ÙˆØ§Ù„: ${exercise.question}\n`;
            log += `Ú¯Ø²ÛŒÙ†Ù‡â€ŒÙ‡Ø§: ${exercise.options.join(' | ')}\n`;
            log += `Ù¾Ø§Ø³Ø® ØµØ­ÛŒØ­: Ú¯Ø²ÛŒÙ†Ù‡ ${exercise.correctAnswer + 1}`;
            
            document.getElementById('result4').innerText = log;
        }

        function testFullFlow() {
            MockDB.clear();
            let log = 'ğŸ”„ Ø¬Ø±ÛŒØ§Ù† Ú©Ø§Ù…Ù„ Ú©Ø§Ø±Ø¨Ø±:\n\n';
            
            // 1. Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø¯Ø±Ø³
            const lesson = LessonService.getLessonById('L1');
            log += `1. ğŸ“¥ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø¯Ø±Ø³: ${lesson.title}\n`;
            
            // 2. ØªÙˆÙ„ÛŒØ¯ ØªÙ…Ø±ÛŒÙ†
            const exercise = LessonService.generateExercise('L1', 'multiple-choice');
            log += `2. ğŸ¯ ØªÙˆÙ„ÛŒØ¯ ØªÙ…Ø±ÛŒÙ†: ${exercise.question}\n`;
            
            // 3. Ø°Ø®ÛŒØ±Ù‡ Ù¾Ø§Ø³Ø®
            const answer = LessonService.saveAnswer('user1', 'L1', exercise.vocabId, 5);
            log += `3. ğŸ’¾ Ø°Ø®ÛŒØ±Ù‡ Ù¾Ø§Ø³Ø®: Ú©ÛŒÙÛŒØª Ûµ â†’ ÙØ§ØµÙ„Ù‡ ${answer.review.interval} Ø±ÙˆØ²\n`;
            
            // 4. Ø¯Ø±ÛŒØ§ÙØª Ù¾ÛŒØ´Ø±ÙØª
            const progress = LessonService.getProgress('user1', 'L1');
            log += `4. ğŸ“Š Ù¾ÛŒØ´Ø±ÙØª ÙØ¹Ù„ÛŒ: ${progress.score}% (${progress.status})\n`;
            
            // 5. Ø°Ø®ÛŒØ±Ù‡ Ù¾Ø§Ø³Ø® Ø¯ÙˆÙ…
            const answer2 = LessonService.saveAnswer('user1', 'L1', 'vocab_L1_2', 3);
            log += `5. ğŸ’¾ Ù¾Ø§Ø³Ø® Ø¯ÙˆÙ…: Ú©ÛŒÙÛŒØª Û³ â†’ ÙØ§ØµÙ„Ù‡ ${answer2.review.interval} Ø±ÙˆØ²\n`;
            
            // 6. Ù¾ÛŒØ´Ø±ÙØª Ù†Ù‡Ø§ÛŒÛŒ
            const finalProgress = LessonService.getProgress('user1', 'L1');
            log += `\nâœ… Ù¾ÛŒØ´Ø±ÙØª Ù†Ù‡Ø§ÛŒÛŒ Ø¯Ø±Ø³: ${finalProgress.score}% - ${finalProgress.status}`;
            
            document.getElementById('result5').innerText = log;
        }

        function clearAll() {
            document.querySelectorAll('.result').forEach(el => el.innerText = 'Ø¨Ø±Ø§ÛŒ Ù†Ù…Ø§ÛŒØ´ Ù†ØªÛŒØ¬Ù‡ Ú©Ù„ÛŒÚ© Ú©Ù†');
            MockDB.clear();
            console.log('ğŸ§¹ Ù‡Ù…Ù‡ Ù†ØªØ§ÛŒØ¬ Ù¾Ø§Ú© Ø´Ø¯Ù†Ø¯');
        }

        function runAll() {
            testLoadLessons();
            testSaveAnswer();
            testGetProgress();
            testGenerateExercise();
            testFullFlow();
            console.log('âš¡ ØªÙ…Ø§Ù… ØªØ³Øªâ€ŒÙ‡Ø§ Ø§Ø¬Ø±Ø§ Ø´Ø¯Ù†Ø¯');
        }
    </script>
</body>
</html>
