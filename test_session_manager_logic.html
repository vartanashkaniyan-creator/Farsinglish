<!DOCTYPE html>
<html lang="fa">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ØªØ³Øª session-manager - Ù…Ù†Ø·Ù‚ Ù…Ø­Ø¶</title>
    <style>
        body { font-family: system-ui, sans-serif; max-width: 800px; margin: 0 auto; padding: 16px; background: #f5f5f5; }
        .header { background: #4f46e5; color: white; padding: 16px; border-radius: 12px; margin-bottom: 20px; }
        h1 { margin: 0; font-size: 1.5rem; }
        .subtitle { margin-top: 8px; opacity: 0.9; font-size: 0.9rem; }
        .test-grid { display: flex; flex-direction: column; gap: 12px; }
        .test-card { background: white; border-radius: 10px; padding: 16px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .test-title { font-weight: 600; margin-bottom: 12px; display: flex; justify-content: space-between; }
        .btn-run { background: #4f46e5; color: white; border: none; border-radius: 6px; padding: 6px 16px; cursor: pointer; }
        .btn-run:hover { background: #6366f1; }
        .output { background: #1e1e2e; color: #a6e3a1; padding: 12px; border-radius: 6px; margin: 12px 0 0; font-family: monospace; white-space: pre-wrap; }
        .success { color: #10b981; font-weight: 500; }
        .error { color: #ef4444; font-weight: 500; }
        .divider { border-top: 1px dashed #ccc; margin: 16px 0; }
    </style>
</head>
<body>
    <div class="header">
        <h1>ğŸ§ª ØªØ³Øª Ù…Ø³ØªÙ‚Ù„ Ø§Ø² Ø§Ø¨Ø²Ø§Ø±: session-manager</h1>
        <div class="subtitle">Ù…Ù†Ø·Ù‚ Ù…Ø­Ø¶ Â· Ø¨Ø¯ÙˆÙ† ÙˆØ§Ø¨Ø³ØªÚ¯ÛŒ Â· Ù‚Ø§Ø¨Ù„ Ø§Ø¬Ø±Ø§ Ø¯Ø± Ù…ÙˆØ¨Ø§ÛŒÙ„</div>
    </div>

    <div class="test-grid">
        <!-- Ú©Ø§Ø±Øª Û±: Ø§ÛŒØ¬Ø§Ø¯ Ù†Ø´Ø³Øª -->
        <div class="test-card" id="card-1">
            <div class="test-title">
                <span>ğŸ“Œ Û±. Ø§ÛŒØ¬Ø§Ø¯ Ù†Ø´Ø³Øª Ø¨Ø§ user id Ù…Ø¹ØªØ¨Ø±</span>
                <button class="btn-run" onclick="runTest1()">Ø§Ø¬Ø±Ø§</button>
            </div>
            <div id="output-1" class="output">â³ Ù…Ù†ØªØ¸Ø± Ø§Ø¬Ø±Ø§...</div>
        </div>

        <!-- Ú©Ø§Ø±Øª Û²: Ø§Ø¹ØªØ¨Ø§Ø±Ø³Ù†Ø¬ÛŒ Ù†Ø´Ø³Øª ÙØ¹Ø§Ù„ -->
        <div class="test-card" id="card-2">
            <div class="test-title">
                <span>ğŸ“Œ Û². Ø¨Ø±Ø±Ø³ÛŒ active Ø¨ÙˆØ¯Ù† Ù†Ø´Ø³Øª</span>
                <button class="btn-run" onclick="runTest2()">Ø§Ø¬Ø±Ø§</button>
            </div>
            <div id="output-2" class="output">â³ Ù…Ù†ØªØ¸Ø± Ø§Ø¬Ø±Ø§...</div>
        </div>

        <!-- Ú©Ø§Ø±Øª Û³: Ø§Ù†Ù‚Ø¶Ø§ÛŒ Ù†Ø´Ø³Øª -->
        <div class="test-card" id="card-3">
            <div class="test-title">
                <span>ğŸ“Œ Û³. Ø§Ù†Ù‚Ø¶Ø§ÛŒ Ø®ÙˆØ¯Ú©Ø§Ø± Ù¾Ø³ Ø§Ø² Ø²Ù…Ø§Ù† Ù…Ù‚Ø±Ø±</span>
                <button class="btn-run" onclick="runTest3()">Ø§Ø¬Ø±Ø§</button>
            </div>
            <div id="output-3" class="output">â³ Ù…Ù†ØªØ¸Ø± Ø§Ø¬Ø±Ø§...</div>
        </div>

        <!-- Ú©Ø§Ø±Øª Û´: Ø®Ø±ÙˆØ¬ (Ù¾Ø§ÛŒØ§Ù† Ù†Ø´Ø³Øª) -->
        <div class="test-card" id="card-4">
            <div class="test-title">
                <span>ğŸ“Œ Û´. Ø®Ø±ÙˆØ¬ Ùˆ Ù¾Ø§Ú© Ú©Ø±Ø¯Ù† Ù†Ø´Ø³Øª</span>
                <button class="btn-run" onclick="runTest4()">Ø§Ø¬Ø±Ø§</button>
            </div>
            <div id="output-4" class="output">â³ Ù…Ù†ØªØ¸Ø± Ø§Ø¬Ø±Ø§...</div>
        </div>

        <!-- Ú©Ø§Ø±Øª Ûµ: ØªÙ…Ø¯ÛŒØ¯ Ù†Ø´Ø³Øª (refresh) -->
        <div class="test-card" id="card-5">
            <div class="test-title">
                <span>ğŸ“Œ Ûµ. ØªÙ…Ø¯ÛŒØ¯ Ø²Ù…Ø§Ù† Ù†Ø´Ø³Øª</span>
                <button class="btn-run" onclick="runTest5()">Ø§Ø¬Ø±Ø§</button>
            </div>
            <div id="output-5" class="output">â³ Ù…Ù†ØªØ¸Ø± Ø§Ø¬Ø±Ø§...</div>
        </div>

        <!-- Ú©Ø§Ø±Øª Û¶: Ø±ÙØªØ§Ø± Ù‚Ø·Ø¹ÛŒ - ÙˆØ±ÙˆØ¯ÛŒ Ø«Ø§Ø¨ØªØŒ Ø®Ø±ÙˆØ¬ÛŒ Ø«Ø§Ø¨Øª -->
        <div class="test-card" id="card-6">
            <div class="test-title">
                <span>ğŸ“Œ Û¶. Ø¢Ø²Ù…ÙˆÙ† Ù‚Ø·Ø¹ÛŒØª (deterministic)</span>
                <button class="btn-run" onclick="runTest6()">Ø§Ø¬Ø±Ø§</button>
            </div>
            <div id="output-6" class="output">â³ Ù…Ù†ØªØ¸Ø± Ø§Ø¬Ø±Ø§...</div>
        </div>
    </div>

    <script>
        // ==================== Ù¾ÛŒØ§Ø¯Ù‡â€ŒØ³Ø§Ø²ÛŒ Ø®Ø§Ù„Øµ session-manager ====================
        // (Ø¨Ø¯ÙˆÙ† Ù‡ÛŒÚ† ÙˆØ§Ø¨Ø³ØªÚ¯ÛŒ Ø¨Ù‡ Ú©ØªØ§Ø¨Ø®Ø§Ù†Ù‡ ÛŒØ§ IndexedDB)
        const SessionManager = {
            // Ø°Ø®ÛŒØ±Ù‡ Ø¯Ø§Ø®Ù„ÛŒ (Ø¨Ø±Ø§ÛŒ Ø´Ø¨ÛŒÙ‡â€ŒØ³Ø§Ø²ÛŒ - Ø¯Ø± ØªØ³Øª ÙˆØ§Ù‚Ø¹ÛŒ Ù…Ø§Ú˜ÙˆÙ„ Ø§ØµÙ„ÛŒ Ø§Ø³ØªÙØ§Ø¯Ù‡ Ù…ÛŒâ€ŒØ´ÙˆØ¯)
            _sessions: new Map(),

            // Ø§ÛŒØ¬Ø§Ø¯ Ù†Ø´Ø³Øª Ø¬Ø¯ÛŒØ¯
            createSession(userId, ttlSeconds = 3600) {
                if (!userId || typeof userId !== 'string' || userId.trim() === '') {
                    return { success: false, error: 'userId Ù†Ø§Ù…Ø¹ØªØ¨Ø±' };
                }
                const sessionId = 'sess_' + Math.random().toString(36).substring(2, 15);
                const now = Date.now();
                const session = {
                    sessionId,
                    userId: userId.trim(),
                    createdAt: now,
                    expiresAt: now + (ttlSeconds * 1000),
                    active: true
                };
                this._sessions.set(sessionId, session);
                return { success: true, sessionId, expiresAt: session.expiresAt };
            },

            // Ø¨Ø±Ø±Ø³ÛŒ Ù†Ø´Ø³Øª Ù…Ø¹ØªØ¨Ø±
            isValidSession(sessionId) {
                if (!sessionId) return false;
                const session = this._sessions.get(sessionId);
                if (!session || !session.active) return false;
                if (Date.now() > session.expiresAt) {
                    // Ø§Ù†Ù‚Ø¶Ø§ Ø®ÙˆØ¯Ú©Ø§Ø± ØºÛŒØ±ÙØ¹Ø§Ù„ Ù…ÛŒâ€ŒÚ©Ù†Ø¯
                    session.active = false;
                    return false;
                }
                return true;
            },

            // Ø¯Ø±ÛŒØ§ÙØª Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ù†Ø´Ø³Øª
            getSession(sessionId) {
                if (!this.isValidSession(sessionId)) return null;
                const session = this._sessions.get(sessionId);
                // Ø¨Ø±Ú¯Ø±Ø¯Ø§Ù†Ø¯Ù† Ú©Ù¾ÛŒ (immutability)
                return { ...session };
            },

            // Ù¾Ø§ÛŒØ§Ù† Ù†Ø´Ø³Øª
            logout(sessionId) {
                if (!sessionId) return false;
                const session = this._sessions.get(sessionId);
                if (session) {
                    session.active = false;
                }
                return true;
            },

            // ØªÙ…Ø¯ÛŒØ¯ Ù†Ø´Ø³Øª
            refreshSession(sessionId, extraSeconds = 3600) {
                if (!this.isValidSession(sessionId)) return { success: false, error: 'Ù†Ø´Ø³Øª Ù†Ø§Ù…Ø¹ØªØ¨Ø± ÛŒØ§ Ù…Ù†Ù‚Ø¶ÛŒ' };
                const session = this._sessions.get(sessionId);
                session.expiresAt += (extraSeconds * 1000);
                return { success: true, expiresAt: session.expiresAt };
            },

            // Ù¾Ø§Ú© Ú©Ø±Ø¯Ù† Ø¨Ø±Ø§ÛŒ ØªØ³Øª (Ø¯Ø³ØªÛŒ)
            _clearForTest() {
                this._sessions.clear();
            }
        };

        // ==================== ØªØ§Ø¨Ø¹ Ú©Ù…Ú©ÛŒ Ø¨Ø±Ø§ÛŒ Ù†Ù…Ø§ÛŒØ´ Ù†ØªÛŒØ¬Ù‡ ====================
        function showOutput(elementId, result, expected, description) {
            const outputDiv = document.getElementById(elementId);
            const ok = result === expected;
            const icon = ok ? 'âœ…' : 'âŒ';
            const color = ok ? '#10b981' : '#ef4444';
            outputDiv.innerHTML = `
${icon} ${description}
â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”
ğŸ” Ù†ØªÛŒØ¬Ù‡: ${JSON.stringify(result)}
ğŸ¯ Ù…ÙˆØ±Ø¯ Ø§Ù†ØªØ¸Ø§Ø±: ${JSON.stringify(expected)}
<span style="color: ${color}">${ok ? 'âœ“ ØµØ­ÛŒØ­' : 'âœ— Ø®Ø·Ø§'}</span>
            `;
        }

        // ==================== ØªØ³Øªâ€ŒÙ‡Ø§ ====================
        function runTest1() {
            SessionManager._clearForTest();
            const result = SessionManager.createSession('user_123', 60);
            const expected = result.success === true && result.sessionId && result.expiresAt > Date.now();
            showOutput('output-1', expected, true, 'Ø§ÛŒØ¬Ø§Ø¯ Ù†Ø´Ø³Øª Ø¨Ø§ userId Ù…Ø¹ØªØ¨Ø±');
        }

        function runTest2() {
            SessionManager._clearForTest();
            const create = SessionManager.createSession('user_456', 60);
            const sessionId = create.sessionId;
            const isValid = SessionManager.isValidSession(sessionId);
            showOutput('output-2', isValid, true, 'Ù†Ø´Ø³Øª ÙØ¹Ø§Ù„ Ø¨Ø§ÛŒØ¯ Ù…Ø¹ØªØ¨Ø± Ø¨Ø§Ø´Ø¯');
        }

        function runTest3() {
            SessionManager._clearForTest();
            // Ø§ÛŒØ¬Ø§Ø¯ Ù†Ø´Ø³Øª Ø¨Ø§ Û± Ø«Ø§Ù†ÛŒÙ‡ Ø¹Ù…Ø± Ø¨Ø±Ø§ÛŒ ØªØ³Øª Ø§Ù†Ù‚Ø¶Ø§
            const create = SessionManager.createSession('user_expire', 0.001); // 1 Ù…ÛŒÙ„ÛŒâ€ŒØ«Ø§Ù†ÛŒÙ‡ (Ø¹Ù…Ù„Ø§Ù‹ ØµÙØ±)
            const sessionId = create.sessionId;

            // ØµØ¨Ø± Ø¯Ø³ØªÛŒ Ù†ÛŒØ³Øª â€“ Ø¨Ø§ Ø²Ù…Ø§Ù† Ø­Ø§Ù„ Ø´Ø¨ÛŒÙ‡â€ŒØ³Ø§Ø²ÛŒ Ù…ÛŒâ€ŒÚ©Ù†ÛŒÙ… (Ù…Ù†Ø·Ù‚ Ù…Ø­Ø¶)
            // Ø¯Ø± Ù¾ÛŒØ§Ø¯Ù‡â€ŒØ³Ø§Ø²ÛŒ ÙˆØ§Ù‚Ø¹ÛŒØŒ expiresAt Ù„Ø­Ø§Ø¸ Ù…ÛŒâ€ŒØ´ÙˆØ¯. Ù…Ø§ Ù…Ø³ØªÙ‚ÛŒÙ…Ø§Ù‹ Ú†Ú© Ù…ÛŒâ€ŒÚ©Ù†ÛŒÙ…:
            const session = SessionManager._sessions.get(sessionId);
            session.expiresAt = Date.now() - 1000; // Ù…Ù†Ù‚Ø¶ÛŒ Ø´Ø¯Ù‡

            const isValid = SessionManager.isValidSession(sessionId);
            showOutput('output-3', isValid, false, 'Ù†Ø´Ø³Øª Ù…Ù†Ù‚Ø¶ÛŒ Ù†Ø§Ù…Ø¹ØªØ¨Ø± Ø§Ø³Øª');
        }

        function runTest4() {
            SessionManager._clearForTest();
            const create = SessionManager.createSession('user_logout', 60);
            const sessionId = create.sessionId;
            SessionManager.logout(sessionId);
            const isValid = SessionManager.isValidSession(sessionId);
            showOutput('output-4', isValid, false, 'Ù¾Ø³ Ø§Ø² Ø®Ø±ÙˆØ¬ØŒ Ù†Ø´Ø³Øª Ù†Ø§Ù…Ø¹ØªØ¨Ø± Ø§Ø³Øª');
        }

        function runTest5() {
            SessionManager._clearForTest();
            const create = SessionManager.createSession('user_refresh', 10);
            const sessionId = create.sessionId;
            const oldExpires = SessionManager._sessions.get(sessionId).expiresAt;
            
            // ØªÙ…Ø¯ÛŒØ¯
            SessionManager.refreshSession(sessionId, 20);
            const newExpires = SessionManager._sessions.get(sessionId).expiresAt;
            
            const ok = newExpires > oldExpires;
            showOutput('output-5', ok, true, 'ØªÙ…Ø¯ÛŒØ¯ Ù†Ø´Ø³Øª Ø¨Ø§ÛŒØ¯ Ø²Ù…Ø§Ù† Ø§Ù†Ù‚Ø¶Ø§ Ø±Ø§ Ø§ÙØ²Ø§ÛŒØ´ Ø¯Ù‡Ø¯');
        }

        function runTest6() {
            SessionManager._clearForTest();
            // ÙˆØ±ÙˆØ¯ÛŒ Ø«Ø§Ø¨Øª: userId ÛŒÚ©Ø³Ø§Ù†
            const r1 = SessionManager.createSession('fixed_user', 30);
            const r2 = SessionManager.createSession('fixed_user', 30);
            // Ù‡Ø± Ø¯Ùˆ Ù…ÙˆÙÙ‚ Ùˆ Ø¯Ø§Ø±Ø§ÛŒ sessionId ÛŒÚ©Ø³Ø§Ù† Ù†ÛŒØ³ØªÙ†Ø¯ (Ø·Ø¨ÛŒØ¹ÛŒ) Ø§Ù…Ø§ Ø³Ø§Ø®ØªØ§Ø± ÛŒÚ©Ø³Ø§Ù† Ø§Ø³Øª
            const ok = (r1.success === true && r2.success === true);
            showOutput('output-6', ok, true, 'Ø¨Ø§ ÙˆØ±ÙˆØ¯ÛŒ Ø«Ø§Ø¨ØªØŒ Ø®Ø±ÙˆØ¬ÛŒ Ø³Ø§Ø®ØªØ§Ø±ÛŒØ§ÙØªÙ‡ ÛŒÚ©Ø³Ø§Ù† (Ù…ÙˆÙÙ‚)');
        }
    </script>
</body>
</html>
