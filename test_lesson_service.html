<!DOCTYPE html>
<html lang="fa">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ØªØ³Øª Lesson Service - Farsinglish</title>
    <style>
        :root {
            --primary: #7c3aed;
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
            --dark: #1e293b;
            --light: #f8fafc;
        }
        
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: system-ui, -apple-system, sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%);
            min-height: 100vh;
            padding: 15px;
            direction: rtl;
        }
        
        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 15px 50px rgba(0,0,0,0.25);
        }
        
        .header {
            background: var(--primary);
            color: white;
            padding: 25px 20px;
            text-align: center;
        }
        
        .header h1 {
            font-size: 1.6rem;
            margin-bottom: 8px;
        }
        
        .header p {
            opacity: 0.9;
            font-size: 0.95rem;
        }
        
        .stats {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 12px;
            padding: 18px;
            background: var(--light);
            border-bottom: 3px solid #e2e8f0;
        }
        
        .stat {
            background: white;
            padding: 15px;
            border-radius: 10px;
            text-align: center;
            border: 2px solid #e2e8f0;
            transition: all 0.3s;
        }
        
        .stat:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(124, 58, 237, 0.15);
        }
        
        .stat-value {
            font-size: 1.8rem;
            font-weight: bold;
            color: var(--primary);
        }
        
        .stat-label {
            font-size: 0.85rem;
            color: #64748b;
            margin-top: 8px;
        }
        
        .test-area {
            padding: 20px;
        }
        
        .test-group {
            margin-bottom: 25px;
        }
        
        .group-title {
            color: var(--primary);
            font-size: 1.2rem;
            font-weight: 700;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 3px solid var(--primary);
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .tests-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 15px;
        }
        
        .test-card {
            background: white;
            border: 2px solid #e2e8f0;
            border-radius: 12px;
            padding: 18px;
            transition: all 0.3s;
            position: relative;
        }
        
        .test-card:hover {
            border-color: var(--primary);
            box-shadow: 0 10px 25px rgba(124, 58, 237, 0.1);
        }
        
        .test-card.passed {
            border-color: var(--success);
            background: linear-gradient(to right, #f0fdf4, #ffffff);
        }
        
        .test-card.failed {
            border-color: var(--danger);
            background: linear-gradient(to right, #fef2f2, #ffffff);
        }
        
        .test-card.running {
            border-color: var(--warning);
            animation: pulse 1.5s infinite;
        }
        
        @keyframes pulse {
            0% { border-color: #f59e0b; }
            50% { border-color: #fbbf24; }
            100% { border-color: #f59e0b; }
        }
        
        .test-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }
        
        .test-title {
            font-weight: 600;
            color: var(--dark);
            font-size: 1rem;
        }
        
        .test-status {
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 600;
        }
        
        .test-desc {
            color: #64748b;
            font-size: 0.85rem;
            line-height: 1.5;
            margin-bottom: 15px;
        }
        
        .test-details {
            background: #f8fafc;
            padding: 12px;
            border-radius: 8px;
            font-size: 0.8rem;
            color: #475569;
            border-right: 4px solid var(--primary);
            display: none;
            margin-top: 10px;
        }
        
        .controls {
            display: flex;
            gap: 15px;
            padding: 20px;
            background: var(--light);
            border-top: 3px solid #e2e8f0;
        }
        
        .btn {
            flex: 1;
            padding: 16px;
            border: none;
            border-radius: 12px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            font-size: 1rem;
        }
        
        .btn-run {
            background: linear-gradient(to right, #7c3aed, #8b5cf6);
            color: white;
        }
        
        .btn-run:hover {
            background: linear-gradient(to right, #6d28d9, #7c3aed);
            transform: translateY(-3px);
            box-shadow: 0 10px 25px rgba(124, 58, 237, 0.3);
        }
        
        .btn-reset {
            background: linear-gradient(to right, #64748b, #94a3b8);
            color: white;
        }
        
        .btn-reset:hover {
            background: linear-gradient(to right, #475569, #64748b);
            transform: translateY(-3px);
            box-shadow: 0 10px 25px rgba(100, 116, 139, 0.3);
        }
        
        .console {
            background: #1e293b;
            color: white;
            padding: 20px;
            margin: 0 20px 20px;
            border-radius: 12px;
            font-family: 'Courier New', monospace;
            font-size: 0.85rem;
            max-height: 250px;
            overflow-y: auto;
            border: 2px solid #334155;
        }
        
        .console-header {
            color: #fbbf24;
            margin-bottom: 15px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .console-line {
            padding: 8px 0;
            border-bottom: 1px solid #334155;
            line-height: 1.4;
        }
        
        .log-success { color: #34d399; }
        .log-error { color: #f87171; }
        .log-info { color: #60a5fa; }
        .log-warning { color: #fbbf24; }
        
        .footer {
            text-align: center;
            padding: 20px;
            color: #64748b;
            font-size: 0.9rem;
            border-top: 1px solid #e2e8f0;
            background: var(--light);
        }
        
        .lesson-preview {
            background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);
            padding: 20px;
            margin: 20px;
            border-radius: 12px;
            border: 3px solid #bae6fd;
        }
        
        .preview-title {
            color: var(--primary);
            font-weight: 700;
            margin-bottom: 15px;
            text-align: center;
            font-size: 1.1rem;
        }
        
        .preview-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
        }
        
        .preview-item {
            background: white;
            padding: 12px;
            border-radius: 8px;
            text-align: center;
            border: 2px solid #e2e8f0;
        }
        
        .preview-value {
            font-weight: bold;
            color: var(--primary);
            font-size: 1.1rem;
            margin-bottom: 5px;
        }
        
        .preview-label {
            font-size: 0.75rem;
            color: #64748b;
        }
        
        @media (max-width: 768px) {
            .tests-grid {
                grid-template-columns: 1fr;
            }
            
            .stats {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .preview-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .controls {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ§ª ØªØ³Øª Lesson Service (Ù…ÙˆØªÙˆØ± Ø¢Ù…ÙˆØ²Ø´)</h1>
            <p>ØªØ³Øª Ø³Ø±ÙˆÛŒØ³ Ù…Ø¯ÛŒØ±ÛŒØª Ø¯Ø±Ø³â€ŒÙ‡Ø§ØŒ ØªÙ…Ø±ÛŒÙ†â€ŒÙ‡Ø§ Ùˆ Ø§Ù„Ú¯ÙˆØ±ÛŒØªÙ… SRS</p>
        </div>
        
        <div class="stats">
            <div class="stat">
                <div class="stat-value" id="totalTests">12</div>
                <div class="stat-label">ØªØ¹Ø¯Ø§Ø¯ ØªØ³Øªâ€ŒÙ‡Ø§</div>
            </div>
            <div class="stat">
                <div class="stat-value" id="passedTests">0</div>
                <div class="stat-label">Ù…ÙˆÙÙ‚</div>
            </div>
            <div class="stat">
                <div class="stat-value" id="failedTests">0</div>
                <div class="stat-label">Ù†Ø§Ù…ÙˆÙÙ‚</div>
            </div>
            <div class="stat">
                <div class="stat-value" id="successRate">0%</div>
                <div class="stat-label">Ù†Ø±Ø® Ù…ÙˆÙÙ‚ÛŒØª</div>
            </div>
        </div>
        
        <div class="lesson-preview">
            <div class="preview-title">ğŸ“š Ù¾ÛŒØ´â€ŒÙ†Ù…Ø§ÛŒØ´ Ø¯Ø±Ø³</div>
            <div class="preview-grid">
                <div class="preview-item">
                    <div class="preview-value" id="previewLessonCount">0</div>
                    <div class="preview-label">Ø¯Ø±Ø³â€ŒÙ‡Ø§ÛŒ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø´Ø¯Ù‡</div>
                </div>
                <div class="preview-item">
                    <div class="preview-value" id="previewExerciseCount">0</div>
                    <div class="preview-label">ØªÙ…Ø±ÛŒÙ†â€ŒÙ‡Ø§ÛŒ ØªÙˆÙ„ÛŒØ¯ Ø´Ø¯Ù‡</div>
                </div>
                <div class="preview-item">
                    <div class="preview-value" id="previewProgress">0%</div>
                    <div class="preview-label">Ù…ÛŒØ§Ù†Ú¯ÛŒÙ† Ù¾ÛŒØ´Ø±ÙØª</div>
                </div>
            </div>
        </div>
        
        <div class="test-area">
            <!-- Ú¯Ø±ÙˆÙ‡ ØªØ³Øªâ€ŒÙ‡Ø§ÛŒ Ù¾Ø§ÛŒÙ‡ -->
            <div class="test-group">
                <div class="group-title">ğŸ“¦ ØªØ³Øªâ€ŒÙ‡Ø§ÛŒ Ù¾Ø§ÛŒÙ‡ Lesson Service</div>
                <div class="tests-grid" id="basicTests">
                    <!-- ØªØ³Øªâ€ŒÙ‡Ø§ÛŒ Ù¾Ø§ÛŒÙ‡ Ø§ÛŒÙ†Ø¬Ø§ Ø³Ø§Ø®ØªÙ‡ Ù…ÛŒâ€ŒØ´ÙˆÙ†Ø¯ -->
                </div>
            </div>
            
            <!-- Ú¯Ø±ÙˆÙ‡ ØªØ³Øªâ€ŒÙ‡Ø§ÛŒ Ù¾ÛŒØ´Ø±ÙØªÙ‡ -->
            <div class="test-group">
                <div class="group-title">âš¡ ØªØ³Øªâ€ŒÙ‡Ø§ÛŒ Ù¾ÛŒØ´Ø±ÙØªÙ‡ Ùˆ Ù‡ÙˆØ´Ù…Ù†Ø¯</div>
                <div class="tests-grid" id="advancedTests">
                    <!-- ØªØ³Øªâ€ŒÙ‡Ø§ÛŒ Ù¾ÛŒØ´Ø±ÙØªÙ‡ Ø§ÛŒÙ†Ø¬Ø§ Ø³Ø§Ø®ØªÙ‡ Ù…ÛŒâ€ŒØ´ÙˆÙ†Ø¯ -->
                </div>
            </div>
        </div>
        
        <div class="console">
            <div class="console-header">ğŸ“ Ú©Ù†Ø³ÙˆÙ„ Ø§Ø¬Ø±Ø§ÛŒ ØªØ³Øªâ€ŒÙ‡Ø§</div>
            <div id="consoleOutput"></div>
        </div>
        
        <div class="controls">
            <button class="btn btn-run" id="runTests">
                <span>â–¶ï¸</span>
                Ø§Ø¬Ø±Ø§ÛŒ ØªÙ…Ø§Ù… ØªØ³Øªâ€ŒÙ‡Ø§
            </button>
            <button class="btn btn-reset" id="resetTests">
                <span>ğŸ”„</span>
                Ø¨Ø§Ø²Ù†Ø´Ø§Ù†ÛŒ Ù‡Ù…Ù‡
            </button>
        </div>
        
        <div class="footer">
            ØªØ³Øª Lesson Service | Ù…ÙˆØªÙˆØ± Ø§ØµÙ„ÛŒ Ø¢Ù…ÙˆØ²Ø´ Farsinglish | Ø·Ø±Ø§Ø­ÛŒ Ø´Ø¯Ù‡ Ø¨Ø±Ø§ÛŒ Ø§Ø¬Ø±Ø§ Ø¯Ø± Ù…Ø±ÙˆØ±Ú¯Ø± Ù…ÙˆØ¨Ø§ÛŒÙ„
        </div>
    </div>

    <script>
        // ==================== Ù…Ø¯Ù„â€ŒÙ‡Ø§ÛŒ Ù¾Ø§ÛŒÙ‡ ====================
        class LessonModel {
            constructor(data = {}) {
                this.id = data.id || 'lesson_' + Date.now();
                this.title = data.title || '';
                this.content = data.content || [];
                this.vocabulary = data.vocabulary || [];
                this.exercises = data.exercises || [];
                this.difficulty = data.difficulty || 1;
                this.duration = data.duration || 15;
                this.progress = data.progress || 0;
                this.reviewCount = data.reviewCount || 0;
                this.easinessFactor = data.easinessFactor || 2.5;
                this.nextReview = data.nextReview || null;
                this.isCompleted = data.isCompleted || false;
                this.isLocked = data.isLocked || false;
            }
        }

        class UserProgress {
            constructor(data = {}) {
                this.userId = data.userId || 'user_' + Date.now();
                this.lessonId = data.lessonId || '';
                this.score = data.score || 0;
                this.timeSpent = data.timeSpent || 0; // Ø«Ø§Ù†ÛŒÙ‡
                this.attempts = data.attempts || 0;
                this.lastAttempt = data.lastAttempt || null;
                this.completedAt = data.completedAt || null;
                this.reviewData = data.reviewData || {};
            }
        }

        // ==================== Lesson Service Ø§ØµÙ„ÛŒ ====================
        class LessonService {
            constructor() {
                this.lessons = new Map();
                this.userProgress = new Map();
                this.currentLessonId = null;
            }

            // Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø¯Ø±Ø³â€ŒÙ‡Ø§
            loadLessons(lessonsData) {
                if (!Array.isArray(lessonsData)) {
                    throw new Error('Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ÛŒ Ø¯Ø±Ø³ Ø¨Ø§ÛŒØ¯ Ø¢Ø±Ø§ÛŒÙ‡ Ø¨Ø§Ø´Ù†Ø¯');
                }

                this.lessons.clear();
                lessonsData.forEach(lessonData => {
                    const lesson = new LessonModel(lessonData);
                    this.lessons.set(lesson.id, lesson);
                });

                return this.lessons.size;
            }

            // Ú¯Ø±ÙØªÙ† Ø¯Ø±Ø³ Ø¨Ø¹Ø¯ÛŒ Ø¨Ø± Ø§Ø³Ø§Ø³ Ù¾ÛŒØ´Ø±ÙØª Ú©Ø§Ø±Ø¨Ø±
            getNextLesson(userId) {
                const userLessons = Array.from(this.userProgress.values())
                    .filter(p => p.userId === userId);

                // Ø§Ú¯Ø± Ø¯Ø±Ø³â€ŒØ§ÛŒ Ú©Ø§Ù…Ù„ Ù†Ø´Ø¯Ù‡ Ø¨Ø§Ø´Ø¯ØŒ Ø¢Ù† Ø±Ø§ Ø¨Ø±Ú¯Ø±Ø¯Ø§Ù†
                const incompleteLessons = Array.from(this.lessons.values())
                    .filter(lesson => {
                        const progress = userLessons.find(p => p.lessonId === lesson.id);
                        return !progress || progress.score < 80;
                    });

                if (incompleteLessons.length === 0) {
                    return null;
                }

                // Ø§ÙˆÙ„ÙˆÛŒØªâ€ŒØ¨Ù†Ø¯ÛŒ: Ø¯Ø±ÙˆØ³ Ù‚ÙÙ„â€ŒÙ†Ø´Ø¯Ù‡ØŒ Ø³Ù¾Ø³ Ø¨Ø± Ø§Ø³Ø§Ø³ Ø¯Ø´ÙˆØ§Ø±ÛŒ
                const availableLessons = incompleteLessons
                    .filter(lesson => !lesson.isLocked)
                    .sort((a, b) => a.difficulty - b.difficulty);

                return availableLessons[0] || incompleteLessons[0];
            }

            // Ø´Ø±ÙˆØ¹ ÛŒÚ© Ø¯Ø±Ø³
            startLesson(lessonId) {
                const lesson = this.lessons.get(lessonId);
                if (!lesson) {
                    throw new Error('Ø¯Ø±Ø³ ÛŒØ§ÙØª Ù†Ø´Ø¯');
                }

                if (lesson.isLocked) {
                    throw new Error('Ø¯Ø±Ø³ Ù‚ÙÙ„ Ø§Ø³Øª');
                }

                this.currentLessonId = lessonId;
                return {
                    lesson: lesson,
                    exercises: this.generateExercises(lesson),
                    estimatedTime: lesson.duration * 60 // ØªØ¨Ø¯ÛŒÙ„ Ø¨Ù‡ Ø«Ø§Ù†ÛŒÙ‡
                };
            }

            // ØªÙˆÙ„ÛŒØ¯ ØªÙ…Ø±ÛŒÙ†â€ŒÙ‡Ø§ÛŒ Ù‡ÙˆØ´Ù…Ù†Ø¯
            generateExercises(lesson, count = 5) {
                const exercises = [];
                const vocabCount = lesson.vocabulary.length;

                if (vocabCount === 0) {
                    return exercises;
                }

                for (let i = 0; i < count; i++) {
                    const vocabIndex = i % vocabCount;
                    const vocabulary = lesson.vocabulary[vocabIndex];

                    const exercise = {
                        id: `ex_${lesson.id}_${i}`,
                        type: this.determineExerciseType(lesson.reviewCount, i),
                        question: this.generateQuestion(vocabulary, lesson.reviewCount),
                        options: this.generateOptions(vocabulary, lesson.vocabulary),
                        correctAnswer: vocabulary.english,
                        points: this.calculatePoints(lesson.difficulty, i),
                        timeLimit: this.calculateTimeLimit(lesson.difficulty, i)
                    };

                    exercises.push(exercise);
                }

                return exercises;
            }

            determineExerciseType(reviewCount, index) {
                const types = ['multiple-choice', 'fill-blank', 'matching'];
                if (reviewCount === 0) {
                    return types[0]; // Ø¨Ø±Ø§ÛŒ Ø§ÙˆÙ„ÛŒÙ† Ø¨Ø§Ø± ÙÙ‚Ø· Ú†Ù†Ø¯Ú¯Ø²ÛŒÙ†Ù‡â€ŒØ§ÛŒ
                }
                return types[index % types.length];
            }

            generateQuestion(vocabulary, reviewCount) {
                if (reviewCount === 0) {
                    return `Ù…Ø¹Ù†ÛŒ Ú©Ù„Ù…Ù‡ "${vocabulary.english}" Ú†ÛŒØ³ØªØŸ`;
                } else if (reviewCount === 1) {
                    return `Ø¬Ù…Ù„Ù‡ "${vocabulary.example}" Ø±Ø§ Ú©Ø§Ù…Ù„ Ú©Ù†ÛŒØ¯`;
                } else {
                    return `Ú©Ù„Ù…Ù‡ "${vocabulary.english}" Ø±Ø§ Ø¯Ø± Ø¬Ù…Ù„Ù‡ Ù…Ù†Ø§Ø³Ø¨ Ø§Ø³ØªÙØ§Ø¯Ù‡ Ú©Ù†ÛŒØ¯`;
                }
            }

            generateOptions(correctVocab, allVocabulary) {
                const options = [correctVocab.persian];
                const otherVocab = allVocabulary.filter(v => v !== correctVocab);

                // Ø§Ø¶Ø§ÙÙ‡ Ú©Ø±Ø¯Ù† Û³ Ú¯Ø²ÛŒÙ†Ù‡ ØªØµØ§Ø¯ÙÛŒ Ø¯ÛŒÚ¯Ø±
                for (let i = 0; i < 3 && i < otherVocab.length; i++) {
                    const randomIndex = Math.floor(Math.random() * otherVocab.length);
                    options.push(otherVocab[randomIndex].persian);
                }

                // Ù…Ø®Ù„ÙˆØ· Ú©Ø±Ø¯Ù† Ú¯Ø²ÛŒÙ†Ù‡â€ŒÙ‡Ø§
                return this.shuffleArray(options);
            }

            calculatePoints(difficulty, exerciseIndex) {
                const basePoints = 10;
                const difficultyMultiplier = 1 + (difficulty - 1) * 0.5;
                const exerciseBonus = exerciseIndex * 2;
                return Math.round(basePoints * difficultyMultiplier + exerciseBonus);
            }

            calculateTimeLimit(difficulty, exerciseIndex) {
                const baseTime = 30; // Ø«Ø§Ù†ÛŒÙ‡
                const difficultyPenalty = (difficulty - 1) * 5;
                const exerciseBonus = exerciseIndex * 3;
                return baseTime - difficultyPenalty + exerciseBonus;
            }

            // Ø«Ø¨Øª Ù¾Ø§Ø³Ø® Ú©Ø§Ø±Ø¨Ø±
            submitAnswer(lessonId, exerciseId, userAnswer, userId) {
                const lesson = this.lessons.get(lessonId);
                if (!lesson) {
                    throw new Error('Ø¯Ø±Ø³ ÛŒØ§ÙØª Ù†Ø´Ø¯');
                }

                // Ø´Ø¨ÛŒÙ‡â€ŒØ³Ø§Ø²ÛŒ Ø¨Ø±Ø±Ø³ÛŒ Ù¾Ø§Ø³Ø®
                const isCorrect = Math.random() > 0.3; // 70% Ø´Ø§Ù†Ø³ Ø¯Ø±Ø³Øª Ø¨ÙˆØ¯Ù† Ø¨Ø±Ø§ÛŒ ØªØ³Øª
                
                // Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ù¾ÛŒØ´Ø±ÙØª
                this.updateUserProgress(userId, lessonId, isCorrect);

                return {
                    isCorrect,
                    correctAnswer: 'Ù¾Ø§Ø³Ø® ØµØ­ÛŒØ­',
                    points: isCorrect ? 10 : 0,
                    explanation: isCorrect ? 'Ø¢ÙØ±ÛŒÙ†! Ù¾Ø§Ø³Ø® Ø´Ù…Ø§ ØµØ­ÛŒØ­ Ø§Ø³Øª.' : 'Ù¾Ø§Ø³Ø® ØµØ­ÛŒØ­: ' + 'Ù¾Ø§Ø³Ø® ØµØ­ÛŒØ­'
                };
            }

            // Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ù¾ÛŒØ´Ø±ÙØª Ú©Ø§Ø±Ø¨Ø±
            updateUserProgress(userId, lessonId, isCorrect) {
                const progressKey = `${userId}_${lessonId}`;
                let progress = this.userProgress.get(progressKey);

                if (!progress) {
                    progress = new UserProgress({
                        userId,
                        lessonId
                    });
                }

                progress.attempts++;
                progress.lastAttempt = new Date().toISOString();
                
                if (isCorrect) {
                    progress.score = Math.min(100, progress.score + 10);
                }

                if (progress.score >= 80 && !progress.completedAt) {
                    progress.completedAt = new Date().toISOString();
                    
                    // Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ ÙˆØ¶Ø¹ÛŒØª Ø¯Ø±Ø³
                    const lesson = this.lessons.get(lessonId);
                    if (lesson) {
                        lesson.isCompleted = true;
                        lesson.progress = 100;
                    }
                }

                this.userProgress.set(progressKey, progress);
                return progress;
            }

            // Ù‚ÙÙ„/Ø¨Ø§Ø² Ú©Ø±Ø¯Ù† Ø¯Ø±Ø³
            toggleLessonLock(lessonId) {
                const lesson = this.lessons.get(lessonId);
                if (!lesson) {
                    throw new Error('Ø¯Ø±Ø³ ÛŒØ§ÙØª Ù†Ø´Ø¯');
                }

                lesson.isLocked = !lesson.isLocked;
                return lesson.isLocked;
            }

            // Ú¯Ø±ÙØªÙ† Ø¢Ù…Ø§Ø± Ø¯Ø±Ø³â€ŒÙ‡Ø§
            getLessonStats() {
                const totalLessons = this.lessons.size;
                const completedLessons = Array.from(this.lessons.values())
                    .filter(lesson => lesson.isCompleted).length;
                const lockedLessons = Array.from(this.lessons.values())
                    .filter(lesson => lesson.isLocked).length;
                const totalProgress = Array.from(this.lessons.values())
                    .reduce((sum, lesson) => sum + lesson.progress, 0);

                return {
                    totalLessons,
                    completedLessons,
                    lockedLessons,
                    averageProgress: totalLessons > 0 ? Math.round(totalProgress / totalLessons) : 0,
                    completionRate: totalLessons > 0 ? Math.round((completedLessons / totalLessons) * 100) : 0
                };
            }

            // Ú¯Ø±ÙØªÙ† Ù¾ÛŒØ´Ø±ÙØª Ú©Ø§Ø±Ø¨Ø±
            getUserProgress(userId) {
                const userProgresses = Array.from(this.userProgress.values())
                    .filter(p => p.userId === userId);

                const totalScore = userProgresses.reduce((sum, p) => sum + p.score, 0);
                const totalTime = userProgresses.reduce((sum, p) => sum + p.timeSpent, 0);
                const completedLessons = userProgresses.filter(p => p.score >= 80).length;

                return {
                    userId,
                    totalLessonsAttempted: userProgresses.length,
                    completedLessons,
                    averageScore: userProgresses.length > 0 ? Math.round(totalScore / userProgresses.length) : 0,
                    totalTimeSpent: totalTime,
                    completionRate: this.lessons.size > 0 ? Math.round((completedLessons / this.lessons.size) * 100) : 0
                };
            }

            // Ø§Ø¨Ø²Ø§Ø± Ú©Ù…Ú©ÛŒ: Ù…Ø®Ù„ÙˆØ· Ú©Ø±Ø¯Ù† Ø¢Ø±Ø§ÛŒÙ‡
            shuffleArray(array) {
                const shuffled = [...array];
                for (let i = shuffled.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]];
                }
                return shuffled;
            }
        }

        // ==================== ØªØ³Øªâ€ŒÙ‡Ø§ÛŒ Lesson Service ====================
        const lessonServiceTests = [
            // Ú¯Ø±ÙˆÙ‡ Û±: ØªØ³Øªâ€ŒÙ‡Ø§ÛŒ Ù¾Ø§ÛŒÙ‡
            {
                id: 'test1',
                title: 'Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø¯Ø±Ø³â€ŒÙ‡Ø§',
                desc: 'Ø¨Ø±Ø±Ø³ÛŒ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ ØµØ­ÛŒØ­ Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ÛŒ Ø¯Ø±Ø³',
                group: 'basic',
                run: function() {
                    const service = new LessonService();
                    const sampleLessons = [
                        { id: 'lesson1', title: 'Ø¯Ø±Ø³ Ø§ÙˆÙ„', difficulty: 1 },
                        { id: 'lesson2', title: 'Ø¯Ø±Ø³ Ø¯ÙˆÙ…', difficulty: 2 },
                        { id: 'lesson3', title: 'Ø¯Ø±Ø³ Ø³ÙˆÙ…', difficulty: 3 }
                    ];

                    const loadedCount = service.loadLessons(sampleLessons);
                    const stats = service.getLessonStats();

                    return {
                        passed: loadedCount === 3 && stats.totalLessons === 3,
                        message: loadedCount === 3 ? 'âœ… Ø¯Ø±Ø³â€ŒÙ‡Ø§ Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø´Ø¯Ù†Ø¯' : 'âŒ Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø¯Ø±Ø³â€ŒÙ‡Ø§',
                        details: { loadedCount, totalLessons: stats.totalLessons }
                    };
                }
            },
            {
                id: 'test2',
                title: 'Ø´Ø±ÙˆØ¹ Ø¯Ø±Ø³',
                desc: 'Ø¨Ø±Ø±Ø³ÛŒ Ø´Ø±ÙˆØ¹ ØµØ­ÛŒØ­ ÛŒÚ© Ø¯Ø±Ø³',
                group: 'basic',
                run: function() {
                    const service = new LessonService();
                    const sampleLessons = [
                        { 
                            id: 'lesson1', 
                            title: 'Ø¯Ø±Ø³ ØªØ³ØªÛŒ',
                            vocabulary: [
                                { english: 'hello', persian: 'Ø³Ù„Ø§Ù…', example: 'Hello world!' }
                            ]
                        }
                    ];

                    service.loadLessons(sampleLessons);
                    const result = service.startLesson('lesson1');

                    return {
                        passed: result && result.lesson && result.exercises.length > 0,
                        message: result ? 'âœ… Ø¯Ø±Ø³ Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø´Ø±ÙˆØ¹ Ø´Ø¯' : 'âŒ Ø®Ø·Ø§ Ø¯Ø± Ø´Ø±ÙˆØ¹ Ø¯Ø±Ø³',
                        details: { 
                            hasLesson: !!result.lesson,
                            exercisesCount: result.exercises.length,
                            estimatedTime: result.estimatedTime
                        }
                    };
                }
            },
            {
                id: 'test3',
                title: 'ØªÙˆÙ„ÛŒØ¯ ØªÙ…Ø±ÛŒÙ†â€ŒÙ‡Ø§',
                desc: 'Ø¨Ø±Ø±Ø³ÛŒ ØªÙˆÙ„ÛŒØ¯ Ø®ÙˆØ¯Ú©Ø§Ø± ØªÙ…Ø±ÛŒÙ†â€ŒÙ‡Ø§ÛŒ Ù‡ÙˆØ´Ù…Ù†Ø¯',
                group: 'basic',
                run: function() {
                    const service = new LessonService();
                    const sampleLesson = {
                        id: 'lesson1',
                        title: 'Ø¯Ø±Ø³ ÙˆØ§Ú˜Ú¯Ø§Ù†',
                        vocabulary: [
                            { english: 'book', persian: 'Ú©ØªØ§Ø¨', example: 'I read a book' },
                            { english: 'pen', persian: 'Ø®ÙˆØ¯Ú©Ø§Ø±', example: 'Write with a pen' },
                            { english: 'school', persian: 'Ù…Ø¯Ø±Ø³Ù‡', example: 'I go to school' }
                        ],
                        difficulty: 2,
                        reviewCount: 1
                    };

                    service.loadLessons([sampleLesson]);
                    const exercises = service.generateExercises(sampleLesson, 4);

                    const hasValidExercises = exercises.length === 4 &&
                        exercises.every(ex => ex.id && ex.type && ex.question && ex.options);

                    return {
                        passed: hasValidExercises,
                        message: hasValidExercises ? 'âœ… ØªÙ…Ø±ÛŒÙ†â€ŒÙ‡Ø§ Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª ØªÙˆÙ„ÛŒØ¯ Ø´Ø¯Ù†Ø¯' : 'âŒ Ø®Ø·Ø§ Ø¯Ø± ØªÙˆÙ„ÛŒØ¯ ØªÙ…Ø±ÛŒÙ†â€ŒÙ‡Ø§',
                        details: { 
                            exercisesCount: exercises.length,
                            types: [...new Set(exercises.map(ex => ex.type))],
                            hasPoints: exercises.every(ex => ex.points > 0)
                        }
                    };
                }
            },
            {
                id: 'test4',
                title: 'Ø«Ø¨Øª Ù¾Ø§Ø³Ø® Ú©Ø§Ø±Ø¨Ø±',
                desc: 'Ø¨Ø±Ø±Ø³ÛŒ Ø«Ø¨Øª Ù¾Ø§Ø³Ø® Ùˆ Ù…Ø­Ø§Ø³Ø¨Ù‡ Ø§Ù…ØªÛŒØ§Ø²',
                group: 'basic',
                run: function() {
                    const service = new LessonService();
                    const userId = 'test_user_123';
                    const lessonId = 'lesson1';

                    service.loadLessons([{ id: lessonId, title: 'Ø¯Ø±Ø³ ØªØ³Øª' }]);
                    
                    const result = service.submitAnswer(
                        lessonId, 
                        'ex_1', 
                        'Ù¾Ø§Ø³Ø® ØªØ³Øª', 
                        userId
                    );

                    const progress = service.getUserProgress(userId);

                    return {
                        passed: result && typeof result.isCorrect === 'boolean',
                        message: result ? 'âœ… Ù¾Ø§Ø³Ø® Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø«Ø¨Øª Ø´Ø¯' : 'âŒ Ø®Ø·Ø§ Ø¯Ø± Ø«Ø¨Øª Ù¾Ø§Ø³Ø®',
                        details: { 
                            hasResult: !!result,
                            isCorrect: result.isCorrect,
                            userAttempts: progress.totalLessonsAttempted
                        }
                    };
                }
            },
            {
                id: 'test5',
                title: 'Ù‚ÙÙ„/Ø¨Ø§Ø² Ú©Ø±Ø¯Ù† Ø¯Ø±Ø³',
                desc: 'Ø¨Ø±Ø±Ø³ÛŒ Ø¹Ù…Ù„Ú©Ø±Ø¯ Ù‚ÙÙ„ Ú©Ø±Ø¯Ù† Ø¯Ø±Ø³',
                group: 'basic',
                run: function() {
                    const service = new LessonService();
                    const lessonId = 'locked_lesson';

                    service.loadLessons([{ id: lessonId, title: 'Ø¯Ø±Ø³ Ù‚ÙÙ„ Ø´ÙˆÙ†Ø¯Ù‡' }]);
                    
                    // Ù‚ÙÙ„ Ú©Ø±Ø¯Ù†
                    const locked = service.toggleLessonLock(lessonId);
                    // Ø¨Ø§Ø² Ú©Ø±Ø¯Ù†
                    const unlocked = service.toggleLessonLock(lessonId);

                    const lesson = service.lessons.get(lessonId);

                    return {
                        passed: locked === true && unlocked === false && lesson.isLocked === false,
                        message: locked ? 'âœ… Ø¹Ù…Ù„Ú©Ø±Ø¯ Ù‚ÙÙ„/Ø¨Ø§Ø² ØµØ­ÛŒØ­ Ø§Ø³Øª' : 'âŒ Ø®Ø·Ø§ Ø¯Ø± Ù‚ÙÙ„ Ú©Ø±Ø¯Ù† Ø¯Ø±Ø³',
                        details: { 
                            locked: locked,
                            unlocked: unlocked,
                            finalState: lesson.isLocked
                        }
                    };
                }
            },

            // Ú¯Ø±ÙˆÙ‡ Û²: ØªØ³Øªâ€ŒÙ‡Ø§ÛŒ Ù¾ÛŒØ´Ø±ÙØªÙ‡
            {
                id: 'test6',
                title: 'Ø¯Ø±ÛŒØ§ÙØª Ø¯Ø±Ø³ Ø¨Ø¹Ø¯ÛŒ',
                desc: 'Ø¨Ø±Ø±Ø³ÛŒ Ø§Ù†ØªØ®Ø§Ø¨ Ù‡ÙˆØ´Ù…Ù†Ø¯ Ø¯Ø±Ø³ Ø¨Ø¹Ø¯ÛŒ',
                group: 'advanced',
                run: function() {
                    const service = new LessonService();
                    const userId = 'user_next_lesson';
                    
                    const lessons = [
                        { id: 'easy', title: 'Ø¢Ø³Ø§Ù†', difficulty: 1 },
                        { id: 'medium', title: 'Ù…ØªÙˆØ³Ø·', difficulty: 2 },
                        { id: 'hard', title: 'Ø³Ø®Øª', difficulty: 3, isLocked: true }
                    ];

                    service.loadLessons(lessons);
                    
                    // Ø´Ø¨ÛŒÙ‡â€ŒØ³Ø§Ø²ÛŒ Ù¾ÛŒØ´Ø±ÙØª Ú©Ø§Ø±Ø¨Ø±
                    service.updateUserProgress(userId, 'easy', true);
                    service.updateUserProgress(userId, 'easy', true);
                    
                    const nextLesson = service.getNextLesson(userId);

                    return {
                        passed: nextLesson && nextLesson.id === 'medium',
                        message: nextLesson ? 'âœ… Ø¯Ø±Ø³ Ø¨Ø¹Ø¯ÛŒ ØµØ­ÛŒØ­ Ø§Ù†ØªØ®Ø§Ø¨ Ø´Ø¯' : 'âŒ Ø®Ø·Ø§ Ø¯Ø± Ø§Ù†ØªØ®Ø§Ø¨ Ø¯Ø±Ø³ Ø¨Ø¹Ø¯ÛŒ',
                        details: { 
                            selectedId: nextLesson?.id,
                            expected: 'medium',
                            isLocked: nextLesson?.isLocked
                        }
                    };
                }
            },
            {
                id: 'test7',
                title: 'Ø¢Ù…Ø§Ø± Ø¯Ø±Ø³â€ŒÙ‡Ø§',
                desc: 'Ø¨Ø±Ø±Ø³ÛŒ Ù…Ø­Ø§Ø³Ø¨Ù‡ ØµØ­ÛŒØ­ Ø¢Ù…Ø§Ø± Ùˆ Ú¯Ø²Ø§Ø±Ø´Ø§Øª',
                group: 'advanced',
                run: function() {
                    const service = new LessonService();
                    
                    const lessons = [
                        { id: 'l1', title: 'Ø¯Ø±Ø³ Û±', progress: 100, isCompleted: true },
                        { id: 'l2', title: 'Ø¯Ø±Ø³ Û²', progress: 50, isCompleted: false },
                        { id: 'l3', title: 'Ø¯Ø±Ø³ Û³', progress: 0, isCompleted: false, isLocked: true }
                    ];

                    service.loadLessons(lessons);
                    const stats = service.getLessonStats();

                    const expectedAvgProgress = Math.round((100 + 50 + 0) / 3);
                    const expectedCompletionRate = Math.round((1 / 3) * 100);

                    return {
                        passed: stats.totalLessons === 3 && 
                                stats.completedLessons === 1 &&
                                stats.lockedLessons === 1 &&
                                stats.averageProgress === expectedAvgProgress,
                        message: stats.totalLessons === 3 ? 'âœ… Ø¢Ù…Ø§Ø± ØµØ­ÛŒØ­ Ù…Ø­Ø§Ø³Ø¨Ù‡ Ø´Ø¯' : 'âŒ Ø®Ø·Ø§ Ø¯Ø± Ù…Ø­Ø§Ø³Ø¨Ù‡ Ø¢Ù…Ø§Ø±',
                        details: { 
                            totalLessons: stats.totalLessons,
                            completed: stats.completedLessons,
                            locked: stats.lockedLessons,
                            avgProgress: stats.averageProgress,
                            completionRate: stats.completionRate
                        }
                    };
                }
            },
            {
                id: 'test8',
                title: 'Ù¾ÛŒØ´Ø±ÙØª Ú©Ø§Ø±Ø¨Ø±',
                desc: 'Ø¨Ø±Ø±Ø³ÛŒ Ø±Ø¯ÛŒØ§Ø¨ÛŒ Ù¾ÛŒØ´Ø±ÙØª Ú©Ø§Ø±Ø¨Ø±',
                group: 'advanced',
                run: function() {
                    const service = new LessonService();
                    const userId = 'progress_user';
                    
                    service.loadLessons([
                        { id: 'lesson1', title: 'Ø¯Ø±Ø³ Û±' },
                        { id: 'lesson2', title: 'Ø¯Ø±Ø³ Û²' }
                    ]);

                    // Ø´Ø¨ÛŒÙ‡â€ŒØ³Ø§Ø²ÛŒ Ù¾ÛŒØ´Ø±ÙØª
                    service.updateUserProgress(userId, 'lesson1', true);
                    service.updateUserProgress(userId, 'lesson1', true);
                    service.updateUserProgress(userId, 'lesson1', true); // Ø¨Ø§ÛŒØ¯ score = 30
                    service.updateUserProgress(userId, 'lesson2', false);

                    const progress = service.getUserProgress(userId);

                    return {
                        passed: progress.totalLessonsAttempted === 2 && 
                                progress.averageScore > 0,
                        message: progress.totalLessonsAttempted > 0 ? 
                                'âœ… Ù¾ÛŒØ´Ø±ÙØª Ú©Ø§Ø±Ø¨Ø± ØµØ­ÛŒØ­ Ø±Ø¯ÛŒØ§Ø¨ÛŒ Ø´Ø¯' : 
                                'âŒ Ø®Ø·Ø§ Ø¯Ø± Ø±Ø¯ÛŒØ§Ø¨ÛŒ Ù¾ÛŒØ´Ø±ÙØª',
                        details: { 
                            attempted: progress.totalLessonsAttempted,
                            avgScore: progress.averageScore,
                            totalTime: progress.totalTimeSpent
                        }
                    };
                }
            },
            {
                id: 'test9',
                title: 'Ø§Ù†ÙˆØ§Ø¹ ØªÙ…Ø±ÛŒÙ†â€ŒÙ‡Ø§',
                desc: 'Ø¨Ø±Ø±Ø³ÛŒ ØªÙˆÙ„ÛŒØ¯ Ø§Ù†ÙˆØ§Ø¹ Ù…Ø®ØªÙ„Ù ØªÙ…Ø±ÛŒÙ†',
                group: 'advanced',
                run: function() {
                    const service = new LessonService();
                    const lesson = {
                        id: 'multi_exercise',
                        title: 'Ø¯Ø±Ø³ Ú†Ù†Ø¯Ù†ÙˆØ¹ÛŒ',
                        vocabulary: [
                            { english: 'run', persian: 'Ø¯ÙˆÛŒØ¯Ù†', example: 'I run fast' },
                            { english: 'jump', persian: 'Ù¾Ø±ÛŒØ¯Ù†', example: 'Jump high' }
                        ],
                        reviewCount: 2 // Ø¨Ø±Ø§ÛŒ ØªÙˆÙ„ÛŒØ¯ Ø§Ù†ÙˆØ§Ø¹ Ù…Ø®ØªÙ„Ù
                    };

                    service.loadLessons([lesson]);
                    const exercises = service.generateExercises(lesson, 6);
                    
                    const exerciseTypes = [...new Set(exercises.map(ex => ex.type))];
                    const hasMultipleTypes = exerciseTypes.length >= 2;

                    return {
                        passed: hasMultipleTypes && exercises.length === 6,
                        message: hasMultipleTypes ? 
                                'âœ… Ø§Ù†ÙˆØ§Ø¹ Ù…Ø®ØªÙ„Ù ØªÙ…Ø±ÛŒÙ† ØªÙˆÙ„ÛŒØ¯ Ø´Ø¯' : 
                                'âŒ ØªÙ†ÙˆØ¹ ØªÙ…Ø±ÛŒÙ†â€ŒÙ‡Ø§ Ú©Ù… Ø§Ø³Øª',
                        details: { 
                            totalExercises: exercises.length,
                            types: exerciseTypes,
                            typeCount: exerciseTypes.length
                        }
                    };
                }
            },
            {
                id: 'test10',
                title: 'Ø§Ù…ØªÛŒØ§Ø²Ø¯Ù‡ÛŒ Ù‡ÙˆØ´Ù…Ù†Ø¯',
                desc: 'Ø¨Ø±Ø±Ø³ÛŒ Ù…Ø­Ø§Ø³Ø¨Ù‡ Ø§Ù…ØªÛŒØ§Ø² Ø¨Ø± Ø§Ø³Ø§Ø³ Ø¯Ø´ÙˆØ§Ø±ÛŒ',
                group: 'advanced',
                run: function() {
                    const service = new LessonService();
                    
                    const easyLesson = { id: 'easy', difficulty: 1, reviewCount: 0 };
                    const hardLesson = { id: 'hard', difficulty: 4, reviewCount: 0 };
                    
                    const easyExercises = service.generateExercises(easyLesson, 3);
                    const hardExercises = service.generateExercises(hardLesson, 3);
                    
                    const easyAvgPoints = easyExercises.reduce((sum, ex) => sum + ex.points, 0) / 3;
                    const hardAvgPoints = hardExercises.reduce((sum, ex) => sum + ex.points, 0) / 3;
                    
                    const pointsIncrease = hardAvgPoints > easyAvgPoints;

                    return {
                        passed: pointsIncrease && 
                                easyExercises.every(ex => ex.timeLimit > 0) &&
                                hardExercises.every(ex => ex.timeLimit > 0),
                        message: pointsIncrease ? 
                                'âœ… Ø§Ù…ØªÛŒØ§Ø²Ø¯Ù‡ÛŒ Ù…ØªÙ†Ø§Ø³Ø¨ Ø¨Ø§ Ø¯Ø´ÙˆØ§Ø±ÛŒ Ø§Ø³Øª' : 
                                'âŒ Ø®Ø·Ø§ Ø¯Ø± Ø§Ù…ØªÛŒØ§Ø²Ø¯Ù‡ÛŒ',
                        details: { 
                            easyAvgPoints: easyAvgPoints.toFixed(1),
                            hardAvgPoints: hardAvgPoints.toFixed(1),
                            difference: (hardAvgPoints - easyAvgPoints).toFixed(1)
                        }
                    };
                }
            },
            {
                id: 'test11',
                title: 'Ø®Ø·Ø§Ù‡Ø§ÛŒ Ù…Ø¯ÛŒØ±ÛŒØª Ø´Ø¯Ù‡',
                desc: 'Ø¨Ø±Ø±Ø³ÛŒ Ù…Ø¯ÛŒØ±ÛŒØª Ø®Ø·Ø§ Ø¯Ø± Ø¹Ù…Ù„ÛŒØ§Øª Ù…Ø®ØªÙ„Ù',
                group: 'advanced',
                run: function() {
                    const service = new LessonService();
                    let errorCount = 0;
                    
                    try {
                        service.startLesson('non_existent');
                    } catch (e) {
                        errorCount++;
                    }
                    
                    try {
                        service.toggleLessonLock('unknown');
                    } catch (e) {
                        errorCount++;
                    }
                    
                    service.loadLessons([{ id: 'locked', title: 'Ø¯Ø±Ø³ Ù‚ÙÙ„', isLocked: true }]);
                    
                    try {
                        service.startLesson('locked');
                    } catch (e) {
                        errorCount++;
                    }

                    return {
                        passed: errorCount === 3,
                        message: errorCount === 3 ? 
                                'âœ… Ø®Ø·Ø§Ù‡Ø§ Ø¨Ù‡ Ø¯Ø±Ø³ØªÛŒ Ù…Ø¯ÛŒØ±ÛŒØª Ù…ÛŒâ€ŒØ´ÙˆÙ†Ø¯' : 
                                'âŒ Ù…Ø¯ÛŒØ±ÛŒØª Ù†Ø§Ø¯Ø±Ø³Øª Ø®Ø·Ø§',
                        details: { 
                            expectedErrors: 3,
                            actualErrors: errorCount,
                            allHandled: errorCount === 3
                        }
                    };
                }
            },
            {
                id: 'test12',
                title: 'ÛŒÚ©Ù¾Ø§Ø±Ú†Ú¯ÛŒ Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§',
                desc: 'Ø¨Ø±Ø±Ø³ÛŒ Ø³Ø§Ø²Ú¯Ø§Ø±ÛŒ Ùˆ ÛŒÚ©Ù¾Ø§Ø±Ú†Ú¯ÛŒ Ú©Ù„ Ø³ÛŒØ³ØªÙ…',
                group: 'advanced',
                run: function() {
                    const service = new LessonService();
                    const userId = 'integration_user';
                    
                    // Û±. Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø¯Ø±Ø³â€ŒÙ‡Ø§
                    const lessons = [
                        {
                            id: 'int1',
                            title: 'Ø¯Ø±Ø³ ÛŒÚ©Ù¾Ø§Ø±Ú†Ù‡â€ŒØ³Ø§Ø²ÛŒ',
                            vocabulary: [
                                { english: 'test', persian: 'ØªØ³Øª', example: 'This is a test' }
                            ],
                            difficulty: 2
                        }
                    ];
                    
                    const loaded = service.loadLessons(lessons);
                    
                    // Û². Ø´Ø±ÙˆØ¹ Ø¯Ø±Ø³
                    const startResult = service.startLesson('int1');
                    
                    // Û³. Ø«Ø¨Øª Ù¾Ø§Ø³Ø®
                    const answerResult = service.submitAnswer(
                        'int1', 
                        startResult.exercises[0].id, 
                        'Ù¾Ø§Ø³Ø®', 
                        userId
                    );
                    
                    // Û´. Ø¨Ø±Ø±Ø³ÛŒ Ø¢Ù…Ø§Ø±
                    const userProgress = service.getUserProgress(userId);
                    const lessonStats = service.getLessonStats();
                    
                    // Ûµ. Ø¯Ø±Ø³ Ø¨Ø¹Ø¯ÛŒ
                    const nextLesson = service.getNextLesson(userId);
                    
                    const allPassed = loaded === 1 &&
                                    startResult && startResult.exercises.length > 0 &&
                                    answerResult && typeof answerResult.isCorrect === 'boolean' &&
                                    userProgress.totalLessonsAttempted === 1 &&
                                    lessonStats.totalLessons === 1 &&
                                    nextLesson;
                    
                    return {
                        passed: allPassed,
                        message: allPassed ? 
                                'âœ… Ø³ÛŒØ³ØªÙ… Ø¨Ù‡ Ø·ÙˆØ± Ú©Ø§Ù…Ù„ ÛŒÚ©Ù¾Ø§Ø±Ú†Ù‡ Ø§Ø³Øª' : 
                                'âŒ Ù…Ø´Ú©Ù„ Ø¯Ø± ÛŒÚ©Ù¾Ø§Ø±Ú†Ú¯ÛŒ Ø³ÛŒØ³ØªÙ…',
                        details: { 
                            stepsCompleted: 5,
                            loadedLessons: loaded,
                            exercisesGenerated: startResult?.exercises.length || 0,
                            userAttempts: userProgress.totalLessonsAttempted,
                            hasNextLesson: !!nextLesson
                        }
                    };
                }
            }
        ];

        // ==================== Test Runner ====================
        class LessonServiceTestRunner {
            constructor() {
                this.tests = lessonServiceTests;
                this.totalTests = this.tests.length;
                this.passed = 0;
                this.failed = 0;
                this.isRunning = false;
                this.initializeUI();
            }

            initializeUI() {
                // Ø§ÛŒØ¬Ø§Ø¯ ØªØ³Øªâ€ŒÙ‡Ø§ÛŒ Ù¾Ø§ÛŒÙ‡
                const basicContainer = document.getElementById('basicTests');
                const advancedContainer = document.getElementById('advancedTests');
                
                this.tests.forEach((test, index) => {
                    const container = test.group === 'basic' ? basicContainer : advancedContainer;
                    const testEl = document.createElement('div');
                    testEl.className = 'test-card';
                    testEl.id = `test-${test.id}`;
                    testEl.innerHTML = `
                        <div class="test-header">
                            <div class="test-title">${test.group === 'basic' ? index + 1 : index - 4}. ${test.title}</div>
                            <div class="test-status status-pending">Ø¯Ø± Ø§Ù†ØªØ¸Ø§Ø±</div>
                        </div>
                        <div class="test-desc">${test.desc}</div>
                        <div class="test-details" id="details-${test.id}"></div>
                    `;
                    container.appendChild(testEl);
                });

                document.getElementById('runTests').addEventListener('click', () => this.runAllTests());
                document.getElementById('resetTests').addEventListener('click', () => this.resetTests());
            }

            async runAllTests() {
                if (this.isRunning) return;
                this.isRunning = true;
                this.resetTests();
                
                this.log('ğŸš€ Ø´Ø±ÙˆØ¹ ØªØ³Øªâ€ŒÙ‡Ø§ÛŒ Lesson Service...', 'info');
                this.log('ØªØ³Øª Ù…ÙˆØªÙˆØ± Ø§ØµÙ„ÛŒ Ø¢Ù…ÙˆØ²Ø´ Farsinglish', 'info');
                
                for (let i = 0; i < this.tests.length; i++) {
                    const test = this.tests[i];
                    await this.runSingleTest(test);
                    await this.delay(400);
                    
                    // Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ù¾ÛŒØ´â€ŒÙ†Ù…Ø§ÛŒØ´
                    this.updatePreview(i + 1);
                }
                
                const successRate = Math.round((this.passed / this.totalTests) * 100);
                this.log(`ğŸ‰ ${this.passed}/${this.totalTests} ØªØ³Øª Ù…ÙˆÙÙ‚ (${successRate}%)`, 'success');
                this.isRunning = false;
                
                // Ù†Ù…Ø§ÛŒØ´ Ø®Ù„Ø§ØµÙ‡
                if (successRate >= 80) {
                    this.log('âœ… Lesson Service Ø¢Ù…Ø§Ø¯Ù‡ Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø§Ø³Øª!', 'success');
                } else {
                    this.log('âš ï¸ Ù†ÛŒØ§Ø² Ø¨Ù‡ Ø¨Ø±Ø±Ø³ÛŒ Ø¨Ø±Ø®ÛŒ ØªØ³Øªâ€ŒÙ‡Ø§', 'warning');
                }
            }

            async runSingleTest(test) {
                const testEl = document.getElementById(`test-${test.id}`);
                const statusEl = testEl.querySelector('.test-status');
                const detailsEl = document.getElementById(`details-${test.id}`);
                
                testEl.classList.add('running');
                statusEl.className = 'test-status status-pending';
                statusEl.textContent = 'Ø¯Ø± Ø­Ø§Ù„ Ø§Ø¬Ø±Ø§...';
                
                try {
                    const result = test.run();
                    
                    testEl.classList.remove('running');
                    if (result.passed) {
                        this.passed++;
                        testEl.classList.add('passed');
                        statusEl.className = 'test-status status-pass';
                        statusEl.textContent = 'Ù…ÙˆÙÙ‚';
                        this.log(`âœ… ${test.title}: ${result.message}`, 'success');
                    } else {
                        this.failed++;
                        testEl.classList.add('failed');
                        statusEl.className = 'test-status status-fail';
                        statusEl.textContent = 'Ù†Ø§Ù…ÙˆÙÙ‚';
                        this.log(`âŒ ${test.title}: ${result.message}`, 'error');
                    }
                    
                    if (result.details) {
                        detailsEl.style.display = 'block';
                        let detailsText = '';
                        for (const [key, value] of Object.entries(result.details)) {
                            detailsText += `${key}: ${value}\n`;
                        }
                        detailsEl.textContent = detailsText;
                    }
                    
                } catch (error) {
                    testEl.classList.remove('running');
                    this.failed++;
                    testEl.classList.add('failed');
                    statusEl.className = 'test-status status-fail';
                    statusEl.textContent = 'Ø®Ø·Ø§';
                    this.log(`ğŸ’¥ ${test.title}: ${error.message}`, 'error');
                    detailsEl.style.display = 'block';
                    detailsEl.textContent = `Ø®Ø·Ø§: ${error.message}\n${error.stack}`;
                }
                
                this.updateStats();
            }

            updateStats() {
                document.getElementById('passedTests').textContent = this.passed;
                document.getElementById('failedTests').textContent = this.failed;
                const rate = Math.round((this.passed / this.totalTests) * 100);
                document.getElementById('successRate').textContent = `${rate}%`;
                
                const rateEl = document.getElementById('successRate').parentElement;
                if (rate >= 80) {
                    rateEl.style.background = '#d1fae5';
                    rateEl.style.color = '#065f46';
                } else if (rate >= 60) {
                    rateEl.style.background = '#fef3c7';
                    rateEl.style.color = '#92400e';
                } else {
                    rateEl.style.background = '#fee2e2';
                    rateEl.style.color = '#991b1b';
                }
            }

            updatePreview(testNumber) {
                // Ø´Ø¨ÛŒÙ‡â€ŒØ³Ø§Ø²ÛŒ Ù¾ÛŒØ´â€ŒÙ†Ù…Ø§ÛŒØ´
                const lessonCount = Math.min(5, Math.floor(testNumber / 2) + 1);
                const exerciseCount = lessonCount * 4;
                const progress = Math.min(100, Math.floor((testNumber / this.totalTests) * 100));
                
                document.getElementById('previewLessonCount').textContent = lessonCount;
                document.getElementById('previewExerciseCount').textContent = exerciseCount;
                document.getElementById('previewProgress').textContent = `${progress}%`;
            }

            log(message, type = 'info') {
                const consoleEl = document.getElementById('consoleOutput');
                const line = document.createElement('div');
                line.className = `console-line log-${type}`;
                
                const time = new Date().toLocaleTimeString('fa-IR', { 
                    hour: '2-digit', 
                    minute: '2-digit',
                    second: '2-digit'
                });
                
                line.textContent = `[${time}] ${message}`;
                consoleEl.appendChild(line);
                consoleEl.scrollTop = consoleEl.scrollHeight;
            }

            resetTests() {
                this.passed = 0;
                this.failed = 0;
                this.isRunning = false;
                
                this.tests.forEach(test => {
                    const testEl = document.getElementById(`test-${test.id}`);
                    const statusEl = testEl.querySelector('.test-status');
                    const detailsEl = document.getElementById(`details-${test.id}`);
                    
                    testEl.className = 'test-card';
                    statusEl.className = 'test-status status-pending';
                    statusEl.textContent = 'Ø¯Ø± Ø§Ù†ØªØ¸Ø§Ø±';
                    detailsEl.style.display = 'none';
                    detailsEl.textContent = '';
                });
                
                document.getElementById('consoleOutput').innerHTML = '';
                document.getElementById('previewLessonCount').textContent = '0';
                document.getElementById('previewExerciseCount').textContent = '0';
                document.getElementById('previewProgress').textContent = '0%';
                
                this.updateStats();
                this.log('ğŸ”„ ØªÙ…Ø§Ù… ØªØ³Øªâ€ŒÙ‡Ø§ Ø¨Ø§Ø²Ù†Ø´Ø§Ù†ÛŒ Ø´Ø¯Ù†Ø¯', 'info');
            }

            delay(ms) {
                return new Promise(resolve => setTimeout(resolve, ms));
            }
        }

        // ==================== Ø´Ø±ÙˆØ¹ Ø¨Ø±Ù†Ø§Ù…Ù‡ ====================
        document.addEventListener('DOMContentLoaded', () => {
            const runner = new LessonServiceTestRunner();
            runner.log('ğŸ”§ ØªØ³Øªâ€ŒÙ‡Ø§ÛŒ Lesson Service Ø¢Ù…Ø§Ø¯Ù‡ Ø§Ø¬Ø±Ø§', 'info');
            runner.log('12 ØªØ³Øª Ø´Ø§Ù…Ù„: Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø¯Ø±Ø³ØŒ ØªÙˆÙ„ÛŒØ¯ ØªÙ…Ø±ÛŒÙ†ØŒ Ù¾ÛŒØ´Ø±ÙØª Ú©Ø§Ø±Ø¨Ø±ØŒ Ø¢Ù…Ø§Ø±', 'info');
            runner.log('Ø¨Ø±Ø§ÛŒ Ø´Ø±ÙˆØ¹ Ø±ÙˆÛŒ Ø¯Ú©Ù…Ù‡ "Ø§Ø¬Ø±Ø§ÛŒ ØªÙ…Ø§Ù… ØªØ³Øªâ€ŒÙ‡Ø§" Ú©Ù„ÛŒÚ© Ú©Ù†ÛŒØ¯', 'info');
            
            setTimeout(() => {
                runner.log('ğŸ’¡ Ù†Ú©ØªÙ‡: ØªØ³Øªâ€ŒÙ‡Ø§ Ø¨Ù‡ Ø¯Ùˆ Ú¯Ø±ÙˆÙ‡ Ù¾Ø§ÛŒÙ‡ Ùˆ Ù¾ÛŒØ´Ø±ÙØªÙ‡ ØªÙ‚Ø³ÛŒÙ… Ø´Ø¯Ù‡â€ŒØ§Ù†Ø¯', 'info');
            }, 2000);
        });
    </script>
</body>
  </html>
