<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.5, user-scalable=yes">
    <title>ØªØ³Øª Ø¯Ø³ØªÛŒ: Ø°Ø®ÛŒØ±Ù‡ Ùˆ Ø¨Ø§Ø²ÛŒØ§Ø¨ÛŒ ÙˆØ¶Ø¹ÛŒØª - Farsinglish</title>
    <style>
        * {
            box-sizing: border-box;
            font-family: 'Tahoma', 'Vazir', 'Segoe UI', sans-serif;
        }
        body {
            margin: 0;
            padding: 20px;
            background: #f8fafc;
            color: #1e293b;
        }
        .container {
            max-width: 900px;
            margin: 0 auto;
        }
        .header {
            background: linear-gradient(145deg, #0f2a3f, #1a3a4f);
            color: white;
            padding: 25px 20px;
            border-radius: 24px;
            margin-bottom: 30px;
            box-shadow: 0 10px 20px rgba(0,0,0,0.15);
            text-align: center;
        }
        .header h1 {
            margin: 0;
            font-size: 26px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }
        .header p {
            margin: 10px 0 0;
            opacity: 0.9;
            font-size: 15px;
        }
        .card {
            background: white;
            border-radius: 20px;
            padding: 20px;
            margin-bottom: 25px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.05);
            border: 1px solid #e2e8f0;
        }
        .card-title {
            font-size: 18px;
            font-weight: bold;
            margin-top: 0;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
            color: #0f2a3f;
            border-bottom: 2px solid #e2e8f0;
            padding-bottom: 12px;
        }
        .grid-2 {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }
        .btn {
            background: #e2e8f0;
            border: none;
            padding: 14px 18px;
            border-radius: 14px;
            font-size: 16px;
            font-weight: 600;
            color: #1e293b;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            cursor: pointer;
            transition: 0.2s;
            border: 1px solid transparent;
            width: 100%;
        }
        .btn-primary {
            background: #1e4a6b;
            color: white;
            box-shadow: 0 6px 0 #0f2a3f;
        }
        .btn-success {
            background: #0f6e4a;
            color: white;
            box-shadow: 0 6px 0 #0a4a33;
        }
        .btn-warning {
            background: #b45309;
            color: white;
            box-shadow: 0 6px 0 #7b2e0a;
        }
        .btn-outline {
            background: transparent;
            border: 2px solid #1e4a6b;
            color: #1e4a6b;
        }
        .btn:active {
            transform: translateY(4px);
            box-shadow: 0 2px 0 #0f2a3f;
        }
        .state-box {
            background: #f1f5f9;
            border-radius: 16px;
            padding: 18px;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            direction: ltr;
            text-align: left;
            white-space: pre-wrap;
            word-break: break-word;
            max-height: 250px;
            overflow-y: auto;
            border: 1px solid #cbd5e1;
            margin: 15px 0;
        }
        .badge {
            display: inline-block;
            background: #1e4a6b;
            color: white;
            padding: 6px 14px;
            border-radius: 30px;
            font-size: 13px;
            font-weight: 600;
        }
        .test-step {
            background: #fef9c3;
            border-right: 8px solid #eab308;
            padding: 16px;
            border-radius: 14px;
            margin-bottom: 20px;
        }
        .success-message {
            background: #d1fae5;
            color: #065f46;
            padding: 14px;
            border-radius: 14px;
            border-right: 8px solid #10b981;
        }
        .footer {
            text-align: center;
            margin-top: 30px;
            color: #64748b;
            font-size: 13px;
        }
        hr {
            border: 1px dashed #cbd5e1;
            margin: 25px 0;
        }
        @media (max-width: 600px) {
            .grid-2 { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ§ª ØªØ³Øª Ø¯Ø³ØªÛŒ Â· Ø°Ø®ÛŒØ±Ù‡ Ùˆ Ø¨Ø§Ø²ÛŒØ§Ø¨ÛŒ State</h1>
            <p>âœ… Ø´Ø¨ÛŒÙ‡â€ŒØ³Ø§Ø²ÛŒ Ú©Ø§Ù…Ù„ Ø°Ø®ÛŒØ±Ù‡â€ŒØ³Ø§Ø²ÛŒØŒ Ø¨Ø§Ø²ÛŒØ§Ø¨ÛŒØŒ Ù…Ù‡Ø§Ø¬Ø±Øª Ùˆ Ù…Ù‚Ø§ÙˆÙ…Øª Ø¯Ø± Ø¨Ø±Ø§Ø¨Ø± Ø¨Ø³ØªÙ‡ Ø´Ø¯Ù† Ù…Ø±ÙˆØ±Ú¯Ø±</p>
        </div>

        <!-- Ú©Ø§Ø±Øª: ÙˆØ¶Ø¹ÛŒØª ÙØ¹Ù„ÛŒ Ø­Ø§ÙØ¸Ù‡ -->
        <div class="card">
            <div class="card-title">
                <span>ğŸ“¦ Û±. ÙˆØ¶Ø¹ÛŒØª ÙØ¹Ù„ÛŒ Ø­Ø§ÙØ¸Ù‡ (State Snapshot)</span>
            </div>
            <div id="currentStateDisplay" class="state-box">
                {/* Ø­Ø§Ù„Øª ÙØ¹Ù„ÛŒ Ø¯Ø± Ø§ÛŒÙ†Ø¬Ø§ Ù†Ù…Ø§ÛŒØ´ Ø¯Ø§Ø¯Ù‡ Ù…ÛŒâ€ŒØ´ÙˆØ¯ */}
            </div>
            <div class="grid-2" style="margin-top: 15px;">
                <button id="btnRefreshState" class="btn btn-outline">ğŸ”„ Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ù†Ù…Ø§ÛŒØ´</button>
                <button id="btnResetState" class="btn btn-warning">ğŸ§¹ Ù¾Ø§Ú© Ú©Ø±Ø¯Ù† Ú©Ø§Ù…Ù„ State</button>
            </div>
        </div>

        <!-- Ø¨Ø®Ø´ Ø³Ù†Ø§Ø±ÛŒÙˆÙ‡Ø§ÛŒ ØªØ³Øª Ø¯Ø³ØªÛŒ -->
        <div class="test-step">
            <span class="badge">ğŸ“‹ Ø±Ø§Ù‡Ù†Ù…Ø§ÛŒ ØªØ³Øª Ø¯Ø³ØªÛŒ</span>
            <p style="margin-bottom: 0; font-size: 15px; font-weight: 500; margin-top: 12px;">
                Û±. Ø¯Ú©Ù…Ù‡â€ŒÙ‡Ø§ÛŒ Â«Ø°Ø®ÛŒØ±Ù‡Â» Ø±Ø§ Ø¨Ø²Ù†ÛŒØ¯ØŒ Ø³Ù¾Ø³ Ù…Ø±ÙˆØ±Ú¯Ø± Ø±Ø§ Ø¨Ø¨Ù†Ø¯ÛŒØ¯ Ùˆ Ø¯ÙˆØ¨Ø§Ø±Ù‡ Ø¨Ø§Ø² Ú©Ù†ÛŒØ¯ â€” State Ø¨Ø§ÛŒØ¯ Ø¨Ø§Ù‚ÛŒ Ø¨Ù…Ø§Ù†Ø¯.<br>
                Û². Ø¯Ú©Ù…Ù‡ Â«Ø¨Ø§Ø²ÛŒØ§Ø¨ÛŒÂ» Ø±Ø§ Ø¨Ø±Ø§ÛŒ Ø¨Ø±Ú¯Ø±Ø¯Ø§Ù†Ø¯Ù† Ø¢Ø®Ø±ÛŒÙ† Ø°Ø®ÛŒØ±Ù‡ Ø¨Ø²Ù†ÛŒØ¯.<br>
                Û³. Ø¯Ú©Ù…Ù‡ Â«Ø´Ø¨ÛŒÙ‡â€ŒØ³Ø§Ø²ÛŒ Ú©Ø±Ø´Â» Ø±Ø§ Ø¨Ø²Ù†ÛŒØ¯ Ùˆ Ù¾Ø³ Ø§Ø² Ø¨Ø§Ø²Ú¯Ø´Ø§ÛŒÛŒ ØµÙØ­Ù‡ØŒ Ú¯Ø²ÛŒÙ†Ù‡ Â«Ø¨Ø§Ø²ÛŒØ§Ø¨ÛŒ Ø®ÙˆØ¯Ú©Ø§Ø±Â» Ø±Ø§ ØªØ³Øª Ú©Ù†ÛŒØ¯.
            </p>
        </div>

        <div class="card">
            <div class="card-title">
                <span>ğŸ’¾ Û². Ø¹Ù…Ù„ÛŒØ§Øª Ù¾Ø§ÛŒÙ‡ Ø°Ø®ÛŒØ±Ù‡â€ŒØ³Ø§Ø²ÛŒ</span>
            </div>
            <div class="grid-2">
                <button id="btnSaveSimple" class="btn btn-primary">ğŸ’¾ Ø°Ø®ÛŒØ±Ù‡ Ø³Ø§Ø¯Ù‡ (Ù¾ÛŒØ´â€ŒÙØ±Ø¶)</button>
                <button id="btnLoadSimple" class="btn btn-success">ğŸ“‚ Ø¨Ø§Ø²ÛŒØ§Ø¨ÛŒ Ø¢Ø®Ø±ÛŒÙ† Ø°Ø®ÛŒØ±Ù‡</button>
            </div>
            <div style="margin-top: 20px;">
                <button id="btnCreateBackup" class="btn btn-outline" style="background: #f59e0b; color: white; border-color: #d97706;">ğŸ“ Ø§ÛŒØ¬Ø§Ø¯ Ù†Ø³Ø®Ù‡ Ù¾Ø´ØªÛŒØ¨Ø§Ù† (Backup)</button>
            </div>
        </div>

        <div class="card">
            <div class="card-title">
                <span>ğŸ§© Û³. ÙˆÛŒØ±Ø§ÛŒØ´Ú¯Ø± Ø¯Ø³ØªÛŒ State</span>
            </div>
            <div style="margin-bottom: 20px;">
                <label style="font-weight: 600; display: block; margin-bottom: 8px;">âœï¸ Ù…Ø­ØªÙˆØ§ÛŒ State (JSON):</label>
                <textarea id="manualStateInput" rows="6" style="width: 100%; padding: 15px; border-radius: 16px; border: 2px solid #cbd5e1; font-family: monospace; direction: ltr; font-size: 14px;">{
  "user": {
    "id": "usr_1",
    "name": "Ú©Ø§Ø±Ø¨Ø± Ø¢Ø²Ù…Ø§ÛŒØ´ÛŒ",
    "level": 5,
    "xp": 1240,
    "streakDays": 7
  },
  "settings": {
    "theme": "dark",
    "language": "fa",
    "dailyGoal": 20
  },
  "lastLesson": "lesson_12",
  "appVersion": "1.2.0"
}</textarea>
            </div>
            <div class="grid-2">
                <button id="btnSaveManual" class="btn btn-primary">ğŸ’¾ Ø°Ø®ÛŒØ±Ù‡ State Ø¯Ø³ØªÛŒ</button>
                <button id="btnValidateJson" class="btn btn-outline">âœ… Ø§Ø¹ØªØ¨Ø§Ø±Ø³Ù†Ø¬ÛŒ JSON</button>
            </div>
        </div>

        <div class="card">
            <div class="card-title">
                <span>ğŸ”„ Û´. Ø³Ù†Ø§Ø±ÛŒÙˆÙ‡Ø§ÛŒ Ù¾ÛŒØ´Ø±ÙØªÙ‡</span>
            </div>
            <div class="grid-2">
                <button id="btnSimulateCrash" class="btn btn-warning">ğŸ’¥ Ø´Ø¨ÛŒÙ‡â€ŒØ³Ø§Ø²ÛŒ Ú©Ø±Ø´ (Ù¾Ø§Ú© Ú©Ø±Ø¯Ù† Ø­Ø§ÙØ¸Ù‡)</button>
                <button id="btnAutoRecover" class="btn btn-success" style="background: #7e5bef;">ğŸ›¡ï¸ Ø¨Ø§Ø²ÛŒØ§Ø¨ÛŒ Ø®ÙˆØ¯Ú©Ø§Ø± Ø§Ø² Ø¢Ø®Ø±ÛŒÙ† Ù†Ø³Ø®Ù‡</button>
            </div>
            <div style="margin-top: 20px;">
                <button id="btnVersionMigration" class="btn btn-outline">ğŸ“± ØªØ³Øª Ù…Ù‡Ø§Ø¬Ø±Øª Ù†Ø³Ø®Ù‡ (v1 â†’ v2)</button>
                <span id="migrationResult" style="display: inline-block; margin-right: 15px; font-size: 14px;"></span>
            </div>
        </div>

        <!-- Ú¯Ø²Ø§Ø±Ø´ Ø¹Ù…Ù„ÛŒØ§Øª -->
        <div class="card" style="background: #f1f5f9;">
            <div class="card-title">
                <span>ğŸ“‹ Ûµ. Ú¯Ø²Ø§Ø±Ø´ Ø±ÙˆÛŒØ¯Ø§Ø¯Ù‡Ø§ (Event Log)</span>
            </div>
            <div id="eventLog" style="background: #0f172a; color: #e2e8f0; border-radius: 16px; padding: 18px; font-family: 'Courier New', monospace; font-size: 13px; direction: ltr; text-align: left; max-height: 200px; overflow-y: auto;">
                [SYSTEM] ØªØ³Øª Ø¯Ø³ØªÛŒ State Persistence Ø¢Ù…Ø§Ø¯Ù‡ Ø§Ø³Øª.
            </div>
            <button id="btnClearLog" style="margin-top: 15px; background: transparent; border: 1px solid #64748b; padding: 8px 16px; border-radius: 30px;">ğŸ§¹ Ù¾Ø§Ú© Ú©Ø±Ø¯Ù† Ù„Ø§Ú¯</button>
        </div>

        <div class="footer">
            <p>ğŸ“± Farsinglish â€” ØªØ³Øª Ø¯Ø³ØªÛŒ Ù…Ø§Ú˜ÙˆÙ„ State Persistence | Ù‚Ø§Ø¨Ù„ Ø§Ø¬Ø±Ø§ Ø¯Ø± Ù…Ø±ÙˆØ±Ú¯Ø± Ù…ÙˆØ¨Ø§ÛŒÙ„</p>
            <p style="font-size: 12px;">ğŸŸ¢ Ø§ÛŒÙ† ÙØ§ÛŒÙ„ Ø¨Ù‡â€ŒØµÙˆØ±Øª Ú©Ø§Ù…Ù„Ø§Ù‹ Ø¯Ø³ØªÛŒØŒ Ù…Ø§Ù†Ø¯Ú¯Ø§Ø±ÛŒ Ø¯Ø§Ø¯Ù‡ Ø±Ø§ Ø¯Ø± LocalStorage/IndexedDB Ø´Ø¨ÛŒÙ‡â€ŒØ³Ø§Ø²ÛŒ Ù…ÛŒâ€ŒÚ©Ù†Ø¯.</p>
        </div>
    </div>

    <script>
        // =============================
        // Ù…Ø§Ú˜ÙˆÙ„ Ù…Ø¯ÛŒØ±ÛŒØª State Persistence (Ø¯Ø³ØªÛŒ Ùˆ Ø´Ø¨ÛŒÙ‡â€ŒØ³Ø§Ø²)
        // =============================
        const StateManager = {
            STORAGE_KEY: 'farsinglish_app_state_v2',
            BACKUP_KEY: 'farsinglish_backup_state',
            VERSION: '2.0.0',

            // Ù…Ù‚Ø¯Ø§Ø± Ù¾ÛŒØ´â€ŒÙØ±Ø¶ state
            getDefaultState() {
                return {
                    user: { id: null, name: 'Ù…ÛŒÙ‡Ù…Ø§Ù†', level: 1, xp: 0, streakDays: 0 },
                    settings: { theme: 'light', language: 'fa', dailyGoal: 10 },
                    lastLesson: null,
                    appVersion: this.VERSION,
                    lastSaved: new Date().toISOString()
                };
            },

            // Ø°Ø®ÛŒØ±Ù‡ state
            save(state, isBackup = false) {
                try {
                    const key = isBackup ? this.BACKUP_KEY : this.STORAGE_KEY;
                    const stateWithMeta = {
                        ...state,
                        _meta: {
                            version: this.VERSION,
                            timestamp: Date.now(),
                            isBackup: isBackup
                        }
                    };
                    localStorage.setItem(key, JSON.stringify(stateWithMeta));
                    this.log(`ğŸ’¾ Ø°Ø®ÛŒØ±Ù‡ Ø´Ø¯ Ø¯Ø± ${isBackup ? 'Ù¾Ø´ØªÛŒØ¨Ø§Ù†' : 'Ø§ØµÙ„ÛŒ'}`);
                    return true;
                } catch(e) {
                    this.log(`âŒ Ø®Ø·Ø§ Ø¯Ø± Ø°Ø®ÛŒØ±Ù‡: ${e.message}`, 'error');
                    return false;
                }
            },

            // Ø¨Ø§Ø²ÛŒØ§Ø¨ÛŒ state
            load(fromBackup = false) {
                try {
                    const key = fromBackup ? this.BACKUP_KEY : this.STORAGE_KEY;
                    const data = localStorage.getItem(key);
                    if (!data) {
                        this.log(`ğŸ“­ Ù‡ÛŒÚ† Ø¯Ø§Ø¯Ù‡â€ŒØ§ÛŒ ÛŒØ§ÙØª Ù†Ø´Ø¯ (${fromBackup ? 'Ù¾Ø´ØªÛŒØ¨Ø§Ù†' : 'Ø§ØµÙ„ÛŒ'})`);
                        return this.getDefaultState();
                    }
                    const parsed = JSON.parse(data);
                    // Ø­Ø°Ù _meta Ø§Ø² Ø®Ø±ÙˆØ¬ÛŒ Ø§ØµÙ„ÛŒ
                    if (parsed._meta) delete parsed._meta;
                    this.log(`ğŸ“‚ Ø¨Ø§Ø²ÛŒØ§Ø¨ÛŒ Ø§Ø² ${fromBackup ? 'Ù¾Ø´ØªÛŒØ¨Ø§Ù†' : 'Ø§ØµÙ„ÛŒ'} Ù…ÙˆÙÙ‚`);
                    return parsed;
                } catch(e) {
                    this.log(`âŒ Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø§Ø²ÛŒØ§Ø¨ÛŒ: ${e.message}`, 'error');
                    return this.getDefaultState();
                }
            },

            // Ù…Ù‡Ø§Ø¬Ø±Øª Ù†Ø³Ø®Ù‡
            migrateFromV1() {
                try {
                    const oldData = localStorage.getItem('farsinglish_app_state_v1');
                    if (!oldData) return { success: false, reason: 'Ù†Ø³Ø®Ù‡ v1 ÛŒØ§ÙØª Ù†Ø´Ø¯' };
                    
                    const oldParsed = JSON.parse(oldData);
                    // Ù…Ù‡Ø§Ø¬Ø±Øª Ø¨Ù‡ v2
                    const newState = {
                        user: oldParsed.user || { name: 'Ú©Ø§Ø±Ø¨Ø± Ù‚Ø¯ÛŒÙ…ÛŒ', level: 1, xp: 0 },
                        settings: oldParsed.settings || { theme: 'light', language: 'fa' },
                        lastLesson: oldParsed.lastLesson || null,
                        appVersion: this.VERSION,
                        migratedFrom: 'v1',
                        migratedAt: new Date().toISOString()
                    };
                    this.save(newState);
                    this.log(`ğŸ†™ Ù…Ù‡Ø§Ø¬Ø±Øª Ø§Ø² v1 Ø¨Ù‡ v2 Ø§Ù†Ø¬Ø§Ù… Ø´Ø¯`);
                    return { success: true, state: newState };
                } catch(e) {
                    this.log(`âŒ Ù…Ù‡Ø§Ø¬Ø±Øª Ù†Ø§Ù…ÙˆÙÙ‚: ${e.message}`, 'error');
                    return { success: false, error: e.message };
                }
            },

            // Ù¾Ø§Ú© Ú©Ø±Ø¯Ù† Ú©Ø§Ù…Ù„ state
            clearAll() {
                localStorage.removeItem(this.STORAGE_KEY);
                localStorage.removeItem(this.BACKUP_KEY);
                this.log('ğŸ§¹ ØªÙ…Ø§Ù… stateÙ‡Ø§ Ù¾Ø§Ú© Ø´Ø¯Ù†Ø¯');
            },

            // Ø§Ø¹ØªØ¨Ø§Ø±Ø³Ù†Ø¬ÛŒ JSON
            validateJSON(str) {
                try {
                    JSON.parse(str);
                    return { valid: true };
                } catch(e) {
                    return { valid: false, error: e.message };
                }
            },

            log(message, type = 'info') {
                const logBox = document.getElementById('eventLog');
                if (!logBox) return;
                const time = new Date().toLocaleTimeString('fa-IR', { hour: '2-digit', minute: '2-digit', second: '2-digit' });
                const color = type === 'error' ? '#f87171' : '#a5f3fc';
                const entry = document.createElement('div');
                entry.style.color = color;
                entry.style.marginBottom = '4px';
                entry.innerHTML = `â±ï¸ ${time} â€” ${message}`;
                logBox.appendChild(entry);
                logBox.scrollTop = logBox.scrollHeight;
            }
        };

        // =============================
        // Ú©Ù†ØªØ±Ù„Ø±Ù‡Ø§ÛŒ UI
        // =============================
        function refreshUIDisplay() {
            const currentState = StateManager.load(false);
            const displayEl = document.getElementById('currentStateDisplay');
            displayEl.innerHTML = JSON.stringify(currentState, null, 2);
        }

        // Ù„Ø§Ú¯ Ø§ÙˆÙ„ÛŒÙ‡
        StateManager.log('ğŸš€ Ù…ÙˆØªÙˆØ± State Persistence Ø±Ø§Ù‡â€ŒØ§Ù†Ø¯Ø§Ø²ÛŒ Ø´Ø¯.');
        refreshUIDisplay();

        // ========== Ø§ØªØµØ§Ù„ Ø±ÙˆÛŒØ¯Ø§Ø¯Ù‡Ø§ ==========
        document.getElementById('btnRefreshState').addEventListener('click', function() {
            refreshUIDisplay();
            StateManager.log('ğŸ”„ Ù†Ù…Ø§ÛŒØ´ state Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ø´Ø¯');
        });

        document.getElementById('btnResetState').addEventListener('click', function() {
            if (confirm('âš ï¸ Ø¢ÛŒØ§ Ø§Ø² Ù¾Ø§Ú© Ú©Ø±Ø¯Ù† Ú©Ø§Ù…Ù„ State Ù…Ø·Ù…Ø¦Ù† Ù‡Ø³ØªÛŒØ¯ØŸ')) {
                StateManager.clearAll();
                refreshUIDisplay();
            }
        });

        document.getElementById('btnSaveSimple').addEventListener('click', function() {
            const current = StateManager.load(false);
            current.lastSaved = new Date().toISOString();
            current.user.name = 'Ú©Ø§Ø±Ø¨Ø± ØªØ³Øª_' + Math.floor(Math.random() * 1000);
            StateManager.save(current, false);
            refreshUIDisplay();
        });

        document.getElementById('btnLoadSimple').addEventListener('click', function() {
            const loaded = StateManager.load(false);
            StateManager.log('ğŸ“‚ Ø¢Ø®Ø±ÛŒÙ† state Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ùˆ Ø¯Ø± Ù†Ù…Ø§ÛŒØ´Ú¯Ø± Ù…Ù†Ø¹Ú©Ø³ Ø´Ø¯');
            refreshUIDisplay(); // Ù†Ù…Ø§ÛŒØ´ state Ø¨Ø§Ø²ÛŒØ§Ø¨ÛŒ Ø´Ø¯Ù‡
        });

        document.getElementById('btnCreateBackup').addEventListener('click', function() {
            const current = StateManager.load(false);
            StateManager.save(current, true);
            StateManager.log('ğŸ“ Ù†Ø³Ø®Ù‡ Ù¾Ø´ØªÛŒØ¨Ø§Ù† Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø§ÛŒØ¬Ø§Ø¯ Ø´Ø¯');
        });

        document.getElementById('btnSaveManual').addEventListener('click', function() {
            const textarea = document.getElementById('manualStateInput');
            const jsonStr = textarea.value;
            const validation = StateManager.validateJSON(jsonStr);
            if (!validation.valid) {
                alert('âŒ JSON Ù†Ø§Ù…Ø¹ØªØ¨Ø± Ø§Ø³Øª: ' + validation.error);
                StateManager.log(`âŒ Ø°Ø®ÛŒØ±Ù‡ Ø¯Ø³ØªÛŒ Ù†Ø§Ù…ÙˆÙÙ‚: ${validation.error}`, 'error');
                return;
            }
            const manualState = JSON.parse(jsonStr);
            StateManager.save(manualState, false);
            refreshUIDisplay();
            StateManager.log('âœï¸ State Ø¯Ø³ØªÛŒ Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø°Ø®ÛŒØ±Ù‡ Ø´Ø¯');
        });

        document.getElementById('btnValidateJson').addEventListener('click', function() {
            const textarea = document.getElementById('manualStateInput');
            const validation = StateManager.validateJSON(textarea.value);
            if (validation.valid) {
                alert('âœ… JSON Ù…Ø¹ØªØ¨Ø± Ø§Ø³Øª');
                StateManager.log('âœ… Ø§Ø¹ØªØ¨Ø§Ø±Ø³Ù†Ø¬ÛŒ JSON: Ù…Ø¹ØªØ¨Ø±');
            } else {
                alert('âŒ JSON Ù†Ø§Ù…Ø¹ØªØ¨Ø±: ' + validation.error);
                StateManager.log(`âŒ JSON Ù†Ø§Ù…Ø¹ØªØ¨Ø±: ${validation.error}`, 'error');
            }
        });

        document.getElementById('btnSimulateCrash').addEventListener('click', function() {
            // Ù¾Ø§Ú© Ú©Ø±Ø¯Ù† state Ùˆ Ø´Ø¨ÛŒÙ‡â€ŒØ³Ø§Ø²ÛŒ Ú©Ø±Ø´
            localStorage.removeItem(StateManager.STORAGE_KEY);
            refreshUIDisplay();
            StateManager.log('ğŸ’¥ Ø´Ø¨ÛŒÙ‡â€ŒØ³Ø§Ø²ÛŒ Ú©Ø±Ø´: state Ø§ØµÙ„ÛŒ Ù¾Ø§Ú© Ø´Ø¯ (Ø¨Ø§Ø²ÛŒØ§Ø¨ÛŒ Ø§Ø² Ù¾Ø´ØªÛŒØ¨Ø§Ù† ÛŒØ§ Ù†Ø³Ø®Ù‡ Ù¾ÛŒØ´â€ŒÙØ±Ø¶)');
            alert('âš ï¸ Ú©Ø±Ø´ Ø´Ø¨ÛŒÙ‡â€ŒØ³Ø§Ø²ÛŒ Ø´Ø¯. Ø­Ø§Ù„Ø§ Ø¯Ú©Ù…Ù‡ "Ø¨Ø§Ø²ÛŒØ§Ø¨ÛŒ Ø®ÙˆØ¯Ú©Ø§Ø±" Ø±Ø§ Ø¨Ø²Ù†ÛŒØ¯.');
        });

        document.getElementById('btnAutoRecover').addEventListener('click', function() {
            // Ø§Ø¨ØªØ¯Ø§ Ø³Ø¹ÛŒ Ú©Ù† Ø§Ø² Ù¾Ø´ØªÛŒØ¨Ø§Ù† Ø¨Ø±Ú¯Ø±Ø¯ÙˆÙ†ÛŒ
            const backup = StateManager.load(true);
            if (backup && backup.user && backup.user.id !== null) {
                StateManager.save(backup, false);
                StateManager.log('ğŸ›¡ï¸ Ø¨Ø§Ø²ÛŒØ§Ø¨ÛŒ Ø®ÙˆØ¯Ú©Ø§Ø± Ø§Ø² Ù¾Ø´ØªÛŒØ¨Ø§Ù† Ø§Ù†Ø¬Ø§Ù… Ø´Ø¯');
            } else {
                // Ø¯Ø±ØºÛŒØ±Ø§ÛŒÙ†ØµÙˆØ±Øª state Ù¾ÛŒØ´â€ŒÙØ±Ø¶
                const defaultState = StateManager.getDefaultState();
                StateManager.save(defaultState, false);
                StateManager.log('ğŸ›¡ï¸ Ù¾Ø´ØªÛŒØ¨Ø§Ù† Ù…ÙˆØ¬ÙˆØ¯ Ù†Ø¨ÙˆØ¯ØŒ state Ù¾ÛŒØ´â€ŒÙØ±Ø¶ Ø°Ø®ÛŒØ±Ù‡ Ø´Ø¯');
            }
            refreshUIDisplay();
        });

        document.getElementById('btnVersionMigration').addEventListener('click', function() {
            // Ø´Ø¨ÛŒÙ‡â€ŒØ³Ø§Ø²ÛŒ Ø°Ø®ÛŒØ±Ù‡ v1
            const mockV1 = {
                user: { name: 'ali_old', level: 3, xp: 550 },
                settings: { theme: 'auto' },
                lastLesson: 'greetings_1'
            };
            localStorage.setItem('farsinglish_app_state_v1', JSON.stringify(mockV1));
            StateManager.log('ğŸ“¦ ÛŒÚ© state Ø¢Ø²Ù…Ø§ÛŒØ´ÛŒ v1 Ø§ÛŒØ¬Ø§Ø¯ Ø´Ø¯');
            
            const migrationResult = StateManager.migrateFromV1();
            if (migrationResult.success) {
                document.getElementById('migrationResult').innerHTML = 'âœ… Ù…Ù‡Ø§Ø¬Ø±Øª Ù…ÙˆÙÙ‚';
                document.getElementById('migrationResult').style.color = '#0f6e4a';
                refreshUIDisplay();
            } else {
                document.getElementById('migrationResult').innerHTML = 'âŒ Ù…Ù‡Ø§Ø¬Ø±Øª Ù†Ø§Ù…ÙˆÙÙ‚';
                document.getElementById('migrationResult').style.color = '#b45309';
            }
        });

        document.getElementById('btnClearLog').addEventListener('click', function() {
            const logBox = document.getElementById('eventLog');
            logBox.innerHTML = '[SYSTEM] Ù„Ø§Ú¯ Ù¾Ø§Ú© Ø´Ø¯.';
            StateManager.log('ğŸ§¹ Ù„Ø§Ú¯ Ø±ÙˆÛŒØ¯Ø§Ø¯Ù‡Ø§ Ù¾Ø§Ú©Ø³Ø§Ø²ÛŒ Ø´Ø¯');
        });

        // Ø°Ø®ÛŒØ±Ù‡ Ø®ÙˆØ¯Ú©Ø§Ø± state Ø¯Ø± ØµÙˆØ±Øª Ø¨Ø³ØªÙ‡ Ø´Ø¯Ù† ØµÙØ­Ù‡ (Ø¬Ù‡Øª Ø´Ø¨ÛŒÙ‡â€ŒØ³Ø§Ø²ÛŒ)
        window.addEventListener('beforeunload', function() {
            // Ø§ÛŒÙ† ØµØ±ÙØ§Ù‹ ÛŒÚ© Ø´Ø¨ÛŒÙ‡â€ŒØ³Ø§Ø²ÛŒ Ø³Ø¨Ú© Ø§Ø³ØªØ› Ù…Ø§ Ø§Ø² localStorage Ø§Ø³ØªÙØ§Ø¯Ù‡ Ù…ÛŒâ€ŒÚ©Ù†ÛŒÙ… Ú©Ù‡ Ù…Ø§Ù†Ø¯Ú¯Ø§Ø± Ø§Ø³Øª.
            StateManager.log('âï¸ ØµÙØ­Ù‡ Ø¨Ø³ØªÙ‡ Ø´Ø¯. state Ø¯Ø± localStorage Ø¨Ø§Ù‚ÛŒ Ù…ÛŒâ€ŒÙ…Ø§Ù†Ø¯.');
        });

        // Ø§ÙØ²ÙˆØ¯Ù† Ù‚Ø§Ø¨Ù„ÛŒØª Ù†Ù…Ø§ÛŒØ´ RTL ØµØ­ÛŒØ­ Ø¯Ø± state-box
        document.querySelectorAll('.state-box').forEach(el => {
            el.setAttribute('dir', 'ltr');
        });
    </script>
</body>
</html>
