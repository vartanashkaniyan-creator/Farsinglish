<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.5, user-scalable=yes">
    <title>ØªØ³Øª Ø¯Ø³ØªÛŒ Ù†Ø§ÙˆØ¨Ø±ÛŒ Ùˆ Ø¨Ø§Ø²Ú¯Ø´Øª - Farsinglish</title>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body {
            font-family: 'Tahoma', 'Arial', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        .container {
            max-width: 900px;
            width: 100%;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 28px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            padding: 25px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.3);
        }
        h1 {
            font-size: 1.9rem;
            color: #2d3748;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 10px;
            border-bottom: 3px solid #9f7aea;
            padding-bottom: 15px;
        }
        .subtitle {
            color: #4a5568;
            margin-bottom: 25px;
            font-size: 1.1rem;
            background: #e9d8fd;
            padding: 12px 18px;
            border-radius: 50px;
            display: inline-block;
        }
        .test-area {
            background: #f7fafc;
            border-radius: 24px;
            padding: 25px;
            margin: 20px 0;
            border: 2px dashed #cbd5e0;
        }
        .nav-bar {
            display: flex;
            gap: 15px;
            margin-bottom: 30px;
            flex-wrap: wrap;
            background: white;
            padding: 15px;
            border-radius: 18px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.05);
        }
        .nav-btn {
            background: #edf2f7;
            border: none;
            padding: 14px 24px;
            border-radius: 16px;
            font-size: 1rem;
            font-weight: 600;
            color: #2d3748;
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
            transition: 0.2s;
            border: 1px solid transparent;
            flex: 1 1 auto;
            justify-content: center;
        }
        .nav-btn.active {
            background: #805ad5;
            color: white;
            box-shadow: 0 10px 15px -3px rgba(128, 90, 213, 0.4);
            border-color: #553c9a;
        }
        .nav-btn:hover {
            background: #cbd5e0;
            transform: translateY(-2px);
        }
        .content-panel {
            background: white;
            border-radius: 20px;
            padding: 25px;
            min-height: 280px;
            box-shadow: inset 0 2px 10px rgba(0,0,0,0.02);
            border: 1px solid #e2e8f0;
            margin-bottom: 25px;
        }
        .state-box {
            background: #2d3748;
            color: #e2e8f0;
            padding: 18px;
            border-radius: 16px;
            font-family: 'Courier New', monospace;
            direction: ltr;
            text-align: left;
            font-size: 0.9rem;
            overflow-x: auto;
            white-space: pre-wrap;
            word-wrap: break-word;
            border-left: 6px solid #9f7aea;
            margin-top: 15px;
        }
        .history-list {
            background: #fefcbf;
            padding: 18px;
            border-radius: 16px;
            color: #744210;
            border-right: 6px solid #d69e2e;
            margin: 15px 0;
        }
        .btn {
            background: linear-gradient(145deg, #48bb78, #38a169);
            color: white;
            border: none;
            padding: 16px 28px;
            border-radius: 50px;
            font-size: 1.1rem;
            font-weight: 700;
            display: inline-flex;
            align-items: center;
            gap: 12px;
            cursor: pointer;
            transition: 0.2s;
            border-bottom: 4px solid #276749;
            margin: 10px 0;
            width: 100%;
            justify-content: center;
        }
        .btn-secondary {
            background: linear-gradient(145deg, #a0aec0, #718096);
            border-bottom-color: #4a5568;
        }
        .btn-warning {
            background: linear-gradient(145deg, #fbbf24, #d97706);
            border-bottom-color: #b45309;
        }
        .test-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(170px, 1fr));
            gap: 12px;
            margin: 20px 0;
        }
        .log-entry {
            background: #1a202c;
            color: #cbd5e0;
            padding: 10px 16px;
            border-radius: 12px;
            font-family: monospace;
            margin-bottom: 8px;
            border-left: 4px solid #48bb78;
        }
        .badge {
            background: #ecc94b;
            color: #1a202c;
            padding: 6px 14px;
            border-radius: 30px;
            font-size: 0.85rem;
            font-weight: 700;
            display: inline-block;
        }
        @media (max-width: 600px) {
            .container { padding: 18px; }
            h1 { font-size: 1.5rem; }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>
            <span>ğŸ§­ Ø¢Ø²Ù…ÙˆÙ† Ù†Ø§ÙˆØ¨Ø±ÛŒ Ùˆ Ø¨Ø§Ø²Ú¯Ø´Øª</span>
            <span class="badge">ØªØ³Øª Ø¯Ø³ØªÛŒ Â· Û· Ø³Ù†Ø§Ø±ÛŒÙˆ</span>
        </h1>
        <div class="subtitle">
            âª Ø¨Ø±Ø±Ø³ÛŒ Ø­ÙØ¸ stateØŒ Ù¾Ø´ØªÙ‡ ØªØ§Ø±ÛŒØ®Ú†Ù‡ Ùˆ Ø¨Ø§Ø²Ú¯Ø´Øª Ø¨Ù‡ ØµÙØ­Ù‡ Ù‚Ø¨Ù„
        </div>

        <!-- Ù†ÙˆØ§Ø± Ù†Ø§ÙˆØ¨Ø±ÛŒ Ø´Ø¨ÛŒÙ‡â€ŒØ³Ø§Ø²ÛŒ Ø´Ø¯Ù‡ -->
        <div class="nav-bar" id="navBar">
            <button class="nav-btn" data-page="dashboard">ğŸ  Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯</button>
            <button class="nav-btn" data-page="lessons">ğŸ“š Ø¯Ø±ÙˆØ³ Ù…Ù†</button>
            <button class="nav-btn" data-page="review">ğŸ”„ Ù…Ø±ÙˆØ± Ù‡ÙˆØ´Ù…Ù†Ø¯</button>
            <button class="nav-btn" data-page="profile">ğŸ‘¤ Ù¾Ø±ÙˆÙØ§ÛŒÙ„</button>
        </div>

        <!-- Ù†Ù…Ø§ÛŒØ´ ØµÙØ­Ù‡ Ø¬Ø§Ø±ÛŒ -->
        <div class="content-panel" id="contentPanel">
            <h2 id="pageTitle" style="color: #2c5282; margin-bottom: 16px;">ğŸ  Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯</h2>
            <div id="pageContent">
                <p style="font-size: 1.2rem; margin-bottom: 20px;">Ø¨Ù‡ ØµÙØ­Ù‡ Ø§ØµÙ„ÛŒ Ø®ÙˆØ´ Ø¢Ù…Ø¯ÛŒØ¯!</p>
                <div style="background: #ebf4ff; padding: 20px; border-radius: 18px;">
                    <span style="font-weight: bold;">Ù¾ÛŒØ´Ø±ÙØª Ø§Ù…Ø±ÙˆØ²:</span> Û¶Û¸Ùª ØªÚ©Ù…ÛŒÙ„ Ø´Ø¯Ù‡<br>
                    <span style="font-weight: bold;">Ù…Ø±ÙˆØ± Ø¨Ø¹Ø¯ÛŒ:</span> Û±Û² Ø¯Ù‚ÛŒÙ‚Ù‡ Ø¯ÛŒÚ¯Ø±
                </div>
            </div>
        </div>

        <!-- Ø¨Ø®Ø´ ØªØ³Øª Ø¯Ø³ØªÛŒ Ù†Ø§ÙˆØ¨Ø±ÛŒ -->
        <div class="test-area">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h3 style="color: #2b6cb0; margin: 0;">ğŸ§ª Ø³Ù†Ø§Ø±ÛŒÙˆÙ‡Ø§ÛŒ ØªØ³Øª Ø¯Ø³ØªÛŒ</h3>
                <span id="manualStepBadge" style="background: #faf089; padding: 8px 18px; border-radius: 30px; font-weight: bold;">Ú¯Ø§Ù… Û± Ø§Ø² Û·</span>
            </div>
            
            <!-- Ù†Ù…Ø§ÛŒØ´ state ÙØ¹Ù„ÛŒ Ùˆ ØªØ§Ø±ÛŒØ®Ú†Ù‡ -->
            <div style="margin-bottom: 20px;">
                <button id="showStateBtn" class="btn-secondary" style="width: auto; padding: 12px 20px; display: inline-flex; margin-left: 10px;">
                    ğŸ“Š Ù†Ù…Ø§ÛŒØ´ state Ú©Ø§Ù…Ù„
                </button>
                <button id="simulateBackBtn" class="btn-warning" style="width: auto; padding: 12px 20px; display: inline-flex;">
                    âª Ø´Ø¨ÛŒÙ‡â€ŒØ³Ø§Ø²ÛŒ Ø¯Ú©Ù…Ù‡ Ø¨Ø§Ø²Ú¯Ø´Øª
                </button>
                <button id="resetTestBtn" style="background: #e53e3e; border-bottom-color: #9b2c2c; width: auto; padding: 12px 20px; display: inline-flex;" class="btn">
                    ğŸ”„ Ø±ÛŒØ³Øª ØªØ³Øª
                </button>
            </div>

            <!-- Ù†Ù…Ø§ÛŒØ´ State Ø¨Ù‡ ØµÙˆØ±Øª live -->
            <div id="stateDisplay" class="state-box">
                â³ Ù…Ù†ØªØ¸Ø± Ø§Ø¬Ø±Ø§ÛŒ ØªØ³Øª...
            </div>

            <!-- ØªØ§Ø±ÛŒØ®Ú†Ù‡ Ù†Ø§ÙˆØ¨Ø±ÛŒ -->
            <div id="historyDisplay" class="history-list">
                <strong>ğŸ“œ Ù¾Ø´ØªÙ‡ Ù†Ø§ÙˆØ¨Ø±ÛŒ:</strong> <span id="historyStack">[dashboard]</span><br>
                <strong>ğŸ§¾ Ø¢Ø®Ø±ÛŒÙ† Ø§Ú©Ø´Ù†:</strong> <span id="lastAction">Ø´Ø±ÙˆØ¹ Ø¨Ø±Ù†Ø§Ù…Ù‡</span>
            </div>

            <!-- Ù„ÛŒØ³Øª Ú†Ú©â€ŒÙ„ÛŒØ³Øª ØªØ³Øª Ø¯Ø³ØªÛŒ -->
            <div style="background: #fff5f5; padding: 22px; border-radius: 20px; margin-top: 25px; border: 1px solid #feb2b2;">
                <h4 style="color: #c53030; margin-bottom: 18px;">âœ… Ú†Ú©â€ŒÙ„ÛŒØ³Øª ØªØ³Øª Ø¯Ø³ØªÛŒ (Û· Ø³Ù†Ø§Ø±ÛŒÙˆ)</h4>
                
                <div class="test-grid">
                    <div id="test1Card" style="background: white; padding: 15px; border-radius: 16px; border: 2px solid #e2e8f0;">
                        <input type="checkbox" id="test1" class="test-checkbox" data-testid="1">
                        <label for="test1" style="font-weight: bold; margin-right: 8px;">Û±. Ù†Ø§ÙˆØ¨Ø±ÛŒ Ø¨Ù‡ Ø¯Ø±Ø³â€ŒÙ‡Ø§</label>
                        <p style="font-size: 0.85rem; color: #4a5568; margin-top: 8px;">Ú©Ù„ÛŒÚ© Ø±ÙˆÛŒ "Ø¯Ø±ÙˆØ³ Ù…Ù†" â† Ø¨Ø±Ø±Ø³ÛŒ ØªØºÛŒÛŒØ± Ù…Ø­ØªÙˆØ§</p>
                    </div>
                    <div id="test2Card" style="background: white; padding: 15px; border-radius: 16px; border: 2px solid #e2e8f0;">
                        <input type="checkbox" id="test2" class="test-checkbox" data-testid="2">
                        <label for="test2" style="font-weight: bold; margin-right: 8px;">Û². Ø¨Ø§Ø²Ú¯Ø´Øª Ø¨Ù‡ Ù‚Ø¨Ù„ÛŒ</label>
                        <p style="font-size: 0.85rem; color: #4a5568; margin-top: 8px;">Ø¯Ú©Ù…Ù‡ Ø¨Ø§Ø²Ú¯Ø´Øª â† Ø¨Ø§Ø²Ú¯Ø´Øª Ø¨Ù‡ Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯</p>
                    </div>
                    <div id="test3Card" style="background: white; padding: 15px; border-radius: 16px; border: 2px solid #e2e8f0;">
                        <input type="checkbox" id="test3" class="test-checkbox" data-testid="3">
                        <label for="test3" style="font-weight: bold; margin-right: 8px;">Û³. ÙˆØ±ÙˆØ¯ Ø¯ÛŒØªØ§ÛŒ ÙØ±Ù…</label>
                        <p style="font-size: 0.85rem; color: #4a5568; margin-top: 8px;">Ø¯Ø± Ù¾Ø±ÙˆÙØ§ÛŒÙ„ØŒ Ù…ØªÙ†ÛŒ ØªØ§ÛŒÙ¾ Ú©Ù† â† Ø¨Ø§Ø²Ú¯Ø´Øª â† Ø¨Ø±Ú¯Ø±Ø¯</p>
                    </div>
                    <div id="test4Card" style="background: white; padding: 15px; border-radius: 16px; border: 2px solid #e2e8f0;">
                        <input type="checkbox" id="test4" class="test-checkbox" data-testid="4">
                        <label for="test4" style="font-weight: bold; margin-right: 8px;">Û´. Ú†Ø±Ø®Ø´ ØµÙØ­Ù‡</label>
                        <p style="font-size: 0.85rem; color: #4a5568; margin-top: 8px;">Ù…Ø±ÙˆØ±Ú¯Ø± Ø±Ø§ Ø§ÙÙ‚ÛŒ/Ø¹Ù…ÙˆØ¯ÛŒ Ú©Ù† â† state Ø­ÙØ¸ Ø´Ø¯Ù‡ØŸ</p>
                    </div>
                    <div id="test5Card" style="background: white; padding: 15px; border-radius: 16px; border: 2px solid #e2e8f0;">
                        <input type="checkbox" id="test5" class="test-checkbox" data-testid="5">
                        <label for="test5" style="font-weight: bold; margin-right: 8px;">Ûµ. Ø¨Ø§Ø²Ú¯Ø´Øª Ú†Ù†Ø¯ Ù…Ø±Ø­Ù„Ù‡</label>
                        <p style="font-size: 0.85rem; color: #4a5568; margin-top: 8px;">Û³ ØµÙØ­Ù‡ Ø¬Ù„Ùˆ Ø¨Ø±Ùˆ â† Û² Ø¨Ø§Ø± Ø¨Ø§Ø²Ú¯Ø´Øª</p>
                    </div>
                    <div id="test6Card" style="background: white; padding: 15px; border-radius: 16px; border: 2px solid #e2e8f0;">
                        <input type="checkbox" id="test6" class="test-checkbox" data-testid="6">
                        <label for="test6" style="font-weight: bold; margin-right: 8px;">Û¶. Ø¨Ø§Ø²Ø®ÙˆØ§Ù†ÛŒ ØµÙØ­Ù‡</label>
                        <p style="font-size: 0.85rem; color: #4a5568; margin-top: 8px;">F5/Ø±ÙØ±Ø´ Ú©Ù† â† ØµÙØ­Ù‡ Ø¢Ø®Ø± Ø­ÙØ¸ Ø´Ø¯ØŸ</p>
                    </div>
                    <div id="test7Card" style="background: white; padding: 15px; border-radius: 16px; border: 2px solid #e2e8f0;">
                        <input type="checkbox" id="test7" class="test-checkbox" data-testid="7">
                        <label for="test7" style="font-weight: bold; margin-right: 8px;">Û·. Ø§Ø³ØªØ®Ø±Ø§Ø¬ ØªØ§Ø±ÛŒØ®Ú†Ù‡</label>
                        <p style="font-size: 0.85rem; color: #4a5568; margin-top: 8px;">Ø¯Ú©Ù…Ù‡ state Ú©Ø§Ù…Ù„ â† Ù„Ø§Ú¯ navigation stack</p>
                    </div>
                </div>
                
                <div style="display: flex; gap: 15px; margin-top: 30px; flex-wrap: wrap;">
                    <button id="exportLogBtn" class="btn-secondary" style="padding: 14px 25px; flex: 1;">
                        ğŸ“¤ Ø®Ø±ÙˆØ¬ÛŒ Ù„Ø§Ú¯ Ø¨Ù‡ Ú©Ù†Ø³ÙˆÙ„ Ù…Ø¬Ø§Ø²ÛŒ
                    </button>
                    <button id="markAllCompleteBtn" style="background: #38a169; padding: 14px 25px; flex: 1;" class="btn">
                        âœ… ØªØ£ÛŒÛŒØ¯ Ù‡Ù…Ù‡ Ø³Ù†Ø§Ø±ÛŒÙˆÙ‡Ø§
                    </button>
                </div>
            </div>
        </div>

        <!-- Ú©Ù†Ø³ÙˆÙ„ Ù…Ø¬Ø§Ø²ÛŒ Ø¨Ø±Ø§ÛŒ Ù†Ù…Ø§ÛŒØ´ Ù„Ø§Ú¯ -->
        <div style="margin-top: 25px; background: #1a202c; border-radius: 18px; padding: 18px;">
            <div style="display: flex; align-items: center; gap: 12px; color: #e2e8f0; margin-bottom: 15px;">
                <span style="background: #48bb78; padding: 5px 14px; border-radius: 30px; font-size: 0.8rem;">LIVE</span>
                <span>ğŸ“‹ Ú©Ù†Ø³ÙˆÙ„ Ù…Ø¬Ø§Ø²ÛŒ - Ø¢Ø®Ø±ÛŒÙ† Ø±ÙˆÛŒØ¯Ø§Ø¯Ù‡Ø§</span>
                <button id="clearLogBtn" style="background: transparent; border: 1px solid #718096; color: white; padding: 6px 16px; border-radius: 30px; margin-right: auto;">Ù¾Ø§Ú© Ú©Ø±Ø¯Ù†</button>
            </div>
            <div id="virtualConsole" style="min-height: 100px; max-height: 200px; overflow-y: auto; direction: ltr; text-align: left; font-family: 'Courier New', monospace; font-size: 0.8rem; color: #a0aec0;">
                <div class="log-entry">[INFO] ØªØ³Øª Ù†Ø§ÙˆØ¨Ø±ÛŒ Ø¢ØºØ§Ø² Ø´Ø¯ - Û±Û³ Ø¨Ù‡Ù…Ù† Û±Û´Û°Û´</div>
                <div class="log-entry">[SYSTEM] state manager ÙØ¹Ø§Ù„ Ø´Ø¯</div>
            </div>
        </div>
    </div>

    <script>
        // -------------------- Ù…Ø¯ÛŒØ±ÛŒØª Ù¾ÛŒØ´Ø±ÙØªÙ‡ State Ùˆ History --------------------
        class NavigationTestManager {
            constructor() {
                this.history = ['dashboard'];
                this.currentPage = 'dashboard';
                this.state = {
                    dashboard: { lastVisit: new Date().toLocaleString('fa-IR'), progress: 68 },
                    lessons: { filter: 'all', scrollPosition: 0, selectedCategory: 'grammar' },
                    review: { currentCard: 0, totalCards: 12, easeFactor: 2.5 },
                    profile: { name: 'Ø¹Ù„ÛŒ Ù…Ø­Ù…Ø¯ÛŒ', email: 'ali@example.com', tempInput: '' }
                };
                this.listeners = [];
                this.init();
            }

            init() {
                // Ø¨Ø§Ø±Ú¯ÛŒØ±ÛŒ Ø§Ø² localStorage Ø§Ú¯Ø± Ù…ÙˆØ¬ÙˆØ¯ Ø¨Ø§Ø´Ø¯
                try {
                    const saved = localStorage.getItem('farsinglish_navigation_test');
                    if (saved) {
                        const parsed = JSON.parse(saved);
                        this.history = parsed.history || ['dashboard'];
                        this.currentPage = parsed.currentPage || 'dashboard';
                        this.state = { ...this.state, ...parsed.state };
                    }
                } catch(e) {}
                
                this.log('Ù…Ø¯ÛŒØ±ÛŒØª Ù†Ø§ÙˆØ¨Ø±ÛŒ Ù…Ù‚Ø¯Ø§Ø±Ø¯Ù‡ÛŒ Ø´Ø¯');
                this.persist();
            }

            navigate(page) {
                if (page === this.currentPage) return;
                
                const previousPage = this.currentPage;
                this.history.push(page);
                this.currentPage = page;
                
                this.log(`Ù†Ø§ÙˆØ¨Ø±ÛŒ: ${previousPage} â†’ ${page}`);
                this.persist();
                this.notify();
                return { previous: previousPage, current: page };
            }

            back() {
                if (this.history.length <= 1) {
                    this.log('âš ï¸ Ù¾Ø´ØªÙ‡ Ù†Ø§ÙˆØ¨Ø±ÛŒ Ø®Ø§Ù„ÛŒ Ø§Ø³Øª - Ù†Ù…ÛŒâ€ŒØªÙˆØ§Ù† Ø¨Ø§Ø²Ú¯Ø´Øª');
                    return null;
                }
                
                this.history.pop(); // Ø­Ø°Ù ØµÙØ­Ù‡ ÙØ¹Ù„ÛŒ
                const previousPage = this.history[this.history.length - 1];
                const oldPage = this.currentPage;
                this.currentPage = previousPage;
                
                this.log(`â¬…ï¸ Ø¨Ø§Ø²Ú¯Ø´Øª: ${oldPage} â†’ ${previousPage}`);
                this.persist();
                this.notify();
                return { from: oldPage, to: previousPage };
            }

            updateState(page, key, value) {
                if (!this.state[page]) this.state[page] = {};
                this.state[page][key] = value;
                
                this.log(`ğŸ“¦ state Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ: ${page}.${key} = ${typeof value === 'string' ? value : JSON.stringify(value)}`);
                this.persist();
                return this.state[page];
            }

            getState(page) {
                return { ...this.state[page] }; // Ú©Ù¾ÛŒ Ø¹Ù…ÛŒÙ‚
            }

            persist() {
                const data = {
                    history: this.history,
                    currentPage: this.currentPage,
                    state: this.state
                };
                localStorage.setItem('farsinglish_navigation_test', JSON.stringify(data));
            }

            reset() {
                this.history = ['dashboard'];
                this.currentPage = 'dashboard';
                this.state = {
                    dashboard: { lastVisit: new Date().toLocaleString('fa-IR'), progress: 68 },
                    lessons: { filter: 'all', scrollPosition: 0, selectedCategory: 'grammar' },
                    review: { currentCard: 0, totalCards: 12, easeFactor: 2.5 },
                    profile: { name: 'Ø¹Ù„ÛŒ Ù…Ø­Ù…Ø¯ÛŒ', email: 'ali@example.com', tempInput: '' }
                };
                localStorage.removeItem('farsinglish_navigation_test');
                this.log('ğŸ”„ Ø±ÛŒØ³Øª Ú©Ø§Ù…Ù„ Ø³ÛŒØ³ØªÙ… Ù†Ø§ÙˆØ¨Ø±ÛŒ');
                this.notify();
            }

            log(message) {
                const consoleDiv = document.getElementById('virtualConsole');
                const entry = document.createElement('div');
                entry.className = 'log-entry';
                entry.textContent = `[${new Date().toLocaleTimeString('fa-IR')}] ${message}`;
                consoleDiv.appendChild(entry);
                consoleDiv.scrollTop = consoleDiv.scrollHeight;
                
                // Ø°Ø®ÛŒØ±Ù‡ Ø¯Ø± localStorage Ø¨Ø±Ø§ÛŒ Ø¯ÛŒØ¨Ø§Ú¯
                try {
                    const logs = JSON.parse(localStorage.getItem('nav_test_logs') || '[]');
                    logs.push({ time: new Date().toISOString(), message });
                    localStorage.setItem('nav_test_logs', JSON.stringify(logs.slice(-20)));
                } catch(e) {}
            }

            notify() {
                this.listeners.forEach(fn => fn(this.getSnapshot()));
            }

            subscribe(fn) {
                this.listeners.push(fn);
                fn(this.getSnapshot());
                return () => this.listeners = this.listeners.filter(l => l !== fn);
            }

            getSnapshot() {
                return {
                    currentPage: this.currentPage,
                    history: [...this.history],
                    state: JSON.parse(JSON.stringify(this.state)) // deep clone
                };
            }

            // Ø´Ø¨ÛŒÙ‡â€ŒØ³Ø§Ø²ÛŒ Ú†Ø±Ø®Ø´ ØµÙØ­Ù‡ (Ø­ÙØ¸ state)
            simulateRotation() {
                this.log('ğŸ”„ Ú†Ø±Ø®Ø´ ØµÙØ­Ù‡ Ø´Ø¨ÛŒÙ‡â€ŒØ³Ø§Ø²ÛŒ Ø´Ø¯ - state Ø³Ø§Ù„Ù…');
                return this.getSnapshot();
            }
        }

        // -------------------- Ø±Ø§Ù‡â€ŒØ§Ù†Ø¯Ø§Ø²ÛŒ Ùˆ Ø§ØªØµØ§Ù„ Ø¨Ù‡ UI --------------------
        const navManager = new NavigationTestManager();

        // Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ø±Ø§Ø¨Ø· Ú©Ø§Ø±Ø¨Ø±ÛŒ Ø¨Ø± Ø§Ø³Ø§Ø³ state
        function updateUI(snapshot) {
            // Ù†Ù…Ø§ÛŒØ´ ØµÙØ­Ù‡ Ø¬Ø§Ø±ÛŒ
            const pageTitleMap = {
                dashboard: 'ğŸ  Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯',
                lessons: 'ğŸ“š Ø¯Ø±ÙˆØ³ Ù…Ù†',
                review: 'ğŸ”„ Ù…Ø±ÙˆØ± Ù‡ÙˆØ´Ù…Ù†Ø¯',
                profile: 'ğŸ‘¤ Ù¾Ø±ÙˆÙØ§ÛŒÙ„'
            };
            
            document.getElementById('pageTitle').innerHTML = pageTitleMap[snapshot.currentPage] || 'ğŸ  ØµÙØ­Ù‡';
            
            // Ù…Ø­ØªÙˆØ§ÛŒ Ø¯Ø§ÛŒÙ†Ø§Ù…ÛŒÚ©
            let contentHtml = '';
            if (snapshot.currentPage === 'dashboard') {
                contentHtml = `<p style="font-size: 1.2rem; margin-bottom: 20px;">Ø¨Ù‡ ØµÙØ­Ù‡ Ø§ØµÙ„ÛŒ Ø®ÙˆØ´ Ø¢Ù…Ø¯ÛŒØ¯!</p>
                    <div style="background: #ebf4ff; padding: 20px; border-radius: 18px;">
                        <span style="font-weight: bold;">Ù¾ÛŒØ´Ø±ÙØª Ø§Ù…Ø±ÙˆØ²:</span> ${snapshot.state.dashboard?.progress || 68}Ùª ØªÚ©Ù…ÛŒÙ„ Ø´Ø¯Ù‡<br>
                        <span style="font-weight: bold;">Ù…Ø±ÙˆØ± Ø¨Ø¹Ø¯ÛŒ:</span> Û±Û² Ø¯Ù‚ÛŒÙ‚Ù‡ Ø¯ÛŒÚ¯Ø±
                    </div>`;
            } else if (snapshot.currentPage === 'lessons') {
                contentHtml = `<div style="display: flex; flex-direction: column; gap: 15px;">
                    <p><span style="background: #805ad5; color: white; padding: 5px 12px; border-radius: 20px;">ğŸ“˜ Ú¯Ø±Ø§Ù…Ø± Ù¾Ø§ÛŒÙ‡</span>  Û¶Û°Ùª Ù¾ÛŒØ´Ø±ÙØª</p>
                    <p><span style="background: #3182ce; color: white; padding: 5px 12px; border-radius: 20px;">ğŸ—£ï¸ Ù…Ú©Ø§Ù„Ù…Ù‡ Ø±ÙˆØ²Ù…Ø±Ù‡</span>  Û³Û°Ùª Ù¾ÛŒØ´Ø±ÙØª</p>
                    <p><span style="background: #38a169; color: white; padding: 5px 12px; border-radius: 20px;">âœï¸ ÙˆØ§Ú˜Ú¯Ø§Ù† Ø¶Ø±ÙˆØ±ÛŒ</span>  Û¸ÛµÙª Ù¾ÛŒØ´Ø±ÙØª</p>
                    <input type="text" id="lessonFilterInput" placeholder="ÙÛŒÙ„ØªØ± Ø¯Ø±Ø³â€ŒÙ‡Ø§..." style="margin-top: 15px; padding: 12px; border-radius: 12px; border: 1px solid #cbd5e0; width: 100%;" value="${snapshot.state.lessons?.filter || ''}">
                </div>`;
            } else if (snapshot.currentPage === 'review') {
                contentHtml = `<div style="text-align: center; padding: 15px;">
                    <div style="font-size: 1.6rem; margin-bottom: 15px;">ğŸƒ Ú©Ø§Ø±Øª ${snapshot.state.review?.currentCard + 1 || 1} Ø§Ø² ${snapshot.state.review?.totalCards || 12}</div>
                    <div style="background: #faf089; padding: 30px; border-radius: 24px; font-size: 1.8rem; margin-bottom: 20px; box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1);">Apple</div>
                    <p style="color: #2d3748;">Ù…Ø¹Ù†ÛŒ: Ø³ÛŒØ¨</p>
                    <div style="display: flex; gap: 10px; margin-top: 20px;">
                        <button style="flex:1; background: #f56565; padding: 12px; border-radius: 20px; border: none; color: white;">Ø³Ø®Øª</button>
                        <button style="flex:1; background: #48bb78; padding: 12px; border-radius: 20px; border: none; color: white;">Ø¢Ø³Ø§Ù†</button>
                    </div>
                </div>`;
            } else if (snapshot.currentPage === 'profile') {
                contentHtml = `<div style="display: flex; flex-direction: column; gap: 20px;">
                    <div><span style="font-weight: bold;">Ù†Ø§Ù…:</span> ${snapshot.state.profile?.name || 'Ø¹Ù„ÛŒ Ù…Ø­Ù…Ø¯ÛŒ'}</div>
                    <div><span style="font-weight: bold;">Ø§ÛŒÙ…ÛŒÙ„:</span> ${snapshot.state.profile?.email || 'ali@example.com'}</div>
                    <div>
                        <label>ğŸ“ ÛŒØ§Ø¯Ø¯Ø§Ø´Øª (ØªØ³Øª Ø­ÙØ¸ state):</label>
                        <input type="text" id="profileNoteInput" placeholder="Ú†ÛŒØ²ÛŒ ØªØ§ÛŒÙ¾ Ú©Ù†..." style="margin-top: 8px; padding: 14px; border-radius: 14px; border: 1px solid #cbd5e0; width: 100%;" value="${snapshot.state.profile?.tempInput || ''}">
                    </div>
                </div>`;
            }
            
            document.getElementById('pageContent').innerHTML = contentHtml;
            
            // Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ history stack
            document.getElementById('historyStack').innerHTML = `[${snapshot.history.join(' â†’ ')}]`;
            document.getElementById('lastAction').innerHTML = `Ø¢Ø®Ø±ÛŒÙ† ØµÙØ­Ù‡: ${snapshot.currentPage}`;
            
            // Ù†Ù…Ø§ÛŒØ´ state Ú©Ø§Ù…Ù„
            const stateDisplay = document.getElementById('stateDisplay');
            if (stateDisplay) {
                stateDisplay.innerHTML = `ğŸ“Œ state Ø¬Ø§Ø±ÛŒ:\n${JSON.stringify(snapshot.state, null, 2)}`;
            }
            
            // Ù‡Ø§ÛŒÙ„Ø§Øª Ø¯Ú©Ù…Ù‡ ÙØ¹Ø§Ù„
            document.querySelectorAll('.nav-btn').forEach(btn => {
                btn.classList.remove('active');
                if (btn.dataset.page === snapshot.currentPage) {
                    btn.classList.add('active');
                }
            });
        }

        // -------------------- Event Listeners --------------------
        window.onload = function() {
            // Ø«Ø¨Øª observer Ø¨Ø±Ø§ÛŒ Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ UI
            navManager.subscribe(updateUI);
            
            // Ù†Ø§ÙˆØ¨Ø±ÛŒ Ø¨Ø§ Ú©Ù„ÛŒÚ© Ø±ÙˆÛŒ Ø¯Ú©Ù…Ù‡â€ŒÙ‡Ø§
            document.querySelectorAll('.nav-btn').forEach(btn => {
                btn.addEventListener('click', function(e) {
                    e.preventDefault();
                    const page = this.dataset.page;
                    navManager.navigate(page);
                    
                    // Ø°Ø®ÛŒØ±Ù‡ Ù…Ù‚Ø¯Ø§Ø± ÙˆØ±ÙˆØ¯ÛŒ Ø§Ú¯Ø± Ø¯Ø± ØµÙØ­Ù‡ Ù¾Ø±ÙˆÙØ§ÛŒÙ„ Ù‡Ø³ØªÛŒÙ…
                    if (page === 'profile') {
                        setTimeout(() => {
                            const input = document.getElementById('profileNoteInput');
                            if (input) {
                                input.addEventListener('input', function(e) {
                                    navManager.updateState('profile', 'tempInput', e.target.value);
                                });
                            }
                        }, 100);
                    }
                    
                    // ÙÛŒÙ„ØªØ± Ø¯Ø±Ø³â€ŒÙ‡Ø§
                    if (page === 'lessons') {
                        setTimeout(() => {
                            const filterInput = document.getElementById('lessonFilterInput');
                            if (filterInput) {
                                filterInput.addEventListener('input', function(e) {
                                    navManager.updateState('lessons', 'filter', e.target.value);
                                });
                            }
                        }, 100);
                    }
                });
            });
            
            // Ø¯Ú©Ù…Ù‡ Ø´Ø¨ÛŒÙ‡â€ŒØ³Ø§Ø²ÛŒ Ø¨Ø§Ø²Ú¯Ø´Øª
            document.getElementById('simulateBackBtn').addEventListener('click', function() {
                navManager.back();
            });
            
            // Ø¯Ú©Ù…Ù‡ Ù†Ù…Ø§ÛŒØ´ state
            document.getElementById('showStateBtn').addEventListener('click', function() {
                const snapshot = navManager.getSnapshot();
                alert('âœ… state Ø¯Ø± localStorage Ø°Ø®ÛŒØ±Ù‡ Ø´Ø¯. Ø¨Ø±Ø§ÛŒ Ù…Ø´Ø§Ù‡Ø¯Ù‡ Ø¯Ù‚ÛŒÙ‚ Ú©Ù†Ø³ÙˆÙ„ Ù…Ø¬Ø§Ø²ÛŒ Ø±Ø§ Ø¨Ø¨ÛŒÙ†ÛŒØ¯.');
                navManager.log('ğŸ“‹ Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ù†Ù…Ø§ÛŒØ´ state Ú©Ø§Ù…Ù„');
                navManager.log(JSON.stringify(snapshot.state, null, 2));
            });
            
            // Ø±ÛŒØ³Øª ØªØ³Øª
            document.getElementById('resetTestBtn').addEventListener('click', function() {
                if (confirm('Ø¢ÛŒØ§ Ø§Ø² Ø±ÛŒØ³Øª Ú©Ø±Ø¯Ù† ØªÙ…Ø§Ù… state Ùˆ ØªØ§Ø±ÛŒØ®Ú†Ù‡ Ø§Ø·Ù…ÛŒÙ†Ø§Ù† Ø¯Ø§Ø±ÛŒØ¯ØŸ')) {
                    navManager.reset();
                    document.querySelectorAll('.test-checkbox').forEach(cb => cb.checked = false);
                    document.getElementById('manualStepBadge').innerHTML = 'Ú¯Ø§Ù… Û± Ø§Ø² Û·';
                }
            });
            
            // Ø´Ø¨ÛŒÙ‡â€ŒØ³Ø§Ø²ÛŒ Ú†Ø±Ø®Ø´ ØµÙØ­Ù‡
            window.addEventListener('orientationchange', function() {
                navManager.simulateRotation();
                navManager.log('ğŸ”„ orientationchange: state Ø­ÙØ¸ Ø´Ø¯');
            });
            
            // Ø¨Ø§Ø²Ø®ÙˆØ§Ù†ÛŒ ØµÙØ­Ù‡ - state Ø§Ø² localStorage Ù…ÛŒâ€ŒØ¢ÛŒØ¯
            window.addEventListener('beforeunload', function() {
                navManager.persist();
            });
            
            // Ø°Ø®ÛŒØ±Ù‡ state ÙˆØ±ÙˆØ¯ÛŒâ€ŒÙ‡Ø§
            document.addEventListener('input', function(e) {
                if (e.target.id === 'profileNoteInput') {
                    navManager.updateState('profile', 'tempInput', e.target.value);
                }
                if (e.target.id === 'lessonFilterInput') {
                    navManager.updateState('lessons', 'filter', e.target.value);
                }
            });
            
            // Ø¯Ú©Ù…Ù‡ Ù„Ø§Ú¯ Ø®Ø±ÙˆØ¬ÛŒ
            document.getElementById('exportLogBtn').addEventListener('click', function() {
                const logs = localStorage.getItem('nav_test_logs') || '[]';
                navManager.log('ğŸ“¤ Ø®Ø±ÙˆØ¬ÛŒ Ù„Ø§Ú¯ Ú¯Ø±ÙØªÙ‡ Ø´Ø¯');
                alert('Ù„Ø§Ú¯â€ŒÙ‡Ø§ Ø¯Ø± Ú©Ù†Ø³ÙˆÙ„ Ù…Ø¬Ø§Ø²ÛŒ Ùˆ localStorage Ø°Ø®ÛŒØ±Ù‡ Ø´Ø¯Ù†Ø¯');
            });
            
            // Ù¾Ø§Ú© Ú©Ø±Ø¯Ù† Ú©Ù†Ø³ÙˆÙ„ Ù…Ø¬Ø§Ø²ÛŒ
            document.getElementById('clearLogBtn').addEventListener('click', function() {
                document.getElementById('virtualConsole').innerHTML = '';
                localStorage.removeItem('nav_test_logs');
                navManager.log('ğŸ§¹ Ú©Ù†Ø³ÙˆÙ„ Ù…Ø¬Ø§Ø²ÛŒ Ù¾Ø§Ú© Ø´Ø¯');
            });
            
            // Ù…Ø§Ø±Ú© ØªÙ…Ø§Ù… Ú†Ú©â€ŒØ¨Ø§Ú©Ø³â€ŒÙ‡Ø§
            document.getElementById('markAllCompleteBtn').addEventListener('click', function() {
                document.querySelectorAll('.test-checkbox').forEach(cb => cb.checked = true);
                document.getElementById('manualStepBadge').innerHTML = 'âœ… ØªÙ…Ø§Ù… Ø³Ù†Ø§Ø±ÛŒÙˆÙ‡Ø§';
                navManager.log('ğŸ¯ ØªÙ…Ø§Ù… Û· Ø³Ù†Ø§Ø±ÛŒÙˆÛŒ ØªØ³Øª Ø¯Ø³ØªÛŒ ØªØ£ÛŒÛŒØ¯ Ø´Ø¯Ù†Ø¯');
            });
            
            // Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ú¯Ø§Ù… ØªØ³Øª Ø¨Ø± Ø§Ø³Ø§Ø³ Ú†Ú©â€ŒØ¨Ø§Ú©Ø³â€ŒÙ‡Ø§
            document.querySelectorAll('.test-checkbox').forEach(cb => {
                cb.addEventListener('change', function(e) {
                    const checkedCount = document.querySelectorAll('.test-checkbox:checked').length;
                    document.getElementById('manualStepBadge').innerHTML = `âœ… ${checkedCount} Ø§Ø² Û· ØªÚ©Ù…ÛŒÙ„`;
                    
                    if (this.checked) {
                        const testId = this.dataset.testid;
                        navManager.log(`ğŸ§ª ØªØ³Øª ${testId} Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ú¯Ø°Ø±Ø§Ù†Ø¯Ù‡ Ø´Ø¯`);
                    }
                });
            });
            
            // Ù…Ù‚Ø¯Ø§Ø±Ø¯Ù‡ÛŒ Ø§ÙˆÙ„ÛŒÙ‡
            navManager.log('ğŸš€ Ø³ÛŒØ³ØªÙ… ØªØ³Øª Ù†Ø§ÙˆØ¨Ø±ÛŒ Ø¢Ù…Ø§Ø¯Ù‡ Ø§Ø³Øª');
        };
    </script>
</body>
  </html>
