<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=yes">
    <title>ØªØ³Øª Ø¢ÙÙ„Ø§ÛŒÙ† - Farsinglish</title>
    <style>
        body {
            font-family: 'Tahoma', 'Arial', sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 15px;
            background: #f5f7fa;
            color: #2c3e50;
            line-height: 1.6;
        }
        .header {
            background: linear-gradient(135deg, #34495e, #2c3e50);
            color: white;
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 25px;
            text-align: center;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        .header h1 { margin: 0; font-size: 24px; }
        .header p { margin: 10px 0 0; opacity: 0.9; }
        
        .status-bar {
            display: flex;
            justify-content: space-between;
            background: white;
            padding: 15px;
            border-radius: 12px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }
        .status-item {
            text-align: center;
            flex: 1;
        }
        .status-label {
            font-size: 13px;
            color: #7f8c8d;
            display: block;
        }
        .status-value {
            font-size: 18px;
            font-weight: bold;
            color: #2c3e50;
        }
        
        .test-grid {
            display: grid;
            gap: 15px;
            margin-bottom: 25px;
        }
        .test-card {
            background: white;
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
            border: 1px solid #e0e7e9;
        }
        .test-header {
            display: flex;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid #f0f3f5;
        }
        .test-icon {
            font-size: 24px;
            margin-left: 12px;
        }
        .test-title {
            font-size: 18px;
            font-weight: bold;
            color: #2c3e50;
        }
        .test-desc {
            font-size: 14px;
            color: #7f8c8d;
            margin-bottom: 15px;
        }
        
        .btn {
            background: #3498db;
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 8px;
            font-size: 15px;
            font-weight: bold;
            cursor: pointer;
            width: 100%;
            margin-bottom: 10px;
            transition: all 0.2s;
        }
        .btn:hover { background: #2980b9; }
        .btn.offline { background: #95a5a6; }
        .btn.online { background: #27ae60; }
        .btn.warning { background: #e67e22; }
        .btn.danger { background: #e74c3c; }
        
        .console {
            background: #1e272b;
            color: #d1d8e0;
            padding: 15px;
            border-radius: 10px;
            font-family: 'Courier New', monospace;
            font-size: 13px;
            margin-top: 20px;
            max-height: 300px;
            overflow-y: auto;
            direction: ltr;
            text-align: left;
        }
        .console p { margin: 5px 0; }
        .success { color: #2ecc71; }
        .error { color: #e74c3c; }
        .warning { color: #f39c12; }
        .info { color: #3498db; }
        
        .progress-bar {
            width: 100%;
            height: 8px;
            background: #ecf0f1;
            border-radius: 4px;
            margin: 15px 0;
            overflow: hidden;
        }
        .progress-fill {
            height: 100%;
            background: #3498db;
            width: 0%;
            transition: width 0.3s;
        }
        
        @media (max-width: 600px) {
            .status-bar { flex-direction: column; gap: 10px; }
            .test-card { padding: 15px; }
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>ğŸ“¶ ØªØ³Øª Ø¢ÙÙ„Ø§ÛŒÙ† Ùˆ Ù‡Ù…Ú¯Ø§Ù…â€ŒØ³Ø§Ø²ÛŒ</h1>
        <p>Farsinglish - Offline Sync Test</p>
    </div>

    <!-- ÙˆØ¶Ø¹ÛŒØª ÙØ¹Ù„ÛŒ -->
    <div class="status-bar">
        <div class="status-item">
            <span class="status-label">ÙˆØ¶Ø¹ÛŒØª Ø§ÛŒÙ†ØªØ±Ù†Øª</span>
            <span id="onlineStatus" class="status-value" style="color: #27ae60;">Ø¢Ù†Ù„Ø§ÛŒÙ†</span>
        </div>
        <div class="status-item">
            <span class="status-label">ØµÙ Ù‡Ù…Ú¯Ø§Ù…â€ŒØ³Ø§Ø²ÛŒ</span>
            <span id="syncQueueCount" class="status-value">Û°</span>
        </div>
        <div class="status-item">
            <span class="status-label">Ø¯Ø±Ø³â€ŒÙ‡Ø§ÛŒ Ø°Ø®ÛŒØ±Ù‡</span>
            <span id="savedLessonsCount" class="status-value">Û°</span>
        </div>
    </div>

    <!-- Ø¯Ú©Ù…Ù‡â€ŒÙ‡Ø§ÛŒ Ú©Ù†ØªØ±Ù„ Ø§ÛŒÙ†ØªØ±Ù†Øª -->
    <div class="test-grid">
        <div class="test-card">
            <div class="test-header">
                <span class="test-icon">ğŸŒ</span>
                <span class="test-title">Ú©Ù†ØªØ±Ù„ Ø§ØªØµØ§Ù„</span>
            </div>
            <div class="test-desc">
                ÙˆØ¶Ø¹ÛŒØª Ø§ÛŒÙ†ØªØ±Ù†Øª Ø±Ø§ Ø¨Ù‡ ØµÙˆØ±Øª Ø¯Ø³ØªÛŒ ØªØºÛŒÛŒØ± Ø¯Ù‡ÛŒØ¯. Ø¹Ù…Ù„ÛŒØ§Øª Ø¢ÙÙ„Ø§Ø¨Øª Ø§Ø¨ØªØ¯Ø§ Ø¯Ø± IndexedDB Ø°Ø®ÛŒØ±Ù‡ Ùˆ Ù¾Ø³ Ø§Ø² Ø§ØªØµØ§Ù„ Ù‡Ù…Ú¯Ø§Ù… Ù…ÛŒâ€ŒØ´ÙˆÙ†Ø¯.
            </div>
            <button id="goOfflineBtn" class="btn offline">ğŸ“´ Ù‚Ø·Ø¹ Ø§ÛŒÙ†ØªØ±Ù†Øª (Ø¢ÙÙ„Ø§ÛŒÙ†)</button>
            <button id="goOnlineBtn" class="btn online">ğŸ“¶ ÙˆØµÙ„ Ø§ÛŒÙ†ØªØ±Ù†Øª (Ø¢Ù†Ù„Ø§ÛŒÙ†)</button>
        </div>

        <!-- ØªØ³Øª Û±: Ø°Ø®ÛŒØ±Ù‡ Ø¯Ø±Ø³ Ø¯Ø± Ø­Ø§Ù„Øª Ø¢ÙÙ„Ø§ÛŒÙ† -->
        <div class="test-card">
            <div class="test-header">
                <span class="test-icon">ğŸ’¾</span>
                <span class="test-title">ØªØ³Øª Û±: Ø°Ø®ÛŒØ±Ù‡ Ø¢ÙÙ„Ø§ÛŒÙ† Ø¯Ø±Ø³</span>
            </div>
            <div class="test-desc">
                Ø¯Ø±Ø³ Ø¬Ø¯ÛŒØ¯ Ø±Ø§ Ø¯Ø± Ø­Ø§Ù„Øª Ø¢ÙÙ„Ø§ÛŒÙ† Ø°Ø®ÛŒØ±Ù‡ Ú©Ù†ÛŒØ¯. Ø¯Ø±Ø³ Ø¯Ø± IndexedDB Ø°Ø®ÛŒØ±Ù‡ Ùˆ Ø¨Ù‡ ØµÙ Ù‡Ù…Ú¯Ø§Ù…â€ŒØ³Ø§Ø²ÛŒ Ø§Ø¶Ø§ÙÙ‡ Ù…ÛŒâ€ŒØ´ÙˆØ¯.
            </div>
            <button id="saveOfflineLessonBtn" class="btn">ğŸ“¥ Ø°Ø®ÛŒØ±Ù‡ Ø¯Ø±Ø³ Ø¢ÙÙ„Ø§ÛŒÙ†</button>
            <div id="offlineLessonResult" style="margin-top: 10px; padding: 10px; background: #f8f9fa; border-radius: 5px; display: none;"></div>
        </div>

        <!-- ØªØ³Øª Û²: Ø«Ø¨Øª Ù¾ÛŒØ´Ø±ÙØª Ø¢ÙÙ„Ø§ÛŒÙ† -->
        <div class="test-card">
            <div class="test-header">
                <span class="test-icon">ğŸ“Š</span>
                <span class="test-title">ØªØ³Øª Û²: Ø«Ø¨Øª Ù¾ÛŒØ´Ø±ÙØª Ø¢ÙÙ„Ø§ÛŒÙ†</span>
            </div>
            <div class="test-desc">
                Ù¾ÛŒØ´Ø±ÙØª Ø¯Ø±Ø³ Ø±Ø§ Ø¯Ø± Ø­Ø§Ù„Øª Ø¢ÙÙ„Ø§ÛŒÙ† Ø«Ø¨Øª Ú©Ù†ÛŒØ¯. Ø¹Ù…Ù„ÛŒØ§Øª Ø¯Ø± ØµÙ Ø§Ù†ØªØ¸Ø§Ø± Ù…ÛŒâ€ŒÙ…Ø§Ù†Ø¯ ØªØ§ Ø§ÛŒÙ†ØªØ±Ù†Øª ÙˆØµÙ„ Ø´ÙˆØ¯.
            </div>
            <button id="saveOfflineProgressBtn" class="btn">ğŸ“ˆ Ø«Ø¨Øª Ù¾ÛŒØ´Ø±ÙØª Ø¢ÙÙ„Ø§ÛŒÙ†</button>
            <div id="offlineProgressResult" style="margin-top: 10px; padding: 10px; background: #f8f9fa; border-radius: 5px; display: none;"></div>
        </div>

        <!-- ØªØ³Øª Û³: Ù‡Ù…Ú¯Ø§Ù…â€ŒØ³Ø§Ø²ÛŒ Ø¯Ø³ØªÛŒ -->
        <div class="test-card">
            <div class="test-header">
                <span class="test-icon">ğŸ”„</span>
                <span class="test-title">ØªØ³Øª Û³: Ù‡Ù…Ú¯Ø§Ù…â€ŒØ³Ø§Ø²ÛŒ Ø¯Ø³ØªÛŒ</span>
            </div>
            <div class="test-desc">
                Ø§Ø¬Ø±Ø§ÛŒ Ø¯Ø³ØªÛŒ Ù‡Ù…Ú¯Ø§Ù…â€ŒØ³Ø§Ø²ÛŒ. Ø¹Ù…Ù„ÛŒØ§Øªâ€ŒÙ‡Ø§ÛŒ Ù…ÙˆØ¬ÙˆØ¯ Ø¯Ø± ØµÙ Ø¨Ø§ Ø³Ø±ÙˆØ± (Mock) Ù‡Ù…Ú¯Ø§Ù… Ù…ÛŒâ€ŒØ´ÙˆÙ†Ø¯.
            </div>
            <button id="manualSyncBtn" class="btn warning">ğŸ”„ Ø§Ø¬Ø±Ø§ÛŒ Ù‡Ù…Ú¯Ø§Ù…â€ŒØ³Ø§Ø²ÛŒ</button>
            <div id="syncResult" style="margin-top: 10px; padding: 10px; background: #f8f9fa; border-radius: 5px; display: none;"></div>
        </div>

        <!-- ØªØ³Øª Û´: Ø¨Ø§Ø²ÛŒØ§Ø¨ÛŒ Ø®ÙˆØ¯Ú©Ø§Ø± Ù¾Ø³ Ø§Ø² Ø§ØªØµØ§Ù„ -->
        <div class="test-card">
            <div class="test-header">
                <span class="test-icon">âš¡</span>
                <span class="test-title">ØªØ³Øª Û´: Ø¨Ø§Ø²ÛŒØ§Ø¨ÛŒ Ø®ÙˆØ¯Ú©Ø§Ø±</span>
            </div>
            <div class="test-desc">
                Ø¨Ø§ ÙˆØµÙ„ Ú©Ø±Ø¯Ù† Ø§ÛŒÙ†ØªØ±Ù†ØªØŒ Ù‡Ù…Ú¯Ø§Ù…â€ŒØ³Ø§Ø²ÛŒ Ø®ÙˆØ¯Ú©Ø§Ø± Ø§Ø¬Ø±Ø§ Ù…ÛŒâ€ŒØ´ÙˆØ¯. Ø§ÛŒÙ† ØªØ³Øª Ø´Ø¨ÛŒÙ‡â€ŒØ³Ø§Ø²ÛŒ Ù‚Ø·Ø¹/ÙˆØµÙ„ Ø®ÙˆØ¯Ú©Ø§Ø± Ø§Ø³Øª.
            </div>
            <button id="testAutoRecoveryBtn" class="btn">ğŸ”„ Ø´Ø¨ÛŒÙ‡â€ŒØ³Ø§Ø²ÛŒ Ù‚Ø·Ø¹ Ùˆ ÙˆØµÙ„</button>
            <div id="autoRecoveryResult" style="margin-top: 10px; padding: 10px; background: #f8f9fa; border-radius: 5px; display: none;"></div>
        </div>

        <!-- ØªØ³Øª Ûµ: Ù¾Ø§Ú©Ø³Ø§Ø²ÛŒ ØµÙ -->
        <div class="test-card">
            <div class="test-header">
                <span class="test-icon">ğŸ§¹</span>
                <span class="test-title">ØªØ³Øª Ûµ: Ù¾Ø§Ú©Ø³Ø§Ø²ÛŒ ØµÙ</span>
            </div>
            <div class="test-desc">
                Ù¾Ø§Ú©Ø³Ø§Ø²ÛŒ Ú©Ø§Ù…Ù„ ØµÙ Ù‡Ù…Ú¯Ø§Ù…â€ŒØ³Ø§Ø²ÛŒ Ùˆ Ø¯ÛŒØªØ§Ø¨ÛŒØ³ Ù…Ø­Ù„ÛŒ.
            </div>
            <button id="clearSyncQueueBtn" class="btn danger">ğŸ—‘ï¸ Ù¾Ø§Ú©Ø³Ø§Ø²ÛŒ ØµÙ</button>
        </div>
    </div>

    <!-- Ù†ÙˆØ§Ø± Ù¾ÛŒØ´Ø±ÙØª Ù‡Ù…Ú¯Ø§Ù…â€ŒØ³Ø§Ø²ÛŒ -->
    <div style="margin: 20px 0;">
        <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
            <span>Ù¾ÛŒØ´Ø±ÙØª Ù‡Ù…Ú¯Ø§Ù…â€ŒØ³Ø§Ø²ÛŒ</span>
            <span id="syncProgressPercent">Û°Ùª</span>
        </div>
        <div class="progress-bar">
            <div id="syncProgressFill" class="progress-fill" style="width: 0%;"></div>
        </div>
    </div>

    <!-- Ú©Ù†Ø³ÙˆÙ„ Ù„Ø§Ú¯ -->
    <div class="console" id="console">
        <p class="info">â³ Ø³ÛŒØ³ØªÙ… ØªØ³Øª Ø¢ÙÙ„Ø§ÛŒÙ† Ø¢Ù…Ø§Ø¯Ù‡ Ø§Ø³Øª...</p>
        <p class="info">ğŸ“± ØªØ³Øª Ø¯Ø± Ù…Ø±ÙˆØ±Ú¯Ø± Ù…ÙˆØ¨Ø§ÛŒÙ„ - Ø¨Ø¯ÙˆÙ† Ù†ÛŒØ§Ø² Ø¨Ù‡ Ø³Ø±ÙˆØ± ÙˆØ§Ù‚Ø¹ÛŒ</p>
    </div>

    <script>
        // -------------------- Ø´Ø¨ÛŒÙ‡â€ŒØ³Ø§Ø² IndexedDB Ùˆ ØµÙ Ù‡Ù…Ú¯Ø§Ù…â€ŒØ³Ø§Ø²ÛŒ --------------------
        class OfflineSyncManager {
            constructor() {
                this.dbName = 'FarsinglishOfflineDB';
                this.dbVersion = 1;
                this.db = null;
                this.syncQueue = [];
                this.lessons = [];
                this.progress = [];
                this.isOnline = true;
                this.init();
            }

            async init() {
                try {
                    // Ø´Ø¨ÛŒÙ‡â€ŒØ³Ø§Ø²ÛŒ Ø¯ÛŒØªØ§Ø¨ÛŒØ³ Ø¯Ø± Ø­Ø§ÙØ¸Ù‡
                    this.loadFromStorage();
                    this.log('âœ… Ø¯ÛŒØªØ§Ø¨ÛŒØ³ Ø¢ÙÙ„Ø§ÛŒÙ† Ø±Ø§Ù‡â€ŒØ§Ù†Ø¯Ø§Ø²ÛŒ Ø´Ø¯', 'success');
                    this.updateUI();
                } catch (error) {
                    this.log(`âŒ Ø®Ø·Ø§ Ø¯Ø± Ø±Ø§Ù‡â€ŒØ§Ù†Ø¯Ø§Ø²ÛŒ Ø¯ÛŒØªØ§Ø¨ÛŒØ³: ${error.message}`, 'error');
                }
            }

            loadFromStorage() {
                // Ø¨Ø§Ø²ÛŒØ§Ø¨ÛŒ Ø¯Ø§Ø¯Ù‡ Ø§Ø² localStorage
                const savedQueue = localStorage.getItem('offlineSyncQueue');
                this.syncQueue = savedQueue ? JSON.parse(savedQueue) : [];
                
                const savedLessons = localStorage.getItem('offlineLessons');
                this.lessons = savedLessons ? JSON.parse(savedLessons) : [];
                
                const savedProgress = localStorage.getItem('offlineProgress');
                this.progress = savedProgress ? JSON.parse(savedProgress) : [];
            }

            saveToStorage() {
                localStorage.setItem('offlineSyncQueue', JSON.stringify(this.syncQueue));
                localStorage.setItem('offlineLessons', JSON.stringify(this.lessons));
                localStorage.setItem('offlineProgress', JSON.stringify(this.progress));
            }

            setOnlineStatus(status) {
                this.isOnline = status;
                this.log(status ? 'ğŸ“¶ ÙˆØ¶Ø¹ÛŒØª: Ø¢Ù†Ù„Ø§ÛŒÙ†' : 'ğŸ“´ ÙˆØ¶Ø¹ÛŒØª: Ø¢ÙÙ„Ø§ÛŒÙ†', status ? 'success' : 'warning');
                this.updateUI();
                
                if (status && this.syncQueue.length > 0) {
                    this.log('ğŸ”„ Ø§ÛŒÙ†ØªØ±Ù†Øª ÙˆØµÙ„ Ø´Ø¯ - Ø´Ø±ÙˆØ¹ Ù‡Ù…Ú¯Ø§Ù…â€ŒØ³Ø§Ø²ÛŒ Ø®ÙˆØ¯Ú©Ø§Ø±...', 'info');
                    this.syncWithServer();
                }
            }

            // Ø°Ø®ÛŒØ±Ù‡ Ø¯Ø±Ø³ Ø¢ÙÙ„Ø§ÛŒÙ†
            async saveLessonOffline(lesson) {
                const newLesson = {
                    id: lesson.id || Date.now(),
                    title: lesson.title,
                    content: lesson.content,
                    timestamp: new Date().toISOString(),
                    synced: false
                };

                this.lessons.push(newLesson);
                
                // Ø§Ø¶Ø§ÙÙ‡ Ø¨Ù‡ ØµÙ Ù‡Ù…Ú¯Ø§Ù…â€ŒØ³Ø§Ø²ÛŒ
                this.syncQueue.push({
                    id: Date.now(),
                    type: 'CREATE_LESSON',
                    data: newLesson,
                    timestamp: new Date().toISOString(),
                    retryCount: 0
                });

                this.saveToStorage();
                this.log(`ğŸ“¥ Ø¯Ø±Ø³ "${lesson.title}" Ø¯Ø± Ø­Ø§ÙØ¸Ù‡ Ø¢ÙÙ„Ø§ÛŒÙ† Ø°Ø®ÛŒØ±Ù‡ Ø´Ø¯`, 'success');
                this.updateUI();
                
                if (this.isOnline) {
                    this.syncWithServer();
                }
                
                return newLesson;
            }

            // Ø«Ø¨Øª Ù¾ÛŒØ´Ø±ÙØª Ø¢ÙÙ„Ø§ÛŒÙ†
            async saveProgressOffline(progress) {
                const newProgress = {
                    id: progress.id || Date.now(),
                    lessonId: progress.lessonId,
                    score: progress.score,
                    timestamp: new Date().toISOString(),
                    synced: false
                };

                this.progress.push(newProgress);
                
                this.syncQueue.push({
                    id: Date.now(),
                    type: 'UPDATE_PROGRESS',
                    data: newProgress,
                    timestamp: new Date().toISOString(),
                    retryCount: 0
                });

                this.saveToStorage();
                this.log(`ğŸ“ˆ Ù¾ÛŒØ´Ø±ÙØª Ø¯Ø±Ø³ ${progress.lessonId} Ø°Ø®ÛŒØ±Ù‡ Ø´Ø¯`, 'success');
                this.updateUI();
                
                if (this.isOnline) {
                    this.syncWithServer();
                }
                
                return newProgress;
            }

            // Ù‡Ù…Ú¯Ø§Ù…â€ŒØ³Ø§Ø²ÛŒ Ø¨Ø§ Ø³Ø±ÙˆØ± (Ø´Ø¨ÛŒÙ‡â€ŒØ³Ø§Ø²)
            async syncWithServer() {
                if (!this.isOnline) {
                    this.log('â›” Ø¯Ø± Ø­Ø§Ù„Øª Ø¢ÙÙ„Ø§ÛŒÙ† Ø§Ù…Ú©Ø§Ù† Ù‡Ù…Ú¯Ø§Ù…â€ŒØ³Ø§Ø²ÛŒ ÙˆØ¬ÙˆØ¯ Ù†Ø¯Ø§Ø±Ø¯', 'warning');
                    return;
                }

                if (this.syncQueue.length === 0) {
                    this.log('âœ… ØµÙ Ù‡Ù…Ú¯Ø§Ù…â€ŒØ³Ø§Ø²ÛŒ Ø®Ø§Ù„ÛŒ Ø§Ø³Øª', 'success');
                    return;
                }

                this.log(`ğŸ”„ Ø´Ø±ÙˆØ¹ Ù‡Ù…Ú¯Ø§Ù…â€ŒØ³Ø§Ø²ÛŒ ${this.syncQueue.length} Ø¹Ù…Ù„ÛŒØ§Øª...`, 'info');
                
                let successCount = 0;
                let failCount = 0;
                
                for (let i = 0; i < this.syncQueue.length; i++) {
                    const item = this.syncQueue[i];
                    this.updateProgress((i + 1) / this.syncQueue.length * 100);
                    
                    try {
                        // Ø´Ø¨ÛŒÙ‡â€ŒØ³Ø§Ø²ÛŒ Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ø¨Ù‡ Ø³Ø±ÙˆØ±
                        await this.mockServerRequest(item);
                        
                        // Ø¹Ù„Ø§Ù…Øªâ€ŒÚ¯Ø°Ø§Ø±ÛŒ Ø¨Ù‡ Ø¹Ù†ÙˆØ§Ù† Ù‡Ù…Ú¯Ø§Ù… Ø´Ø¯Ù‡
                        if (item.type === 'CREATE_LESSON') {
                            const lesson = this.lessons.find(l => l.id === item.data.id);
                            if (lesson) lesson.synced = true;
                        } else if (item.type === 'UPDATE_PROGRESS') {
                            const progress = this.progress.find(p => p.id === item.data.id);
                            if (progress) progress.synced = true;
                        }
                        
                        successCount++;
                        this.log(`âœ… ${item.type} Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ù‡Ù…Ú¯Ø§Ù… Ø´Ø¯`, 'success');
                    } catch (error) {
                        failCount++;
                        item.retryCount++;
                        this.log(`âŒ Ø®Ø·Ø§ Ø¯Ø± Ù‡Ù…Ú¯Ø§Ù…â€ŒØ³Ø§Ø²ÛŒ ${item.type}: ${error.message}`, 'error');
                    }
                    
                    // ØªØ£Ø®ÛŒØ± Ø´Ø¨ÛŒÙ‡â€ŒØ³Ø§Ø²ÛŒ
                    await new Promise(resolve => setTimeout(resolve, 300));
                }

                // Ø­Ø°Ù Ø¢ÛŒØªÙ…â€ŒÙ‡Ø§ÛŒ Ù…ÙˆÙÙ‚ Ø§Ø² ØµÙ
                this.syncQueue = this.syncQueue.filter(item => {
                    const isLessonSynced = item.type === 'CREATE_LESSON' && 
                        this.lessons.find(l => l.id === item.data.id)?.synced;
                    const isProgressSynced = item.type === 'UPDATE_PROGRESS' && 
                        this.progress.find(p => p.id === item.data.id)?.synced;
                    return !(isLessonSynced || isProgressSynced);
                });

                this.saveToStorage();
                this.updateUI();
                this.updateProgress(0);
                
                this.log(`ğŸ“Š Ù†ØªÛŒØ¬Ù‡ Ù‡Ù…Ú¯Ø§Ù…â€ŒØ³Ø§Ø²ÛŒ: ${successCount} Ù…ÙˆÙÙ‚, ${failCount} Ù†Ø§Ù…ÙˆÙÙ‚`, 
                    failCount === 0 ? 'success' : 'warning');
            }

            // Ø´Ø¨ÛŒÙ‡â€ŒØ³Ø§Ø² Ø³Ø±ÙˆØ±
            async mockServerRequest(item) {
                return new Promise((resolve, reject) => {
                    setTimeout(() => {
                        // 90% Ù…ÙˆÙÙ‚ÛŒØªØŒ 10% Ø®Ø·Ø§ÛŒ ØªØµØ§Ø¯ÙÛŒ
                        if (Math.random() < 0.9) {
                            resolve({ status: 200, data: item.data });
                        } else {
                            reject(new Error('Ø®Ø·Ø§ÛŒ Ø³Ø±ÙˆØ± (Ø´Ø¨ÛŒÙ‡â€ŒØ³Ø§Ø²ÛŒ)'));
                        }
                    }, 200);
                });
            }

            // Ø¯Ø±ÛŒØ§ÙØª Ø¢Ù…Ø§Ø±
            getStats() {
                return {
                    syncQueueLength: this.syncQueue.length,
                    savedLessons: this.lessons.length,
                    syncedLessons: this.lessons.filter(l => l.synced).length,
                    savedProgress: this.progress.length,
                    syncedProgress: this.progress.filter(p => p.synced).length
                };
            }

            // Ù¾Ø§Ú©Ø³Ø§Ø²ÛŒ ØµÙ
            clearQueue() {
                this.syncQueue = [];
                this.lessons = [];
                this.progress = [];
                this.saveToStorage();
                this.log('ğŸ§¹ ØµÙ Ù‡Ù…Ú¯Ø§Ù…â€ŒØ³Ø§Ø²ÛŒ Ùˆ Ø¯ÛŒØªØ§Ø¨ÛŒØ³ Ù¾Ø§Ú©Ø³Ø§Ø²ÛŒ Ø´Ø¯', 'warning');
                this.updateUI();
            }

            updateProgress(percent) {
                const fill = document.getElementById('syncProgressFill');
                const percentText = document.getElementById('syncProgressPercent');
                if (fill) fill.style.width = `${percent}%`;
                if (percentText) percentText.textContent = `${Math.round(percent)}Ùª`;
            }

            log(message, type = 'info') {
                const console = document.getElementById('console');
                if (console) {
                    const p = document.createElement('p');
                    p.className = type;
                    p.textContent = `[${new Date().toLocaleTimeString('fa-IR')}] ${message}`;
                    console.appendChild(p);
                    console.scrollTop = console.scrollHeight;
                }
                console.log(message);
            }

            updateUI() {
                const stats = this.getStats();
                
                const onlineEl = document.getElementById('onlineStatus');
                if (onlineEl) {
                    onlineEl.textContent = this.isOnline ? 'Ø¢Ù†Ù„Ø§ÛŒÙ†' : 'Ø¢ÙÙ„Ø§ÛŒÙ†';
                    onlineEl.style.color = this.isOnline ? '#27ae60' : '#e74c3c';
                }
                
                const queueEl = document.getElementById('syncQueueCount');
                if (queueEl) queueEl.textContent = stats.syncQueueLength;
                
                const lessonsEl = document.getElementById('savedLessonsCount');
                if (lessonsEl) lessonsEl.textContent = stats.savedLessons;
            }
        }

        // -------------------- Ù†Ù…ÙˆÙ†Ù‡â€ŒØ³Ø§Ø²ÛŒ Ùˆ Ø§ØªØµØ§Ù„ Ø¨Ù‡ UI --------------------
        const offlineManager = new OfflineSyncManager();

        // Ø¯Ú©Ù…Ù‡ Ù‚Ø·Ø¹ Ø§ÛŒÙ†ØªØ±Ù†Øª
        document.getElementById('goOfflineBtn').addEventListener('click', () => {
            offlineManager.setOnlineStatus(false);
        });

        // Ø¯Ú©Ù…Ù‡ ÙˆØµÙ„ Ø§ÛŒÙ†ØªØ±Ù†Øª
        document.getElementById('goOnlineBtn').addEventListener('click', () => {
            offlineManager.setOnlineStatus(true);
        });

        // Ø¯Ú©Ù…Ù‡ Ø°Ø®ÛŒØ±Ù‡ Ø¯Ø±Ø³ Ø¢ÙÙ„Ø§ÛŒÙ†
        document.getElementById('saveOfflineLessonBtn').addEventListener('click', async () => {
            const lesson = {
                id: Date.now(),
                title: `Ø¯Ø±Ø³ Ø¢Ø²Ù…Ø§ÛŒØ´ÛŒ ${offlineManager.lessons.length + 1}`,
                content: 'Ø§ÛŒÙ† ÛŒÚ© Ø¯Ø±Ø³ Ø¢Ø²Ù…Ø§ÛŒØ´ÛŒ Ø¨Ø±Ø§ÛŒ ØªØ³Øª Ø¢ÙÙ„Ø§ÛŒÙ† Ø§Ø³Øª.'
            };
            
            await offlineManager.saveLessonOffline(lesson);
            
            const resultDiv = document.getElementById('offlineLessonResult');
            resultDiv.style.display = 'block';
            resultDiv.innerHTML = `âœ… Ø¯Ø±Ø³ "${lesson.title}" Ø°Ø®ÛŒØ±Ù‡ Ø´Ø¯<br>ğŸ“¤ ÙˆØ¶Ø¹ÛŒØª Ù‡Ù…Ú¯Ø§Ù…â€ŒØ³Ø§Ø²ÛŒ: ${offlineManager.isOnline ? 'Ø¯Ø± ØµÙ Ø§Ù†ØªØ¸Ø§Ø±' : 'Ø¢ÙÙ„Ø§ÛŒÙ†'}`;
        });

        // Ø¯Ú©Ù…Ù‡ Ø«Ø¨Øª Ù¾ÛŒØ´Ø±ÙØª Ø¢ÙÙ„Ø§ÛŒÙ†
        document.getElementById('saveOfflineProgressBtn').addEventListener('click', async () => {
            const progress = {
                id: Date.now(),
                lessonId: offlineManager.lessons.length > 0 ? offlineManager.lessons[0].id : 1001,
                score: Math.floor(Math.random() * 100)
            };
            
            await offlineManager.saveProgressOffline(progress);
            
            const resultDiv = document.getElementById('offlineProgressResult');
            resultDiv.style.display = 'block';
            resultDiv.innerHTML = `ğŸ“Š Ù¾ÛŒØ´Ø±ÙØª: Ø§Ù…ØªÛŒØ§Ø² ${progress.score} Ø¨Ø±Ø§ÛŒ Ø¯Ø±Ø³ ${progress.lessonId}<br>ğŸ“¤ ÙˆØ¶Ø¹ÛŒØª: ${offlineManager.isOnline ? 'Ø¯Ø± ØµÙ Ø§Ù†ØªØ¸Ø§Ø±' : 'Ø¢ÙÙ„Ø§ÛŒÙ†'}`;
        });

        // Ø¯Ú©Ù…Ù‡ Ù‡Ù…Ú¯Ø§Ù…â€ŒØ³Ø§Ø²ÛŒ Ø¯Ø³ØªÛŒ
        document.getElementById('manualSyncBtn').addEventListener('click', async () => {
            if (!offlineManager.isOnline) {
                offlineManager.log('â›” Ù„Ø·ÙØ§Ù‹ Ø§Ø¨ØªØ¯Ø§ Ø§ÛŒÙ†ØªØ±Ù†Øª Ø±Ø§ ÙˆØµÙ„ Ú©Ù†ÛŒØ¯', 'warning');
                return;
            }
            await offlineManager.syncWithServer();
            
            const resultDiv = document.getElementById('syncResult');
            resultDiv.style.display = 'block';
            resultDiv.innerHTML = `ğŸ”„ Ù‡Ù…Ú¯Ø§Ù…â€ŒØ³Ø§Ø²ÛŒ Ø§Ù†Ø¬Ø§Ù… Ø´Ø¯. ${offlineManager.syncQueue.length} Ø¹Ù…Ù„ÛŒØ§Øª Ø¯Ø± ØµÙ Ø¨Ø§Ù‚ÛŒâ€ŒÙ…Ø§Ù†Ø¯Ù‡.`;
        });

        // Ø¯Ú©Ù…Ù‡ ØªØ³Øª Ø¨Ø§Ø²ÛŒØ§Ø¨ÛŒ Ø®ÙˆØ¯Ú©Ø§Ø±
        document.getElementById('testAutoRecoveryBtn').addEventListener('click', async () => {
            offlineManager.log('ğŸ”„ Ø´Ø¨ÛŒÙ‡â€ŒØ³Ø§Ø²ÛŒ Ù‚Ø·Ø¹ Ùˆ ÙˆØµÙ„ Ø§ÛŒÙ†ØªØ±Ù†Øª...', 'info');
            
            // Ù‚Ø·Ø¹ Ø§ÛŒÙ†ØªØ±Ù†Øª
            offlineManager.setOnlineStatus(false);
            
            // Ø°Ø®ÛŒØ±Ù‡ ÛŒÚ© Ø¯Ø±Ø³ Ø¢ÙÙ„Ø§ÛŒÙ†
            await offlineManager.saveLessonOffline({
                id: Date.now(),
                title: 'Ø¯Ø±Ø³ Ø¨Ø§Ø²ÛŒØ§Ø¨ÛŒ Ø®ÙˆØ¯Ú©Ø§Ø±',
                content: 'Ø§ÛŒÙ† Ø¯Ø±Ø³ Ø¨Ø±Ø§ÛŒ ØªØ³Øª Ø¨Ø§Ø²ÛŒØ§Ø¨ÛŒ Ø®ÙˆØ¯Ú©Ø§Ø± Ø°Ø®ÛŒØ±Ù‡ Ø´Ø¯Ù‡ Ø§Ø³Øª.'
            });
            
            // ØµØ¨Ø± Ú©ÙˆØªØ§Ù‡
            await new Promise(resolve => setTimeout(resolve, 1000));
            
            // ÙˆØµÙ„ Ø§ÛŒÙ†ØªØ±Ù†Øª
            offlineManager.setOnlineStatus(true);
            
            const resultDiv = document.getElementById('autoRecoveryResult');
            resultDiv.style.display = 'block';
            resultDiv.innerHTML = 'âœ… Ù‚Ø·Ø¹ Ùˆ ÙˆØµÙ„ Ø´Ø¨ÛŒÙ‡â€ŒØ³Ø§Ø²ÛŒ Ø´Ø¯. Ù‡Ù…Ú¯Ø§Ù…â€ŒØ³Ø§Ø²ÛŒ Ø®ÙˆØ¯Ú©Ø§Ø± Ø§Ø¬Ø±Ø§ Ù…ÛŒâ€ŒØ´ÙˆØ¯.';
        });

        // Ø¯Ú©Ù…Ù‡ Ù¾Ø§Ú©Ø³Ø§Ø²ÛŒ ØµÙ
        document.getElementById('clearSyncQueueBtn').addEventListener('click', () => {
            offlineManager.clearQueue();
        });

        // Ø§ÙØ²ÙˆØ¯Ù† Ù„Ø§Ú¯ Ø§ÙˆÙ„ÛŒÙ‡
        offlineManager.log('ğŸ“± ØªØ³Øª Ø¢ÙÙ„Ø§ÛŒÙ† - Ø¢Ù…Ø§Ø¯Ù‡ Ø§Ø¬Ø±Ø§ÛŒ Ø³Ù†Ø§Ø±ÛŒÙˆÙ‡Ø§', 'info');
        offlineManager.log('ğŸ”§ Ù…Ø±Ø§Ø­Ù„ Ù¾ÛŒØ´Ù†Ù‡Ø§Ø¯ÛŒ:', 'info');
        offlineManager.log('  1. Ù‚Ø·Ø¹ Ø§ÛŒÙ†ØªØ±Ù†Øª Ùˆ Ø°Ø®ÛŒØ±Ù‡ Ø¯Ø±Ø³ Ø¢ÙÙ„Ø§ÛŒÙ†', 'info');
        offlineManager.log('  2. Ø«Ø¨Øª Ù¾ÛŒØ´Ø±ÙØª Ø¢ÙÙ„Ø§ÛŒÙ†', 'info');
        offlineManager.log('  3. ÙˆØµÙ„ Ø§ÛŒÙ†ØªØ±Ù†Øª Ùˆ Ù…Ø´Ø§Ù‡Ø¯Ù‡ Ù‡Ù…Ú¯Ø§Ù…â€ŒØ³Ø§Ø²ÛŒ Ø®ÙˆØ¯Ú©Ø§Ø±', 'info');
    </script>
</body>
</html>
