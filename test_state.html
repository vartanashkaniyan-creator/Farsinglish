<!DOCTYPE html>
<html dir="rtl" lang="fa">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>âœ… ØªØ³Øª State Manager - Farsinglish</title>
    <style>
        * { font-family: 'Segoe UI', Tahoma, sans-serif; }
        body { background: #0f172a; color: #e2e8f0; padding: 20px; max-width: 800px; margin: auto; }
        h1 { color: #38bdf8; border-right: 5px solid #38bdf8; padding-right: 15px; }
        .test { background: #1e293b; margin: 15px 0; padding: 15px; border-radius: 10px; border-right: 4px solid #475569; }
        .pass { border-right-color: #10b981 !important; }
        .fail { border-right-color: #ef4444 !important; }
        button { background: #3b82f6; color: white; border: none; padding: 10px 20px; border-radius: 8px; cursor: pointer; margin: 10px 0; }
        button:hover { background: #2563eb; }
        .console { background: #111827; padding: 15px; border-radius: 8px; margin-top: 20px; font-family: monospace; white-space: pre-wrap; }
    </style>
</head>
<body>
    <h1>ğŸ§ª ØªØ³Øª State Manager (Û¸ ØªØ³Øª Ø§ØµÙ„ÛŒ)</h1>
    <p>Ù¾Ø±ÙˆÚ˜Ù‡: Farsinglish - ØªØ§Ø±ÛŒØ®: Û±Û´Û°Û³/Û°Û²/Û²Û²</p>
    
    <div id="tests"></div>
    
    <button onclick="runAllTests()">â–¶ Ø§Ø¬Ø±Ø§ÛŒ Ù‡Ù…Ù‡ ØªØ³Øªâ€ŒÙ‡Ø§</button>
    <button onclick="clearResults()">ğŸ§¹ Ù¾Ø§Ú© Ú©Ø±Ø¯Ù† Ù†ØªØ§ÛŒØ¬</button>
    
    <div class="console" id="console">â³ Ù…Ù†ØªØ¸Ø± Ø§Ø¬Ø±Ø§ÛŒ ØªØ³Øª...</div>

<script>
// ==================== State Manager Core ====================
class StateManager {
    constructor(initialState = {}) {
        this.state = { ...initialState };
        this.middlewares = [];
        this.subscribers = new Set();
    }

    setState(newState) {
        const prevState = { ...this.state };
        this.state = { ...this.state, ...newState };
        this._runMiddlewares(prevState, this.state);
        this._notifySubscribers(prevState, this.state);
    }

    getState() {
        return { ...this.state };
    }

    subscribe(callback) {
        this.subscribers.add(callback);
        return () => this.subscribers.delete(callback);
    }

    addMiddleware(middleware) {
        this.middlewares.push(middleware);
    }

    _runMiddlewares(prevState, nextState) {
        this.middlewares.forEach(mw => mw(prevState, nextState));
    }

    _notifySubscribers(prevState, nextState) {
        this.subscribers.forEach(callback => callback(prevState, nextState));
    }

    saveToStorage(key = 'farsi_state') {
        localStorage.setItem(key, JSON.stringify(this.state));
    }

    loadFromStorage(key = 'farsi_state') {
        const saved = localStorage.getItem(key);
        if (saved) this.state = JSON.parse(saved);
        return this.state;
    }
}

// ==================== Test Runner ====================
const tests = [];
const consoleOutput = [];

function test(name, fn) {
    tests.push({ name, fn });
}

function log(message) {
    consoleOutput.push(message);
    document.getElementById('console').textContent = consoleOutput.join('\n');
}

// ==================== Û¸ ØªØ³Øª Ø§ØµÙ„ÛŒ ====================
test('Ù…Ù‚Ø¯Ø§Ø±Ø¯Ù‡ÛŒ Ø§ÙˆÙ„ÛŒÙ‡ State', () => {
    const sm = new StateManager({ user: null, lessons: [] });
    const state = sm.getState();
    return state.user === null && Array.isArray(state.lessons);
});

test('Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ State Ø¨Ø§ setState', () => {
    const sm = new StateManager({ count: 0 });
    sm.setState({ count: 5 });
    return sm.getState().count === 5;
});

test('Immutability - Ø¹Ø¯Ù… ØªØºÛŒÛŒØ± State Ø§ØµÙ„ÛŒ', () => {
    const sm = new StateManager({ items: ['a'] });
    const state1 = sm.getState();
    state1.items.push('b');
    const state2 = sm.getState();
    return state2.items.length === 1;
});

test('Subscribe/Notify Ú©Ø§Ø± Ù…ÛŒâ€ŒÚ©Ù†Ø¯', () => {
    let notified = false;
    const sm = new StateManager({ value: 0 });
    sm.subscribe(() => { notified = true; });
    sm.setState({ value: 1 });
    return notified === true;
});

test('Middleware Ø§Ø¬Ø±Ø§ Ù…ÛŒâ€ŒØ´ÙˆØ¯', () => {
    let middlewareCalled = false;
    const sm = new StateManager({});
    sm.addMiddleware(() => { middlewareCalled = true; });
    sm.setState({ test: true });
    return middlewareCalled === true;
});

test('Middleware Ø¨Ù‡ State Ù‚Ø¯ÛŒÙ… Ùˆ Ø¬Ø¯ÛŒØ¯ Ø¯Ø³ØªØ±Ø³ÛŒ Ø¯Ø§Ø±Ø¯', () => {
    let oldValue, newValue;
    const sm = new StateManager({ score: 10 });
    sm.addMiddleware((prev, next) => {
        oldValue = prev.score;
        newValue = next.score;
    });
    sm.setState({ score: 20 });
    return oldValue === 10 && newValue === 20;
});

test('Ø°Ø®ÛŒØ±Ù‡â€ŒØ³Ø§Ø²ÛŒ Ø¯Ø± localStorage', () => {
    const sm = new StateManager({ data: 'test' });
    sm.saveToStorage('test_key');
    const saved = localStorage.getItem('test_key');
    return saved && JSON.parse(saved).data === 'test';
});

test('Ø¨Ø§Ø²ÛŒØ§Ø¨ÛŒ Ø§Ø² localStorage', () => {
    localStorage.setItem('restore_key', JSON.stringify({ restored: true }));
    const sm = new StateManager();
    sm.loadFromStorage('restore_key');
    return sm.getState().restored === true;
});

// ==================== Ø§Ø¬Ø±Ø§ÛŒ ØªØ³Øªâ€ŒÙ‡Ø§ ====================
function runAllTests() {
    consoleOutput.length = 0;
    const testContainer = document.getElementById('tests');
    testContainer.innerHTML = '';
    let passed = 0;

    tests.forEach((t, i) => {
        const div = document.createElement('div');
        div.className = 'test';
        
        try {
            const result = t.fn();
            if (result) {
                div.classList.add('pass');
                div.innerHTML = `âœ… ØªØ³Øª ${i+1}: ${t.name}`;
                passed++;
                log(`âœ… ØªØ³Øª "${t.name}" Ù…ÙˆÙÙ‚`);
            } else {
                div.classList.add('fail');
                div.innerHTML = `âŒ ØªØ³Øª ${i+1}: ${t.name}`;
                log(`âŒ ØªØ³Øª "${t.name}" Ø´Ú©Ø³Øª`);
            }
        } catch (error) {
            div.classList.add('fail');
            div.innerHTML = `ğŸ’¥ ØªØ³Øª ${i+1}: ${t.name} (Ø®Ø·Ø§: ${error.message})`;
            log(`ğŸ’¥ ØªØ³Øª "${t.name}" Ø®Ø·Ø§: ${error.message}`);
        }
        
        testContainer.appendChild(div);
    });

    const summary = document.createElement('div');
    summary.className = 'test';
    summary.style.borderRightColor = passed === tests.length ? '#10b981' : '#ef4444';
    summary.innerHTML = `<h3>ğŸ“Š Ù†ØªÛŒØ¬Ù‡ Ù†Ù‡Ø§ÛŒÛŒ: ${passed} Ø§Ø² ${tests.length} ØªØ³Øª Ù…ÙˆÙÙ‚</h3>`;
    testContainer.appendChild(summary);

    log(`\nğŸ¯ ØªØ³Øªâ€ŒÙ‡Ø§ ØªÙ…Ø§Ù… Ø´Ø¯. ${passed}/${tests.length} Ù…ÙˆÙÙ‚.`);
}

function clearResults() {
    document.getElementById('tests').innerHTML = '';
    document.getElementById('console').textContent = 'ğŸ§¹ Ù†ØªØ§ÛŒØ¬ Ù¾Ø§Ú© Ø´Ø¯.';
    consoleOutput.length = 0;
}
</script>
</body>
</html>
