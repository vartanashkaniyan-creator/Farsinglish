<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.5, user-scalable=yes">
    <title>ØªØ³Øª Ø¯Ø³ØªÛŒ Ù…Ù‡Ø§Ø¬Ø±Øª Ø¯ÛŒØªØ§Ø¨ÛŒØ³ - Ù†Ø³Ø®Ù‡ Ø§ØµÙ„Ø§Ø­â€ŒØ´Ø¯Ù‡ - Farsinglish</title>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body {
            font-family: 'Tahoma', 'Arial', sans-serif;
            background: #1e272e;
            color: #d2dae2;
            padding: 16px;
            line-height: 1.6;
            direction: rtl;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
            background: #2c3a47;
            border-radius: 24px;
            padding: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
            border: 1px solid #3b4b5a;
        }
        h1 {
            color: #ffdd59;
            font-size: 1.8rem;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 10px;
            border-bottom: 2px solid #ffdd59;
            padding-bottom: 12px;
        }
        h2 {
            font-size: 1.3rem;
            color: #ffb142;
            margin: 20px 0 10px;
        }
        .card {
            background: #3b4b5a;
            border-radius: 16px;
            padding: 18px;
            margin-bottom: 20px;
            border-right: 6px solid #34ace0;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }
        .btn {
            background: #34ace0;
            border: none;
            color: white;
            padding: 14px 24px;
            border-radius: 50px;
            font-size: 1.1rem;
            font-weight: bold;
            cursor: pointer;
            width: 100%;
            margin-bottom: 12px;
            transition: 0.2s;
            border-bottom: 4px solid #227093;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }
        .btn:hover {
            background: #3dc4f0;
            transform: translateY(-2px);
        }
        .btn-warning {
            background: #ffb142;
            border-bottom-color: #cc8e34;
        }
        .btn-danger {
            background: #ff5252;
            border-bottom-color: #b33939;
        }
        .btn-success {
            background: #33d9b2;
            border-bottom-color: #218c74;
        }
        .log {
            background: #1e272e;
            border-radius: 12px;
            padding: 16px;
            font-family: 'Courier New', monospace;
            font-size: 0.9rem;
            direction: ltr;
            text-align: left;
            color: #0be881;
            max-height: 300px;
            overflow-y: auto;
            margin-top: 16px;
            border: 1px solid #34ace0;
        }
        .badge {
            background: #ffdd59;
            color: #1e272e;
            padding: 6px 14px;
            border-radius: 50px;
            font-size: 0.9rem;
            font-weight: bold;
            display: inline-block;
            margin-left: 10px;
        }
        .badge-fixed {
            background: #33d9b2;
            color: #1e272e;
            padding: 6px 14px;
            border-radius: 50px;
            font-size: 0.9rem;
            font-weight: bold;
            display: inline-block;
            margin-left: 10px;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            background: #2c3a47;
            border-radius: 12px;
            margin: 16px 0;
        }
        td, th {
            padding: 12px;
            border-bottom: 1px solid #4a5b68;
            text-align: center;
        }
        th {
            background: #34ace0;
            color: white;
        }
        .success { color: #33d9b2; font-weight: bold; }
        .danger { color: #ff5252; font-weight: bold; }
        .warning { color: #ffb142; font-weight: bold; }
        .flex-row {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
        }
        .flex-row .btn {
            flex: 1;
        }
        .fixed-note {
            background: #33d9b2;
            color: #1e272e;
            padding: 10px;
            border-radius: 8px;
            margin-bottom: 16px;
            font-weight: bold;
            text-align: center;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>
            <span>ğŸ—‚ï¸ ØªØ³Øª Ø¯Ø³ØªÛŒ Ù…Ù‡Ø§Ø¬Ø±Øª Ø¯ÛŒØªØ§Ø¨ÛŒØ³</span>
            <span class="badge-fixed">âœ… Ù†Ø³Ø®Ù‡ Ø§ØµÙ„Ø§Ø­â€ŒØ´Ø¯Ù‡ - Ø±ÙØ¹ Ø®Ø·Ø§ÛŒ Ù†Ø³Ø®Ù‡</span>
        </h1>
        <div class="fixed-note">
            ğŸ› ï¸ Ø±ÙØ¹ Ø®Ø·Ø§: ØªÙ…Ø§Ù… ØªÙˆØ§Ø¨Ø¹ Ø§Ø² Ø¢Ø®Ø±ÛŒÙ† Ù†Ø³Ø®Ù‡ Ø¯ÛŒØªØ§Ø¨ÛŒØ³ Ø§Ø³ØªÙØ§Ø¯Ù‡ Ù…ÛŒâ€ŒÚ©Ù†Ù†Ø¯ Â· Ø¨Ø¯ÙˆÙ† Ø®Ø·Ø§ÛŒ "version is less"
        </div>
        <p style="margin-bottom: 20px; color: #a4b0be;">
            âœ… ØªØ³Øª Ø§Ø±ØªÙ‚Ø§ÛŒ Ù†Ø³Ø®Ù‡ IndexedDB Ø§Ø² v1 Ø¨Ù‡ v2 Â· Ø§ÙØ²ÙˆØ¯Ù† Ø¬Ø¯ÙˆÙ„ Â· ØªØºÛŒÛŒØ± Ø§ÛŒÙ†Ø¯Ú©Ø³ Â· Ø­ÙØ¸ Ø¯Ø§Ø¯Ù‡
        </p>

        <!-- Ú©Ø§Ø±Øª ÙˆØ¶Ø¹ÛŒØª ÙØ¹Ù„ÛŒ -->
        <div class="card">
            <h2>ğŸ“Œ ÙˆØ¶Ø¹ÛŒØª Ø¯ÛŒØªØ§Ø¨ÛŒØ³</h2>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 16px;">
                <div style="background: #2c3a47; padding: 16px; border-radius: 12px; text-align: center;">
                    <div style="font-size: 2rem;">ğŸ“€</div>
                    <div style="font-size: 0.9rem; color: #a4b0be;">Ù†Ø³Ø®Ù‡ ÙØ¹Ù„ÛŒ</div>
                    <div id="dbVersionDisplay" style="font-size: 1.8rem; font-weight: bold; color: #ffdd59;">-</div>
                </div>
                <div style="background: #2c3a47; padding: 16px; border-radius: 12px; text-align: center;">
                    <div style="font-size: 2rem;">ğŸ§®</div>
                    <div style="font-size: 0.9rem; color: #a4b0be;">ØªØ¹Ø¯Ø§Ø¯ Ú©Ø§Ø±Ø¨Ø±Ø§Ù†</div>
                    <div id="userCountDisplay" style="font-size: 1.8rem; font-weight: bold; color: #33d9b2;">0</div>
                </div>
            </div>
        </div>

        <!-- Ú©Ø§Ø±Øª Ù…Ø±Ø­Ù„Ù‡ Û±: Ù†ØµØ¨ Ù†Ø³Ø®Ù‡ Û± -->
        <div class="card">
            <h2>ğŸ”° Ù…Ø±Ø­Ù„Ù‡ Û±: Ø§ÛŒØ¬Ø§Ø¯ Ø¯ÛŒØªØ§Ø¨ÛŒØ³ v1</h2>
            <p style="color: #a4b0be; margin-bottom: 16px;">Ø¬Ø¯ÙˆÙ„: users (id, name, email, level) Â· Ø§ÛŒÙ†Ø¯Ú©Ø³: email</p>
            <div class="flex-row">
                <button id="installV1Btn" class="btn">ğŸ“¥ Ù†ØµØ¨/Ø¨Ø§Ø²Ù†Ø´Ø§Ù†ÛŒ v1</button>
                <button id="addSampleUserBtn" class="btn btn-success">â• Ø§ÙØ²ÙˆØ¯Ù† Ú©Ø§Ø±Ø¨Ø± Ù†Ù…ÙˆÙ†Ù‡</button>
            </div>
            <button id="showUsersBtn" class="btn btn-warning" style="margin-top: 8px;">ğŸ‘¥ Ù†Ù…Ø§ÛŒØ´ Ú©Ø§Ø±Ø¨Ø±Ø§Ù†</button>
        </div>

        <!-- Ú©Ø§Ø±Øª Ù…Ø±Ø­Ù„Ù‡ Û²: Ù…Ù‡Ø§Ø¬Ø±Øª Ø¨Ù‡ Ù†Ø³Ø®Ù‡ Û² -->
        <div class="card">
            <h2>â¬†ï¸ Ù…Ø±Ø­Ù„Ù‡ Û²: Ù…Ù‡Ø§Ø¬Ø±Øª Ø¨Ù‡ v2</h2>
            <p style="color: #a4b0be; margin-bottom: 16px;">
                âœ… ØªØºÛŒÛŒØ±Ø§Øª: Ø§Ø¶Ø§ÙÙ‡ Ø´Ø¯Ù† Ø¬Ø¯ÙˆÙ„ lessons Â· Ø§ÛŒÙ†Ø¯Ú©Ø³ Ø¬Ø¯ÛŒØ¯ Ø±ÙˆÛŒ level Â· Ø§Ø¶Ø§ÙÙ‡ Ø´Ø¯Ù† ÙÛŒÙ„Ø¯ createdAt Ø¨Ù‡ users
            </p>
            <button id="migrateToV2Btn" class="btn btn-danger">ğŸ”„ Ø§Ø¬Ø±Ø§ÛŒ Ù…Ù‡Ø§Ø¬Ø±Øª Ø¨Ù‡ v2</button>
        </div>

        <!-- Ú©Ø§Ø±Øª Ù…Ø±Ø­Ù„Ù‡ Û³: Ø§Ø¹ØªØ¨Ø§Ø±Ø³Ù†Ø¬ÛŒ -->
        <div class="card">
            <h2>ğŸ§ª Ù…Ø±Ø­Ù„Ù‡ Û³: ØªØ³Øªâ€ŒÙ‡Ø§ÛŒ Ù…Ù‡Ø§Ø¬Ø±Øª</h2>
            <div class="flex-row">
                <button id="testUsersSchemaBtn" class="btn">ğŸ§¾ Ø¨Ø±Ø±Ø³ÛŒ Ø§Ø³Ú©ÛŒÙ…Ø§ users</button>
                <button id="testLessonsTableBtn" class="btn">ğŸ“š Ø¨Ø±Ø±Ø³ÛŒ Ø¬Ø¯ÙˆÙ„ lessons</button>
            </div>
            <button id="fullMigrationTestBtn" class="btn btn-success" style="margin-top: 12px;">âœ… Ø§Ø¬Ø±Ø§ÛŒ Ú©Ø§Ù…Ù„ ØªØ³Øª Ù…Ù‡Ø§Ø¬Ø±Øª</button>
        </div>

        <!-- Ù†Ù…Ø§ÛŒØ´ Ù„Ø§Ú¯ -->
        <div style="margin-top: 24px;">
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <h2>ğŸ“‹ Ú¯Ø²Ø§Ø±Ø´ Ø¹Ù…Ù„ÛŒØ§Øª</h2>
                <button id="clearLogBtn" style="background: none; border: 1px solid #ff5252; color: #ff5252; padding: 8px 16px; border-radius: 50px;">Ù¾Ø§Ú© Ú©Ø±Ø¯Ù†</button>
            </div>
            <div id="logContainer" class="log">
                â³ Ø¢Ù…Ø§Ø¯Ù‡â€ŒØ³Ø§Ø²ÛŒ... Ø¨Ø±Ø§ÛŒ Ø´Ø±ÙˆØ¹ ÛŒÚ©ÛŒ Ø§Ø² Ø¹Ù…Ù„ÛŒØ§Øªâ€ŒÙ‡Ø§ Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯.
            </div>
        </div>

        <div style="margin-top: 24px; text-align: center; color: #a4b0be; font-size: 0.8rem;">
            <p>ğŸ§ª Farsinglish Â· ØªØ³Øª Ø¯Ø³ØªÛŒ Ù…Ù‡Ø§Ø¬Ø±Øª Ø¯ÛŒØªØ§Ø¨ÛŒØ³ Â· Ù†Ø³Ø®Ù‡ Ø§ØµÙ„Ø§Ø­â€ŒØ´Ø¯Ù‡ Â· ØªØ§Ø±ÛŒØ®: 2026-02-13</p>
        </div>
    </div>

    <script>
        // -------------------- Ú©Ø§Ù†ÙÛŒÚ¯ Ø¯ÛŒØªØ§Ø¨ÛŒØ³ --------------------
        const DB_NAME = 'FarsinglishMigrationTest';
        const DB_VERSION_V1 = 1;
        const DB_VERSION_V2 = 2;

        // -------------------- Ø³ÛŒØ³ØªÙ… Ù„Ø§Ú¯ --------------------
        const LogManager = {
            logEl: document.getElementById('logContainer'),
            append(message, type = 'info') {
                const time = new Date().toLocaleTimeString('fa-IR', { hour: '2-digit', minute: '2-digit', second: '2-digit' });
                let prefix = '';
                switch(type) {
                    case 'success': prefix = 'âœ…'; break;
                    case 'error': prefix = 'âŒ'; break;
                    case 'warning': prefix = 'âš ï¸'; break;
                    case 'migrate': prefix = 'â¬†ï¸'; break;
                    default: prefix = 'ğŸ“Œ';
                }
                this.logEl.innerHTML += `<div>${prefix} [${time}] ${message}</div>`;
                this.logEl.scrollTop = this.logEl.scrollHeight;
            },
            clear() {
                this.logEl.innerHTML = 'ğŸ§¹ Ù„Ø§Ú¯ Ù¾Ø§Ú© Ø´Ø¯.';
            }
        };

        // -------------------- Helper: Ø¨Ø§Ø² Ú©Ø±Ø¯Ù† Ø¯ÛŒØªØ§Ø¨ÛŒØ³ --------------------
        function openDB(version) {
            return new Promise((resolve, reject) => {
                const request = indexedDB.open(DB_NAME, version);
                
                request.onupgradeneeded = (event) => {
                    const db = event.target.result;
                    const oldVersion = event.oldVersion;
                    const newVersion = event.newVersion;
                    
                    LogManager.append(`ğŸ”„ upgrade Ø§Ø² Ù†Ø³Ø®Ù‡ ${oldVersion} Ø¨Ù‡ ${newVersion}`, 'migrate');

                    // Ù…Ù‡Ø§Ø¬Ø±Øª Ø§Ø² 0 Ø¨Ù‡ 1 (Ù†ØµØ¨ Ø§ÙˆÙ„ÛŒÙ‡)
                    if (oldVersion < 1) {
                        if (!db.objectStoreNames.contains('users')) {
                            const userStore = db.createObjectStore('users', { keyPath: 'id', autoIncrement: true });
                            userStore.createIndex('email', 'email', { unique: true });
                            userStore.createIndex('level', 'level', { unique: false });
                            LogManager.append(`ğŸ“ Ø§ÛŒØ¬Ø§Ø¯ Ø¬Ø¯ÙˆÙ„ users (v1)`, 'success');
                        }
                    }

                    // Ù…Ù‡Ø§Ø¬Ø±Øª Ø§Ø² 1 Ø¨Ù‡ 2
                    if (oldVersion < 2 && oldVersion >= 1) {
                        LogManager.append(`ğŸ†™ Ø§Ø±ØªÙ‚Ø§ Ø¨Ù‡ v2: Ø§Ø¶Ø§ÙÙ‡ Ø´Ø¯Ù† Ø¬Ø¯ÙˆÙ„ lessons`, 'migrate');
                        
                        // Ø§ÛŒØ¬Ø§Ø¯ Ø¬Ø¯ÙˆÙ„ lessons
                        if (!db.objectStoreNames.contains('lessons')) {
                            const lessonStore = db.createObjectStore('lessons', { keyPath: 'id', autoIncrement: true });
                            lessonStore.createIndex('title', 'title', { unique: false });
                            lessonStore.createIndex('progress', 'progress', { unique: false });
                            LogManager.append(`ğŸ“ Ø§ÛŒØ¬Ø§Ø¯ Ø¬Ø¯ÙˆÙ„ lessons (v2)`, 'success');
                        }

                        LogManager.append(`ğŸ”– Ø§ÛŒÙ†Ø¯Ú©Ø³ level Ø¯Ø± users Ù‚Ø¨Ù„Ø§Ù‹ ÙˆØ¬ÙˆØ¯ Ø¯Ø§Ø±Ø¯`, 'info');
                    }
                };

                request.onsuccess = (event) => {
                    resolve(event.target.result);
                };

                request.onerror = (event) => {
                    reject(event.target.error);
                };
            });
        }

        // -------------------- Ù†Ù…Ø§ÛŒØ´ Ù†Ø³Ø®Ù‡ Ùˆ ØªØ¹Ø¯Ø§Ø¯ Ú©Ø§Ø±Ø¨Ø±Ø§Ù† --------------------
        async function refreshDBInfo() {
            try {
                const db = await openDB(DB_VERSION_V2); // Ù‡Ù…ÛŒØ´Ù‡ Ø¢Ø®Ø±ÛŒÙ† Ù†Ø³Ø®Ù‡
                document.getElementById('dbVersionDisplay').innerText = db.version;
                
                if (db.objectStoreNames.contains('users')) {
                    const tx = db.transaction('users', 'readonly');
                    const store = tx.objectStore('users');
                    const countRequest = store.count();
                    countRequest.onsuccess = () => {
                        document.getElementById('userCountDisplay').innerText = countRequest.result;
                    };
                } else {
                    document.getElementById('userCountDisplay').innerText = '0';
                }
                db.close();
            } catch (e) {
                document.getElementById('dbVersionDisplay').innerText = '0';
                document.getElementById('userCountDisplay').innerText = '0';
            }
        }

        // -------------------- Ù†ØµØ¨ v1 (Ø­Ø°Ù Ùˆ Ø§ÛŒØ¬Ø§Ø¯ Ù…Ø¬Ø¯Ø¯) --------------------
        async function installV1() {
            return new Promise((resolve, reject) => {
                LogManager.append('ğŸ—‘ï¸ Ø­Ø°Ù Ø¯ÛŒØªØ§Ø¨ÛŒØ³ Ù‚Ø¨Ù„ÛŒ...', 'warning');
                const deleteRequest = indexedDB.deleteDatabase(DB_NAME);
                
                deleteRequest.onsuccess = () => {
                    LogManager.append('âœ… Ø¯ÛŒØªØ§Ø¨ÛŒØ³ Ø­Ø°Ù Ø´Ø¯. Ù†ØµØ¨ v1...', 'success');
                    
                    const request = indexedDB.open(DB_NAME, DB_VERSION_V1);
                    request.onupgradeneeded = (e) => {
                        const db = e.target.result;
                        if (!db.objectStoreNames.contains('users')) {
                            const store = db.createObjectStore('users', { keyPath: 'id', autoIncrement: true });
                            store.createIndex('email', 'email', { unique: true });
                            store.createIndex('level', 'level', { unique: false });
                            LogManager.append('ğŸ“ Ø¬Ø¯ÙˆÙ„ users Ø¨Ø§ Ø§ÛŒÙ†Ø¯Ú©Ø³ email, level Ø§ÛŒØ¬Ø§Ø¯ Ø´Ø¯', 'success');
                        }
                    };
                    request.onsuccess = () => {
                        LogManager.append('ğŸ‰ Ø¯ÛŒØªØ§Ø¨ÛŒØ³ v1 Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ù†ØµØ¨ Ø´Ø¯', 'success');
                        request.result.close();
                        refreshDBInfo();
                        resolve();
                    };
                    request.onerror = (e) => {
                        LogManager.append(`âŒ Ø®Ø·Ø§ Ø¯Ø± Ù†ØµØ¨ v1: ${e.target.error}`, 'error');
                        reject(e);
                    };
                };
                
                deleteRequest.onerror = (e) => {
                    LogManager.append(`âŒ Ø®Ø·Ø§ Ø¯Ø± Ø­Ø°Ù Ø¯ÛŒØªØ§Ø¨ÛŒØ³: ${e.target.error}`, 'error');
                    reject(e);
                };
            });
        }

        // -------------------- Ø§ÙØ²ÙˆØ¯Ù† Ú©Ø§Ø±Ø¨Ø± Ù†Ù…ÙˆÙ†Ù‡ (Ø±ÙØ¹ Ø®Ø·Ø§: Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø§Ø² Ø¢Ø®Ø±ÛŒÙ† Ù†Ø³Ø®Ù‡) --------------------
        async function addSampleUser() {
            try {
                // Ø±ÙØ¹ Ø®Ø·Ø§: Ù‡Ù…ÛŒØ´Ù‡ Ø§Ø² Ø¢Ø®Ø±ÛŒÙ† Ù†Ø³Ø®Ù‡ Ø§Ø³ØªÙØ§Ø¯Ù‡ Ú©Ù†
                const db = await openDB(DB_VERSION_V2);
                
                if (!db.objectStoreNames.contains('users')) {
                    LogManager.append('âŒ Ø¬Ø¯ÙˆÙ„ users ÙˆØ¬ÙˆØ¯ Ù†Ø¯Ø§Ø±Ø¯. Ø§Ø¨ØªØ¯Ø§ Ø¯ÛŒØªØ§Ø¨ÛŒØ³ Ø±Ø§ Ù†ØµØ¨ Ú©Ù†ÛŒØ¯.', 'error');
                    db.close();
                    return;
                }
                
                const tx = db.transaction('users', 'readwrite');
                const store = tx.objectStore('users');
                
                const user = {
                    name: 'Ú©Ø§Ø±Ø¨Ø± ØªØ³ØªÛŒ',
                    email: `test${Date.now()}@farsinglish.ir`,
                    level: Math.floor(Math.random() * 5) + 1,
                    createdAt: new Date().toISOString() // ÙÛŒÙ„Ø¯ Ø¬Ø¯ÛŒØ¯ v2
                };
                
                const request = store.add(user);
                request.onsuccess = () => {
                    LogManager.append(`ğŸ‘¤ Ú©Ø§Ø±Ø¨Ø± "${user.name}" Ø¨Ø§ Ø³Ø·Ø­ ${user.level} Ø§Ø¶Ø§ÙÙ‡ Ø´Ø¯`, 'success');
                    refreshDBInfo();
                };
                request.onerror = (e) => {
                    LogManager.append(`âŒ Ø®Ø·Ø§ Ø¯Ø± Ø§ÙØ²ÙˆØ¯Ù† Ú©Ø§Ø±Ø¨Ø±: ${e.target.error}`, 'error');
                };
                
                db.close();
            } catch (e) {
                LogManager.append(`âŒ Ø®Ø·Ø§: ${e.message}`, 'error');
            }
        }

        // -------------------- Ù†Ù…Ø§ÛŒØ´ Ú©Ø§Ø±Ø¨Ø±Ø§Ù† (Ø±ÙØ¹ Ø®Ø·Ø§: Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø§Ø² Ø¢Ø®Ø±ÛŒÙ† Ù†Ø³Ø®Ù‡) --------------------
        async function showUsers() {
            try {
                // Ø±ÙØ¹ Ø®Ø·Ø§: Ù‡Ù…ÛŒØ´Ù‡ Ø§Ø² Ø¢Ø®Ø±ÛŒÙ† Ù†Ø³Ø®Ù‡ Ø§Ø³ØªÙØ§Ø¯Ù‡ Ú©Ù†
                const db = await openDB(DB_VERSION_V2);
                
                if (!db.objectStoreNames.contains('users')) {
                    LogManager.append('âŒ Ø¬Ø¯ÙˆÙ„ users ÙˆØ¬ÙˆØ¯ Ù†Ø¯Ø§Ø±Ø¯.', 'error');
                    db.close();
                    return;
                }
                
                const tx = db.transaction('users', 'readonly');
                const store = tx.objectStore('users');
                const request = store.getAll();
                
                request.onsuccess = () => {
                    const users = request.result;
                    if (users.length === 0) {
                        LogManager.append('ğŸ“­ Ù‡ÛŒÚ† Ú©Ø§Ø±Ø¨Ø±ÛŒ ÛŒØ§ÙØª Ù†Ø´Ø¯', 'warning');
                    } else {
                        LogManager.append(`ğŸ“‹ Ù„ÛŒØ³Øª Ú©Ø§Ø±Ø¨Ø±Ø§Ù† (${users.length} Ù†ÙØ±):`, 'info');
                        users.forEach(u => {
                            const createdAt = u.createdAt ? u.createdAt.substring(0, 10) : 'Ù‚Ø¯ÛŒÙ…ÛŒ (Ø¨Ø¯ÙˆÙ† ØªØ§Ø±ÛŒØ®)';
                            LogManager.append(`   ID: ${u.id} | Ù†Ø§Ù…: ${u.name} | Ø³Ø·Ø­: ${u.level} | ØªØ§Ø±ÛŒØ®: ${createdAt}`, 'info');
                        });
                    }
                    db.close();
                };
            } catch (e) {
                LogManager.append(`âŒ Ø®Ø·Ø§ Ø¯Ø± Ù†Ù…Ø§ÛŒØ´ Ú©Ø§Ø±Ø¨Ø±Ø§Ù†: ${e.message}`, 'error');
            }
        }

        // -------------------- Ù…Ù‡Ø§Ø¬Ø±Øª Ø¨Ù‡ v2 --------------------
        async function migrateToV2() {
            try {
                LogManager.append('â¬†ï¸ Ø´Ø±ÙˆØ¹ ÙØ±Ø¢ÛŒÙ†Ø¯ Ù…Ù‡Ø§Ø¬Ø±Øª Ø¨Ù‡ v2...', 'migrate');
                
                const db = await openDB(DB_VERSION_V2);
                
                if (db.objectStoreNames.contains('lessons')) {
                    const tx = db.transaction('lessons', 'readwrite');
                    const store = tx.objectStore('lessons');
                    
                    const sampleLesson = {
                        title: 'Ø¯Ø±Ø³ Ù†Ù…ÙˆÙ†Ù‡ Ù¾Ø³ Ø§Ø² Ù…Ù‡Ø§Ø¬Ø±Øª',
                        progress: 0,
                        createdAt: new Date().toISOString()
                    };
                    
                    store.add(sampleLesson);
                    LogManager.append('ğŸ“š Ø¯Ø±Ø³ Ù†Ù…ÙˆÙ†Ù‡ Ø¨Ù‡ Ø¬Ø¯ÙˆÙ„ lessons Ø§Ø¶Ø§ÙÙ‡ Ø´Ø¯', 'success');
                }
                
                db.close();
                LogManager.append('ğŸ‰ Ù…Ù‡Ø§Ø¬Ø±Øª Ø¨Ù‡ v2 Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø§Ù†Ø¬Ø§Ù… Ø´Ø¯', 'success');
                refreshDBInfo();
                
                await testUsersSchema();
                
            } catch (e) {
                LogManager.append(`âŒ Ø®Ø·Ø§ Ø¯Ø± Ù…Ù‡Ø§Ø¬Ø±Øª: ${e.message}`, 'error');
            }
        }

        // -------------------- ØªØ³Øª Ø§Ø³Ú©ÛŒÙ…Ø§ users --------------------
        async function testUsersSchema() {
            try {
                const db = await openDB(DB_VERSION_V2);
                
                if (!db.objectStoreNames.contains('users')) {
                    LogManager.append('âŒ Ø¬Ø¯ÙˆÙ„ users ÙˆØ¬ÙˆØ¯ Ù†Ø¯Ø§Ø±Ø¯!', 'error');
                    db.close();
                    return;
                }
                
                const tx = db.transaction('users', 'readonly');
                const store = tx.objectStore('users');
                
                const emailIndex = store.index('email');
                const levelIndex = store.index('level');
                
                let schemaValid = true;
                if (!emailIndex) {
                    LogManager.append('âŒ Ø§ÛŒÙ†Ø¯Ú©Ø³ email ÛŒØ§ÙØª Ù†Ø´Ø¯', 'error');
                    schemaValid = false;
                }
                if (!levelIndex) {
                    LogManager.append('âŒ Ø§ÛŒÙ†Ø¯Ú©Ø³ level ÛŒØ§ÙØª Ù†Ø´Ø¯', 'error');
                    schemaValid = false;
                }
                
                if (schemaValid) {
                    LogManager.append('âœ… Ø§Ø³Ú©ÛŒÙ…Ø§ users: ØµØ­ÛŒØ­ (Ø¯Ø§Ø±Ø§ÛŒ Ø§ÛŒÙ†Ø¯Ú©Ø³â€ŒÙ‡Ø§ÛŒ email Ùˆ level)', 'success');
                }
                
                db.close();
            } catch (e) {
                LogManager.append(`âŒ Ø®Ø·Ø§ Ø¯Ø± ØªØ³Øª Ø§Ø³Ú©ÛŒÙ…Ø§: ${e.message}`, 'error');
            }
        }

        // -------------------- ØªØ³Øª Ø¬Ø¯ÙˆÙ„ lessons --------------------
        async function testLessonsTable() {
            try {
                const db = await openDB(DB_VERSION_V2);
                
                if (!db.objectStoreNames.contains('lessons')) {
                    LogManager.append('âŒ Ø¬Ø¯ÙˆÙ„ lessons ÙˆØ¬ÙˆØ¯ Ù†Ø¯Ø§Ø±Ø¯! Ù…Ù‡Ø§Ø¬Ø±Øª Ú©Ø§Ù…Ù„ Ù†Ø´Ø¯Ù‡.', 'error');
                    db.close();
                    return;
                }
                
                const tx = db.transaction('lessons', 'readonly');
                const store = tx.objectStore('lessons');
                
                const titleIndex = store.index('title');
                const progressIndex = store.index('progress');
                
                if (titleIndex && progressIndex) {
                    LogManager.append('âœ… Ø¬Ø¯ÙˆÙ„ lessons Ø¨Ø§ Ø§ÛŒÙ†Ø¯Ú©Ø³â€ŒÙ‡Ø§ÛŒ title Ùˆ progress ÙˆØ¬ÙˆØ¯ Ø¯Ø§Ø±Ø¯', 'success');
                } else {
                    LogManager.append('âš ï¸ Ø§ÛŒÙ†Ø¯Ú©Ø³â€ŒÙ‡Ø§ÛŒ lessons Ù†Ø§Ù‚Øµ Ù‡Ø³ØªÙ†Ø¯', 'warning');
                }
                
                const getAll = store.getAll();
                getAll.onsuccess = () => {
                    const lessons = getAll.result;
                    LogManager.append(`ğŸ“– ØªØ¹Ø¯Ø§Ø¯ Ø¯Ø±ÙˆØ³: ${lessons.length}`, 'info');
                    lessons.forEach(l => {
                        LogManager.append(`   Ø¯Ø±Ø³: ${l.title} | Ù¾ÛŒØ´Ø±ÙØª: ${l.progress}% | ØªØ§Ø±ÛŒØ®: ${l.createdAt ? l.createdAt.substring(0,10) : 'Ù†Ø¯Ø§Ø±Ø¯'}`, 'info');
                    });
                };
                
                db.close();
            } catch (e) {
                LogManager.append(`âŒ Ø®Ø·Ø§ Ø¯Ø± ØªØ³Øª lessons: ${e.message}`, 'error');
            }
        }

        // -------------------- ØªØ³Øª Ú©Ø§Ù…Ù„ Ù…Ù‡Ø§Ø¬Ø±Øª --------------------
        async function fullMigrationTest() {
            LogManager.append('ğŸ§ª Ø´Ø±ÙˆØ¹ ØªØ³Øª Ø¬Ø§Ù…Ø¹ Ù…Ù‡Ø§Ø¬Ø±Øª...', 'info');
            
            await installV1();
            
            for (let i = 0; i < 3; i++) {
                await addSampleUser();
            }
            
            await showUsers();
            
            await migrateToV2();
            
            await testLessonsTable();
            
            LogManager.append('ğŸ ØªØ³Øª Ø¬Ø§Ù…Ø¹ Ù…Ù‡Ø§Ø¬Ø±Øª Ø¨Ù‡ Ù¾Ø§ÛŒØ§Ù† Ø±Ø³ÛŒØ¯ - Ø¨Ø¯ÙˆÙ† Ø®Ø·Ø§ÛŒ Ù†Ø³Ø®Ù‡ âœ…', 'success');
            
            refreshDBInfo();
        }

        // -------------------- Event Listeners --------------------
        window.onload = () => {
            refreshDBInfo();
            
            document.getElementById('installV1Btn').addEventListener('click', installV1);
            document.getElementById('addSampleUserBtn').addEventListener('click', addSampleUser);
            document.getElementById('showUsersBtn').addEventListener('click', showUsers);
            document.getElementById('migrateToV2Btn').addEventListener('click', migrateToV2);
            document.getElementById('testUsersSchemaBtn').addEventListener('click', testUsersSchema);
            document.getElementById('testLessonsTableBtn').addEventListener('click', testLessonsTable);
            document.getElementById('fullMigrationTestBtn').addEventListener('click', fullMigrationTest);
            document.getElementById('clearLogBtn').addEventListener('click', () => LogManager.clear());
            
            LogManager.append('ğŸš€ Ø³ÛŒØ³ØªÙ… ØªØ³Øª Ù…Ù‡Ø§Ø¬Ø±Øª (Ù†Ø³Ø®Ù‡ Ø§ØµÙ„Ø§Ø­â€ŒØ´Ø¯Ù‡) Ø¢Ù…Ø§Ø¯Ù‡ Ø§Ø³Øª.', 'success');
            LogManager.append('ğŸ› ï¸ Ø±ÙØ¹ Ø®Ø·Ø§: ØªÙ…Ø§Ù… ØªÙˆØ§Ø¨Ø¹ Ø§Ø² Ø¢Ø®Ø±ÛŒÙ† Ù†Ø³Ø®Ù‡ Ø¯ÛŒØªØ§Ø¨ÛŒØ³ Ø§Ø³ØªÙØ§Ø¯Ù‡ Ù…ÛŒâ€ŒÚ©Ù†Ù†Ø¯', 'success');
        };
    </script>
</body>
</html>
