<!DOCTYPE html>
<html lang="fa">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ØªØ³Øª Auth Service - Farsinglish</title>
    <style>
        :root {
            --primary: #4f46e5;
            --secondary: #7c3aed;
            --success: #10b981;
            --danger: #ef4444;
            --warning: #f59e0b;
            --info: #3b82f6;
            --light: #f8fafc;
            --dark: #1e293b;
            --gray: #64748b;
            --border: #e2e8f0;
        }
        
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: 'Vazirmatn', system-ui, -apple-system, sans-serif;
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            min-height: 100vh;
            padding: 20px;
            color: var(--dark);
            line-height: 1.6;
        }
        
        .container {
            max-width: 1000px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }
        
        .header {
            text-align: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 2px solid var(--border);
        }
        
        h1 {
            color: var(--dark);
            font-size: 28px;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
        }
        
        .subtitle {
            color: var(--gray);
            font-size: 16px;
            margin-bottom: 15px;
        }
        
        .badges {
            display: flex;
            justify-content: center;
            gap: 10px;
            flex-wrap: wrap;
            margin-top: 15px;
        }
        
        .badge {
            padding: 6px 15px;
            border-radius: 20px;
            font-size: 13px;
            font-weight: bold;
        }
        
        .badge-jwt { background: #dbeafe; color: #1e40af; }
        .badge-token { background: #f0f9ff; color: #0c4a6e; }
        .badge-crypto { background: #fef3c7; color: #92400e; }
        .badge-validation { background: #dcfce7; color: #166534; }
        
        .test-section {
            margin: 25px 0;
        }
        
        .test-category {
            background: var(--light);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            border: 1px solid var(--border);
        }
        
        .category-title {
            font-size: 18px;
            font-weight: bold;
            color: var(--dark);
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid var(--border);
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .test-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 15px;
        }
        
        @media (max-width: 768px) {
            .test-list {
                grid-template-columns: 1fr;
            }
        }
        
        .test-item {
            background: white;
            border-radius: 10px;
            padding: 15px;
            border: 1px solid var(--border);
            transition: all 0.3s;
            position: relative;
            overflow: hidden;
        }
        
        .test-item:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 20px rgba(0,0,0,0.1);
        }
        
        .test-item::before {
            content: '';
            position: absolute;
            top: 0;
            right: 0;
            width: 4px;
            height: 100%;
        }
        
        .test-item.passing::before { background: var(--success); }
        .test-item.failing::before { background: var(--danger); }
        .test-item.pending::before { background: var(--warning); }
        
        .test-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        
        .test-name {
            font-weight: 600;
            color: var(--dark);
            flex-grow: 1;
        }
        
        .test-status {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: bold;
            margin-right: 10px;
        }
        
        .status-pass { background: var(--success); color: white; }
        .status-fail { background: var(--danger); color: white; }
        .status-pending { background: var(--warning); color: white; }
        
        .test-description {
            font-size: 13px;
            color: var(--gray);
            margin-bottom: 10px;
            line-height: 1.5;
        }
        
        .test-details {
            background: var(--light);
            border-radius: 8px;
            padding: 10px;
            margin-top: 10px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            color: var(--dark);
            display: none;
            white-space: pre-wrap;
            animation: slideDown 0.3s;
        }
        
        @keyframes slideDown {
            from { opacity: 0; max-height: 0; }
            to { opacity: 1; max-height: 500px; }
        }
        
        .test-item.expanded .test-details {
            display: block;
        }
        
        .toggle-details {
            background: none;
            border: none;
            color: var(--info);
            font-size: 12px;
            cursor: pointer;
            padding: 4px 8px;
            border-radius: 4px;
            margin-top: 8px;
            transition: all 0.2s;
        }
        
        .toggle-details:hover {
            background: var(--border);
        }
        
        .controls {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin: 30px 0;
            flex-wrap: wrap;
        }
        
        .btn {
            padding: 12px 28px;
            border-radius: 10px;
            border: none;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            min-width: 180px;
        }
        
        .btn-primary { 
            background: var(--primary); 
            color: white; 
        }
        
        .btn-success { 
            background: var(--success); 
            color: white; 
        }
        
        .btn-warning { 
            background: var(--warning); 
            color: white; 
        }
        
        .btn-danger { 
            background: var(--danger); 
            color: white; 
        }
        
        .btn:hover {
            transform: scale(1.05);
            box-shadow: 0 8px 20px rgba(0,0,0,0.2);
        }
        
        .btn:active {
            transform: scale(0.98);
        }
        
        .stats {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 15px;
            margin: 30px 0;
        }
        
        @media (max-width: 768px) {
            .stats {
                grid-template-columns: repeat(2, 1fr);
            }
        }
        
        .stat-card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            text-align: center;
            border: 1px solid var(--border);
            box-shadow: 0 5px 15px rgba(0,0,0,0.05);
        }
        
        .stat-value {
            font-size: 32px;
            font-weight: bold;
            margin-bottom: 5px;
        }
        
        .stat-label {
            font-size: 14px;
            color: var(--gray);
        }
        
        .stat-passed .stat-value { color: var(--success); }
        .stat-failed .stat-value { color: var(--danger); }
        .stat-total .stat-value { color: var(--primary); }
        .stat-duration .stat-value { color: var(--warning); }
        
        .progress-container {
            margin: 25px 0;
        }
        
        .progress-bar {
            height: 8px;
            background: var(--border);
            border-radius: 4px;
            overflow: hidden;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--success), var(--info));
            border-radius: 4px;
            transition: width 0.5s;
            width: 0%;
        }
        
        .progress-text {
            display: flex;
            justify-content: space-between;
            margin-top: 8px;
            font-size: 14px;
            color: var(--gray);
        }
        
        .mock-api {
            background: #1e293b;
            color: #e2e8f0;
            border-radius: 12px;
            padding: 20px;
            margin: 25px 0;
            font-family: 'Courier New', monospace;
            font-size: 13px;
        }
        
        .mock-title {
            color: #94a3b8;
            margin-bottom: 10px;
            font-weight: bold;
        }
        
        .mock-endpoint {
            color: #60a5fa;
            margin: 5px 0;
        }
        
        .mock-response {
            color: #34d399;
            margin: 5px 0;
        }
        
        .summary {
            background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);
            border-radius: 12px;
            padding: 25px;
            margin-top: 30px;
            border-left: 4px solid var(--info);
        }
        
        .summary-title {
            font-size: 18px;
            font-weight: bold;
            color: var(--dark);
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .summary-content {
            color: var(--dark);
            line-height: 1.8;
        }
        
        .footer {
            text-align: center;
            margin-top: 30px;
            padding-top: 20px;
            border-top: 1px solid var(--border);
            color: var(--gray);
            font-size: 14px;
        }
        
        .console {
            background: #0f172a;
            color: #cbd5e0;
            border-radius: 12px;
            padding: 15px;
            margin-top: 20px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            max-height: 200px;
            overflow-y: auto;
        }
        
        .console-line {
            padding: 5px 0;
            border-bottom: 1px solid #334155;
            font-family: 'Vazirmatn', monospace;
        }
        
        .console-timestamp {
            color: #64748b;
            font-size: 11px;
            margin-left: 10px;
        }
        
        .console-success { color: #34d399; }
        .console-error { color: #f87171; }
        .console-warning { color: #fbbf24; }
        .console-info { color: #60a5fa; }
    </style>
    <link href="https://cdn.jsdelivr.net/gh/rastikerdar/vazirmatn@v33.003/Vazirmatn-font-face.css" rel="stylesheet">
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>
                <span>ğŸ”</span>
                ØªØ³Øª Auth Service
            </h1>
            <p class="subtitle">Ø³Ø±ÙˆÛŒØ³ Ø§Ø­Ø±Ø§Ø² Ù‡ÙˆÛŒØª Ø¨Ø§ JWTØŒ HashØŒ Ùˆ Validation Ù¾ÛŒØ´Ø±ÙØªÙ‡</p>
            
            <div class="badges">
                <span class="badge badge-jwt">JWT Token</span>
                <span class="badge badge-token">Refresh Token</span>
                <span class="badge badge-crypto">Password Hash</span>
                <span class="badge badge-validation">Input Validation</span>
            </div>
        </div>

        <div class="stats">
            <div class="stat-card stat-total">
                <div class="stat-value" id="totalTests">18</div>
                <div class="stat-label">Ú©Ù„ ØªØ³Øªâ€ŒÙ‡Ø§</div>
            </div>
            <div class="stat-card stat-passed">
                <div class="stat-value" id="passedTests">0</div>
                <div class="stat-label">Ù…ÙˆÙÙ‚</div>
            </div>
            <div class="stat-card stat-failed">
                <div class="stat-value" id="failedTests">0</div>
                <div class="stat-label">Ù†Ø§Ù…ÙˆÙÙ‚</div>
            </div>
            <div class="stat-card stat-duration">
                <div class="stat-value" id="duration">0.00</div>
                <div class="stat-label">Ø«Ø§Ù†ÛŒÙ‡</div>
            </div>
        </div>

        <div class="progress-container">
            <div class="progress-bar">
                <div class="progress-fill" id="progressFill"></div>
            </div>
            <div class="progress-text">
                <span>Ù¾ÛŒØ´Ø±ÙØª ØªØ³Øªâ€ŒÙ‡Ø§</span>
                <span id="progressPercent">0%</span>
            </div>
        </div>

        <div class="controls">
            <button class="btn btn-primary" onclick="runAllTests()">
                <span>ğŸš€</span> Ø§Ø¬Ø±Ø§ÛŒ Ù‡Ù…Ù‡ ØªØ³Øªâ€ŒÙ‡Ø§
            </button>
            <button class="btn btn-success" onclick="runCategoryTests('validation')">
                <span>âœ…</span> ØªØ³Øªâ€ŒÙ‡Ø§ÛŒ Validation
            </button>
            <button class="btn btn-warning" onclick="runCategoryTests('security')">
                <span>ğŸ”’</span> ØªØ³Øªâ€ŒÙ‡Ø§ÛŒ Ø§Ù…Ù†ÛŒØªÛŒ
            </button>
            <button class="btn btn-danger" onclick="resetTests()">
                <span>ğŸ”„</span> Ø¨Ø§Ø²Ù†Ø´Ø§Ù†ÛŒ
            </button>
        </div>

        <div class="mock-api">
            <div class="mock-title">ğŸ­ Mock API Endpoints:</div>
            <div class="mock-endpoint">POST /api/auth/login â†’ { token, user }</div>
            <div class="mock-endpoint">POST /api/auth/register â†’ { success, userId }</div>
            <div class="mock-endpoint">POST /api/auth/refresh â†’ { newToken }</div>
            <div class="mock-response">âœ… Ù‡Ù…Ù‡ Ø¯Ø±Ø®ÙˆØ§Ø³Øªâ€ŒÙ‡Ø§ Ø¨Ù‡ ØµÙˆØ±Øª Mock Ù¾Ø§Ø³Ø® Ø¯Ø§Ø¯Ù‡ Ù…ÛŒâ€ŒØ´ÙˆÙ†Ø¯</div>
        </div>

        <div id="testResults">
            <!-- ØªØ³Øªâ€ŒÙ‡Ø§ Ø§ÛŒÙ†Ø¬Ø§ Ù†Ù…Ø§ÛŒØ´ Ø¯Ø§Ø¯Ù‡ Ù…ÛŒâ€ŒØ´ÙˆÙ†Ø¯ -->
        </div>

        <div class="console">
            <div id="consoleOutput">
                <div class="console-line console-info">
                    Ø³ÛŒØ³ØªÙ… ØªØ³Øª Auth Service Ø¢Ù…Ø§Ø¯Ù‡ Ø§Ø³Øª 
                    <span class="console-timestamp">[Ø¢Ù…Ø§Ø¯Ù‡]</span>
                </div>
            </div>
        </div>

        <div class="summary">
            <div class="summary-title">
                <span>ğŸ“‹ ÙˆÛŒÚ˜Ú¯ÛŒâ€ŒÙ‡Ø§ÛŒ ØªØ³Øª Ø´Ø¯Ù‡</span>
            </div>
            <div class="summary-content">
                1. <strong>Ø§Ø¹ØªØ¨Ø§Ø±Ø³Ù†Ø¬ÛŒ ÙˆØ±ÙˆØ¯ÛŒâ€ŒÙ‡Ø§:</strong> Ø§ÛŒÙ…ÛŒÙ„ØŒ Ø±Ù…Ø² Ø¹Ø¨ÙˆØ±ØŒ Ù†Ø§Ù… Ú©Ø§Ø±Ø¨Ø±ÛŒ<br>
                2. <strong>Ø§Ù…Ù†ÛŒØª:</strong> Hash Ú©Ø±Ø¯Ù† Ø±Ù…Ø² Ø¹Ø¨ÙˆØ±ØŒ JWTç­¾åØŒ Refresh Token<br>
                3. <strong>Ù…Ø¯ÛŒØ±ÛŒØª Token:</strong> Ø°Ø®ÛŒØ±Ù‡â€ŒØ³Ø§Ø²ÛŒØŒ Ø§Ø¹ØªØ¨Ø§Ø±Ø³Ù†Ø¬ÛŒØŒ ØªÙ…Ø¯ÛŒØ¯<br>
                4. <strong>Ø®Ø·Ø§Ù‡Ø§:</strong> Ù¾Ø§Ø³Ø®â€ŒÙ‡Ø§ÛŒ Ù…Ù†Ø§Ø³Ø¨ Ø¨Ø±Ø§ÛŒ ÙˆØ±ÙˆØ¯ÛŒ Ù†Ø§Ù…Ø¹ØªØ¨Ø±<br>
                5. <strong>Ù¾Ø§ÛŒØ¯Ø§Ø±ÛŒ:</strong> Ø¹Ù…Ù„Ú©Ø±Ø¯ Ø¯Ø± Ø­Ø§Ù„Øª Offline Ùˆ Online
            </div>
        </div>

        <div class="footer">
            <p>Farsinglish Project - Authentication Test Suite</p>
            <p>â±ï¸ Ø¢Ø®Ø±ÛŒÙ† Ø§Ø¬Ø±Ø§: <span id="lastRunTime">Ù‡Ù†ÙˆØ² Ø§Ø¬Ø±Ø§ Ù†Ø´Ø¯Ù‡</span></p>
        </div>
    </div>

    <script>
        // ==================== Mock Storage (Ø´Ø¨ÛŒÙ‡â€ŒØ³Ø§Ø²ÛŒ localStorage Ùˆ IndexedDB) ====================
        class MockStorage {
            constructor() {
                this.data = new Map();
                this.listeners = new Map();
            }

            setItem(key, value) {
                const oldValue = this.data.get(key);
                this.data.set(key, value);
                this._notifyListeners(key, value, oldValue);
                return Promise.resolve();
            }

            getItem(key) {
                return Promise.resolve(this.data.get(key) || null);
            }

            removeItem(key) {
                const oldValue = this.data.get(key);
                this.data.delete(key);
                this._notifyListeners(key, null, oldValue);
                return Promise.resolve();
            }

            clear() {
                this.data.clear();
                return Promise.resolve();
            }

            addListener(key, callback) {
                if (!this.listeners.has(key)) {
                    this.listeners.set(key, new Set());
                }
                this.listeners.get(key).add(callback);
                return () => this.listeners.get(key).delete(callback);
            }

            _notifyListeners(key, newValue, oldValue) {
                const listeners = this.listeners.get(key);
                if (listeners) {
                    listeners.forEach(callback => callback(newValue, oldValue));
                }
            }
        }

        // ==================== Auth Service (Ù†Ø³Ø®Ù‡ Ú©Ø§Ù…Ù„) ====================
        class AuthService {
            constructor(storage = new MockStorage()) {
                this.storage = storage;
                this.currentUser = null;
                this.isOnline = true;
                this.apiBaseUrl = 'https://api.farsinglish.com';
                this.tokenRefreshInterval = null;
                
                // Ø±ÙˆÛŒØ¯Ø§Ø¯Ù‡Ø§
                this.events = {
                    LOGIN: 'auth:login',
                    LOGOUT: 'auth:logout',
                    TOKEN_EXPIRED: 'auth:token-expired',
                    ERROR: 'auth:error'
                };
                
                this.listeners = new Map();
            }

            // ==================== Utility Functions ====================
            _validateEmail(email) {
                if (!email || typeof email !== 'string') return false;
                const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
                return emailRegex.test(email.trim());
            }

            _validatePassword(password) {
                if (!password || typeof password !== 'string') return false;
                if (password.length < 8) return false;
                if (!/[A-Z]/.test(password)) return false;
                if (!/[a-z]/.test(password)) return false;
                if (!/[0-9]/.test(password)) return false;
                return true;
            }

            _validateUsername(username) {
                if (!username || typeof username !== 'string') return false;
                if (username.length < 3 || username.length > 30) return false;
                const usernameRegex = /^[a-zA-Z0-9_.-]+$/;
                return usernameRegex.test(username);
            }

            async _hashPassword(password) {
                // Ø´Ø¨ÛŒÙ‡â€ŒØ³Ø§Ø²ÛŒ Hash Ú©Ø±Ø¯Ù† (Ø¯Ø± ÙˆØ§Ù‚Ø¹ÛŒØª Ø§Ø² bcrypt Ø§Ø³ØªÙØ§Ø¯Ù‡ Ù…ÛŒâ€ŒØ´ÙˆØ¯)
                const encoder = new TextEncoder();
                const data = encoder.encode(password + 'farsinglish-salt');
                const hashBuffer = await crypto.subtle.digest('SHA-256', data);
                const hashArray = Array.from(new Uint8Array(hashBuffer));
                return hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
            }

            _generateToken(userId, expiresInHours = 24) {
                // Ø´Ø¨ÛŒÙ‡â€ŒØ³Ø§Ø²ÛŒ JWT (Ø¯Ø± ÙˆØ§Ù‚Ø¹ÛŒØª Ø§Ø² Ú©ØªØ§Ø¨Ø®Ø§Ù†Ù‡â€ŒØ§ÛŒ Ù…Ø«Ù„ jsonwebtoken Ø§Ø³ØªÙØ§Ø¯Ù‡ Ù…ÛŒâ€ŒØ´ÙˆØ¯)
                const header = btoa(JSON.stringify({ alg: 'HS256', typ: 'JWT' }));
                const payload = btoa(JSON.stringify({
                    sub: userId,
                    iat: Math.floor(Date.now() / 1000),
                    exp: Math.floor(Date.now() / 1000) + (expiresInHours * 3600),
                    role: 'user'
                }));
                const signature = 'mock-signature-' + Date.now();
                return `${header}.${payload}.${signature}`;
            }

            _parseToken(token) {
                try {
                    const parts = token.split('.');
                    if (parts.length !== 3) return null;
                    const payload = JSON.parse(atob(parts[1]));
                    return payload;
                } catch (error) {
                    return null;
                }
            }

            _isTokenValid(token) {
                const payload = this._parseToken(token);
                if (!payload) return false;
                const now = Math.floor(Date.now() / 1000);
                return payload.exp > now;
            }

            // ==================== API Methods ====================
            async _mockApiCall(endpoint, method = 'GET', data = null) {
                if (!this.isOnline) {
                    throw new Error('Ø§ØªØµØ§Ù„ Ø§ÛŒÙ†ØªØ±Ù†Øª Ø¨Ø±Ù‚Ø±Ø§Ø± Ù†ÛŒØ³Øª');
                }

                // Ø´Ø¨ÛŒÙ‡â€ŒØ³Ø§Ø²ÛŒ ØªØ§Ø®ÛŒØ± Ø´Ø¨Ú©Ù‡
                await new Promise(resolve => setTimeout(resolve, 100 + Math.random() * 200));

                // Mock responses
                switch (endpoint) {
                    case '/auth/login':
                        if (data?.email === 'test@example.com' && data?.password === 'Password123!') {
                            return {
                                success: true,
                                token: this._generateToken('user-123'),
                                refreshToken: 'refresh-' + Date.now(),
                                user: {
                                    id: 'user-123',
                                    email: data.email,
                                    name: 'Ú©Ø§Ø±Ø¨Ø± ØªØ³Øª',
                                    level: 1,
                                    xp: 0
                                }
                            };
                        }
                        throw new Error('Ø§ÛŒÙ…ÛŒÙ„ ÛŒØ§ Ø±Ù…Ø² Ø¹Ø¨ÙˆØ± Ù†Ø§Ø¯Ø±Ø³Øª Ø§Ø³Øª');

                    case '/auth/register':
                        if (!this._validateEmail(data?.email)) {
                            throw new Error('Ø§ÛŒÙ…ÛŒÙ„ Ù†Ø§Ù…Ø¹ØªØ¨Ø± Ø§Ø³Øª');
                        }
                        if (!this._validatePassword(data?.password)) {
                            throw new Error('Ø±Ù…Ø² Ø¹Ø¨ÙˆØ± Ø¨Ø§ÛŒØ¯ Ø­Ø¯Ø§Ù‚Ù„ Û¸ Ú©Ø§Ø±Ø§Ú©ØªØ± Ùˆ Ø´Ø§Ù…Ù„ Ø­Ø±ÙˆÙ Ø¨Ø²Ø±Ú¯ØŒ Ú©ÙˆÚ†Ú© Ùˆ Ø§Ø¹Ø¯Ø§Ø¯ Ø¨Ø§Ø´Ø¯');
                        }
                        return {
                            success: true,
                            userId: 'user-' + Date.now(),
                            message: 'Ø«Ø¨Øªâ€ŒÙ†Ø§Ù… Ù…ÙˆÙÙ‚ÛŒØªâ€ŒØ¢Ù…ÛŒØ² Ø¨ÙˆØ¯'
                        };

                    case '/auth/refresh':
                        if (data?.refreshToken?.startsWith('refresh-')) {
                            return {
                                success: true,
                                token: this._generateToken('user-123', 1) // 1 Ø³Ø§Ø¹Øª Ø§Ø¹ØªØ¨Ø§Ø±
                            };
                        }
                        throw new Error('Refresh token Ù†Ø§Ù…Ø¹ØªØ¨Ø± Ø§Ø³Øª');

                    default:
                        throw new Error('Endpoint ÛŒØ§ÙØª Ù†Ø´Ø¯');
                }
            }

            // ==================== Public Methods ====================
            async register(userData) {
                try {
                    // Ø§Ø¹ØªØ¨Ø§Ø±Ø³Ù†Ø¬ÛŒ
                    if (!this._validateEmail(userData.email)) {
                        throw new Error('Ø§ÛŒÙ…ÛŒÙ„ Ù†Ø§Ù…Ø¹ØªØ¨Ø± Ø§Ø³Øª');
                    }
                    if (!this._validatePassword(userData.password)) {
                        throw new Error('Ø±Ù…Ø² Ø¹Ø¨ÙˆØ± Ø¶Ø¹ÛŒÙ Ø§Ø³Øª');
                    }
                    if (!this._validateUsername(userData.username)) {
                        throw new Error('Ù†Ø§Ù… Ú©Ø§Ø±Ø¨Ø±ÛŒ Ù†Ø§Ù…Ø¹ØªØ¨Ø± Ø§Ø³Øª');
                    }

                    // Hash Ú©Ø±Ø¯Ù† Ø±Ù…Ø² Ø¹Ø¨ÙˆØ±
                    const hashedPassword = await this._hashPassword(userData.password);

                    // Ø§Ø±Ø³Ø§Ù„ Ø¨Ù‡ API
                    const response = await this._mockApiCall('/auth/register', 'POST', {
                        ...userData,
                        password: hashedPassword
                    });

                    this._emit(this.events.LOGIN, { user: userData });
                    return response;

                } catch (error) {
                    this._emit(this.events.ERROR, { error: error.message });
                    throw error;
                }
            }

            async login(email, password) {
                try {
                    // Ø§Ø¹ØªØ¨Ø§Ø±Ø³Ù†Ø¬ÛŒ Ø§ÙˆÙ„ÛŒÙ‡
                    if (!this._validateEmail(email)) {
                        throw new Error('ÙØ±Ù…Øª Ø§ÛŒÙ…ÛŒÙ„ Ù†Ø§Ù…Ø¹ØªØ¨Ø± Ø§Ø³Øª');
                    }
                    if (!password || password.length < 1) {
                        throw new Error('Ø±Ù…Ø² Ø¹Ø¨ÙˆØ± Ø§Ù„Ø²Ø§Ù…ÛŒ Ø§Ø³Øª');
                    }

                    // Hash Ú©Ø±Ø¯Ù† Ø¨Ø±Ø§ÛŒ Ø§Ø±Ø³Ø§Ù„
                    const hashedPassword = await this._hashPassword(password);

                    // Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ø¨Ù‡ API
                    const response = await this._mockApiCall('/auth/login', 'POST', {
                        email,
                        password: hashedPassword
                    });

                    // Ø°Ø®ÛŒØ±Ù‡â€ŒØ³Ø§Ø²ÛŒ Token
                    await this.storage.setItem('auth_token', response.token);
                    await this.storage.setItem('refresh_token', response.refreshToken);
                    await this.storage.setItem('user_data', JSON.stringify(response.user));

                    this.currentUser = response.user;
                    this._startTokenRefresh();
                    this._emit(this.events.LOGIN, { user: response.user });

                    return response;

                } catch (error) {
                    this._emit(this.events.ERROR, { error: error.message });
                    throw error;
                }
            }

            async logout() {
                try {
                    // Ø­Ø°Ù Tokenâ€ŒÙ‡Ø§
                    await this.storage.removeItem('auth_token');
                    await this.storage.removeItem('refresh_token');
                    await this.storage.removeItem('user_data');

                    // Ù…ØªÙˆÙ‚Ù Ú©Ø±Ø¯Ù† ØªÙ…Ø¯ÛŒØ¯ Ø®ÙˆØ¯Ú©Ø§Ø±
                    this._stopTokenRefresh();

                    this.currentUser = null;
                    this._emit(this.events.LOGOUT);

                    return { success: true };

                } catch (error) {
                    this._emit(this.events.ERROR, { error: error.message });
                    throw error;
                }
            }

            async refreshToken() {
                try {
                    const refreshToken = await this.storage.getItem('refresh_token');
                    if (!refreshToken) {
                        throw new Error('Refresh token ÛŒØ§ÙØª Ù†Ø´Ø¯');
                    }

                    const response = await this._mockApiCall('/auth/refresh', 'POST', {
                        refreshToken
                    });

                    await this.storage.setItem('auth_token', response.token);
                    return response;

                } catch (error) {
                    this._emit(this.events.TOKEN_EXPIRED);
                    throw error;
                }
            }

            async getCurrentUser() {
                if (this.currentUser) {
                    return this.currentUser;
                }

                try {
                    const userData = await this.storage.getItem('user_data');
                    const token = await this.storage.getItem('auth_token');

                    if (userData && token && this._isTokenValid(token)) {
                        this.currentUser = JSON.parse(userData);
                        return this.currentUser;
                    }

                    // Ø§Ú¯Ø± Token Ù…Ù†Ù‚Ø¶ÛŒ Ø´Ø¯Ù‡
                    if (token && !this._isTokenValid(token)) {
                        await this.refreshToken();
                        return await this.getCurrentUser();
                    }

                    return null;

                } catch (error) {
                    return null;
                }
            }

            isAuthenticated() {
                return this.currentUser !== null;
            }

            // ==================== Event Management ====================
            on(event, callback) {
                if (!this.listeners.has(event)) {
                    this.listeners.set(event, new Set());
                }
                this.listeners.get(event).add(callback);
                return () => this.listeners.get(event).delete(callback);
            }

            _emit(event, data = {}) {
                const listeners = this.listeners.get(event);
                if (listeners) {
                    listeners.forEach(callback => callback(data));
                }
            }

            // ==================== Token Refresh ====================
            _startTokenRefresh() {
                this._stopTokenRefresh();
                // ØªÙ…Ø¯ÛŒØ¯ Ù‡Ø± 55 Ø¯Ù‚ÛŒÙ‚Ù‡ (5 Ø¯Ù‚ÛŒÙ‚Ù‡ Ù‚Ø¨Ù„ Ø§Ø² Ø§Ù†Ù‚Ø¶Ø§)
                this.tokenRefreshInterval = setInterval(async () => {
                    try {
                        await this.refreshToken();
                    } catch (error) {
                        console.warn('Ø®Ø·Ø§ Ø¯Ø± ØªÙ…Ø¯ÛŒØ¯ Token:', error);
                    }
                }, 55 * 60 * 1000);
            }

            _stopTokenRefresh() {
                if (this.tokenRefreshInterval) {
                    clearInterval(this.tokenRefreshInterval);
                    this.tokenRefreshInterval = null;
                }
            }

            // ==================== Test Helpers ====================
            setOnlineStatus(online) {
                this.isOnline = online;
            }

            clearStorage() {
                return this.storage.clear();
            }
        }

        // ==================== Test Suite ====================
        const testSuites = {
            validation: [
                {
                    name: 'Ø§Ø¹ØªØ¨Ø§Ø±Ø³Ù†Ø¬ÛŒ Ø§ÛŒÙ…ÛŒÙ„',
                    description: 'Ø§ÛŒÙ…ÛŒÙ„â€ŒÙ‡Ø§ÛŒ Ù…Ø¹ØªØ¨Ø± Ùˆ Ù†Ø§Ù…Ø¹ØªØ¨Ø± Ø¨Ø§ÛŒØ¯ Ø¨Ù‡ Ø¯Ø±Ø³ØªÛŒ ØªØ´Ø®ÛŒØµ Ø¯Ø§Ø¯Ù‡ Ø´ÙˆÙ†Ø¯',
                    category: 'validation',
                    fn: async () => {
                        const auth = new AuthService();
                        
                        const validEmails = [
                            'test@example.com',
                            'user.name@domain.co',
                            'user+tag@example.org'
                        ];
                        
                        const invalidEmails = [
                            null,
                            '',
                            'invalid-email',
                            '@example.com',
                            'test@.com',
                            'test@com.'
                        ];
                        
                        // ØªØ³Øª Ø§ÛŒÙ…ÛŒÙ„â€ŒÙ‡Ø§ÛŒ Ù…Ø¹ØªØ¨Ø±
                        for (const email of validEmails) {
                            if (!auth._validateEmail(email)) {
                                return `Ø§ÛŒÙ…ÛŒÙ„ Ù…Ø¹ØªØ¨Ø± Ø´Ù†Ø§Ø³Ø§ÛŒÛŒ Ù†Ø´Ø¯: ${email}`;
                            }
                        }
                        
                        // ØªØ³Øª Ø§ÛŒÙ…ÛŒÙ„â€ŒÙ‡Ø§ÛŒ Ù†Ø§Ù…Ø¹ØªØ¨Ø±
                        for (const email of invalidEmails) {
                            if (auth._validateEmail(email)) {
                                return `Ø§ÛŒÙ…ÛŒÙ„ Ù†Ø§Ù…Ø¹ØªØ¨Ø± Ø¨Ù‡ Ø¹Ù†ÙˆØ§Ù† Ù…Ø¹ØªØ¨Ø± Ø´Ù†Ø§Ø³Ø§ÛŒÛŒ Ø´Ø¯: ${email}`;
                            }
                        }
                        
                        return true;
                    }
                },
                {
                    name: 'Ø§Ø¹ØªØ¨Ø§Ø±Ø³Ù†Ø¬ÛŒ Ø±Ù…Ø² Ø¹Ø¨ÙˆØ±',
                    description: 'Ø±Ù…Ø² Ø¹Ø¨ÙˆØ± Ø¨Ø§ÛŒØ¯ Ø­Ø¯Ø§Ù‚Ù„ Û¸ Ú©Ø§Ø±Ø§Ú©ØªØ± Ùˆ Ø´Ø§Ù…Ù„ Ø­Ø±ÙˆÙ Ø¨Ø²Ø±Ú¯ØŒ Ú©ÙˆÚ†Ú© Ùˆ Ø§Ø¹Ø¯Ø§Ø¯ Ø¨Ø§Ø´Ø¯',
                    category: 'validation',
                    fn: async () => {
                        const auth = new AuthService();
                        
                        const validPasswords = [
                            'Password123',
                            'SecurePass456',
                            'Test@Pass789'
                        ];
                        
                        const invalidPasswords = [
                            null,
                            '',
                            'short',
                            'nocapital123',
                            'NOLOWERCASE123',
                            'NoNumbersHere',
                            '12345678' // ÙÙ‚Ø· Ø§Ø¹Ø¯Ø§Ø¯
                        ];
                        
                        for (const pass of validPasswords) {
                            if (!auth._validatePassword(pass)) {
                                return `Ø±Ù…Ø² Ø¹Ø¨ÙˆØ± Ù…Ø¹ØªØ¨Ø± Ø´Ù†Ø§Ø³Ø§ÛŒÛŒ Ù†Ø´Ø¯: ${pass}`;
                            }
                        }
                        
                        for (const pass of invalidPasswords) {
                            if (auth._validatePassword(pass)) {
                                return `Ø±Ù…Ø² Ø¹Ø¨ÙˆØ± Ù†Ø§Ù…Ø¹ØªØ¨Ø± Ø¨Ù‡ Ø¹Ù†ÙˆØ§Ù† Ù…Ø¹ØªØ¨Ø± Ø´Ù†Ø§Ø³Ø§ÛŒÛŒ Ø´Ø¯: ${pass}`;
                            }
                        }
                        
                        return true;
                    }
                },
                {
                    name: 'Ø§Ø¹ØªØ¨Ø§Ø±Ø³Ù†Ø¬ÛŒ Ù†Ø§Ù… Ú©Ø§Ø±Ø¨Ø±ÛŒ',
                    description: 'Ù†Ø§Ù… Ú©Ø§Ø±Ø¨Ø±ÛŒ Ø¨Ø§ÛŒØ¯ Ø¨ÛŒÙ† Û³ ØªØ§ Û³Û° Ú©Ø§Ø±Ø§Ú©ØªØ± Ùˆ ÙÙ‚Ø· Ø´Ø§Ù…Ù„ Ø­Ø±ÙˆÙØŒ Ø§Ø¹Ø¯Ø§Ø¯ Ùˆ ._- Ø¨Ø§Ø´Ø¯',
                    category: 'validation',
                    fn: async () => {
                        const auth = new AuthService();
                        
                        const validUsernames = [
                            'user123',
                            'test_user',
                            'user.name',
                            'user-name',
                            'usr'
                        ];
                        
                        const invalidUsernames = [
                            null,
                            '',
                            'ab', // Ø®ÛŒÙ„ÛŒ Ú©ÙˆØªØ§Ù‡
                            'a'.repeat(31), // Ø®ÛŒÙ„ÛŒ Ø·ÙˆÙ„Ø§Ù†ÛŒ
                            'user@name', // Ú©Ø§Ø±Ø§Ú©ØªØ± ØºÛŒØ±Ù…Ø¬Ø§Ø²
                            'user name', // ÙØ§ØµÙ„Ù‡
                            'user#tag'
                        ];
                        
                        for (const username of validUsernames) {
                            if (!auth._validateUsername(username)) {
                                return `Ù†Ø§Ù… Ú©Ø§Ø±Ø¨Ø±ÛŒ Ù…Ø¹ØªØ¨Ø± Ø´Ù†Ø§Ø³Ø§ÛŒÛŒ Ù†Ø´Ø¯: ${username}`;
                            }
                        }
                        
                        for (const username of invalidUsernames) {
                            if (auth._validateUsername(username)) {
                                return `Ù†Ø§Ù… Ú©Ø§Ø±Ø¨Ø±ÛŒ Ù†Ø§Ù…Ø¹ØªØ¨Ø± Ø¨Ù‡ Ø¹Ù†ÙˆØ§Ù† Ù…Ø¹ØªØ¨Ø± Ø´Ù†Ø§Ø³Ø§ÛŒÛŒ Ø´Ø¯: ${username}`;
                            }
                        }
                        
                        return true;
                    }
                }
            ],
            security: [
                {
                    name: 'Hash Ú©Ø±Ø¯Ù† Ø±Ù…Ø² Ø¹Ø¨ÙˆØ±',
                    description: 'Ø±Ù…Ø² Ø¹Ø¨ÙˆØ± Ø¨Ø§ÛŒØ¯ Ø¨Ù‡ ØµÙˆØ±Øª Ø§Ù…Ù† Hash Ø´ÙˆØ¯',
                    category: 'security',
                    fn: async () => {
                        const auth = new AuthService();
                        
                        const password = 'MySecurePassword123';
                        const hash1 = await auth._hashPassword(password);
                        const hash2 = await auth._hashPassword(password);
                        
                        // Hash ÛŒÚ©Ø³Ø§Ù† Ø¨Ø±Ø§ÛŒ Ø±Ù…Ø² Ø¹Ø¨ÙˆØ± ÛŒÚ©Ø³Ø§Ù†
                        if (hash1 !== hash2) {
                            return 'Hash ÛŒÚ©Ø³Ø§Ù† Ø¨Ø±Ø§ÛŒ Ø±Ù…Ø² Ø¹Ø¨ÙˆØ± ÛŒÚ©Ø³Ø§Ù† ØªÙˆÙ„ÛŒØ¯ Ù†Ø´Ø¯';
                        }
                        
                        // Hash Ù…ØªÙØ§ÙˆØª Ø¨Ø±Ø§ÛŒ Ø±Ù…Ø² Ø¹Ø¨ÙˆØ± Ù…ØªÙØ§ÙˆØª
                        const hash3 = await auth._hashPassword('DifferentPassword456');
                        if (hash1 === hash3) {
                            return 'Hash ÛŒÚ©Ø³Ø§Ù† Ø¨Ø±Ø§ÛŒ Ø±Ù…Ø² Ø¹Ø¨ÙˆØ± Ù…ØªÙØ§ÙˆØª ØªÙˆÙ„ÛŒØ¯ Ø´Ø¯';
                        }
                        
                        // Ø·ÙˆÙ„ Hash (SHA-256 Ø¨Ø§ÛŒØ¯ 64 Ú©Ø§Ø±Ø§Ú©ØªØ± hex Ø¨Ø§Ø´Ø¯)
                        if (hash1.length !== 64) {
                            return `Ø·ÙˆÙ„ Hash Ù†Ø§Ù…Ø¹ØªØ¨Ø±: ${hash1.length} (Ù…ÙˆØ±Ø¯ Ø§Ù†ØªØ¸Ø§Ø±: 64)`;
                        }
                        
                        // ÙØ±Ù…Øª hex
                        const hexRegex = /^[0-9a-f]{64}$/;
                        if (!hexRegex.test(hash1)) {
                            return 'ÙØ±Ù…Øª Hash Ù†Ø§Ù…Ø¹ØªØ¨Ø± Ø§Ø³Øª';
                        }
                        
                        return true;
                    }
                },
                {
                    name: 'JWT Token Generation',
                    description: 'ØªÙˆÚ©Ù† JWT Ø¨Ø§ÛŒØ¯ Ø¨Ù‡ Ø¯Ø±Ø³ØªÛŒ ØªÙˆÙ„ÛŒØ¯ Ùˆ parse Ø´ÙˆØ¯',
                    category: 'security',
                    fn: async () => {
                        const auth = new AuthService();
                        const userId = 'user-test-123';
                        
                        // ØªÙˆÙ„ÛŒØ¯ ØªÙˆÚ©Ù†
                        const token = auth._generateToken(userId);
                        
                        // Ø¨Ø±Ø±Ø³ÛŒ Ø³Ø§Ø®ØªØ§Ø±
                        const parts = token.split('.');
                        if (parts.length !== 3) {
                            return `ÙØ±Ù…Øª ØªÙˆÚ©Ù† Ù†Ø§Ù…Ø¹ØªØ¨Ø±. Ø¨Ø®Ø´â€ŒÙ‡Ø§: ${parts.length}`;
                        }
                        
                        // Parse ØªÙˆÚ©Ù†
                        const payload = auth._parseToken(token);
                        if (!payload) {
                            return 'Ø®Ø·Ø§ Ø¯Ø± parse Ú©Ø±Ø¯Ù† ØªÙˆÚ©Ù†';
                        }
                        
                        // Ø¨Ø±Ø±Ø³ÛŒ payload
                        if (payload.sub !== userId) {
                            return `Ø´Ù†Ø§Ø³Ù‡ Ú©Ø§Ø±Ø¨Ø± Ù†Ø§Ø¯Ø±Ø³Øª. Ù…ÙˆØ±Ø¯ Ø§Ù†ØªØ¸Ø§Ø±: ${userId}, Ø¯Ø±ÛŒØ§ÙØª: ${payload.sub}`;
                        }
                        
                        if (!payload.iat || !payload.exp) {
                            return 'Ø²Ù…Ø§Ù†â€ŒÙ‡Ø§ÛŒ iat ÛŒØ§ exp ÙˆØ¬ÙˆØ¯ Ù†Ø¯Ø§Ø±Ù†Ø¯';
                        }
                        
                        if (payload.role !== 'user') {
                            return `Ù†Ù‚Ø´ Ù†Ø§Ø¯Ø±Ø³Øª. Ù…ÙˆØ±Ø¯ Ø§Ù†ØªØ¸Ø§Ø±: user, Ø¯Ø±ÛŒØ§ÙØª: ${payload.role}`;
                        }
                        
                        // Ø§Ø¹ØªØ¨Ø§Ø±Ø³Ù†Ø¬ÛŒ ØªÙˆÚ©Ù†
                        if (!auth._isTokenValid(token)) {
                            return 'ØªÙˆÚ©Ù† Ù…Ø¹ØªØ¨Ø± Ø´Ù†Ø§Ø³Ø§ÛŒÛŒ Ù†Ø´Ø¯';
                        }
                        
                        // ØªÙˆÚ©Ù† Ù…Ù†Ù‚Ø¶ÛŒ Ø´Ø¯Ù‡ (Ø´Ø¨ÛŒÙ‡â€ŒØ³Ø§Ø²ÛŒ)
                        const expiredToken = auth._generateToken(userId, -1); // Ø§Ù†Ù‚Ø¶Ø§ Ø¯Ø± Ú¯Ø°Ø´ØªÙ‡
                        if (auth._isTokenValid(expiredToken)) {
                            return 'ØªÙˆÚ©Ù† Ù…Ù†Ù‚Ø¶ÛŒ Ø´Ø¯Ù‡ Ø¨Ù‡ Ø¹Ù†ÙˆØ§Ù† Ù…Ø¹ØªØ¨Ø± Ø´Ù†Ø§Ø³Ø§ÛŒÛŒ Ø´Ø¯';
                        }
                        
                        // ØªÙˆÚ©Ù† Ù†Ø§Ù…Ø¹ØªØ¨Ø±
                        if (auth._isTokenValid('invalid.token.here')) {
                            return 'ØªÙˆÚ©Ù† Ù†Ø§Ù…Ø¹ØªØ¨Ø± Ø¨Ù‡ Ø¹Ù†ÙˆØ§Ù† Ù…Ø¹ØªØ¨Ø± Ø´Ù†Ø§Ø³Ø§ÛŒÛŒ Ø´Ø¯';
                        }
                        
                        return true;
                    }
                },
                {
                    name: 'ØªÙˆÚ©Ù†â€ŒÙ‡Ø§ÛŒ ÛŒÚ©Ø³Ø§Ù† Ù†Ø¨Ø§Ø´Ù†Ø¯',
                    description: 'Ù‡Ø± Ø¨Ø§Ø± login Ø¨Ø§ÛŒØ¯ ØªÙˆÚ©Ù† Ø¬Ø¯ÛŒØ¯ ØªÙˆÙ„ÛŒØ¯ Ú©Ù†Ø¯',
                    category: 'security',
                    fn: async () => {
                        const auth = new AuthService();
                        const storage = new MockStorage();
                        auth.storage = storage;
                        
                        // Login Ø§ÙˆÙ„
                        await auth.login('test@example.com', 'Password123!');
                        const token1 = await storage.getItem('auth_token');
                        
                        // Logout
                        await auth.logout();
                        
                        // Login Ø¯ÙˆÙ…
                        await auth.login('test@example.com', 'Password123!');
                        const token2 = await storage.getItem('auth_token');
                        
                        // ØªÙˆÚ©Ù†â€ŒÙ‡Ø§ Ù†Ø¨Ø§ÛŒØ¯ ÛŒÚ©Ø³Ø§Ù† Ø¨Ø§Ø´Ù†Ø¯
                        if (token1 === token2) {
                            return 'ØªÙˆÚ©Ù†â€ŒÙ‡Ø§ÛŒ Ù…Ø®ØªÙ„Ù login ÛŒÚ©Ø³Ø§Ù† Ù‡Ø³ØªÙ†Ø¯ (Ø§Ù…Ù†ÛŒØª Ù¾Ø§ÛŒÛŒÙ†)';
                        }
                        
                        return true;
                    }
                }
            ],
            authFlow: [
                {
                    name: 'Ø«Ø¨Øªâ€ŒÙ†Ø§Ù… Ù…ÙˆÙÙ‚',
                    description: 'Ú©Ø§Ø±Ø¨Ø± Ø¬Ø¯ÛŒØ¯ Ø¨Ø§ÛŒØ¯ Ø¨ØªÙˆØ§Ù†Ø¯ Ø«Ø¨Øªâ€ŒÙ†Ø§Ù… Ú©Ù†Ø¯',
                    category: 'authFlow',
                    fn: async () => {
                        const auth = new AuthService();
                        
                        const result = await auth.register({
                            email: 'newuser@example.com',
                            password: 'SecurePass123',
                            username: 'newuser'
                        });
                        
                        if (!result.success) {
                            return `Ø«Ø¨Øªâ€ŒÙ†Ø§Ù… Ù†Ø§Ù…ÙˆÙÙ‚: ${result.message || 'Unknown error'}`;
                        }
                        
                        if (!result.userId || !result.userId.startsWith('user-')) {
                            return `Ø´Ù†Ø§Ø³Ù‡ Ú©Ø§Ø±Ø¨Ø± Ù†Ø§Ù…Ø¹ØªØ¨Ø±: ${result.userId}`;
                        }
                        
                        return true;
                    }
                },
                {
                    name: 'Ø«Ø¨Øªâ€ŒÙ†Ø§Ù… Ø¨Ø§ Ø§ÛŒÙ…ÛŒÙ„ Ù†Ø§Ù…Ø¹ØªØ¨Ø±',
                    description: 'Ø«Ø¨Øªâ€ŒÙ†Ø§Ù… Ø¨Ø§ Ø§ÛŒÙ…ÛŒÙ„ Ù†Ø§Ù…Ø¹ØªØ¨Ø± Ø¨Ø§ÛŒØ¯ Ø®Ø·Ø§ Ø¯Ù‡Ø¯',
                    category: 'authFlow',
                    fn: async () => {
                        const auth = new AuthService();
                        
                        try {
                            await auth.register({
                                email: 'invalid-email',
                                password: 'SecurePass123',
                                username: 'testuser'
                            });
                            return 'Ø«Ø¨Øªâ€ŒÙ†Ø§Ù… Ø¨Ø§ Ø§ÛŒÙ…ÛŒÙ„ Ù†Ø§Ù…Ø¹ØªØ¨Ø± Ø¨Ø§ÛŒØ¯ Ø®Ø·Ø§ Ø¯Ù‡Ø¯';
                        } catch (error) {
                            if (!error.message.includes('Ø§ÛŒÙ…ÛŒÙ„')) {
                                return `Ø®Ø·Ø§ÛŒ Ù†Ø§Ù…Ù†ØªØ¸Ø±Ù‡: ${error.message}`;
                            }
                            return true;
                        }
                    }
                },
                {
                    name: 'Ù„Ø§Ú¯ÛŒÙ† Ù…ÙˆÙÙ‚',
                    description: 'Ú©Ø§Ø±Ø¨Ø± Ù…ÙˆØ¬ÙˆØ¯ Ø¨Ø§ÛŒØ¯ Ø¨ØªÙˆØ§Ù†Ø¯ ÙˆØ§Ø±Ø¯ Ø´ÙˆØ¯',
                    category: 'authFlow',
                    fn: async () => {
                        const auth = new AuthService();
                        const storage = new MockStorage();
                        auth.storage = storage;
                        
                        const result = await auth.login('test@example.com', 'Password123!');
                        
                        if (!result.success) {
                            return `Ù„Ø§Ú¯ÛŒÙ† Ù†Ø§Ù…ÙˆÙÙ‚: ${result.message || 'Unknown error'}`;
                        }
                        
                        if (!result.token) {
                            return 'ØªÙˆÚ©Ù† Ø¯Ø± Ù¾Ø§Ø³Ø® ÙˆØ¬ÙˆØ¯ Ù†Ø¯Ø§Ø±Ø¯';
                        }
                        
                        if (!result.user) {
                            return 'Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ú©Ø§Ø±Ø¨Ø± Ø¯Ø± Ù¾Ø§Ø³Ø® ÙˆØ¬ÙˆØ¯ Ù†Ø¯Ø§Ø±Ø¯';
                        }
                        
                        // Ø¨Ø±Ø±Ø³ÛŒ Ø°Ø®ÛŒØ±Ù‡â€ŒØ³Ø§Ø²ÛŒ
                        const storedToken = await storage.getItem('auth_token');
                        const storedUser = await storage.getItem('user_data');
                        
                        if (storedToken !== result.token) {
                            return 'ØªÙˆÚ©Ù† Ø¯Ø± storage Ø°Ø®ÛŒØ±Ù‡ Ù†Ø´Ø¯Ù‡';
                        }
                        
                        if (!storedUser) {
                            return 'Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ú©Ø§Ø±Ø¨Ø± Ø¯Ø± storage Ø°Ø®ÛŒØ±Ù‡ Ù†Ø´Ø¯Ù‡';
                        }
                        
                        // Ø¨Ø±Ø±Ø³ÛŒ ÙˆØ¶Ø¹ÛŒØª Ú©Ø§Ø±Ø¨Ø±
                        const currentUser = await auth.getCurrentUser();
                        if (!currentUser || currentUser.email !== 'test@example.com') {
                            return 'Ú©Ø§Ø±Ø¨Ø± Ø¬Ø§Ø±ÛŒ Ø¨Ù‡ Ø¯Ø±Ø³ØªÛŒ ØªÙ†Ø¸ÛŒÙ… Ù†Ø´Ø¯Ù‡';
                        }
                        
                        if (!auth.isAuthenticated()) {
                            return 'ÙˆØ¶Ø¹ÛŒØª authenticated Ø¨Ù‡ Ø¯Ø±Ø³ØªÛŒ ØªÙ†Ø¸ÛŒÙ… Ù†Ø´Ø¯Ù‡';
                        }
                        
                        return true;
                    }
                },
                {
                    name: 'Ù„Ø§Ú¯ÛŒÙ† Ø¨Ø§ Ø±Ù…Ø² Ø¹Ø¨ÙˆØ± Ù†Ø§Ø¯Ø±Ø³Øª',
                    description: 'Ù„Ø§Ú¯ÛŒÙ† Ø¨Ø§ Ø±Ù…Ø² Ø¹Ø¨ÙˆØ± Ù†Ø§Ø¯Ø±Ø³Øª Ø¨Ø§ÛŒØ¯ Ø®Ø·Ø§ Ø¯Ù‡Ø¯',
                    category: 'authFlow',
                    fn: async () => {
                        const auth = new AuthService();
                        
                        try {
                            await auth.login('test@example.com', 'WrongPassword!');
                            return 'Ù„Ø§Ú¯ÛŒÙ† Ø¨Ø§ Ø±Ù…Ø² Ø¹Ø¨ÙˆØ± Ù†Ø§Ø¯Ø±Ø³Øª Ø¨Ø§ÛŒØ¯ Ø®Ø·Ø§ Ø¯Ù‡Ø¯';
                        } catch (error) {
                            if (!error.message.includes('Ø§ÛŒÙ…ÛŒÙ„ ÛŒØ§ Ø±Ù…Ø² Ø¹Ø¨ÙˆØ±')) {
                                return `Ø®Ø·Ø§ÛŒ Ù†Ø§Ù…Ù†ØªØ¸Ø±Ù‡: ${error.message}`;
                            }
                            return true;
                        }
                    }
                },
                {
                    name: 'Ù„Ø§Ú¯Ø§ÙˆØª Ú©Ø§Ù…Ù„',
                    description: 'Ù„Ø§Ú¯Ø§ÙˆØª Ø¨Ø§ÛŒØ¯ ØªÙ…Ø§Ù… Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ Ø±Ø§ Ù¾Ø§Ú© Ú©Ù†Ø¯',
                    category: 'authFlow',
                    fn: async () => {
                        const auth = new AuthService();
                        const storage = new MockStorage();
                        auth.storage = storage;
                        
                        // Ø§ÙˆÙ„ Ù„Ø§Ú¯ÛŒÙ† Ú©Ù†ÛŒÙ…
                        await auth.login('test@example.com', 'Password123!');
                        
                        // Ø¨Ø±Ø±Ø³ÛŒ Ù„Ø§Ú¯ÛŒÙ† Ù…ÙˆÙÙ‚
                        if (!auth.isAuthenticated()) {
                            return 'Ú©Ø§Ø±Ø¨Ø± Ø¨Ø§ÛŒØ¯ Ù„Ø§Ú¯ÛŒÙ† Ø¨Ø§Ø´Ø¯';
                        }
                        
                        // Ù„Ø§Ú¯Ø§ÙˆØª
                        await auth.logout();
                        
                        // Ø¨Ø±Ø±Ø³ÛŒ Ù¾Ø§Ú© Ø´Ø¯Ù† Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§
                        const token = await storage.getItem('auth_token');
                        const userData = await storage.getItem('user_data');
                        
                        if (token !== null) {
                            return 'ØªÙˆÚ©Ù† Ø¨Ø¹Ø¯ Ø§Ø² Ù„Ø§Ú¯Ø§ÙˆØª Ù¾Ø§Ú© Ù†Ø´Ø¯Ù‡';
                        }
                        
                        if (userData !== null) {
                            return 'Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ú©Ø§Ø±Ø¨Ø± Ø¨Ø¹Ø¯ Ø§Ø² Ù„Ø§Ú¯Ø§ÙˆØª Ù¾Ø§Ú© Ù†Ø´Ø¯Ù‡';
                        }
                        
                        if (auth.isAuthenticated()) {
                            return 'ÙˆØ¶Ø¹ÛŒØª authenticated Ø¨Ø¹Ø¯ Ø§Ø² Ù„Ø§Ú¯Ø§ÙˆØª true Ø§Ø³Øª';
                        }
                        
                        if (auth.currentUser !== null) {
                            return 'currentUser Ø¨Ø¹Ø¯ Ø§Ø² Ù„Ø§Ú¯Ø§ÙˆØª null Ù†ÛŒØ³Øª';
                        }
                        
                        return true;
                    }
                },
                {
                    name: 'Ø°Ø®ÛŒØ±Ù‡â€ŒØ³Ø§Ø²ÛŒ Ø¢ÙÙ„Ø§ÛŒÙ†',
                    description: 'Ú©Ø§Ø±Ø¨Ø± Ø¨Ø§ÛŒØ¯ Ø¨Ø¹Ø¯ Ø§Ø² Ø¨Ø³ØªÙ‡ Ø´Ø¯Ù† ØµÙØ­Ù‡ Ù‡Ù… Ù„Ø§Ú¯ÛŒÙ† Ø¨Ù…Ø§Ù†Ø¯',
                    category: 'authFlow',
                    fn: async () => {
                        const storage = new MockStorage();
                        
                        // Auth instance Ø§ÙˆÙ„
                        const auth1 = new AuthService(storage);
                        await auth1.login('test@example.com', 'Password123!');
                        
                        // Ø´Ø¨ÛŒÙ‡â€ŒØ³Ø§Ø²ÛŒ Ø¨Ø³ØªÙ‡ Ø´Ø¯Ù† ØµÙØ­Ù‡ (Ø§ÛŒØ¬Ø§Ø¯ instance Ø¬Ø¯ÛŒØ¯)
                        const auth2 = new AuthService(storage);
                        
                        // Ú©Ø§Ø±Ø¨Ø± Ø¨Ø§ÛŒØ¯ Ù„Ø§Ú¯ÛŒÙ† Ø¨Ø§Ø´Ø¯
                        const user = await auth2.getCurrentUser();
                        if (!user || user.email !== 'test@example.com') {
                            return 'Ú©Ø§Ø±Ø¨Ø± Ø¨Ø¹Ø¯ Ø§Ø² Ø§ÛŒØ¬Ø§Ø¯ instance Ø¬Ø¯ÛŒØ¯ Ù„Ø§Ú¯ÛŒÙ† Ù†ÛŒØ³Øª';
                        }
                        
                        if (!auth2.isAuthenticated()) {
                            return 'ÙˆØ¶Ø¹ÛŒØª authenticated Ø¨Ø¹Ø¯ Ø§Ø² Ø§ÛŒØ¬Ø§Ø¯ instance Ø¬Ø¯ÛŒØ¯ false Ø§Ø³Øª';
                        }
                        
                        return true;
                    }
                }
            ],
            tokenManagement: [
                {
                    name: 'ØªÙ…Ø¯ÛŒØ¯ Ø®ÙˆØ¯Ú©Ø§Ø± ØªÙˆÚ©Ù†',
                    description: 'Ø³ÛŒØ³ØªÙ… Ø¨Ø§ÛŒØ¯ Ø¨Ù‡ ØµÙˆØ±Øª Ø®ÙˆØ¯Ú©Ø§Ø± ØªÙˆÚ©Ù† Ø±Ø§ ØªÙ…Ø¯ÛŒØ¯ Ú©Ù†Ø¯',
                    category: 'tokenManagement',
                    fn: async () => {
                        const auth = new AuthService();
                        const storage = new MockStorage();
                        auth.storage = storage;
                        
                        let refreshCalled = false;
                        
                        // Mock Ú©Ø±Ø¯Ù† ØªØ§Ø¨Ø¹ refreshToken
                        const originalRefresh = auth.refreshToken.bind(auth);
                        auth.refreshToken = async () => {
                            refreshCalled = true;
                            return { success: true, token: 'new-token-' + Date.now() };
                        };
                        
                        // Ù„Ø§Ú¯ÛŒÙ†
                        await auth.login('test@example.com', 'Password123!');
                        
                        // Ø°Ø®ÛŒØ±Ù‡ Ø²Ù…Ø§Ù† Ø´Ø±ÙˆØ¹
                        const startTime = Date.now();
                        
                        // ØµØ¨Ø± Ø¨Ø±Ø§ÛŒ ØªÙ…Ø¯ÛŒØ¯ (Ø¯Ø± ÙˆØ§Ù‚Ø¹ÛŒØª 55 Ø¯Ù‚ÛŒÙ‚Ù‡ØŒ Ø§Ù…Ø§ Ø¨Ø±Ø§ÛŒ ØªØ³Øª Ú©Ù…ØªØ±)
                        return new Promise((resolve) => {
                            setTimeout(() => {
                                if (!refreshCalled) {
                                    resolve('ØªÙ…Ø¯ÛŒØ¯ Ø®ÙˆØ¯Ú©Ø§Ø± ØªÙˆÚ©Ù† Ø§Ù†Ø¬Ø§Ù… Ù†Ø´Ø¯');
                                } else {
                                    resolve(true);
                                }
                            }, 100);
                        });
                    }
                },
                {
                    name: 'Ø¯Ø±ÛŒØ§ÙØª Ú©Ø§Ø±Ø¨Ø± Ø§Ø² storage',
                    description: 'Ø¨Ø§Ø²ÛŒØ§Ø¨ÛŒ Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ú©Ø§Ø±Ø¨Ø± Ø§Ø² storage',
                    category: 'tokenManagement',
                    fn: async () => {
                        const storage = new MockStorage();
                        
                        // Ø°Ø®ÛŒØ±Ù‡ Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ÛŒ Ú©Ø§Ø±Ø¨Ø±
                        const mockUser = {
                            id: 'test-user-123',
                            email: 'test@example.com',
                            name: 'Ú©Ø§Ø±Ø¨Ø± ØªØ³Øª'
                        };
                        
                        await storage.setItem('user_data', JSON.stringify(mockUser));
                        await storage.setItem('auth_token', 'valid.jwt.token');
                        
                        // Ø§ÛŒØ¬Ø§Ø¯ Auth instance Ø¬Ø¯ÛŒØ¯
                        const auth = new AuthService(storage);
                        
                        // Ø¯Ø±ÛŒØ§ÙØª Ú©Ø§Ø±Ø¨Ø±
                        const user = await auth.getCurrentUser();
                        
                        if (!user) {
                            return 'Ú©Ø§Ø±Ø¨Ø± Ø¨Ø§Ø²ÛŒØ§Ø¨ÛŒ Ù†Ø´Ø¯';
                        }
                        
                        if (user.id !== mockUser.id) {
                            return `Ø´Ù†Ø§Ø³Ù‡ Ú©Ø§Ø±Ø¨Ø± Ù†Ø§Ø¯Ø±Ø³Øª. Ù…ÙˆØ±Ø¯ Ø§Ù†ØªØ¸Ø§Ø±: ${mockUser.id}, Ø¯Ø±ÛŒØ§ÙØª: ${user.id}`;
                        }
                        
                        if (user.email !== mockUser.email) {
                            return `Ø§ÛŒÙ…ÛŒÙ„ Ú©Ø§Ø±Ø¨Ø± Ù†Ø§Ø¯Ø±Ø³Øª. Ù…ÙˆØ±Ø¯ Ø§Ù†ØªØ¸Ø§Ø±: ${mockUser.email}, Ø¯Ø±ÛŒØ§ÙØª: ${user.email}`;
                        }
                        
                        return true;
                    }
                },
                {
                    name: 'Ù…Ø¯ÛŒØ±ÛŒØª Ø­Ø§Ù„Øª Ø¢ÙÙ„Ø§ÛŒÙ†',
                    description: 'Ø¹Ù…Ù„Ú©Ø±Ø¯ ØµØ­ÛŒØ­ Ø¯Ø± Ø­Ø§Ù„Øª Ø¢ÙÙ„Ø§ÛŒÙ†',
                    category: 'tokenManagement',
                    fn: async () => {
                        const auth = new AuthService();
                        
                        // Ø­Ø§Ù„Øª Ø¢ÙÙ„Ø§ÛŒÙ†
                        auth.setOnlineStatus(false);
                        
                        try {
                            await auth.login('test@example.com', 'Password123!');
                            return 'Ù„Ø§Ú¯ÛŒÙ† Ø¯Ø± Ø­Ø§Ù„Øª Ø¢ÙÙ„Ø§ÛŒÙ† Ø¨Ø§ÛŒØ¯ Ø®Ø·Ø§ Ø¯Ù‡Ø¯';
                        } catch (error) {
                            if (!error.message.includes('Ø§ØªØµØ§Ù„ Ø§ÛŒÙ†ØªØ±Ù†Øª')) {
                                return `Ø®Ø·Ø§ÛŒ Ù†Ø§Ù…Ù†ØªØ¸Ø±Ù‡ Ø¯Ø± Ø­Ø§Ù„Øª Ø¢ÙÙ„Ø§ÛŒÙ†: ${error.message}`;
                            }
                            
                            // Ø¨Ø§Ø²Ú¯Ø´Øª Ø¨Ù‡ Ø­Ø§Ù„Øª Ø¢Ù†Ù„Ø§ÛŒÙ†
                            auth.setOnlineStatus(true);
                            
                            // Ø­Ø§Ù„Ø§ Ø¨Ø§ÛŒØ¯ Ú©Ø§Ø± Ú©Ù†Ø¯
                            try {
                                await auth.login('test@example.com', 'Password123!');
                                return true;
                            } catch (loginError) {
                                return `Ù„Ø§Ú¯ÛŒÙ† Ø¯Ø± Ø­Ø§Ù„Øª Ø¢Ù†Ù„Ø§ÛŒÙ† Ù†Ø§Ù…ÙˆÙÙ‚: ${loginError.message}`;
                            }
                        }
                    }
                }
            ],
            events: [
                {
                    name: 'Ø±ÙˆÛŒØ¯Ø§Ø¯Ù‡Ø§ÛŒ auth',
                    description: 'Ø±ÙˆÛŒØ¯Ø§Ø¯Ù‡Ø§ÛŒ loginØŒ logout Ùˆ error Ø¨Ø§ÛŒØ¯ ÙØ±Ø§Ø®ÙˆØ§Ù†ÛŒ Ø´ÙˆÙ†Ø¯',
                    category: 'events',
                    fn: async () => {
                        const auth = new AuthService();
                        const storage = new MockStorage();
                        auth.storage = storage;
                        
                        let loginEventCalled = false;
                        let logoutEventCalled = false;
                        let errorEventCalled = false;
                        
                        // Ø«Ø¨Øª listeners
                        auth.on(auth.events.LOGIN, () => {
                            loginEventCalled = true;
                        });
                        
                        auth.on(auth.events.LOGOUT, () => {
                            logoutEventCalled = true;
                        });
                        
                        auth.on(auth.events.ERROR, () => {
                            errorEventCalled = true;
                        });
                        
                        // ØªØ³Øª Ù„Ø§Ú¯ÛŒÙ† Ù…ÙˆÙÙ‚
                        await auth.login('test@example.com', 'Password123!');
                        
                        if (!loginEventCalled) {
                            return 'Ø±ÙˆÛŒØ¯Ø§Ø¯ LOGIN ÙØ±Ø§Ø®ÙˆØ§Ù†ÛŒ Ù†Ø´Ø¯';
                        }
                        
                        // ØªØ³Øª Ù„Ø§Ú¯Ø§ÙˆØª
                        await auth.logout();
                        
                        if (!logoutEventCalled) {
                            return 'Ø±ÙˆÛŒØ¯Ø§Ø¯ LOGOUT ÙØ±Ø§Ø®ÙˆØ§Ù†ÛŒ Ù†Ø´Ø¯';
                        }
                        
                        // ØªØ³Øª Ø®Ø·Ø§ (Ù„Ø§Ú¯ÛŒÙ† Ø¨Ø§ Ø±Ù…Ø² Ø¹Ø¨ÙˆØ± Ù†Ø§Ø¯Ø±Ø³Øª)
                        try {
                            await auth.login('test@example.com', 'WrongPassword');
                        } catch (error) {
                            // Ø®Ø·Ø§ Ø§Ù†ØªØ¸Ø§Ø± Ù…ÛŒâ€ŒØ±ÙˆØ¯
                        }
                        
                        if (!errorEventCalled) {
                            return 'Ø±ÙˆÛŒØ¯Ø§Ø¯ ERROR ÙØ±Ø§Ø®ÙˆØ§Ù†ÛŒ Ù†Ø´Ø¯';
                        }
                        
                        return true;
                    }
                }
            ]
        };

        // ==================== Test Runner ====================
        let allTests = [];
        Object.values(testSuites).forEach(suite => {
            allTests = allTests.concat(suite);
        });

        let testResults = [];
        let startTime = null;

        function logToConsole(type, message) {
            const consoleOutput = document.getElementById('consoleOutput');
            const timestamp = new Date().toLocaleTimeString('fa-IR');
            const line = document.createElement('div');
            line.className = `console-line console-${type}`;
            line.innerHTML = `${message} <span class="console-timestamp">[${timestamp}]</span>`;
            consoleOutput.appendChild(line);
            consoleOutput.scrollTop = consoleOutput.scrollHeight;
        }

        function updateStats() {
            const passed = testResults.filter(r => r && r.success).length;
            const failed = testResults.filter(r => r && !r.success).length;
            const total = allTests.length;
            
            document.getElementById('passedTests').textContent = passed;
            document.getElementById('failedTests').textContent = failed;
            document.getElementById('totalTests').textContent = total;
            
            const progress = total > 0 ? Math.round((passed / total) * 100) : 0;
            document.getElementById('progressFill').style.width = `${progress}%`;
            document.getElementById('progressPercent').textContent = `${progress}%`;
            
            if (startTime) {
                const duration = ((Date.now() - startTime) / 1000).toFixed(2);
                document.getElementById('duration').textContent = duration;
                document.getElementById('lastRunTime').textContent = `${duration} Ø«Ø§Ù†ÛŒÙ‡ Ù¾ÛŒØ´`;
            }
        }

        function createTestElement(test, index, result = null) {
            const testItem = document.createElement('div');
            testItem.className = `test-item ${result ? (result.success ? 'passing' : 'failing') : 'pending'}`;
            testItem.id = `test-${index}`;
            
            const header = document.createElement('div');
            header.className = 'test-header';
            
            const name = document.createElement('div');
            name.className = 'test-name';
            name.textContent = `${index + 1}. ${test.name}`;
            
            const status = document.createElement('div');
            status.className = `test-status ${result ? (result.success ? 'status-pass' : 'status-fail') : 'status-pending'}`;
            status.textContent = result ? (result.success ? 'âœ…' : 'âŒ') : 'â³';
            
            header.appendChild(name);
            header.appendChild(status);
            testItem.appendChild(header);
            
            const description = document.createElement('div');
            description.className = 'test-description';
            description.textContent = test.description;
            testItem.appendChild(description);
            
            if (result) {
                const toggleBtn = document.createElement('button');
                toggleBtn.className = 'toggle-details';
                toggleBtn.textContent = 'Ù†Ù…Ø§ÛŒØ´ Ø¬Ø²Ø¦ÛŒØ§Øª';
                toggleBtn.onclick = () => {
                    testItem.classList.toggle('expanded');
                    toggleBtn.textContent = testItem.classList.contains('expanded') ? 'Ù¾Ù†Ù‡Ø§Ù† Ú©Ø±Ø¯Ù†' : 'Ù†Ù…Ø§ÛŒØ´ Ø¬Ø²Ø¦ÛŒØ§Øª';
                };
                testItem.appendChild(toggleBtn);
                
                const details = document.createElement('div');
                details.className = 'test-details';
                
                let detailsText = `Ø¯Ø³ØªÙ‡: ${test.category}\n`;
                detailsText += `Ø²Ù…Ø§Ù† Ø§Ø¬Ø±Ø§: ${result.duration || 0}ms\n`;
                
                if (result.success) {
                    detailsText += '\nâœ… ØªØ³Øª Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ú¯Ø°Ø´Øª';
                } else {
                    detailsText += `\nâŒ ØªØ³Øª Ù†Ø§Ù…ÙˆÙÙ‚\n`;
                    if (result.error) {
                        detailsText += `Ø®Ø·Ø§: ${result.error.message}\n`;
                        if (result.error.stack) {
                            detailsText += `Stack Trace:\n${result.error.stack}`;
                        }
                    } else if (result.message) {
                        detailsText += `Ù¾ÛŒØ§Ù…: ${result.message}`;
                    }
                }
                
                details.textContent = detailsText;
                testItem.appendChild(details);
            }
            
            return testItem;
        }

        function renderTestCategories() {
            const container = document.getElementById('testResults');
            container.innerHTML = '';
            
            Object.entries(testSuites).forEach(([category, tests]) => {
                const categoryDiv = document.createElement('div');
                categoryDiv.className = 'test-category';
                
                const title = document.createElement('div');
                title.className = 'category-title';
                
                // Ø¢ÛŒÚ©ÙˆÙ† Ø¨Ø± Ø§Ø³Ø§Ø³ Ø¯Ø³ØªÙ‡
                let icon = 'ğŸ“‹';
                if (category === 'security') icon = 'ğŸ”’';
                if (category === 'authFlow') icon = 'ğŸ”„';
                if (category === 'tokenManagement') icon = 'ğŸ”„';
                if (category === 'events') icon = 'ğŸ””';
                
                title.innerHTML = `${icon} ${getCategoryName(category)} (${tests.length} ØªØ³Øª)`;
                categoryDiv.appendChild(title);
                
                const testList = document.createElement('div');
                testList.className = 'test-list';
                
                tests.forEach((test, index) => {
                    const globalIndex = allTests.findIndex(t => t === test);
                    const result = testResults[globalIndex];
                    testList.appendChild(createTestElement(test, globalIndex, result));
                });
                
                categoryDiv.appendChild(testList);
                container.appendChild(categoryDiv);
            });
        }

        function getCategoryName(category) {
            const names = {
                validation: 'Ø§Ø¹ØªØ¨Ø§Ø±Ø³Ù†Ø¬ÛŒ',
                security: 'Ø§Ù…Ù†ÛŒØª',
                authFlow: 'Ø¬Ø±ÛŒØ§Ù† Ø§Ø­Ø±Ø§Ø² Ù‡ÙˆÛŒØª',
                tokenManagement: 'Ù…Ø¯ÛŒØ±ÛŒØª ØªÙˆÚ©Ù†',
                events: 'Ø±ÙˆÛŒØ¯Ø§Ø¯Ù‡Ø§'
            };
            return names[category] || category;
        }

        async function runTest(test, index) {
            const startTime = Date.now();
            
            try {
                const result = await test.fn();
                const duration = Date.now() - startTime;
                
                if (result === true) {
                    testResults[index] = {
                        success: true,
                        duration,
                        test: test.name
                    };
                    logToConsole('success', `âœ… "${test.name}" - Ù…ÙˆÙÙ‚ (${duration}ms)`);
                } else {
                    testResults[index] = {
                        success: false,
                        duration,
                        message: result,
                        test: test.name
                    };
                    logToConsole('error', `âŒ "${test.name}" - Ù†Ø§Ù…ÙˆÙÙ‚: ${result}`);
                }
            } catch (error) {
                const duration = Date.now() - startTime;
                testResults[index] = {
                    success: false,
                    duration,
                    error: error,
                    test: test.name
                };
                logToConsole('error', `âŒ "${test.name}" - Ø®Ø·Ø§: ${error.message}`);
            }
            
            renderTestCategories();
            updateStats();
            
            return testResults[index];
        }

        async function runAllTests() {
            startTime = Date.now();
            testResults = new Array(allTests.length);
            
            logToConsole('info', 'ğŸš€ Ø´Ø±ÙˆØ¹ Ø§Ø¬Ø±Ø§ÛŒ Ù‡Ù…Ù‡ ØªØ³Øªâ€ŒÙ‡Ø§...');
            
            for (let i = 0; i < allTests.length; i++) {
                await runTest(allTests[i], i);
                await new Promise(resolve => setTimeout(resolve, 50)); // ØªØ§Ø®ÛŒØ± Ú©ÙˆÚ†Ú©
            }
            
            const passed = testResults.filter(r => r && r.success).length;
            const total = allTests.length;
            
            logToConsole('info', `ğŸ“Š Ù¾Ø§ÛŒØ§Ù† Ø§Ø¬Ø±Ø§ÛŒ ØªØ³Øªâ€ŒÙ‡Ø§: ${passed} Ø§Ø² ${total} ØªØ³Øª Ù…ÙˆÙÙ‚`);
            
            if (passed === total) {
                logToConsole('success', 'ğŸ‰ Ù‡Ù…Ù‡ ØªØ³Øªâ€ŒÙ‡Ø§ÛŒ Auth Service Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ú¯Ø°Ø´ØªÙ†Ø¯!');
            } else {
                logToConsole('warning', `âš ï¸ ${total - passed} ØªØ³Øª Ù†Ø§Ù…ÙˆÙÙ‚ Ø¨ÙˆØ¯Ù†Ø¯`);
            }
        }

        async function runCategoryTests(category) {
            startTime = Date.now();
            
            logToConsole('info', `ğŸƒ Ø´Ø±ÙˆØ¹ Ø§Ø¬Ø±Ø§ÛŒ ØªØ³Øªâ€ŒÙ‡Ø§ÛŒ ${getCategoryName(category)}...`);
            
            const categoryTests = testSuites[category] || [];
            for (const test of categoryTests) {
                const index = allTests.findIndex(t => t === test);
                if (index !== -1) {
                    await runTest(test, index);
                    await new Promise(resolve => setTimeout(resolve, 50));
                }
            }
            
            logToConsole('info', `âœ… Ø§Ø¬Ø±Ø§ÛŒ ØªØ³Øªâ€ŒÙ‡Ø§ÛŒ ${getCategoryName(category)} Ú©Ø§Ù…Ù„ Ø´Ø¯`);
        }

        function resetTests() {
            testResults = new Array(allTests.length);
            startTime = null;
            
            logToConsole('info', 'ğŸ”„ Ù‡Ù…Ù‡ ØªØ³Øªâ€ŒÙ‡Ø§ Ø¨Ø§Ø²Ù†Ø´Ø§Ù†ÛŒ Ø´Ø¯Ù†Ø¯');
            renderTestCategories();
            updateStats();
        }

        // Ù…Ù‚Ø¯Ø§Ø±Ø¯Ù‡ÛŒ Ø§ÙˆÙ„ÛŒÙ‡
        renderTestCategories();
        updateStats();
        logToConsole('info', 'Ø³ÛŒØ³ØªÙ… ØªØ³Øª Auth Service Ø¨Ø§Ø±Ú¯ÛŒØ±ÛŒ Ø´Ø¯. Ø¨Ø±Ø§ÛŒ Ø´Ø±ÙˆØ¹ Ø¯Ú©Ù…Ù‡ "Ø§Ø¬Ø±Ø§ÛŒ Ù‡Ù…Ù‡ ØªØ³Øªâ€ŒÙ‡Ø§" Ø±Ø§ Ø¨Ø²Ù†ÛŒØ¯.');
    </script>
</body>
  </html>
