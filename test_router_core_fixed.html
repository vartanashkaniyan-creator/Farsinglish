<!DOCTYPE html>
<html lang="fa">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Farsinglish - ØªØ³Øª Ù‡Ø³ØªÙ‡ Ù…Ø³ÛŒØ±ÛŒØ§Ø¨ÛŒ (Ø§ØµÙ„Ø§Ø­â€ŒØ´Ø¯Ù‡)</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif;
            background: linear-gradient(135deg, #0d47a1 0%, #1976d2 100%);
            color: #e3f2fd;
            min-height: 100vh;
            padding: 15px;
        }
        .container { 
            max-width: 800px; 
            margin: 0 auto;
            background: rgba(25, 35, 70, 0.95);
            border-radius: 12px;
            padding: 18px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.6);
            border: 1px solid rgba(100, 150, 255, 0.4);
        }
        h1 { 
            text-align: center; 
            margin-bottom: 20px;
            font-size: 1.6rem;
            color: #82b1ff;
        }
        .test-section { 
            margin: 15px 0;
            padding: 14px;
            background: rgba(40, 45, 80, 0.9);
            border-radius: 8px;
            border-left: 4px solid #4fc3f7;
        }
        .test-header { 
            display: flex; 
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        .test-title { 
            font-size: 0.95rem; 
            font-weight: 600;
            color: #bb86fc;
        }
        .test-result { 
            padding: 4px 10px;
            border-radius: 10px;
            font-size: 0.8rem;
            font-weight: bold;
        }
        .pass { background: #4caf50; }
        .fail { background: #f44336; }
        .details { 
            margin-top: 8px;
            padding: 10px;
            background: rgba(0, 0, 30, 0.7);
            border-radius: 6px;
            font-family: monospace;
            font-size: 0.8rem;
            color: #a5d6a7;
        }
        .summary {
            margin-top: 20px;
            padding: 15px;
            background: rgba(40, 45, 80, 0.9);
            border-radius: 8px;
            text-align: center;
            font-size: 0.95rem;
        }
        button {
            background: #2962ff;
            color: white;
            border: none;
            padding: 8px 18px;
            border-radius: 6px;
            font-size: 0.85rem;
            cursor: pointer;
            margin: 5px;
        }
        .controls { text-align: center; margin-top: 15px; }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ§­ ØªØ³Øª Ù‡Ø³ØªÙ‡ Ù…Ø³ÛŒØ±ÛŒØ§Ø¨ÛŒ (Ø§ØµÙ„Ø§Ø­â€ŒØ´Ø¯Ù‡)</h1>
        
        <div id="test-results"></div>
        
        <div class="summary">
            <p id="summary-text">Ø¯Ø± Ø­Ø§Ù„ Ø¢Ù…Ø§Ø¯Ù‡â€ŒØ³Ø§Ø²ÛŒ...</p>
        </div>
        
        <div class="controls">
            <button onclick="runAllTests()">â–¶ï¸ Ø§Ø¬Ø±Ø§ÛŒ ØªØ³Øªâ€ŒÙ‡Ø§</button>
            <button onclick="clearTests()">ğŸ—‘ï¸ Ù¾Ø§Ú© Ú©Ø±Ø¯Ù†</button>
        </div>
    </div>

    <script>
        // ==================== Router Core FIXED ====================
        class RouterCoreFixed {
            constructor() {
                this.routes = new Map();
                this.currentRoute = '/';
                this.history = [];
                this.isAuthenticated = false;
                this.userRole = 'guest';
                
                // Ù…Ù‡Ù…: Ø§ÙˆÙ„ Ù…Ø³ÛŒØ± 404 Ø±Ùˆ Ø§Ø¶Ø§ÙÙ‡ Ú©Ù†
                this.routes.set('/404', {
                    name: 'ØµÙØ­Ù‡ ÛŒØ§ÙØª Ù†Ø´Ø¯',
                    requiresAuth: false,
                    roles: ['guest', 'user', 'admin']
                });
                
                // Ø³Ù¾Ø³ Ø¨Ù‚ÛŒÙ‡ Ù…Ø³ÛŒØ±Ù‡Ø§
                this.routes.set('/', {
                    name: 'Ø®Ø§Ù†Ù‡',
                    requiresAuth: false,
                    roles: ['guest', 'user', 'admin']
                });
                
                this.routes.set('/login', {
                    name: 'ÙˆØ±ÙˆØ¯',
                    requiresAuth: false,
                    roles: ['guest']
                });
                
                this.routes.set('/dashboard', {
                    name: 'Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯',
                    requiresAuth: true,
                    roles: ['user', 'admin']
                });
                
                this.routes.set('/admin', {
                    name: 'Ù…Ø¯ÛŒØ±ÛŒØª',
                    requiresAuth: true,
                    roles: ['admin']
                });
            }
            
            async navigate(toPath, options = {}) {
                console.log(`ğŸ” Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ù…Ø³ÛŒØ±ÛŒØ§Ø¨ÛŒ Ø¨Ù‡: ${toPath}`);
                
                // 1. Ø§ÙˆÙ„ Ø¨Ø±Ø±Ø³ÛŒ Ú©Ù† Ù…Ø³ÛŒØ± ÙˆØ¬ÙˆØ¯ Ø¯Ø§Ø±Ù‡
                if (!this.routes.has(toPath)) {
                    console.log(`âŒ Ù…Ø³ÛŒØ± ${toPath} ÛŒØ§ÙØª Ù†Ø´Ø¯ â†’ Ø±ÛŒØ¯Ø§ÛŒØ±Ú©Øª Ø¨Ù‡ 404`);
                    this.currentRoute = '/404';
                    return false;
                }
                
                const to = this.routes.get(toPath);
                
                // 2. Guard Ù…Ù‡Ù…Ø§Ù† (Ø¨Ø§ÛŒØ¯ Ù‚Ø¨Ù„ Ø§Ø² Ø§Ø­Ø±Ø§Ø² Ú†Ú© Ø´Ù‡)
                if ((toPath === '/login') && this.isAuthenticated) {
                    console.log('ğŸš« Ú©Ø§Ø±Ø¨Ø± Ù„Ø§Ú¯ÛŒÙ† Ú©Ø±Ø¯Ù‡ØŒ Ù†Ù…ÛŒâ€ŒØªÙˆØ§Ù†Ø¯ Ø¨Ù‡ Ù„Ø§Ú¯ÛŒÙ† Ø¨Ø±ÙˆØ¯');
                    this.currentRoute = '/dashboard';
                    return false;
                }
                
                // 3. Guard Ø§Ø­Ø±Ø§Ø² Ù‡ÙˆÛŒØª
                if (to.requiresAuth && !this.isAuthenticated) {
                    console.log('ğŸ” Ù†ÛŒØ§Ø² Ø¨Ù‡ Ø§Ø­Ø±Ø§Ø² Ù‡ÙˆÛŒØª â†’ Ø±ÛŒØ¯Ø§ÛŒØ±Ú©Øª Ø¨Ù‡ Ù„Ø§Ú¯ÛŒÙ†');
                    this.currentRoute = '/login';
                    return false;
                }
                
                // 4. Guard Ù†Ù‚Ø´ Ú©Ø§Ø±Ø¨Ø±
                if (to.roles && !to.roles.includes(this.userRole)) {
                    console.log(`â›” Ù†Ù‚Ø´ ${this.userRole} Ù…Ø¬Ø§Ø² Ù†ÛŒØ³Øª`);
                    this.currentRoute = '/';
                    return false;
                }
                
                // 5. Ø§Ù†Ø¬Ø§Ù… Ù…Ø³ÛŒØ±ÛŒØ§Ø¨ÛŒ Ù…ÙˆÙÙ‚
                const previous = this.currentRoute;
                this.currentRoute = toPath;
                
                // ÙÙ‚Ø· Ø§Ú¯Ø± replace Ù†Ø¨ÙˆØ¯ Ùˆ Ù…Ø³ÛŒØ± ØªØºÛŒÛŒØ± Ú©Ø±Ø¯Ù‡ØŒ Ø¨Ù‡ history Ø§Ø¶Ø§ÙÙ‡ Ú©Ù†
                if (!options.replace && previous !== toPath) {
                    this.history.push(previous);
                    console.log(`ğŸ“ Ø§Ø¶Ø§ÙÙ‡ Ø¨Ù‡ ØªØ§Ø±ÛŒØ®Ú†Ù‡: ${previous}`);
                }
                
                console.log(`âœ… Ù…Ø³ÛŒØ±ÛŒØ§Ø¨ÛŒ Ù…ÙˆÙÙ‚: ${previous} â†’ ${toPath}`);
                return true;
            }
            
            goBack() {
                if (this.history.length > 0) {
                    const previous = this.history.pop();
                    console.log(`â†©ï¸ Ø¨Ø§Ø²Ú¯Ø´Øª Ø¨Ù‡: ${previous}`);
                    this.currentRoute = previous;
                    return true;
                }
                console.log('âš ï¸ ØªØ§Ø±ÛŒØ®Ú†Ù‡â€ŒØ§ÛŒ Ø¨Ø±Ø§ÛŒ Ø¨Ø§Ø²Ú¯Ø´Øª ÙˆØ¬ÙˆØ¯ Ù†Ø¯Ø§Ø±Ø¯');
                return false;
            }
            
            setAuth(authenticated, role = 'user') {
                this.isAuthenticated = authenticated;
                this.userRole = role;
                console.log(`ğŸ‘¤ ÙˆØ¶Ø¹ÛŒØª Ø§Ø­Ø±Ø§Ø²: ${authenticated ? 'Ù„Ø§Ú¯ÛŒÙ†' : 'Ù„Ø§Ú¯â€ŒØ§ÙˆØª'} | Ù†Ù‚Ø´: ${role}`);
            }
            
            addRoute(path, config) {
                if (this.routes.has(path)) {
                    console.log(`âš ï¸ Ù…Ø³ÛŒØ± ${path} Ù‚Ø¨Ù„Ø§Ù‹ ÙˆØ¬ÙˆØ¯ Ø¯Ø§Ø±Ø¯`);
                    return false;
                }
                this.routes.set(path, config);
                console.log(`â• Ù…Ø³ÛŒØ± Ø¬Ø¯ÛŒØ¯: ${path}`);
                return true;
            }
        }

        // ==================== ØªØ³Øªâ€ŒÙ‡Ø§ÛŒ Ø§ØµÙ„Ø§Ø­â€ŒØ´Ø¯Ù‡ ====================
        const coreTestsFixed = [
            {
                id: 1,
                title: "Ù…Ø³ÛŒØ±ÛŒØ§Ø¨ÛŒ Ø³Ø§Ø¯Ù‡ Ø¨Ù‡ ØµÙØ­Ù‡ Ø§ØµÙ„ÛŒ",
                run: async () => {
                    const router = new RouterCoreFixed();
                    const result = await router.navigate('/');
                    return result && router.currentRoute === '/';
                }
            },
            {
                id: 2,
                title: "Guard Ø§Ø­Ø±Ø§Ø² - Ø¯Ø³ØªØ±Ø³ÛŒ Ø¨Ù‡ Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯ Ø¨Ø¯ÙˆÙ† Ù„Ø§Ú¯ÛŒÙ†",
                run: async () => {
                    const router = new RouterCoreFixed();
                    router.setAuth(false, 'guest'); // Ù„Ø§Ú¯ÛŒÙ† Ù†ÛŒØ³Øª
                    const result = await router.navigate('/dashboard');
                    // Ø¨Ø§ÛŒØ¯ false Ø¨Ø±Ú¯Ø±Ø¯ÙˆÙ†Ù‡ Ùˆ Ø¨Ù‡ /login Ø±ÛŒØ¯Ø§ÛŒØ±Ú©Øª Ø¨Ø´Ù‡
                    return !result && router.currentRoute === '/login';
                }
            },
            {
                id: 3,
                title: "Guard Ø§Ø­Ø±Ø§Ø² - Ø¯Ø³ØªØ±Ø³ÛŒ Ø¨Ù‡ Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯ Ø¨Ø§ Ù„Ø§Ú¯ÛŒÙ†",
                run: async () => {
                    const router = new RouterCoreFixed();
                    router.setAuth(true, 'user'); // Ù„Ø§Ú¯ÛŒÙ† Ø´Ø¯Ù‡
                    const result = await router.navigate('/dashboard');
                    return result && router.currentRoute === '/dashboard';
                }
            },
            {
                id: 4,
                title: "Guard Ù†Ù‚Ø´ - Ú©Ø§Ø±Ø¨Ø± Ø¹Ø§Ø¯ÛŒ Ø¨Ù‡ Ø§Ø¯Ù…ÛŒÙ† Ø¯Ø³ØªØ±Ø³ÛŒ Ù†Ø¯Ø§Ø±Ø¯",
                run: async () => {
                    const router = new RouterCoreFixed();
                    router.setAuth(true, 'user'); // Ù†Ù‚Ø´ user
                    const result = await router.navigate('/admin');
                    // Ø¨Ø§ÛŒØ¯ false Ø¨Ø±Ú¯Ø±Ø¯ÙˆÙ†Ù‡ Ùˆ Ø¨Ù‡ / Ø±ÛŒØ¯Ø§ÛŒØ±Ú©Øª Ø¨Ø´Ù‡
                    return !result && router.currentRoute === '/';
                }
            },
            {
                id: 5,
                title: "ØªØ§Ø±ÛŒØ®Ú†Ù‡ Ù…Ø³ÛŒØ±ÛŒØ§Ø¨ÛŒ Ùˆ Ù‚Ø§Ø¨Ù„ÛŒØª Ø¨Ø§Ø²Ú¯Ø´Øª",
                run: async () => {
                    const router = new RouterCoreFixed();
                    router.setAuth(true, 'user');
                    
                    // Ø¨Ù‡ Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯ Ø¨Ø±Ùˆ (Ø¨Ù‡ ØªØ§Ø±ÛŒØ®Ú†Ù‡ Ø§Ø¶Ø§ÙÙ‡ Ù…ÛŒâ€ŒØ´ÙˆØ¯)
                    await router.navigate('/dashboard');
                    const historyCount1 = router.history.length; // Ø¨Ø§ÛŒØ¯ 1 Ø¨Ø§Ø´Ø¯
                    
                    // Ø¨Ù‡ Ø®Ø§Ù†Ù‡ Ø¨Ø±Ú¯Ø±Ø¯ (Ø¨Ø§Ø² Ù‡Ù… Ø§Ø¶Ø§ÙÙ‡ Ù…ÛŒâ€ŒØ´ÙˆØ¯)
                    await router.navigate('/');
                    const historyCount2 = router.history.length; // Ø¨Ø§ÛŒØ¯ 2 Ø¨Ø§Ø´Ø¯
                    
                    // ÛŒÚ© Ø¨Ø§Ø± Ø¨Ø±Ú¯Ø´Øª
                    const back1 = router.goBack();
                    const currentAfterBack1 = router.currentRoute; // Ø¨Ø§ÛŒØ¯ '/dashboard' Ø¨Ø§Ø´Ø¯
                    
                    // Ø¯ÙˆØ¨Ø§Ø±Ù‡ Ø¨Ø±Ú¯Ø´Øª
                    const back2 = router.goBack();
                    const currentAfterBack2 = router.currentRoute; // Ø¨Ø§ÛŒØ¯ '/' Ø¨Ø§Ø´Ø¯
                    
                    return historyCount1 === 1 && 
                           historyCount2 === 2 &&
                           back1 && currentAfterBack1 === '/dashboard' &&
                           back2 && currentAfterBack2 === '/';
                }
            },
            {
                id: 6,
                title: "Ù…Ø¯ÛŒØ±ÛŒØª Ù…Ø³ÛŒØ±Ù‡Ø§ÛŒ Ù†Ø§Ù…ÙˆØ¬ÙˆØ¯ (404)",
                run: async () => {
                    const router = new RouterCoreFixed();
                    const result = await router.navigate('/invalid-route-xyz');
                    // Ø¨Ø§ÛŒØ¯ false Ø¨Ø±Ú¯Ø±Ø¯ÙˆÙ†Ù‡ Ùˆ currentRoute Ø¨Ø´Ù‡ '/404'
                    return !result && router.currentRoute === '/404';
                }
            },
            {
                id: 7,
                title: "Ø§ÙØ²ÙˆØ¯Ù† Ù…Ø³ÛŒØ± Ø¯Ø§ÛŒÙ†Ø§Ù…ÛŒÚ© Ùˆ Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ù¾Ø§Ø±Ø§Ù…ØªØ±Ù‡Ø§",
                run: async () => {
                    const router = new RouterCoreFixed();
                    
                    // Ø§Ø¶Ø§ÙÙ‡ Ú©Ø±Ø¯Ù† Ù…Ø³ÛŒØ± Ø¨Ø§ Ù¾Ø§Ø±Ø§Ù…ØªØ±
                    const added = router.addRoute('/user/:userId', {
                        name: 'Ù¾Ø±ÙˆÙØ§ÛŒÙ„ Ú©Ø§Ø±Ø¨Ø±',
                        requiresAuth: true,
                        roles: ['user', 'admin']
                    });
                    
                    // ØªØ³Øª ÙˆØ¬ÙˆØ¯ Ù…Ø³ÛŒØ±
                    const routeExists = router.routes.has('/user/:userId');
                    
                    // ØªØ³Øª Ù¾Ø§Ø±Ø§Ù…ØªØ±Ù‡Ø§
                    const extractParams = (path) => {
                        if (!path.includes(':')) return [];
                        const params = [];
                        const parts = path.split('/');
                        parts.forEach(part => {
                            if (part.startsWith(':')) {
                                params.push(part.substring(1));
                            }
                        });
                        return params;
                    };
                    
                    const params = extractParams('/user/:userId');
                    const hasUserId = params.includes('userId');
                    
                    return added && routeExists && hasUserId;
                }
            },
            {
                id: 8,
                title: "Ù…Ø³ÛŒØ±ÛŒØ§Ø¨ÛŒ Ø¨Ø§ replace (Ø¨Ø¯ÙˆÙ† Ø§ÙØ²ÙˆØ¯Ù† Ø¨Ù‡ ØªØ§Ø±ÛŒØ®Ú†Ù‡)",
                run: async () => {
                    const router = new RouterCoreFixed();
                    router.setAuth(true, 'user');
                    
                    // Ø±ÙØªÙ† Ø¨Ù‡ Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯ (Ø§Ø¶Ø§ÙÙ‡ Ø¨Ù‡ ØªØ§Ø±ÛŒØ®Ú†Ù‡)
                    await router.navigate('/dashboard');
                    const historyAfterFirst = router.history.length; // Ø¨Ø§ÛŒØ¯ 1 Ø¨Ø§Ø´Ø¯
                    
                    // Ø±ÙØªÙ† Ø¨Ù‡ Ø®Ø§Ù†Ù‡ Ø¨Ø§ replace (Ø§Ø¶Ø§ÙÙ‡ Ù†Ù…ÛŒâ€ŒØ´ÙˆØ¯)
                    await router.navigate('/', { replace: true });
                    const historyAfterReplace = router.history.length; // Ø¨Ø§ÛŒØ¯ Ù‡Ù†ÙˆØ² 1 Ø¨Ø§Ø´Ø¯
                    
                    return historyAfterFirst === 1 && historyAfterReplace === 1;
                }
            }
        ];

        // ==================== Ø§Ø¬Ø±Ø§ÛŒ ØªØ³Øªâ€ŒÙ‡Ø§ ====================
        let passedTests = 0;
        let failedTests = 0;

        async function runAllTests() {
            passedTests = 0;
            failedTests = 0;
            const resultsDiv = document.getElementById('test-results');
            resultsDiv.innerHTML = '';
            
            for (const test of coreTestsFixed) {
                try {
                    const result = await test.run();
                    const testDiv = document.createElement('div');
                    testDiv.className = 'test-section';
                    
                    const testResult = result ? 'pass' : 'fail';
                    const resultText = result ? 'âœ… Ù…ÙˆÙÙ‚' : 'âŒ Ù†Ø§Ù…ÙˆÙÙ‚';
                    
                    if (result) passedTests++;
                    else failedTests++;
                    
                    testDiv.innerHTML = `
                        <div class="test-header">
                            <div class="test-title">${test.id}. ${test.title}</div>
                            <div class="test-result ${testResult}">${resultText}</div>
                        </div>
                        ${!result ? '<div class="details">ØªØ³Øª Ù†Ø§Ù…ÙˆÙÙ‚ Ø¨ÙˆØ¯</div>' : ''}
                    `;
                    
                    resultsDiv.appendChild(testDiv);
                    
                    // Ù„Ø§Ú¯ Ú©Ù†Ø³ÙˆÙ„ Ø¨Ø±Ø§ÛŒ Ø¯ÛŒØ¨Ø§Ú¯
                    console.log(`ØªØ³Øª ${test.id}: ${result ? 'âœ…' : 'âŒ'}`);
                    
                } catch (error) {
                    failedTests++;
                    const testDiv = document.createElement('div');
                    testDiv.className = 'test-section';
                    testDiv.innerHTML = `
                        <div class="test-header">
                            <div class="test-title">${test.id}. ${test.title}</div>
                            <div class="test-result fail">âŒ Ø®Ø·Ø§</div>
                        </div>
                        <div class="details">${error.message}</div>
                    `;
                    resultsDiv.appendChild(testDiv);
                    console.error(`Ø®Ø·Ø§ Ø¯Ø± ØªØ³Øª ${test.id}:`, error);
                }
                
                updateSummary();
            }
        }

        function clearTests() {
            document.getElementById('test-results').innerHTML = '';
            passedTests = failedTests = 0;
            updateSummary();
        }

        function updateSummary() {
            const summary = document.getElementById('summary-text');
            const total = coreTestsFixed.length;
            const percentage = total > 0 ? Math.round((passedTests / total) * 100) : 0;
            
            summary.textContent = 
                `âœ… ${passedTests} Ù…ÙˆÙÙ‚ | âŒ ${failedTests} Ù†Ø§Ù…ÙˆÙÙ‚ | ğŸ“Š ${percentage}% Ù‚Ø¨ÙˆÙ„ÛŒ`;
            
            summary.style.color = percentage === 100 ? '#4caf50' : 
                                 percentage >= 80 ? '#ff9800' : '#f44336';
        }

        // Ø§Ø¬Ø±Ø§ÛŒ Ø®ÙˆØ¯Ú©Ø§Ø± ØªØ³Øªâ€ŒÙ‡Ø§
        window.onload = () => {
            updateSummary();
            console.log('ğŸš€ Ø´Ø±ÙˆØ¹ ØªØ³Øªâ€ŒÙ‡Ø§ÛŒ Ù…Ø³ÛŒØ±ÛŒØ§Ø¨ÛŒ...');
            setTimeout(runAllTests, 500);
        };
    </script>
</body>
</html>
