<!DOCTYPE html>
<html lang="fa">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ØªØ³Øª State Manager (Ø§ØµÙ„Ø§Ø­ Ø´Ø¯Ù‡) - Farsinglish</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: system-ui, -apple-system, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            color: #2d3748;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }
        h1 { color: #4a5568; margin-bottom: 10px; text-align: center; }
        .subtitle { color: #718096; margin-bottom: 30px; text-align: center; }
        .test-card {
            background: #f7fafc;
            border-radius: 12px;
            padding: 20px;
            margin: 15px 0;
            border: 1px solid #e2e8f0;
            transition: all 0.3s;
        }
        .test-card:hover { background: #edf2f7; transform: translateY(-2px); }
        .test-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        .test-title { font-weight: bold; color: #2d3748; }
        .test-badge {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: bold;
        }
        .pass { background: #c6f6d5; color: #22543d; }
        .fail { background: #fed7d7; color: #742a2a; }
        .test-details {
            background: white;
            border: 1px solid #cbd5e0;
            border-radius: 8px;
            padding: 12px;
            margin-top: 10px;
            font-family: 'Courier New', monospace;
            font-size: 13px;
            color: #4a5568;
            white-space: pre-wrap;
        }
        .stats {
            display: flex;
            justify-content: space-around;
            margin: 30px 0;
            padding: 20px;
            background: #e6fffa;
            border-radius: 12px;
            color: #234e52;
        }
        .stat-box { text-align: center; }
        .stat-box h2 { font-size: 32px; margin-bottom: 5px; }
        .stat-box p { font-size: 14px; opacity: 0.8; }
        .controls {
            text-align: center;
            margin: 20px 0;
        }
        button {
            background: #4299e1;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.3s;
        }
        button:hover { background: #3182ce; transform: scale(1.05); }
        .summary {
            background: #f0fff4;
            padding: 15px;
            border-radius: 10px;
            border-right: 4px solid #48bb78;
            margin-top: 20px;
            text-align: right;
            line-height: 1.6;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ§ª ØªØ³Øª State Manager (Ø§ØµÙ„Ø§Ø­ Ø´Ø¯Ù‡)</h1>
        <p class="subtitle">Ù‡Ù…Ù‡ ØªØ³Øªâ€ŒÙ‡Ø§ Ø¨Ø§ÛŒØ¯ Ù…ÙˆÙÙ‚ Ø¨Ø§Ø´Ù†Ø¯</p>
        
        <div id="testResults"></div>
        
        <div class="stats">
            <div class="stat-box">
                <h2 id="passedCount">0</h2>
                <p>Ù…ÙˆÙÙ‚</p>
            </div>
            <div class="stat-box">
                <h2 id="failedCount">0</h2>
                <p>Ù†Ø§Ù…ÙˆÙÙ‚</p>
            </div>
            <div class="stat-box">
                <h2 id="totalCount">0</h2>
                <p>Ú©Ù„ ØªØ³Øªâ€ŒÙ‡Ø§</p>
            </div>
        </div>
        
        <div class="controls">
            <button onclick="runAllTests()">â–¶ï¸ Ø§Ø¬Ø±Ø§ÛŒ Ù‡Ù…Ù‡ ØªØ³Øªâ€ŒÙ‡Ø§</button>
            <button onclick="resetTests()" style="background: #718096; margin-left: 10px;">
                ğŸ”„ Ø¨Ø§Ø²Ù†Ø´Ø§Ù†ÛŒ
            </button>
        </div>
        
        <div class="summary">
            <strong>ğŸ”§ Ø§ØµÙ„Ø§Ø­Ø§Øª Ø§Ù†Ø¬Ø§Ù… Ø´Ø¯Ù‡:</strong><br>
            1. Ø±ÙØ¹ Ù…Ø´Ú©Ù„ Immutability Ø¯Ø± dispatch()<br>
            2. Ø§ØµÙ„Ø§Ø­ deepClone Ø¨Ø±Ø§ÛŒ Ø¢Ø±Ø§ÛŒÙ‡â€ŒÙ‡Ø§ Ùˆ Ø¢Ø¨Ø¬Ú©Øªâ€ŒÙ‡Ø§ÛŒ ØªÙˆ Ø¯Ø± ØªÙˆ<br>
            3. Ø±ÙØ¹ Ø¨Ø§Ú¯ middleware chain<br>
            4. ØªØ¶Ù…ÛŒÙ† Ú©Ù¾ÛŒ Ø¹Ù…ÛŒÙ‚ Ø¯Ø± getState()
        </div>
    </div>

    <script>
        // ==================== State Manager (Ø§ØµÙ„Ø§Ø­ Ø´Ø¯Ù‡) ====================
        class StateManager {
            constructor(initialState = {}) {
                if (StateManager._instance) {
                    return StateManager._instance;
                }
                
                this._state = initialState;
                this._middlewares = [];
                this._listeners = [];
                StateManager._instance = this;
                
                // Ù…ØªØ¯Ù‡Ø§ÛŒ public Ø±Ø§ bind Ù…ÛŒâ€ŒÚ©Ù†ÛŒÙ…
                this.getState = this.getState.bind(this);
                this.dispatch = this.dispatch.bind(this);
                this.subscribe = this.subscribe.bind(this);
                this.addMiddleware = this.addMiddleware.bind(this);
                
                return this;
            }

            _deepClone(obj) {
                if (obj === null || typeof obj !== 'object') return obj;
                if (obj instanceof Date) return new Date(obj.getTime());
                if (Array.isArray(obj)) return obj.map(item => this._deepClone(item));
                
                const cloned = {};
                for (const key in obj) {
                    if (obj.hasOwnProperty(key)) {
                        cloned[key] = this._deepClone(obj[key]);
                    }
                }
                return cloned;
            }

            getState() {
                return this._deepClone(this._state);
            }

            dispatch(action) {
                let currentState = this._deepClone(this._state);
                let actionToProcess = action;
                
                // Ø§Ø¬Ø±Ø§ÛŒ middlewareâ€ŒÙ‡Ø§
                const runMiddleware = (index) => {
                    if (index < this._middlewares.length) {
                        this._middlewares[index](
                            actionToProcess, 
                            currentState, 
                            (newAction) => {
                                if (newAction) actionToProcess = newAction;
                                runMiddleware(index + 1);
                            }
                        );
                    } else {
                        // Ø§Ø¹Ù…Ø§Ù„ ØªØºÛŒÛŒØ±Ø§Øª Ù†Ù‡Ø§ÛŒÛŒ
                        const oldState = this._deepClone(this._state);
                        currentState = this._applyReducer(currentState, actionToProcess);
                        
                        // Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ state Ø§ØµÙ„ÛŒ
                        this._state = currentState;
                        
                        // Ø§Ø·Ù„Ø§Ø¹â€ŒØ±Ø³Ø§Ù†ÛŒ Ø¨Ù‡ listeners
                        this._notifyListeners(this._state, oldState);
                    }
                };
                
                runMiddleware(0);
            }

            _applyReducer(state, action) {
                const newState = this._deepClone(state);
                
                switch (action.type) {
                    case 'INCREMENT':
                        newState.counter = (newState.counter || 0) + (action.payload || 1);
                        break;
                    case 'ADD_USER':
                        if (!newState.users) newState.users = [];
                        newState.users.push({ 
                            ...action.payload, 
                            id: Date.now() + Math.random() 
                        });
                        break;
                    case 'UPDATE_SETTINGS':
                        newState.settings = { 
                            ...(newState.settings || {}), 
                            ...action.payload 
                        };
                        break;
                    case 'NESTED_UPDATE':
                        if (!newState.data) newState.data = { nested: { value: 0 } };
                        if (!newState.data.nested) newState.data.nested = { value: 0 };
                        newState.data.nested.value = (newState.data.nested.value || 0) + 1;
                        break;
                    case 'SET_VALUE':
                        newState.value = action.payload;
                        break;
                }
                
                return newState;
            }

            addMiddleware(middleware) {
                this._middlewares.push(middleware);
            }

            subscribe(listener) {
                this._listeners.push(listener);
                return () => {
                    this._listeners = this._listeners.filter(l => l !== listener);
                };
            }

            _notifyListeners(newState, oldState) {
                const newStateCopy = this._deepClone(newState);
                const oldStateCopy = this._deepClone(oldState);
                
                this._listeners.forEach(listener => {
                    try {
                        listener(newStateCopy, oldStateCopy);
                    } catch (error) {
                        console.error('Error in listener:', error);
                    }
                });
            }

            static clearInstance() {
                StateManager._instance = null;
            }
        }

        // ==================== ØªØ³Øªâ€ŒÙ‡Ø§ ====================
        const tests = [];
        let passed = 0;
        let failed = 0;

        function addTest(name, testFn) {
            tests.push({ name, fn: testFn });
        }

        // 1. ØªØ³Øª Singleton Pattern
        addTest('Singleton Pattern', () => {
            StateManager.clearInstance();
            const m1 = new StateManager({ test: 1 });
            const m2 = new StateManager({ test: 2 });
            
            // Ù‡Ø± Ø¯Ùˆ Ø¨Ø§ÛŒØ¯ ÛŒÚ© instance Ø¨Ø§Ø´Ù†Ø¯
            const sameInstance = m1 === m2;
            
            // state Ø§ÙˆÙ„ÛŒÙ‡ Ø¨Ø§ÛŒØ¯ Ø­ÙØ¸ Ø´ÙˆØ¯ (Ø¯ÙˆÙ…ÛŒ Ù†Ø¨Ø§ÛŒØ¯ Ø§ÙˆÙ„ÛŒ Ø±Ø§ Ø¨Ø§Ø²Ù†ÙˆÛŒØ³ÛŒ Ú©Ù†Ø¯)
            const statePreserved = m1.getState().test === 1;
            
            return sameInstance && statePreserved;
        });

        // 2. ØªØ³Øª State Initialization
        addTest('State Initialization', () => {
            StateManager.clearInstance();
            const manager = new StateManager({ 
                counter: 5,
                users: ['Ali']
            });
            
            const state = manager.getState();
            return state.counter === 5 && 
                   state.users.length === 1 &&
                   state.users[0] === 'Ali';
        });

        // 3. ØªØ³Øª Immutability: getState returns deep copy
        addTest('Immutability: getState() deep copy', () => {
            StateManager.clearInstance();
            const manager = new StateManager({ 
                data: { nested: { value: 10 } },
                list: [1, 2, 3]
            });
            
            const copy1 = manager.getState();
            copy1.data.nested.value = 999;
            copy1.list.push(4);
            
            const copy2 = manager.getState();
            
            // state Ø§ØµÙ„ÛŒ Ù†Ø¨Ø§ÛŒØ¯ ØªØºÛŒÛŒØ± Ú©Ø±Ø¯Ù‡ Ø¨Ø§Ø´Ø¯
            return copy2.data.nested.value === 10 && 
                   copy2.list.length === 3 &&
                   JSON.stringify(copy2.list) === '[1,2,3]';
        });

        // 4. ØªØ³Øª Immutability: dispatch creates new state
        addTest('Immutability: dispatch() new state', () => {
            StateManager.clearInstance();
            const manager = new StateManager({ counter: 0 });
            const oldState = manager.getState();
            
            manager.dispatch({ type: 'INCREMENT', payload: 5 });
            const newState = manager.getState();
            
            // oldState Ù†Ø¨Ø§ÛŒØ¯ ØªØºÛŒÛŒØ± Ú©Ù†Ø¯
            const oldStateUnchanged = oldState.counter === 0;
            
            // newState Ø¨Ø§ÛŒØ¯ Ù…Ù‚Ø¯Ø§Ø± Ø¬Ø¯ÛŒØ¯ Ø¯Ø§Ø´ØªÙ‡ Ø¨Ø§Ø´Ø¯
            const newStateUpdated = newState.counter === 5;
            
            // Ø¨Ø§ÛŒØ¯ Ø¯Ùˆ Ø¢Ø¨Ø¬Ú©Øª Ù…ØªÙØ§ÙˆØª Ø¨Ø§Ø´Ù†Ø¯
            const differentObjects = oldState !== newState;
            
            // state Ø§ØµÙ„ÛŒ Ù‡Ù… Ù†Ø¨Ø§ÛŒØ¯ ØªØºÛŒÛŒØ± Ú©Ø±Ø¯Ù‡ Ø¨Ø§Ø´Ø¯
            const finalState = manager.getState();
            const finalStateCorrect = finalState.counter === 5;
            
            return oldStateUnchanged && newStateUpdated && 
                   differentObjects && finalStateCorrect;
        });

        // 5. ØªØ³Øª Nested Object Immutability
        addTest('Nested Object Immutability', () => {
            StateManager.clearInstance();
            const manager = new StateManager({ 
                data: { 
                    nested: { 
                        values: [1, 2],
                        config: { enabled: true }
                    } 
                } 
            });
            
            const stateBefore = manager.getState();
            manager.dispatch({ type: 'NESTED_UPDATE' });
            const stateAfter = manager.getState();
            
            // Ù…Ù‚Ø§Ø¯ÛŒØ± Ø¨Ø§ÛŒØ¯ Ø¯Ø±Ø³Øª Ø¨Ù‡â€ŒØ±ÙˆØ² Ø´Ø¯Ù‡ Ø¨Ø§Ø´Ù†Ø¯
            const valuesUpdated = stateAfter.data.nested.value === 1;
            
            // Ø¢Ø¨Ø¬Ú©Øªâ€ŒÙ‡Ø§ÛŒ Ø§ØµÙ„ÛŒ Ù†Ø¨Ø§ÛŒØ¯ ØªØºÛŒÛŒØ± Ú©Ø±Ø¯Ù‡ Ø¨Ø§Ø´Ù†Ø¯
            const objectsDifferent = 
                stateBefore.data !== stateAfter.data &&
                stateBefore.data.nested !== stateAfter.data.nested;
            
            // state Ù‚Ø¨Ù„ Ù†Ø¨Ø§ÛŒØ¯ ØªØºÛŒÛŒØ± Ú©Ø±Ø¯Ù‡ Ø¨Ø§Ø´Ø¯
            const beforeUnchanged = 
                stateBefore.data.nested.value === undefined;
            
            return valuesUpdated && objectsDifferent && beforeUnchanged;
        });

        // 6. ØªØ³Øª Middleware Chain Execution
        addTest('Middleware Chain Execution', () => {
            StateManager.clearInstance();
            const manager = new StateManager();
            
            const executionOrder = [];
            
            manager.addMiddleware((action, state, next) => {
                executionOrder.push('middleware1-before');
                next(action);
                executionOrder.push('middleware1-after');
            });
            
            manager.addMiddleware((action, state, next) => {
                executionOrder.push('middleware2-before');
                next(action);
                executionOrder.push('middleware2-after');
            });
            
            manager.dispatch({ type: 'SET_VALUE', payload: 'test' });
            
            const correctOrder = [
                'middleware1-before',
                'middleware2-before',
                'middleware2-after',
                'middleware1-after'
            ];
            
            return JSON.stringify(executionOrder) === JSON.stringify(correctOrder);
        });

        // 7. ØªØ³Øª Listener Notification
        addTest('Listener Notification', () => {
            StateManager.clearInstance();
            const manager = new StateManager({ value: 0 });
            
            let listenerCalled = false;
            let receivedNewState = null;
            let receivedOldState = null;
            
            const unsubscribe = manager.subscribe((newState, oldState) => {
                listenerCalled = true;
                receivedNewState = newState;
                receivedOldState = oldState;
            });
            
            manager.dispatch({ type: 'INCREMENT', payload: 3 });
            
            const listenerWorked = listenerCalled && 
                                   receivedNewState && 
                                   receivedOldState;
            
            const valuesCorrect = receivedNewState?.counter === 3 &&
                                  receivedOldState?.counter === undefined;
            
            // ØªØ³Øª unsubscribe
            listenerCalled = false;
            manager.dispatch({ type: 'INCREMENT' });
            const unsubscribeWorked = !listenerCalled;
            
            return listenerWorked && valuesCorrect && unsubscribeWorked;
        });

        // 8. ØªØ³Øª Complex State Update
        addTest('Complex State Update', () => {
            StateManager.clearInstance();
            const manager = new StateManager({ 
                users: [],
                settings: { theme: 'light' },
                counters: { a: 0, b: 0 }
            });
            
            const initialState = manager.getState();
            
            // Ú†Ù†Ø¯ action Ù…Ø®ØªÙ„Ù
            manager.dispatch({ 
                type: 'ADD_USER', 
                payload: { name: 'Reza', age: 25 }
            });
            
            manager.dispatch({ 
                type: 'UPDATE_SETTINGS', 
                payload: { language: 'fa', fontSize: 14 }
            });
            
            manager.dispatch({ type: 'INCREMENT', payload: 2 });
            
            const finalState = manager.getState();
            
            // Ø¨Ø±Ø±Ø³ÛŒ ØªØºÛŒÛŒØ±Ø§Øª
            const usersUpdated = 
                initialState.users.length === 0 &&
                finalState.users.length === 1 &&
                finalState.users[0].name === 'Reza';
            
            const settingsUpdated = 
                finalState.settings.theme === 'light' &&
                finalState.settings.language === 'fa' &&
                finalState.settings.fontSize === 14 &&
                initialState.settings !== finalState.settings;
            
            const counterUpdated = 
                finalState.counter === 2;
            
            return usersUpdated && settingsUpdated && counterUpdated;
        });

        // ==================== Ø§Ø¬Ø±Ø§ÛŒ ØªØ³Øªâ€ŒÙ‡Ø§ ====================
        function createTestElement(name, success, details) {
            const card = document.createElement('div');
            card.className = 'test-card';
            
            const header = document.createElement('div');
            header.className = 'test-header';
            
            const title = document.createElement('div');
            title.className = 'test-title';
            title.textContent = name;
            
            const badge = document.createElement('div');
            badge.className = `test-badge ${success ? 'pass' : 'fail'}`;
            badge.textContent = success ? 'âœ…' : 'âŒ';
            
            header.appendChild(title);
            header.appendChild(badge);
            card.appendChild(header);
            
            if (details) {
                const detailsDiv = document.createElement('div');
                detailsDiv.className = 'test-details';
                detailsDiv.textContent = details;
                card.appendChild(detailsDiv);
            }
            
            return card;
        }

        function runAllTests() {
            const container = document.getElementById('testResults');
            container.innerHTML = '';
            passed = 0;
            failed = 0;
            
            tests.forEach((test, index) => {
                let success = false;
                let details = '';
                
                try {
                    const result = test.fn();
                    
                    if (result === true) {
                        success = true;
                        passed++;
                        details = 'ØªØ³Øª Ù…ÙˆÙÙ‚ÛŒØªâ€ŒØ¢Ù…ÛŒØ² Ø¨ÙˆØ¯';
                    } else {
                        failed++;
                        details = `Ù†ØªÛŒØ¬Ù‡: ${result}\nÙ…Ù‚Ø¯Ø§Ø± Ù…ÙˆØ±Ø¯ Ø§Ù†ØªØ¸Ø§Ø±: true`;
                    }
                } catch (error) {
                    failed++;
                    details = `Ø®Ø·Ø§: ${error.message}\n${error.stack}`;
                }
                
                container.appendChild(
                    createTestElement(`${index + 1}. ${test.name}`, success, details)
                );
                
                // Ø¢Ù¾Ø¯ÛŒØª Ø¢Ù…Ø§Ø±
                updateStats();
            });
        }

        function resetTests() {
            passed = 0;
            failed = 0;
            updateStats();
            document.getElementById('testResults').innerHTML = 
                '<div class="test-card" style="text-align: center; color: #718096;">ØªØ³Øªâ€ŒÙ‡Ø§ Ø¨Ø§Ø²Ù†Ø´Ø§Ù†ÛŒ Ø´Ø¯Ù†Ø¯. Ø¯Ú©Ù…Ù‡ "Ø§Ø¬Ø±Ø§ÛŒ Ù‡Ù…Ù‡ ØªØ³Øªâ€ŒÙ‡Ø§" Ø±Ø§ Ø¨Ø²Ù†ÛŒØ¯.</div>';
        }

        function updateStats() {
            document.getElementById('passedCount').textContent = passed;
            document.getElementById('failedCount').textContent = failed;
            document.getElementById('totalCount').textContent = tests.length;
        }

        // Ø§Ø¬Ø±Ø§ÛŒ Ø®ÙˆØ¯Ú©Ø§Ø± ØªØ³Øªâ€ŒÙ‡Ø§
        setTimeout(runAllTests, 100);
    </script>
</body>
</html>
