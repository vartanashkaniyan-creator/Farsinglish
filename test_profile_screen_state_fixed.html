<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ØªØ³Øª Ø¯Ø³ØªÛŒ: ØµÙØ­Ù‡ Ù¾Ø±ÙˆÙØ§ÛŒÙ„ (State) - Ø§ØµÙ„Ø§Ø­ Ø´Ø¯Ù‡</title>
    <style>
        body {
            font-family: Vazir, Tahoma, Arial, sans-serif;
            background: #f5f7fa;
            margin: 0;
            padding: 20px;
            color: #1e293b;
        }
        .container {
            max-width: 1000px;
            margin: 0 auto;
        }
        h1 {
            font-size: 1.8rem;
            margin-bottom: 20px;
            color: #0f172a;
            border-right: 5px solid #3b82f6;
            padding-right: 15px;
        }
        .test-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        .card {
            background: white;
            border-radius: 16px;
            padding: 20px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.05);
            border: 1px solid #e2e8f0;
        }
        .card h3 {
            margin-top: 0;
            margin-bottom: 15px;
            font-size: 1.2rem;
            display: flex;
            align-items: center;
            gap: 8px;
            color: #0f172a;
        }
        .btn {
            background: #3b82f6;
            color: white;
            border: none;
            padding: 10px 16px;
            border-radius: 30px;
            font-size: 0.9rem;
            font-weight: 500;
            cursor: pointer;
            width: 100%;
            transition: 0.2s;
            margin-bottom: 12px;
            border: 1px solid #2563eb;
        }
        .btn:hover {
            background: #2563eb;
            transform: translateY(-1px);
        }
        .btn.secondary {
            background: #f1f5f9;
            color: #1e293b;
            border: 1px solid #cbd5e1;
        }
        .btn.secondary:hover {
            background: #e2e8f0;
        }
        .log-container {
            background: #0f172a;
            color: #e2e8f0;
            padding: 20px;
            border-radius: 12px;
            font-family: 'Courier New', monospace;
            font-size: 0.85rem;
            direction: ltr;
            text-align: left;
            max-height: 400px;
            overflow-y: auto;
            margin-top: 20px;
            border: 1px solid #334155;
        }
        .log-entry {
            padding: 4px 0;
            border-bottom: 1px dotted #334155;
            color: #a5f3fc;
        }
        .log-entry.error {
            color: #fca5a5;
        }
        .log-entry.success {
            color: #86efac;
        }
        .flex-row {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }
        .badge {
            background: #e2e8f0;
            padding: 4px 12px;
            border-radius: 30px;
            font-size: 0.8rem;
            color: #334155;
        }
        hr {
            border: none;
            border-top: 1px solid #e2e8f0;
            margin: 20px 0;
        }
        .state-preview {
            background: #f8fafc;
            border: 1px solid #cbd5e1;
            border-radius: 8px;
            padding: 15px;
            font-family: monospace;
            direction: ltr;
            text-align: left;
            font-size: 0.8rem;
            margin-top: 15px;
        }
    </style>
</head>
<body>
<div class="container">
    <h1>ğŸ“‹ ØªØ³Øª Ø¯Ø³ØªÛŒ: ØµÙØ­Ù‡ Ù¾Ø±ÙˆÙØ§ÛŒÙ„ (Ù…Ø¯ÛŒØ±ÛŒØª State) - Ù†Ø³Ø®Ù‡ Ø§ØµÙ„Ø§Ø­ Ø´Ø¯Ù‡</h1>
    <p style="margin-bottom: 20px;">Ø§ÛŒÙ† ØªØ³Øªâ€ŒÙ‡Ø§ ÙˆØ¶Ø¹ÛŒØª Ø¯Ø§Ø®Ù„ÛŒ ØµÙØ­Ù‡ Ù¾Ø±ÙˆÙØ§ÛŒÙ„ Ùˆ ØªØºÛŒÛŒØ±Ø§Øª Ø¢Ù† Ø±Ø§ Ø¨Ø¯ÙˆÙ† ÙˆØ§Ø¨Ø³ØªÚ¯ÛŒ Ø¨Ù‡ UI ÙˆØ§Ù‚Ø¹ÛŒ Ø¨Ø±Ø±Ø³ÛŒ Ù…ÛŒâ€ŒÚ©Ù†Ù†Ø¯.</p>

    <div class="test-grid">
        <!-- Ú©Ø§Ø±Øª Û±: Ù‡Ø³ØªÙ‡ State -->
        <div class="card">
            <h3>ğŸ”¹ Û±. Ù‡Ø³ØªÙ‡ State (immutability)</h3>
            <div class="flex-row">
                <button class="btn" id="testInitialStateBtn">âœ… ØªØ³Øª state Ø§ÙˆÙ„ÛŒÙ‡</button>
                <button class="btn secondary" id="testImmutabilityBtn">ğŸ§ª ØªØ³Øª immutability</button>
            </div>
            <div class="badge">Ø§ÛŒØ²ÙˆÙ„Ù‡ Â· Ù‚Ø·Ø¹ÛŒ</div>
            <div style="margin-top: 15px; font-size: 0.9rem;">
                <span>state Ù¾ÛŒØ´â€ŒÙØ±Ø¶ Ø¨Ø§ÛŒØ¯ Ø´Ø§Ù…Ù„: userId, name, email, level, xp, streak, stats, settings</span>
            </div>
        </div>

        <!-- Ú©Ø§Ø±Øª Û²: Ø¨Ø±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ State -->
        <div class="card">
            <h3>ğŸ”¸ Û². Ø¨Ø±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ state</h3>
            <div class="flex-row">
                <button class="btn" id="testUpdateFieldBtn">âœï¸ Ø¨Ø±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ ÙÛŒÙ„Ø¯</button>
                <button class="btn secondary" id="testNestedUpdateBtn">ğŸ“¦ Ø¨Ø±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ ØªÙˆ Ø¯Ø± ØªÙˆ</button>
            </div>
            <div class="badge">ØªÚ©â€ŒØ§Ø¯Ø¹Ø§ Â· Ø¨Ø¯ÙˆÙ† Ø§Ø«Ø± Ø¬Ø§Ù†Ø¨ÛŒ</div>
            <div style="margin-top: 15px;">
                <button class="btn secondary" id="testBatchUpdateBtn">âš¡ Ø¨Ø±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ú¯Ø±ÙˆÙ‡ÛŒ</button>
            </div>
        </div>

        <!-- Ú©Ø§Ø±Øª Û³: Ù…Ø­Ø§Ø³Ø¨Ø§Øª Ùˆ Ù…Ø´ØªÙ‚Ø§Øª -->
        <div class="card">
            <h3>ğŸ”¹ Û³. Ù…Ù‚Ø§Ø¯ÛŒØ± Ù…Ø´ØªÙ‚ (derived)</h3>
            <div class="flex-row">
                <button class="btn" id="testNextLevelBtn">ğŸ“ˆ Ù…Ø­Ø§Ø³Ø¨Ù‡ Ø³Ø·Ø­ Ø¨Ø¹Ø¯ÛŒ</button>
                <button class="btn secondary" id="testProgressPercentBtn">ğŸ“Š Ø¯Ø±ØµØ¯ Ù¾ÛŒØ´Ø±ÙØª</button>
            </div>
            <div class="badge">Ù…Ù†Ø·Ù‚ Ù…Ø­Ø¶ Â· pure function</div>
            <div style="margin-top: 15px;">
                <button class="btn secondary" id="testStreakBonusBtn">ğŸ”¥ Ù…Ø­Ø§Ø³Ø¨Ù‡ Ù¾Ø§Ø¯Ø§Ø´ Ø§Ø³ØªØ±ÛŒÚ©</button>
            </div>
        </div>

        <!-- Ú©Ø§Ø±Øª Û´: edge cases -->
        <div class="card">
            <h3>âš ï¸ Û´. Ù„Ø¨Ù‡â€ŒÙ‡Ø§ (edge cases)</h3>
            <div class="flex-row">
                <button class="btn" id="testNullFieldBtn">ğŸ•³ï¸ ÙÛŒÙ„Ø¯ null/undefined</button>
                <button class="btn secondary" id="testInvalidTypeBtn">ğŸš« Ù†ÙˆØ¹ Ù†Ø§Ù…Ø¹ØªØ¨Ø±</button>
            </div>
            <div class="badge">Ù…Ù‚Ø§ÙˆÙ… Â· fail safe</div>
            <div style="margin-top: 15px;">
                <button class="btn secondary" id="testResetStateBtn">ğŸ”„ Ø¨Ø§Ø²Ù†Ø´Ø§Ù†ÛŒ Ø¨Ù‡ initialState</button>
            </div>
        </div>
    </div>

    <!-- Ú©Ø§Ø±Øª Ûµ: Ø´Ø¨ÛŒÙ‡â€ŒØ³Ø§Ø²ÛŒ Ø¬Ø±ÛŒØ§Ù† Ú©Ø§Ø±Ø¨Ø± -->
    <div class="card" style="grid-column: 1/-1;">
        <h3>ğŸ§ª Ûµ. Ø´Ø¨ÛŒÙ‡â€ŒØ³Ø§Ø²ÛŒ Ø³Ù†Ø§Ø±ÛŒÙˆÛŒ Ú©Ø§Ø±Ø¨Ø± (flow simulation)</h3>
        <div class="flex-row">
            <button class="btn" id="testProfileLoadBtn">ğŸ‘¤ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ù¾Ø±ÙˆÙØ§ÛŒÙ„</button>
            <button class="btn secondary" id="testProfileEditBtn">âœï¸ ÙˆÛŒØ±Ø§ÛŒØ´ Ùˆ Ø°Ø®ÛŒØ±Ù‡</button>
            <button class="btn secondary" id="testLevelUpBtn">â¬†ï¸ Ø§Ø±ØªÙ‚Ø§ Ø³Ø·Ø­</button>
        </div>
        <div class="flex-row">
            <button class="btn secondary" id="testCompleteFlowBtn">ğŸ”„ Ø§Ø¬Ø±Ø§ÛŒ Ú¯Ø§Ù…â€ŒØ¨Ù‡â€ŒÚ¯Ø§Ù… Ú©Ø§Ù…Ù„</button>
        </div>
        <div class="badge">Ø³Ù†Ø§Ø±ÛŒÙˆÛŒ Ø§Ù†Ø³Ø§Ù†ÛŒ Â· Ù„Ø§Ú¯ Ø´ÙØ§Ù</div>
    </div>

    <!-- Ù†Ù…Ø§ÛŒØ´Ú¯Ø± state ÙØ¹Ù„ÛŒ (Ø´Ø¨ÛŒÙ‡â€ŒØ³Ø§Ø²ÛŒ Ø´Ø¯Ù‡) -->
    <div class="state-preview" id="statePreview">
        <strong>ğŸ“Œ state ÙØ¹Ù„ÛŒ (Ø¨Ø±Ø§ÛŒ ØªØ³Øªâ€ŒÙ‡Ø§):</strong> <span id="stateDisplay">(Ù¾Ø³ Ø§Ø² Ù‡Ø± ØªØ³Øª Ø¨Ù‡â€ŒØ±ÙˆØ² Ù…ÛŒâ€ŒØ´ÙˆØ¯)</span>
    </div>

    <!-- Ù„Ø§Ú¯ Ù…Ø¬Ø§Ø²ÛŒ -->
    <div class="log-container" id="logContainer">
        <div class="log-entry">âœ… Ø¢Ù…Ø§Ø¯Ù‡â€ŒØ³Ø§Ø²ÛŒ ØªØ³Øªâ€ŒÙ‡Ø§ÛŒ state Ù¾Ø±ÙˆÙØ§ÛŒÙ„ (Ù†Ø³Ø®Ù‡ Ø§ØµÙ„Ø§Ø­ Ø´Ø¯Ù‡) ...</div>
    </div>
</div>

<script>
    (function() {
        // ----- Ø§ØµÙˆÙ„ Ø­Ø±ÙÙ‡â€ŒØ§ÛŒ: Tool-Agnostic, Deterministic, Isolated -----
        
        // Û±. ØªØ¹Ø±ÛŒÙ initialState (Ù…Ø­Ø¶ØŒ Ù‚Ø§Ø¨Ù„ Ù¾ÛŒØ´â€ŒØ¨ÛŒÙ†ÛŒ)
        const INITIAL_STATE = {
            userId: 'user_123',
            name: 'Ø¹Ù„ÛŒØ±Ø¶Ø§ Ú©Ø§Ø¸Ù…ÛŒ',
            email: 'alireza@example.com',
            level: 3,
            xp: 280,
            nextLevelXp: 400,
            streak: 7,
            stats: {
                lessonsCompleted: 24,
                totalReviews: 156,
                avgAccuracy: 78.5,
                perfectReviews: 12
            },
            settings: {
                darkMode: false,
                notifications: true,
                language: 'fa'
            },
            lastUpdated: '2026-02-18T10:30:00Z'
        };

        // state Ø¬Ø§Ø±ÛŒ (Ø¨Ø±Ø§ÛŒ ØªØ³Øªâ€ŒÙ‡Ø§ØŒ Ù‡Ø± Ø¨Ø§Ø± clone Ù…ÛŒâ€ŒÚ©Ù†ÛŒÙ… ØªØ§ Ø§ÛŒØ²ÙˆÙ„Ù‡ Ø¨Ù…Ø§Ù†Ø¯)
        let currentState = JSON.parse(JSON.stringify(INITIAL_STATE));
        
        // Ø§Ù„Ù…Ø§Ù†â€ŒÙ‡Ø§ÛŒ DOM
        const logContainer = document.getElementById('logContainer');
        const stateDisplay = document.getElementById('stateDisplay');
        
        // Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ù†Ù…Ø§ÛŒØ´ state
        function updateStatePreview() {
            stateDisplay.innerText = JSON.stringify(currentState, null, 2).substring(0, 150) + '...';
        }

        // ØªØ§Ø¨Ø¹ Ú©Ù…Ú©ÛŒ Ø¨Ø±Ø§ÛŒ clone Ø¹Ù…ÛŒÙ‚ (Ø¬Ø¯Ø§Ø³Ø§Ø²ÛŒ)
        function deepClone(obj) {
            return JSON.parse(JSON.stringify(obj));
        }

        // ØªØ§Ø¨Ø¹ Ù„Ø§Ú¯ (Ù‚Ø§Ø¨Ù„ Ù…Ø´Ø§Ù‡Ø¯Ù‡ Ø¯Ø± console Ù…Ø¬Ø§Ø²ÛŒ)
        function addLog(message, type = 'info') {
            const logDiv = document.createElement('div');
            logDiv.className = `log-entry ${type === 'error' ? 'error' : (type === 'success' ? 'success' : '')}`;
            logDiv.textContent = `> ${new Date().toLocaleTimeString('fa-IR')} â€“ ${message}`;
            logContainer.appendChild(logDiv);
            logContainer.scrollTop = logContainer.scrollHeight;
            // Ù‡Ù…Ø²Ù…Ø§Ù† Ø¯Ø± Ú©Ù†Ø³ÙˆÙ„ ÙˆØ§Ù‚Ø¹ÛŒ Ù‡Ù… Ù„Ø§Ú¯ Ù…ÛŒâ€ŒÚ©Ù†ÛŒÙ… (Ø´ÙØ§ÙÛŒØª)
            console.log(`[Profile State Test] ${message}`);
        }

        // ØªØ§Ø¨Ø¹ Ø±ÛŒØ³Øª state Ø¨Ù‡ initialState (Ø¨Ø±Ø§ÛŒ Ø§ÛŒØ²ÙˆÙ„Ù‡ Ø¨ÙˆØ¯Ù† ØªØ³Øªâ€ŒÙ‡Ø§)
        function resetState() {
            currentState = deepClone(INITIAL_STATE);
            addLog('state Ø¨Ù‡ initialState Ø¨Ø§Ø²Ù†Ø´Ø§Ù†ÛŒ Ø´Ø¯ (Ø§ÛŒØ²ÙˆÙ„Ù‡â€ŒØ³Ø§Ø²ÛŒ)', 'info');
            updateStatePreview();
            return currentState;
        }

        // ----- ØªÙˆØ§Ø¨Ø¹ Ù…Ø­Ø¶ (pure) Ø¨Ø±Ø§ÛŒ ØªØ³Øª Ù…Ù†Ø·Ù‚ -----

        // Ù…Ø­Ø§Ø³Ø¨Ù‡ Ø³Ø·Ø­ Ø¨Ø¹Ø¯ÛŒ (pure)
        function getNextLevel(currentLevel, xp) {
            if (typeof currentLevel !== 'number' || typeof xp !== 'number') return null;
            const xpNeeded = (currentLevel + 1) * 100; // ÙØ±Ù…ÙˆÙ„ Ø³Ø§Ø¯Ù‡
            return {
                currentLevel,
                nextLevel: currentLevel + 1,
                xpNeeded,
                xpProgress: Math.min(100, Math.floor((xp / xpNeeded) * 100))
            };
        }

        // Ù…Ø­Ø§Ø³Ø¨Ù‡ Ø¯Ø±ØµØ¯ Ù¾ÛŒØ´Ø±ÙØª ØªØ§ Ø³Ø·Ø­ Ø¨Ø¹Ø¯ÛŒ (pure)
        function getProgressPercent(xp, nextLevelXp) {
            if (typeof xp !== 'number' || typeof nextLevelXp !== 'number' || nextLevelXp <= 0) return 0;
            return Math.min(100, Math.floor((xp / nextLevelXp) * 100));
        }

        // Ù…Ø­Ø§Ø³Ø¨Ù‡ Ù¾Ø§Ø¯Ø§Ø´ Ø§Ø³ØªØ±ÛŒÚ© (pure)
        function getStreakBonus(streak) {
            if (typeof streak !== 'number' || streak < 0) return 0;
            if (streak >= 30) return 50;
            if (streak >= 14) return 30;
            if (streak >= 7) return 15;
            if (streak >= 3) return 5;
            return 0;
        }

        // Ø¨Ø±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ø§ÛŒÙ…Ù† state (immutable)
        function updateState(state, updates) {
            // Ø¨Ø±Ø±Ø³ÛŒ ÙˆØ¬ÙˆØ¯ state
            if (!state || typeof state !== 'object') return deepClone(INITIAL_STATE);
            
            const newState = deepClone(state);
            let changed = false;

            // Ø§Ø¹Ù…Ø§Ù„ Ø¨Ø±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒâ€ŒÙ‡Ø§ÛŒ Ø³Ø§Ø¯Ù‡
            for (let key in updates) {
                if (updates.hasOwnProperty(key) && newState.hasOwnProperty(key)) {
                    // Ø§Ú¯Ø± Ù…Ù‚Ø¯Ø§Ø± Ø¬Ø¯ÛŒØ¯ undefined Ù†Ø¨Ø§Ø´Ø¯
                    if (updates[key] !== undefined && updates[key] !== null) {
                        newState[key] = updates[key];
                        changed = true;
                    }
                }
            }
            return changed ? newState : state;
        }

        // Ø¨Ø±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ ØªÙˆ Ø¯Ø± ØªÙˆ (Ø§ÛŒÙ…Ù†)
        function updateNested(state, path, value) {
            if (!state || !path || path.length === 0) return state;
            const newState = deepClone(state);
            let current = newState;
            for (let i = 0; i < path.length - 1; i++) {
                if (!current[path[i]] || typeof current[path[i]] !== 'object') {
                    current[path[i]] = {};
                }
                current = current[path[i]];
            }
            const lastKey = path[path.length - 1];
            if (value === undefined || value === null) {
                // Ø§Ú¯Ø± Ù…Ù‚Ø¯Ø§Ø± null/undefined Ø¨ÙˆØ¯ØŒ ØªØºÛŒÛŒØ± Ù†Ù…ÛŒâ€ŒØ¯Ù‡ÛŒÙ…
                return state;
            } else {
                current[lastKey] = value;
            }
            return newState;
        }

        // ØªØ³Øª immutability Ø§ØµÙ„Ø§Ø­ Ø´Ø¯Ù‡
        function testImmutability() {
            resetState();
            const oldState = deepClone(currentState);
            const oldName = currentState.name;
            
            // Ø§ÛŒØ¬Ø§Ø¯ ÛŒÚ© state Ø¬Ø¯ÛŒØ¯ Ø¨Ø§ ØªØºÛŒÛŒØ± (immutable)
            const newState = updateState(currentState, { name: 'Ù†Ø§Ù… ØªØºÛŒÛŒØ± ÛŒØ§ÙØªÙ‡ (ØªØ³Øª)' });
            
            // Ø¨Ø±Ø±Ø³ÛŒ Ø§ÛŒÙ†Ú©Ù‡ state Ø§ØµÙ„ÛŒ ØªØºÛŒÛŒØ± Ù†Ú©Ø±Ø¯Ù‡
            if (currentState.name === oldName && newState.name === 'Ù†Ø§Ù… ØªØºÛŒÛŒØ± ÛŒØ§ÙØªÙ‡ (ØªØ³Øª)') {
                addLog('âœ… immutability Ø±Ø¹Ø§ÛŒØª Ø´Ø¯Ù‡: state Ø§ØµÙ„ÛŒ unchanged Ù…Ø§Ù†Ø¯', 'success');
                addLog(`   name Ø§ØµÙ„ÛŒ: "${currentState.name}" (Ø¨Ø¯ÙˆÙ† ØªØºÛŒÛŒØ±)`);
                addLog(`   name Ø¬Ø¯ÛŒØ¯ (Ø¯Ø± state Ø¬Ø¯ÛŒØ¯): "${newState.name}"`);
                
                // Ù†Ù…Ø§ÛŒØ´ Ø§ÛŒÙ†Ú©Ù‡ Ù…Ø§ Ù…ÛŒâ€ŒØªÙˆØ§Ù†ÛŒÙ… Ø§Ø² newState Ø§Ø³ØªÙØ§Ø¯Ù‡ Ú©Ù†ÛŒÙ… Ø¨Ø¯ÙˆÙ† ØªØºÛŒÛŒØ± oldState
                currentState = newState;
                addLog('   state Ø¬Ø§Ø±ÛŒ Ø¨Ù‡ Ù†Ø³Ø®Ù‡ Ø¬Ø¯ÛŒØ¯ ØªØºÛŒÛŒØ± ÛŒØ§ÙØª', 'info');
            } else {
                addLog('âŒ Ù…Ø´Ú©Ù„: immutability Ù†Ù‚Ø¶ Ø´Ø¯', 'error');
            }
            updateStatePreview();
        }

        // ----- Ø±Ø§Ù‡â€ŒØ§Ù†Ø¯Ø§Ø²ÛŒ Ø±ÙˆÛŒØ¯Ø§Ø¯Ù‡Ø§ Ø¨Ø§ Ø´Ù†Ø§Ø³Ù‡â€ŒÙ‡Ø§ÛŒ ØµØ­ÛŒØ­ -----
        document.addEventListener('DOMContentLoaded', function() {
            // Û±. ØªØ³Øª state Ø§ÙˆÙ„ÛŒÙ‡
            document.getElementById('testInitialStateBtn').addEventListener('click', () => {
                resetState();
                addLog('ğŸ“‹ ØªØ³Øª state Ø§ÙˆÙ„ÛŒÙ‡:');
                addLog(`   Ù†Ø§Ù…: ${currentState.name}`);
                addLog(`   Ø§ÛŒÙ…ÛŒÙ„: ${currentState.email}`);
                addLog(`   Ø³Ø·Ø­: ${currentState.level}, XP: ${currentState.xp}`);
                addLog(`   Ø§Ø³ØªØ±ÛŒÚ©: ${currentState.streak} Ø±ÙˆØ²Ù‡`);
                addLog('âœ… state Ø§ÙˆÙ„ÛŒÙ‡ Ø¨Ù‡ Ø¯Ø±Ø³ØªÛŒ Ù…Ù‚Ø¯Ø§Ø±Ø¯Ù‡ÛŒ Ø´Ø¯Ù‡ Ø§Ø³Øª.', 'success');
            });

            // Û². ØªØ³Øª immutability
            document.getElementById('testImmutabilityBtn').addEventListener('click', testImmutability);

            // Û³. Ø¨Ø±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ ÙÛŒÙ„Ø¯
            document.getElementById('testUpdateFieldBtn').addEventListener('click', () => {
                resetState();
                const newName = 'Ø±Ø¶Ø§ Ù…Ø­Ù…Ø¯ÛŒ';
                const newXp = 310;
                const newState = updateState(currentState, { name: newName, xp: newXp });
                
                addLog('âœï¸ Ø¨Ø±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ ÙÛŒÙ„Ø¯: name Ùˆ xp');
                addLog(`   Ù‚Ø¨Ù„ÛŒ: name="${currentState.name}", xp=${currentState.xp}`);
                
                currentState = newState;
                addLog(`   Ø¨Ø¹Ø¯ÛŒ: name="${currentState.name}", xp=${currentState.xp}`);
                
                if (currentState.name === newName && currentState.xp === newXp) {
                    addLog('âœ… Ø¨Ø±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ù…ÙˆÙÙ‚', 'success');
                } else {
                    addLog('âŒ Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ', 'error');
                }
                updateStatePreview();
            });

            // Û´. Ø¨Ø±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ ØªÙˆ Ø¯Ø± ØªÙˆ
            document.getElementById('testNestedUpdateBtn').addEventListener('click', () => {
                resetState();
                const oldAccuracy = currentState.stats.avgAccuracy;
                const newAccuracy = 85.0;
                
                currentState = updateNested(currentState, ['stats', 'avgAccuracy'], newAccuracy);
                
                addLog('ğŸ“¦ Ø¨Ø±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ ØªÙˆ Ø¯Ø± ØªÙˆ: stats.avgAccuracy');
                addLog(`   Ù‚Ø¨Ù„ÛŒ: ${oldAccuracy}%`);
                addLog(`   Ø¨Ø¹Ø¯ÛŒ: ${currentState.stats.avgAccuracy}%`);
                
                if (currentState.stats.avgAccuracy === newAccuracy) {
                    addLog('âœ… Ø¨Ø±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ ØªÙˆ Ø¯Ø± ØªÙˆ Ù…ÙˆÙÙ‚', 'success');
                } else {
                    addLog('âŒ Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ ØªÙˆ Ø¯Ø± ØªÙˆ', 'error');
                }
                updateStatePreview();
            });

            // Ûµ. Ø¨Ø±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ú¯Ø±ÙˆÙ‡ÛŒ (Ø§ØµÙ„Ø§Ø­ Ø´Ø¯Ù‡)
            document.getElementById('testBatchUpdateBtn').addEventListener('click', () => {
                resetState();
                addLog('âš¡ Ø¨Ø±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ú¯Ø±ÙˆÙ‡ÛŒ (level, xp, streak, lessonsCompleted)');
                
                // Ø§Ø¹Ù…Ø§Ù„ Ú†Ù†Ø¯ Ø¨Ø±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ù¾Ø´Øª Ø³Ø± Ù‡Ù…
                let tempState = currentState;
                tempState = updateState(tempState, { level: 4, xp: 150, streak: 8 });
                tempState = updateNested(tempState, ['stats', 'lessonsCompleted'], 25);
                
                const oldState = deepClone(currentState);
                currentState = tempState;
                
                addLog(`   Ù‚Ø¨Ù„ÛŒ: level=${oldState.level}, xp=${oldState.xp}, streak=${oldState.streak}, lessons=${oldState.stats.lessonsCompleted}`);
                addLog(`   Ø¨Ø¹Ø¯ÛŒ: level=${currentState.level}, xp=${currentState.xp}, streak=${currentState.streak}, lessons=${currentState.stats.lessonsCompleted}`);
                
                if (currentState.level === 4 && currentState.xp === 150 && 
                    currentState.streak === 8 && currentState.stats.lessonsCompleted === 25) {
                    addLog('âœ… Ø¨Ø±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ú¯Ø±ÙˆÙ‡ÛŒ Ù…ÙˆÙÙ‚', 'success');
                } else {
                    addLog('âŒ Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ú¯Ø±ÙˆÙ‡ÛŒ', 'error');
                }
                updateStatePreview();
            });

            // Û¶. Ù…Ø­Ø§Ø³Ø¨Ù‡ Ø³Ø·Ø­ Ø¨Ø¹Ø¯ÛŒ
            document.getElementById('testNextLevelBtn').addEventListener('click', () => {
                resetState();
                const next = getNextLevel(currentState.level, currentState.xp);
                addLog(`ğŸ“ˆ Ù…Ø­Ø§Ø³Ø¨Ù‡ Ø³Ø·Ø­ Ø¨Ø¹Ø¯ÛŒ:`);
                addLog(`   Ø³Ø·Ø­ ÙØ¹Ù„ÛŒ: ${next.currentLevel}`);
                addLog(`   Ø³Ø·Ø­ Ø¨Ø¹Ø¯ÛŒ: ${next.nextLevel}`);
                addLog(`   XP Ù†ÛŒØ§Ø²: ${next.xpNeeded}`);
                addLog(`   Ù¾ÛŒØ´Ø±ÙØª: ${next.xpProgress}%`);
                
                if (next.xpNeeded > 0 && next.xpProgress >= 0 && next.xpProgress <= 100) {
                    addLog('âœ… Ù…Ø­Ø§Ø³Ø¨Ù‡ Ø³Ø·Ø­ Ø¨Ø¹Ø¯ÛŒ ØµØ­ÛŒØ­ Ø§Ø³Øª', 'success');
                } else {
                    addLog('âš ï¸ Ù…Ù‚Ø§Ø¯ÛŒØ± ØºÛŒØ±Ù…Ù†ØªØ¸Ø±Ù‡', 'error');
                }
            });

            // Û·. Ø¯Ø±ØµØ¯ Ù¾ÛŒØ´Ø±ÙØª
            document.getElementById('testProgressPercentBtn').addEventListener('click', () => {
                resetState();
                const percent = getProgressPercent(currentState.xp, currentState.nextLevelXp);
                addLog(`ğŸ“Š Ø¯Ø±ØµØ¯ Ù¾ÛŒØ´Ø±ÙØª ØªØ§ Ø³Ø·Ø­ Ø¨Ø¹Ø¯ÛŒ: ${percent}%`);
                addLog(`   XP: ${currentState.xp}/${currentState.nextLevelXp}`);
                
                if (percent >= 0 && percent <= 100) {
                    addLog('âœ… Ù…Ø­Ø§Ø³Ø¨Ù‡ Ø¯Ø±ØµØ¯ Ù…Ø¹ØªØ¨Ø± Ø§Ø³Øª', 'success');
                } else {
                    addLog('âŒ Ø¯Ø±ØµØ¯ Ø®Ø§Ø±Ø¬ Ø§Ø² Ù…Ø­Ø¯ÙˆØ¯Ù‡', 'error');
                }
            });

            // Û¸. Ù¾Ø§Ø¯Ø§Ø´ Ø§Ø³ØªØ±ÛŒÚ©
            document.getElementById('testStreakBonusBtn').addEventListener('click', () => {
                resetState();
                const bonus = getStreakBonus(currentState.streak);
                addLog(`ğŸ”¥ Ù¾Ø§Ø¯Ø§Ø´ Ø§Ø³ØªØ±ÛŒÚ© ${currentState.streak} Ø±ÙˆØ²Ù‡: ${bonus} Ø§Ù…ØªÛŒØ§Ø²`);
                
                addLog('ğŸ“‹ ØªØ³Øª Ù…ÙˆØ§Ø±Ø¯ Ù…Ø±Ø²ÛŒ:');
                const testCases = [
                    { streak: 2, expected: 0 },
                    { streak: 5, expected: 5 },
                    { streak: 7, expected: 15 },
                    { streak: 10, expected: 15 },
                    { streak: 14, expected: 30 },
                    { streak: 20, expected: 30 },
                    { streak: 30, expected: 50 },
                    { streak: 40, expected: 50 }
                ];
                
                testCases.forEach(tc => {
                    const res = getStreakBonus(tc.streak);
                    const status = res === tc.expected ? 'âœ“' : 'âœ—';
                    addLog(`   Ø§Ø³ØªØ±ÛŒÚ© ${tc.streak} Ø±ÙˆØ²Ù‡ â†’ ${res} Ø§Ù…ØªÛŒØ§Ø² (Ø§Ù†ØªØ¸Ø§Ø± ${tc.expected}) ${status}`);
                });
                
                addLog('âœ… Ù…Ø­Ø§Ø³Ø¨Ø§Øª Ù¾Ø§Ø¯Ø§Ø´ Ø§Ø³ØªØ±ÛŒÚ© Ú©Ø§Ù…Ù„ Ø´Ø¯', 'success');
            });

            // Û¹. ÙÛŒÙ„Ø¯ null/undefined
            document.getElementById('testNullFieldBtn').addEventListener('click', () => {
                resetState();
                const oldName = currentState.name;
                const oldXp = currentState.xp;
                
                const newState = updateState(currentState, { name: null, xp: undefined });
                
                addLog('ğŸ•³ï¸ ØªØ³Øª ÙÛŒÙ„Ø¯ null/undefined:');
                addLog(`   name Ø¨Ø¹Ø¯ Ø§Ø² update: "${newState.name}" (Ø¨Ø§ÛŒØ¯ "${oldName}" Ø¨Ø§Ø´Ø¯)`);
                addLog(`   xp Ø¨Ø¹Ø¯ Ø§Ø² update: ${newState.xp} (Ø¨Ø§ÛŒØ¯ ${oldXp} Ø¨Ø§Ø´Ø¯)`);
                
                if (newState.name === oldName && newState.xp === oldXp) {
                    addLog('âœ… Ù…Ù‚Ø§Ø¯ÛŒØ± null/undefined Ù†Ø§Ø¯ÛŒØ¯Ù‡ Ú¯Ø±ÙØªÙ‡ Ø´Ø¯Ù†Ø¯', 'success');
                    currentState = newState;
                } else {
                    addLog('âŒ state ØªØºÛŒÛŒØ± Ú©Ø±Ø¯ (Ù†Ø¨Ø§ÛŒØ¯ ØªØºÛŒÛŒØ± Ù…ÛŒâ€ŒÚ©Ø±Ø¯)', 'error');
                }
                updateStatePreview();
            });

            // Û±Û°. Ù†ÙˆØ¹ Ù†Ø§Ù…Ø¹ØªØ¨Ø±
            document.getElementById('testInvalidTypeBtn').addEventListener('click', () => {
                resetState();
                const oldLevel = currentState.level;
                
                const newState = updateState(currentState, { level: 'Ù¾Ù†Ø¬' });
                
                addLog('ğŸš« ØªØ³Øª Ù†ÙˆØ¹ Ù†Ø§Ù…Ø¹ØªØ¨Ø±:');
                addLog(`   level Ø¨Ø¹Ø¯ Ø§Ø² update: ${newState.level} (Ø¨Ø§ÛŒØ¯ ${oldLevel} Ø¨Ø§Ø´Ø¯)`);
                
                if (newState.level === oldLevel && typeof newState.level === 'number') {
                    addLog('âœ… Ù†ÙˆØ¹ Ù†Ø§Ù…Ø¹ØªØ¨Ø± Ù†Ø§Ø¯ÛŒØ¯Ù‡ Ú¯Ø±ÙØªÙ‡ Ø´Ø¯', 'success');
                    currentState = newState;
                } else {
                    addLog('âŒ state Ø¨Ø§ Ù†ÙˆØ¹ Ù†Ø§Ù…Ø¹ØªØ¨Ø± ØªØºÛŒÛŒØ± Ú©Ø±Ø¯', 'error');
                }
                updateStatePreview();
            });

            // Û±Û±. Ø¨Ø§Ø²Ù†Ø´Ø§Ù†ÛŒ state
            document.getElementById('testResetStateBtn').addEventListener('click', () => {
                // Ø§ÙˆÙ„ state Ø±Ø§ ØªØºÛŒÛŒØ± Ù…ÛŒâ€ŒØ¯Ù‡ÛŒÙ…
                currentState = updateState(currentState, { name: 'Ù†Ø§Ù… Ù…ÙˆÙ‚Øª', level: 99 });
                addLog('ğŸ”„ state Ø¨Ù‡ "Ù†Ø§Ù… Ù…ÙˆÙ‚Øª" Ùˆ level=99 ØªØºÛŒÛŒØ± ÛŒØ§ÙØª');
                updateStatePreview();
                
                // Ø³Ù¾Ø³ Ø±ÛŒØ³Øª
                setTimeout(() => {
                    resetState();
                    addLog('âœ… Ø¨Ø§Ø²Ù†Ø´Ø§Ù†ÛŒ Ø¨Ù‡ initialState Ø§Ù†Ø¬Ø§Ù… Ø´Ø¯', 'success');
                }, 500);
            });

            // Û±Û². Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ù¾Ø±ÙˆÙØ§ÛŒÙ„
            document.getElementById('testProfileLoadBtn').addEventListener('click', () => {
                resetState();
                addLog('ğŸ‘¤ Ø´Ø¨ÛŒÙ‡â€ŒØ³Ø§Ø²ÛŒ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ù¾Ø±ÙˆÙØ§ÛŒÙ„ Ø§Ø² Ø³Ø±ÙˆØ± (fake)');
                
                const serverData = {
                    ...deepClone(currentState),
                    name: 'Ø¹Ù„ÛŒ Ù†Ø§Ø¯Ø±ÛŒ',
                    xp: 415,
                    level: 4,
                    streak: 14
                };
                
                currentState = serverData;
                addLog(`   Ù†Ø§Ù…: ${currentState.name}`);
                addLog(`   Ø³Ø·Ø­: ${currentState.level}, XP: ${currentState.xp}`);
                addLog(`   Ø§Ø³ØªØ±ÛŒÚ©: ${currentState.streak} Ø±ÙˆØ²Ù‡`);
                addLog('âœ… Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ù¾Ø±ÙˆÙØ§ÛŒÙ„ Ù…ÙˆÙÙ‚', 'success');
                updateStatePreview();
            });

            // Û±Û³. ÙˆÛŒØ±Ø§ÛŒØ´ Ùˆ Ø°Ø®ÛŒØ±Ù‡
            document.getElementById('testProfileEditBtn').addEventListener('click', () => {
                resetState();
                addLog('âœï¸ Ø´Ø¨ÛŒÙ‡â€ŒØ³Ø§Ø²ÛŒ ÙˆÛŒØ±Ø§ÛŒØ´ Ù¾Ø±ÙˆÙØ§ÛŒÙ„:');
                
                const edits = {
                    name: 'Ù…Ø­Ù…Ø¯ Ø§Ø­Ù…Ø¯ÛŒ',
                    email: 'm.ahmadi@example.com'
                };
                
                const oldName = currentState.name;
                const oldEmail = currentState.email;
                currentState = updateState(currentState, edits);
                
                addLog(`   Ù†Ø§Ù…: "${oldName}" â†’ "${currentState.name}"`);
                addLog(`   Ø§ÛŒÙ…ÛŒÙ„: "${oldEmail}" â†’ "${currentState.email}"`);
                
                if (currentState.name === edits.name && currentState.email === edits.email) {
                    addLog('âœ… ÙˆÛŒØ±Ø§ÛŒØ´ Ùˆ Ø°Ø®ÛŒØ±Ù‡ Ù…ÙˆÙÙ‚', 'success');
                } else {
                    addLog('âŒ Ø®Ø·Ø§ Ø¯Ø± ÙˆÛŒØ±Ø§ÛŒØ´', 'error');
                }
                updateStatePreview();
            });

            // Û±Û´. Ø§Ø±ØªÙ‚Ø§ Ø³Ø·Ø­
            document.getElementById('testLevelUpBtn').addEventListener('click', () => {
                resetState();
                const oldLevel = currentState.level;
                const oldXp = currentState.xp;
                
                // Ø´Ø¨ÛŒÙ‡â€ŒØ³Ø§Ø²ÛŒ Ø§Ø±ØªÙ‚Ø§ Ø³Ø·Ø­
                currentState = updateState(currentState, { 
                    level: currentState.level + 1,
                    xp: currentState.xp + 150  // Ø§ÙØ²Ø§ÛŒØ´ XP Ø¨Ù‡ Ø¬Ø§ÛŒ Ú©Ø§Ù‡Ø´
                });
                
                addLog(`â¬†ï¸ Ø§Ø±ØªÙ‚Ø§ Ø³Ø·Ø­:`);
                addLog(`   Ø³Ø·Ø­: ${oldLevel} â†’ ${currentState.level}`);
                addLog(`   XP: ${oldXp} â†’ ${currentState.xp}`);
                
                if (currentState.level === oldLevel + 1) {
                    addLog('âœ… Ø§Ø±ØªÙ‚Ø§ Ø³Ø·Ø­ Ù…ÙˆÙÙ‚', 'success');
                } else {
                    addLog('âŒ Ø®Ø·Ø§ Ø¯Ø± Ø§Ø±ØªÙ‚Ø§ Ø³Ø·Ø­', 'error');
                }
                updateStatePreview();
            });

            // Û±Ûµ. Ø¬Ø±ÛŒØ§Ù† Ú©Ø§Ù…Ù„
            document.getElementById('testCompleteFlowBtn').addEventListener('click', () => {
                resetState();
                addLog('ğŸ”¥ Ø´Ø±ÙˆØ¹ Ø´Ø¨ÛŒÙ‡â€ŒØ³Ø§Ø²ÛŒ Ø¬Ø±ÛŒØ§Ù† Ú©Ø§Ù…Ù„ Ú©Ø§Ø±Ø¨Ø± Ø¯Ø± ØµÙØ­Ù‡ Ù¾Ø±ÙˆÙØ§ÛŒÙ„');
                
                // Ú¯Ø§Ù… Û±: Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ù¾Ø±ÙˆÙØ§ÛŒÙ„
                addLog('Ú¯Ø§Ù… Û±: Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ù¾Ø±ÙˆÙØ§ÛŒÙ„ Ø§Ø² Ø¯ÛŒØªØ§Ø¨ÛŒØ³');
                
                // Ú¯Ø§Ù… Û²: Ù†Ù…Ø§ÛŒØ´ Ø¢Ù…Ø§Ø±
                addLog(`Ú¯Ø§Ù… Û²: Ù†Ù…Ø§ÛŒØ´ Ø¢Ù…Ø§Ø± - Ø¯Ø±Ø³â€ŒÙ‡Ø§: ${currentState.stats.lessonsCompleted}, Ø¯Ù‚Øª: ${currentState.stats.avgAccuracy}%`);
                
                // Ú¯Ø§Ù… Û³: ÙˆÛŒØ±Ø§ÛŒØ´ Ù¾Ø±ÙˆÙØ§ÛŒÙ„
                addLog('Ú¯Ø§Ù… Û³: ÙˆÛŒØ±Ø§ÛŒØ´ Ù¾Ø±ÙˆÙØ§ÛŒÙ„ (ØªØºÛŒÛŒØ± Ù†Ø§Ù…)');
                currentState = updateState(currentState, { name: 'Ú©Ø§Ø¸Ù… Ø±Ø¶Ø§ÛŒÛŒ' });
                
                // Ú¯Ø§Ù… Û´: Ø¯Ø±ÛŒØ§ÙØª XP Ùˆ Ø§Ø±ØªÙ‚Ø§ Ø³Ø·Ø­
                addLog('Ú¯Ø§Ù… Û´: Ø¯Ø±ÛŒØ§ÙØª XP Ùˆ Ø§Ø±ØªÙ‚Ø§ Ø³Ø·Ø­');
                currentState = updateState(currentState, { xp: currentState.xp + 150 });
                addLog(`   XP Ø¬Ø¯ÛŒØ¯: ${currentState.xp}`);
                
                if (currentState.xp >= currentState.nextLevelXp) {
                    const newLevel = currentState.level + 1;
                    const remainingXp = currentState.xp - currentState.nextLevelXp;
                    currentState = updateState(currentState, { 
                        level: newLevel,
                        xp: remainingXp
                    });
                    addLog(`   Ø§Ø±ØªÙ‚Ø§ Ø¨Ù‡ Ø³Ø·Ø­ ${newLevel} Ø¨Ø§ XP Ø¨Ø§Ù‚ÛŒÙ…Ø§Ù†Ø¯Ù‡ ${remainingXp}`);
                }
                
                // Ú¯Ø§Ù… Ûµ: Ø§ÙØ²Ø§ÛŒØ´ Ø§Ø³ØªØ±ÛŒÚ©
                addLog('Ú¯Ø§Ù… Ûµ: Ø§ÙØ²Ø§ÛŒØ´ Ø§Ø³ØªØ±ÛŒÚ© Ø±ÙˆØ²Ø§Ù†Ù‡');
                currentState = updateState(currentState, { streak: currentState.streak + 1 });
                
                // Ú¯Ø§Ù… Û¶: Ø°Ø®ÛŒØ±Ù‡ Ù†Ù‡Ø§ÛŒÛŒ
                addLog('Ú¯Ø§Ù… Û¶: Ø°Ø®ÛŒØ±Ù‡ Ù†Ù‡Ø§ÛŒÛŒ state');
                
                addLog('âœ… Ø¬Ø±ÛŒØ§Ù† Ú©Ø§Ù…Ù„ Ù¾Ø±ÙˆÙØ§ÛŒÙ„ Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø´Ø¨ÛŒÙ‡â€ŒØ³Ø§Ø²ÛŒ Ø´Ø¯.', 'success');
                addLog(`   ÙˆØ¶Ø¹ÛŒØª Ù†Ù‡Ø§ÛŒÛŒ - Ù†Ø§Ù…: "${currentState.name}", Ø³Ø·Ø­: ${currentState.level}, XP: ${currentState.xp}, Ø§Ø³ØªØ±ÛŒÚ©: ${currentState.streak}`);
                
                updateStatePreview();
            });

            // Ù†Ù…Ø§ÛŒØ´ Ø§ÙˆÙ„ÛŒÙ‡
            resetState();
            addLog('âœ… Ù‡Ù…Ù‡ Ø¯Ú©Ù…Ù‡â€ŒÙ‡Ø§ Ø¢Ù…Ø§Ø¯Ù‡â€ŒØ§Ù†Ø¯. Ù‡Ø± ØªØ³Øª Ø§ÛŒØ²ÙˆÙ„Ù‡ Ùˆ Ù‚Ø§Ø¨Ù„ ØªÚ©Ø±Ø§Ø± Ø§Ø³Øª.', 'success');
        });
    })();
</script>
</body>
</html>
