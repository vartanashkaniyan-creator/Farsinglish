<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ØªØ³Øª Ø¯Ø³ØªÛŒ: Ø¬Ø±ÛŒØ§Ù† ØµÙØ­Ù‡ Ù…Ø±ÙˆØ± (Review Screen Flow)</title>
    <style>
        body {
            font-family: system-ui, sans-serif;
            max-width: 600px;
            margin: 0 auto;
            padding: 20px;
            background: #f7f9fc;
            color: #1e293b;
        }
        h1 {
            font-size: 1.5rem;
            margin-bottom: 1rem;
            color: #0f172a;
            border-bottom: 2px solid #e2e8f0;
            padding-bottom: 0.5rem;
        }
        .card {
            background: white;
            border-radius: 16px;
            padding: 20px;
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1);
            margin-bottom: 20px;
            border: 1px solid #e2e8f0;
        }
        .status {
            background: #f1f5f9;
            padding: 12px;
            border-radius: 12px;
            font-family: monospace;
            white-space: pre-wrap;
            direction: ltr;
            text-align: left;
            max-height: 200px;
            overflow-y: auto;
            font-size: 0.9rem;
            border: 1px solid #cbd5e1;
        }
        button {
            background: #3b82f6;
            color: white;
            border: none;
            padding: 10px 18px;
            border-radius: 40px;
            font-size: 1rem;
            font-weight: 500;
            margin: 6px 6px 6px 0;
            cursor: pointer;
            transition: 0.2s;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            border: 1px solid #2563eb;
        }
        button:hover {
            background: #2563eb;
            transform: translateY(-1px);
        }
        button.secondary {
            background: white;
            color: #1e293b;
            border: 1px solid #94a3b8;
        }
        button.secondary:hover {
            background: #f1f5f9;
        }
        .log {
            color: #0f172a;
        }
        .success { color: #15803d; font-weight: bold; }
        .error { color: #b91c1c; font-weight: bold; }
        .info { color: #2563eb; }
        hr {
            border: none;
            border-top: 2px dashed #cbd5e1;
            margin: 20px 0;
        }
        .step {
            background: #f8fafc;
            border-right: 4px solid #3b82f6;
            padding: 10px;
            margin: 10px 0;
        }
    </style>
</head>
<body>
    <h1>ğŸ§ª ØªØ³Øª Ø¯Ø³ØªÛŒ: Ø¬Ø±ÛŒØ§Ù† ØµÙØ­Ù‡ Ù…Ø±ÙˆØ± (Review Screen)</h1>
    <div class="card">
        <p><strong>Ù‡Ø¯Ù:</strong> Ø´Ø¨ÛŒÙ‡â€ŒØ³Ø§Ø²ÛŒ Ú¯Ø§Ù…â€ŒØ¨Ù‡â€ŒÚ¯Ø§Ù… ØµÙØ­Ù‡ Ù…Ø±ÙˆØ± Ø¯Ø±Ø³â€ŒÙ‡Ø§ Ø¨Ø§ SRS</p>
        <p><strong>Ø³Ù†Ø§Ø±ÛŒÙˆ:</strong> Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø¯Ø±Ø³â€ŒÙ‡Ø§ÛŒ Ù†ÛŒØ§Ø² Ø¨Ù‡ Ù…Ø±ÙˆØ± â† Ø§Ø¬Ø±Ø§ÛŒ ØªÙ…Ø±ÛŒÙ† â† Ø«Ø¨Øª Ù¾Ø§Ø³Ø® â† Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ SRS</p>
    </div>

    <div class="card">
        <div style="display: flex; gap: 8px; flex-wrap: wrap; margin-bottom: 20px;">
            <button onclick="initTest()">ğŸ”„ Ø±Ø§Ù‡â€ŒØ§Ù†Ø¯Ø§Ø²ÛŒ Ø§ÙˆÙ„ÛŒÙ‡</button>
            <button onclick="loadReviews()" class="secondary">ğŸ“š Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ù…Ø±ÙˆØ±Ù‡Ø§</button>
            <button onclick="startExercise()" class="secondary">âœï¸ Ø´Ø±ÙˆØ¹ ØªÙ…Ø±ÛŒÙ†</button>
            <button onclick="submitAnswer(true)" class="secondary">âœ… Ù¾Ø§Ø³Ø® ØµØ­ÛŒØ­</button>
            <button onclick="submitAnswer(false)" class="secondary">âŒ Ù¾Ø§Ø³Ø® ØºÙ„Ø·</button>
            <button onclick="resetTest()">ğŸ”„ Ø±ÛŒØ³Øª Ú©Ø§Ù…Ù„</button>
        </div>
        <div>
            <button onclick="logState()" class="secondary">ğŸ“‹ Ù†Ù…Ø§ÛŒØ´ ÙˆØ¶Ø¹ÛŒØª</button>
            <button onclick="clearLog()" class="secondary">ğŸ—‘ï¸ Ù¾Ø§Ú© Ú©Ø±Ø¯Ù† Ù„Ø§Ú¯</button>
        </div>
    </div>

    <div class="card">
        <h3>ğŸ“‹ Ù„Ø§Ú¯ Ø±ÙˆÛŒØ¯Ø§Ø¯Ù‡Ø§</h3>
        <div id="log" class="status">[Ø³ÛŒØ³ØªÙ… Ø¢Ù…Ø§Ø¯Ù‡ Ø§Ø³Øª]</div>
    </div>

    <script>
        // ---------- Ù…Ø¯Ù„â€ŒÙ‡Ø§ÛŒ Ø³Ø§Ø¯Ù‡ (Mock) ----------
        const mockLessons = [
            { id: 'l1', title: 'Ø¯Ø±Ø³ Û±: Ø§Ø­ÙˆØ§Ù„Ù¾Ø±Ø³ÛŒ', stage: 2, nextReview: Date.now() - 10000 },
            { id: 'l2', title: 'Ø¯Ø±Ø³ Û²: Ø§Ø¹Ø¯Ø§Ø¯', stage: 1, nextReview: Date.now() - 5000 },
            { id: 'l3', title: 'Ø¯Ø±Ø³ Û³: Ø®Ø§Ù†ÙˆØ§Ø¯Ù‡', stage: 0, nextReview: Date.now() + 100000 }
        ];

        const mockExercises = [
            { type: 'multiple-choice', question: 'Hello Ø¨Ù‡ Ú†Ù‡ Ù…Ø¹Ù†Ø§Ø³ØªØŸ', options: ['Ø³Ù„Ø§Ù…', 'Ø®Ø¯Ø§Ø­Ø§ÙØ¸', 'ØµØ¨Ø­ Ø¨Ø®ÛŒØ±'], answer: 0 },
            { type: 'flashcard', front: 'Good morning', back: 'ØµØ¨Ø­ Ø¨Ø®ÛŒØ±' },
            { type: 'fill-blank', text: 'I ___ a student.', answer: 'am' }
        ];

        // ---------- ÙˆØ¶Ø¹ÛŒØª Ø¯Ø§Ø®Ù„ÛŒ ----------
        let reviewState = {
            lessons: [],
            currentLessonIndex: -1,
            currentExercise: null,
            exerciseIndex: -1,
            history: []
        };

        let mockDb = {
            lessons: [...mockLessons],
            progress: {}
        };

        // ---------- ØªÙˆØ§Ø¨Ø¹ Ú©Ù…Ú©ÛŒ ----------
        function addLog(message, type = 'info') {
            const logDiv = document.getElementById('log');
            const time = new Date().toLocaleTimeString('fa-IR');
            let className = 'log';
            if (type === 'success') className = 'success';
            if (type === 'error') className = 'error';
            if (type === 'info') className = 'info';
            logDiv.innerHTML += `<div class="${className}">[${time}] ${message}</div>`;
            logDiv.scrollTop = logDiv.scrollHeight;
        }

        function clearLog() {
            document.getElementById('log').innerHTML = '';
            addLog('Ù„Ø§Ú¯ Ù¾Ø§Ú© Ø´Ø¯');
        }

        // ---------- Ø´Ø¨ÛŒÙ‡â€ŒØ³Ø§Ø²ÛŒ SRS Ø³Ø§Ø¯Ù‡ ----------
        function calculateNextStage(currentStage, quality) {
            if (quality < 3) return 0;  // Ù¾Ø§Ø³Ø® Ø¶Ø¹ÛŒÙ â†’ Ø¨Ø±Ú¯Ø´Øª Ø¨Ù‡ Ù…Ø±Ø­Ù„Ù‡ Û°
            if (currentStage === 0) return 1;
            if (currentStage === 1) return 3;
            return currentStage + 2; // ØªØµØ§Ø¹Ø¯ÛŒ
        }

        function calculateNextReview(stage) {
            const intervals = [0, 1, 3, 7, 14, 30]; // Ø±ÙˆØ²
            const days = intervals[stage] || 30;
            return Date.now() + days * 24 * 60 * 60 * 1000;
        }

        // ---------- ØªÙˆØ§Ø¨Ø¹ Ø§ØµÙ„ÛŒ Ø³Ù†Ø§Ø±ÛŒÙˆ ----------
        function initTest() {
            addLog('ğŸ”„ Ø±Ø§Ù‡â€ŒØ§Ù†Ø¯Ø§Ø²ÛŒ Ø§ÙˆÙ„ÛŒÙ‡: Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø¯Ø±Ø³â€ŒÙ‡Ø§ÛŒ Ù†Ù…ÙˆÙ†Ù‡ Ùˆ Ø±ÛŒØ³Øª ÙˆØ¶Ø¹ÛŒØª', 'info');
            reviewState.lessons = mockDb.lessons.filter(l => l.nextReview <= Date.now());
            reviewState.currentLessonIndex = -1;
            reviewState.currentExercise = null;
            reviewState.exerciseIndex = -1;
            addLog(`âœ… ${reviewState.lessons.length} Ø¯Ø±Ø³ Ù†ÛŒØ§Ø² Ø¨Ù‡ Ù…Ø±ÙˆØ± Ø¯Ø§Ø±Ù†Ø¯.`, 'success');
            logState();
        }

        function loadReviews() {
            if (reviewState.lessons.length === 0) {
                addLog('âš ï¸ Ø§Ø¨ØªØ¯Ø§ Ø¯Ú©Ù…Ù‡ "Ø±Ø§Ù‡â€ŒØ§Ù†Ø¯Ø§Ø²ÛŒ Ø§ÙˆÙ„ÛŒÙ‡" Ø±Ø§ Ø¨Ø²Ù†ÛŒØ¯.', 'error');
                return;
            }
            addLog(`ğŸ“š Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ù…Ø±ÙˆØ±Ù‡Ø§: ${reviewState.lessons.map(l => l.title).join('ØŒ ')}`, 'info');
        }

        function startExercise() {
            if (reviewState.lessons.length === 0) {
                addLog('âš ï¸ Ø§Ø¨ØªØ¯Ø§ Ù…Ø±ÙˆØ±Ù‡Ø§ Ø±Ø§ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ú©Ù†ÛŒØ¯.', 'error');
                return;
            }
            if (reviewState.currentLessonIndex + 1 >= reviewState.lessons.length) {
                addLog('ğŸ‰ Ù‡Ù…Ù‡ Ø¯Ø±Ø³â€ŒÙ‡Ø§ÛŒ Ø§ÛŒÙ† Ø¬Ù„Ø³Ù‡ Ù…Ø±ÙˆØ± Ø´Ø¯Ù†Ø¯.', 'success');
                return;
            }

            reviewState.currentLessonIndex++;
            const lesson = reviewState.lessons[reviewState.currentLessonIndex];
            // Ø§Ù†ØªØ®Ø§Ø¨ ØªÙ…Ø±ÛŒÙ† ØªØµØ§Ø¯ÙÛŒ Ø¨Ø±Ø§ÛŒ Ø§ÛŒÙ† Ø¯Ø±Ø³
            const randomIndex = Math.floor(Math.random() * mockExercises.length);
            reviewState.currentExercise = { ...mockExercises[randomIndex], lessonId: lesson.id };
            reviewState.exerciseIndex = randomIndex;

            addLog(`âœï¸ Ø´Ø±ÙˆØ¹ ØªÙ…Ø±ÛŒÙ† Ø¨Ø±Ø§ÛŒ "${lesson.title}":`, 'info');
            addLog(`   Ù¾Ø±Ø³Ø´: ${reviewState.currentExercise.question || reviewState.currentExercise.front || 'ØªÙ…Ø±ÛŒÙ†'}`, 'info');
        }

        function submitAnswer(isCorrect) {
            if (!reviewState.currentExercise) {
                addLog('âš ï¸ Ø§Ø¨ØªØ¯Ø§ ÛŒÚ© ØªÙ…Ø±ÛŒÙ† Ø±Ø§ Ø´Ø±ÙˆØ¹ Ú©Ù†ÛŒØ¯.', 'error');
                return;
            }

            const lesson = reviewState.lessons[reviewState.currentLessonIndex];
            const quality = isCorrect ? 5 : 2; // Ú©ÛŒÙÛŒØª Ù¾Ø§Ø³Ø® (Û°-Ûµ)
            const oldStage = lesson.stage;

            // Ù…Ø­Ø§Ø³Ø¨Ù‡ stage Ø¬Ø¯ÛŒØ¯
            lesson.stage = calculateNextStage(oldStage, quality);
            lesson.nextReview = calculateNextReview(lesson.stage);

            addLog(`âœ… Ù¾Ø§Ø³Ø® ${isCorrect ? 'ØµØ­ÛŒØ­' : 'ØºÙ„Ø·'} Ø«Ø¨Øª Ø´Ø¯.`, isCorrect ? 'success' : 'error');
            addLog(`   Ù…Ø±Ø­Ù„Ù‡ SRS: ${oldStage} â†’ ${lesson.stage}`, 'info');
            addLog(`   Ù…Ø±ÙˆØ± Ø¨Ø¹Ø¯ÛŒ: ${new Date(lesson.nextReview).toLocaleString('fa-IR')}`, 'info');

            // Ø°Ø®ÛŒØ±Ù‡ Ø¯Ø± ØªØ§Ø±ÛŒØ®Ú†Ù‡
            reviewState.history.push({
                lessonId: lesson.id,
                correct: isCorrect,
                newStage: lesson.stage,
                time: new Date()
            });

            // Ù¾Ø§Ú© Ú©Ø±Ø¯Ù† ØªÙ…Ø±ÛŒÙ† ÙØ¹Ù„ÛŒ Ø¨Ø±Ø§ÛŒ Ø´Ø±ÙˆØ¹ Ø¨Ø¹Ø¯ÛŒ
            reviewState.currentExercise = null;
        }

        function resetTest() {
            mockDb.lessons = JSON.parse(JSON.stringify(mockLessons)); // Ø±ÛŒØ³Øª Ø¨Ù‡ Ø­Ø§Ù„Øª Ø§ÙˆÙ„
            reviewState = {
                lessons: [],
                currentLessonIndex: -1,
                currentExercise: null,
                exerciseIndex: -1,
                history: []
            };
            addLog('ğŸ”„ Ø±ÛŒØ³Øª Ú©Ø§Ù…Ù„: Ù‡Ù…Ù‡ Ú†ÛŒØ² Ø¨Ù‡ Ø­Ø§Ù„Øª Ø§ÙˆÙ„ÛŒÙ‡ Ø¨Ø§Ø²Ú¯Ø´Øª.', 'info');
            initTest(); // Ø±Ø§Ù‡â€ŒØ§Ù†Ø¯Ø§Ø²ÛŒ Ù…Ø¬Ø¯Ø¯ Ø®ÙˆØ¯Ú©Ø§Ø±
        }

        function logState() {
            addLog('ğŸ“‹ ÙˆØ¶Ø¹ÛŒØª ÙØ¹Ù„ÛŒ:', 'info');
            addLog(`   Ø¯Ø±Ø³â€ŒÙ‡Ø§ÛŒ Ù†ÛŒØ§Ø² Ø¨Ù‡ Ù…Ø±ÙˆØ±: ${reviewState.lessons.length}`, 'info');
            if (reviewState.currentLessonIndex >= 0) {
                addLog(`   Ø¯Ø±Ø³ Ø¬Ø§Ø±ÛŒ: ${reviewState.lessons[reviewState.currentLessonIndex]?.title || 'Ù†Ø¯Ø§Ø±ÛŒÙ…'}`, 'info');
            } else {
                addLog(`   Ø¯Ø±Ø³ Ø¬Ø§Ø±ÛŒ: Ø´Ø±ÙˆØ¹ Ù†Ø´Ø¯Ù‡`, 'info');
            }
            addLog(`   ØªÙ…Ø±ÛŒÙ† ÙØ¹Ø§Ù„: ${reviewState.currentExercise ? 'Ø¯Ø§Ø±ÛŒÙ…' : 'Ù†Ø¯Ø§Ø±ÛŒÙ…'}`, 'info');
            addLog(`   ØªØ§Ø±ÛŒØ®Ú†Ù‡ Ù¾Ø§Ø³Ø®â€ŒÙ‡Ø§: ${reviewState.history.length} Ù…ÙˆØ±Ø¯`, 'info');
        }

        // Ø±Ø§Ù‡â€ŒØ§Ù†Ø¯Ø§Ø²ÛŒ Ø§ÙˆÙ„ÛŒÙ‡ Ø®ÙˆØ¯Ú©Ø§Ø±
        window.onload = function() {
            initTest();
        };
    </script>
</body>
</html>
