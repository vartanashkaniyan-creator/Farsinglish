<!DOCTYPE html>
<html lang="fa">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Farsinglish - ØªØ³Øª Ø°Ø®ÛŒØ±Ù‡â€ŒØ³Ø§Ø²ÛŒ State Ø¯Ø± IndexedDB</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif;
            background: linear-gradient(135deg, #1a2980 0%, #26d0ce 100%);
            color: #f5f5f5;
            min-height: 100vh;
            padding: 15px;
        }
        .container { 
            max-width: 900px; 
            margin: 0 auto;
            background: rgba(20, 25, 45, 0.9);
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.5);
            border: 1px solid rgba(64, 224, 208, 0.3);
        }
        h1 { 
            text-align: center; 
            margin-bottom: 25px;
            font-size: 1.8rem;
            color: #40e0d0;
            text-shadow: 0 2px 4px rgba(0,0,0,0.3);
        }
        .test-section { 
            margin: 15px 0;
            padding: 15px;
            background: rgba(30, 35, 60, 0.8);
            border-radius: 10px;
            border-left: 4px solid #ff6b6b;
            transition: all 0.3s;
        }
        .test-section:hover {
            background: rgba(40, 45, 70, 0.9);
            transform: translateY(-2px);
        }
        .test-header { 
            display: flex; 
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        .test-title { 
            font-size: 1rem; 
            font-weight: 600;
            color: #bb86fc;
        }
        .test-result { 
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 0.8rem;
            font-weight: bold;
        }
        .pass { background: linear-gradient(45deg, #00c853, #64dd17); }
        .fail { background: linear-gradient(45deg, #d50000, #ff5252); }
        .details { 
            margin-top: 10px;
            padding: 12px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            font-size: 0.85rem;
            color: #a5d6a7;
            border: 1px solid rgba(100, 150, 100, 0.2);
            max-height: 200px;
            overflow-y: auto;
        }
        .summary {
            margin-top: 20px;
            padding: 15px;
            background: rgba(30, 40, 60, 0.8);
            border-radius: 10px;
            text-align: center;
            font-size: 0.95rem;
            border: 1px solid rgba(64, 224, 208, 0.3);
        }
        button {
            background: linear-gradient(45deg, #8e2de2, #4a00e0);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            font-size: 0.9rem;
            cursor: pointer;
            margin: 5px;
            transition: all 0.3s;
            font-weight: 600;
        }
        button:hover { 
            transform: translateY(-2px); 
            box-shadow: 0 5px 15px rgba(142, 45, 226, 0.4);
        }
        .controls { text-align: center; margin-top: 20px; }
        .state-viewer {
            background: rgba(0, 0, 0, 0.2);
            padding: 15px;
            border-radius: 10px;
            margin: 15px 0;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        .state-item {
            display: flex;
            justify-content: space-between;
            padding: 8px;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }
        .state-key { color: #bb86fc; }
        .state-value { color: #4fc3f7; }
        .simulator {
            background: rgba(0, 20, 40, 0.6);
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
        }
        .sim-buttons {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            justify-content: center;
            margin: 15px 0;
        }
        .sim-btn {
            background: linear-gradient(45deg, #2196F3, #21CBF3);
            flex: 1;
            min-width: 120px;
        }
        .sim-btn.delete {
            background: linear-gradient(45deg, #f44336, #ff7961);
        }
        @media (max-width: 600px) {
            .container { padding: 12px; }
            .test-header { flex-direction: column; align-items: flex-start; }
            .sim-buttons { flex-direction: column; }
            .sim-btn { width: 100%; }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ’¾ ØªØ³Øª Ø°Ø®ÛŒØ±Ù‡â€ŒØ³Ø§Ø²ÛŒ State Ø¯Ø± IndexedDB</h1>
        
        <div class="simulator">
            <h3 style="text-align: center; color: #4fc3f7; margin-bottom: 15px;">ğŸ”§ Ø´Ø¨ÛŒÙ‡â€ŒØ³Ø§Ø² State</h3>
            <div class="sim-buttons">
                <button class="sim-btn" onclick="simulateUserLogin()">ğŸ‘¤ ÙˆØ±ÙˆØ¯ Ú©Ø§Ø±Ø¨Ø±</button>
                <button class="sim-btn" onclick="simulateLessonProgress()">ğŸ“š Ù¾ÛŒØ´Ø±ÙØª Ø¯Ø±Ø³</button>
                <button class="sim-btn" onclick="simulateSettingsChange()">âš™ï¸ ØªØºÛŒÛŒØ± ØªÙ†Ø¸ÛŒÙ…Ø§Øª</button>
                <button class="sim-btn" onclick="simulateLargeState()">ğŸ“Š State Ø¨Ø²Ø±Ú¯</button>
                <button class="sim-btn delete" onclick="clearAllStates()">ğŸ—‘ï¸ Ø­Ø°Ù Ù‡Ù…Ù‡</button>
            </div>
            <div class="state-viewer">
                <h4>ğŸ“‹ State ÙØ¹Ù„ÛŒ Ø¯Ø± Ø­Ø§ÙØ¸Ù‡:</h4>
                <div id="current-state"></div>
            </div>
        </div>
        
        <div id="test-results"></div>
        
        <div class="summary">
            <p id="summary-text">Ø¢Ù…Ø§Ø¯Ù‡ Ø§Ø¬Ø±Ø§ÛŒ Û±Û² ØªØ³Øª Ø°Ø®ÛŒØ±Ù‡â€ŒØ³Ø§Ø²ÛŒ...</p>
        </div>
        
        <div class="controls">
            <button onclick="runAllTests()">ğŸš€ Ø§Ø¬Ø±Ø§ÛŒ ØªÙ…Ø§Ù… ØªØ³Øªâ€ŒÙ‡Ø§</button>
            <button onclick="clearTests()" style="background: linear-gradient(45deg, #757575, #9e9e9e);">â™»ï¸ Ø¨Ø§Ø²Ù†Ø´Ø§Ù†ÛŒ</button>
        </div>
    </div>

    <script>
        // ==================== State Persistence Service ====================
        class StatePersistenceService {
            constructor() {
                this.dbName = 'farsinglish_state_db';
                this.dbVersion = 1;
                this.storeName = 'app_states';
                this.db = null;
                this.currentState = null;
                this.autoSave = true;
            }

            // ========== IndexedDB Management ==========
            async initDatabase() {
                return new Promise((resolve, reject) => {
                    const request = indexedDB.open(this.dbName, this.dbVersion);
                    
                    request.onerror = () => reject(new Error('Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø§Ø² Ú©Ø±Ø¯Ù† Ø¯ÛŒØªØ§Ø¨ÛŒØ³'));
                    
                    request.onsuccess = (event) => {
                        this.db = event.target.result;
                        console.log('âœ… Ø¯ÛŒØªØ§Ø¨ÛŒØ³ State Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø´Ø¯');
                        resolve(this.db);
                    };
                    
                    request.onupgradeneeded = (event) => {
                        const db = event.target.result;
                        if (!db.objectStoreNames.contains(this.storeName)) {
                            const store = db.createObjectStore(this.storeName, { keyPath: 'id' });
                            store.createIndex('timestamp', 'timestamp', { unique: false });
                            store.createIndex('stateType', 'stateType', { unique: false });
                            console.log('ğŸ“¦ ObjectStore State Ø§ÛŒØ¬Ø§Ø¯ Ø´Ø¯');
                        }
                    };
                });
            }

            // ========== State Operations ==========
            async saveState(stateId, stateData, metadata = {}) {
                if (!this.db) await this.initDatabase();
                
                return new Promise((resolve, reject) => {
                    const transaction = this.db.transaction([this.storeName], 'readwrite');
                    const store = transaction.objectStore(this.storeName);
                    
                    const stateRecord = {
                        id: stateId,
                        data: this.deepClone(stateData),
                        timestamp: Date.now(),
                        stateType: metadata.type || 'general',
                        version: metadata.version || '1.0',
                        checksum: this.calculateChecksum(stateData),
                        ...metadata
                    };
                    
                    const request = store.put(stateRecord);
                    
                    request.onsuccess = () => {
                        console.log(`âœ… State "${stateId}" Ø°Ø®ÛŒØ±Ù‡ Ø´Ø¯`, stateRecord);
                        resolve(stateRecord);
                    };
                    
                    request.onerror = () => reject(new Error('Ø®Ø·Ø§ Ø¯Ø± Ø°Ø®ÛŒØ±Ù‡ State'));
                });
            }

            async loadState(stateId) {
                if (!this.db) await this.initDatabase();
                
                return new Promise((resolve, reject) => {
                    const transaction = this.db.transaction([this.storeName], 'readonly');
                    const store = transaction.objectStore(this.storeName);
                    const request = store.get(stateId);
                    
                    request.onsuccess = () => {
                        const result = request.result;
                        if (result) {
                            // Ø§Ø¹ØªØ¨Ø§Ø±Ø³Ù†Ø¬ÛŒ checksum
                            const currentChecksum = this.calculateChecksum(result.data);
                            if (currentChecksum !== result.checksum) {
                                console.warn('âš ï¸ Checksum State Ù…Ø·Ø§Ø¨Ù‚Øª Ù†Ø¯Ø§Ø±Ø¯');
                            }
                            
                            console.log(`ğŸ“¥ State "${stateId}" Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø´Ø¯`, result);
                            this.currentState = result.data;
                            resolve(result);
                        } else {
                            resolve(null);
                        }
                    };
                    
                    request.onerror = () => reject(new Error('Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ State'));
                });
            }

            async deleteState(stateId) {
                if (!this.db) await this.initDatabase();
                
                return new Promise((resolve, reject) => {
                    const transaction = this.db.transaction([this.storeName], 'readwrite');
                    const store = transaction.objectStore(this.storeName);
                    const request = store.delete(stateId);
                    
                    request.onsuccess = () => {
                        console.log(`ğŸ—‘ï¸ State "${stateId}" Ø­Ø°Ù Ø´Ø¯`);
                        resolve(true);
                    };
                    
                    request.onerror = () => reject(new Error('Ø®Ø·Ø§ Ø¯Ø± Ø­Ø°Ù State'));
                });
            }

            async getAllStates() {
                if (!this.db) await this.initDatabase();
                
                return new Promise((resolve, reject) => {
                    const transaction = this.db.transaction([this.storeName], 'readonly');
                    const store = transaction.objectStore(this.storeName);
                    const request = store.getAll();
                    
                    request.onsuccess = () => resolve(request.result);
                    request.onerror = () => reject(new Error('Ø®Ø·Ø§ Ø¯Ø± Ø¯Ø±ÛŒØ§ÙØª Ù„ÛŒØ³Øª StateÙ‡Ø§'));
                });
            }

            async clearAllStates() {
                if (!this.db) await this.initDatabase();
                
                return new Promise((resolve, reject) => {
                    const transaction = this.db.transaction([this.storeName], 'readwrite');
                    const store = transaction.objectStore(this.storeName);
                    const request = store.clear();
                    
                    request.onsuccess = () => {
                        console.log('ğŸ§¹ ØªÙ…Ø§Ù… StateÙ‡Ø§ Ø­Ø°Ù Ø´Ø¯Ù†Ø¯');
                        resolve(true);
                    };
                    
                    request.onerror = () => reject(new Error('Ø®Ø·Ø§ Ø¯Ø± Ø­Ø°Ù StateÙ‡Ø§'));
                });
            }

            async getStatesByType(stateType) {
                if (!this.db) await this.initDatabase();
                
                return new Promise((resolve, reject) => {
                    const transaction = this.db.transaction([this.storeName], 'readonly');
                    const store = transaction.objectStore(this.storeName);
                    const index = store.index('stateType');
                    const request = index.getAll(stateType);
                    
                    request.onsuccess = () => resolve(request.result);
                    request.onerror = () => reject(new Error(`Ø®Ø·Ø§ Ø¯Ø± Ø¯Ø±ÛŒØ§ÙØª StateÙ‡Ø§ÛŒ Ù†ÙˆØ¹ ${stateType}`));
                });
            }

            // ========== State Compression ==========
            compressState(state) {
                try {
                    const json = JSON.stringify(state);
                    // Ø´Ø¨ÛŒÙ‡â€ŒØ³Ø§Ø²ÛŒ compression Ø³Ø§Ø¯Ù‡
                    return {
                        compressed: true,
                        originalSize: json.length,
                        data: state // Ø¯Ø± ÙˆØ§Ù‚Ø¹ÛŒØª Ø§ÛŒÙ†Ø¬Ø§ compression Ø§Ù†Ø¬Ø§Ù… Ù…ÛŒâ€ŒØ´Ø¯
                    };
                } catch (error) {
                    console.error('Ø®Ø·Ø§ Ø¯Ø± ÙØ´Ø±Ø¯Ù‡â€ŒØ³Ø§Ø²ÛŒ:', error);
                    return state;
                }
            }

            // ========== State Recovery ==========
            async recoverFromBackup(stateId) {
                try {
                    // Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø¢Ø®Ø±ÛŒÙ† Ù†Ø³Ø®Ù‡ Ø³Ø§Ù„Ù…
                    const allStates = await this.getAllStates();
                    const stateVersions = allStates.filter(s => s.id.startsWith(stateId));
                    
                    if (stateVersions.length === 0) {
                        return null;
                    }
                    
                    // Ù…Ø±ØªØ¨â€ŒØ³Ø§Ø²ÛŒ Ø¨Ø± Ø§Ø³Ø§Ø³ timestamp
                    stateVersions.sort((a, b) => b.timestamp - a.timestamp);
                    
                    // Ø¨Ø±Ø±Ø³ÛŒ checksum Ù‡Ø± Ù†Ø³Ø®Ù‡
                    for (const version of stateVersions) {
                        const checksum = this.calculateChecksum(version.data);
                        if (checksum === version.checksum) {
                            console.log(`ğŸ”„ Ø¨Ø§Ø²ÛŒØ§Ø¨ÛŒ State "${stateId}" Ø§Ø² Ù†Ø³Ø®Ù‡ ${new Date(version.timestamp).toLocaleTimeString()}`);
                            return version;
                        }
                    }
                    
                    console.warn('âš ï¸ Ù‡ÛŒÚ† Ù†Ø³Ø®Ù‡ Ø³Ø§Ù„Ù…ÛŒ Ø¨Ø±Ø§ÛŒ Ø¨Ø§Ø²ÛŒØ§Ø¨ÛŒ ÛŒØ§ÙØª Ù†Ø´Ø¯');
                    return null;
                } catch (error) {
                    console.error('Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø§Ø²ÛŒØ§Ø¨ÛŒ:', error);
                    return null;
                }
            }

            // ========== Utility Methods ==========
            deepClone(obj) {
                if (obj === null || typeof obj !== 'object') return obj;
                return JSON.parse(JSON.stringify(obj));
            }

            calculateChecksum(data) {
                const json = JSON.stringify(data);
                let hash = 0;
                for (let i = 0; i < json.length; i++) {
                    const char = json.charCodeAt(i);
                    hash = ((hash << 5) - hash) + char;
                    hash = hash & hash; // ØªØ¨Ø¯ÛŒÙ„ Ø¨Ù‡ 32-bit integer
                }
                return hash.toString(16);
            }

            generateStateId(prefix = 'state') {
                return `${prefix}_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
            }

            async getDatabaseInfo() {
                if (!this.db) await this.initDatabase();
                
                const allStates = await this.getAllStates();
                const totalSize = JSON.stringify(allStates).length;
                
                return {
                    totalStates: allStates.length,
                    totalSizeKB: (totalSize / 1024).toFixed(2),
                    stateTypes: [...new Set(allStates.map(s => s.stateType))],
                    lastUpdate: allStates.length > 0 ? 
                        new Date(Math.max(...allStates.map(s => s.timestamp))) : 
                        null
                };
            }
        }

        // ==================== ØªØ³Øªâ€ŒÙ‡Ø§ ====================
        const persistenceTests = [
            {
                id: 1,
                title: "Ø°Ø®ÛŒØ±Ù‡â€ŒØ³Ø§Ø²ÛŒ State Ú©Ø§Ø±Ø¨Ø±",
                run: async (service) => {
                    const userState = {
                        user: {
                            id: "user_123",
                            username: "Ø¹Ù„ÛŒ Ù…Ø­Ù…Ø¯ÛŒ",
                            level: 5,
                            xp: 1250,
                            lastLogin: new Date().toISOString()
                        },
                        preferences: {
                            theme: "dark",
                            language: "fa",
                            notifications: true
                        }
                    };
                    
                    const stateId = service.generateStateId('user');
                    await service.saveState(stateId, userState, { 
                        type: 'user', 
                        version: '1.1' 
                    });
                    
                    const loaded = await service.loadState(stateId);
                    return loaded && 
                           loaded.data.user.username === "Ø¹Ù„ÛŒ Ù…Ø­Ù…Ø¯ÛŒ" &&
                           loaded.data.preferences.language === "fa";
                }
            },
            {
                id: 2,
                title: "Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ State Ø¯Ø±Ø³",
                run: async (service) => {
                    const lessonState = {
                        currentLesson: {
                            id: "lesson_456",
                            title: "Ù…Ú©Ø§Ù„Ù…Ù‡ Ø±ÙˆØ²Ù…Ø±Ù‡",
                            progress: 75,
                            lastReview: Date.now() - 86400000,
                            nextReview: Date.now() + 86400000
                        },
                        vocabulary: [
                            { word: "hello", meaning: "Ø³Ù„Ø§Ù…", mastered: true },
                            { word: "thank you", meaning: "Ù…ØªØ´Ú©Ø±Ù…", mastered: false }
                        ]
                    };
                    
                    const stateId = "lesson_current_456";
                    await service.saveState(stateId, lessonState, { type: 'lesson' });
                    
                    const loaded = await service.loadState(stateId);
                    return loaded && 
                           loaded.data.currentLesson.progress === 75 &&
                           loaded.data.vocabulary.length === 2;
                }
            },
            {
                id: 3,
                title: "Ø­Ø°Ù State",
                run: async (service) => {
                    const tempState = { test: "Ø­Ø°Ù Ø®ÙˆØ§Ù‡Ø¯ Ø´Ø¯" };
                    const stateId = "temp_state_to_delete";
                    
                    await service.saveState(stateId, tempState, { type: 'test' });
                    await service.deleteState(stateId);
                    
                    const loaded = await service.loadState(stateId);
                    return loaded === null;
                }
            },
            {
                id: 4,
                title: "Ø¯Ø±ÛŒØ§ÙØª Ù‡Ù…Ù‡ StateÙ‡Ø§",
                run: async (service) => {
                    // Ø­Ø°Ù StateÙ‡Ø§ÛŒ Ù‚Ø¨Ù„ÛŒ Ø¨Ø±Ø§ÛŒ ØªØ³Øª ØªÙ…ÛŒØ²
                    await service.clearAllStates();
                    
                    // Ø°Ø®ÛŒØ±Ù‡ Ú†Ù†Ø¯ State
                    await service.saveState("state1", { data: "Ø§ÙˆÙ„" }, { type: 'test' });
                    await service.saveState("state2", { data: "Ø¯ÙˆÙ…" }, { type: 'test' });
                    await service.saveState("state3", { data: "Ø³ÙˆÙ…" }, { type: 'other' });
                    
                    const allStates = await service.getAllStates();
                    return allStates.length === 3;
                }
            },
            {
                id: 5,
                title: "ÙÛŒÙ„ØªØ± StateÙ‡Ø§ Ø¨Ø± Ø§Ø³Ø§Ø³ Ù†ÙˆØ¹",
                run: async (service) => {
                    await service.clearAllStates();
                    
                    await service.saveState("user_1", { name: "Ú©Ø§Ø±Ø¨Ø±Û±" }, { type: 'user' });
                    await service.saveState("user_2", { name: "Ú©Ø§Ø±Ø¨Ø±Û²" }, { type: 'user' });
                    await service.saveState("lesson_1", { title: "Ø¯Ø±Ø³Û±" }, { type: 'lesson' });
                    
                    const userStates = await service.getStatesByType('user');
                    return userStates.length === 2;
                }
            },
            {
                id: 6,
                title: "Checksum Ø¨Ø±Ø§ÛŒ ÛŒÚ©Ù¾Ø§Ø±Ú†Ú¯ÛŒ Ø¯Ø§Ø¯Ù‡",
                run: async (service) => {
                    const testState = { important: "Ø¯Ø§Ø¯Ù‡ Ù…Ù‡Ù…", number: 42 };
                    const stateId = "checksum_test";
                    
                    const saved = await service.saveState(stateId, testState);
                    const loaded = await service.loadState(stateId);
                    
                    const originalChecksum = service.calculateChecksum(testState);
                    return saved.checksum === loaded.checksum && 
                           loaded.checksum === originalChecksum;
                }
            },
            {
                id: 7,
                title: "Ø¨Ø§Ø²ÛŒØ§Ø¨ÛŒ Ø§Ø² Ù†Ø³Ø®Ù‡â€ŒÙ‡Ø§ÛŒ Ù‚Ø¨Ù„ÛŒ",
                run: async (service) => {
                    await service.clearAllStates();
                    
                    const stateId = "recovery_test";
                    const stateV1 = { version: 1, data: "Ù†Ø³Ø®Ù‡ Ø§ÙˆÙ„" };
                    const stateV2 = { version: 2, data: "Ù†Ø³Ø®Ù‡ Ø¯ÙˆÙ…" };
                    
                    // Ø°Ø®ÛŒØ±Ù‡ Ø¯Ùˆ Ù†Ø³Ø®Ù‡
                    await service.saveState(stateId, stateV1, { version: '1.0' });
                    await new Promise(resolve => setTimeout(resolve, 100));
                    await service.saveState(stateId, stateV2, { version: '2.0' });
                    
                    // Ø­Ø°Ù Ø¢Ø®Ø±ÛŒÙ† Ù†Ø³Ø®Ù‡
                    await service.deleteState(stateId);
                    
                    // Ø¨Ø§Ø²ÛŒØ§Ø¨ÛŒ
                    const recovered = await service.recoverFromBackup(stateId);
                    return recovered && recovered.data.version === 1;
                }
            },
            {
                id: 8,
                title: "State Ø¨Ø²Ø±Ú¯ (Performance)",
                run: async (service) => {
                    // Ø§ÛŒØ¬Ø§Ø¯ State Ø¨Ø§ Ø­Ø¬Ù… Ù†Ø³Ø¨ØªØ§Ù‹ Ø¨Ø²Ø±Ú¯
                    const largeState = {
                        vocabulary: Array.from({ length: 100 }, (_, i) => ({
                            id: `word_${i}`,
                            english: `word${i}`,
                            persian: `Ú©Ù„Ù…Ù‡ ${i}`,
                            example: `This is example ${i}`,
                            mastered: i % 3 === 0,
                            reviews: Array.from({ length: 10 }, (_, j) => ({
                                date: Date.now() - j * 86400000,
                                score: Math.random() * 100
                            }))
                        })),
                        metadata: {
                            totalWords: 100,
                            masteredCount: 34,
                            averageScore: 78.5
                        }
                    };
                    
                    const stateId = "large_vocabulary_state";
                    const startTime = performance.now();
                    
                    await service.saveState(stateId, largeState, { type: 'vocabulary' });
                    const loaded = await service.loadState(stateId);
                    
                    const endTime = performance.now();
                    const duration = endTime - startTime;
                    
                    console.log(`â±ï¸ Ø²Ù…Ø§Ù† Ø°Ø®ÛŒØ±Ù‡/Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ State Ø¨Ø²Ø±Ú¯: ${duration.toFixed(2)}ms`);
                    
                    return loaded && 
                           loaded.data.vocabulary.length === 100 &&
                           duration < 5000; // Ø¨Ø§ÛŒØ¯ Ø²ÛŒØ± 5 Ø«Ø§Ù†ÛŒÙ‡ Ø¨Ø§Ø´Ø¯
                }
            },
            {
                id: 9,
                title: "Deep Clone ØµØ­ÛŒØ­",
                run: async (service) => {
                    const original = {
                        nested: {
                            data: "Ø§ØµÙ„ÛŒ",
                            numbers: [1, 2, 3],
                            deep: { level: 3 }
                        }
                    };
                    
                    const cloned = service.deepClone(original);
                    cloned.nested.data = "ØªØºÛŒÛŒØ± ÛŒØ§ÙØªÙ‡";
                    cloned.nested.numbers.push(4);
                    cloned.nested.deep.level = 999;
                    
                    // original Ù†Ø¨Ø§ÛŒØ¯ ØªØºÛŒÛŒØ± Ú©Ø±Ø¯Ù‡ Ø¨Ø§Ø´Ø¯
                    return original.nested.data === "Ø§ØµÙ„ÛŒ" &&
                           original.nested.numbers.length === 3 &&
                           original.nested.deep.level === 3;
                }
            },
            {
                id: 10,
                title: "Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø¯ÛŒØªØ§Ø¨ÛŒØ³",
                run: async (service) => {
                    await service.clearAllStates();
                    
                    await service.saveState("info_test_1", { test: 1 }, { type: 'test' });
                    await service.saveState("info_test_2", { test: 2 }, { type: 'test' });
                    await service.saveState("user_info", { user: "test" }, { type: 'user' });
                    
                    const info = await service.getDatabaseInfo();
                    return info.totalStates === 3 &&
                           info.stateTypes.includes('test') &&
                           info.stateTypes.includes('user');
                }
            },
            {
                id: 11,
                title: "Ù…Ø¯ÛŒØ±ÛŒØª Ø®Ø·Ø§ - Ø¯ÛŒØªØ§Ø¨ÛŒØ³ Ø¨Ø³ØªÙ‡",
                run: async (service) => {
                    // Ø´Ø¨ÛŒÙ‡â€ŒØ³Ø§Ø²ÛŒ Ø®Ø·Ø§ÛŒ Ø¯ÛŒØªØ§Ø¨ÛŒØ³
                    const oldDB = service.db;
                    service.db = null;
                    
                    try {
                        // Ø§ÛŒÙ† Ø¨Ø§ÛŒØ¯ Ø®Ø·Ø§ Ù†Ø¯Ù‡Ø¯ Ùˆ Ø¯ÛŒØªØ§Ø¨ÛŒØ³ Ø±Ø§ Ù…Ø¬Ø¯Ø¯Ø§Ù‹ Ø¨Ø§Ø² Ú©Ù†Ø¯
                        await service.saveState("recovery_test", { data: "ØªØ³Øª" });
                        const loaded = await service.loadState("recovery_test");
                        
                        return loaded !== null;
                    } catch (error) {
                        console.error('Ø®Ø·Ø§ Ø¯Ø± ØªØ³Øª:', error);
                        return false;
                    } finally {
                        service.db = oldDB;
                    }
                }
            },
            {
                id: 12,
                title: "Ú©Ø§Ø±Ø§Ú©ØªØ±Ù‡Ø§ÛŒ ÙØ§Ø±Ø³ÛŒ Ø¯Ø± State",
                run: async (service) => {
                    const farsiState = {
                        title: "Ø¯Ø±Ø³ Ù…Ú©Ø§Ù„Ù…Ù‡ ÙØ§Ø±Ø³ÛŒ",
                        description: "Ø§ÛŒÙ† ÛŒÚ© Ø¯Ø±Ø³ Ø¨Ø±Ø§ÛŒ Ø¢Ù…ÙˆØ²Ø´ Ù…Ú©Ø§Ù„Ù…Ù‡â€ŒÙ‡Ø§ÛŒ Ø±ÙˆØ²Ù…Ø±Ù‡ Ø§Ø³Øª",
                        vocabulary: [
                            { english: "hello", persian: "Ø³Ù„Ø§Ù…" },
                            { english: "thank you", persian: "Ù…ØªØ´Ú©Ø±Ù…" },
                            { english: "goodbye", persian: "Ø®Ø¯Ø§Ø­Ø§ÙØ¸" }
                        ],
                        notes: "ØªÙˆØ¬Ù‡: Ø§ÛŒÙ† Ø¯Ø±Ø³ Ø´Ø§Ù…Ù„ Ù†Ú©Ø§Øª Ù…Ù‡Ù… Ú¯Ø±Ø§Ù…Ø±ÛŒ Ù…ÛŒâ€ŒØ¨Ø§Ø´Ø¯"
                    };
                    
                    const stateId = "farsi_content_lesson";
                    await service.saveState(stateId, farsiState, { 
                        type: 'lesson',
                        language: 'fa'
                    });
                    
                    const loaded = await service.loadState(stateId);
                    return loaded && 
                           loaded.data.title === "Ø¯Ø±Ø³ Ù…Ú©Ø§Ù„Ù…Ù‡ ÙØ§Ø±Ø³ÛŒ" &&
                           loaded.data.vocabulary[1].persian === "Ù…ØªØ´Ú©Ø±Ù…";
                }
            }
        ];

        // ==================== Ø´Ø¨ÛŒÙ‡â€ŒØ³Ø§Ø² ====================
        const stateService = new StatePersistenceService();
        let currentStates = [];

        async function simulateUserLogin() {
            const userState = {
                user: {
                    id: "sim_user_" + Date.now(),
                    username: "Ú©Ø§Ø±Ø¨Ø± Ø´Ø¨ÛŒÙ‡â€ŒØ³Ø§Ø²",
                    level: Math.floor(Math.random() * 10) + 1,
                    xp: Math.floor(Math.random() * 1000),
                    loginCount: Math.floor(Math.random() * 50) + 1
                },
                session: {
                    loginTime: new Date().toISOString(),
                    device: navigator.userAgent.substr(0, 50)
                }
            };
            
            const stateId = stateService.generateStateId('user_session');
            await stateService.saveState(stateId, userState, { 
                type: 'user_session',
                autoGenerated: true
            });
            
            updateStateViewer();
            showMessage(`ğŸ‘¤ State Ú©Ø§Ø±Ø¨Ø± Ø°Ø®ÛŒØ±Ù‡ Ø´Ø¯ (${stateId})`);
        }

        async function simulateLessonProgress() {
            const lessonState = {
                lesson: {
                    id: "lesson_" + Math.floor(Math.random() * 1000),
                    title: ["Ù…Ú©Ø§Ù„Ù…Ù‡ Ù¾Ø§ÛŒÙ‡", "Ú¯Ø±Ø§Ù…Ø± Ù¾ÛŒØ´Ø±ÙØªÙ‡", "ÙˆØ§Ú˜Ú¯Ø§Ù† ØªØ¬Ø§Ø±ÛŒ"][Math.floor(Math.random() * 3)],
                    progress: Math.floor(Math.random() * 100),
                    score: Math.floor(Math.random() * 100),
                    timeSpent: Math.floor(Math.random() * 3600)
                },
                completedExercises: Array.from({ length: Math.floor(Math.random() * 10) + 1 }, (_, i) => ({
                    id: `ex_${i}`,
                    type: ['choice', 'typing', 'listening'][Math.floor(Math.random() * 3)],
                    score: Math.floor(Math.random() * 100),
                    time: Math.floor(Math.random() * 300)
                }))
            };
            
            const stateId = stateService.generateStateId('lesson_progress');
            await stateService.saveState(stateId, lessonState, { 
                type: 'lesson_progress',
                autoGenerated: true
            });
            
            updateStateViewer();
            showMessage(`ğŸ“š State Ø¯Ø±Ø³ Ø°Ø®ÛŒØ±Ù‡ Ø´Ø¯ (${stateId})`);
        }

        async function simulateSettingsChange() {
            const settingsState = {
                preferences: {
                    theme: ['dark', 'light', 'auto'][Math.floor(Math.random() * 3)],
                    language: ['fa', 'en'][Math.floor(Math.random() * 2)],
                    fontSize: Math.floor(Math.random() * 5) + 12,
                    sound: Math.random() > 0.5,
                    notifications: Math.random() > 0.5
                },
                lastUpdated: new Date().toISOString()
            };
            
            const stateId = "user_settings";
            await stateService.saveState(stateId, settingsState, { 
                type: 'settings',
                autoGenerated: true
            });
            
            updateStateViewer();
            showMessage(`âš™ï¸ State ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ø¨Ù‡â€ŒØ±ÙˆØ² Ø´Ø¯`);
        }

        async function simulateLargeState() {
            const largeState = {
                timestamp: Date.now(),
                data: Array.from({ length: 50 }, (_, i) => ({
                    id: `item_${i}`,
                    value: `Ù…Ù‚Ø¯Ø§Ø± ${i}`,
                    metadata: {
                        created: Date.now() - i * 1000,
                        tags: ['tag1', 'tag2', 'tag3'].slice(0, Math.floor(Math.random() * 3) + 1),
                        active: Math.random() > 0.5
                    }
                })),
                summary: {
                    totalItems: 50,
                    activeItems: 25,
                    lastUpdate: new Date().toISOString()
                }
            };
            
            const stateId = stateService.generateStateId('large_data');
            await stateService.saveState(stateId, largeState, { 
                type: 'bulk_data',
                autoGenerated: true
            });
            
            updateStateViewer();
            showMessage(`ğŸ“Š State Ø¨Ø²Ø±Ú¯ (50 Ø¢ÛŒØªÙ…) Ø°Ø®ÛŒØ±Ù‡ Ø´Ø¯`);
        }

        async function clearAllStates() {
            await stateService.clearAllStates();
            updateStateViewer();
            showMessage('ğŸ—‘ï¸ ØªÙ…Ø§Ù… StateÙ‡Ø§ Ø­Ø°Ù Ø´Ø¯Ù†Ø¯');
        }

        async function updateStateViewer() {
            const states = await stateService.getAllStates();
            currentStates = states;
            
            const container = document.getElementById('current-state');
            if (states.length === 0) {
                container.innerHTML = '<div style="color: #888; text-align: center;">Ù‡ÛŒÚ† StateØ§ÛŒ Ø°Ø®ÛŒØ±Ù‡ Ù†Ø´Ø¯Ù‡ Ø§Ø³Øª</div>';
                return;
            }
            
            let html = '';
            states.slice(-5).reverse().forEach(state => {
                const time = new Date(state.timestamp).toLocaleTimeString();
                const size = JSON.stringify(state.data).length;
                
                html += `
                    <div class="state-item">
                        <div class="state-key">${state.id}</div>
                        <div class="state-value">
                            ${state.stateType} â€¢ ${time} â€¢ ${size} Ø¨Ø§ÛŒØª
                        </div>
                    </div>
                `;
            });
            
            if (states.length > 5) {
                html += `<div style="color: #888; text-align: center; padding: 10px;">
                    + ${states.length - 5} State Ø¯ÛŒÚ¯Ø±
                </div>`;
            }
            
            container.innerHTML = html;
        }

        function showMessage(text) {
            console.log('ğŸ’¬ ' + text);
            const summary = document.getElementById('summary-text');
            const originalText = summary.textContent;
            summary.innerHTML = `<span style="color: #4fc3f7;">${text}</span><br>${originalText}`;
            
            setTimeout(() => {
                summary.innerHTML = originalText;
            }, 3000);
        }

        // ==================== Ø§Ø¬Ø±Ø§ÛŒ ØªØ³Øªâ€ŒÙ‡Ø§ ====================
        let passedTests = 0;
        let failedTests = 0;

        async function runAllTests() {
            passedTests = 0;
            failedTests = 0;
            const resultsDiv = document.getElementById('test-results');
            resultsDiv.innerHTML = '';
            
            // Ø­Ø°Ù StateÙ‡Ø§ÛŒ ØªØ³Øª Ù‚Ø¨Ù„ÛŒ
            await stateService.clearAllStates();
            
            for (const test of persistenceTests) {
                try {
                    const result = await test.run(stateService);
                    const testDiv = document.createElement('div');
                    testDiv.className = 'test-section';
                    
                    const testResult = result ? 'pass' : 'fail';
                    const resultText = result ? 'âœ… Ù…ÙˆÙÙ‚' : 'âŒ Ù†Ø§Ù…ÙˆÙÙ‚';
                    
                    if (result) passedTests++;
                    else failedTests++;
                    
                    testDiv.innerHTML = `
                        <div class="test-header">
                            <div class="test-title">${test.id}. ${test.title}</div>
                            <div class="test-result ${testResult}">${resultText}</div>
                        </div>
                    `;
                    
                    resultsDiv.appendChild(testDiv);
                } catch (error) {
                    failedTests++;
                    const testDiv = document.createElement('div');
                    testDiv.className = 'test-section';
                    testDiv.innerHTML = `
                        <div class="test-header">
                            <div class="test-title">${test.id}. ${test.title}</div>
                            <div class="test-result fail">âŒ Ø®Ø·Ø§</div>
                        </div>
                        <div class="details">${error.message}</div>
                    `;
                    resultsDiv.appendChild(testDiv);
                }
                
                updateSummary();
            }
            
            // Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ù†Ù…Ø§ÛŒØ´ StateÙ‡Ø§
            updateStateViewer();
        }

        function clearTests() {
            document.getElementById('test-results').innerHTML = '';
            passedTests = failedTests = 0;
            updateSummary();
        }

        function updateSummary() {
            const summary = document.getElementById('summary-text');
            const total = persistenceTests.length;
            const percentage = total > 0 ? Math.round((passedTests / total) * 100) : 0;
            
            let statusIcon = 'âœ…';
            if (percentage < 70) statusIcon = 'âš ï¸';
            if (percentage < 50) statusIcon = 'ğŸš¨';
            
            summary.innerHTML = `
                <strong>Ù†ØªÛŒØ¬Ù‡ ØªØ³Øªâ€ŒÙ‡Ø§ÛŒ Ø°Ø®ÛŒØ±Ù‡â€ŒØ³Ø§Ø²ÛŒ State:</strong><br>
                ${statusIcon} ${passedTests} Ù…ÙˆÙÙ‚ | âŒ ${failedTests} Ù†Ø§Ù…ÙˆÙÙ‚ | ğŸ“Š ${percentage}% Ù‚Ø¨ÙˆÙ„ÛŒ
            `;
            
            summary.style.color = percentage >= 90 ? '#4caf50' : 
                                 percentage >= 70 ? '#ff9800' : '#f44336';
        }

        // Ø§Ø¬Ø±Ø§ÛŒ Ø®ÙˆØ¯Ú©Ø§Ø± Ùˆ Ø§ÙˆÙ„ÛŒÙ‡
        window.onload = async () => {
            try {
                await stateService.initDatabase();
                updateSummary();
                updateStateViewer();
                setTimeout(runAllTests, 1000);
            } catch (error) {
                console.error('Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø§ÙˆÙ„ÛŒÙ‡:', error);
                document.getElementById('summary-text').textContent = 
                    'Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø¯ÛŒØªØ§Ø¨ÛŒØ³: ' + error.message;
            }
        };
    </script>
</body>
  </html><!DOCTYPE html>
<html lang="fa">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Farsinglish - ØªØ³Øª Ø°Ø®ÛŒØ±Ù‡â€ŒØ³Ø§Ø²ÛŒ State Ø¯Ø± IndexedDB</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif;
            background: linear-gradient(135deg, #1a2980 0%, #26d0ce 100%);
            color: #f5f5f5;
            min-height: 100vh;
            padding: 15px;
        }
        .container { 
            max-width: 900px; 
            margin: 0 auto;
            background: rgba(20, 25, 45, 0.9);
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.5);
            border: 1px solid rgba(64, 224, 208, 0.3);
        }
        h1 { 
            text-align: center; 
            margin-bottom: 25px;
            font-size: 1.8rem;
            color: #40e0d0;
            text-shadow: 0 2px 4px rgba(0,0,0,0.3);
        }
        .test-section { 
            margin: 15px 0;
            padding: 15px;
            background: rgba(30, 35, 60, 0.8);
            border-radius: 10px;
            border-left: 4px solid #ff6b6b;
            transition: all 0.3s;
        }
        .test-section:hover {
            background: rgba(40, 45, 70, 0.9);
            transform: translateY(-2px);
        }
        .test-header { 
            display: flex; 
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        .test-title { 
            font-size: 1rem; 
            font-weight: 600;
            color: #bb86fc;
        }
        .test-result { 
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 0.8rem;
            font-weight: bold;
        }
        .pass { background: linear-gradient(45deg, #00c853, #64dd17); }
        .fail { background: linear-gradient(45deg, #d50000, #ff5252); }
        .details { 
            margin-top: 10px;
            padding: 12px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            font-size: 0.85rem;
            color: #a5d6a7;
            border: 1px solid rgba(100, 150, 100, 0.2);
            max-height: 200px;
            overflow-y: auto;
        }
        .summary {
            margin-top: 20px;
            padding: 15px;
            background: rgba(30, 40, 60, 0.8);
            border-radius: 10px;
            text-align: center;
            font-size: 0.95rem;
            border: 1px solid rgba(64, 224, 208, 0.3);
        }
        button {
            background: linear-gradient(45deg, #8e2de2, #4a00e0);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            font-size: 0.9rem;
            cursor: pointer;
            margin: 5px;
            transition: all 0.3s;
            font-weight: 600;
        }
        button:hover { 
            transform: translateY(-2px); 
            box-shadow: 0 5px 15px rgba(142, 45, 226, 0.4);
        }
        .controls { text-align: center; margin-top: 20px; }
        .state-viewer {
            background: rgba(0, 0, 0, 0.2);
            padding: 15px;
            border-radius: 10px;
            margin: 15px 0;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        .state-item {
            display: flex;
            justify-content: space-between;
            padding: 8px;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }
        .state-key { color: #bb86fc; }
        .state-value { color: #4fc3f7; }
        .simulator {
            background: rgba(0, 20, 40, 0.6);
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
        }
        .sim-buttons {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            justify-content: center;
            margin: 15px 0;
        }
        .sim-btn {
            background: linear-gradient(45deg, #2196F3, #21CBF3);
            flex: 1;
            min-width: 120px;
        }
        .sim-btn.delete {
            background: linear-gradient(45deg, #f44336, #ff7961);
        }
        @media (max-width: 600px) {
            .container { padding: 12px; }
            .test-header { flex-direction: column; align-items: flex-start; }
            .sim-buttons { flex-direction: column; }
            .sim-btn { width: 100%; }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ’¾ ØªØ³Øª Ø°Ø®ÛŒØ±Ù‡â€ŒØ³Ø§Ø²ÛŒ State Ø¯Ø± IndexedDB</h1>
        
        <div class="simulator">
            <h3 style="text-align: center; color: #4fc3f7; margin-bottom: 15px;">ğŸ”§ Ø´Ø¨ÛŒÙ‡â€ŒØ³Ø§Ø² State</h3>
            <div class="sim-buttons">
                <button class="sim-btn" onclick="simulateUserLogin()">ğŸ‘¤ ÙˆØ±ÙˆØ¯ Ú©Ø§Ø±Ø¨Ø±</button>
                <button class="sim-btn" onclick="simulateLessonProgress()">ğŸ“š Ù¾ÛŒØ´Ø±ÙØª Ø¯Ø±Ø³</button>
                <button class="sim-btn" onclick="simulateSettingsChange()">âš™ï¸ ØªØºÛŒÛŒØ± ØªÙ†Ø¸ÛŒÙ…Ø§Øª</button>
                <button class="sim-btn" onclick="simulateLargeState()">ğŸ“Š State Ø¨Ø²Ø±Ú¯</button>
                <button class="sim-btn delete" onclick="clearAllStates()">ğŸ—‘ï¸ Ø­Ø°Ù Ù‡Ù…Ù‡</button>
            </div>
            <div class="state-viewer">
                <h4>ğŸ“‹ State ÙØ¹Ù„ÛŒ Ø¯Ø± Ø­Ø§ÙØ¸Ù‡:</h4>
                <div id="current-state"></div>
            </div>
        </div>
        
        <div id="test-results"></div>
        
        <div class="summary">
            <p id="summary-text">Ø¢Ù…Ø§Ø¯Ù‡ Ø§Ø¬Ø±Ø§ÛŒ Û±Û² ØªØ³Øª Ø°Ø®ÛŒØ±Ù‡â€ŒØ³Ø§Ø²ÛŒ...</p>
        </div>
        
        <div class="controls">
            <button onclick="runAllTests()">ğŸš€ Ø§Ø¬Ø±Ø§ÛŒ ØªÙ…Ø§Ù… ØªØ³Øªâ€ŒÙ‡Ø§</button>
            <button onclick="clearTests()" style="background: linear-gradient(45deg, #757575, #9e9e9e);">â™»ï¸ Ø¨Ø§Ø²Ù†Ø´Ø§Ù†ÛŒ</button>
        </div>
    </div>

    <script>
        // ==================== State Persistence Service ====================
        class StatePersistenceService {
            constructor() {
                this.dbName = 'farsinglish_state_db';
                this.dbVersion = 1;
                this.storeName = 'app_states';
                this.db = null;
                this.currentState = null;
                this.autoSave = true;
            }

            // ========== IndexedDB Management ==========
            async initDatabase() {
                return new Promise((resolve, reject) => {
                    const request = indexedDB.open(this.dbName, this.dbVersion);
                    
                    request.onerror = () => reject(new Error('Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø§Ø² Ú©Ø±Ø¯Ù† Ø¯ÛŒØªØ§Ø¨ÛŒØ³'));
                    
                    request.onsuccess = (event) => {
                        this.db = event.target.result;
                        console.log('âœ… Ø¯ÛŒØªØ§Ø¨ÛŒØ³ State Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø´Ø¯');
                        resolve(this.db);
                    };
                    
                    request.onupgradeneeded = (event) => {
                        const db = event.target.result;
                        if (!db.objectStoreNames.contains(this.storeName)) {
                            const store = db.createObjectStore(this.storeName, { keyPath: 'id' });
                            store.createIndex('timestamp', 'timestamp', { unique: false });
                            store.createIndex('stateType', 'stateType', { unique: false });
                            console.log('ğŸ“¦ ObjectStore State Ø§ÛŒØ¬Ø§Ø¯ Ø´Ø¯');
                        }
                    };
                });
            }

            // ========== State Operations ==========
            async saveState(stateId, stateData, metadata = {}) {
                if (!this.db) await this.initDatabase();
                
                return new Promise((resolve, reject) => {
                    const transaction = this.db.transaction([this.storeName], 'readwrite');
                    const store = transaction.objectStore(this.storeName);
                    
                    const stateRecord = {
                        id: stateId,
                        data: this.deepClone(stateData),
                        timestamp: Date.now(),
                        stateType: metadata.type || 'general',
                        version: metadata.version || '1.0',
                        checksum: this.calculateChecksum(stateData),
                        ...metadata
                    };
                    
                    const request = store.put(stateRecord);
                    
                    request.onsuccess = () => {
                        console.log(`âœ… State "${stateId}" Ø°Ø®ÛŒØ±Ù‡ Ø´Ø¯`, stateRecord);
                        resolve(stateRecord);
                    };
                    
                    request.onerror = () => reject(new Error('Ø®Ø·Ø§ Ø¯Ø± Ø°Ø®ÛŒØ±Ù‡ State'));
                });
            }

            async loadState(stateId) {
                if (!this.db) await this.initDatabase();
                
                return new Promise((resolve, reject) => {
                    const transaction = this.db.transaction([this.storeName], 'readonly');
                    const store = transaction.objectStore(this.storeName);
                    const request = store.get(stateId);
                    
                    request.onsuccess = () => {
                        const result = request.result;
                        if (result) {
                            // Ø§Ø¹ØªØ¨Ø§Ø±Ø³Ù†Ø¬ÛŒ checksum
                            const currentChecksum = this.calculateChecksum(result.data);
                            if (currentChecksum !== result.checksum) {
                                console.warn('âš ï¸ Checksum State Ù…Ø·Ø§Ø¨Ù‚Øª Ù†Ø¯Ø§Ø±Ø¯');
                            }
                            
                            console.log(`ğŸ“¥ State "${stateId}" Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø´Ø¯`, result);
                            this.currentState = result.data;
                            resolve(result);
                        } else {
                            resolve(null);
                        }
                    };
                    
                    request.onerror = () => reject(new Error('Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ State'));
                });
            }

            async deleteState(stateId) {
                if (!this.db) await this.initDatabase();
                
                return new Promise((resolve, reject) => {
                    const transaction = this.db.transaction([this.storeName], 'readwrite');
                    const store = transaction.objectStore(this.storeName);
                    const request = store.delete(stateId);
                    
                    request.onsuccess = () => {
                        console.log(`ğŸ—‘ï¸ State "${stateId}" Ø­Ø°Ù Ø´Ø¯`);
                        resolve(true);
                    };
                    
                    request.onerror = () => reject(new Error('Ø®Ø·Ø§ Ø¯Ø± Ø­Ø°Ù State'));
                });
            }

            async getAllStates() {
                if (!this.db) await this.initDatabase();
                
                return new Promise((resolve, reject) => {
                    const transaction = this.db.transaction([this.storeName], 'readonly');
                    const store = transaction.objectStore(this.storeName);
                    const request = store.getAll();
                    
                    request.onsuccess = () => resolve(request.result);
                    request.onerror = () => reject(new Error('Ø®Ø·Ø§ Ø¯Ø± Ø¯Ø±ÛŒØ§ÙØª Ù„ÛŒØ³Øª StateÙ‡Ø§'));
                });
            }

            async clearAllStates() {
                if (!this.db) await this.initDatabase();
                
                return new Promise((resolve, reject) => {
                    const transaction = this.db.transaction([this.storeName], 'readwrite');
                    const store = transaction.objectStore(this.storeName);
                    const request = store.clear();
                    
                    request.onsuccess = () => {
                        console.log('ğŸ§¹ ØªÙ…Ø§Ù… StateÙ‡Ø§ Ø­Ø°Ù Ø´Ø¯Ù†Ø¯');
                        resolve(true);
                    };
                    
                    request.onerror = () => reject(new Error('Ø®Ø·Ø§ Ø¯Ø± Ø­Ø°Ù StateÙ‡Ø§'));
                });
            }

            async getStatesByType(stateType) {
                if (!this.db) await this.initDatabase();
                
                return new Promise((resolve, reject) => {
                    const transaction = this.db.transaction([this.storeName], 'readonly');
                    const store = transaction.objectStore(this.storeName);
                    const index = store.index('stateType');
                    const request = index.getAll(stateType);
                    
                    request.onsuccess = () => resolve(request.result);
                    request.onerror = () => reject(new Error(`Ø®Ø·Ø§ Ø¯Ø± Ø¯Ø±ÛŒØ§ÙØª StateÙ‡Ø§ÛŒ Ù†ÙˆØ¹ ${stateType}`));
                });
            }

            // ========== State Compression ==========
            compressState(state) {
                try {
                    const json = JSON.stringify(state);
                    // Ø´Ø¨ÛŒÙ‡â€ŒØ³Ø§Ø²ÛŒ compression Ø³Ø§Ø¯Ù‡
                    return {
                        compressed: true,
                        originalSize: json.length,
                        data: state // Ø¯Ø± ÙˆØ§Ù‚Ø¹ÛŒØª Ø§ÛŒÙ†Ø¬Ø§ compression Ø§Ù†Ø¬Ø§Ù… Ù…ÛŒâ€ŒØ´Ø¯
                    };
                } catch (error) {
                    console.error('Ø®Ø·Ø§ Ø¯Ø± ÙØ´Ø±Ø¯Ù‡â€ŒØ³Ø§Ø²ÛŒ:', error);
                    return state;
                }
            }

            // ========== State Recovery ==========
            async recoverFromBackup(stateId) {
                try {
                    // Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø¢Ø®Ø±ÛŒÙ† Ù†Ø³Ø®Ù‡ Ø³Ø§Ù„Ù…
                    const allStates = await this.getAllStates();
                    const stateVersions = allStates.filter(s => s.id.startsWith(stateId));
                    
                    if (stateVersions.length === 0) {
                        return null;
                    }
                    
                    // Ù…Ø±ØªØ¨â€ŒØ³Ø§Ø²ÛŒ Ø¨Ø± Ø§Ø³Ø§Ø³ timestamp
                    stateVersions.sort((a, b) => b.timestamp - a.timestamp);
                    
                    // Ø¨Ø±Ø±Ø³ÛŒ checksum Ù‡Ø± Ù†Ø³Ø®Ù‡
                    for (const version of stateVersions) {
                        const checksum = this.calculateChecksum(version.data);
                        if (checksum === version.checksum) {
                            console.log(`ğŸ”„ Ø¨Ø§Ø²ÛŒØ§Ø¨ÛŒ State "${stateId}" Ø§Ø² Ù†Ø³Ø®Ù‡ ${new Date(version.timestamp).toLocaleTimeString()}`);
                            return version;
                        }
                    }
                    
                    console.warn('âš ï¸ Ù‡ÛŒÚ† Ù†Ø³Ø®Ù‡ Ø³Ø§Ù„Ù…ÛŒ Ø¨Ø±Ø§ÛŒ Ø¨Ø§Ø²ÛŒØ§Ø¨ÛŒ ÛŒØ§ÙØª Ù†Ø´Ø¯');
                    return null;
                } catch (error) {
                    console.error('Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø§Ø²ÛŒØ§Ø¨ÛŒ:', error);
                    return null;
                }
            }

            // ========== Utility Methods ==========
            deepClone(obj) {
                if (obj === null || typeof obj !== 'object') return obj;
                return JSON.parse(JSON.stringify(obj));
            }

            calculateChecksum(data) {
                const json = JSON.stringify(data);
                let hash = 0;
                for (let i = 0; i < json.length; i++) {
                    const char = json.charCodeAt(i);
                    hash = ((hash << 5) - hash) + char;
                    hash = hash & hash; // ØªØ¨Ø¯ÛŒÙ„ Ø¨Ù‡ 32-bit integer
                }
                return hash.toString(16);
            }

            generateStateId(prefix = 'state') {
                return `${prefix}_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
            }

            async getDatabaseInfo() {
                if (!this.db) await this.initDatabase();
                
                const allStates = await this.getAllStates();
                const totalSize = JSON.stringify(allStates).length;
                
                return {
                    totalStates: allStates.length,
                    totalSizeKB: (totalSize / 1024).toFixed(2),
                    stateTypes: [...new Set(allStates.map(s => s.stateType))],
                    lastUpdate: allStates.length > 0 ? 
                        new Date(Math.max(...allStates.map(s => s.timestamp))) : 
                        null
                };
            }
        }

        // ==================== ØªØ³Øªâ€ŒÙ‡Ø§ ====================
        const persistenceTests = [
            {
                id: 1,
                title: "Ø°Ø®ÛŒØ±Ù‡â€ŒØ³Ø§Ø²ÛŒ State Ú©Ø§Ø±Ø¨Ø±",
                run: async (service) => {
                    const userState = {
                        user: {
                            id: "user_123",
                            username: "Ø¹Ù„ÛŒ Ù…Ø­Ù…Ø¯ÛŒ",
                            level: 5,
                            xp: 1250,
                            lastLogin: new Date().toISOString()
                        },
                        preferences: {
                            theme: "dark",
                            language: "fa",
                            notifications: true
                        }
                    };
                    
                    const stateId = service.generateStateId('user');
                    await service.saveState(stateId, userState, { 
                        type: 'user', 
                        version: '1.1' 
                    });
                    
                    const loaded = await service.loadState(stateId);
                    return loaded && 
                           loaded.data.user.username === "Ø¹Ù„ÛŒ Ù…Ø­Ù…Ø¯ÛŒ" &&
                           loaded.data.preferences.language === "fa";
                }
            },
            {
                id: 2,
                title: "Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ State Ø¯Ø±Ø³",
                run: async (service) => {
                    const lessonState = {
                        currentLesson: {
                            id: "lesson_456",
                            title: "Ù…Ú©Ø§Ù„Ù…Ù‡ Ø±ÙˆØ²Ù…Ø±Ù‡",
                            progress: 75,
                            lastReview: Date.now() - 86400000,
                            nextReview: Date.now() + 86400000
                        },
                        vocabulary: [
                            { word: "hello", meaning: "Ø³Ù„Ø§Ù…", mastered: true },
                            { word: "thank you", meaning: "Ù…ØªØ´Ú©Ø±Ù…", mastered: false }
                        ]
                    };
                    
                    const stateId = "lesson_current_456";
                    await service.saveState(stateId, lessonState, { type: 'lesson' });
                    
                    const loaded = await service.loadState(stateId);
                    return loaded && 
                           loaded.data.currentLesson.progress === 75 &&
                           loaded.data.vocabulary.length === 2;
                }
            },
            {
                id: 3,
                title: "Ø­Ø°Ù State",
                run: async (service) => {
                    const tempState = { test: "Ø­Ø°Ù Ø®ÙˆØ§Ù‡Ø¯ Ø´Ø¯" };
                    const stateId = "temp_state_to_delete";
                    
                    await service.saveState(stateId, tempState, { type: 'test' });
                    await service.deleteState(stateId);
                    
                    const loaded = await service.loadState(stateId);
                    return loaded === null;
                }
            },
            {
                id: 4,
                title: "Ø¯Ø±ÛŒØ§ÙØª Ù‡Ù…Ù‡ StateÙ‡Ø§",
                run: async (service) => {
                    // Ø­Ø°Ù StateÙ‡Ø§ÛŒ Ù‚Ø¨Ù„ÛŒ Ø¨Ø±Ø§ÛŒ ØªØ³Øª ØªÙ…ÛŒØ²
                    await service.clearAllStates();
                    
                    // Ø°Ø®ÛŒØ±Ù‡ Ú†Ù†Ø¯ State
                    await service.saveState("state1", { data: "Ø§ÙˆÙ„" }, { type: 'test' });
                    await service.saveState("state2", { data: "Ø¯ÙˆÙ…" }, { type: 'test' });
                    await service.saveState("state3", { data: "Ø³ÙˆÙ…" }, { type: 'other' });
                    
                    const allStates = await service.getAllStates();
                    return allStates.length === 3;
                }
            },
            {
                id: 5,
                title: "ÙÛŒÙ„ØªØ± StateÙ‡Ø§ Ø¨Ø± Ø§Ø³Ø§Ø³ Ù†ÙˆØ¹",
                run: async (service) => {
                    await service.clearAllStates();
                    
                    await service.saveState("user_1", { name: "Ú©Ø§Ø±Ø¨Ø±Û±" }, { type: 'user' });
                    await service.saveState("user_2", { name: "Ú©Ø§Ø±Ø¨Ø±Û²" }, { type: 'user' });
                    await service.saveState("lesson_1", { title: "Ø¯Ø±Ø³Û±" }, { type: 'lesson' });
                    
                    const userStates = await service.getStatesByType('user');
                    return userStates.length === 2;
                }
            },
            {
                id: 6,
                title: "Checksum Ø¨Ø±Ø§ÛŒ ÛŒÚ©Ù¾Ø§Ø±Ú†Ú¯ÛŒ Ø¯Ø§Ø¯Ù‡",
                run: async (service) => {
                    const testState = { important: "Ø¯Ø§Ø¯Ù‡ Ù…Ù‡Ù…", number: 42 };
                    const stateId = "checksum_test";
                    
                    const saved = await service.saveState(stateId, testState);
                    const loaded = await service.loadState(stateId);
                    
                    const originalChecksum = service.calculateChecksum(testState);
                    return saved.checksum === loaded.checksum && 
                           loaded.checksum === originalChecksum;
                }
            },
            {
                id: 7,
                title: "Ø¨Ø§Ø²ÛŒØ§Ø¨ÛŒ Ø§Ø² Ù†Ø³Ø®Ù‡â€ŒÙ‡Ø§ÛŒ Ù‚Ø¨Ù„ÛŒ",
                run: async (service) => {
                    await service.clearAllStates();
                    
                    const stateId = "recovery_test";
                    const stateV1 = { version: 1, data: "Ù†Ø³Ø®Ù‡ Ø§ÙˆÙ„" };
                    const stateV2 = { version: 2, data: "Ù†Ø³Ø®Ù‡ Ø¯ÙˆÙ…" };
                    
                    // Ø°Ø®ÛŒØ±Ù‡ Ø¯Ùˆ Ù†Ø³Ø®Ù‡
                    await service.saveState(stateId, stateV1, { version: '1.0' });
                    await new Promise(resolve => setTimeout(resolve, 100));
                    await service.saveState(stateId, stateV2, { version: '2.0' });
                    
                    // Ø­Ø°Ù Ø¢Ø®Ø±ÛŒÙ† Ù†Ø³Ø®Ù‡
                    await service.deleteState(stateId);
                    
                    // Ø¨Ø§Ø²ÛŒØ§Ø¨ÛŒ
                    const recovered = await service.recoverFromBackup(stateId);
                    return recovered && recovered.data.version === 1;
                }
            },
            {
                id: 8,
                title: "State Ø¨Ø²Ø±Ú¯ (Performance)",
                run: async (service) => {
                    // Ø§ÛŒØ¬Ø§Ø¯ State Ø¨Ø§ Ø­Ø¬Ù… Ù†Ø³Ø¨ØªØ§Ù‹ Ø¨Ø²Ø±Ú¯
                    const largeState = {
                        vocabulary: Array.from({ length: 100 }, (_, i) => ({
                            id: `word_${i}`,
                            english: `word${i}`,
                            persian: `Ú©Ù„Ù…Ù‡ ${i}`,
                            example: `This is example ${i}`,
                            mastered: i % 3 === 0,
                            reviews: Array.from({ length: 10 }, (_, j) => ({
                                date: Date.now() - j * 86400000,
                                score: Math.random() * 100
                            }))
                        })),
                        metadata: {
                            totalWords: 100,
                            masteredCount: 34,
                            averageScore: 78.5
                        }
                    };
                    
                    const stateId = "large_vocabulary_state";
                    const startTime = performance.now();
                    
                    await service.saveState(stateId, largeState, { type: 'vocabulary' });
                    const loaded = await service.loadState(stateId);
                    
                    const endTime = performance.now();
                    const duration = endTime - startTime;
                    
                    console.log(`â±ï¸ Ø²Ù…Ø§Ù† Ø°Ø®ÛŒØ±Ù‡/Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ State Ø¨Ø²Ø±Ú¯: ${duration.toFixed(2)}ms`);
                    
                    return loaded && 
                           loaded.data.vocabulary.length === 100 &&
                           duration < 5000; // Ø¨Ø§ÛŒØ¯ Ø²ÛŒØ± 5 Ø«Ø§Ù†ÛŒÙ‡ Ø¨Ø§Ø´Ø¯
                }
            },
            {
                id: 9,
                title: "Deep Clone ØµØ­ÛŒØ­",
                run: async (service) => {
                    const original = {
                        nested: {
                            data: "Ø§ØµÙ„ÛŒ",
                            numbers: [1, 2, 3],
                            deep: { level: 3 }
                        }
                    };
                    
                    const cloned = service.deepClone(original);
                    cloned.nested.data = "ØªØºÛŒÛŒØ± ÛŒØ§ÙØªÙ‡";
                    cloned.nested.numbers.push(4);
                    cloned.nested.deep.level = 999;
                    
                    // original Ù†Ø¨Ø§ÛŒØ¯ ØªØºÛŒÛŒØ± Ú©Ø±Ø¯Ù‡ Ø¨Ø§Ø´Ø¯
                    return original.nested.data === "Ø§ØµÙ„ÛŒ" &&
                           original.nested.numbers.length === 3 &&
                           original.nested.deep.level === 3;
                }
            },
            {
                id: 10,
                title: "Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø¯ÛŒØªØ§Ø¨ÛŒØ³",
                run: async (service) => {
                    await service.clearAllStates();
                    
                    await service.saveState("info_test_1", { test: 1 }, { type: 'test' });
                    await service.saveState("info_test_2", { test: 2 }, { type: 'test' });
                    await service.saveState("user_info", { user: "test" }, { type: 'user' });
                    
                    const info = await service.getDatabaseInfo();
                    return info.totalStates === 3 &&
                           info.stateTypes.includes('test') &&
                           info.stateTypes.includes('user');
                }
            },
            {
                id: 11,
                title: "Ù…Ø¯ÛŒØ±ÛŒØª Ø®Ø·Ø§ - Ø¯ÛŒØªØ§Ø¨ÛŒØ³ Ø¨Ø³ØªÙ‡",
                run: async (service) => {
                    // Ø´Ø¨ÛŒÙ‡â€ŒØ³Ø§Ø²ÛŒ Ø®Ø·Ø§ÛŒ Ø¯ÛŒØªØ§Ø¨ÛŒØ³
                    const oldDB = service.db;
                    service.db = null;
                    
                    try {
                        // Ø§ÛŒÙ† Ø¨Ø§ÛŒØ¯ Ø®Ø·Ø§ Ù†Ø¯Ù‡Ø¯ Ùˆ Ø¯ÛŒØªØ§Ø¨ÛŒØ³ Ø±Ø§ Ù…Ø¬Ø¯Ø¯Ø§Ù‹ Ø¨Ø§Ø² Ú©Ù†Ø¯
                        await service.saveState("recovery_test", { data: "ØªØ³Øª" });
                        const loaded = await service.loadState("recovery_test");
                        
                        return loaded !== null;
                    } catch (error) {
                        console.error('Ø®Ø·Ø§ Ø¯Ø± ØªØ³Øª:', error);
                        return false;
                    } finally {
                        service.db = oldDB;
                    }
                }
            },
            {
                id: 12,
                title: "Ú©Ø§Ø±Ø§Ú©ØªØ±Ù‡Ø§ÛŒ ÙØ§Ø±Ø³ÛŒ Ø¯Ø± State",
                run: async (service) => {
                    const farsiState = {
                        title: "Ø¯Ø±Ø³ Ù…Ú©Ø§Ù„Ù…Ù‡ ÙØ§Ø±Ø³ÛŒ",
                        description: "Ø§ÛŒÙ† ÛŒÚ© Ø¯Ø±Ø³ Ø¨Ø±Ø§ÛŒ Ø¢Ù…ÙˆØ²Ø´ Ù…Ú©Ø§Ù„Ù…Ù‡â€ŒÙ‡Ø§ÛŒ Ø±ÙˆØ²Ù…Ø±Ù‡ Ø§Ø³Øª",
                        vocabulary: [
                            { english: "hello", persian: "Ø³Ù„Ø§Ù…" },
                            { english: "thank you", persian: "Ù…ØªØ´Ú©Ø±Ù…" },
                            { english: "goodbye", persian: "Ø®Ø¯Ø§Ø­Ø§ÙØ¸" }
                        ],
                        notes: "ØªÙˆØ¬Ù‡: Ø§ÛŒÙ† Ø¯Ø±Ø³ Ø´Ø§Ù…Ù„ Ù†Ú©Ø§Øª Ù…Ù‡Ù… Ú¯Ø±Ø§Ù…Ø±ÛŒ Ù…ÛŒâ€ŒØ¨Ø§Ø´Ø¯"
                    };
                    
                    const stateId = "farsi_content_lesson";
                    await service.saveState(stateId, farsiState, { 
                        type: 'lesson',
                        language: 'fa'
                    });
                    
                    const loaded = await service.loadState(stateId);
                    return loaded && 
                           loaded.data.title === "Ø¯Ø±Ø³ Ù…Ú©Ø§Ù„Ù…Ù‡ ÙØ§Ø±Ø³ÛŒ" &&
                           loaded.data.vocabulary[1].persian === "Ù…ØªØ´Ú©Ø±Ù…";
                }
            }
        ];

        // ==================== Ø´Ø¨ÛŒÙ‡â€ŒØ³Ø§Ø² ====================
        const stateService = new StatePersistenceService();
        let currentStates = [];

        async function simulateUserLogin() {
            const userState = {
                user: {
                    id: "sim_user_" + Date.now(),
                    username: "Ú©Ø§Ø±Ø¨Ø± Ø´Ø¨ÛŒÙ‡â€ŒØ³Ø§Ø²",
                    level: Math.floor(Math.random() * 10) + 1,
                    xp: Math.floor(Math.random() * 1000),
                    loginCount: Math.floor(Math.random() * 50) + 1
                },
                session: {
                    loginTime: new Date().toISOString(),
                    device: navigator.userAgent.substr(0, 50)
                }
            };
            
            const stateId = stateService.generateStateId('user_session');
            await stateService.saveState(stateId, userState, { 
                type: 'user_session',
                autoGenerated: true
            });
            
            updateStateViewer();
            showMessage(`ğŸ‘¤ State Ú©Ø§Ø±Ø¨Ø± Ø°Ø®ÛŒØ±Ù‡ Ø´Ø¯ (${stateId})`);
        }

        async function simulateLessonProgress() {
            const lessonState = {
                lesson: {
                    id: "lesson_" + Math.floor(Math.random() * 1000),
                    title: ["Ù…Ú©Ø§Ù„Ù…Ù‡ Ù¾Ø§ÛŒÙ‡", "Ú¯Ø±Ø§Ù…Ø± Ù¾ÛŒØ´Ø±ÙØªÙ‡", "ÙˆØ§Ú˜Ú¯Ø§Ù† ØªØ¬Ø§Ø±ÛŒ"][Math.floor(Math.random() * 3)],
                    progress: Math.floor(Math.random() * 100),
                    score: Math.floor(Math.random() * 100),
                    timeSpent: Math.floor(Math.random() * 3600)
                },
                completedExercises: Array.from({ length: Math.floor(Math.random() * 10) + 1 }, (_, i) => ({
                    id: `ex_${i}`,
                    type: ['choice', 'typing', 'listening'][Math.floor(Math.random() * 3)],
                    score: Math.floor(Math.random() * 100),
                    time: Math.floor(Math.random() * 300)
                }))
            };
            
            const stateId = stateService.generateStateId('lesson_progress');
            await stateService.saveState(stateId, lessonState, { 
                type: 'lesson_progress',
                autoGenerated: true
            });
            
            updateStateViewer();
            showMessage(`ğŸ“š State Ø¯Ø±Ø³ Ø°Ø®ÛŒØ±Ù‡ Ø´Ø¯ (${stateId})`);
        }

        async function simulateSettingsChange() {
            const settingsState = {
                preferences: {
                    theme: ['dark', 'light', 'auto'][Math.floor(Math.random() * 3)],
                    language: ['fa', 'en'][Math.floor(Math.random() * 2)],
                    fontSize: Math.floor(Math.random() * 5) + 12,
                    sound: Math.random() > 0.5,
                    notifications: Math.random() > 0.5
                },
                lastUpdated: new Date().toISOString()
            };
            
            const stateId = "user_settings";
            await stateService.saveState(stateId, settingsState, { 
                type: 'settings',
                autoGenerated: true
            });
            
            updateStateViewer();
            showMessage(`âš™ï¸ State ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ø¨Ù‡â€ŒØ±ÙˆØ² Ø´Ø¯`);
        }

        async function simulateLargeState() {
            const largeState = {
                timestamp: Date.now(),
                data: Array.from({ length: 50 }, (_, i) => ({
                    id: `item_${i}`,
                    value: `Ù…Ù‚Ø¯Ø§Ø± ${i}`,
                    metadata: {
                        created: Date.now() - i * 1000,
                        tags: ['tag1', 'tag2', 'tag3'].slice(0, Math.floor(Math.random() * 3) + 1),
                        active: Math.random() > 0.5
                    }
                })),
                summary: {
                    totalItems: 50,
                    activeItems: 25,
                    lastUpdate: new Date().toISOString()
                }
            };
            
            const stateId = stateService.generateStateId('large_data');
            await stateService.saveState(stateId, largeState, { 
                type: 'bulk_data',
                autoGenerated: true
            });
            
            updateStateViewer();
            showMessage(`ğŸ“Š State Ø¨Ø²Ø±Ú¯ (50 Ø¢ÛŒØªÙ…) Ø°Ø®ÛŒØ±Ù‡ Ø´Ø¯`);
        }

        async function clearAllStates() {
            await stateService.clearAllStates();
            updateStateViewer();
            showMessage('ğŸ—‘ï¸ ØªÙ…Ø§Ù… StateÙ‡Ø§ Ø­Ø°Ù Ø´Ø¯Ù†Ø¯');
        }

        async function updateStateViewer() {
            const states = await stateService.getAllStates();
            currentStates = states;
            
            const container = document.getElementById('current-state');
            if (states.length === 0) {
                container.innerHTML = '<div style="color: #888; text-align: center;">Ù‡ÛŒÚ† StateØ§ÛŒ Ø°Ø®ÛŒØ±Ù‡ Ù†Ø´Ø¯Ù‡ Ø§Ø³Øª</div>';
                return;
            }
            
            let html = '';
            states.slice(-5).reverse().forEach(state => {
                const time = new Date(state.timestamp).toLocaleTimeString();
                const size = JSON.stringify(state.data).length;
                
                html += `
                    <div class="state-item">
                        <div class="state-key">${state.id}</div>
                        <div class="state-value">
                            ${state.stateType} â€¢ ${time} â€¢ ${size} Ø¨Ø§ÛŒØª
                        </div>
                    </div>
                `;
            });
            
            if (states.length > 5) {
                html += `<div style="color: #888; text-align: center; padding: 10px;">
                    + ${states.length - 5} State Ø¯ÛŒÚ¯Ø±
                </div>`;
            }
            
            container.innerHTML = html;
        }

        function showMessage(text) {
            console.log('ğŸ’¬ ' + text);
            const summary = document.getElementById('summary-text');
            const originalText = summary.textContent;
            summary.innerHTML = `<span style="color: #4fc3f7;">${text}</span><br>${originalText}`;
            
            setTimeout(() => {
                summary.innerHTML = originalText;
            }, 3000);
        }

        // ==================== Ø§Ø¬Ø±Ø§ÛŒ ØªØ³Øªâ€ŒÙ‡Ø§ ====================
        let passedTests = 0;
        let failedTests = 0;

        async function runAllTests() {
            passedTests = 0;
            failedTests = 0;
            const resultsDiv = document.getElementById('test-results');
            resultsDiv.innerHTML = '';
            
            // Ø­Ø°Ù StateÙ‡Ø§ÛŒ ØªØ³Øª Ù‚Ø¨Ù„ÛŒ
            await stateService.clearAllStates();
            
            for (const test of persistenceTests) {
                try {
                    const result = await test.run(stateService);
                    const testDiv = document.createElement('div');
                    testDiv.className = 'test-section';
                    
                    const testResult = result ? 'pass' : 'fail';
                    const resultText = result ? 'âœ… Ù…ÙˆÙÙ‚' : 'âŒ Ù†Ø§Ù…ÙˆÙÙ‚';
                    
                    if (result) passedTests++;
                    else failedTests++;
                    
                    testDiv.innerHTML = `
                        <div class="test-header">
                            <div class="test-title">${test.id}. ${test.title}</div>
                            <div class="test-result ${testResult}">${resultText}</div>
                        </div>
                    `;
                    
                    resultsDiv.appendChild(testDiv);
                } catch (error) {
                    failedTests++;
                    const testDiv = document.createElement('div');
                    testDiv.className = 'test-section';
                    testDiv.innerHTML = `
                        <div class="test-header">
                            <div class="test-title">${test.id}. ${test.title}</div>
                            <div class="test-result fail">âŒ Ø®Ø·Ø§</div>
                        </div>
                        <div class="details">${error.message}</div>
                    `;
                    resultsDiv.appendChild(testDiv);
                }
                
                updateSummary();
            }
            
            // Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ù†Ù…Ø§ÛŒØ´ StateÙ‡Ø§
            updateStateViewer();
        }

        function clearTests() {
            document.getElementById('test-results').innerHTML = '';
            passedTests = failedTests = 0;
            updateSummary();
        }

        function updateSummary() {
            const summary = document.getElementById('summary-text');
            const total = persistenceTests.length;
            const percentage = total > 0 ? Math.round((passedTests / total) * 100) : 0;
            
            let statusIcon = 'âœ…';
            if (percentage < 70) statusIcon = 'âš ï¸';
            if (percentage < 50) statusIcon = 'ğŸš¨';
            
            summary.innerHTML = `
                <strong>Ù†ØªÛŒØ¬Ù‡ ØªØ³Øªâ€ŒÙ‡Ø§ÛŒ Ø°Ø®ÛŒØ±Ù‡â€ŒØ³Ø§Ø²ÛŒ State:</strong><br>
                ${statusIcon} ${passedTests} Ù…ÙˆÙÙ‚ | âŒ ${failedTests} Ù†Ø§Ù…ÙˆÙÙ‚ | ğŸ“Š ${percentage}% Ù‚Ø¨ÙˆÙ„ÛŒ
            `;
            
            summary.style.color = percentage >= 90 ? '#4caf50' : 
                                 percentage >= 70 ? '#ff9800' : '#f44336';
        }

        // Ø§Ø¬Ø±Ø§ÛŒ Ø®ÙˆØ¯Ú©Ø§Ø± Ùˆ Ø§ÙˆÙ„ÛŒÙ‡
        window.onload = async () => {
            try {
                await stateService.initDatabase();
                updateSummary();
                updateStateViewer();
                setTimeout(runAllTests, 1000);
            } catch (error) {
                console.error('Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø§ÙˆÙ„ÛŒÙ‡:', error);
                document.getElementById('summary-text').textContent = 
                    'Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø¯ÛŒØªØ§Ø¨ÛŒØ³: ' + error.message;
            }
        };
    </script>
</body>
</html><!DOCTYPE html>
<html lang="fa">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Farsinglish - ØªØ³Øª Ø°Ø®ÛŒØ±Ù‡â€ŒØ³Ø§Ø²ÛŒ State Ø¯Ø± IndexedDB</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif;
            background: linear-gradient(135deg, #1a2980 0%, #26d0ce 100%);
            color: #f5f5f5;
            min-height: 100vh;
            padding: 15px;
        }
        .container { 
            max-width: 900px; 
            margin: 0 auto;
            background: rgba(20, 25, 45, 0.9);
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.5);
            border: 1px solid rgba(64, 224, 208, 0.3);
        }
        h1 { 
            text-align: center; 
            margin-bottom: 25px;
            font-size: 1.8rem;
            color: #40e0d0;
            text-shadow: 0 2px 4px rgba(0,0,0,0.3);
        }
        .test-section { 
            margin: 15px 0;
            padding: 15px;
            background: rgba(30, 35, 60, 0.8);
            border-radius: 10px;
            border-left: 4px solid #ff6b6b;
            transition: all 0.3s;
        }
        .test-section:hover {
            background: rgba(40, 45, 70, 0.9);
            transform: translateY(-2px);
        }
        .test-header { 
            display: flex; 
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        .test-title { 
            font-size: 1rem; 
            font-weight: 600;
            color: #bb86fc;
        }
        .test-result { 
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 0.8rem;
            font-weight: bold;
        }
        .pass { background: linear-gradient(45deg, #00c853, #64dd17); }
        .fail { background: linear-gradient(45deg, #d50000, #ff5252); }
        .details { 
            margin-top: 10px;
            padding: 12px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            font-size: 0.85rem;
            color: #a5d6a7;
            border: 1px solid rgba(100, 150, 100, 0.2);
            max-height: 200px;
            overflow-y: auto;
        }
        .summary {
            margin-top: 20px;
            padding: 15px;
            background: rgba(30, 40, 60, 0.8);
            border-radius: 10px;
            text-align: center;
            font-size: 0.95rem;
            border: 1px solid rgba(64, 224, 208, 0.3);
        }
        button {
            background: linear-gradient(45deg, #8e2de2, #4a00e0);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            font-size: 0.9rem;
            cursor: pointer;
            margin: 5px;
            transition: all 0.3s;
            font-weight: 600;
        }
        button:hover { 
            transform: translateY(-2px); 
            box-shadow: 0 5px 15px rgba(142, 45, 226, 0.4);
        }
        .controls { text-align: center; margin-top: 20px; }
        .state-viewer {
            background: rgba(0, 0, 0, 0.2);
            padding: 15px;
            border-radius: 10px;
            margin: 15px 0;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        .state-item {
            display: flex;
            justify-content: space-between;
            padding: 8px;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }
        .state-key { color: #bb86fc; }
        .state-value { color: #4fc3f7; }
        .simulator {
            background: rgba(0, 20, 40, 0.6);
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
        }
        .sim-buttons {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            justify-content: center;
            margin: 15px 0;
        }
        .sim-btn {
            background: linear-gradient(45deg, #2196F3, #21CBF3);
            flex: 1;
            min-width: 120px;
        }
        .sim-btn.delete {
            background: linear-gradient(45deg, #f44336, #ff7961);
        }
        @media (max-width: 600px) {
            .container { padding: 12px; }
            .test-header { flex-direction: column; align-items: flex-start; }
            .sim-buttons { flex-direction: column; }
            .sim-btn { width: 100%; }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ’¾ ØªØ³Øª Ø°Ø®ÛŒØ±Ù‡â€ŒØ³Ø§Ø²ÛŒ State Ø¯Ø± IndexedDB</h1>
        
        <div class="simulator">
            <h3 style="text-align: center; color: #4fc3f7; margin-bottom: 15px;">ğŸ”§ Ø´Ø¨ÛŒÙ‡â€ŒØ³Ø§Ø² State</h3>
            <div class="sim-buttons">
                <button class="sim-btn" onclick="simulateUserLogin()">ğŸ‘¤ ÙˆØ±ÙˆØ¯ Ú©Ø§Ø±Ø¨Ø±</button>
                <button class="sim-btn" onclick="simulateLessonProgress()">ğŸ“š Ù¾ÛŒØ´Ø±ÙØª Ø¯Ø±Ø³</button>
                <button class="sim-btn" onclick="simulateSettingsChange()">âš™ï¸ ØªØºÛŒÛŒØ± ØªÙ†Ø¸ÛŒÙ…Ø§Øª</button>
                <button class="sim-btn" onclick="simulateLargeState()">ğŸ“Š State Ø¨Ø²Ø±Ú¯</button>
                <button class="sim-btn delete" onclick="clearAllStates()">ğŸ—‘ï¸ Ø­Ø°Ù Ù‡Ù…Ù‡</button>
            </div>
            <div class="state-viewer">
                <h4>ğŸ“‹ State ÙØ¹Ù„ÛŒ Ø¯Ø± Ø­Ø§ÙØ¸Ù‡:</h4>
                <div id="current-state"></div>
            </div>
        </div>
        
        <div id="test-results"></div>
        
        <div class="summary">
            <p id="summary-text">Ø¢Ù…Ø§Ø¯Ù‡ Ø§Ø¬Ø±Ø§ÛŒ Û±Û² ØªØ³Øª Ø°Ø®ÛŒØ±Ù‡â€ŒØ³Ø§Ø²ÛŒ...</p>
        </div>
        
        <div class="controls">
            <button onclick="runAllTests()">ğŸš€ Ø§Ø¬Ø±Ø§ÛŒ ØªÙ…Ø§Ù… ØªØ³Øªâ€ŒÙ‡Ø§</button>
            <button onclick="clearTests()" style="background: linear-gradient(45deg, #757575, #9e9e9e);">â™»ï¸ Ø¨Ø§Ø²Ù†Ø´Ø§Ù†ÛŒ</button>
        </div>
    </div>

    <script>
        // ==================== State Persistence Service ====================
        class StatePersistenceService {
            constructor() {
                this.dbName = 'farsinglish_state_db';
                this.dbVersion = 1;
                this.storeName = 'app_states';
                this.db = null;
                this.currentState = null;
                this.autoSave = true;
            }

            // ========== IndexedDB Management ==========
            async initDatabase() {
                return new Promise((resolve, reject) => {
                    const request = indexedDB.open(this.dbName, this.dbVersion);
                    
                    request.onerror = () => reject(new Error('Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø§Ø² Ú©Ø±Ø¯Ù† Ø¯ÛŒØªØ§Ø¨ÛŒØ³'));
                    
                    request.onsuccess = (event) => {
                        this.db = event.target.result;
                        console.log('âœ… Ø¯ÛŒØªØ§Ø¨ÛŒØ³ State Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø´Ø¯');
                        resolve(this.db);
                    };
                    
                    request.onupgradeneeded = (event) => {
                        const db = event.target.result;
                        if (!db.objectStoreNames.contains(this.storeName)) {
                            const store = db.createObjectStore(this.storeName, { keyPath: 'id' });
                            store.createIndex('timestamp', 'timestamp', { unique: false });
                            store.createIndex('stateType', 'stateType', { unique: false });
                            console.log('ğŸ“¦ ObjectStore State Ø§ÛŒØ¬Ø§Ø¯ Ø´Ø¯');
                        }
                    };
                });
            }

            // ========== State Operations ==========
            async saveState(stateId, stateData, metadata = {}) {
                if (!this.db) await this.initDatabase();
                
                return new Promise((resolve, reject) => {
                    const transaction = this.db.transaction([this.storeName], 'readwrite');
                    const store = transaction.objectStore(this.storeName);
                    
                    const stateRecord = {
                        id: stateId,
                        data: this.deepClone(stateData),
                        timestamp: Date.now(),
                        stateType: metadata.type || 'general',
                        version: metadata.version || '1.0',
                        checksum: this.calculateChecksum(stateData),
                        ...metadata
                    };
                    
                    const request = store.put(stateRecord);
                    
                    request.onsuccess = () => {
                        console.log(`âœ… State "${stateId}" Ø°Ø®ÛŒØ±Ù‡ Ø´Ø¯`, stateRecord);
                        resolve(stateRecord);
                    };
                    
                    request.onerror = () => reject(new Error('Ø®Ø·Ø§ Ø¯Ø± Ø°Ø®ÛŒØ±Ù‡ State'));
                });
            }

            async loadState(stateId) {
                if (!this.db) await this.initDatabase();
                
                return new Promise((resolve, reject) => {
                    const transaction = this.db.transaction([this.storeName], 'readonly');
                    const store = transaction.objectStore(this.storeName);
                    const request = store.get(stateId);
                    
                    request.onsuccess = () => {
                        const result = request.result;
                        if (result) {
                            // Ø§Ø¹ØªØ¨Ø§Ø±Ø³Ù†Ø¬ÛŒ checksum
                            const currentChecksum = this.calculateChecksum(result.data);
                            if (currentChecksum !== result.checksum) {
                                console.warn('âš ï¸ Checksum State Ù…Ø·Ø§Ø¨Ù‚Øª Ù†Ø¯Ø§Ø±Ø¯');
                            }
                            
                            console.log(`ğŸ“¥ State "${stateId}" Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø´Ø¯`, result);
                            this.currentState = result.data;
                            resolve(result);
                        } else {
                            resolve(null);
                        }
                    };
                    
                    request.onerror = () => reject(new Error('Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ State'));
                });
            }

            async deleteState(stateId) {
                if (!this.db) await this.initDatabase();
                
                return new Promise((resolve, reject) => {
                    const transaction = this.db.transaction([this.storeName], 'readwrite');
                    const store = transaction.objectStore(this.storeName);
                    const request = store.delete(stateId);
                    
                    request.onsuccess = () => {
                        console.log(`ğŸ—‘ï¸ State "${stateId}" Ø­Ø°Ù Ø´Ø¯`);
                        resolve(true);
                    };
                    
                    request.onerror = () => reject(new Error('Ø®Ø·Ø§ Ø¯Ø± Ø­Ø°Ù State'));
                });
            }

            async getAllStates() {
                if (!this.db) await this.initDatabase();
                
                return new Promise((resolve, reject) => {
                    const transaction = this.db.transaction([this.storeName], 'readonly');
                    const store = transaction.objectStore(this.storeName);
                    const request = store.getAll();
                    
                    request.onsuccess = () => resolve(request.result);
                    request.onerror = () => reject(new Error('Ø®Ø·Ø§ Ø¯Ø± Ø¯Ø±ÛŒØ§ÙØª Ù„ÛŒØ³Øª StateÙ‡Ø§'));
                });
            }

            async clearAllStates() {
                if (!this.db) await this.initDatabase();
                
                return new Promise((resolve, reject) => {
                    const transaction = this.db.transaction([this.storeName], 'readwrite');
                    const store = transaction.objectStore(this.storeName);
                    const request = store.clear();
                    
                    request.onsuccess = () => {
                        console.log('ğŸ§¹ ØªÙ…Ø§Ù… StateÙ‡Ø§ Ø­Ø°Ù Ø´Ø¯Ù†Ø¯');
                        resolve(true);
                    };
                    
                    request.onerror = () => reject(new Error('Ø®Ø·Ø§ Ø¯Ø± Ø­Ø°Ù StateÙ‡Ø§'));
                });
            }

            async getStatesByType(stateType) {
                if (!this.db) await this.initDatabase();
                
                return new Promise((resolve, reject) => {
                    const transaction = this.db.transaction([this.storeName], 'readonly');
                    const store = transaction.objectStore(this.storeName);
                    const index = store.index('stateType');
                    const request = index.getAll(stateType);
                    
                    request.onsuccess = () => resolve(request.result);
                    request.onerror = () => reject(new Error(`Ø®Ø·Ø§ Ø¯Ø± Ø¯Ø±ÛŒØ§ÙØª StateÙ‡Ø§ÛŒ Ù†ÙˆØ¹ ${stateType}`));
                });
            }

            // ========== State Compression ==========
            compressState(state) {
                try {
                    const json = JSON.stringify(state);
                    // Ø´Ø¨ÛŒÙ‡â€ŒØ³Ø§Ø²ÛŒ compression Ø³Ø§Ø¯Ù‡
                    return {
                        compressed: true,
                        originalSize: json.length,
                        data: state // Ø¯Ø± ÙˆØ§Ù‚Ø¹ÛŒØª Ø§ÛŒÙ†Ø¬Ø§ compression Ø§Ù†Ø¬Ø§Ù… Ù…ÛŒâ€ŒØ´Ø¯
                    };
                } catch (error) {
                    console.error('Ø®Ø·Ø§ Ø¯Ø± ÙØ´Ø±Ø¯Ù‡â€ŒØ³Ø§Ø²ÛŒ:', error);
                    return state;
                }
            }

            // ========== State Recovery ==========
            async recoverFromBackup(stateId) {
                try {
                    // Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø¢Ø®Ø±ÛŒÙ† Ù†Ø³Ø®Ù‡ Ø³Ø§Ù„Ù…
                    const allStates = await this.getAllStates();
                    const stateVersions = allStates.filter(s => s.id.startsWith(stateId));
                    
                    if (stateVersions.length === 0) {
                        return null;
                    }
                    
                    // Ù…Ø±ØªØ¨â€ŒØ³Ø§Ø²ÛŒ Ø¨Ø± Ø§Ø³Ø§Ø³ timestamp
                    stateVersions.sort((a, b) => b.timestamp - a.timestamp);
                    
                    // Ø¨Ø±Ø±Ø³ÛŒ checksum Ù‡Ø± Ù†Ø³Ø®Ù‡
                    for (const version of stateVersions) {
                        const checksum = this.calculateChecksum(version.data);
                        if (checksum === version.checksum) {
                            console.log(`ğŸ”„ Ø¨Ø§Ø²ÛŒØ§Ø¨ÛŒ State "${stateId}" Ø§Ø² Ù†Ø³Ø®Ù‡ ${new Date(version.timestamp).toLocaleTimeString()}`);
                            return version;
                        }
                    }
                    
                    console.warn('âš ï¸ Ù‡ÛŒÚ† Ù†Ø³Ø®Ù‡ Ø³Ø§Ù„Ù…ÛŒ Ø¨Ø±Ø§ÛŒ Ø¨Ø§Ø²ÛŒØ§Ø¨ÛŒ ÛŒØ§ÙØª Ù†Ø´Ø¯');
                    return null;
                } catch (error) {
                    console.error('Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø§Ø²ÛŒØ§Ø¨ÛŒ:', error);
                    return null;
                }
            }

            // ========== Utility Methods ==========
            deepClone(obj) {
                if (obj === null || typeof obj !== 'object') return obj;
                return JSON.parse(JSON.stringify(obj));
            }

            calculateChecksum(data) {
                const json = JSON.stringify(data);
                let hash = 0;
                for (let i = 0; i < json.length; i++) {
                    const char = json.charCodeAt(i);
                    hash = ((hash << 5) - hash) + char;
                    hash = hash & hash; // ØªØ¨Ø¯ÛŒÙ„ Ø¨Ù‡ 32-bit integer
                }
                return hash.toString(16);
            }

            generateStateId(prefix = 'state') {
                return `${prefix}_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
            }

            async getDatabaseInfo() {
                if (!this.db) await this.initDatabase();
                
                const allStates = await this.getAllStates();
                const totalSize = JSON.stringify(allStates).length;
                
                return {
                    totalStates: allStates.length,
                    totalSizeKB: (totalSize / 1024).toFixed(2),
                    stateTypes: [...new Set(allStates.map(s => s.stateType))],
                    lastUpdate: allStates.length > 0 ? 
                        new Date(Math.max(...allStates.map(s => s.timestamp))) : 
                        null
                };
            }
        }

        // ==================== ØªØ³Øªâ€ŒÙ‡Ø§ ====================
        const persistenceTests = [
            {
                id: 1,
                title: "Ø°Ø®ÛŒØ±Ù‡â€ŒØ³Ø§Ø²ÛŒ State Ú©Ø§Ø±Ø¨Ø±",
                run: async (service) => {
                    const userState = {
                        user: {
                            id: "user_123",
                            username: "Ø¹Ù„ÛŒ Ù…Ø­Ù…Ø¯ÛŒ",
                            level: 5,
                            xp: 1250,
                            lastLogin: new Date().toISOString()
                        },
                        preferences: {
                            theme: "dark",
                            language: "fa",
                            notifications: true
                        }
                    };
                    
                    const stateId = service.generateStateId('user');
                    await service.saveState(stateId, userState, { 
                        type: 'user', 
                        version: '1.1' 
                    });
                    
                    const loaded = await service.loadState(stateId);
                    return loaded && 
                           loaded.data.user.username === "Ø¹Ù„ÛŒ Ù…Ø­Ù…Ø¯ÛŒ" &&
                           loaded.data.preferences.language === "fa";
                }
            },
            {
                id: 2,
                title: "Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ State Ø¯Ø±Ø³",
                run: async (service) => {
                    const lessonState = {
                        currentLesson: {
                            id: "lesson_456",
                            title: "Ù…Ú©Ø§Ù„Ù…Ù‡ Ø±ÙˆØ²Ù…Ø±Ù‡",
                            progress: 75,
                            lastReview: Date.now() - 86400000,
                            nextReview: Date.now() + 86400000
                        },
                        vocabulary: [
                            { word: "hello", meaning: "Ø³Ù„Ø§Ù…", mastered: true },
                            { word: "thank you", meaning: "Ù…ØªØ´Ú©Ø±Ù…", mastered: false }
                        ]
                    };
                    
                    const stateId = "lesson_current_456";
                    await service.saveState(stateId, lessonState, { type: 'lesson' });
                    
                    const loaded = await service.loadState(stateId);
                    return loaded && 
                           loaded.data.currentLesson.progress === 75 &&
                           loaded.data.vocabulary.length === 2;
                }
            },
            {
                id: 3,
                title: "Ø­Ø°Ù State",
                run: async (service) => {
                    const tempState = { test: "Ø­Ø°Ù Ø®ÙˆØ§Ù‡Ø¯ Ø´Ø¯" };
                    const stateId = "temp_state_to_delete";
                    
                    await service.saveState(stateId, tempState, { type: 'test' });
                    await service.deleteState(stateId);
                    
                    const loaded = await service.loadState(stateId);
                    return loaded === null;
                }
            },
            {
                id: 4,
                title: "Ø¯Ø±ÛŒØ§ÙØª Ù‡Ù…Ù‡ StateÙ‡Ø§",
                run: async (service) => {
                    // Ø­Ø°Ù StateÙ‡Ø§ÛŒ Ù‚Ø¨Ù„ÛŒ Ø¨Ø±Ø§ÛŒ ØªØ³Øª ØªÙ…ÛŒØ²
                    await service.clearAllStates();
                    
                    // Ø°Ø®ÛŒØ±Ù‡ Ú†Ù†Ø¯ State
                    await service.saveState("state1", { data: "Ø§ÙˆÙ„" }, { type: 'test' });
                    await service.saveState("state2", { data: "Ø¯ÙˆÙ…" }, { type: 'test' });
                    await service.saveState("state3", { data: "Ø³ÙˆÙ…" }, { type: 'other' });
                    
                    const allStates = await service.getAllStates();
                    return allStates.length === 3;
                }
            },
            {
                id: 5,
                title: "ÙÛŒÙ„ØªØ± StateÙ‡Ø§ Ø¨Ø± Ø§Ø³Ø§Ø³ Ù†ÙˆØ¹",
                run: async (service) => {
                    await service.clearAllStates();
                    
                    await service.saveState("user_1", { name: "Ú©Ø§Ø±Ø¨Ø±Û±" }, { type: 'user' });
                    await service.saveState("user_2", { name: "Ú©Ø§Ø±Ø¨Ø±Û²" }, { type: 'user' });
                    await service.saveState("lesson_1", { title: "Ø¯Ø±Ø³Û±" }, { type: 'lesson' });
                    
                    const userStates = await service.getStatesByType('user');
                    return userStates.length === 2;
                }
            },
            {
                id: 6,
                title: "Checksum Ø¨Ø±Ø§ÛŒ ÛŒÚ©Ù¾Ø§Ø±Ú†Ú¯ÛŒ Ø¯Ø§Ø¯Ù‡",
                run: async (service) => {
                    const testState = { important: "Ø¯Ø§Ø¯Ù‡ Ù…Ù‡Ù…", number: 42 };
                    const stateId = "checksum_test";
                    
                    const saved = await service.saveState(stateId, testState);
                    const loaded = await service.loadState(stateId);
                    
                    const originalChecksum = service.calculateChecksum(testState);
                    return saved.checksum === loaded.checksum && 
                           loaded.checksum === originalChecksum;
                }
            },
            {
                id: 7,
                title: "Ø¨Ø§Ø²ÛŒØ§Ø¨ÛŒ Ø§Ø² Ù†Ø³Ø®Ù‡â€ŒÙ‡Ø§ÛŒ Ù‚Ø¨Ù„ÛŒ",
                run: async (service) => {
                    await service.clearAllStates();
                    
                    const stateId = "recovery_test";
                    const stateV1 = { version: 1, data: "Ù†Ø³Ø®Ù‡ Ø§ÙˆÙ„" };
                    const stateV2 = { version: 2, data: "Ù†Ø³Ø®Ù‡ Ø¯ÙˆÙ…" };
                    
                    // Ø°Ø®ÛŒØ±Ù‡ Ø¯Ùˆ Ù†Ø³Ø®Ù‡
                    await service.saveState(stateId, stateV1, { version: '1.0' });
                    await new Promise(resolve => setTimeout(resolve, 100));
                    await service.saveState(stateId, stateV2, { version: '2.0' });
                    
                    // Ø­Ø°Ù Ø¢Ø®Ø±ÛŒÙ† Ù†Ø³Ø®Ù‡
                    await service.deleteState(stateId);
                    
                    // Ø¨Ø§Ø²ÛŒØ§Ø¨ÛŒ
                    const recovered = await service.recoverFromBackup(stateId);
                    return recovered && recovered.data.version === 1;
                }
            },
            {
                id: 8,
                title: "State Ø¨Ø²Ø±Ú¯ (Performance)",
                run: async (service) => {
                    // Ø§ÛŒØ¬Ø§Ø¯ State Ø¨Ø§ Ø­Ø¬Ù… Ù†Ø³Ø¨ØªØ§Ù‹ Ø¨Ø²Ø±Ú¯
                    const largeState = {
                        vocabulary: Array.from({ length: 100 }, (_, i) => ({
                            id: `word_${i}`,
                            english: `word${i}`,
                            persian: `Ú©Ù„Ù…Ù‡ ${i}`,
                            example: `This is example ${i}`,
                            mastered: i % 3 === 0,
                            reviews: Array.from({ length: 10 }, (_, j) => ({
                                date: Date.now() - j * 86400000,
                                score: Math.random() * 100
                            }))
                        })),
                        metadata: {
                            totalWords: 100,
                            masteredCount: 34,
                            averageScore: 78.5
                        }
                    };
                    
                    const stateId = "large_vocabulary_state";
                    const startTime = performance.now();
                    
                    await service.saveState(stateId, largeState, { type: 'vocabulary' });
                    const loaded = await service.loadState(stateId);
                    
                    const endTime = performance.now();
                    const duration = endTime - startTime;
                    
                    console.log(`â±ï¸ Ø²Ù…Ø§Ù† Ø°Ø®ÛŒØ±Ù‡/Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ State Ø¨Ø²Ø±Ú¯: ${duration.toFixed(2)}ms`);
                    
                    return loaded && 
                           loaded.data.vocabulary.length === 100 &&
                           duration < 5000; // Ø¨Ø§ÛŒØ¯ Ø²ÛŒØ± 5 Ø«Ø§Ù†ÛŒÙ‡ Ø¨Ø§Ø´Ø¯
                }
            },
            {
                id: 9,
                title: "Deep Clone ØµØ­ÛŒØ­",
                run: async (service) => {
                    const original = {
                        nested: {
                            data: "Ø§ØµÙ„ÛŒ",
                            numbers: [1, 2, 3],
                            deep: { level: 3 }
                        }
                    };
                    
                    const cloned = service.deepClone(original);
                    cloned.nested.data = "ØªØºÛŒÛŒØ± ÛŒØ§ÙØªÙ‡";
                    cloned.nested.numbers.push(4);
                    cloned.nested.deep.level = 999;
                    
                    // original Ù†Ø¨Ø§ÛŒØ¯ ØªØºÛŒÛŒØ± Ú©Ø±Ø¯Ù‡ Ø¨Ø§Ø´Ø¯
                    return original.nested.data === "Ø§ØµÙ„ÛŒ" &&
                           original.nested.numbers.length === 3 &&
                           original.nested.deep.level === 3;
                }
            },
            {
                id: 10,
                title: "Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø¯ÛŒØªØ§Ø¨ÛŒØ³",
                run: async (service) => {
                    await service.clearAllStates();
                    
                    await service.saveState("info_test_1", { test: 1 }, { type: 'test' });
                    await service.saveState("info_test_2", { test: 2 }, { type: 'test' });
                    await service.saveState("user_info", { user: "test" }, { type: 'user' });
                    
                    const info = await service.getDatabaseInfo();
                    return info.totalStates === 3 &&
                           info.stateTypes.includes('test') &&
                           info.stateTypes.includes('user');
                }
            },
            {
                id: 11,
                title: "Ù…Ø¯ÛŒØ±ÛŒØª Ø®Ø·Ø§ - Ø¯ÛŒØªØ§Ø¨ÛŒØ³ Ø¨Ø³ØªÙ‡",
                run: async (service) => {
                    // Ø´Ø¨ÛŒÙ‡â€ŒØ³Ø§Ø²ÛŒ Ø®Ø·Ø§ÛŒ Ø¯ÛŒØªØ§Ø¨ÛŒØ³
                    const oldDB = service.db;
                    service.db = null;
                    
                    try {
                        // Ø§ÛŒÙ† Ø¨Ø§ÛŒØ¯ Ø®Ø·Ø§ Ù†Ø¯Ù‡Ø¯ Ùˆ Ø¯ÛŒØªØ§Ø¨ÛŒØ³ Ø±Ø§ Ù…Ø¬Ø¯Ø¯Ø§Ù‹ Ø¨Ø§Ø² Ú©Ù†Ø¯
                        await service.saveState("recovery_test", { data: "ØªØ³Øª" });
                        const loaded = await service.loadState("recovery_test");
                        
                        return loaded !== null;
                    } catch (error) {
                        console.error('Ø®Ø·Ø§ Ø¯Ø± ØªØ³Øª:', error);
                        return false;
                    } finally {
                        service.db = oldDB;
                    }
                }
            },
            {
                id: 12,
                title: "Ú©Ø§Ø±Ø§Ú©ØªØ±Ù‡Ø§ÛŒ ÙØ§Ø±Ø³ÛŒ Ø¯Ø± State",
                run: async (service) => {
                    const farsiState = {
                        title: "Ø¯Ø±Ø³ Ù…Ú©Ø§Ù„Ù…Ù‡ ÙØ§Ø±Ø³ÛŒ",
                        description: "Ø§ÛŒÙ† ÛŒÚ© Ø¯Ø±Ø³ Ø¨Ø±Ø§ÛŒ Ø¢Ù…ÙˆØ²Ø´ Ù…Ú©Ø§Ù„Ù…Ù‡â€ŒÙ‡Ø§ÛŒ Ø±ÙˆØ²Ù…Ø±Ù‡ Ø§Ø³Øª",
                        vocabulary: [
                            { english: "hello", persian: "Ø³Ù„Ø§Ù…" },
                            { english: "thank you", persian: "Ù…ØªØ´Ú©Ø±Ù…" },
                            { english: "goodbye", persian: "Ø®Ø¯Ø§Ø­Ø§ÙØ¸" }
                        ],
                        notes: "ØªÙˆØ¬Ù‡: Ø§ÛŒÙ† Ø¯Ø±Ø³ Ø´Ø§Ù…Ù„ Ù†Ú©Ø§Øª Ù…Ù‡Ù… Ú¯Ø±Ø§Ù…Ø±ÛŒ Ù…ÛŒâ€ŒØ¨Ø§Ø´Ø¯"
                    };
                    
                    const stateId = "farsi_content_lesson";
                    await service.saveState(stateId, farsiState, { 
                        type: 'lesson',
                        language: 'fa'
                    });
                    
                    const loaded = await service.loadState(stateId);
                    return loaded && 
                           loaded.data.title === "Ø¯Ø±Ø³ Ù…Ú©Ø§Ù„Ù…Ù‡ ÙØ§Ø±Ø³ÛŒ" &&
                           loaded.data.vocabulary[1].persian === "Ù…ØªØ´Ú©Ø±Ù…";
                }
            }
        ];

        // ==================== Ø´Ø¨ÛŒÙ‡â€ŒØ³Ø§Ø² ====================
        const stateService = new StatePersistenceService();
        let currentStates = [];

        async function simulateUserLogin() {
            const userState = {
                user: {
                    id: "sim_user_" + Date.now(),
                    username: "Ú©Ø§Ø±Ø¨Ø± Ø´Ø¨ÛŒÙ‡â€ŒØ³Ø§Ø²",
                    level: Math.floor(Math.random() * 10) + 1,
                    xp: Math.floor(Math.random() * 1000),
                    loginCount: Math.floor(Math.random() * 50) + 1
                },
                session: {
                    loginTime: new Date().toISOString(),
                    device: navigator.userAgent.substr(0, 50)
                }
            };
            
            const stateId = stateService.generateStateId('user_session');
            await stateService.saveState(stateId, userState, { 
                type: 'user_session',
                autoGenerated: true
            });
            
            updateStateViewer();
            showMessage(`ğŸ‘¤ State Ú©Ø§Ø±Ø¨Ø± Ø°Ø®ÛŒØ±Ù‡ Ø´Ø¯ (${stateId})`);
        }

        async function simulateLessonProgress() {
            const lessonState = {
                lesson: {
                    id: "lesson_" + Math.floor(Math.random() * 1000),
                    title: ["Ù…Ú©Ø§Ù„Ù…Ù‡ Ù¾Ø§ÛŒÙ‡", "Ú¯Ø±Ø§Ù…Ø± Ù¾ÛŒØ´Ø±ÙØªÙ‡", "ÙˆØ§Ú˜Ú¯Ø§Ù† ØªØ¬Ø§Ø±ÛŒ"][Math.floor(Math.random() * 3)],
                    progress: Math.floor(Math.random() * 100),
                    score: Math.floor(Math.random() * 100),
                    timeSpent: Math.floor(Math.random() * 3600)
                },
                completedExercises: Array.from({ length: Math.floor(Math.random() * 10) + 1 }, (_, i) => ({
                    id: `ex_${i}`,
                    type: ['choice', 'typing', 'listening'][Math.floor(Math.random() * 3)],
                    score: Math.floor(Math.random() * 100),
                    time: Math.floor(Math.random() * 300)
                }))
            };
            
            const stateId = stateService.generateStateId('lesson_progress');
            await stateService.saveState(stateId, lessonState, { 
                type: 'lesson_progress',
                autoGenerated: true
            });
            
            updateStateViewer();
            showMessage(`ğŸ“š State Ø¯Ø±Ø³ Ø°Ø®ÛŒØ±Ù‡ Ø´Ø¯ (${stateId})`);
        }

        async function simulateSettingsChange() {
            const settingsState = {
                preferences: {
                    theme: ['dark', 'light', 'auto'][Math.floor(Math.random() * 3)],
                    language: ['fa', 'en'][Math.floor(Math.random() * 2)],
                    fontSize: Math.floor(Math.random() * 5) + 12,
                    sound: Math.random() > 0.5,
                    notifications: Math.random() > 0.5
                },
                lastUpdated: new Date().toISOString()
            };
            
            const stateId = "user_settings";
            await stateService.saveState(stateId, settingsState, { 
                type: 'settings',
                autoGenerated: true
            });
            
            updateStateViewer();
            showMessage(`âš™ï¸ State ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ø¨Ù‡â€ŒØ±ÙˆØ² Ø´Ø¯`);
        }

        async function simulateLargeState() {
            const largeState = {
                timestamp: Date.now(),
                data: Array.from({ length: 50 }, (_, i) => ({
                    id: `item_${i}`,
                    value: `Ù…Ù‚Ø¯Ø§Ø± ${i}`,
                    metadata: {
                        created: Date.now() - i * 1000,
                        tags: ['tag1', 'tag2', 'tag3'].slice(0, Math.floor(Math.random() * 3) + 1),
                        active: Math.random() > 0.5
                    }
                })),
                summary: {
                    totalItems: 50,
                    activeItems: 25,
                    lastUpdate: new Date().toISOString()
                }
            };
            
            const stateId = stateService.generateStateId('large_data');
            await stateService.saveState(stateId, largeState, { 
                type: 'bulk_data',
                autoGenerated: true
            });
            
            updateStateViewer();
            showMessage(`ğŸ“Š State Ø¨Ø²Ø±Ú¯ (50 Ø¢ÛŒØªÙ…) Ø°Ø®ÛŒØ±Ù‡ Ø´Ø¯`);
        }

        async function clearAllStates() {
            await stateService.clearAllStates();
            updateStateViewer();
            showMessage('ğŸ—‘ï¸ ØªÙ…Ø§Ù… StateÙ‡Ø§ Ø­Ø°Ù Ø´Ø¯Ù†Ø¯');
        }

        async function updateStateViewer() {
            const states = await stateService.getAllStates();
            currentStates = states;
            
            const container = document.getElementById('current-state');
            if (states.length === 0) {
                container.innerHTML = '<div style="color: #888; text-align: center;">Ù‡ÛŒÚ† StateØ§ÛŒ Ø°Ø®ÛŒØ±Ù‡ Ù†Ø´Ø¯Ù‡ Ø§Ø³Øª</div>';
                return;
            }
            
            let html = '';
            states.slice(-5).reverse().forEach(state => {
                const time = new Date(state.timestamp).toLocaleTimeString();
                const size = JSON.stringify(state.data).length;
                
                html += `
                    <div class="state-item">
                        <div class="state-key">${state.id}</div>
                        <div class="state-value">
                            ${state.stateType} â€¢ ${time} â€¢ ${size} Ø¨Ø§ÛŒØª
                        </div>
                    </div>
                `;
            });
            
            if (states.length > 5) {
                html += `<div style="color: #888; text-align: center; padding: 10px;">
                    + ${states.length - 5} State Ø¯ÛŒÚ¯Ø±
                </div>`;
            }
            
            container.innerHTML = html;
        }

        function showMessage(text) {
            console.log('ğŸ’¬ ' + text);
            const summary = document.getElementById('summary-text');
            const originalText = summary.textContent;
            summary.innerHTML = `<span style="color: #4fc3f7;">${text}</span><br>${originalText}`;
            
            setTimeout(() => {
                summary.innerHTML = originalText;
            }, 3000);
        }

        // ==================== Ø§Ø¬Ø±Ø§ÛŒ ØªØ³Øªâ€ŒÙ‡Ø§ ====================
        let passedTests = 0;
        let failedTests = 0;

        async function runAllTests() {
            passedTests = 0;
            failedTests = 0;
            const resultsDiv = document.getElementById('test-results');
            resultsDiv.innerHTML = '';
            
            // Ø­Ø°Ù StateÙ‡Ø§ÛŒ ØªØ³Øª Ù‚Ø¨Ù„ÛŒ
            await stateService.clearAllStates();
            
            for (const test of persistenceTests) {
                try {
                    const result = await test.run(stateService);
                    const testDiv = document.createElement('div');
                    testDiv.className = 'test-section';
                    
                    const testResult = result ? 'pass' : 'fail';
                    const resultText = result ? 'âœ… Ù…ÙˆÙÙ‚' : 'âŒ Ù†Ø§Ù…ÙˆÙÙ‚';
                    
                    if (result) passedTests++;
                    else failedTests++;
                    
                    testDiv.innerHTML = `
                        <div class="test-header">
                            <div class="test-title">${test.id}. ${test.title}</div>
                            <div class="test-result ${testResult}">${resultText}</div>
                        </div>
                    `;
                    
                    resultsDiv.appendChild(testDiv);
                } catch (error) {
                    failedTests++;
                    const testDiv = document.createElement('div');
                    testDiv.className = 'test-section';
                    testDiv.innerHTML = `
                        <div class="test-header">
                            <div class="test-title">${test.id}. ${test.title}</div>
                            <div class="test-result fail">âŒ Ø®Ø·Ø§</div>
                        </div>
                        <div class="details">${error.message}</div>
                    `;
                    resultsDiv.appendChild(testDiv);
                }
                
                updateSummary();
            }
            
            // Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ù†Ù…Ø§ÛŒØ´ StateÙ‡Ø§
            updateStateViewer();
        }

        function clearTests() {
            document.getElementById('test-results').innerHTML = '';
            passedTests = failedTests = 0;
            updateSummary();
        }

        function updateSummary() {
            const summary = document.getElementById('summary-text');
            const total = persistenceTests.length;
            const percentage = total > 0 ? Math.round((passedTests / total) * 100) : 0;
            
            let statusIcon = 'âœ…';
            if (percentage < 70) statusIcon = 'âš ï¸';
            if (percentage < 50) statusIcon = 'ğŸš¨';
            
            summary.innerHTML = `
                <strong>Ù†ØªÛŒØ¬Ù‡ ØªØ³Øªâ€ŒÙ‡Ø§ÛŒ Ø°Ø®ÛŒØ±Ù‡â€ŒØ³Ø§Ø²ÛŒ State:</strong><br>
                ${statusIcon} ${passedTests} Ù…ÙˆÙÙ‚ | âŒ ${failedTests} Ù†Ø§Ù…ÙˆÙÙ‚ | ğŸ“Š ${percentage}% Ù‚Ø¨ÙˆÙ„ÛŒ
            `;
            
            summary.style.color = percentage >= 90 ? '#4caf50' : 
                                 percentage >= 70 ? '#ff9800' : '#f44336';
        }

        // Ø§Ø¬Ø±Ø§ÛŒ Ø®ÙˆØ¯Ú©Ø§Ø± Ùˆ Ø§ÙˆÙ„ÛŒÙ‡
        window.onload = async () => {
            try {
                await stateService.initDatabase();
                updateSummary();
                updateStateViewer();
                setTimeout(runAllTests, 1000);
            } catch (error) {
                console.error('Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø§ÙˆÙ„ÛŒÙ‡:', error);
                document.getElementById('summary-text').textContent = 
                    'Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø¯ÛŒØªØ§Ø¨ÛŒØ³: ' + error.message;
            }
        };
    </script>
</body>
</html>
