<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ØªØ³Øª Ø¯Ø³ØªÛŒ Ø¬Ø±ÛŒØ§Ù† ÙˆØ±ÙˆØ¯/Ø®Ø±ÙˆØ¬ - Farsinglish</title>
    <style>
        * { box-sizing: border-box; font-family: Vazir, Tahoma, sans-serif; }
        body { background: #f0f2f5; margin: 0; padding: 15px; }
        .container { max-width: 600px; margin: 0 auto; }
        .header { background: #2c3e50; color: white; padding: 20px; border-radius: 15px; text-align: center; margin-bottom: 20px; }
        .card { background: white; border-radius: 15px; padding: 20px; margin-bottom: 20px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
        .form-group { margin-bottom: 15px; }
        label { display: block; margin-bottom: 5px; font-weight: bold; }
        input, select { width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 1rem; }
        .btn-group { display: flex; gap: 10px; flex-wrap: wrap; margin: 15px 0; }
        button { flex: 1; min-width: 120px; padding: 12px; border: none; border-radius: 8px; font-size: 1rem; cursor: pointer; font-weight: bold; }
        .btn-primary { background: #3498db; color: white; }
        .btn-success { background: #27ae60; color: white; }
        .btn-danger { background: #e74c3c; color: white; }
        .btn-warning { background: #f39c12; color: white; }
        .btn-secondary { background: #95a5a6; color: white; }
        .log-panel { background: #1e272e; color: #00ff00; padding: 15px; border-radius: 10px; font-family: monospace; height: 200px; overflow-y: auto; font-size: 0.9rem; direction: ltr; text-align: left; margin-top: 15px; }
        .status-badge { display: inline-block; padding: 5px 10px; border-radius: 20px; font-size: 0.9rem; margin: 5px 0; }
        .status-online { background: #27ae60; color: white; }
        .status-offline { background: #7f8c8d; color: white; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h2>ğŸ§ª ØªØ³Øª Ø¯Ø³ØªÛŒ Ø¬Ø±ÛŒØ§Ù† ÙˆØ±ÙˆØ¯/Ø®Ø±ÙˆØ¬</h2>
        </div>

        <!-- Ú©Ø§Ø±Øª ÙˆØ¶Ø¹ÛŒØª -->
        <div class="card">
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <h3>ğŸ“Š ÙˆØ¶Ø¹ÛŒØª ÙØ¹Ù„ÛŒ</h3>
                <span class="status-badge status-offline" id="authStatusDisplay">ÙˆØ¶Ø¹ÛŒØª: Ø¢ÙÙ„Ø§ÛŒÙ†</span>
            </div>
            <div id="userInfo" style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-top: 10px;">
                <p>ğŸ‘¤ Ú©Ø§Ø±Ø¨Ø±: <span id="displayUsername">ÙˆØ§Ø±Ø¯ Ù†Ø´Ø¯Ù‡</span></p>
                <p>ğŸ”‘ ØªÙˆÚ©Ù†: <span id="displayToken">-</span></p>
            </div>
        </div>

        <!-- Ú©Ø§Ø±Øª Ø«Ø¨Øªâ€ŒÙ†Ø§Ù… -->
        <div class="card" id="registerCard">
            <h3>ğŸ“ Ø«Ø¨Øªâ€ŒÙ†Ø§Ù…</h3>
            <div class="form-group">
                <label>Ù†Ø§Ù… Ú©Ø§Ø±Ø¨Ø±ÛŒ:</label>
                <input type="text" id="regUsername" value="testuser">
            </div>
            <div class="form-group">
                <label>Ø§ÛŒÙ…ÛŒÙ„:</label>
                <input type="email" id="regEmail" value="test@example.com">
            </div>
            <div class="form-group">
                <label>Ø±Ù…Ø² Ø¹Ø¨ÙˆØ±:</label>
                <input type="password" id="regPassword" value="123456">
            </div>
            <button class="btn-primary" onclick="window.handleRegister()">ğŸ“ Ø«Ø¨Øªâ€ŒÙ†Ø§Ù…</button>
        </div>

        <!-- Ú©Ø§Ø±Øª ÙˆØ±ÙˆØ¯ -->
        <div class="card" id="loginCard">
            <h3>ğŸ” ÙˆØ±ÙˆØ¯</h3>
            <div class="form-group">
                <label>Ù†Ø§Ù… Ú©Ø§Ø±Ø¨Ø±ÛŒ ÛŒØ§ Ø§ÛŒÙ…ÛŒÙ„:</label>
                <input type="text" id="loginUsername" value="testuser">
            </div>
            <div class="form-group">
                <label>Ø±Ù…Ø² Ø¹Ø¨ÙˆØ±:</label>
                <input type="password" id="loginPassword" value="123456">
            </div>
            <button class="btn-success" onclick="window.handleLogin()">ğŸ”“ ÙˆØ±ÙˆØ¯</button>
            <button class="btn-secondary" onclick="window.clearSession()" style="margin-top:10px;">ğŸ§¹ Ù¾Ø§Ú© Ú©Ø±Ø¯Ù† Ù†Ø´Ø³Øª</button>
        </div>

        <!-- Ú©Ø§Ø±Øª Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯ -->
        <div class="card" id="dashboardCard" style="display: none;">
            <h3>ğŸ“‹ Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯</h3>
            <button class="btn-danger" onclick="window.handleLogout()">ğŸšª Ø®Ø±ÙˆØ¬</button>
            <button class="btn-warning" onclick="window.checkSession()">ğŸ”„ Ø¨Ø±Ø±Ø³ÛŒ Ù†Ø´Ø³Øª</button>
            <button class="btn-secondary" onclick="window.refreshToken()">ğŸ”„ ØªÙ…Ø¯ÛŒØ¯ ØªÙˆÚ©Ù†</button>
            <button class="btn-warning" onclick="window.simulateExpiredToken()" style="margin-top:10px;">â° Ø§Ù†Ù‚Ø¶Ø§ÛŒ ØªÙˆÚ©Ù†</button>
        </div>

        <!-- Ø¯Ú©Ù…Ù‡ Ù¾Ø§Ú© Ú©Ø±Ø¯Ù† Ù‡Ù…Ù‡ Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ -->
        <button class="btn-secondary" onclick="window.clearAllData()" style="width:100%; margin-bottom:15px;">ğŸ—‘ï¸ Ù¾Ø§Ú© Ú©Ø±Ø¯Ù† Ù‡Ù…Ù‡ Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§</button>

        <!-- Ù¾Ù†Ù„ Ù„Ø§Ú¯ -->
        <div class="card">
            <h3>ğŸ“‹ Ú¯Ø²Ø§Ø±Ø´ ØªØ³Øª</h3>
            <div class="log-panel" id="logPanel">â±ï¸ Ù…Ù†ØªØ¸Ø± Ø¹Ù…Ù„ÛŒØ§Øª...</div>
            <button class="btn-secondary" onclick="window.clearLogs()" style="margin-top:10px;">ğŸ—‘ï¸ Ù¾Ø§Ú© Ú©Ø±Ø¯Ù† Ù„Ø§Ú¯</button>
        </div>
    </div>

    <script>
        // Ù‚Ø±Ø§Ø± Ø¯Ø§Ø¯Ù† ØªÙˆØ§Ø¨Ø¹ Ø¯Ø± scope Ø¬Ù‡Ø§Ù†ÛŒ
        window.handleRegister = handleRegister;
        window.handleLogin = handleLogin;
        window.handleLogout = handleLogout;
        window.clearSession = clearSession;
        window.checkSession = checkSession;
        window.refreshToken = refreshToken;
        window.simulateExpiredToken = simulateExpiredToken;
        window.clearAllData = clearAllData;
        window.clearLogs = clearLogs;

        // ---------- Ú©Ù„Ø§Ø³ Auth ----------
        class AuthService {
            constructor() {
                this.STORAGE_KEY = 'farsinglish_auth';
                this.USERS_KEY = 'farsinglish_users';
                this.currentUser = null;
                this.token = null;
                this.tokenExpiry = null;
                this.loadSession();
            }

            async hashPassword(password) {
                const msgBuffer = new TextEncoder().encode(password);
                const hashBuffer = await crypto.subtle.digest('SHA-256', msgBuffer);
                const hashArray = Array.from(new Uint8Array(hashBuffer));
                return hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
            }

            async register(username, email, password) {
                if (!username || username.length < 3) throw new Error('Ù†Ø§Ù… Ú©Ø§Ø±Ø¨Ø±ÛŒ Ø­Ø¯Ø§Ù‚Ù„ Û³ Ú©Ø§Ø±Ø§Ú©ØªØ±');
                if (!email || !email.includes('@')) throw new Error('Ø§ÛŒÙ…ÛŒÙ„ Ù†Ø§Ù…Ø¹ØªØ¨Ø±');
                if (!password || password.length < 6) throw new Error('Ø±Ù…Ø² Ø­Ø¯Ø§Ù‚Ù„ Û¶ Ú©Ø§Ø±Ø§Ú©ØªØ±');

                const users = this.getUsers();
                if (users[username]) throw new Error('Ú©Ø§Ø±Ø¨Ø± ÙˆØ¬ÙˆØ¯ Ø¯Ø§Ø±Ø¯');

                const hashedPassword = await this.hashPassword(password);
                users[username] = { username, email, password: hashedPassword, createdAt: new Date().toISOString() };
                localStorage.setItem(this.USERS_KEY, JSON.stringify(users));
                return true;
            }

            async login(identifier, password) {
                const users = this.getUsers();
                let foundUser = null;

                for (let username in users) {
                    if (username === identifier || users[username].email === identifier) {
                        foundUser = users[username];
                        break;
                    }
                }

                if (!foundUser) throw new Error('Ú©Ø§Ø±Ø¨Ø± ÛŒØ§ÙØª Ù†Ø´Ø¯');

                const hashedPassword = await this.hashPassword(password);
                if (hashedPassword !== foundUser.password) throw new Error('Ø±Ù…Ø² Ø§Ø´ØªØ¨Ø§Ù‡');

                this.currentUser = foundUser;
                this.tokenExpiry = Date.now() + (60 * 60 * 1000);
                this.token = this.generateToken(foundUser.username);
                this.saveSession();
                return true;
            }

            generateToken(username) {
                return btoa(JSON.stringify({ username, exp: this.tokenExpiry }));
            }

            logout() {
                this.currentUser = null;
                this.token = null;
                this.tokenExpiry = null;
                localStorage.removeItem(this.STORAGE_KEY);
            }

            checkSession() {
                if (!this.token || !this.tokenExpiry) return false;
                if (Date.now() > this.tokenExpiry) {
                    this.logout();
                    return false;
                }
                return true;
            }

            refreshToken() {
                if (!this.checkSession()) throw new Error('Ù†Ø´Ø³Øª Ù†Ø§Ù…Ø¹ØªØ¨Ø±');
                this.tokenExpiry = Date.now() + (60 * 60 * 1000);
                this.token = this.generateToken(this.currentUser.username);
                this.saveSession();
                return this.token;
            }

            saveSession() {
                if (!this.currentUser || !this.token) return;
                localStorage.setItem(this.STORAGE_KEY, JSON.stringify({
                    user: this.currentUser,
                    token: this.token,
                    expiry: this.tokenExpiry
                }));
            }

            loadSession() {
                const saved = localStorage.getItem(this.STORAGE_KEY);
                if (saved) {
                    try {
                        const session = JSON.parse(saved);
                        this.currentUser = session.user;
                        this.token = session.token;
                        this.tokenExpiry = session.expiry;
                        if (Date.now() > this.tokenExpiry) this.logout();
                    } catch (e) { this.logout(); }
                }
            }

            getUsers() {
                const users = localStorage.getItem(this.USERS_KEY);
                return users ? JSON.parse(users) : {};
            }

            clearAll() {
                this.logout();
                localStorage.removeItem(this.USERS_KEY);
                localStorage.removeItem(this.STORAGE_KEY);
            }
        }

        // Ù†Ù…ÙˆÙ†Ù‡ Ø§ØµÙ„ÛŒ
        const auth = new AuthService();

        // ØªÙˆØ§Ø¨Ø¹ Ù„Ø§Ú¯
        function addLog(message, type = 'info') {
            const logPanel = document.getElementById('logPanel');
            const time = new Date().toLocaleTimeString('fa-IR');
            const emoji = type === 'success' ? 'âœ…' : type === 'error' ? 'âŒ' : 'â„¹ï¸';
            logPanel.innerHTML += `<div>[${time}] ${emoji} ${message}</div>`;
            logPanel.scrollTop = logPanel.scrollHeight;
        }

        function clearLogs() {
            document.getElementById('logPanel').innerHTML = 'â±ï¸ Ù„Ø§Ú¯ Ù¾Ø§Ú© Ø´Ø¯...';
        }

        // Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ UI
        function updateUI() {
            const isLoggedIn = auth.checkSession();
            const statusEl = document.getElementById('authStatusDisplay');
            
            if (isLoggedIn && auth.currentUser) {
                statusEl.className = 'status-badge status-online';
                statusEl.textContent = 'ÙˆØ¶Ø¹ÛŒØª: Ø¢Ù†Ù„Ø§ÛŒÙ†';
                document.getElementById('displayUsername').textContent = auth.currentUser.username;
                document.getElementById('displayToken').textContent = auth.token ? auth.token.substring(0, 15) + '...' : '-';
                
                document.getElementById('registerCard').style.display = 'none';
                document.getElementById('loginCard').style.display = 'none';
                document.getElementById('dashboardCard').style.display = 'block';
            } else {
                statusEl.className = 'status-badge status-offline';
                statusEl.textContent = 'ÙˆØ¶Ø¹ÛŒØª: Ø¢ÙÙ„Ø§ÛŒÙ†';
                document.getElementById('displayUsername').textContent = 'ÙˆØ§Ø±Ø¯ Ù†Ø´Ø¯Ù‡';
                document.getElementById('displayToken').textContent = '-';
                
                document.getElementById('registerCard').style.display = 'block';
                document.getElementById('loginCard').style.display = 'block';
                document.getElementById('dashboardCard').style.display = 'none';
            }
        }

        // ØªÙˆØ§Ø¨Ø¹ Ù‡Ù†Ø¯Ù„Ø±
        async function handleRegister() {
            const username = document.getElementById('regUsername').value.trim();
            const email = document.getElementById('regEmail').value.trim();
            const password = document.getElementById('regPassword').value;

            try {
                addLog(`ØªÙ„Ø§Ø´ Ø«Ø¨Øªâ€ŒÙ†Ø§Ù…: ${username}`);
                await auth.register(username, email, password);
                addLog('âœ… Ø«Ø¨Øªâ€ŒÙ†Ø§Ù… Ù…ÙˆÙÙ‚', 'success');
                alert('âœ… Ø«Ø¨Øªâ€ŒÙ†Ø§Ù… Ù…ÙˆÙÙ‚');
            } catch (error) {
                addLog(`âŒ ${error.message}`, 'error');
                alert(`âŒ ${error.message}`);
            }
        }

        async function handleLogin() {
            const identifier = document.getElementById('loginUsername').value.trim();
            const password = document.getElementById('loginPassword').value;

            try {
                addLog(`ØªÙ„Ø§Ø´ ÙˆØ±ÙˆØ¯: ${identifier}`);
                await auth.login(identifier, password);
                addLog('âœ… ÙˆØ±ÙˆØ¯ Ù…ÙˆÙÙ‚', 'success');
                updateUI();
            } catch (error) {
                addLog(`âŒ ${error.message}`, 'error');
                alert(`âŒ ${error.message}`);
            }
        }

        function handleLogout() {
            auth.logout();
            addLog('ğŸšª Ø®Ø±ÙˆØ¬ Ø§Ù†Ø¬Ø§Ù… Ø´Ø¯');
            updateUI();
        }

        function clearSession() {
            auth.logout();
            addLog('ğŸ§¹ Ù†Ø´Ø³Øª Ù¾Ø§Ú© Ø´Ø¯');
            updateUI();
        }

        function checkSession() {
            const isValid = auth.checkSession();
            addLog(isValid ? 'âœ… Ù†Ø´Ø³Øª Ù…Ø¹ØªØ¨Ø±' : 'âŒ Ù†Ø´Ø³Øª Ù†Ø§Ù…Ø¹ØªØ¨Ø±', isValid ? 'success' : 'error');
            alert(isValid ? 'âœ… Ù†Ø´Ø³Øª Ù…Ø¹ØªØ¨Ø±' : 'âŒ Ù†Ø´Ø³Øª Ù†Ø§Ù…Ø¹ØªØ¨Ø±');
            updateUI();
        }

        function refreshToken() {
            try {
                auth.refreshToken();
                addLog('ğŸ”„ ØªÙˆÚ©Ù† ØªÙ…Ø¯ÛŒØ¯ Ø´Ø¯', 'success');
                updateUI();
            } catch (error) {
                addLog(`âŒ ${error.message}`, 'error');
                alert(`âŒ ${error.message}`);
            }
        }

        function simulateExpiredToken() {
            if (auth.tokenExpiry) {
                auth.tokenExpiry = Date.now() - 1000;
                auth.saveSession();
                addLog('â° Ø§Ù†Ù‚Ø¶Ø§ Ø´Ø¨ÛŒÙ‡â€ŒØ³Ø§Ø²ÛŒ Ø´Ø¯');
                checkSession();
            } else {
                addLog('âš ï¸ Ú©Ø§Ø±Ø¨Ø± ÙˆØ§Ø±Ø¯ Ù†Ø´Ø¯Ù‡');
            }
        }

        function clearAllData() {
            auth.clearAll();
            addLog('ğŸ—‘ï¸ Ù‡Ù…Ù‡ Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ Ù¾Ø§Ú© Ø´Ø¯');
            updateUI();
        }

        // Ø´Ø±ÙˆØ¹
        window.onload = function() {
            updateUI();
            addLog('ğŸš€ ØªØ³Øª Ø¢Ù…Ø§Ø¯Ù‡ Ø§Ø³Øª');
        };
    </script>
</body>
</html>
