<!DOCTYPE html>
<html lang="fa">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Farsinglish - ØªØ³Øª Ù…Ø³ÛŒØ±ÛŒØ§Ø¨ÛŒ (Ù†Ø³Ø®Ù‡ Ù¾Ø§ÛŒØ¯Ø§Ø±)</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif;
            background: linear-gradient(135deg, #0d47a1 0%, #1976d2 100%);
            color: #e3f2fd;
            min-height: 100vh;
            padding: 15px;
        }
        .container { 
            max-width: 800px; 
            margin: 0 auto;
            background: rgba(25, 35, 65, 0.95);
            border-radius: 12px;
            padding: 18px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.6);
        }
        h1 { 
            text-align: center; 
            margin-bottom: 20px;
            font-size: 1.6rem;
            color: #82b1ff;
        }
        .test-section { 
            margin: 15px 0;
            padding: 14px;
            background: rgba(40, 45, 80, 0.9);
            border-radius: 8px;
            border-left: 4px solid #4fc3f7;
        }
        .test-header { 
            display: flex; 
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        .test-title { 
            font-size: 0.95rem; 
            font-weight: 600;
            color: #bb86fc;
        }
        .test-result { 
            padding: 4px 10px;
            border-radius: 10px;
            font-size: 0.8rem;
            font-weight: bold;
        }
        .pass { background: #4caf50; }
        .fail { background: #f44336; }
        .details { 
            margin-top: 8px;
            padding: 10px;
            background: rgba(0, 0, 30, 0.7);
            border-radius: 6px;
            font-family: monospace;
            font-size: 0.8rem;
            color: #a5d6a7;
        }
        .summary {
            margin-top: 20px;
            padding: 15px;
            background: rgba(40, 45, 80, 0.9);
            border-radius: 8px;
            text-align: center;
            font-size: 0.95rem;
        }
        button {
            background: #2962ff;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            font-size: 0.85rem;
            cursor: pointer;
            margin: 4px;
        }
        .controls { text-align: center; margin-top: 15px; }
        .simulation {
            margin: 20px 0;
            padding: 15px;
            background: rgba(50, 55, 90, 0.9);
            border-radius: 10px;
            border: 1px solid rgba(100, 150, 255, 0.4);
        }
        .sim-btn {
            background: rgba(66, 165, 245, 0.2);
            border: 1px solid #42a5f5;
            color: #90caf9;
            padding: 6px 12px;
            border-radius: 6px;
            margin: 4px;
            cursor: pointer;
            font-size: 0.8rem;
        }
        .route-display {
            font-family: monospace;
            background: rgba(0,0,0,0.3);
            padding: 8px;
            border-radius: 6px;
            margin: 8px 0;
            color: #ffd54f;
        }
        .status-login { color: #4caf50; }
        .status-logout { color: #f44336; }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ§­ ØªØ³Øª Ù…Ø³ÛŒØ±ÛŒØ§Ø¨ÛŒ - Ù†Ø³Ø®Ù‡ Ù¾Ø§ÛŒØ¯Ø§Ø±</h1>
        
        <div class="simulation">
            <h3>ğŸ® Ø´Ø¨ÛŒÙ‡â€ŒØ³Ø§Ø² ØªØ¹Ø§Ù…Ù„ÛŒ</h3>
            <div id="sim-controls">
                <p>Ø¨Ø±Ø§ÛŒ ÙØ¹Ø§Ù„â€ŒØ³Ø§Ø²ÛŒ Ø¯Ú©Ù…Ù‡ Ø²ÛŒØ± Ø±Ø§ Ø¨Ø²Ù†ÛŒØ¯:</p>
                <button onclick="initSimulation()">ğŸš€ Ø±Ø§Ù‡â€ŒØ§Ù†Ø¯Ø§Ø²ÛŒ Ø´Ø¨ÛŒÙ‡â€ŒØ³Ø§Ø²</button>
            </div>
            <div class="route-display">
                Ù…Ø³ÛŒØ± ÙØ¹Ù„ÛŒ: <span id="current-route">/</span>
            </div>
            <div class="route-display">
                ÙˆØ¶Ø¹ÛŒØª Ú©Ø§Ø±Ø¨Ø±: <span id="user-status" class="status-logout">âŒ Ù„Ø§Ú¯ÛŒÙ† Ù†Ø´Ø¯Ù‡</span>
            </div>
            <div class="route-display">
                ØªØ§Ø±ÛŒØ®Ú†Ù‡: <span id="history-display">[]</span>
            </div>
        </div>
        
        <div id="test-results"></div>
        
        <div class="summary">
            <p id="summary-text">Ø¢Ù…Ø§Ø¯Ù‡ Ø§Ø¬Ø±Ø§ÛŒ Û±Û° ØªØ³Øª Ù…Ø³ÛŒØ±ÛŒØ§Ø¨ÛŒ...</p>
        </div>
        
        <div class="controls">
            <button onclick="runAllTests()">â–¶ï¸ Ø§Ø¬Ø±Ø§ÛŒ ØªØ³Øªâ€ŒÙ‡Ø§</button>
            <button onclick="clearTests()">ğŸ—‘ï¸ Ù¾Ø§Ú© Ú©Ø±Ø¯Ù† Ù†ØªØ§ÛŒØ¬</button>
        </div>
    </div>

    <script>
        // ==================== Router Ù¾Ø§ÛŒØ¯Ø§Ø± ====================
        class StableRouter {
            constructor() {
                this.routes = {
                    '/': { name: 'Ø®Ø§Ù†Ù‡', auth: false, roles: ['guest', 'user', 'admin'] },
                    '/login': { name: 'ÙˆØ±ÙˆØ¯', auth: false, roles: ['guest'] },
                    '/dashboard': { name: 'Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯', auth: true, roles: ['user', 'admin'] },
                    '/lessons': { name: 'Ø¯Ø±ÙˆØ³', auth: true, roles: ['user', 'admin'] },
                    '/profile': { name: 'Ù¾Ø±ÙˆÙØ§ÛŒÙ„', auth: true, roles: ['user', 'admin'] },
                    '/admin': { name: 'Ù…Ø¯ÛŒØ±ÛŒØª', auth: true, roles: ['admin'] },
                    '/404': { name: 'ÛŒØ§ÙØª Ù†Ø´Ø¯', auth: false, roles: ['guest', 'user', 'admin'] }
                };
                this.currentRoute = '/';
                this.history = [];
                this.isAuthenticated = false;
                this.userRole = 'guest';
                this.listeners = [];
            }
            
            navigate(path) {
                console.log(`ğŸ§­ navigate(${path})`);
                
                // Ø°Ø®ÛŒØ±Ù‡ Ù…Ø³ÛŒØ± Ù‚Ø¨Ù„ÛŒ Ø¨Ø±Ø§ÛŒ ØªØ§Ø±ÛŒØ®Ú†Ù‡
                const previousRoute = this.currentRoute;
                
                // Ø¨Ø±Ø±Ø³ÛŒ ÙˆØ¬ÙˆØ¯ Ù…Ø³ÛŒØ±
                if (!this.routes[path]) {
                    console.log(`âŒ Ù…Ø³ÛŒØ± ${path} ÙˆØ¬ÙˆØ¯ Ù†Ø¯Ø§Ø±Ø¯ -> 404`);
                    this.currentRoute = '/404';
                    this._notify(previousRoute, '/404', false);
                    return false;
                }
                
                const route = this.routes[path];
                
                // Guard: Ø§Ú¯Ø± Ù„Ø§Ú¯ÛŒÙ† Ú©Ø±Ø¯Ù‡ Ø¨Ø§Ø´Ø¯ØŒ Ù†Ù…ÛŒâ€ŒØªÙˆØ§Ù†Ø¯ Ø¨Ù‡ Ù„Ø§Ú¯ÛŒÙ† Ø¨Ø±ÙˆØ¯
                if (path === '/login' && this.isAuthenticated) {
                    console.log('ğŸ”’ Ú©Ø§Ø±Ø¨Ø± Ù‚Ø¨Ù„Ø§Ù‹ Ù„Ø§Ú¯ÛŒÙ† Ú©Ø±Ø¯Ù‡ -> dashboard');
                    this.currentRoute = '/dashboard';
                    this._notify(previousRoute, '/dashboard', false);
                    return false;
                }
                
                // Guard: Ù†ÛŒØ§Ø² Ø¨Ù‡ Ø§Ø­Ø±Ø§Ø² Ù‡ÙˆÛŒØª
                if (route.auth && !this.isAuthenticated) {
                    console.log('ğŸ” Ù†ÛŒØ§Ø² Ø¨Ù‡ Ù„Ø§Ú¯ÛŒÙ† -> login');
                    this.currentRoute = '/login';
                    this._notify(previousRoute, '/login', false);
                    return false;
                }
                
                // Guard: Ø¨Ø±Ø±Ø³ÛŒ Ù†Ù‚Ø´ Ú©Ø§Ø±Ø¨Ø±
                if (!route.roles.includes(this.userRole)) {
                    console.log(`â›” Ù†Ù‚Ø´ ${this.userRole} Ù…Ø¬Ø§Ø² Ù†ÛŒØ³Øª -> home`);
                    this.currentRoute = '/';
                    this._notify(previousRoute, '/', false);
                    return false;
                }
                
                // Ù…Ø³ÛŒØ±ÛŒØ§Ø¨ÛŒ Ù…ÙˆÙÙ‚ - Ø§Ø¶Ø§ÙÙ‡ Ø¨Ù‡ ØªØ§Ø±ÛŒØ®Ú†Ù‡ ÙÙ‚Ø· Ø§Ú¯Ø± Ù…Ø³ÛŒØ± ØªØºÛŒÛŒØ± Ú©Ø±Ø¯Ù‡
                if (previousRoute !== path) {
                    this.history.push(previousRoute);
                    if (this.history.length > 10) {
                        this.history.shift(); // Ù…Ø­Ø¯ÙˆØ¯ÛŒØª Ø§Ù†Ø¯Ø§Ø²Ù‡
                    }
                }
                
                this.currentRoute = path;
                this._notify(previousRoute, path, true);
                console.log(`âœ… navigate Ù…ÙˆÙÙ‚: ${previousRoute} -> ${path}`);
                return true;
            }
            
            _notify(from, to, success) {
                this.listeners.forEach(callback => {
                    try {
                        callback({
                            from,
                            to,
                            success,
                            userRole: this.userRole,
                            isAuthenticated: this.isAuthenticated,
                            timestamp: new Date().toLocaleTimeString(),
                            history: [...this.history]
                        });
                    } catch (error) {
                        console.error('Ø®Ø·Ø§ Ø¯Ø± listener:', error);
                    }
                });
            }
            
            setAuth(auth, role = 'user') {
                this.isAuthenticated = auth;
                this.userRole = role;
                console.log(`ğŸ‘¤ setAuth: ${auth ? 'Ù„Ø§Ú¯ÛŒÙ†' : 'Ù„Ø§Ú¯â€ŒØ§ÙˆØª'} (${role})`);
                
                // Ø§Ø·Ù„Ø§Ø¹ Ø¨Ù‡ listeners
                this._notify(this.currentRoute, this.currentRoute, true);
            }
            
            goBack() {
                if (this.history.length === 0) {
                    console.log('âš ï¸ ØªØ§Ø±ÛŒØ®Ú†Ù‡ Ø®Ø§Ù„ÛŒ Ø§Ø³Øª');
                    return false;
                }
                
                const previousRoute = this.history.pop();
                console.log(`â†©ï¸ Ø¨Ø§Ø²Ú¯Ø´Øª Ø¨Ù‡: ${previousRoute} (ØªØ§Ø±ÛŒØ®Ú†Ù‡ Ø¨Ø§Ù‚ÛŒâ€ŒÙ…Ø§Ù†Ø¯Ù‡: ${this.history.length})`);
                
                // Ù…Ø³ØªÙ‚ÛŒÙ…Ø§Ù‹ Ù…Ø³ÛŒØ± Ø±Ø§ ØªØºÛŒÛŒØ± Ø¯Ù‡ÛŒÙ… (Ø¨Ø¯ÙˆÙ† Ø¨Ø±Ø±Ø³ÛŒ guardÙ‡Ø§)
                const oldRoute = this.currentRoute;
                this.currentRoute = previousRoute;
                this._notify(oldRoute, previousRoute, true);
                
                return true;
            }
            
            onRouteChange(callback) {
                this.listeners.push(callback);
            }
            
            getHistory() {
                return [...this.history];
            }
        }

        // ==================== ØªØ³Øªâ€ŒÙ‡Ø§ÛŒ Ø§ØµÙ„Ø§Ø­â€ŒØ´Ø¯Ù‡ ====================
        const stableTests = [
            {
                id: 1,
                title: "Ù…Ø³ÛŒØ±ÛŒØ§Ø¨ÛŒ Ø³Ø§Ø¯Ù‡ Ø¨Ù‡ Ø®Ø§Ù†Ù‡",
                run: () => {
                    const router = new StableRouter();
                    const result = router.navigate('/');
                    return result && router.currentRoute === '/';
                }
            },
            {
                id: 2,
                title: "Ø¯Ø³ØªØ±Ø³ÛŒ Ø¨Ù‡ Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯ Ø¨Ø¯ÙˆÙ† Ù„Ø§Ú¯ÛŒÙ†",
                run: () => {
                    const router = new StableRouter();
                    router.setAuth(false, 'guest');
                    const result = router.navigate('/dashboard');
                    return !result && router.currentRoute === '/login';
                }
            },
            {
                id: 3,
                title: "Ø¯Ø³ØªØ±Ø³ÛŒ Ø¨Ù‡ Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯ Ø¨Ø§ Ù„Ø§Ú¯ÛŒÙ†",
                run: () => {
                    const router = new StableRouter();
                    router.setAuth(true, 'user');
                    return router.navigate('/dashboard') && router.currentRoute === '/dashboard';
                }
            },
            {
                id: 4,
                title: "Ú©Ø§Ø±Ø¨Ø± Ø¹Ø§Ø¯ÛŒ Ø¨Ù‡ Ø§Ø¯Ù…ÛŒÙ† Ø¯Ø³ØªØ±Ø³ÛŒ Ù†Ø¯Ø§Ø±Ø¯",
                run: () => {
                    const router = new StableRouter();
                    router.setAuth(true, 'user');
                    const result = router.navigate('/admin');
                    return !result && router.currentRoute === '/';
                }
            },
            {
                id: 5,
                title: "ØªØ§Ø±ÛŒØ®Ú†Ù‡ Ùˆ Ø¨Ø§Ø²Ú¯Ø´Øª - Ø§ØµÙ„Ø§Ø­ Ø´Ø¯Ù‡",
                run: () => {
                    const router = new StableRouter();
                    router.setAuth(true, 'user');
                    
                    // Ø±ÙØªÙ† Ø¨Ù‡ Ù…Ø³ÛŒØ±Ù‡Ø§ÛŒ Ù…Ø®ØªÙ„Ù
                    router.navigate('/dashboard');  // ØªØ§Ø±ÛŒØ®Ú†Ù‡: ['/']
                    router.navigate('/lessons');    // ØªØ§Ø±ÛŒØ®Ú†Ù‡: ['/', '/dashboard']
                    router.navigate('/profile');    // ØªØ§Ø±ÛŒØ®Ú†Ù‡: ['/', '/dashboard', '/lessons']
                    
                    // Ø¨Ø±Ø±Ø³ÛŒ ØªØ§Ø±ÛŒØ®Ú†Ù‡
                    const history = router.getHistory();
                    const historyValid = history.length === 3 && 
                                       history[0] === '/' && 
                                       history[1] === '/dashboard' && 
                                       history[2] === '/lessons';
                    
                    // Ø¨Ø§Ø²Ú¯Ø´Øª Ø§ÙˆÙ„
                    const back1 = router.goBack();
                    const route1 = router.currentRoute === '/lessons';
                    
                    // Ø¨Ø§Ø²Ú¯Ø´Øª Ø¯ÙˆÙ…
                    const back2 = router.goBack();
                    const route2 = router.currentRoute === '/dashboard';
                    
                    console.log('ØªØ§Ø±ÛŒØ®Ú†Ù‡:', history);
                    console.log('ØªØ§Ø±ÛŒØ®Ú†Ù‡ Ù…Ø¹ØªØ¨Ø±:', historyValid);
                    console.log('Ø¨Ø§Ø²Ú¯Ø´Øª Ø§ÙˆÙ„:', back1, 'Ù…Ø³ÛŒØ±:', router.currentRoute);
                    console.log('Ø¨Ø§Ø²Ú¯Ø´Øª Ø¯ÙˆÙ…:', back2, 'Ù…Ø³ÛŒØ±:', router.currentRoute);
                    
                    return historyValid && back1 && route1 && back2 && route2;
                }
            },
            {
                id: 6,
                title: "Ù…Ø³ÛŒØ± Ù†Ø§Ù…ÙˆØ¬ÙˆØ¯ (404)",
                run: () => {
                    const router = new StableRouter();
                    const result = router.navigate('/invalid-path-xyz');
                    return !result && router.currentRoute === '/404';
                }
            },
            {
                id: 7,
                title: "Ù„Ø§Ú¯ÛŒÙ† Ø´Ø¯Ù‡ Ù†Ù…ÛŒâ€ŒØªÙˆØ§Ù†Ø¯ Ø¨Ù‡ Ù„Ø§Ú¯ÛŒÙ† Ø¨Ø±ÙˆØ¯",
                run: () => {
                    const router = new StableRouter();
                    router.setAuth(true, 'user');
                    const result = router.navigate('/login');
                    return !result && router.currentRoute === '/dashboard';
                }
            },
            {
                id: 8,
                title: "Ø§Ø¯Ù…ÛŒÙ† Ø¨Ù‡ Ø§Ø¯Ù…ÛŒÙ† Ø¯Ø³ØªØ±Ø³ÛŒ Ø¯Ø§Ø±Ø¯",
                run: () => {
                    const router = new StableRouter();
                    router.setAuth(true, 'admin');
                    return router.navigate('/admin') && router.currentRoute === '/admin';
                }
            },
            {
                id: 9,
                title: "Event Listeners Ú©Ø§Ø± Ù…ÛŒâ€ŒÚ©Ù†Ù†Ø¯",
                run: () => {
                    return new Promise((resolve) => {
                        const router = new StableRouter();
                        let eventReceived = false;
                        
                        router.onRouteChange((event) => {
                            if (event.to === '/dashboard' && event.success) {
                                eventReceived = true;
                                resolve(true);
                            }
                        });
                        
                        router.setAuth(true, 'user');
                        router.navigate('/dashboard');
                        
                        setTimeout(() => resolve(eventReceived), 500);
                    });
                }
            },
            {
                id: 10,
                title: "Ø¹Ù…Ù„Ú©Ø±Ø¯ Ù¾Ø´Øª Ø³Ø± Ù‡Ù…",
                run: () => {
                    const router = new StableRouter();
                    router.setAuth(true, 'user');
                    
                    const r1 = router.navigate('/dashboard');
                    const r2 = router.navigate('/lessons');
                    const r3 = router.navigate('/profile');
                    
                    // Ù‡Ù…Ù‡ Ø¨Ø§ÛŒØ¯ Ù…ÙˆÙÙ‚ Ø¨Ø§Ø´Ù†Ø¯
                    const allSuccess = r1 && r2 && r3;
                    const finalRoute = router.currentRoute;
                    const historySize = router.getHistory().length;
                    
                    console.log('Ù†ØªØ§ÛŒØ¬:', {r1, r2, r3, finalRoute, historySize});
                    
                    return allSuccess && finalRoute === '/profile' && historySize === 3;
                }
            }
        ];

        // ==================== Ø´Ø¨ÛŒÙ‡â€ŒØ³Ø§Ø² ØªØ¹Ø§Ù…Ù„ÛŒ Ø§ØµÙ„Ø§Ø­ Ø´Ø¯Ù‡ ====================
        let activeRouter = null;
        
        function initSimulation() {
            activeRouter = new StableRouter();
            const controls = document.getElementById('sim-controls');
            
            controls.innerHTML = `
                <div style="margin-bottom: 10px;">
                    <strong>Ú©Ù†ØªØ±Ù„ ÙˆØ¶Ø¹ÛŒØª:</strong><br>
                    <button class="sim-btn" onclick="simLoginUser()">ğŸ‘¤ ÙˆØ±ÙˆØ¯ Ú©Ø§Ø±Ø¨Ø±</button>
                    <button class="sim-btn" onclick="simLoginAdmin()">ğŸ‘‘ ÙˆØ±ÙˆØ¯ Ø§Ø¯Ù…ÛŒÙ†</button>
                    <button class="sim-btn" onclick="simLogout()">ğŸšª Ø®Ø±ÙˆØ¬</button>
                </div>
                <div style="margin-bottom: 10px;">
                    <strong>Ù…Ø³ÛŒØ±ÛŒØ§Ø¨ÛŒ:</strong><br>
                    <button class="sim-btn" onclick="simNav('/')">ğŸ  Ø®Ø§Ù†Ù‡</button>
                    <button class="sim-btn" onclick="simNav('/login')">ğŸ” ÙˆØ±ÙˆØ¯</button>
                    <button class="sim-btn" onclick="simNav('/dashboard')">ğŸ“Š Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯</button>
                    <button class="sim-btn" onclick="simNav('/lessons')">ğŸ“š Ø¯Ø±ÙˆØ³</button>
                    <button class="sim-btn" onclick="simNav('/profile')">ğŸ‘¤ Ù¾Ø±ÙˆÙØ§ÛŒÙ„</button>
                    <button class="sim-btn" onclick="simNav('/admin')">âš™ï¸ Ø§Ø¯Ù…ÛŒÙ†</button>
                    <button class="sim-btn" onclick="simNav('/invalid-path')">âŒ Ù…Ø³ÛŒØ± Ù†Ø§Ù…Ø¹ØªØ¨Ø±</button>
                </div>
                <div>
                    <button class="sim-btn" onclick="simGoBack()">â†©ï¸ Ø¨Ø§Ø²Ú¯Ø´Øª</button>
                    <button class="sim-btn" onclick="simClearHistory()">ğŸ—‘ï¸ Ù¾Ø§Ú© ØªØ§Ø±ÛŒØ®Ú†Ù‡</button>
                </div>
            `;
            
            // Ø§Ø¶Ø§ÙÙ‡ Ú©Ø±Ø¯Ù† listener Ø¨Ø±Ø§ÛŒ Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ UI
            activeRouter.onRouteChange(updateSimUI);
            
            updateSimUI();
            console.log('âœ… Ø´Ø¨ÛŒÙ‡â€ŒØ³Ø§Ø² ÙØ¹Ø§Ù„ Ø´Ø¯');
        }
        
        function simLoginUser() {
            if (!activeRouter) return;
            activeRouter.setAuth(true, 'user');
            activeRouter.navigate('/dashboard');
        }
        
        function simLoginAdmin() {
            if (!activeRouter) return;
            activeRouter.setAuth(true, 'admin');
            activeRouter.navigate('/admin');
        }
        
        function simLogout() {
            if (!activeRouter) return;
            activeRouter.setAuth(false, 'guest');
        }
        
        function simNav(path) {
            if (!activeRouter) return;
            activeRouter.navigate(path);
        }
        
        function simGoBack() {
            if (!activeRouter) return;
            activeRouter.goBack();
        }
        
        function simClearHistory() {
            if (!activeRouter) return;
            // Ø±Ø§Ù‡ Ø³Ø§Ø¯Ù‡: Ø§ÛŒØ¬Ø§Ø¯ Ø±ÙˆØªØ± Ø¬Ø¯ÛŒØ¯
            initSimulation();
        }
        
        function updateSimUI(event) {
            if (!activeRouter) return;
            
            document.getElementById('current-route').textContent = activeRouter.currentRoute;
            
            const statusEl = document.getElementById('user-status');
            if (activeRouter.isAuthenticated) {
                statusEl.textContent = `âœ… Ù„Ø§Ú¯ÛŒÙ† (${activeRouter.userRole})`;
                statusEl.className = 'status-login';
            } else {
                statusEl.textContent = 'âŒ Ù„Ø§Ú¯ÛŒÙ† Ù†Ø´Ø¯Ù‡';
                statusEl.className = 'status-logout';
            }
            
            // Ù†Ù…Ø§ÛŒØ´ ØªØ§Ø±ÛŒØ®Ú†Ù‡
            const history = activeRouter.getHistory();
            document.getElementById('history-display').textContent = 
                JSON.stringify(history).replace(/"/g, '');
        }

        // ==================== Ø§Ø¬Ø±Ø§ÛŒ ØªØ³Øªâ€ŒÙ‡Ø§ ====================
        let passedTests = 0;
        let failedTests = 0;

        function runAllTests() {
            passedTests = 0;
            failedTests = 0;
            const resultsDiv = document.getElementById('test-results');
            resultsDiv.innerHTML = '';
            
            stableTests.forEach((test, index) => {
                const testDiv = document.createElement('div');
                testDiv.className = 'test-section';
                
                try {
                    // Ø§Ø¬Ø±Ø§ÛŒ ØªØ³Øª
                    const result = test.run();
                    
                    // Ø¨Ø±Ø±Ø³ÛŒ Ù†ØªÛŒØ¬Ù‡ Promise
                    if (result && typeof result.then === 'function') {
                        result.then(asyncResult => {
                            updateTestResult(test.id, asyncResult, testDiv);
                        }).catch(error => {
                            updateTestResult(test.id, false, testDiv, error);
                        });
                        return;
                    }
                    
                    updateTestResult(test.id, result, testDiv);
                    
                } catch (error) {
                    updateTestResult(test.id, false, testDiv, error);
                }
                
                resultsDiv.appendChild(testDiv);
            });
        }
        
        function updateTestResult(testId, result, testDiv, error = null) {
            const test = stableTests.find(t => t.id === testId);
            if (!test) return;
            
            const testResult = result ? 'pass' : 'fail';
            const resultText = result ? 'âœ… Ù…ÙˆÙÙ‚' : 'âŒ Ù†Ø§Ù…ÙˆÙÙ‚';
            
            if (result) passedTests++;
            else failedTests++;
            
            testDiv.innerHTML = `
                <div class="test-header">
                    <div class="test-title">${test.id}. ${test.title}</div>
                    <div class="test-result ${testResult}">${resultText}</div>
                </div>
                ${error ? `<div class="details">${error.message}</div>` : ''}
            `;
            
            updateSummary();
            console.log(`ØªØ³Øª ${test.id}: ${result ? 'âœ…' : 'âŒ'}`);
        }

        function clearTests() {
            document.getElementById('test-results').innerHTML = '';
            passedTests = failedTests = 0;
            updateSummary();
        }

        function updateSummary() {
            const summary = document.getElementById('summary-text');
            const total = stableTests.length;
            const percentage = total > 0 ? Math.round((passedTests / total) * 100) : 0;
            
            let message = `âœ… ${passedTests} Ù…ÙˆÙÙ‚ | âŒ ${failedTests} Ù†Ø§Ù…ÙˆÙÙ‚ | ğŸ“Š ${percentage}% Ù‚Ø¨ÙˆÙ„ÛŒ`;
            
            if (percentage === 100) message += ' ğŸ†';
            else if (percentage >= 80) message += ' ğŸ‘';
            
            summary.textContent = message;
            summary.style.color = percentage === 100 ? '#4caf50' : 
                                 percentage >= 80 ? '#ff9800' : '#f44336';
        }

        // Ø§Ø¬Ø±Ø§ÛŒ Ø®ÙˆØ¯Ú©Ø§Ø± ØªØ³Øªâ€ŒÙ‡Ø§
        window.onload = () => {
            updateSummary();
            setTimeout(runAllTests, 500);
        };
    </script>
</body>
</html>
