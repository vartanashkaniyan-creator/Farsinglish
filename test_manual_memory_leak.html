<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ØªØ³Øª Ø¯Ø³ØªÛŒ Ù†Ø´Øª Ø­Ø§ÙØ¸Ù‡ - Farsinglish</title>
    <style>
        * { box-sizing: border-box; font-family: system-ui, Tahoma, sans-serif; }
        body { background: #1a2634; margin: 0; padding: 15px; color: #e0e0e0; }
        .container { max-width: 1000px; margin: 0 auto; }
        h1 { color: #ffd966; text-align: center; font-size: 1.8rem; margin-bottom: 25px; }
        .card { background: #2c3e50; border-radius: 18px; padding: 22px; margin-bottom: 25px; box-shadow: 0 8px 20px rgba(0,0,0,0.4); border: 1px solid #3f5568; }
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(140px,1fr)); gap: 15px; margin-bottom: 20px; }
        .stat-box { background: #1e2b38; border-radius: 16px; padding: 15px; text-align: center; border: 1px solid #3a5068; }
        .stat-label { font-size: 0.85rem; color: #9aaebf; margin-bottom: 5px; }
        .stat-value { font-size: 1.9rem; font-weight: bold; color: #ffd966; line-height: 1.2; }
        .stat-unit { font-size: 0.8rem; color: #7f96ab; margin-right: 3px; }
        .btn-group { display: flex; flex-wrap: wrap; gap: 12px; margin: 25px 0 15px; }
        .btn { background: #3b4f64; border: none; color: white; padding: 14px 22px; border-radius: 40px; font-size: 1rem; font-weight: 500; cursor: pointer; transition: 0.2s; flex: 1 0 auto; min-width: 160px; box-shadow: 0 4px 8px rgba(0,0,0,0.3); border: 1px solid #57708c; }
        .btn-primary { background: #e67e22; border-color: #f39c12; }
        .btn-danger { background: #c0392b; border-color: #e74c3c; }
        .btn-success { background: #27ae60; border-color: #2ecc71; }
        .btn-warning { background: #7d3c1b; border-color: #b85e2a; }
        .btn:active { transform: scale(0.96); }
        .log-panel { background: #0f1a24; border-radius: 16px; padding: 16px; height: 200px; overflow-y: auto; font-family: 'Courier New', monospace; font-size: 0.85rem; border: 1px solid #2a4055; margin-top: 20px; }
        .log-entry { padding: 6px 0; border-bottom: 1px dashed #2e4258; color: #bbd1e6; }
        .warn { color: #f7dc6f; }
        .leak { color: #f1948a; }
        .good { color: #7dcea0; }
        .info { color: #85c1e2; }
        .snapshot-row { display: flex; gap: 20px; margin-top: 20px; flex-wrap: wrap; }
        .snapshot-box { background: #1b2a36; flex:1; padding: 15px; border-radius: 20px; text-align: center; min-width: 140px; }
        .badge { background: #ff5555; color: white; padding: 4px 14px; border-radius: 30px; font-size: 0.8rem; }
        hr { border-color: #3a5068; margin: 25px 0; }
    </style>
</head>
<body>
<div class="container">
    <h1>ğŸ§ª ØªØ³Øª Ø¯Ø³ØªÛŒ Ù†Ø´Øª Ø­Ø§ÙØ¸Ù‡ (Memory Leak)</h1>

    <!-- Ø¢Ù…Ø§Ø± Ù„Ø­Ø¸Ù‡â€ŒØ§ÛŒ Ø­Ø§ÙØ¸Ù‡ -->
    <div class="card">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
            <h2 style="margin:0; font-size:1.4rem;">ğŸ“Š Ù…Ø§Ù†ÛŒØªÙˆØ±ÛŒÙ†Ú¯ Ù„Ø­Ø¸Ù‡â€ŒØ§ÛŒ</h2>
            <span class="badge" id="leakWarning" style="background:#27ae60;">âœ… Ù¾Ø§ÛŒØ¯Ø§Ø±</span>
        </div>
        <div class="stats-grid">
            <div class="stat-box"><div class="stat-label">JS heap size</div><div class="stat-value" id="heapSize">0</div><div class="stat-unit">MB</div></div>
            <div class="stat-box"><div class="stat-label">total heap</div><div class="stat-value" id="totalHeap">0</div><div class="stat-unit">MB</div></div>
            <div class="stat-box"><div class="stat-label">heap limit</div><div class="stat-value" id="heapLimit">0</div><div class="stat-unit">MB</div></div>
            <div class="stat-box"><div class="stat-label">DOM nodes</div><div class="stat-value" id="domNodes">0</div></div>
        </div>
        <div style="display:flex; justify-content:space-between; font-size:0.8rem; color:#9aaebf; margin-top:5px;">
            <span>ğŸ”„ Ø¨Ø±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ù‡Ø± Û² Ø«Ø§Ù†ÛŒÙ‡</span>
            <span>â±ï¸ timestamp: <span id="timestamp">â€”</span></span>
        </div>
    </div>

    <!-- Ø¯Ú©Ù…Ù‡â€ŒÙ‡Ø§ÛŒ ØªØ³Øª -->
    <div class="card">
        <h2 style="margin-top:0; font-size:1.4rem;">ğŸ§¨ Ø³Ù†Ø§Ø±ÛŒÙˆÙ‡Ø§ÛŒ Ø§ÛŒØ¬Ø§Ø¯ Ù†Ø´Øª</h2>
        <div class="btn-group">
            <button class="btn" id="btnArray">ğŸ“¦ Ø¢Ø±Ø§ÛŒÙ‡â€ŒÙ‡Ø§ÛŒ Ø¨Ø²Ø±Ú¯ (Û±Û°Û°k Ø¹Ø¶Ùˆ)</button>
            <button class="btn" id="btnDom">ğŸ§© DOM + event listener (Ù†Ø´Øª)</button>
            <button class="btn" id="btnInterval">â²ï¸ Ø§ÛŒÙ†ØªØ±ÙˆØ§Ù„â€ŒÙ‡Ø§ÛŒ ÙØ±Ø§Ù…ÙˆØ´â€ŒØ´Ø¯Ù‡</button>
            <button class="btn" id="btnClosure">ğŸ”„ closure scope</button>
        </div>
        <div class="btn-group">
            <button class="btn btn-success" id="btnCleanArray">ğŸ§¹ Ù¾Ø§Ú©Ø³Ø§Ø²ÛŒ Ø¢Ø±Ø§ÛŒÙ‡â€ŒÙ‡Ø§</button>
            <button class="btn btn-success" id="btnCleanDom">ğŸ§½ Ù¾Ø§Ú©Ø³Ø§Ø²ÛŒ DOM</button>
            <button class="btn btn-success" id="btnClearInterval">â¹ï¸ Ù¾Ø§Ú©Ø³Ø§Ø²ÛŒ Ø§ÛŒÙ†ØªØ±ÙˆØ§Ù„â€ŒÙ‡Ø§</button>
            <button class="btn btn-primary" id="btnGc">âš¡ Ø¯Ø±Ø®ÙˆØ§Ø³Øª Garbage Collector</button>
        </div>
        <div style="margin-top:20px;">
            <button class="btn btn-warning" id="btnSnapshotBefore">ğŸ“¸ Ø§Ø³Ù†Ù¾Ø´Ø§Øª Ù‚Ø¨Ù„</button>
            <button class="btn btn-warning" id="btnSnapshotAfter">ğŸ“¸ Ø§Ø³Ù†Ù¾Ø´Ø§Øª Ø¨Ø¹Ø¯ (Ù…Ù‚Ø§ÛŒØ³Ù‡)</button>
            <button class="btn btn-danger" id="btnResetAll">ğŸ”„ Ø±ÛŒØ³Øª Ú©Ø§Ù…Ù„ (Ø­Ø°Ù Ù‡Ù…Ù‡)</button>
        </div>
    </div>

    <!-- Ø°Ø®ÛŒØ±Ù‡ Ø§Ø³Ù†Ù¾Ø´Ø§Øªâ€ŒÙ‡Ø§ -->
    <div class="card">
        <div class="snapshot-row">
            <div class="snapshot-box"><strong>ğŸ“¸ Ø§Ø³Ù†Ù¾Ø´Ø§Øª Ù‚Ø¨Ù„</strong><br><span id="snapBeforeVal">â€”</span><br><small>heap used</small></div>
            <div class="snapshot-box"><strong>ğŸ“¸ Ø§Ø³Ù†Ù¾Ø´Ø§Øª Ø¨Ø¹Ø¯</strong><br><span id="snapAfterVal">â€”</span><br><small>heap used</small></div>
            <div class="snapshot-box"><strong>ğŸ“ˆ ØªÙØ§ÙˆØª</strong><br><span id="snapDiffVal">â€”</span><br><small>MB / Ø¯Ø±ØµØ¯</small></div>
        </div>
    </div>

    <!-- Ù„Ø§Ú¯ Ø±ÙˆÛŒØ¯Ø§Ø¯Ù‡Ø§ -->
    <div class="card">
        <div style="display:flex; justify-content:space-between; margin-bottom:10px;">
            <h2 style="margin:0; font-size:1.2rem;">ğŸ“‹ Ú¯Ø²Ø§Ø±Ø´ Ø¹Ù…Ù„Ú©Ø±Ø¯</h2>
            <button class="btn" id="btnClearLog" style="padding:8px 18px; min-width:unset;">Ù¾Ø§Ú© Ú©Ø±Ø¯Ù† Ù„Ø§Ú¯</button>
        </div>
        <div class="log-panel" id="logPanel">
            <div class="log-entry">âš¡ Ø¨Ø±Ù†Ø§Ù…Ù‡ Ø´Ø±ÙˆØ¹ Ø´Ø¯. Ø¨Ø±Ø§ÛŒ ØªØ³Øª Ø¯Ú©Ù…Ù‡â€ŒÙ‡Ø§ Ø±Ø§ ÙØ´Ø§Ø± Ø¯Ù‡ÛŒØ¯.</div>
        </div>
    </div>
</div>

<script>
    (function(){
        // -------------------- ÙˆØ¶Ø¹ÛŒØª Ø¯Ø§Ø®Ù„ÛŒ --------------------
        let leakedArrays = [];              // Ø¢Ø±Ø§ÛŒÙ‡â€ŒÙ‡Ø§ÛŒ Ø¹Ù…Ø¯ÛŒ Ø¨Ø±Ø§ÛŒ Ù†Ø´Øª
        let leakedElements = [];            // Ø¹Ù†Ø§ØµØ± DOM Ø±Ù‡Ø§ Ø´Ø¯Ù‡
        let intervals = [];                 // interval IDÙ‡Ø§
        let closureLeakHolder = [];          // Ù†Ú¯Ù‡Ø¯Ø§Ø±Ù†Ø¯Ù‡ Ø¨Ø±Ø§ÛŒ closure
        
        let snapBefore = 0;
        let snapAfter = 0;

        // -------------------- Ø§Ø¨Ø²Ø§Ø± Ù„Ø§Ú¯ --------------------
        const logPanel = document.getElementById('logPanel');
        function addLog(message, type = 'info') {
            const entry = document.createElement('div');
            entry.className = `log-entry ${type}`;
            const time = new Date().toLocaleTimeString('fa-IR', {hour:'2-digit', minute:'2-digit', second:'2-digit'});
            entry.textContent = `[${time}] ${message}`;
            logPanel.appendChild(entry);
            logPanel.scrollTop = logPanel.scrollHeight;
        }

        // -------------------- Ù†Ù…Ø§ÛŒØ´ Ø­Ø§ÙØ¸Ù‡ --------------------
        function formatMB(bytes) {
            return (bytes / (1024 * 1024)).toFixed(2);
        }

        function updateMemoryStats() {
            const heapEl = document.getElementById('heapSize');
            const totalEl = document.getElementById('totalHeap');
            const limitEl = document.getElementById('heapLimit');
            const domEl = document.getElementById('domNodes');
            const tsEl = document.getElementById('timestamp');

            if (performance.memory) {
                const mem = performance.memory;
                heapEl.innerText = formatMB(mem.usedJSHeapSize);
                totalEl.innerText = formatMB(mem.totalJSHeapSize);
                limitEl.innerText = formatMB(mem.jsHeapSizeLimit);
            } else {
                heapEl.innerText = 'N/A';
                totalEl.innerText = 'N/A';
                limitEl.innerText = 'N/A';
            }

            // Ø´Ù…Ø§Ø±Ø´ DOM nodes (ØªÙ‚Ø±ÛŒØ¨ÛŒ)
            const count = document.getElementsByTagName('*').length;
            domEl.innerText = count;

            const now = new Date();
            tsEl.innerText = now.toLocaleTimeString('fa-IR');

            // Ù‡Ø´Ø¯Ø§Ø± Ø§Ú¯Ø± Ø±Ø´Ø¯ ØºÛŒØ±Ø¹Ø§Ø¯ÛŒ
            const warnEl = document.getElementById('leakWarning');
            if (performance.memory) {
                const used = performance.memory.usedJSHeapSize;
                if (used > 200 * 1024 * 1024) { // 200MB
                    warnEl.innerText = 'âš ï¸ Ù†Ø´Øª Ø§Ø­ØªÙ…Ø§Ù„ÛŒ!';
                    warnEl.style.background = '#e67e22';
                } else {
                    warnEl.innerText = 'âœ… Ù¾Ø§ÛŒØ¯Ø§Ø±';
                    warnEl.style.background = '#27ae60';
                }
            }
        }

        // -------------------- Ø³Ù†Ø§Ø±ÛŒÙˆÙ‡Ø§ÛŒ Ù†Ø´Øª --------------------
        document.getElementById('btnArray').addEventListener('click', function(){
            addLog('ğŸ“¦ Ø§ÛŒØ¬Ø§Ø¯ Ø¢Ø±Ø§ÛŒÙ‡ Ø¨Ø²Ø±Ú¯ (Û±Û°Û°Ù‡Ø²Ø§Ø± Ø¹Ø¶Ùˆ) ...', 'warn');
            const bigArray = new Array(100000).fill(0).map((_,i) => ({id:i, value: 'test' + i, data: new Array(10).fill('*') }));
            leakedArrays.push(bigArray);  // Ù†Ú¯Ù‡ Ø¯Ø§Ø´ØªÙ‡ Ù…ÛŒâ€ŒØ´ÙˆØ¯
            addLog(`âœ… Ø¢Ø±Ø§ÛŒÙ‡ Ø¨Ø§ ${bigArray.length} Ø¹Ø¶Ùˆ Ø°Ø®ÛŒØ±Ù‡ Ø´Ø¯ (leakedArrays length = ${leakedArrays.length})`, 'leak');
        });

        // DOM leak
        document.getElementById('btnDom').addEventListener('click', function(){
            addLog('ğŸ§© Ø§ÛŒØ¬Ø§Ø¯ ÛµÛ° Ø¯Ú©Ù…Ù‡ Ø¨Ø§ event listener (Ù†Ø´Øª)', 'warn');
            const container = document.createElement('div');
            container.id = 'leakContainer_' + Date.now();
            for (let i=0; i<50; i++) {
                const btn = document.createElement('button');
                btn.innerText = 'Ù†Ø´Øª ' + i;
                btn.addEventListener('click', function(){ alert('Ø§ÛŒÙ† Ø¯Ú©Ù…Ù‡ Ù†Ø´Øª ÛŒØ§ÙØªÙ‡!'); });
                container.appendChild(btn);
            }
            document.body.appendChild(container);
            leakedElements.push(container);
            addLog(`âœ… ${leakedElements.length} Ø¹Ù†ØµØ± DOM Ù†Ø´Øª ÛŒØ§ÙØªÙ‡ Ø§Ø¶Ø§ÙÙ‡ Ø´Ø¯.`, 'leak');
        });

        // interval leak
        document.getElementById('btnInterval').addEventListener('click', function(){
            addLog('â²ï¸ Ø§Ø¶Ø§ÙÙ‡ Ú©Ø±Ø¯Ù† interval (Ù¾Ø§Ú© Ù†Ù…ÛŒâ€ŒØ´ÙˆØ¯)', 'warn');
            const id = setInterval(() => {
                console.log('interval leak running...');
                // Ú©Ø§Ø±ÛŒ Ù†Ù…ÛŒâ€ŒÚ©Ù†Ø¯ ÙÙ‚Ø· Ø§Ø¬Ø±Ø§ Ù…ÛŒâ€ŒØ´ÙˆØ¯
            }, 2000);
            intervals.push(id);
            addLog(`âœ… ØªØ¹Ø¯Ø§Ø¯ Ø§ÛŒÙ†ØªØ±ÙˆØ§Ù„â€ŒÙ‡Ø§ÛŒ ÙØ¹Ø§Ù„: ${intervals.length}`, 'leak');
        });

        // closure leak
        document.getElementById('btnClosure').addEventListener('click', function(){
            addLog('ğŸ”„ Ø§ÛŒØ¬Ø§Ø¯ closure Ø³Ù†Ú¯ÛŒÙ† (Ù†Ø´Øª)', 'warn');
            let bigData = new Array(50000).fill('closure leak data');
            let leakedFn = function() {
                return bigData.length; // bigData Ø¯Ø± scope Ù…ÛŒâ€ŒÙ…Ø§Ù†Ø¯
            };
            closureLeakHolder.push(leakedFn);
            addLog(`âœ… closureLeakHolder length: ${closureLeakHolder.length}`, 'leak');
        });

        // Ù¾Ø§Ú©Ø³Ø§Ø²ÛŒ Ø¢Ø±Ø§ÛŒÙ‡â€ŒÙ‡Ø§
        document.getElementById('btnCleanArray').addEventListener('click', function(){
            leakedArrays = [];
            addLog('ğŸ§¹ Ø¢Ø±Ø§ÛŒÙ‡â€ŒÙ‡Ø§ÛŒ Ø¨Ø²Ø±Ú¯ Ù¾Ø§Ú© Ø´Ø¯Ù†Ø¯.', 'good');
        });

        // Ù¾Ø§Ú©Ø³Ø§Ø²ÛŒ DOM
        document.getElementById('btnCleanDom').addEventListener('click', function(){
            leakedElements.forEach(el => el.remove());
            leakedElements = [];
            addLog('ğŸ§½ Ø¹Ù†Ø§ØµØ± DOM Ù†Ø´Øªâ€ŒÛŒØ§ÙØªÙ‡ Ø­Ø°Ù Ø´Ø¯Ù†Ø¯.', 'good');
        });

        // Ù¾Ø§Ú©Ø³Ø§Ø²ÛŒ Ø§ÛŒÙ†ØªØ±ÙˆØ§Ù„â€ŒÙ‡Ø§
        document.getElementById('btnClearInterval').addEventListener('click', function(){
            intervals.forEach(id => clearInterval(id));
            intervals = [];
            addLog('â¹ï¸ Ù‡Ù…Ù‡ Ø§ÛŒÙ†ØªØ±ÙˆØ§Ù„â€ŒÙ‡Ø§ Ù…ØªÙˆÙ‚Ù Ø´Ø¯Ù†Ø¯.', 'good');
        });

        // Ø¯Ø±Ø®ÙˆØ§Ø³Øª GC (ÙÙ‚Ø· Ø¯Ø± Ù…Ø±ÙˆØ±Ú¯Ø±Ù‡Ø§ÛŒ Ø®Ø§Øµ)
        document.getElementById('btnGc').addEventListener('click', function(){
            addLog('âš¡ ØªÙ„Ø§Ø´ Ø¨Ø±Ø§ÛŒ ÙØ±Ø§Ø®ÙˆØ§Ù†ÛŒ Garbage Collector...', 'info');
            if (window.gc) {
                window.gc();
                addLog('âœ… GC Ø§Ø¬Ø±Ø§ Ø´Ø¯.', 'good');
            } else {
                addLog('âš ï¸ Ù¾Ù†Ø¬Ø±Ù‡ Ø±Ø§ Ø¨Ø§Ø² Ú©Ù†ÛŒØ¯: chrome://flags/#enable-javascript-harmony', 'warn');
            }
            updateMemoryStats();
        });

        // Ø§Ø³Ù†Ù¾Ø´Ø§Øª Ù‚Ø¨Ù„
        document.getElementById('btnSnapshotBefore').addEventListener('click', function(){
            if (!performance.memory) { addLog('âŒ performance.memory Ù¾Ø´ØªÛŒØ¨Ø§Ù†ÛŒ Ù†Ù…ÛŒâ€ŒØ´ÙˆØ¯', 'warn'); return; }
            snapBefore = performance.memory.usedJSHeapSize;
            document.getElementById('snapBeforeVal').innerText = formatMB(snapBefore) + ' MB';
            addLog(`ğŸ“¸ Ø§Ø³Ù†Ù¾Ø´Ø§Øª Ù‚Ø¨Ù„ Ø«Ø¨Øª Ø´Ø¯: ${formatMB(snapBefore)} MB`, 'info');
        });

        // Ø§Ø³Ù†Ù¾Ø´Ø§Øª Ø¨Ø¹Ø¯ + Ù…Ø­Ø§Ø³Ø¨Ù‡ ØªÙØ§ÙˆØª
        document.getElementById('btnSnapshotAfter').addEventListener('click', function(){
            if (!performance.memory) { addLog('âŒ performance.memory Ù¾Ø´ØªÛŒØ¨Ø§Ù†ÛŒ Ù†Ù…ÛŒâ€ŒØ´ÙˆØ¯', 'warn'); return; }
            snapAfter = performance.memory.usedJSHeapSize;
            document.getElementById('snapAfterVal').innerText = formatMB(snapAfter) + ' MB';
            const diff = snapAfter - snapBefore;
            const diffMB = (diff / (1024*1024)).toFixed(2);
            const percent = ((snapAfter/snapBefore - 1)*100).toFixed(1);
            document.getElementById('snapDiffVal').innerHTML = `${diffMB} MB (${percent}%)`;
            addLog(`ğŸ“Š ØªÙØ§ÙˆØª: ${diffMB} MB (${percent}%)`, diff > 5*1024*1024 ? 'leak' : 'good');
        });

        // Ø±ÛŒØ³Øª Ú©Ø§Ù…Ù„
        document.getElementById('btnResetAll').addEventListener('click', function(){
            leakedArrays = [];
            leakedElements.forEach(el => el.remove());
            leakedElements = [];
            intervals.forEach(id => clearInterval(id));
            intervals = [];
            closureLeakHolder = [];
            if (window.gc) window.gc();
            addLog('ğŸ”„ Ù‡Ù…Ù‡ Ù…Ù†Ø§Ø¨Ø¹ Ø¢Ø²Ø§Ø¯ Ø´Ø¯Ù†Ø¯.', 'good');
            updateMemoryStats();
        });

        // Ù¾Ø§Ú© Ú©Ø±Ø¯Ù† Ù„Ø§Ú¯
        document.getElementById('btnClearLog').addEventListener('click', function(){
            logPanel.innerHTML = '<div class="log-entry">ğŸ§¹ Ù„Ø§Ú¯ Ù¾Ø§Ú© Ø´Ø¯.</div>';
        });

        // Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ø®ÙˆØ¯Ú©Ø§Ø± Ù‡Ø± Û² Ø«Ø§Ù†ÛŒÙ‡
        setInterval(() => {
            updateMemoryStats();
        }, 2000);

        // Ù…Ù‚Ø¯Ø§Ø±Ø¯Ù‡ÛŒ Ø§ÙˆÙ„ÛŒÙ‡
        updateMemoryStats();
        addLog('âš¡ ØªØ³Øª Ù†Ø´Øª Ø­Ø§ÙØ¸Ù‡ Ø¢Ù…Ø§Ø¯Ù‡ Ø§Ø³Øª.', 'good');
    })();
</script>
</body>
</html>
