<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ØªØ³Øª ÛŒÚ©Ù¾Ø§Ø±Ú†Ú¯ÛŒ Offline Manager - Farsinglish</title>
    <style>
        body {
            font-family: Vazir, Tahoma, Arial, sans-serif;
            max-width: 800px;
            margin: 20px auto;
            padding: 20px;
            background: #f5f5f5;
            direction: rtl;
        }
        h1 {
            color: #2c3e50;
            font-size: 1.5rem;
            border-bottom: 2px solid #3498db;
            padding-bottom: 10px;
        }
        .test-container {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        .button-group {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin: 15px 0;
        }
        button {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-family: Vazir, Tahoma, Arial, sans-serif;
            font-size: 0.9rem;
            transition: all 0.2s;
            flex: 1 1 auto;
            min-width: 120px;
        }
        .btn-primary {
            background: #3498db;
            color: white;
        }
        .btn-primary:hover {
            background: #2980b9;
        }
        .btn-success {
            background: #27ae60;
            color: white;
        }
        .btn-success:hover {
            background: #229954;
        }
        .btn-warning {
            background: #f39c12;
            color: white;
        }
        .btn-warning:hover {
            background: #e67e22;
        }
        .btn-danger {
            background: #e74c3c;
            color: white;
        }
        .btn-danger:hover {
            background: #c0392b;
        }
        .log-container {
            background: #1e1e1e;
            color: #00ff00;
            padding: 15px;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            font-size: 0.85rem;
            direction: ltr;
            height: 300px;
            overflow-y: auto;
            white-space: pre-wrap;
            margin-top: 15px;
        }
        .log-entry {
            margin: 2px 0;
            border-bottom: 1px solid #333;
            padding: 2px 0;
        }
        .log-info {
            color: #00ff00;
        }
        .log-error {
            color: #ff6b6b;
        }
        .log-warning {
            color: #f39c12;
        }
        .log-success {
            color: #2ecc71;
            font-weight: bold;
        }
        .status-badge {
            display: inline-block;
            padding: 3px 8px;
            border-radius: 12px;
            font-size: 0.8rem;
            font-weight: bold;
            margin-right: 10px;
        }
        .badge-online {
            background: #27ae60;
            color: white;
        }
        .badge-offline {
            background: #e74c3c;
            color: white;
        }
        .test-row {
            display: flex;
            align-items: center;
            gap: 10px;
            margin: 10px 0;
            flex-wrap: wrap;
        }
        .test-label {
            font-weight: bold;
            min-width: 120px;
            color: #34495e;
        }
        hr {
            border: none;
            border-top: 1px solid #ddd;
            margin: 20px 0;
        }
        .summary {
            background: #ecf0f1;
            padding: 15px;
            border-radius: 8px;
            margin-top: 20px;
        }
        .summary-item {
            display: flex;
            justify-content: space-between;
            margin: 5px 0;
            padding: 5px;
            background: white;
            border-radius: 4px;
        }
        .pass {
            color: #27ae60;
            font-weight: bold;
        }
        .fail {
            color: #e74c3c;
            font-weight: bold;
        }
        .fixed-badge {
            background: #f1c40f;
            color: #000;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 0.7rem;
            font-weight: bold;
            margin-right: 5px;
        }
    </style>
</head>
<body>
    <h1>ğŸ§ª ØªØ³Øª ÛŒÚ©Ù¾Ø§Ø±Ú†Ú¯ÛŒ Offline Manager <span class="fixed-badge">Ø±ÙØ¹ Ø®Ø·Ø§ Ø´Ø¯Ù‡</span></h1>
    <div class="test-container">
        <div style="display: flex; justify-content: space-between; align-items: center;">
            <h2>Ù…Ø¯ÛŒØ±ÛŒØª ÙˆØ¶Ø¹ÛŒØª Ø¢ÙÙ„Ø§ÛŒÙ†/Ø¢Ù†Ù„Ø§ÛŒÙ†</h2>
            <span id="networkStatusBadge" class="status-badge badge-online">Ø¢Ù†Ù„Ø§ÛŒÙ†</span>
        </div>

        <div class="button-group">
            <button class="btn-primary" onclick="runAllTests()">â–¶ Ø§Ø¬Ø±Ø§ÛŒ Ù‡Ù…Ù‡ ØªØ³Øªâ€ŒÙ‡Ø§</button>
            <button class="btn-warning" onclick="clearLogs()">ğŸ—‘ Ù¾Ø§Ú© Ú©Ø±Ø¯Ù† Ù„Ø§Ú¯</button>
            <button class="btn-success" onclick="resetEnvironment()">ğŸ”„ Ø±ÛŒØ³Øª Ù…Ø­ÛŒØ· ØªØ³Øª</button>
        </div>

        <hr>

        <!-- ØªØ³Øªâ€ŒÙ‡Ø§ÛŒ Ù…Ø¯ÛŒØ±ÛŒØª ÙˆØ¶Ø¹ÛŒØª -->
        <h3>ğŸ“¡ Û±. ØªØ´Ø®ÛŒØµ ÙˆØ¶Ø¹ÛŒØª Ø´Ø¨Ú©Ù‡</h3>
        <div class="test-row">
            <span class="test-label">ÙˆØ¶Ø¹ÛŒØª ÙØ¹Ù„ÛŒ:</span>
            <button class="btn-primary" onclick="testGetCurrentStatus()">ğŸ” Ø¨Ø±Ø±Ø³ÛŒ ÙˆØ¶Ø¹ÛŒØª ÙØ¹Ù„ÛŒ</button>
        </div>
        <div class="test-row">
            <span class="test-label">Ø´Ø¨ÛŒÙ‡â€ŒØ³Ø§Ø²ÛŒ:</span>
            <button class="btn-success" onclick="simulateOnline()">ğŸ“¶ Ø¢Ù†Ù„Ø§ÛŒÙ†</button>
            <button class="btn-danger" onclick="simulateOffline()">ğŸ“´ Ø¢ÙÙ„Ø§ÛŒÙ†</button>
        </div>

        <h3>ğŸ’¾ Û². Ø°Ø®ÛŒØ±Ù‡ Ùˆ Ø¨Ø§Ø²ÛŒØ§Ø¨ÛŒ Ø¹Ù…Ù„ÛŒØ§Øª Ø¢ÙÙ„Ø§ÛŒÙ† (Ø±ÙØ¹ Ø´Ø¯Ù‡)</h3>
        <div class="test-row">
            <span class="test-label">Ø¹Ù…Ù„ÛŒØ§Øª:</span>
            <button class="btn-primary" onclick="testAddOfflineOperationFixed('save_lesson', {id: 1, name: 'Ø¯Ø±Ø³ Û±'})">â• Ø§ÙØ²ÙˆØ¯Ù† Ø¯Ø±Ø³</button>
            <button class="btn-primary" onclick="testAddOfflineOperationFixed('save_progress', {lessonId: 1, score: 80})">ğŸ“Š Ø§ÙØ²ÙˆØ¯Ù† Ù¾ÛŒØ´Ø±ÙØª</button>
            <button class="btn-primary" onclick="testAddOfflineOperationFixed('save_achievement', {type: 'gold'})">ğŸ† Ø§ÙØ²ÙˆØ¯Ù† Ø¯Ø³ØªØ§ÙˆØ±Ø¯</button>
        </div>
        <div class="test-row">
            <span class="test-label">Ù…Ø¯ÛŒØ±ÛŒØª:</span>
            <button class="btn-primary" onclick="testGetPendingOperations()">ğŸ“‹ Ù†Ù…Ø§ÛŒØ´ Ø¹Ù…Ù„ÛŒØ§Øª Ø¯Ø± Ø§Ù†ØªØ¸Ø§Ø±</button>
            <button class="btn-success" onclick="testProcessPendingOperations()">âš™ Ù¾Ø±Ø¯Ø§Ø²Ø´ Ø¹Ù…Ù„ÛŒØ§Øª</button>
        </div>

        <h3>ğŸ”„ Û³. Ù‡Ù…Ú¯Ø§Ù…â€ŒØ³Ø§Ø²ÛŒ Ø®ÙˆØ¯Ú©Ø§Ø±</h3>
        <div class="test-row">
            <span class="test-label">Ù‡Ù…Ú¯Ø§Ù…â€ŒØ³Ø§Ø²ÛŒ:</span>
            <button class="btn-primary" onclick="testEnableAutoSync()">âœ… ÙØ¹Ø§Ù„</button>
            <button class="btn-danger" onclick="testDisableAutoSync()">âŒ ØºÛŒØ±ÙØ¹Ø§Ù„</button>
            <button class="btn-warning" onclick="testTriggerSync()">ğŸ”„ Ù‡Ù…Ú¯Ø§Ù…â€ŒØ³Ø§Ø²ÛŒ Ø¯Ø³ØªÛŒ</button>
        </div>

        <h3>âš  Û´. Ù…Ø¯ÛŒØ±ÛŒØª Ø®Ø·Ø§</h3>
        <div class="test-row">
            <span class="test-label">Ø®Ø·Ø§:</span>
            <button class="btn-warning" onclick="testSyncFailure()">ğŸ’¥ Ø´Ø¨ÛŒÙ‡â€ŒØ³Ø§Ø²ÛŒ Ø®Ø·Ø§</button>
            <button class="btn-primary" onclick="testRetryFailedOperations()">ğŸ”„ ØªÙ„Ø§Ø´ Ù…Ø¬Ø¯Ø¯</button>
            <button class="btn-danger" onclick="testClearFailedOperations()">ğŸ—‘ Ù¾Ø§Ú© Ú©Ø±Ø¯Ù† Ø®Ø·Ø§Ù‡Ø§</button>
        </div>

        <h3>ğŸ“Š Ûµ. Ø¢Ù…Ø§Ø± Ùˆ ÙˆØ¶Ø¹ÛŒØª</h3>
        <div class="test-row">
            <span class="test-label">Ø¢Ù…Ø§Ø±:</span>
            <button class="btn-primary" onclick="testGetStats()">ğŸ“ˆ Ù†Ù…Ø§ÛŒØ´ Ø¢Ù…Ø§Ø±</button>
            <button class="btn-primary" onclick="testGetQueueLength()">ğŸ§® ØªØ¹Ø¯Ø§Ø¯ Ø¯Ø± ØµÙ</button>
        </div>

        <h3>ğŸ§ª Û¶. Ø³Ù†Ø§Ø±ÛŒÙˆÛŒ Ú©Ø§Ù…Ù„</h3>
        <div class="test-row">
            <span class="test-label">Ø³Ù†Ø§Ø±ÛŒÙˆ:</span>
            <button class="btn-success" onclick="testCompleteOfflineScenario()">ğŸ”„ Ø§Ø¬Ø±Ø§ÛŒ Ø³Ù†Ø§Ø±ÛŒÙˆÛŒ Ø¢ÙÙ„Ø§ÛŒÙ† Ú©Ø§Ù…Ù„</button>
        </div>

        <h3>âœ… Ù†ØªØ§ÛŒØ¬ ØªØ³Øªâ€ŒÙ‡Ø§</h3>
        <div id="summary" class="summary">
            <div class="summary-item">
                <span>ØªØ¹Ø¯Ø§Ø¯ ØªØ³Øªâ€ŒÙ‡Ø§ÛŒ Ù…ÙˆÙÙ‚:</span>
                <span id="passCount" class="pass">0</span>
            </div>
            <div class="summary-item">
                <span>ØªØ¹Ø¯Ø§Ø¯ ØªØ³Øªâ€ŒÙ‡Ø§ÛŒ Ù†Ø§Ù…ÙˆÙÙ‚:</span>
                <span id="failCount" class="fail">0</span>
            </div>
            <div class="summary-item">
                <span>Ù…Ø¬Ù…ÙˆØ¹ ØªØ³Øªâ€ŒÙ‡Ø§:</span>
                <span id="totalCount">0</span>
            </div>
        </div>

        <div id="logContainer" class="log-container">
            <div class="log-entry log-info">ğŸ¤– Ø¢Ù…Ø§Ø¯Ù‡ Ø§Ø¬Ø±Ø§ÛŒ ØªØ³Øªâ€ŒÙ‡Ø§ (Ù†Ø³Ø®Ù‡ Ø±ÙØ¹ Ø®Ø·Ø§ Ø´Ø¯Ù‡)...</div>
        </div>
    </div>

    <script>
        // ---------- Mock Objects ----------
        const mockDB = {
            operations: [],
            syncHistory: [],
            
            saveOfflineOperation(type, data) {
                const op = {
                    id: Date.now() + Math.random(),
                    type,
                    data,
                    timestamp: new Date().toISOString(),
                    status: 'pending',
                    retryCount: 0
                };
                this.operations.push(op);
                return op;
            },

            getPendingOperations() {
                return this.operations.filter(op => op.status === 'pending');
            },

            updateOperationStatus(id, status) {
                const op = this.operations.find(o => o.id === id);
                if (op) {
                    op.status = status;
                    if (status === 'completed') {
                        op.completedAt = new Date().toISOString();
                    }
                    return true;
                }
                return false;
            },

            clearOperations() {
                this.operations = [];
            },

            getStats() {
                return {
                    total: this.operations.length,
                    pending: this.operations.filter(o => o.status === 'pending').length,
                    completed: this.operations.filter(o => o.status === 'completed').length,
                    failed: this.operations.filter(o => o.status === 'failed').length
                };
            }
        };

        // ---------- Offline Manager Class ----------
        class OfflineManager {
            constructor(db) {
                this.db = db;
                this.isOnline = navigator.onLine;
                this.autoSyncEnabled = true;
                this.syncInProgress = false;
                this.eventListeners = [];
                
                // Ø´Ø¨ÛŒÙ‡â€ŒØ³Ø§Ø²ÛŒ event listener
                window.addEventListener('online', () => this.handleOnline());
                window.addEventListener('offline', () => this.handleOffline());
            }

            handleOnline() {
                this.isOnline = true;
                this.log('ğŸ“¶ Ø´Ø¨Ú©Ù‡ Ù…ØªØµÙ„ Ø´Ø¯');
                this.notifyListeners('online');
                if (this.autoSyncEnabled && !this.syncInProgress) {
                    this.processPendingOperations();
                }
            }

            handleOffline() {
                this.isOnline = false;
                this.log('ğŸ“´ Ø´Ø¨Ú©Ù‡ Ù‚Ø·Ø¹ Ø´Ø¯');
                this.notifyListeners('offline');
            }

            getCurrentStatus() {
                return {
                    isOnline: this.isOnline,
                    autoSyncEnabled: this.autoSyncEnabled,
                    syncInProgress: this.syncInProgress,
                    pendingCount: this.db.getPendingOperations().length,
                    timestamp: new Date().toISOString()
                };
            }

            // âœ… Ù…ØªØ¯ Ø§ØµÙ„Ø§Ø­ Ø´Ø¯Ù‡ - Ø­Ø§Ù„Ø§ operation Ø±Ø§ Ø¨Ø±Ù…ÛŒâ€ŒÚ¯Ø±Ø¯Ø§Ù†Ø¯
            addOfflineOperation(type, data) {
                const operation = this.db.saveOfflineOperation(type, data);
                this.log(`ğŸ’¾ Ø¹Ù…Ù„ÛŒØ§Øª Ø¢ÙÙ„Ø§ÛŒÙ† Ø°Ø®ÛŒØ±Ù‡ Ø´Ø¯: ${type} (${operation.id})`);
                
                if (this.isOnline && this.autoSyncEnabled && !this.syncInProgress) {
                    this.processPendingOperations();
                }
                
                return operation; // Ø§ÛŒÙ† Ø®Ø· Ø¨Ø±Ø§ÛŒ Ø¨Ø±Ú¯Ø±Ø¯Ø§Ù†Ø¯Ù† Ø¹Ù…Ù„ÛŒØ§Øª Ø¶Ø±ÙˆØ±ÛŒ Ø§Ø³Øª
            }

            async processPendingOperations() {
                if (this.syncInProgress) {
                    this.log('âš  Ù‡Ù…Ú¯Ø§Ù…â€ŒØ³Ø§Ø²ÛŒ Ø¯Ø± Ø­Ø§Ù„ Ø§Ù†Ø¬Ø§Ù… Ø§Ø³Øª');
                    return;
                }

                if (!this.isOnline) {
                    this.log('âš  Ø¢ÙÙ„Ø§ÛŒÙ† - Ù‡Ù…Ú¯Ø§Ù…â€ŒØ³Ø§Ø²ÛŒ Ù…Ù…Ú©Ù† Ù†ÛŒØ³Øª');
                    return;
                }

                this.syncInProgress = true;
                this.log('ğŸ”„ Ø´Ø±ÙˆØ¹ Ù‡Ù…Ú¯Ø§Ù…â€ŒØ³Ø§Ø²ÛŒ Ø¹Ù…Ù„ÛŒØ§Øª...');

                const pending = this.db.getPendingOperations();
                let successCount = 0;
                let failCount = 0;

                for (const op of pending) {
                    try {
                        // Ø´Ø¨ÛŒÙ‡â€ŒØ³Ø§Ø²ÛŒ Ø§Ø±Ø³Ø§Ù„ Ø¨Ù‡ Ø³Ø±ÙˆØ±
                        await this.simulateServerSync(op);
                        this.db.updateOperationStatus(op.id, 'completed');
                        successCount++;
                        this.log(`âœ… Ø¹Ù…Ù„ÛŒØ§Øª ${op.id} Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ù‡Ù…Ú¯Ø§Ù… Ø´Ø¯`);
                    } catch (error) {
                        op.retryCount++;
                        if (op.retryCount >= 3) {
                            this.db.updateOperationStatus(op.id, 'failed');
                            failCount++;
                            this.log(`âŒ Ø¹Ù…Ù„ÛŒØ§Øª ${op.id} Ù¾Ø³ Ø§Ø² Û³ Ø¨Ø§Ø± ØªÙ„Ø§Ø´ Ù†Ø§Ù…ÙˆÙÙ‚`, 'error');
                        } else {
                            this.log(`âš  Ø®Ø·Ø§ Ø¯Ø± Ø¹Ù…Ù„ÛŒØ§Øª ${op.id} (ØªÙ„Ø§Ø´ ${op.retryCount}/3)`, 'warning');
                        }
                    }
                }

                this.syncInProgress = false;
                this.log(`ğŸ“Š Ù‡Ù…Ú¯Ø§Ù…â€ŒØ³Ø§Ø²ÛŒ Ú©Ø§Ù…Ù„: ${successCount} Ù…ÙˆÙÙ‚ØŒ ${failCount} Ù†Ø§Ù…ÙˆÙÙ‚`);

                return { success: successCount, fail: failCount };
            }

            simulateServerSync(operation) {
                return new Promise((resolve, reject) => {
                    setTimeout(() => {
                        // Ø´Ø¨ÛŒÙ‡â€ŒØ³Ø§Ø²ÛŒ Ø®Ø·Ø§ÛŒ ØªØµØ§Ø¯ÙÛŒ (Û±Û°Ùª Ø§Ø­ØªÙ…Ø§Ù„)
                        if (Math.random() < 0.1 && operation.retryCount < 2) {
                            reject(new Error('Ø®Ø·Ø§ÛŒ Ø³Ø±ÙˆØ±'));
                        } else {
                            resolve({ success: true, operation });
                        }
                    }, 100);
                });
            }

            getPendingOperations() {
                return this.db.getPendingOperations();
            }

            enableAutoSync() {
                this.autoSyncEnabled = true;
                this.log('âœ… Ù‡Ù…Ú¯Ø§Ù…â€ŒØ³Ø§Ø²ÛŒ Ø®ÙˆØ¯Ú©Ø§Ø± ÙØ¹Ø§Ù„ Ø´Ø¯');
                if (this.isOnline && !this.syncInProgress) {
                    this.processPendingOperations();
                }
            }

            disableAutoSync() {
                this.autoSyncEnabled = false;
                this.log('âŒ Ù‡Ù…Ú¯Ø§Ù…â€ŒØ³Ø§Ø²ÛŒ Ø®ÙˆØ¯Ú©Ø§Ø± ØºÛŒØ±ÙØ¹Ø§Ù„ Ø´Ø¯');
            }

            addEventListener(callback) {
                this.eventListeners.push(callback);
            }

            notifyListeners(event, data) {
                this.eventListeners.forEach(cb => cb(event, data));
            }

            getStats() {
                return this.db.getStats();
            }

            getQueueLength() {
                return this.db.getPendingOperations().length;
            }

            clearFailedOperations() {
                const failed = this.db.operations.filter(o => o.status === 'failed');
                failed.forEach(op => {
                    const index = this.db.operations.findIndex(o => o.id === op.id);
                    if (index !== -1) this.db.operations.splice(index, 1);
                });
                this.log(`ğŸ—‘ ${failed.length} Ø¹Ù…Ù„ÛŒØ§Øª Ù†Ø§Ù…ÙˆÙÙ‚ Ù¾Ø§Ú© Ø´Ø¯`);
            }

            log(message, type = 'info') {
                console.log(`[OfflineManager] ${message}`);
                // Ø§ÛŒÙ† Ù…ØªØ¯ ØªÙˆØ³Ø· UI ØµØ¯Ø§ Ø²Ø¯Ù‡ Ù…ÛŒâ€ŒØ´ÙˆØ¯
            }
        }

        // ---------- Test Framework ----------
        const TestFramework = {
            passCount: 0,
            failCount: 0,
            totalCount: 0,

            log(message, type = 'info') {
                const container = document.getElementById('logContainer');
                const entry = document.createElement('div');
                entry.className = `log-entry log-${type}`;
                
                let prefix = '';
                switch(type) {
                    case 'info': prefix = 'â„¹ï¸'; break;
                    case 'success': prefix = 'âœ…'; break;
                    case 'error': prefix = 'âŒ'; break;
                    case 'warning': prefix = 'âš ï¸'; break;
                }
                
                entry.textContent = `${prefix} ${message}`;
                container.appendChild(entry);
                container.scrollTop = container.scrollHeight;
            },

            assert(condition, message, type = 'success') {
                this.totalCount++;
                if (condition) {
                    this.passCount++;
                    this.log(`âœ… ${message}`, 'success');
                } else {
                    this.failCount++;
                    this.log(`âŒ ${message}`, 'error');
                }
                this.updateSummary();
            },

            assertEqual(actual, expected, message) {
                this.assert(actual === expected, `${message} (${actual} === ${expected})`);
            },

            assertNotEqual(actual, expected, message) {
                this.assert(actual !== expected, `${message} (${actual} !== ${expected})`);
            },

            assertTrue(value, message) {
                this.assert(value === true, `${message} (true Ù…ÙˆØ±Ø¯ Ø§Ù†ØªØ¸Ø§Ø± Ø¨ÙˆØ¯ØŒ ${value} Ø¯Ø±ÛŒØ§ÙØª Ø´Ø¯)`);
            },

            assertFalse(value, message) {
                this.assert(value === false, `${message} (false Ù…ÙˆØ±Ø¯ Ø§Ù†ØªØ¸Ø§Ø± Ø¨ÙˆØ¯ØŒ ${value} Ø¯Ø±ÛŒØ§ÙØª Ø´Ø¯)`);
            },

            assertDefined(value, message) {
                this.assert(value !== undefined && value !== null, `${message} (Ù…Ù‚Ø¯Ø§Ø± ØªØ¹Ø±ÛŒÙ Ø´Ø¯Ù‡ Ù†ÛŒØ³Øª)`);
            },

            reset() {
                this.passCount = 0;
                this.failCount = 0;
                this.totalCount = 0;
                this.updateSummary();
                this.log('ğŸ”„ ØªØ³Øªâ€ŒÙ‡Ø§ Ø±ÛŒØ³Øª Ø´Ø¯Ù†Ø¯', 'info');
            },

            updateSummary() {
                document.getElementById('passCount').textContent = this.passCount;
                document.getElementById('failCount').textContent = this.failCount;
                document.getElementById('totalCount').textContent = this.totalCount;
            }
        };

        // ---------- Test Variables ----------
        let offlineManager;
        let testMockDB;

        // ---------- Test Functions ----------
        function initTest() {
            testMockDB = {
                operations: [],
                saveOfflineOperation(type, data) {
                    const op = {
                        id: Date.now() + Math.random(),
                        type,
                        data,
                        timestamp: new Date().toISOString(),
                        status: 'pending',
                        retryCount: 0
                    };
                    this.operations.push(op);
                    return op;
                },
                getPendingOperations() {
                    return this.operations.filter(op => op.status === 'pending');
                },
                updateOperationStatus(id, status) {
                    const op = this.operations.find(o => o.id === id);
                    if (op) {
                        op.status = status;
                        return true;
                    }
                    return false;
                },
                getStats() {
                    return {
                        total: this.operations.length,
                        pending: this.operations.filter(o => o.status === 'pending').length,
                        completed: this.operations.filter(o => o.status === 'completed').length,
                        failed: this.operations.filter(o => o.status === 'failed').length
                    };
                },
                clearOperations() {
                    this.operations = [];
                }
            };
            
            offlineManager = new OfflineManager(testMockDB);
            
            // Override log method to show in UI
            offlineManager.log = function(message, type = 'info') {
                TestFramework.log(message, type);
            };

            TestFramework.log('ğŸ§ª Ù…Ø­ÛŒØ· ØªØ³Øª Ø¢Ù…Ø§Ø¯Ù‡ Ø´Ø¯', 'info');
            updateNetworkBadge();
        }

        function resetEnvironment() {
            initTest();
            TestFramework.reset();
            TestFramework.log('ğŸ”„ Ù…Ø­ÛŒØ· ØªØ³Øª Ø±ÛŒØ³Øª Ø´Ø¯', 'info');
        }

        function updateNetworkBadge() {
            const badge = document.getElementById('networkStatusBadge');
            if (offlineManager && offlineManager.isOnline) {
                badge.textContent = 'Ø¢Ù†Ù„Ø§ÛŒÙ†';
                badge.className = 'status-badge badge-online';
            } else {
                badge.textContent = 'Ø¢ÙÙ„Ø§ÛŒÙ†';
                badge.className = 'status-badge badge-offline';
            }
        }

        function clearLogs() {
            const container = document.getElementById('logContainer');
            container.innerHTML = '<div class="log-entry log-info">ğŸ§¹ Ù„Ø§Ú¯ Ù¾Ø§Ú© Ø´Ø¯</div>';
            TestFramework.reset();
        }

        // ---------- ØªØ³Øªâ€ŒÙ‡Ø§ÛŒ Ù…Ø¯ÛŒØ±ÛŒØª ÙˆØ¶Ø¹ÛŒØª ----------
        function testGetCurrentStatus() {
            TestFramework.log('ğŸ“‹ Ø¨Ø±Ø±Ø³ÛŒ ÙˆØ¶Ø¹ÛŒØª ÙØ¹Ù„ÛŒ...', 'info');
            
            const status = offlineManager.getCurrentStatus();
            
            TestFramework.assertDefined(status, 'ÙˆØ¶Ø¹ÛŒØª ØªØ¹Ø±ÛŒÙ Ø´Ø¯Ù‡ Ø§Ø³Øª');
            TestFramework.assertDefined(status.isOnline, 'ÙˆØ¶Ø¹ÛŒØª Ø¢Ù†Ù„Ø§ÛŒÙ† ØªØ¹Ø±ÛŒÙ Ø´Ø¯Ù‡ Ø§Ø³Øª');
            TestFramework.assertDefined(status.autoSyncEnabled, 'ÙˆØ¶Ø¹ÛŒØª Ù‡Ù…Ú¯Ø§Ù…â€ŒØ³Ø§Ø²ÛŒ Ø®ÙˆØ¯Ú©Ø§Ø± ØªØ¹Ø±ÛŒÙ Ø´Ø¯Ù‡ Ø§Ø³Øª');
            TestFramework.assertDefined(status.pendingCount, 'ØªØ¹Ø¯Ø§Ø¯ Ø¹Ù…Ù„ÛŒØ§Øª Ø¯Ø± Ø§Ù†ØªØ¸Ø§Ø± ØªØ¹Ø±ÛŒÙ Ø´Ø¯Ù‡ Ø§Ø³Øª');
            
            TestFramework.log(`â„¹ï¸ ÙˆØ¶Ø¹ÛŒØª: Ø¢Ù†Ù„Ø§ÛŒÙ†=${status.isOnline}, Ø®ÙˆØ¯Ú©Ø§Ø±=${status.autoSyncEnabled}, Ø¯Ø± Ø§Ù†ØªØ¸Ø§Ø±=${status.pendingCount}`, 'info');
            
            updateNetworkBadge();
        }

        function simulateOnline() {
            if (offlineManager) {
                offlineManager.isOnline = true;
                offlineManager.notifyListeners('online');
                TestFramework.log('ğŸ“¶ Ø´Ø¨ÛŒÙ‡â€ŒØ³Ø§Ø²ÛŒ: Ø¢Ù†Ù„Ø§ÛŒÙ† Ø´Ø¯', 'success');
                updateNetworkBadge();
            }
        }

        function simulateOffline() {
            if (offlineManager) {
                offlineManager.isOnline = false;
                offlineManager.notifyListeners('offline');
                TestFramework.log('ğŸ“´ Ø´Ø¨ÛŒÙ‡â€ŒØ³Ø§Ø²ÛŒ: Ø¢ÙÙ„Ø§ÛŒÙ† Ø´Ø¯', 'warning');
                updateNetworkBadge();
            }
        }

        // ---------- ØªØ³Øªâ€ŒÙ‡Ø§ÛŒ Ø¹Ù…Ù„ÛŒØ§Øª Ø¢ÙÙ„Ø§ÛŒÙ† (Ø±ÙØ¹ Ø´Ø¯Ù‡) ----------
        function testAddOfflineOperationFixed(type, data) {
            TestFramework.log(`â• Ø§ÙØ²ÙˆØ¯Ù† Ø¹Ù…Ù„ÛŒØ§Øª Ø¢ÙÙ„Ø§ÛŒÙ†: ${type}`, 'info');
            
            const beforeCount = offlineManager.getQueueLength();
            
            // âœ… Ø§ÛŒÙ†Ø¨Ø§Ø± operation Ø±Ø§ Ø¯Ø±ÛŒØ§ÙØª Ù…ÛŒâ€ŒÚ©Ù†ÛŒÙ…
            const operation = offlineManager.addOfflineOperation(type, data);
            
            // âœ… ØªØ³Øªâ€ŒÙ‡Ø§ÛŒ Ø§ØµÙ„Ø§Ø­ Ø´Ø¯Ù‡ - operation ØªØ¹Ø±ÛŒÙ Ø´Ø¯Ù‡ Ø§Ø³Øª
            TestFramework.assertDefined(operation, 'Ø¹Ù…Ù„ÛŒØ§Øª Ø³Ø§Ø®ØªÙ‡ Ø´Ø¯');
            TestFramework.assertEqual(operation.type, type, `Ù†ÙˆØ¹ Ø¹Ù…Ù„ÛŒØ§Øª ØµØ­ÛŒØ­ Ø§Ø³Øª (${operation.type} === ${type})`);
            TestFramework.assertEqual(operation.status, 'pending', 'ÙˆØ¶Ø¹ÛŒØª Ø¹Ù…Ù„ÛŒØ§Øª pending Ø§Ø³Øª');
            
            const afterCount = offlineManager.getQueueLength();
            TestFramework.assertEqual(afterCount, beforeCount + 1, `ØªØ¹Ø¯Ø§Ø¯ Ø¹Ù…Ù„ÛŒØ§Øª Ø§ÙØ²Ø§ÛŒØ´ ÛŒØ§ÙØª (${afterCount} === ${beforeCount + 1})`);
            
            return operation;
        }

        function testGetPendingOperations() {
            TestFramework.log('ğŸ“‹ Ø¯Ø±ÛŒØ§ÙØª Ø¹Ù…Ù„ÛŒØ§Øª Ø¯Ø± Ø§Ù†ØªØ¸Ø§Ø±...', 'info');
            
            const pending = offlineManager.getPendingOperations();
            
            TestFramework.assertDefined(pending, 'Ù„ÛŒØ³Øª Ø¹Ù…Ù„ÛŒØ§Øª ØªØ¹Ø±ÛŒÙ Ø´Ø¯Ù‡ Ø§Ø³Øª');
            TestFramework.assert(Array.isArray(pending), 'Ù„ÛŒØ³Øª Ø¹Ù…Ù„ÛŒØ§Øª Ø¢Ø±Ø§ÛŒÙ‡ Ø§Ø³Øª');
            
            TestFramework.log(`â„¹ï¸ ØªØ¹Ø¯Ø§Ø¯ Ø¹Ù…Ù„ÛŒØ§Øª Ø¯Ø± Ø§Ù†ØªØ¸Ø§Ø±: ${pending.length}`, 'info');
            pending.forEach((op, index) => {
                TestFramework.log(`  ${index + 1}. ${op.type} (${op.status}) - ØªÙ„Ø§Ø´: ${op.retryCount}`, 'info');
            });
        }

        function testProcessPendingOperations() {
            TestFramework.log('âš™ Ù¾Ø±Ø¯Ø§Ø²Ø´ Ø¹Ù…Ù„ÛŒØ§Øª Ø¯Ø± Ø§Ù†ØªØ¸Ø§Ø±...', 'info');
            
            const beforePending = offlineManager.getPendingOperations().length;
            
            if (beforePending === 0) {
                TestFramework.log('âš  Ù‡ÛŒÚ† Ø¹Ù…Ù„ÛŒØ§ØªÛŒ Ø¯Ø± Ø§Ù†ØªØ¸Ø§Ø± Ù†ÛŒØ³Øª', 'warning');
                return;
            }
            
            if (!offlineManager.isOnline) {
                TestFramework.log('âš  Ø¢ÙÙ„Ø§ÛŒÙ† - Ù‡Ù…Ú¯Ø§Ù…â€ŒØ³Ø§Ø²ÛŒ Ù…Ù…Ú©Ù† Ù†ÛŒØ³Øª', 'warning');
                return;
            }
            
            offlineManager.processPendingOperations().then(result => {
                if (result) {
                    TestFramework.log(`ğŸ“Š Ù†ØªÛŒØ¬Ù‡: ${result.success} Ù…ÙˆÙÙ‚ØŒ ${result.fail} Ù†Ø§Ù…ÙˆÙÙ‚`, 'info');
                    
                    const afterPending = offlineManager.getPendingOperations().length;
                    TestFramework.assert(afterPending <= beforePending, 'ØªØ¹Ø¯Ø§Ø¯ Ø¹Ù…Ù„ÛŒØ§Øª Ø¯Ø± Ø§Ù†ØªØ¸Ø§Ø± Ú©Ø§Ù‡Ø´ ÛŒØ§ÙØª');
                }
            });
        }

        // ---------- ØªØ³Øªâ€ŒÙ‡Ø§ÛŒ Ù‡Ù…Ú¯Ø§Ù…â€ŒØ³Ø§Ø²ÛŒ Ø®ÙˆØ¯Ú©Ø§Ø± ----------
        function testEnableAutoSync() {
            TestFramework.log('âœ… ÙØ¹Ø§Ù„â€ŒØ³Ø§Ø²ÛŒ Ù‡Ù…Ú¯Ø§Ù…â€ŒØ³Ø§Ø²ÛŒ Ø®ÙˆØ¯Ú©Ø§Ø±...', 'info');
            
            offlineManager.enableAutoSync();
            
            TestFramework.assertTrue(offlineManager.autoSyncEnabled, 'Ù‡Ù…Ú¯Ø§Ù…â€ŒØ³Ø§Ø²ÛŒ Ø®ÙˆØ¯Ú©Ø§Ø± ÙØ¹Ø§Ù„ Ø´Ø¯');
        }

        function testDisableAutoSync() {
            TestFramework.log('âŒ ØºÛŒØ±ÙØ¹Ø§Ù„â€ŒØ³Ø§Ø²ÛŒ Ù‡Ù…Ú¯Ø§Ù…â€ŒØ³Ø§Ø²ÛŒ Ø®ÙˆØ¯Ú©Ø§Ø±...', 'info');
            
            offlineManager.disableAutoSync();
            
            TestFramework.assertFalse(offlineManager.autoSyncEnabled, 'Ù‡Ù…Ú¯Ø§Ù…â€ŒØ³Ø§Ø²ÛŒ Ø®ÙˆØ¯Ú©Ø§Ø± ØºÛŒØ±ÙØ¹Ø§Ù„ Ø´Ø¯');
        }

        function testTriggerSync() {
            TestFramework.log('ğŸ”„ Ø§Ø¬Ø±Ø§ÛŒ Ù‡Ù…Ú¯Ø§Ù…â€ŒØ³Ø§Ø²ÛŒ Ø¯Ø³ØªÛŒ...', 'info');
            
            if (!offlineManager.isOnline) {
                TestFramework.log('âš  Ø¢ÙÙ„Ø§ÛŒÙ† - Ù‡Ù…Ú¯Ø§Ù…â€ŒØ³Ø§Ø²ÛŒ Ù…Ù…Ú©Ù† Ù†ÛŒØ³Øª', 'warning');
                return;
            }
            
            offlineManager.processPendingOperations().then(result => {
                if (result) {
                    TestFramework.log(`âœ… Ù‡Ù…Ú¯Ø§Ù…â€ŒØ³Ø§Ø²ÛŒ Ø¯Ø³ØªÛŒ Ú©Ø§Ù…Ù„ Ø´Ø¯: ${result.success} Ù…ÙˆÙÙ‚`, 'success');
                }
            });
        }

        // ---------- ØªØ³Øªâ€ŒÙ‡Ø§ÛŒ Ù…Ø¯ÛŒØ±ÛŒØª Ø®Ø·Ø§ ----------
        function testSyncFailure() {
            TestFramework.log('ğŸ’¥ Ø´Ø¨ÛŒÙ‡â€ŒØ³Ø§Ø²ÛŒ Ø®Ø·Ø§ÛŒ Ù‡Ù…Ú¯Ø§Ù…â€ŒØ³Ø§Ø²ÛŒ...', 'info');
            
            // Ø§Ø¶Ø§ÙÙ‡ Ú©Ø±Ø¯Ù† ÛŒÚ© Ø¹Ù…Ù„ÛŒØ§Øª
            const op = offlineManager.addOfflineOperation('error_test', { shouldFail: true });
            
            // Ø´Ø¨ÛŒÙ‡â€ŒØ³Ø§Ø²ÛŒ Ø®Ø·Ø§
            op.retryCount = 3;
            offlineManager.db.updateOperationStatus(op.id, 'failed');
            
            TestFramework.assertEqual(op.status, 'failed', 'ÙˆØ¶Ø¹ÛŒØª Ø¹Ù…Ù„ÛŒØ§Øª Ø¨Ù‡ failed ØªØºÛŒÛŒØ± Ú©Ø±Ø¯');
            
            const stats = offlineManager.getStats();
            TestFramework.assert(stats.failed > 0, 'Ø¢Ù…Ø§Ø± Ø®Ø·Ø§ Ø¨Ù‡â€ŒØ±ÙˆØ² Ø´Ø¯');
        }

        function testRetryFailedOperations() {
            TestFramework.log('ğŸ”„ ØªÙ„Ø§Ø´ Ù…Ø¬Ø¯Ø¯ Ø¨Ø±Ø§ÛŒ Ø¹Ù…Ù„ÛŒØ§Øª Ù†Ø§Ù…ÙˆÙÙ‚...', 'info');
            
            const failed = offlineManager.db.operations.filter(o => o.status === 'failed');
            
            if (failed.length === 0) {
                TestFramework.log('âš  Ù‡ÛŒÚ† Ø¹Ù…Ù„ÛŒØ§Øª Ù†Ø§Ù…ÙˆÙÙ‚ÛŒ ÙˆØ¬ÙˆØ¯ Ù†Ø¯Ø§Ø±Ø¯', 'warning');
                return;
            }
            
            failed.forEach(op => {
                op.status = 'pending';
                op.retryCount = 0;
            });
            
            TestFramework.log(`âœ… ${failed.length} Ø¹Ù…Ù„ÛŒØ§Øª Ø¨Ø±Ø§ÛŒ ØªÙ„Ø§Ø´ Ù…Ø¬Ø¯Ø¯ Ø¢Ù…Ø§Ø¯Ù‡ Ø´Ø¯`, 'success');
            
            if (offlineManager.isOnline && offlineManager.autoSyncEnabled) {
                offlineManager.processPendingOperations();
            }
        }

        function testClearFailedOperations() {
            TestFramework.log('ğŸ—‘ Ù¾Ø§Ú© Ú©Ø±Ø¯Ù† Ø¹Ù…Ù„ÛŒØ§Øª Ù†Ø§Ù…ÙˆÙÙ‚...', 'info');
            
            const beforeCount = offlineManager.db.operations.length;
            const failedCount = offlineManager.db.operations.filter(o => o.status === 'failed').length;
            
            offlineManager.clearFailedOperations();
            
            const afterCount = offlineManager.db.operations.length;
            TestFramework.assertEqual(afterCount, beforeCount - failedCount, 'Ø¹Ù…Ù„ÛŒØ§Øª Ù†Ø§Ù…ÙˆÙÙ‚ Ù¾Ø§Ú© Ø´Ø¯Ù†Ø¯');
        }

        // ---------- ØªØ³Øªâ€ŒÙ‡Ø§ÛŒ Ø¢Ù…Ø§Ø± ----------
        function testGetStats() {
            TestFramework.log('ğŸ“ˆ Ø¯Ø±ÛŒØ§ÙØª Ø¢Ù…Ø§Ø±...', 'info');
            
            const stats = offlineManager.getStats();
            
            TestFramework.assertDefined(stats, 'Ø¢Ù…Ø§Ø± ØªØ¹Ø±ÛŒÙ Ø´Ø¯Ù‡ Ø§Ø³Øª');
            TestFramework.assertDefined(stats.total, 'ØªØ¹Ø¯Ø§Ø¯ Ú©Ù„ ØªØ¹Ø±ÛŒÙ Ø´Ø¯Ù‡ Ø§Ø³Øª');
            TestFramework.assertDefined(stats.pending, 'ØªØ¹Ø¯Ø§Ø¯ Ø¯Ø± Ø§Ù†ØªØ¸Ø§Ø± ØªØ¹Ø±ÛŒÙ Ø´Ø¯Ù‡ Ø§Ø³Øª');
            TestFramework.assertDefined(stats.completed, 'ØªØ¹Ø¯Ø§Ø¯ Ú©Ø§Ù…Ù„ Ø´Ø¯Ù‡ ØªØ¹Ø±ÛŒÙ Ø´Ø¯Ù‡ Ø§Ø³Øª');
            TestFramework.assertDefined(stats.failed, 'ØªØ¹Ø¯Ø§Ø¯ Ù†Ø§Ù…ÙˆÙÙ‚ ØªØ¹Ø±ÛŒÙ Ø´Ø¯Ù‡ Ø§Ø³Øª');
            
            TestFramework.log(`ğŸ“Š Ú©Ù„: ${stats.total} | Ø¯Ø± Ø§Ù†ØªØ¸Ø§Ø±: ${stats.pending} | Ú©Ø§Ù…Ù„: ${stats.completed} | Ù†Ø§Ù…ÙˆÙÙ‚: ${stats.failed}`, 'info');
        }

        function testGetQueueLength() {
            const length = offlineManager.getQueueLength();
            
            TestFramework.assert(length >= 0, 'Ø·ÙˆÙ„ ØµÙ Ù…Ø¹ØªØ¨Ø± Ø§Ø³Øª');
            TestFramework.log(`ğŸ§® Ø·ÙˆÙ„ ØµÙ Ø¹Ù…Ù„ÛŒØ§Øª: ${length}`, 'info');
        }

        // ---------- Ø³Ù†Ø§Ø±ÛŒÙˆÛŒ Ú©Ø§Ù…Ù„ ----------
        function testCompleteOfflineScenario() {
            TestFramework.log('ğŸ”„ Ø§Ø¬Ø±Ø§ÛŒ Ø³Ù†Ø§Ø±ÛŒÙˆÛŒ Ú©Ø§Ù…Ù„ Ø¢ÙÙ„Ø§ÛŒÙ†...', 'info');
            
            // 1. Ø´Ø¨ÛŒÙ‡â€ŒØ³Ø§Ø²ÛŒ Ø¢ÙÙ„Ø§ÛŒÙ†
            simulateOffline();
            
            // 2. Ø§ÙØ²ÙˆØ¯Ù† Ú†Ù†Ø¯ Ø¹Ù…Ù„ÛŒØ§Øª (Ø¨Ø§ Ù…ØªØ¯ Ø§ØµÙ„Ø§Ø­ Ø´Ø¯Ù‡)
            testAddOfflineOperationFixed('save_lesson', { id: 1, name: 'Ø¯Ø±Ø³ Û±' });
            testAddOfflineOperationFixed('save_progress', { lessonId: 1, score: 80 });
            testAddOfflineOperationFixed('save_achievement', { type: 'gold', name: 'Ø¯Ø³ØªØ§ÙˆØ±Ø¯ Ø·Ù„Ø§ÛŒÛŒ' });
            
            // 3. Ø¨Ø±Ø±Ø³ÛŒ ÙˆØ¶Ø¹ÛŒØª
            testGetPendingOperations();
            
            // 4. Ø´Ø¨ÛŒÙ‡â€ŒØ³Ø§Ø²ÛŒ Ø¢Ù†Ù„Ø§ÛŒÙ†
            simulateOnline();
            
            // 5. Ù¾Ø±Ø¯Ø§Ø²Ø´ Ø®ÙˆØ¯Ú©Ø§Ø±
            setTimeout(() => {
                testGetStats();
                testGetPendingOperations();
                TestFramework.log('âœ… Ø³Ù†Ø§Ø±ÛŒÙˆÛŒ Ø¢ÙÙ„Ø§ÛŒÙ† Ú©Ø§Ù…Ù„ Ø´Ø¯', 'success');
            }, 1500);
        }

        // ---------- Ø§Ø¬Ø±Ø§ÛŒ Ù‡Ù…Ù‡ ØªØ³Øªâ€ŒÙ‡Ø§ ----------
        function runAllTests() {
            TestFramework.reset();
            TestFramework.log('ğŸš€ Ø´Ø±ÙˆØ¹ Ø§Ø¬Ø±Ø§ÛŒ Ù‡Ù…Ù‡ ØªØ³Øªâ€ŒÙ‡Ø§...', 'info');
            
            // Ø±ÛŒØ³Øª Ú©Ø±Ø¯Ù† Ù…Ø­ÛŒØ·
            initTest();
            
            // ØªØ³Øªâ€ŒÙ‡Ø§ÛŒ Ù…Ø¯ÛŒØ±ÛŒØª ÙˆØ¶Ø¹ÛŒØª
            testGetCurrentStatus();
            
            // ØªØ³Øªâ€ŒÙ‡Ø§ÛŒ Ø¹Ù…Ù„ÛŒØ§Øª Ø¢ÙÙ„Ø§ÛŒÙ† (Ø±ÙØ¹ Ø´Ø¯Ù‡)
            testAddOfflineOperationFixed('test_type', { sample: 'data' });
            testAddOfflineOperationFixed('another_type', { value: 123 });
            testGetPendingOperations();
            
            // ØªØ³Øªâ€ŒÙ‡Ø§ÛŒ Ù‡Ù…Ú¯Ø§Ù…â€ŒØ³Ø§Ø²ÛŒ
            testEnableAutoSync();
            testDisableAutoSync();
            
            // ØªØ³Øªâ€ŒÙ‡Ø§ÛŒ Ø¢Ù…Ø§Ø±
            testGetStats();
            testGetQueueLength();
            
            // ØªØ³Øªâ€ŒÙ‡Ø§ÛŒ Ù…Ø¯ÛŒØ±ÛŒØª Ø®Ø·Ø§
            simulateOffline();
            testAddOfflineOperationFixed('offline_op', { id: 999 });
            simulateOnline();
            
            // Ø³Ù†Ø§Ø±ÛŒÙˆÛŒ Ú©Ø§Ù…Ù„
            setTimeout(() => {
                testCompleteOfflineScenario();
            }, 500);
            
            TestFramework.log('âœ… Ù‡Ù…Ù‡ ØªØ³Øªâ€ŒÙ‡Ø§ Ø§Ø¬Ø±Ø§ Ø´Ø¯Ù†Ø¯', 'success');
        }

        // Initialize
        initTest();
    </script>
</body>
</html>
