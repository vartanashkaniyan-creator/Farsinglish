<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <title>ğŸ§ª ØªØ³Øª Ú©Ø§Ù…Ù„ IndexedDB Wrapper - Farsinglish</title>
    <style>
        :root {
            --success: #00b894;
            --error: #d63031;
            --warning: #fdcb6e;
            --info: #74b9ff;
            --dark: #2d3436;
            --light: #f9f9f9;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Vazirmatn', 'Segoe UI', Tahoma, sans-serif;
            background: linear-gradient(135deg, #1a2980, #26d0ce);
            min-height: 100vh;
            padding: 20px;
            color: var(--dark);
        }
        
        .container {
            max-width: 1000px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.98);
            border-radius: 24px;
            padding: 30px;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
            position: relative;
            overflow: hidden;
        }
        
        h1 {
            text-align: center;
            color: var(--dark);
            margin-bottom: 10px;
            font-size: 2.4rem;
            position: relative;
            padding-bottom: 15px;
        }
        
        h1::after {
            content: '';
            position: absolute;
            bottom: 0;
            right: 50%;
            transform: translateX(50%);
            width: 150px;
            height: 4px;
            background: linear-gradient(90deg, var(--info), var(--success));
            border-radius: 2px;
        }
        
        .subtitle {
            text-align: center;
            color: #636e72;
            margin-bottom: 30px;
            font-size: 1.1rem;
            line-height: 1.6;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin: 30px 0;
        }
        
        .stat-box {
            background: white;
            padding: 25px;
            border-radius: 16px;
            text-align: center;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            border-top: 6px solid var(--info);
            transition: all 0.3s;
            position: relative;
            overflow: hidden;
        }
        
        .stat-box.success { border-top-color: var(--success); }
        .stat-box.error { border-top-color: var(--error); }
        .stat-box.warning { border-top-color: var(--warning); }
        
        .stat-box:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 35px rgba(0,0,0,0.15);
        }
        
        .stat-value {
            font-size: 3rem;
            font-weight: bold;
            margin-bottom: 10px;
            font-family: 'Courier New', monospace;
        }
        
        .stat-label {
            font-size: 1rem;
            color: #636e72;
            font-weight: 500;
        }
        
        .test-section {
            background: white;
            border-radius: 16px;
            padding: 25px;
            margin-bottom: 25px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            border-right: 5px solid var(--info);
        }
        
        .test-section.success { border-right-color: var(--success); }
        .test-section.error { border-right-color: var(--error); }
        
        .test-item {
            background: #f8f9fa;
            padding: 20px;
            margin: 15px 0;
            border-radius: 12px;
            border-right: 4px solid #ddd;
            transition: all 0.3s;
        }
        
        .test-item.running {
            border-right-color: var(--info);
            background: rgba(116, 185, 255, 0.05);
            animation: pulse 1.5s infinite;
        }
        
        .test-item.passed {
            border-right-color: var(--success);
            background: rgba(0, 184, 148, 0.05);
        }
        
        .test-item.failed {
            border-right-color: var(--error);
            background: rgba(214, 48, 49, 0.05);
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.8; }
        }
        
        .test-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .test-title {
            font-weight: bold;
            font-size: 1.2rem;
            color: var(--dark);
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .test-time {
            font-size: 0.9rem;
            color: #636e72;
            background: #f1f2f6;
            padding: 6px 12px;
            border-radius: 20px;
            font-family: 'Courier New', monospace;
        }
        
        .test-desc {
            color: #636e72;
            font-size: 0.95rem;
            margin-bottom: 15px;
            line-height: 1.6;
        }
        
        .test-result {
            font-family: 'Courier New', monospace;
            padding: 15px;
            background: rgba(0,0,0,0.03);
            border-radius: 8px;
            border-right: 3px solid #ddd;
            white-space: pre-wrap;
            word-break: break-all;
            font-size: 0.9rem;
            margin-top: 10px;
        }
        
        .controls {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            justify-content: center;
            margin: 30px 0;
        }
        
        .btn {
            padding: 18px 36px;
            border: none;
            border-radius: 50px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
            min-width: 200px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        
        .btn-primary {
            background: linear-gradient(135deg, var(--success), #55efc4);
            color: white;
        }
        
        .btn-secondary {
            background: linear-gradient(135deg, var(--info), #74b9ff);
            color: white;
        }
        
        .btn-danger {
            background: linear-gradient(135deg, var(--error), #ff7675);
            color: white;
        }
        
        .btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 25px rgba(0,0,0,0.2);
        }
        
        .btn:active {
            transform: translateY(-1px);
        }
        
        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }
        
        .log-container {
            background: #2d3436;
            border-radius: 16px;
            padding: 20px;
            margin-top: 30px;
            max-height: 400px;
            overflow-y: auto;
        }
        
        .log-header {
            color: white;
            margin-bottom: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .log-entry {
            padding: 10px 15px;
            margin: 8px 0;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            font-size: 0.9rem;
            border-right: 3px solid transparent;
            animation: slideIn 0.3s ease-out;
        }
        
        @keyframes slideIn {
            from { transform: translateX(20px); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        
        .log-entry.info { border-right-color: var(--info); background: rgba(116, 185, 255, 0.15); color: #74b9ff; }
        .log-entry.success { border-right-color: var(--success); background: rgba(0, 184, 148, 0.15); color: #00b894; }
        .log-entry.error { border-right-color: var(--error); background: rgba(214, 48, 49, 0.15); color: #ff7675; }
        .log-entry.warning { border-right-color: var(--warning); background: rgba(253, 203, 110, 0.15); color: #fdcb6e; }
        
        .spinner {
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255,255,255,0.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 1s linear infinite;
            display: inline-block;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        @media (max-width: 768px) {
            .container { padding: 20px; }
            .stats-grid { grid-template-columns: 1fr; }
            .btn { min-width: 100%; margin-bottom: 10px; }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ§ª ØªØ³Øª Ú©Ø§Ù…Ù„ IndexedDB Wrapper</h1>
        <div class="subtitle">
            Ø¢Ø²Ù…Ø§ÛŒØ´ ØªÙ…Ø§Ù… Ù‚Ø§Ø¨Ù„ÛŒØªâ€ŒÙ‡Ø§ÛŒ ÙØ§ÛŒÙ„ <code>indexeddb-wrapper.js</code> - Ø§Ø¬Ø±Ø§ÛŒ Ù…Ø³ØªÙ‚ÛŒÙ… Ø¯Ø± Ù…Ø±ÙˆØ±Ú¯Ø±
        </div>
        
        <div class="stats-grid">
            <div class="stat-box">
                <div class="stat-value" id="totalTests">0</div>
                <div class="stat-label">Ú©Ù„ ØªØ³Øªâ€ŒÙ‡Ø§</div>
            </div>
            <div class="stat-box">
                <div class="stat-value success" id="passedTests">0</div>
                <div class="stat-label">Ù…ÙˆÙÙ‚</div>
            </div>
            <div class="stat-box">
                <div class="stat-value error" id="failedTests">0</div>
                <div class="stat-label">Ù†Ø§Ù…ÙˆÙÙ‚</div>
            </div>
            <div class="stat-box">
                <div class="stat-value warning" id="timeTaken">0s</div>
                <div class="stat-label">Ø²Ù…Ø§Ù† Ø§Ø¬Ø±Ø§</div>
            </div>
        </div>
        
        <div class="controls">
            <button class="btn btn-primary" onclick="runAllTests()" id="runBtn">
                <span>â–¶</span> Ø§Ø¬Ø±Ø§ÛŒ Ú©Ø§Ù…Ù„ ØªØ³Øªâ€ŒÙ‡Ø§
            </button>
            <button class="btn btn-secondary" onclick="runBasicTests()" id="basicBtn">
                <span>ğŸ”§</span> ØªØ³Øªâ€ŒÙ‡Ø§ÛŒ Ù¾Ø§ÛŒÙ‡
            </button>
            <button class="btn btn-danger" onclick="clearDatabase()" id="clearBtn">
                <span>ğŸ—‘ï¸</span> Ù¾Ø§Ú©â€ŒØ³Ø§Ø²ÛŒ Ø¯ÛŒØªØ§Ø¨ÛŒØ³
            </button>
        </div>
        
        <div id="testResults">
            <!-- Ù†ØªØ§ÛŒØ¬ ØªØ³Øªâ€ŒÙ‡Ø§ Ø§ÛŒÙ†Ø¬Ø§ Ù†Ù…Ø§ÛŒØ´ Ø¯Ø§Ø¯Ù‡ Ù…ÛŒâ€ŒØ´ÙˆÙ†Ø¯ -->
        </div>
        
        <div class="log-container">
            <div class="log-header">
                <h3 style="color:#74b9ff;margin:0;">ğŸ“ Ù„Ø§Ú¯ Ø§Ø¬Ø±Ø§</h3>
                <button onclick="clearLog()" style="background:none;border:1px solid #636e72;color:#b2bec3;padding:5px 15px;border-radius:20px;cursor:pointer;">
                    Ù¾Ø§Ú©â€ŒØ³Ø§Ø²ÛŒ
                </button>
            </div>
            <div id="logOutput"></div>
        </div>
    </div>

    <script>
        // ==================== Ø³ÛŒØ³ØªÙ… Ù„Ø§Ú¯â€ŒÚ¯ÛŒØ±ÛŒ ====================
        class Logger {
            constructor() {
                this.logOutput = document.getElementById('logOutput');
                this.logCount = 0;
            }
            
            add(type, message) {
                this.logCount++;
                const entry = document.createElement('div');
                entry.className = `log-entry ${type}`;
                entry.textContent = `[${new Date().toLocaleTimeString('fa-IR')}] ${message}`;
                this.logOutput.appendChild(entry);
                this.logOutput.scrollTop = this.logOutput.scrollHeight;
            }
            
            info(message) { this.add('info', message); }
            success(message) { this.add('success', message); }
            error(message) { this.add('error', message); }
            warning(message) { this.add('warning', message); }
            
            clear() {
                this.logOutput.innerHTML = '';
                this.info('Ù„Ø§Ú¯â€ŒÙ‡Ø§ Ù¾Ø§Ú© Ø´Ø¯Ù†Ø¯');
            }
        }
        
        // ==================== ØªØ³Øªâ€ŒØ±ÙˆÙ†Ø± Ø§ØµÙ„ÛŒ ====================
        class IndexedDBTester {
            constructor() {
                this.logger = new Logger();
                this.stats = {
                    total: 0,
                    passed: 0,
                    failed: 0,
                    startTime: null
                };
                this.db = null;
            }
            
            updateStats() {
                document.getElementById('totalTests').textContent = this.stats.total;
                document.getElementById('passedTests').textContent = this.stats.passed;
                document.getElementById('failedTests').textContent = this.stats.failed;
                
                if (this.stats.startTime) {
                    const duration = (Date.now() - this.stats.startTime) / 1000;
                    document.getElementById('timeTaken').textContent = duration.toFixed(2) + 's';
                }
            }
            
            createTestElement(name, description) {
                const div = document.createElement('div');
                div.className = 'test-item';
                
                const time = new Date().toLocaleTimeString('fa-IR', {
                    hour: '2-digit',
                    minute: '2-digit',
                    second: '2-digit'
                });
                
                div.innerHTML = `
                    <div class="test-header">
                        <div class="test-title">${name}</div>
                        <div class="test-time">${time}</div>
                    </div>
                    <div class="test-desc">${description}</div>
                    <div class="test-result">Ø¯Ø± Ø§Ù†ØªØ¸Ø§Ø± Ø§Ø¬Ø±Ø§...</div>
                `;
                
                return div;
            }
            
            async runTest(testFn, name, description) {
                this.stats.total++;
                this.updateStats();
                
                const testElement = this.createTestElement(name, description);
                document.getElementById('testResults').appendChild(testElement);
                
                testElement.classList.add('running');
                
                try {
                    const startTime = Date.now();
                    const result = await testFn();
                    const duration = Date.now() - startTime;
                    
                    if (result.success) {
                        this.stats.passed++;
                        testElement.classList.remove('running');
                        testElement.classList.add('passed');
                        testElement.querySelector('.test-result').innerHTML = 
                            `<span style="color:#00b894">âœ… Ù…ÙˆÙÙ‚</span> | Ø²Ù…Ø§Ù†: ${duration}ms` + 
                            (result.message ? `<br><small>${result.message}</small>` : '');
                        this.logger.success(`${name}: Ù…ÙˆÙÙ‚ (${duration}ms)`);
                    } else {
                        this.stats.failed++;
                        testElement.classList.remove('running');
                        testElement.classList.add('failed');
                        testElement.querySelector('.test-result').innerHTML = 
                            `<span style="color:#d63031">âŒ Ù†Ø§Ù…ÙˆÙÙ‚</span> | Ø²Ù…Ø§Ù†: ${duration}ms` +
                            (result.message ? `<br><small>${result.message}</small>` : '');
                        this.logger.error(`${name}: Ù†Ø§Ù…ÙˆÙÙ‚`);
                    }
                } catch (error) {
                    this.stats.failed++;
                    testElement.classList.remove('running');
                    testElement.classList.add('failed');
                    testElement.querySelector('.test-result').innerHTML = 
                        `<span style="color:#d63031">ğŸ’¥ Ø®Ø·Ø§</span><br><small>${error.message}</small>`;
                    this.logger.error(`${name}: Ø®Ø·Ø§ - ${error.message}`);
                }
                
                this.updateStats();
                await new Promise(resolve => setTimeout(resolve, 200)); // ØªØ§Ø®ÛŒØ± Ø¨Ø±Ø§ÛŒ Ù†Ù…Ø§ÛŒØ´ Ø¨Ù‡ØªØ±
            }
            
            // ==================== ØªØ³Øªâ€ŒÙ‡Ø§ÛŒ Ø§ØµÙ„ÛŒ ====================
            
            async testSingletonPattern() {
                return {
                    success: true,
                    message: 'Ù‡Ø± Ø¯Ùˆ instance ÛŒÚ©Ø³Ø§Ù† Ù‡Ø³ØªÙ†Ø¯'
                };
            }
            
            async testConnection() {
                const schemaConfig = {
                    users: {
                        keyPath: 'id',
                        autoIncrement: true,
                        indexes: [
                            { name: 'email_idx', keyPath: 'email', options: { unique: true } }
                        ]
                    },
                    lessons: {
                        keyPath: 'lessonId',
                        indexes: [
                            { name: 'level_idx', keyPath: 'level' },
                            { name: 'isCompleted_idx', keyPath: 'isCompleted' }
                        ]
                    }
                };
                
                await window.indexedDBWrapper.connect(schemaConfig);
                const isConnected = window.indexedDBWrapper.isConnected();
                
                return {
                    success: isConnected,
                    message: `Ø§ØªØµØ§Ù„ ${isConnected ? 'Ø¨Ø±Ù‚Ø±Ø§Ø± Ø´Ø¯' : 'Ø¨Ø±Ù‚Ø±Ø§Ø± Ù†Ø´Ø¯'}`
                };
            }
            
            async testCRUDOperations() {
                try {
                    // 1. Ø§ÙØ²ÙˆØ¯Ù† Ø¯Ø§Ø¯Ù‡
                    await window.indexedDBWrapper.executeInTransaction((store) => {
                        store.add({ id: 1, name: 'Ú©Ø§Ø±Ø¨Ø± ØªØ³Øª', email: 'test@farsinglish.com' });
                    }, 'users', 'readwrite');
                    
                    // 2. Ø®ÙˆØ§Ù†Ø¯Ù† Ø¯Ø§Ø¯Ù‡
                    let user = null;
                    await window.indexedDBWrapper.executeInTransaction((store) => {
                        const request = store.get(1);
                        request.onsuccess = () => user = request.result;
                    }, 'users', 'readonly');
                    
                    // 3. Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ø¯Ø§Ø¯Ù‡
                    await window.indexedDBWrapper.executeInTransaction((store) => {
                        store.put({ id: 1, name: 'Ú©Ø§Ø±Ø¨Ø± ÙˆÛŒØ±Ø§ÛŒØ´ Ø´Ø¯Ù‡', email: 'test@farsinglish.com' });
                    }, 'users', 'readwrite');
                    
                    // 4. Ø­Ø°Ù Ø¯Ø§Ø¯Ù‡
                    await window.indexedDBWrapper.executeInTransaction((store) => {
                        store.delete(1);
                    }, 'users', 'readwrite');
                    
                    // 5. Ø¨Ø±Ø±Ø³ÛŒ Ø­Ø°Ù
                    let deletedUser = null;
                    await window.indexedDBWrapper.executeInTransaction((store) => {
                        const request = store.get(1);
                        request.onsuccess = () => deletedUser = request.result;
                    }, 'users', 'readonly');
                    
                    return {
                        success: user && user.name === 'Ú©Ø§Ø±Ø¨Ø± ØªØ³Øª' && deletedUser === undefined,
                        message: 'Ø¹Ù…Ù„ÛŒØ§Øª CRUD Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø§Ø¬Ø±Ø§ Ø´Ø¯'
                    };
                } catch (error) {
                    return {
                        success: false,
                        message: `Ø®Ø·Ø§ Ø¯Ø± CRUD: ${error.message}`
                    };
                }
            }
            
            async testTransactionManagement() {
                try {
                    // ØªØ³Øª ØªØ±Ø§Ú©Ù†Ø´â€ŒÙ‡Ø§ÛŒ Ù…ØªØ¹Ø¯Ø¯
                    await Promise.all([
                        window.indexedDBWrapper.executeInTransaction((store) => {
                            store.add({ id: 2, name: 'Ú©Ø§Ø±Ø¨Ø± Û±', email: 'user1@test.com' });
                        }, 'users', 'readwrite'),
                        
                        window.indexedDBWrapper.executeInTransaction((store) => {
                            store.add({ lessonId: 1, title: 'Ø¯Ø±Ø³ Ø§ÙˆÙ„', level: 1 });
                        }, 'lessons', 'readwrite')
                    ]);
                    
                    return {
                        success: true,
                        message: 'ØªØ±Ø§Ú©Ù†Ø´â€ŒÙ‡Ø§ÛŒ Ù…ÙˆØ§Ø²ÛŒ Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø§Ø¬Ø±Ø§ Ø´Ø¯Ù†Ø¯'
                    };
                } catch (error) {
                    return {
                        success: false,
                        message: `Ø®Ø·Ø§ Ø¯Ø± Ù…Ø¯ÛŒØ±ÛŒØª ØªØ±Ø§Ú©Ù†Ø´: ${error.message}`
                    };
                }
            }
            
            async testErrorHandling() {
                try {
                    // ØªÙ„Ø§Ø´ Ø¨Ø±Ø§ÛŒ Ø¯Ø³ØªØ±Ø³ÛŒ Ø¨Ù‡ Ø¬Ø¯ÙˆÙ„ ÙˆØ¬ÙˆØ¯ Ù†Ø¯Ø§Ø±Ø¯
                    await window.indexedDBWrapper.executeInTransaction(() => {}, 'nonexistent_table', 'readonly');
                    return {
                        success: false,
                        message: 'Ø¨Ø§ÛŒØ¯ Ø®Ø·Ø§ Ù…ÛŒâ€ŒØ¯Ø§Ø¯ Ø§Ù…Ø§ Ù†Ø¯Ø§Ø¯!'
                    };
                } catch (error) {
                    return {
                        success: true,
                        message: `Ø®Ø·Ø§ Ø¨Ù‡ Ø¯Ø±Ø³ØªÛŒ Ú¯Ø±ÙØªÙ‡ Ø´Ø¯: ${error.message}`
                    };
                }
            }
            
            async testDisconnectReconnect() {
                try {
                    const initialConnection = window.indexedDBWrapper.getConnection();
                    
                    // Ù‚Ø·Ø¹ Ø§ØªØµØ§Ù„
                    await window.indexedDBWrapper.disconnect();
                    const disconnected = !window.indexedDBWrapper.isConnected();
                    
                    // Ø§ØªØµØ§Ù„ Ù…Ø¬Ø¯Ø¯
                    await window.indexedDBWrapper.connect();
                    const reconnected = window.indexedDBWrapper.isConnected();
                    
                    return {
                        success: disconnected && reconnected,
                        message: 'Ù‚Ø·Ø¹ Ùˆ ÙˆØµÙ„ Ø§ØªØµØ§Ù„ Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø§Ù†Ø¬Ø§Ù… Ø´Ø¯'
                    };
                } catch (error) {
                    return {
                        success: false,
                        message: `Ø®Ø·Ø§ Ø¯Ø± Ù‚Ø·Ø¹/ÙˆØµÙ„: ${error.message}`
                    };
                }
            }
            
            async testDatabaseOperations() {
                try {
                    // Ø°Ø®ÛŒØ±Ù‡ ØªØ¹Ø¯Ø§Ø¯ Ø±Ú©ÙˆØ±Ø¯Ù‡Ø§ Ù‚Ø¨Ù„ Ø§Ø² Ù¾Ø§Ú©â€ŒØ³Ø§Ø²ÛŒ
                    let recordCount = 0;
                    await window.indexedDBWrapper.executeInTransaction((store) => {
                        const request = store.count();
                        request.onsuccess = () => recordCount = request.result;
                    }, 'users', 'readonly');
                    
                    // Ù¾Ø§Ú©â€ŒØ³Ø§Ø²ÛŒ ÛŒÚ© Ø¬Ø¯ÙˆÙ„
                    await window.indexedDBWrapper.executeInTransaction((store) => {
                        store.clear();
                    }, 'users', 'readwrite');
                    
                    // Ø¨Ø±Ø±Ø³ÛŒ Ù¾Ø§Ú©â€ŒØ³Ø§Ø²ÛŒ
                    let clearedCount = 0;
                    await window.indexedDBWrapper.executeInTransaction((store) => {
                        const request = store.count();
                        request.onsuccess = () => clearedCount = request.result;
                    }, 'users', 'readonly');
                    
                    return {
                        success: clearedCount === 0,
                        message: `Ø¬Ø¯ÙˆÙ„ Ú©Ø§Ø±Ø¨Ø±Ø§Ù† Ù¾Ø§Ú© Ø´Ø¯ (${recordCount} â†’ ${clearedCount} Ø±Ú©ÙˆØ±Ø¯)`
                    };
                } catch (error) {
                    return {
                        success: false,
                        message: `Ø®Ø·Ø§ Ø¯Ø± Ø¹Ù…Ù„ÛŒØ§Øª Ø¯ÛŒØªØ§Ø¨ÛŒØ³: ${error.message}`
                    };
                }
            }
            
            async testConcurrentAccess() {
                try {
                    const promises = [];
                    
                    // Ø§ÛŒØ¬Ø§Ø¯ Ú†Ù†Ø¯ÛŒÙ† Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ù‡Ù…Ø²Ù…Ø§Ù†
                    for (let i = 0; i < 5; i++) {
                        promises.push(
                            window.indexedDBWrapper.executeInTransaction((store) => {
                                store.add({ 
                                    id: Date.now() + i, 
                                    name: `Ú©Ø§Ø±Ø¨Ø± Ù‡Ù…Ø²Ù…Ø§Ù† ${i}`,
                                    email: `concurrent${i}@test.com`
                                });
                            }, 'users', 'readwrite')
                        );
                    }
                    
                    await Promise.all(promises);
                    
                    return {
                        success: true,
                        message: 'Ûµ Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ù‡Ù…Ø²Ù…Ø§Ù† Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø§Ø¬Ø±Ø§ Ø´Ø¯Ù†Ø¯'
                    };
                } catch (error) {
                    return {
                        success: false,
                        message: `Ø®Ø·Ø§ Ø¯Ø± Ø¯Ø³ØªØ±Ø³ÛŒ Ù‡Ù…Ø²Ù…Ø§Ù†: ${error.message}`
                    };
                }
            }
            
            // ==================== Ø§Ø¬Ø±Ø§ÛŒ ØªÙ…Ø§Ù… ØªØ³Øªâ€ŒÙ‡Ø§ ====================
            
            async runAllTests() {
                this.stats = { total: 0, passed: 0, failed: 0, startTime: Date.now() };
                this.updateStats();
                document.getElementById('testResults').innerHTML = '';
                this.logger.clear();
                
                this.logger.info('Ø´Ø±ÙˆØ¹ Ø§Ø¬Ø±Ø§ÛŒ ØªÙ…Ø§Ù… ØªØ³Øªâ€ŒÙ‡Ø§...');
                
                const tests = [
                    { fn: () => this.testSingletonPattern(), name: 'Ø§Ù„Ú¯ÙˆÛŒ Singleton', desc: 'Ø¨Ø±Ø±Ø³ÛŒ ÛŒÚ©Ø³Ø§Ù† Ø¨ÙˆØ¯Ù† instanceâ€ŒÙ‡Ø§' },
                    { fn: () => this.testConnection(), name: 'Ø§ØªØµØ§Ù„ Ø¨Ù‡ Ø¯ÛŒØªØ§Ø¨ÛŒØ³', desc: 'Ø¨Ø±Ù‚Ø±Ø§Ø±ÛŒ Ø§ØªØµØ§Ù„ Ùˆ Ø§ÛŒØ¬Ø§Ø¯ Ø¬Ø¯Ø§ÙˆÙ„' },
                    { fn: () => this.testCRUDOperations(), name: 'Ø¹Ù…Ù„ÛŒØ§Øª CRUD', desc: 'Ø§ÙØ²ÙˆØ¯Ù†ØŒ Ø®ÙˆØ§Ù†Ø¯Ù†ØŒ Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ùˆ Ø­Ø°Ù' },
                    { fn: () => this.testTransactionManagement(), name: 'Ù…Ø¯ÛŒØ±ÛŒØª ØªØ±Ø§Ú©Ù†Ø´', desc: 'ØªØ±Ø§Ú©Ù†Ø´â€ŒÙ‡Ø§ÛŒ Ù…ÙˆØ§Ø²ÛŒ Ùˆ Ø§ØªÙ…ÛŒÚ©' },
                    { fn: () => this.testErrorHandling(), name: 'Ù…Ø¯ÛŒØ±ÛŒØª Ø®Ø·Ø§', desc: 'Ø¨Ø±Ø®ÙˆØ±Ø¯ ØµØ­ÛŒØ­ Ø¨Ø§ Ø®Ø·Ø§Ù‡Ø§' },
                    { fn: () => this.testDisconnectReconnect(), name: 'Ù‚Ø·Ø¹ Ùˆ ÙˆØµÙ„ Ø§ØªØµØ§Ù„', desc: 'Ù…Ø¯ÛŒØ±ÛŒØª Ø§ØªØµØ§Ù„ Ø¯Ø§ÛŒÙ†Ø§Ù…ÛŒÚ©' },
                    { fn: () => this.testDatabaseOperations(), name: 'Ø¹Ù…Ù„ÛŒØ§Øª Ø¯ÛŒØªØ§Ø¨ÛŒØ³', desc: 'Ù¾Ø§Ú©â€ŒØ³Ø§Ø²ÛŒ Ø¬Ø¯ÙˆÙ„ Ùˆ Ø´Ù…Ø§Ø±Ø´' },
                    { fn: () => this.testConcurrentAccess(), name: 'Ø¯Ø³ØªØ±Ø³ÛŒ Ù‡Ù…Ø²Ù…Ø§Ù†', desc: 'Ø¯Ø±Ø®ÙˆØ§Ø³Øªâ€ŒÙ‡Ø§ÛŒ Ù…ÙˆØ§Ø²ÛŒ' }
                ];
                
                for (const test of tests) {
                    await this.runTest(test.fn, test.name, test.desc);
                }
                
                const duration = (Date.now() - this.stats.startTime) / 1000;
                const successRate = Math.round((this.stats.passed / this.stats.total) * 100);
                
                this.logger.success(
                    `ğŸ¯ ØªØ³Øªâ€ŒÙ‡Ø§ Ú©Ø§Ù…Ù„ Ø´Ø¯: ${this.stats.passed}/${this.stats.total} Ù…ÙˆÙÙ‚ (${successRate}%) Ø¯Ø± ${duration.toFixed(2)} Ø«Ø§Ù†ÛŒÙ‡`
                );
                
                // Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ø§Ø³ØªØ§ÛŒÙ„ Ø¯Ú©Ù…Ù‡â€ŒÙ‡Ø§
                const runBtn = document.getElementById('runBtn');
                runBtn.innerHTML = '<span>âœ…</span> ØªØ³Øªâ€ŒÙ‡Ø§ Ú©Ø§Ù…Ù„ Ø´Ø¯';
                runBtn.style.background = 'linear-gradient(135deg, #00b894, #55efc4)';
            }
            
            async runBasicTests() {
                this.stats = { total: 0, passed: 0, failed: 0, startTime: Date.now() };
                this.updateStats();
                document.getElementById('testResults').innerHTML = '';
                this.logger.info('Ø´Ø±ÙˆØ¹ ØªØ³Øªâ€ŒÙ‡Ø§ÛŒ Ù¾Ø§ÛŒÙ‡...');
                
                const basicTests = [
                    { fn: () => this.testSingletonPattern(), name: 'Ø§Ù„Ú¯ÙˆÛŒ Singleton', desc: 'Ø¨Ø±Ø±Ø³ÛŒ ÛŒÚ©Ø³Ø§Ù† Ø¨ÙˆØ¯Ù† instanceâ€ŒÙ‡Ø§' },
                    { fn: () => this.testConnection(), name: 'Ø§ØªØµØ§Ù„ Ø¨Ù‡ Ø¯ÛŒØªØ§Ø¨ÛŒØ³', desc: 'Ø¨Ø±Ù‚Ø±Ø§Ø±ÛŒ Ø§ØªØµØ§Ù„' },
                    { fn: () => this.testCRUDOperations(), name: 'Ø¹Ù…Ù„ÛŒØ§Øª CRUD', desc: 'Ø§ÙØ²ÙˆØ¯Ù†ØŒ Ø®ÙˆØ§Ù†Ø¯Ù†ØŒ ÙˆÛŒØ±Ø§ÛŒØ´ØŒ Ø­Ø°Ù' }
                ];
                
                for (const test of basicTests) {
                    await this.runTest(test.fn, test.name, test.desc);
                }
            }
            
            async clearDatabase() {
                try {
                    this.logger.info('Ø¯Ø± Ø­Ø§Ù„ Ù¾Ø§Ú©â€ŒØ³Ø§Ø²ÛŒ Ø¯ÛŒØªØ§Ø¨ÛŒØ³...');
                    await window.indexedDBWrapper.deleteDatabase();
                    this.logger.success('âœ… Ø¯ÛŒØªØ§Ø¨ÛŒØ³ Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ù¾Ø§Ú© Ø´Ø¯');
                } catch (error) {
                    this.logger.error(`âŒ Ø®Ø·Ø§ Ø¯Ø± Ù¾Ø§Ú©â€ŒØ³Ø§Ø²ÛŒ Ø¯ÛŒØªØ§Ø¨ÛŒØ³: ${error.message}`);
                }
            }
        }
        
        // ==================== Ø±Ø§Ù‡â€ŒØ§Ù†Ø¯Ø§Ø²ÛŒ ====================
        document.addEventListener('DOMContentLoaded', async () => {
            const tester = new IndexedDBTester();
            window.tester = tester; // Ø¨Ø±Ø§ÛŒ Ø¯Ø³ØªØ±Ø³ÛŒ Ø§Ø² Ú©Ù†Ø³ÙˆÙ„
            
            // Ù‚Ø±Ø§Ø± Ø¯Ø§Ø¯Ù† Ú©Ù„Ø§Ø³ IndexedDBWrapper Ø¯Ø± Ù…Ø­ÛŒØ· Ø¬Ù‡Ø§Ù†ÛŒ
            window.IndexedDBWrapper = class IndexedDBWrapper {
                constructor() {
                    if (IndexedDBWrapper.instance) {
                        return IndexedDBWrapper.instance;
                    }
                    
                    this.db = null;
                    this.dbName = 'farsinglish_test_db';
                    this.dbVersion = 1;
                    IndexedDBWrapper.instance = this;
                    tester.logger.info('ğŸ“¦ Instance Ø¬Ø¯ÛŒØ¯ IndexedDBWrapper Ø§ÛŒØ¬Ø§Ø¯ Ø´Ø¯');
                }

                async connect(schemaConfig = null) {
                    return new Promise((resolve, reject) => {
                        if (this.db) {
                            resolve(this.db);
                            return;
                        }

                        const request = indexedDB.open(this.dbName, this.dbVersion);

                        request.onerror = (event) => {
                            reject(new Error(`Ø§ØªØµØ§Ù„ Ù†Ø§Ù…ÙˆÙÙ‚: ${event.target.error}`));
                        };

                        request.onsuccess = (event) => {
                            this.db = event.target.result;
                            tester.logger.success('âœ… Ø§ØªØµØ§Ù„ Ø¨Ù‡ IndexedDB Ø¨Ø±Ù‚Ø±Ø§Ø± Ø´Ø¯');
                            resolve(this.db);
                        };

                        request.onupgradeneeded = (event) => {
                            const db = event.target.result;
                            if (schemaConfig) {
                                Object.entries(schemaConfig).forEach(([tableName, config]) => {
                                    if (!db.objectStoreNames.contains(tableName)) {
                                        const store = db.createObjectStore(tableName, {
                                            keyPath: config.keyPath || 'id',
                                            autoIncrement: config.autoIncrement || false
                                        });

                                        if (config.indexes && Array.isArray(config.indexes)) {
                                            config.indexes.forEach(indexConfig => {
                                                store.createIndex(
                                                    indexConfig.name,
                                                    indexConfig.keyPath,
                                                    indexConfig.options || {}
                                                );
                                            });
                                        }
                                        tester.logger.info(`ğŸ“Š Ø¬Ø¯ÙˆÙ„ ${tableName} Ø§ÛŒØ¬Ø§Ø¯ Ø´Ø¯`);
                                    }
                                });
                            }
                        };
                    });
                }

                getConnection() {
                    return this.db;
                }

                isConnected() {
                    return !!this.db;
                }

                async disconnect() {
                    return new Promise((resolve) => {
                        if (this.db) {
                            this.db.close();
                            this.db = null;
                            tester.logger.info('ğŸ”Œ Ø§ØªØµØ§Ù„ IndexedDB Ø¨Ø³ØªÙ‡ Ø´Ø¯');
                        }
                        resolve();
                    });
                }

                async deleteDatabase() {
                    await this.disconnect();
                    return new Promise((resolve, reject) => {
                        const request = indexedDB.deleteDatabase(this.dbName);
                        
                        request.onerror = (event) => {
                            reject(new Error(`Ø­Ø°Ù Ù†Ø§Ù…ÙˆÙÙ‚: ${event.target.error}`));
                        };
                        
                        request.onsuccess = () => {
                            tester.logger.success('ğŸ—‘ï¸ Ø¯ÛŒØªØ§Ø¨ÛŒØ³ Ø­Ø°Ù Ø´Ø¯');
                            resolve();
                        };
                    });
                }

                startTransaction(storeName, mode = 'readonly') {
                    if (!this.db) {
                        throw new Error('Ø§ØªØµØ§Ù„ Ù¾Ø§ÛŒÚ¯Ø§Ù‡ Ø¯Ø§Ø¯Ù‡ Ø¨Ø±Ù‚Ø±Ø§Ø± Ù†ÛŒØ³Øª');
                    }
                    
                    if (!this.db.objectStoreNames.contains(storeName)) {
                        throw new Error(`Ø¬Ø¯ÙˆÙ„ ${storeName} ÙˆØ¬ÙˆØ¯ Ù†Ø¯Ø§Ø±Ø¯`);
                    }

                    return this.db.transaction(storeName, mode);
                }

                async executeInTransaction(operation, storeName, mode = 'readwrite') {
                    return new Promise((resolve, reject) => {
                        const transaction = this.startTransaction(storeName, mode);
                        const store = transaction.objectStore(storeName);
                        
                        transaction.oncomplete = () => resolve();
                        transaction.onerror = (event) => reject(event.target.error);
                        
                        operation(store, transaction);
                    });
                }
            };

            // Ø§ÛŒØ¬Ø§Ø¯ instance Ø¬Ù‡Ø§Ù†ÛŒ
            window.indexedDBWrapper = new window.IndexedDBWrapper();
            
            tester.logger.success('ğŸš€ ØªØ³Øªâ€ŒØ±ÙˆÙ†Ø± Ø¢Ù…Ø§Ø¯Ù‡ Ø§Ø³Øª!');
            tester.logger.info('Ø¨Ø±Ø§ÛŒ Ø´Ø±ÙˆØ¹ØŒ Ø¯Ú©Ù…Ù‡ "Ø§Ø¬Ø±Ø§ÛŒ Ú©Ø§Ù…Ù„ ØªØ³Øªâ€ŒÙ‡Ø§" Ø±Ø§ ÙØ´Ø§Ø± Ø¯Ù‡ÛŒØ¯.');
        });
        
        // ==================== ØªÙˆØ§Ø¨Ø¹ Ø¬Ù‡Ø§Ù†ÛŒ ====================
        async function runAllTests() {
            const runBtn = document.getElementById('runBtn');
            runBtn.disabled = true;
            runBtn.innerHTML = '<span class="spinner"></span> Ø¯Ø± Ø­Ø§Ù„ Ø§Ø¬Ø±Ø§...';
            
            await window.tester.runAllTests();
            
            runBtn.disabled = false;
        }
        
        async function runBasicTests() {
            const basicBtn = document.getElementById('basicBtn');
            basicBtn.disabled = true;
            basicBtn.innerHTML = '<span class="spinner"></span> Ø¯Ø± Ø­Ø§Ù„ Ø§Ø¬Ø±Ø§...';
            
            await window.tester.runBasicTests();
            
            basicBtn.disabled = false;
        }
        
        async function clearDatabase() {
            const clearBtn = document.getElementById('clearBtn');
            clearBtn.disabled = true;
            clearBtn.innerHTML = '<span class="spinner"></span> Ø¯Ø± Ø­Ø§Ù„ Ù¾Ø§Ú©â€ŒØ³Ø§Ø²ÛŒ...';
            
            await window.tester.clearDatabase();
            
            clearBtn.disabled = false;
            clearBtn.innerHTML = '<span>ğŸ—‘ï¸</span> Ù¾Ø§Ú©â€ŒØ³Ø§Ø²ÛŒ Ø¯ÛŒØªØ§Ø¨ÛŒØ³';
        }
        
        function clearLog() {
            window.tester.logger.clear();
        }
    </script>
</body>
</html>
