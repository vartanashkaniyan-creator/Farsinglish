<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <title>ØªØ³Øª IndexedDB Wrapper - Farsinglish</title>
    <style>
        body { 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
            padding: 20px; 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }
        h1 {
            text-align: center;
            color: #2d3436;
            margin-bottom: 10px;
            font-size: 2.2rem;
        }
        .subtitle {
            text-align: center;
            color: #636e72;
            margin-bottom: 30px;
            font-size: 1.1rem;
        }
        .test {
            background: white;
            padding: 20px;
            margin: 15px 0;
            border-radius: 12px;
            border-right: 6px solid #4CAF50;
            box-shadow: 0 5px 15px rgba(0,0,0,0.08);
            transition: transform 0.3s;
        }
        .test:hover {
            transform: translateY(-3px);
        }
        .fail {
            border-right-color: #e74c3c;
        }
        .pending {
            border-right-color: #f39c12;
        }
        .success {
            color: #27ae60;
            font-weight: bold;
        }
        .error {
            color: #e74c3c;
            font-weight: bold;
        }
        .warning {
            color: #f39c12;
        }
        button {
            padding: 14px 28px;
            margin: 8px;
            border: none;
            border-radius: 50px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        #runTests {
            background: linear-gradient(135deg, #00b09b, #96c93d);
            color: white;
        }
        #clearDB {
            background: linear-gradient(135deg, #ff7e5f, #feb47b);
            color: white;
        }
        button:hover {
            transform: translateY(-3px);
            box-shadow: 0 7px 20px rgba(0,0,0,0.2);
        }
        button:active {
            transform: translateY(-1px);
        }
        .controls {
            text-align: center;
            margin: 30px 0;
        }
        .details {
            font-size: 0.9rem;
            color: #636e72;
            margin-top: 8px;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
        }
        .stats {
            display: flex;
            justify-content: space-around;
            margin: 25px 0;
            padding: 20px;
            background: linear-gradient(135deg, #74b9ff, #0984e3);
            border-radius: 15px;
            color: white;
            text-align: center;
        }
        .stat-item {
            flex: 1;
        }
        .stat-value {
            font-size: 2.5rem;
            font-weight: bold;
            margin-bottom: 5px;
        }
        .stat-label {
            font-size: 0.9rem;
            opacity: 0.9;
        }
        .loading {
            text-align: center;
            padding: 20px;
            color: #636e72;
        }
        .loading::after {
            content: '...';
            animation: dots 1.5s infinite;
        }
        @keyframes dots {
            0%, 20% { content: '.'; }
            40% { content: '..'; }
            60%, 100% { content: '...'; }
        }
        .time {
            font-size: 0.85rem;
            color: #636e72;
            float: left;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ§ª ØªØ³Øª IndexedDB Wrapper</h1>
        <div class="subtitle">Ø¨Ø±Ø±Ø³ÛŒ Ù‡Ø³ØªÙ‡ Ø°Ø®ÛŒØ±Ù‡â€ŒØ³Ø§Ø²ÛŒ Ù¾Ø±ÙˆÚ˜Ù‡ Farsinglish</div>
        
        <div class="stats">
            <div class="stat-item">
                <div class="stat-value" id="totalTests">0</div>
                <div class="stat-label">Ú©Ù„ ØªØ³Øªâ€ŒÙ‡Ø§</div>
            </div>
            <div class="stat-item">
                <div class="stat-value" id="passedTests" style="color:#55efc4">0</div>
                <div class="stat-label">Ù…ÙˆÙÙ‚</div>
            </div>
            <div class="stat-item">
                <div class="stat-value" id="failedTests" style="color:#ff7675">0</div>
                <div class="stat-label">Ù†Ø§Ù…ÙˆÙÙ‚</div>
            </div>
            <div class="stat-item">
                <div class="stat-value" id="duration">0s</div>
                <div class="stat-label">Ø²Ù…Ø§Ù†</div>
            </div>
        </div>
        
        <div class="controls">
            <button id="runTests" onclick="runTests()">
                <span>â–¶</span> Ø§Ø¬Ø±Ø§ÛŒ Ú©Ø§Ù…Ù„ ØªØ³Øªâ€ŒÙ‡Ø§
            </button>
            <button id="clearDB" onclick="clearDB()">
                <span>ğŸ—‘ï¸</span> Ù¾Ø§Ú©â€ŒØ³Ø§Ø²ÛŒ Ø¯ÛŒØªØ§Ø¨ÛŒØ³
            </button>
        </div>
        
        <div id="results">
            <div class="loading" id="loadingStatus">
                Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ ÙØ§ÛŒÙ„â€ŒÙ‡Ø§...
            </div>
        </div>
    </div>

    <script>
        // ==================== ØªÙ†Ø¸ÛŒÙ…Ø§Øª ====================
        const CONFIG = {
            DB_NAME: 'farsinglish_test_db',
            DB_VERSION: 1,
            STORES: {
                users: { keyPath: 'id' },
                lessons: { keyPath: 'lessonId' },
                progress: { keyPath: 'userId' }
            }
        };
        
        // ==================== Ù…ØªØºÛŒØ±Ù‡Ø§ÛŒ Ø¬Ù‡Ø§Ù†ÛŒ ====================
        let testResults = {
            total: 0,
            passed: 0,
            failed: 0,
            startTime: null
        };
        
        // ==================== Ø§Ø¨Ø²Ø§Ø±Ù‡Ø§ÛŒ Ú©Ù…Ú©ÛŒ ====================
        function updateStats() {
            document.getElementById('totalTests').textContent = testResults.total;
            document.getElementById('passedTests').textContent = testResults.passed;
            document.getElementById('failedTests').textContent = testResults.failed;
            
            if (testResults.startTime) {
                const duration = (Date.now() - testResults.startTime) / 1000;
                document.getElementById('duration').textContent = duration.toFixed(1) + 's';
            }
        }
        
        function addTestResult(name, passed, details = '') {
            testResults.total++;
            if (passed) testResults.passed++; else testResults.failed++;
            
            const resultDiv = document.createElement('div');
            resultDiv.className = `test ${passed ? '' : 'fail'}`;
            
            const time = new Date().toLocaleTimeString('fa-IR', { 
                hour: '2-digit', 
                minute: '2-digit',
                second: '2-digit'
            });
            
            resultDiv.innerHTML = `
                <div>
                    <strong>${passed ? 'âœ…' : 'âŒ'} ${name}</strong>
                    <span class="time">${time}</span>
                </div>
                ${details ? `<div class="details">${details}</div>` : ''}
            `;
            
            document.getElementById('results').appendChild(resultDiv);
            updateStats();
            return resultDiv;
        }
        
        function showMessage(type, text) {
            const msg = document.createElement('div');
            msg.className = `test ${type}`;
            msg.innerHTML = `<strong>${text}</strong>`;
            document.getElementById('results').appendChild(msg);
        }
        
        // ==================== Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ ÙØ§ÛŒÙ„ Ø§ØµÙ„ÛŒ ====================
        const scriptsToLoad = [
            '../core/db/indexeddb-wrapper.js'
        ];
        
        let loadedScripts = 0;
        
        function loadScript(src) {
            return new Promise((resolve, reject) => {
                const script = document.createElement('script');
                script.src = src;
                script.onload = () => {
                    console.log(`âœ… Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø´Ø¯: ${src}`);
                    loadedScripts++;
                    resolve();
                };
                script.onerror = () => {
                    console.error(`âŒ Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ: ${src}`);
                    reject(new Error(`Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ ${src}`));
                };
                document.head.appendChild(script);
            });
        }
        
        async function loadAllScripts() {
            try {
                for (const src of scriptsToLoad) {
                    await loadScript(src);
                }
                document.getElementById('loadingStatus').remove();
                showMessage('success', 'âœ… ØªÙ…Ø§Ù… ÙØ§ÛŒÙ„â€ŒÙ‡Ø§ Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø´Ø¯Ù†Ø¯');
            } catch (error) {
                document.getElementById('loadingStatus').remove();
                showMessage('error', `âŒ Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ: ${error.message}`);
                throw error;
            }
        }
        
        // ==================== ØªØ³Øªâ€ŒÙ‡Ø§ ====================
        async function runTests() {
            // Ù¾Ø§Ú©â€ŒØ³Ø§Ø²ÛŒ Ù†ØªØ§ÛŒØ¬ Ù‚Ø¨Ù„ÛŒ
            document.getElementById('results').innerHTML = '';
            testResults = { total: 0, passed: 0, failed: 0, startTime: Date.now() };
            updateStats();
            
            try {
                // ØªØ³Øª Û±: Singleton Pattern
                const db1 = IndexedDBWrapper.getInstance();
                const db2 = IndexedDBWrapper.getInstance();
                const isSingleton = db1 === db2;
                addTestResult(
                    'Ø§Ù„Ú¯ÙˆÛŒ Singleton',
                    isSingleton,
                    `db1 === db2: ${isSingleton}`
                );
                
                // ØªØ³Øª Û²: Ø§ØªØµØ§Ù„ Ø¨Ù‡ Ø¯ÛŒØªØ§Ø¨ÛŒØ³
                try {
                    await db1.connect(CONFIG.DB_NAME, CONFIG.DB_VERSION, CONFIG.STORES);
                    addTestResult(
                        'Ø§ØªØµØ§Ù„ Ø¨Ù‡ Ø¯ÛŒØªØ§Ø¨ÛŒØ³',
                        true,
                        `Ø¯ÛŒØªØ§Ø¨ÛŒØ³: ${CONFIG.DB_NAME} (ÙˆØ±Ú˜Ù† ${CONFIG.DB_VERSION})`
                    );
                } catch (error) {
                    addTestResult(
                        'Ø§ØªØµØ§Ù„ Ø¨Ù‡ Ø¯ÛŒØªØ§Ø¨ÛŒØ³',
                        false,
                        `Ø®Ø·Ø§: ${error.message}`
                    );
                    throw error;
                }
                
                // ØªØ³Øª Û³: Ø§ÙØ²ÙˆØ¯Ù† Ø¯Ø§Ø¯Ù‡
                const testUser = { 
                    id: Date.now(), 
                    name: 'Ú©Ø§Ø±Ø¨Ø± ØªØ³Øª',
                    email: 'test@farsinglish.com',
                    level: 1,
                    xp: 0,
                    createdAt: new Date().toISOString()
                };
                
                await db1.add('users', testUser);
                const retrievedUser = await db1.get('users', testUser.id);
                const addPassed = retrievedUser && retrievedUser.name === testUser.name;
                
                addTestResult(
                    'Ø§ÙØ²ÙˆØ¯Ù† Ø¯Ø§Ø¯Ù‡ (Add)',
                    addPassed,
                    `Ø´Ù†Ø§Ø³Ù‡: ${testUser.id}<br>Ù†Ø§Ù…: ${retrievedUser?.name || 'ÛŒØ§ÙØª Ù†Ø´Ø¯'}`
                );
                
                // ØªØ³Øª Û´: Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ø¯Ø§Ø¯Ù‡
                if (addPassed) {
                    const updatedUser = { ...retrievedUser, level: 2, xp: 100 };
                    await db1.update('users', updatedUser);
                    const afterUpdate = await db1.get('users', testUser.id);
                    const updatePassed = afterUpdate && afterUpdate.level === 2;
                    
                    addTestResult(
                        'Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ø¯Ø§Ø¯Ù‡ (Update)',
                        updatePassed,
                        `Ø³Ø·Ø­: ${afterUpdate?.level || 'Ù†Ø§Ù…Ø´Ø®Øµ'} | XP: ${afterUpdate?.xp || 0}`
                    );
                }
                
                // ØªØ³Øª Ûµ: Ø­Ø°Ù Ø¯Ø§Ø¯Ù‡
                await db1.delete('users', testUser.id);
                const afterDelete = await db1.get('users', testUser.id);
                const deletePassed = afterDelete === undefined;
                
                addTestResult(
                    'Ø­Ø°Ù Ø¯Ø§Ø¯Ù‡ (Delete)',
                    deletePassed,
                    deletePassed ? 'Ø¯Ø§Ø¯Ù‡ Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø­Ø°Ù Ø´Ø¯' : 'Ø¯Ø§Ø¯Ù‡ Ù‡Ù†ÙˆØ² Ù…ÙˆØ¬ÙˆØ¯ Ø§Ø³Øª'
                );
                
                // ØªØ³Øª Û¶: Ø¹Ù…Ù„ÛŒØ§Øª Batch (Ú†Ù†Ø¯ØªØ§ÛŒÛŒ)
                const testLessons = [
                    { lessonId: 'lesson_1', title: 'Ø¯Ø±Ø³ Ø§ÙˆÙ„', difficulty: 'easy', order: 1 },
                    { lessonId: 'lesson_2', title: 'Ø¯Ø±Ø³ Ø¯ÙˆÙ…', difficulty: 'medium', order: 2 },
                    { lessonId: 'lesson_3', title: 'Ø¯Ø±Ø³ Ø³ÙˆÙ…', difficulty: 'hard', order: 3 }
                ];
                
                await Promise.all(
                    testLessons.map(lesson => db1.add('lessons', lesson))
                );
                
                const allLessons = await db1.getAll('lessons');
                const batchPassed = allLessons.length === 3;
                
                addTestResult(
                    'Ø¹Ù…Ù„ÛŒØ§Øª Batch (Ú†Ù†Ø¯ØªØ§ÛŒÛŒ)',
                    batchPassed,
                    `${allLessons.length} Ø¯Ø±Ø³ Ø°Ø®ÛŒØ±Ù‡ Ø´Ø¯`
                );
                
                // ØªØ³Øª Û·: Ù¾Ø§Ú©â€ŒØ³Ø§Ø²ÛŒ Ø¬Ø¯ÙˆÙ„
                await db1.clearStore('lessons');
                const afterClear = await db1.getAll('lessons');
                const clearPassed = afterClear.length === 0;
                
                addTestResult(
                    'Ù¾Ø§Ú©â€ŒØ³Ø§Ø²ÛŒ Ø¬Ø¯ÙˆÙ„ (Clear Store)',
                    clearPassed,
                    clearPassed ? 'Ø¬Ø¯ÙˆÙ„ Ø®Ø§Ù„ÛŒ Ø´Ø¯' : `Ù‡Ù†ÙˆØ² ${afterClear.length} Ø±Ú©ÙˆØ±Ø¯ Ù…ÙˆØ¬ÙˆØ¯ Ø§Ø³Øª`
                );
                
                // ØªØ³Øª Û¸: Ù…Ø¯ÛŒØ±ÛŒØª Ø®Ø·Ø§ (Ø¬Ø¯ÙˆÙ„ Ù†Ø§Ù…ÙˆØ¬ÙˆØ¯)
                try {
                    await db1.get('non_existent_table', 1);
                    addTestResult(
                        'Ù…Ø¯ÛŒØ±ÛŒØª Ø®Ø·Ø§',
                        false,
                        'Ø¨Ø§ÛŒØ¯ Ø®Ø·Ø§ Ù…ÛŒâ€ŒØ¯Ø§Ø¯ Ø§Ù…Ø§ Ù†Ø¯Ø§Ø¯!'
                    );
                } catch (error) {
                    addTestResult(
                        'Ù…Ø¯ÛŒØ±ÛŒØª Ø®Ø·Ø§',
                        true,
                        `Ø®Ø·Ø§ Ø¨Ù‡ Ø¯Ø±Ø³ØªÛŒ Ú¯Ø±ÙØªÙ‡ Ø´Ø¯: ${error.message}`
                    );
                }
                
                // ØªØ³Øª Û¹: ÙˆØ¶Ø¹ÛŒØª Ø§ØªØµØ§Ù„
                const isConnected = db1.isConnected();
                addTestResult(
                    'ÙˆØ¶Ø¹ÛŒØª Ø§ØªØµØ§Ù„',
                    isConnected,
                    isConnected ? 'Ø¯ÛŒØªØ§Ø¨ÛŒØ³ Ù…ØªØµÙ„ Ø§Ø³Øª' : 'Ø¯ÛŒØªØ§Ø¨ÛŒØ³ Ù‚Ø·Ø¹ Ø§Ø³Øª'
                );
                
                // Ø¬Ù…Ø¹â€ŒØ¨Ù†Ø¯ÛŒ
                const successRate = Math.round((testResults.passed / testResults.total) * 100);
                showMessage(
                    successRate === 100 ? 'success' : successRate > 70 ? 'warning' : 'error',
                    `ğŸ¯ Ø¬Ù…Ø¹â€ŒØ¨Ù†Ø¯ÛŒ: ${testResults.passed} Ø§Ø² ${testResults.total} ØªØ³Øª Ù…ÙˆÙÙ‚ (${successRate}%)`
                );
                
            } catch (error) {
                addTestResult(
                    'Ø®Ø·Ø§ÛŒ Ú©Ù„ÛŒ ØªØ³Øªâ€ŒÙ‡Ø§',
                    false,
                    `Ø®Ø·Ø§: ${error.message}<br><small>${error.stack}</small>`
                );
                showMessage('error', 'âŒ ØªØ³Øªâ€ŒÙ‡Ø§ Ø¨Ø§ Ø®Ø·Ø§ Ù…ØªÙˆÙ‚Ù Ø´Ø¯Ù†Ø¯');
            }
        }
        
        async function clearDB() {
            try {
                const db = IndexedDBWrapper.getInstance();
                if (db.isConnected()) {
                    await db.clearDatabase();
                    showMessage('success', 'âœ… Ø¯ÛŒØªØ§Ø¨ÛŒØ³ Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ù¾Ø§Ú©â€ŒØ³Ø§Ø²ÛŒ Ø´Ø¯');
                } else {
                    showMessage('warning', 'âš ï¸ Ø§Ø¨ØªØ¯Ø§ Ø¯ÛŒØªØ§Ø¨ÛŒØ³ Ø±Ø§ Ù…ØªØµÙ„ Ú©Ù†ÛŒØ¯');
                }
            } catch (error) {
                showMessage('error', `âŒ Ø®Ø·Ø§ Ø¯Ø± Ù¾Ø§Ú©â€ŒØ³Ø§Ø²ÛŒ: ${error.message}`);
            }
        }
        
        // ==================== Ø´Ø±ÙˆØ¹ Ø®ÙˆØ¯Ú©Ø§Ø± ====================
        window.addEventListener('DOMContentLoaded', () => {
            // Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ ÙØ§ÛŒÙ„â€ŒÙ‡Ø§ Ø¨Ù‡ ØµÙˆØ±Øª Ø®ÙˆØ¯Ú©Ø§Ø±
            loadAllScripts().catch(() => {
                // Ø§Ú¯Ø± ÙØ§ÛŒÙ„ Ø§ØµÙ„ÛŒ ÙˆØ¬ÙˆØ¯ Ù†Ø¯Ø§Ø´ØªØŒ Ù¾ÛŒØ§Ù… Ù…Ù†Ø§Ø³Ø¨ Ù†Ù…Ø§ÛŒØ´ Ø¨Ø¯Ù‡
                setTimeout(() => {
                    if (loadedScripts === 0) {
                        document.getElementById('loadingStatus').innerHTML = 
                            'âš ï¸ ÙØ§ÛŒÙ„ Ø§ØµÙ„ÛŒ ÛŒØ§ÙØª Ù†Ø´Ø¯. Ù…Ø·Ù…Ø¦Ù† Ø´ÙˆÛŒØ¯ Ù…Ø³ÛŒØ± ÙØ§ÛŒÙ„â€ŒÙ‡Ø§ Ø¯Ø±Ø³Øª Ø§Ø³Øª:<br>' +
                            '<code>../core/db/indexeddb-wrapper.js</code>';
                    }
                }, 3000);
            });
        });
    </script>
</body>
</html>
