<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.5, user-scalable=yes">
    <title>ØªØ³Øª Ø¯Ø³ØªÛŒ Persistence Recovery - Farsinglish (Ø±ÙØ¹ Ø®Ø·Ø§)</title>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body {
            font-family: 'Tahoma', 'Vazir', sans-serif;
            background: linear-gradient(145deg, #f0f2f5 0%, #e9ecef 100%);
            padding: 20px;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        .container {
            max-width: 900px;
            width: 100%;
            background: rgba(255,255,255,0.9);
            backdrop-filter: blur(10px);
            border-radius: 32px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.12);
            padding: 25px;
            border: 1px solid rgba(255,255,255,0.3);
        }
        h1 {
            color: #1e3c5c;
            font-size: 1.9rem;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 12px;
            border-bottom: 3px solid #ffb74d;
            padding-bottom: 15px;
        }
        .sub {
            color: #2c3e50;
            margin-bottom: 25px;
            background: #e3f2fd;
            padding: 12px 20px;
            border-radius: 50px;
            font-size: 0.95rem;
            display: inline-block;
        }
        .card {
            background: white;
            border-radius: 24px;
            padding: 20px;
            margin-bottom: 25px;
            box-shadow: 0 6px 18px rgba(0,0,0,0.04);
            border: 1px solid #f1f3f5;
        }
        .badge {
            background: #1e3c5c;
            color: white;
            padding: 6px 16px;
            border-radius: 40px;
            font-size: 0.8rem;
            display: inline-block;
            margin-bottom: 12px;
            letter-spacing: 1px;
        }
        .btn-group {
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
            margin: 20px 0;
            justify-content: center;
        }
        .btn {
            border: none;
            background: white;
            padding: 14px 24px;
            border-radius: 60px;
            font-size: 1rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.02);
            transition: 0.2s;
            border: 1px solid #dee2e6;
            cursor: pointer;
            color: #1e3c5c;
            flex: 1 1 160px;
            justify-content: center;
        }
        .btn-primary {
            background: #1e3c5c;
            color: white;
            border: none;
        }
        .btn-warning {
            background: #ff9800;
            color: white;
            border: none;
        }
        .btn-success {
            background: #2e7d32;
            color: white;
            border: none;
        }
        .btn:active { transform: scale(0.96); }
        .state-box {
            background: #1a2634;
            color: #e9f1f7;
            padding: 18px;
            border-radius: 18px;
            font-family: 'Courier New', monospace;
            font-size: 0.9rem;
            direction: ltr;
            text-align: left;
            white-space: pre-wrap;
            word-break: break-word;
            max-height: 220px;
            overflow-y: auto;
            margin: 15px 0;
            border-left: 6px solid #ffb74d;
        }
        .log {
            background: #f8fbfd;
            border-radius: 16px;
            padding: 15px;
            font-size: 0.9rem;
            border-right: 5px solid #4caf50;
            color: #0a2f44;
            max-height: 200px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
        }
        .flex-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
        }
        .timestamp {
            color: #6c757d;
            font-size: 0.75rem;
            font-family: monospace;
        }
        .recovery-sim {
            background: #fff3e0;
            border-radius: 20px;
            padding: 20px;
            margin-top: 10px;
        }
        hr {
            margin: 25px 0 15px;
            border: 1px dashed #adb5bd;
        }
        .fixed-badge {
            background: #27ae60;
            color: white;
            padding: 4px 12px;
            border-radius: 30px;
            font-size: 0.75rem;
            display: inline-block;
            margin-right: 10px;
        }
        @media (max-width: 600px) {
            .container { padding: 18px; }
            h1 { font-size: 1.6rem; }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>
            <span>ğŸ”„ Persistence & Recovery</span>
            <span class="fixed-badge">Ø±ÙØ¹ Ø®Ø·Ø§ÛŒ btoa</span>
        </h1>
        <div class="sub">
            âš¡ ØªØ³Øª Ø¯Ø³ØªÛŒ Ø°Ø®ÛŒØ±Ù‡â€ŒØ³Ø§Ø²ÛŒØŒ Ø¨Ø§Ø²ÛŒØ§Ø¨ÛŒ state Ùˆ Ù…Ù‚Ø§ÙˆÙ…Øª Ø¯Ø± Ø¨Ø±Ø§Ø¨Ø± Ø¨Ø³ØªÙ‡ Ø´Ø¯Ù† ØµÙØ­Ù‡
        </div>

        <!-- Ú©Ø§Ø±Øª Û±: Ø´Ø¨ÛŒÙ‡â€ŒØ³Ø§Ø² State Ø¨Ø§ LocalStorage -->
        <div class="card">
            <div class="badge">ğŸ“¦ Û±. Ù…ÙˆØªÙˆØ± persistence (Ø±ÙØ¹ Ø®Ø·Ø§ÛŒ ÛŒÙˆÙ†ÛŒÚ©Ø¯)</div>
            
            <div class="flex-row">
                <span style="font-weight:700;">ğŸ§  ÙˆØ¶Ø¹ÛŒØª ÙØ¹Ù„ÛŒ Ø­Ø§ÙØ¸Ù‡:</span>
                <span class="timestamp" id="timeDisplay"></span>
            </div>
            <div id="stateViewer" class="state-box">
                { "user": null, "progress": {}, "settings": {}, "timestamp": "--" }
            </div>
            
            <div class="btn-group">
                <button class="btn btn-primary" id="saveUserProgressBtn">
                    ğŸ’¾ Û±. Ø°Ø®ÛŒØ±Ù‡ Ù¾ÛŒØ´Ø±ÙØª Ú©Ø§Ø±Ø¨Ø± (Ù†Ù…ÙˆÙ†Ù‡)
                </button>
                <button class="btn" id="loadFromStorageBtn">
                    ğŸ“‚ Û². Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø§Ø² Ø­Ø§ÙØ¸Ù‡
                </button>
                <button class="btn btn-warning" id="simulatePageCloseBtn">
                    ğŸ§ª Û³. Ø´Ø¨ÛŒÙ‡â€ŒØ³Ø§Ø²ÛŒ Ø¨Ø³ØªÙ‡ Ø´Ø¯Ù† ØµÙØ­Ù‡
                </button>
                <button class="btn btn-success" id="simulateRecoveryBtn">
                    ğŸ” Û´. Ø¨Ø§Ø²ÛŒØ§Ø¨ÛŒ Ù¾Ø³ Ø§Ø² Ø¨Ø§Ø²Ú¯Ø´Ø§ÛŒÛŒ
                </button>
            </div>
            <p style="color: #444; margin-top: 12px; background: #e8f5e9; padding: 10px; border-radius: 12px;">
                âœ… Ú¯Ø§Ù… Ù¾ÛŒØ´Ù†Ù‡Ø§Ø¯ÛŒ: Ø°Ø®ÛŒØ±Ù‡ â† Ø¨Ø³ØªÙ† Ø´Ø¨ÛŒÙ‡â€ŒØ³Ø§Ø²ÛŒ â† Ø¨Ø§Ø²ÛŒØ§Ø¨ÛŒ â† Ø¨Ø±Ø±Ø³ÛŒ ÛŒÚ©Ù¾Ø§Ø±Ú†Ú¯ÛŒ state
            </p>
        </div>

        <!-- Ú©Ø§Ø±Øª Û²: Ø³Ù†Ø§Ø±ÛŒÙˆÙ‡Ø§ÛŒ ØªØ³Øª Ø¯Ø³ØªÛŒ -->
        <div class="card recovery-sim">
            <div style="display:flex; align-items:center; gap:10px; margin-bottom:12px;">
                <span style="background: #2c3e50; color:white; padding:5px 18px; border-radius:30px;">ğŸ§ª Ø³Ù†Ø§Ø±ÛŒÙˆÙ‡Ø§ÛŒ ØªØ³Øª Ø¯Ø³ØªÛŒ</span>
            </div>
            
            <div style="display:grid; gap:20px;">
                <div style="background:white; border-radius:16px; padding:16px;">
                    <strong style="color:#d32f2f;">ğŸ”´ ØªØ³Øª Û± - Ø¨Ø§Ø²ÛŒØ§Ø¨ÛŒ Ù¾Ø³ Ø§Ø² Ø¨Ø³ØªÙ† Ø§Ø¬Ø¨Ø§Ø±ÛŒ</strong>
                    <p style="margin-top:6px;">Û±. Ø¯Ú©Ù…Ù‡ "Ø°Ø®ÛŒØ±Ù‡ Ù¾ÛŒØ´Ø±ÙØª Ú©Ø§Ø±Ø¨Ø±" Ø±Ø§ Ø¨Ø²Ù†ÛŒØ¯.<br>Û². Ø¯Ú©Ù…Ù‡ "Ø´Ø¨ÛŒÙ‡â€ŒØ³Ø§Ø²ÛŒ Ø¨Ø³ØªÙ‡ Ø´Ø¯Ù† ØµÙØ­Ù‡" Ø±Ø§ Ø¨Ø²Ù†ÛŒØ¯ (Ø­Ø§ÙØ¸Ù‡ Ù¾Ø§Ú© Ù…ÛŒâ€ŒØ´ÙˆØ¯).<br>Û³. Ø¯Ú©Ù…Ù‡ "Ø¨Ø§Ø²ÛŒØ§Ø¨ÛŒ Ù¾Ø³ Ø§Ø² Ø¨Ø§Ø²Ú¯Ø´Ø§ÛŒÛŒ" Ø±Ø§ Ø¨Ø²Ù†ÛŒØ¯.<br>ğŸ“Œ Ø¨Ø±Ø±Ø³ÛŒ: Ø¢ÛŒØ§ state Ù‚Ø¨Ù„ÛŒ Ø¨Ø§ ØªÙ…Ø§Ù… ÙÛŒÙ„Ø¯Ù‡Ø§ Ø¨Ø§Ø²Ú¯Ø´ØªÙ‡ Ø§Ø³ØªØŸ</p>
                </div>
                <div style="background:white; border-radius:16px; padding:16px;">
                    <strong style="color:#1565c0;">ğŸ”µ ØªØ³Øª Û² - Ù‚Ø·Ø¹ Ù†Ø§Ú¯Ù‡Ø§Ù†ÛŒ Ø¨Ø±Ù‚/Ú©Ø±Ø´</strong>
                    <p>Û±. ÛŒÚ© state Ø¯Ù„Ø®ÙˆØ§Ù‡ Ø¨Ø³Ø§Ø²ÛŒØ¯ (Ù…Ø«Ù„Ø§Ù‹ Ø¯Ø±Ø³ Ûµ Ø¨Ø§ Ù†Ù…Ø±Ù‡ Û´).<br>Û². Ø¨Ø¯ÙˆÙ† Ø°Ø®ÛŒØ±Ù‡â€ŒØ³Ø§Ø²ÛŒØŒ ØµÙØ­Ù‡ Ø±Ø§ Ø±ÙØ±Ø´ Ú©Ù†ÛŒØ¯ (Ø®ÙˆØ¯ Ù…Ø±ÙˆØ±Ú¯Ø±).<br>Û³. Ø¯Ú©Ù…Ù‡ "Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø§Ø² Ø­Ø§ÙØ¸Ù‡" Ø±Ø§ Ø¨Ø²Ù†ÛŒØ¯.<br>ğŸ“Œ Ø¢ÛŒØ§ Ù…Ù‚Ø¯Ø§Ø± Ø°Ø®ÛŒØ±Ù‡â€ŒØ´Ø¯Ù‡â€ŒÙ…Ø§Ù†Ù†Ø¯ Ù‚Ø¨Ù„ Ø¨Ø§Ù‚ÛŒ Ù…Ø§Ù†Ø¯Ù‡ØŸ (persistence ÙˆØ§Ù‚Ø¹ÛŒ)</p>
                </div>
                <div style="background:white; border-radius:16px; padding:16px;">
                    <strong style="color:#ff6d00;">ğŸŸ  ØªØ³Øª Û³ - Ù…Ù‡Ø§Ø¬Ø±Øª Ù†Ø³Ø®Ù‡ state (Ø±ÙØ¹ Ø´Ø¯Ù‡)</strong>
                    <p>Û±. Ø¯Ú©Ù…Ù‡ Ø°Ø®ÛŒØ±Ù‡ Ø±Ø§ Ø¨Ø²Ù†ÛŒØ¯ (Ù†Ø³Ø®Ù‡ Û±).<br>Û². Ø¯Ú©Ù…Ù‡ "Ø´Ø¨ÛŒÙ‡â€ŒØ³Ø§Ø²ÛŒ Ù…Ù‡Ø§Ø¬Ø±Øª v1â†’v2" Ø±Ø§ Ø¨Ø²Ù†ÛŒØ¯.<br>Û³. Ø¨Ø§Ø²ÛŒØ§Ø¨ÛŒ Ø§Ù†Ø¬Ø§Ù… Ø¯Ù‡ÛŒØ¯: ÙÛŒÙ„Ø¯Ù‡Ø§ÛŒ dailyGoal Ùˆ newFeature Ø§Ø¶Ø§ÙÙ‡ Ù…ÛŒâ€ŒØ´ÙˆØ¯.<br>âœ… Ø¨Ø¯ÙˆÙ† Ø®Ø·Ø§ÛŒ btoa</p>
                    <button id="simulateMigrationBtn" style="background: #ffb74d; border:none; padding:8px 20px; border-radius:40px; margin-top:6px; color:black; font-weight:bold;">ğŸ§¬ Ø´Ø¨ÛŒÙ‡â€ŒØ³Ø§Ø²ÛŒ Ù…Ù‡Ø§Ø¬Ø±Øª v1 â†’ v2</button>
                </div>
            </div>
        </div>

        <!-- Ú©Ø§Ø±Øª Û³: ÙˆÙ‚Ø§ÛŒØ¹ Ùˆ Ù„Ø§Ú¯ Ø¹Ù…Ù„ÛŒØ§Øª -->
        <div class="card">
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <span class="badge" style="background: #2a4d69;">ğŸ“‹ Ù„Ø§Ú¯ Ø±ÙˆÛŒØ¯Ø§Ø¯Ù‡Ø§ÛŒ Persistence</span>
                <button id="clearLogBtn" style="background: none; border:1px solid gray; padding:5px 15px; border-radius:30px;">ğŸ§¹ Ù¾Ø§Ú© Ú©Ø±Ø¯Ù† Ù„Ø§Ú¯</button>
            </div>
            <div id="logPanel" class="log">
                -- Ù„Ø§Ú¯ Ø®Ø§Ù„ÛŒ -- Ø¢Ù…Ø§Ø¯Ù‡ Ø¯Ø±ÛŒØ§ÙØª Ø¯Ø³ØªÙˆØ±Ø§Øª
            </div>
        </div>

        <!-- Ø±Ø§Ù‡Ù†Ù…Ø§ÛŒ Ø³Ø±ÛŒØ¹ -->
        <div style="background: #d4edc9; padding: 14px; border-radius: 24px; color: #14532d; text-align: center; font-size: 0.85rem;">
            ğŸ’¡ Ø®Ø·Ø§ÛŒ btoa Ø±ÙØ¹ Ø´Ø¯. Ø§Ú©Ù†ÙˆÙ† ØªÙ…Ø§Ù… Ù…ØªÙˆÙ† ÙØ§Ø±Ø³ÛŒ Ùˆ ÛŒÙˆÙ†ÛŒÚ©Ø¯ Ø¨Ù‡ Ø¯Ø±Ø³ØªÛŒ Ø°Ø®ÛŒØ±Ù‡ Ù…ÛŒâ€ŒØ´ÙˆÙ†Ø¯.
        </div>
    </div>

    <script>
        // -------------------- ğŸŒ Persistence Manager (Ø±ÙØ¹ Ø®Ø·Ø§ÛŒ btoa) --------------------
        const PERSISTENCE_KEY = 'farsinglish_persistence_recovery_test';
        const VERSION_KEY = 'farsinglish_state_version';
        
        // Ù…Ø¯Ù„ state Ù¾Ø§ÛŒÙ‡ Ø¨Ø§ timestamp
        let currentState = {
            user: { id: null, name: 'Ú©Ø§Ø±Ø¨Ø± Ù…Ù‡Ù…Ø§Ù†', xp: 0, level: 1 },
            progress: {
                lastLessonId: null,
                completedLessons: [],
                srsReviews: {},
                streak: 0
            },
            settings: { darkMode: false, language: 'fa', notifications: true },
            version: 1,
            lastSaved: null
        };

        // Ù„Ø§Ú¯ Ø­Ø§ÙØ¸Ù‡
        let actionLog = [];

        // -------------------- ØªÙˆØ§Ø¨Ø¹ Ú©Ù…Ú©ÛŒ (Ø±ÙØ¹ Ø®Ø·Ø§ÛŒ ÛŒÙˆÙ†ÛŒÚ©Ø¯) --------------------
        function addLog(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString('fa-IR', { hour12: false });
            const logEntry = `[${timestamp}] ${message}`;
            actionLog.unshift(logEntry);
            if (actionLog.length > 8) actionLog.pop();
            renderLog();
        }

        function renderLog() {
            const logEl = document.getElementById('logPanel');
            logEl.innerHTML = actionLog.length ? actionLog.map(l => `ğŸ“Œ ${l}`).join('<br>') : '-- Ù„Ø§Ú¯ Ø®Ø§Ù„ÛŒ --';
        }

        // ØªØ§Ø¨Ø¹ Ø§ÛŒÙ…Ù† Ø¨Ø±Ø§ÛŒ btoa Ø¨Ø§ Ù¾Ø´ØªÛŒØ¨Ø§Ù†ÛŒ Ø§Ø² ÛŒÙˆÙ†ÛŒÚ©Ø¯/ÙØ§Ø±Ø³ÛŒ
        function safeBtoa(str) {
            try {
                // ØªØ¨Ø¯ÛŒÙ„ Ú©Ø§Ø±Ø§Ú©ØªØ±Ù‡Ø§ÛŒ ÛŒÙˆÙ†ÛŒÚ©Ø¯ Ø¨Ù‡ Ù„Ø§ØªÛŒÙ†1
                return btoa(unescape(encodeURIComponent(str)));
            } catch(e) {
                console.warn('btoa failed, using fallback', e);
                // ÙØ§Ù„â€ŒØ¨Ú©: return string Ø³Ø§Ø¯Ù‡
                return 'checksum-' + Date.now();
            }
        }

        // Ø°Ø®ÛŒØ±Ù‡ state Ø¯Ø± localStorage (Ø±ÙØ¹ Ø®Ø·Ø§ÛŒ btoa)
        function persistState(state) {
            try {
                const stateWithMeta = {
                    ...state,
                    lastSaved: new Date().toISOString(),
                    // Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø§Ø² ØªØ§Ø¨Ø¹ Ø§ÛŒÙ…Ù†
                    checksum: safeBtoa(JSON.stringify(state)).slice(-10)
                };
                localStorage.setItem(PERSISTENCE_KEY, JSON.stringify(stateWithMeta));
                localStorage.setItem(VERSION_KEY, String(state.version || 1));
                addLog(`ğŸ’¾ Ø°Ø®ÛŒØ±Ù‡ Ø´Ø¯ | Ù†Ø³Ø®Ù‡: ${state.version} | checksum: ${stateWithMeta.checksum}`);
                return true;
            } catch(e) {
                addLog(`âŒ Ø®Ø·Ø§ Ø¯Ø± Ø°Ø®ÛŒØ±Ù‡: ${e.message}`, 'error');
                return false;
            }
        }

        // Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ state Ø§Ø² localStorage
        function loadPersistedState() {
            try {
                const raw = localStorage.getItem(PERSISTENCE_KEY);
                if (!raw) {
                    addLog('ğŸ“‚ Ù‡ÛŒÚ† state Ø°Ø®ÛŒØ±Ù‡â€ŒØ´Ø¯Ù‡â€ŒØ§ÛŒ ÛŒØ§ÙØª Ù†Ø´Ø¯');
                    return null;
                }
                const parsed = JSON.parse(raw);
                addLog(`ğŸ“‚ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ù…ÙˆÙÙ‚ | Ù†Ø³Ø®Ù‡: ${parsed.version || 1} | Ø¢Ø®Ø±ÛŒÙ† Ø°Ø®ÛŒØ±Ù‡: ${parsed.lastSaved?.slice(0,10) || 'Ù†Ø§Ù…Ø´Ø®Øµ'}`);
                return parsed;
            } catch(e) {
                addLog(`âŒ Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ: ${e.message}`);
                return null;
            }
        }

        // Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ù†Ù…Ø§ÛŒØ´ state Ø¯Ø± UI
        function renderState(stateToShow = currentState) {
            const viewer = document.getElementById('stateViewer');
            const displayObj = {
                user: stateToShow.user,
                progress: {
                    lastLesson: stateToShow.progress.lastLessonId,
                    completed: stateToShow.progress.completedLessons.length + ' Ø¯Ø±Ø³',
                    srsItems: Object.keys(stateToShow.progress.srsReviews || {}).length + ' Ú©Ø§Ø±Øª',
                    streak: stateToShow.progress.streak,
                    ...(stateToShow.progress.dailyGoal && { dailyGoal: stateToShow.progress.dailyGoal })
                },
                settings: {
                    ...stateToShow.settings,
                    ...(stateToShow.settings.newFeature !== undefined && { newFeature: stateToShow.settings.newFeature })
                },
                version: stateToShow.version,
                lastSaved: stateToShow.lastSaved ? stateToShow.lastSaved.slice(0,19).replace('T',' ') : '---'
            };
            viewer.textContent = JSON.stringify(displayObj, null, 2);
            document.getElementById('timeDisplay').innerHTML = `ğŸ•’ Ø¢Ø®Ø±ÛŒÙ† Ø¨Ù‡â€ŒØ±ÙˆØ²: ${new Date().toLocaleTimeString('fa')}`;
        }

        // -------------------- Ø³Ù†Ø§Ø±ÛŒÙˆÙ‡Ø§ÛŒ Ø¯Ø³ØªÛŒ --------------------
        function handleSaveSampleProgress() {
            // Ø³Ø§Ø®Øª ÛŒÚ© Ù¾ÛŒØ´Ø±ÙØª Ù†Ù…ÙˆÙ†Ù‡ Ø¨Ø§ Ù…ØªÙ† ÙØ§Ø±Ø³ÛŒ
            currentState.user = { id: 'user_123', name: 'Ø¹Ù„ÛŒ Ø±Ø¶Ø§ÛŒÛŒ', xp: 1250, level: 4 };
            currentState.progress = {
                lastLessonId: 'lesson_7',
                completedLessons: ['lesson_1','lesson_2','lesson_3','lesson_4','lesson_7'],
                srsReviews: {
                    'vocab_22': { interval: 6, ease: 2.5, due: '2026-02-18' },
                    'vocab_45': { interval: 12, ease: 2.7, due: '2026-02-24' }
                },
                streak: 12
            };
            currentState.settings = { darkMode: true, language: 'fa', notifications: false };
            currentState.version = 1;
            currentState.lastSaved = new Date().toISOString();
            
            persistState(currentState);
            renderState(currentState);
            addLog('ğŸ‘¤ Ù¾ÛŒØ´Ø±ÙØª Ú©Ø§Ø±Ø¨Ø± Ø¹Ù„ÛŒ Ø±Ø¶Ø§ÛŒÛŒ Ø°Ø®ÛŒØ±Ù‡ Ø´Ø¯ (Ø¯Ø±Ø³ Û·ØŒ Ø§Ø³ØªØ±ÛŒÚ© Û±Û²)');
        }

        function handleLoadFromStorage() {
            const loaded = loadPersistedState();
            if (loaded) {
                currentState = { ...currentState, ...loaded, progress: { ...currentState.progress, ...loaded.progress } };
                renderState(currentState);
                addLog('âœ… state Ø§Ø² Ø­Ø§ÙØ¸Ù‡ Ø¨Ø§Ø²ÛŒØ§Ø¨ÛŒ Ùˆ Ø¯Ø± UI Ø§Ø¹Ù…Ø§Ù„ Ø´Ø¯');
            } else {
                addLog('âš ï¸ Ù‡ÛŒÚ† Ø¯Ø§Ø¯Ù‡â€ŒØ§ÛŒ Ø¨Ø±Ø§ÛŒ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ù…ÙˆØ¬ÙˆØ¯ Ù†ÛŒØ³Øª');
            }
        }

        function handleSimulatePageClose() {
            // Ø´Ø¨ÛŒÙ‡â€ŒØ³Ø§Ø²ÛŒ Ø¨Ø³ØªÙ‡ Ø´Ø¯Ù† ØµÙØ­Ù‡: Ù¾Ø§Ú© Ú©Ø±Ø¯Ù† state Ù…ÙˆÙ‚Øª ÙˆÙ„ÛŒ Ø­ÙØ¸ localStorage
            const tempState = { ...currentState };
            // Ø±ÛŒØ³Øª currentState Ø¨Ù‡ Ø­Ø§Ù„Øª Ø§ÙˆÙ„ÛŒÙ‡ (Ø´Ø¨ÛŒÙ‡ Ø§Ø² Ø¯Ø³Øª Ø±ÙØªÙ† Ø­Ø§ÙØ¸Ù‡ Ù…ÙˆÙ‚Øª)
            currentState = {
                user: { id: null, name: 'Ú©Ø§Ø±Ø¨Ø± Ù…Ù‡Ù…Ø§Ù†', xp: 0, level: 1 },
                progress: { lastLessonId: null, completedLessons: [], srsReviews: {}, streak: 0 },
                settings: { darkMode: false, language: 'fa', notifications: true },
                version: 1,
                lastSaved: null
            };
            renderState(currentState);
            addLog('ğŸ’€ Ø´Ø¨ÛŒÙ‡â€ŒØ³Ø§Ø²ÛŒ Ø¨Ø³ØªÙ‡ Ø´Ø¯Ù† ØµÙØ­Ù‡: state Ù…ÙˆÙ‚Øª Ù¾Ø§Ú© Ø´Ø¯ (localStorage Ù‡Ù…Ú†Ù†Ø§Ù† Ù…Ø­ÙÙˆØ¸ Ø§Ø³Øª)');
        }

        function handleSimulateRecovery() {
            // Ø¨Ø§Ø²ÛŒØ§Ø¨ÛŒ Ù¾Ø³ Ø§Ø² Ø¨Ø§Ø²Ú¯Ø´Ø§ÛŒÛŒ: Ø§Ø² localStorage Ø¨Ø®ÙˆØ§Ù† Ùˆ currentState Ø±Ø§ Ø¨Ø§Ø²Ù†Ø´Ø§Ù†ÛŒ Ú©Ù†
            const recovered = loadPersistedState();
            if (recovered) {
                currentState = { ...currentState, ...recovered, progress: { ...currentState.progress, ...recovered.progress } };
                renderState(currentState);
                addLog('ğŸ”¥ Ø¨Ø§Ø²ÛŒØ§Ø¨ÛŒ Ø§Ø¶Ø·Ø±Ø§Ø±ÛŒ Ø§Ù†Ø¬Ø§Ù… Ø´Ø¯: state Ø§Ø² localStorage Ø¨Ø§Ø²Ú¯Ø±Ø¯Ø§Ù†Ø¯Ù‡ Ø´Ø¯');
            } else {
                addLog('âš ï¸ Ø¯Ø§Ø¯Ù‡â€ŒØ§ÛŒ Ø¨Ø±Ø§ÛŒ Ø¨Ø§Ø²ÛŒØ§Ø¨ÛŒ Ù…ÙˆØ¬ÙˆØ¯ Ù†ÛŒØ³Øª');
            }
        }

        function handleSimulateMigration() {
            // Ø§Ø±ØªÙ‚Ø§Ø¡ Ù†Ø³Ø®Ù‡ Û± Ø¨Ù‡ Û² (Ø§ÙØ²ÙˆØ¯Ù† ÙÛŒÙ„Ø¯ newFeature) - Ø¨Ø¯ÙˆÙ† Ø®Ø·Ø§
            const loaded = loadPersistedState();
            if (loaded) {
                if (loaded.version === 1) {
                    loaded.version = 2;
                    loaded.settings.newFeature = true;  // ÙÛŒÙ„Ø¯ Ø¬Ø¯ÛŒØ¯ Ø¯Ø± Ù†Ø³Ø®Ù‡ Û²
                    loaded.progress.dailyGoal = 20;     // ÙÛŒÙ„Ø¯ Ø¬Ø¯ÛŒØ¯
                    // Ø°Ø®ÛŒØ±Ù‡ Ù…Ø¬Ø¯Ø¯ Ø¨Ø§ Ù…ØªØ¯ Ø§ØµÙ„Ø§Ø­â€ŒØ´Ø¯Ù‡
                    localStorage.setItem(PERSISTENCE_KEY, JSON.stringify(loaded));
                    localStorage.setItem(VERSION_KEY, '2');
                    addLog('ğŸ†™ Ù…Ù‡Ø§Ø¬Ø±Øª Ø§Ø² Ù†Ø³Ø®Ù‡ Û± Ø¨Ù‡ Û² Ø§Ù†Ø¬Ø§Ù… Ø´Ø¯: ÙÛŒÙ„Ø¯Ù‡Ø§ÛŒ dailyGoal Ùˆ newFeature Ø§Ø¶Ø§ÙÙ‡ Ø´Ø¯');
                    currentState = { ...currentState, ...loaded };
                    renderState(currentState);
                } else {
                    addLog(`âœ… Ù†Ø³Ø®Ù‡ ÙØ¹Ù„ÛŒ ${loaded.version} Ø§Ø³Øª. Ù†ÛŒØ§Ø²ÛŒ Ø¨Ù‡ Ù…Ù‡Ø§Ø¬Ø±Øª Ù†ÛŒØ³Øª.`);
                }
            } else {
                addLog('âš ï¸ Ø§Ø¨ØªØ¯Ø§ ÛŒÚ© state Ø°Ø®ÛŒØ±Ù‡ Ú©Ù†ÛŒØ¯');
            }
        }

        // -------------------- Ù¾Ø§Ú©Ø³Ø§Ø²ÛŒ --------------------
        function handleClearAll() {
            localStorage.removeItem(PERSISTENCE_KEY);
            localStorage.removeItem(VERSION_KEY);
            currentState = {
                user: { id: null, name: 'Ú©Ø§Ø±Ø¨Ø± Ù…Ù‡Ù…Ø§Ù†', xp: 0, level: 1 },
                progress: { lastLessonId: null, completedLessons: [], srsReviews: {}, streak: 0 },
                settings: { darkMode: false, language: 'fa', notifications: true },
                version: 1,
                lastSaved: null
            };
            renderState(currentState);
            actionLog = [];
            renderLog();
            addLog('ğŸ§¹ ØªÙ…Ø§Ù… Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ÛŒ Ø°Ø®ÛŒØ±Ù‡â€ŒØ´Ø¯Ù‡ Ù¾Ø§Ú© Ø´Ø¯');
        }

        // -------------------- Ù…Ù‚Ø¯Ø§Ø±Ø¯Ù‡ÛŒ Ø§ÙˆÙ„ÛŒÙ‡ Ùˆ event listeners --------------------
        window.onload = function() {
            // ØªÙ„Ø§Ø´ Ø¨Ø±Ø§ÛŒ Ø¨Ø§Ø²ÛŒØ§Ø¨ÛŒ Ø®ÙˆØ¯Ú©Ø§Ø± state Ø§Ø² localStorage Ø¯Ø± Ø´Ø±ÙˆØ¹
            const autoRecover = loadPersistedState();
            if (autoRecover) {
                currentState = { ...currentState, ...autoRecover, progress: { ...currentState.progress, ...autoRecover.progress } };
                addLog('ğŸ”„ Ø¨Ø§Ø²ÛŒØ§Ø¨ÛŒ Ø®ÙˆØ¯Ú©Ø§Ø± Ø¯Ø± Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ ØµÙØ­Ù‡');
            } else {
                addLog('ğŸ†• state Ù¾ÛŒØ´â€ŒÙØ±Ø¶ Ø§ÙˆÙ„ÛŒÙ‡');
            }
            renderState(currentState);

            // Ø¯Ú©Ù…Ù‡â€ŒÙ‡Ø§
            document.getElementById('saveUserProgressBtn').addEventListener('click', handleSaveSampleProgress);
            document.getElementById('loadFromStorageBtn').addEventListener('click', handleLoadFromStorage);
            document.getElementById('simulatePageCloseBtn').addEventListener('click', handleSimulatePageClose);
            document.getElementById('simulateRecoveryBtn').addEventListener('click', handleSimulateRecovery);
            document.getElementById('simulateMigrationBtn').addEventListener('click', handleSimulateMigration);
            document.getElementById('clearLogBtn').addEventListener('click', function() {
                actionLog = [];
                renderLog();
                addLog('ğŸ§¹ Ù„Ø§Ú¯ Ù¾Ø§Ú© Ø´Ø¯');
            });

            // Ø¯Ú©Ù…Ù‡ Ù…Ø®ÙÛŒ Ø¨Ø±Ø§ÛŒ Ù¾Ø§Ú©Ø³Ø§Ø²ÛŒ Ú©Ø§Ù…Ù„ (Ø¨Ø§ Ø¯ÙˆØ¨Ø§Ø± Ú©Ù„ÛŒÚ© Ø±ÙˆÛŒ Ù‡Ø¯Ø±)
            let clickCount = 0;
            document.querySelector('h1').addEventListener('dblclick', function(e) {
                if (clickCount++ % 2 === 0) {
                    handleClearAll();
                }
            });
        };
    </script>
</body>
</html>
