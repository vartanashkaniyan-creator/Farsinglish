<!DOCTYPE html>
<html dir="rtl" lang="fa">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ØªØ³Øª Ù„Ø¨Ù‡â€ŒÙ‡Ø§ÛŒ State Manager</title>
    <style>
        body {
            font-family: 'Vazir', 'Tahoma', sans-serif;
            max-width: 800px;
            margin: 20px auto;
            padding: 20px;
            background: #f5f5f5;
        }
        h1 {
            color: #2c3e50;
            font-size: 1.5rem;
            border-bottom: 2px solid #3498db;
            padding-bottom: 10px;
        }
        h2 {
            font-size: 1.2rem;
            color: #34495e;
            margin-top: 25px;
        }
        .test-section {
            background: white;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            border-right: 4px solid #3498db;
        }
        .test-case {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 15px;
            margin: 15px 0;
            border: 1px solid #dee2e6;
        }
        .test-title {
            font-weight: bold;
            color: #2c3e50;
            margin-bottom: 10px;
            font-size: 1.1rem;
        }
        .test-desc {
            color: #7f8c8d;
            margin-bottom: 15px;
            font-size: 0.95rem;
            padding-right: 15px;
            border-right: 3px solid #3498db;
        }
        button {
            background: #3498db;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.95rem;
            margin: 5px 10px 5px 0;
            transition: all 0.2s;
            font-family: inherit;
        }
        button:hover {
            background: #2980b9;
            transform: translateY(-1px);
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }
        button.reset {
            background: #95a5a6;
        }
        button.reset:hover {
            background: #7f8c8d;
        }
        .console-output {
            background: #2c3e50;
            color: #2ecc71;
            padding: 15px;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            font-size: 0.9rem;
            margin-top: 15px;
            white-space: pre-wrap;
            direction: ltr;
            text-align: left;
            max-height: 200px;
            overflow-y: auto;
        }
        .success-badge {
            display: inline-block;
            background: #27ae60;
            color: white;
            padding: 3px 10px;
            border-radius: 20px;
            font-size: 0.8rem;
            margin-right: 10px;
        }
        .warning-badge {
            background: #f39c12;
            color: white;
            padding: 3px 10px;
            border-radius: 20px;
            font-size: 0.8rem;
            margin-right: 10px;
        }
        .danger-badge {
            background: #e74c3c;
            color: white;
            padding: 3px 10px;
            border-radius: 20px;
            font-size: 0.8rem;
            margin-right: 10px;
        }
        .summary-stats {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            margin: 20px 0;
        }
        .stat-box {
            background: white;
            padding: 15px 25px;
            border-radius: 10px;
            flex: 1;
            min-width: 120px;
            text-align: center;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }
        .stat-number {
            font-size: 2rem;
            font-weight: bold;
            color: #3498db;
        }
        .stat-label {
            color: #7f8c8d;
            font-size: 0.9rem;
        }
        .footer {
            text-align: center;
            margin-top: 40px;
            color: #95a5a6;
            font-size: 0.9rem;
        }
    </style>
</head>
<body>
    <h1>ğŸ§ª ØªØ³Øª Ù„Ø¨Ù‡â€ŒÙ‡Ø§ÛŒ State Manager <span class="warning-badge">Ù†Ø³Ø®Ù‡ Ø¯Ø³ØªÛŒ Ø¨Ø§ Ø¯Ú©Ù…Ù‡</span></h1>
    
    <div class="summary-stats">
        <div class="stat-box">
            <div class="stat-number" id="totalTests">0</div>
            <div class="stat-label">Ú©Ù„ ØªØ³Øªâ€ŒÙ‡Ø§</div>
        </div>
        <div class="stat-box">
            <div class="stat-number" id="passedTests">0</div>
            <div class="stat-label">Ù…ÙˆÙÙ‚</div>
        </div>
        <div class="stat-box">
            <div class="stat-number" id="failedTests">0</div>
            <div class="stat-label">Ù†Ø§Ù…ÙˆÙÙ‚</div>
        </div>
    </div>

    <div class="test-section">
        <h2>ğŸ”´ Û±. ØªØ³Øª Ù…Ù‚Ø¯Ø§Ø±Ø¯Ù‡ÛŒ Ø§ÙˆÙ„ÛŒÙ‡</h2>
        
        <div class="test-case">
            <div class="test-title">Ø¢Ø²Ù…Ø§ÛŒØ´ Û±.Û±: Ø§ÛŒØ¬Ø§Ø¯ State Manager Ø¨Ø§ initialState Ù†Ø§Ù…Ø¹ØªØ¨Ø±</div>
            <div class="test-desc">ÙˆØ±ÙˆØ¯ÛŒ: null, undefined, Ø¢Ø±Ø§ÛŒÙ‡ Ø¨Ù‡ Ø¬Ø§ÛŒ Ø¢Ø¨Ø¬Ú©Øª</div>
            <button onclick="testInvalidInitialState()">Ø§Ø¬Ø±Ø§ÛŒ ØªØ³Øª</button>
            <button class="reset" onclick="resetState()">Ø±ÛŒØ³Øª State</button>
        </div>

        <div class="test-case">
            <div class="test-title">Ø¢Ø²Ù…Ø§ÛŒØ´ Û±.Û²: Ù…Ù‚Ø¯Ø§Ø±Ø¯Ù‡ÛŒ Ø¨Ø§ initialState Ø­Ø§ÙˆÛŒ ØªÙˆØ§Ø¨Ø¹</div>
            <div class="test-desc">Ø¨Ø±Ø±Ø³ÛŒ Ø±ÙØªØ§Ø± Ø¨Ø§ Ù…Ù‚Ø§Ø¯ÛŒØ± ØºÛŒØ±Ù‚Ø§Ø¨Ù„ Ø³Ø±ÛŒØ§Ù„â€ŒØ³Ø§Ø²ÛŒ</div>
            <button onclick="testFunctionInState()">Ø§Ø¬Ø±Ø§ÛŒ ØªØ³Øª</button>
        </div>
    </div>

    <div class="test-section">
        <h2>ğŸŸ¡ Û². ØªØ³Øª Ù„Ø¨Ù‡â€ŒÙ‡Ø§ÛŒ setState</h2>
        
        <div class="test-case">
            <div class="test-title">Ø¢Ø²Ù…Ø§ÛŒØ´ Û².Û±: setState Ø¨Ø§ Ù…Ø³ÛŒØ±Ù‡Ø§ÛŒ Ù†Ø§Ù…Ø¹ØªØ¨Ø±</div>
            <div class="test-desc">Ù…Ø³ÛŒØ± Ø®Ø§Ù„ÛŒØŒ nullØŒ Ø¢Ø±Ø§ÛŒÙ‡ Ø®Ø§Ù„ÛŒØŒ Ú©Ø§Ø±Ø§Ú©ØªØ±Ù‡Ø§ÛŒ Ø®Ø§Øµ</div>
            <button onclick="testInvalidPaths()">Ø§Ø¬Ø±Ø§ÛŒ ØªØ³Øª</button>
        </div>

        <div class="test-case">
            <div class="test-title">Ø¢Ø²Ù…Ø§ÛŒØ´ Û².Û²: setState Ø¨Ø§ Ù…Ù‚Ø§Ø¯ÛŒØ± border</div>
            <div class="test-desc">NaN, Infinity, undefined, circular reference</div>
            <button onclick="testBorderValues()">Ø§Ø¬Ø±Ø§ÛŒ ØªØ³Øª</button>
        </div>

        <div class="test-case">
            <div class="test-title">Ø¢Ø²Ù…Ø§ÛŒØ´ Û².Û³: Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ø¹Ù…ÛŒÙ‚ Ø¨Ø§ path Ø·ÙˆÙ„Ø§Ù†ÛŒ</div>
            <div class="test-desc">Ù…Ø³ÛŒØ± Û±Û° Ø³Ø·Ø­ÛŒ Ùˆ Ø¨Ø±Ø±Ø³ÛŒ Ø¹Ù…Ù„Ú©Ø±Ø¯ clone Ø¹Ù…ÛŒÙ‚</div>
            <button onclick="testDeepPathUpdate()">Ø§Ø¬Ø±Ø§ÛŒ ØªØ³Øª</button>
        </div>
    </div>

    <div class="test-section">
        <h2>ğŸŸ  Û³. ØªØ³Øª Middleware</h2>
        
        <div class="test-case">
            <div class="test-title">Ø¢Ø²Ù…Ø§ÛŒØ´ Û³.Û±: middleware Ú©Ù‡ throw Ù…ÛŒâ€ŒÚ©Ù†Ø¯</div>
            <div class="test-desc">Ø¨Ø±Ø±Ø³ÛŒ Ø±ÙØªØ§Ø± Ø²Ù†Ø¬ÛŒØ±Ù‡ Ø¯Ø± Ù…ÙˆØ§Ø¬Ù‡Ù‡ Ø¨Ø§ Ø®Ø·Ø§</div>
            <button onclick="testMiddlewareThrow()">Ø§Ø¬Ø±Ø§ÛŒ ØªØ³Øª</button>
        </div>

        <div class="test-case">
            <div class="test-title">Ø¢Ø²Ù…Ø§ÛŒØ´ Û³.Û²: middleware Ù†Ø§Ù…Ù†Ø¸Ù…</div>
            <div class="test-desc">Ø®Ø±ÙˆØ¬ÛŒ ØºÛŒØ±Ø¢Ø¨Ø¬Ú©ØªØŒ ØªØºÛŒÛŒØ± Ù…Ø³ÛŒØ±ØŒ Ø§Ø¬Ø±Ø§ÛŒ Ù†Ø§Ù‡Ù…Ú¯Ø§Ù…</div>
            <button onclick="testMalformedMiddleware()">Ø§Ø¬Ø±Ø§ÛŒ ØªØ³Øª</button>
        </div>

        <div class="test-case">
            <div class="test-title">Ø¢Ø²Ù…Ø§ÛŒØ´ Û³.Û³: middleware Ø¨Ø§ ØªØ±ØªÛŒØ¨ ÙˆØ§Ø¨Ø³ØªÙ‡</div>
            <div class="test-desc">Ø¨Ø±Ø±Ø³ÛŒ ÙˆØ§Ø¨Ø³ØªÚ¯ÛŒ Ø¨Ù‡ ØªØ±ØªÛŒØ¨ Ø§Ø¬Ø±Ø§</div>
            <button onclick="testMiddlewareOrder()">Ø§Ø¬Ø±Ø§ÛŒ ØªØ³Øª</button>
        </div>
    </div>

    <div class="test-section">
        <h2>ğŸ”µ Û´. ØªØ³Øª Listener</h2>
        
        <div class="test-case">
            <div class="test-title">Ø¢Ø²Ù…Ø§ÛŒØ´ Û´.Û±: listener Ú©Ù‡ Ø®Ø·Ø§ Ù…ÛŒâ€ŒØ¯Ù‡Ø¯</div>
            <div class="test-desc">ØªØ£Ø«ÛŒØ± listener Ø®Ø±Ø§Ø¨ Ø±ÙˆÛŒ Ø¨Ù‚ÛŒÙ‡</div>
            <button onclick="testListenerError()">Ø§Ø¬Ø±Ø§ÛŒ ØªØ³Øª</button>
        </div>

        <div class="test-case">
            <div class="test-title">Ø¢Ø²Ù…Ø§ÛŒØ´ Û´.Û²: unsubscribe Ù…Ú©Ø±Ø± Ùˆ Ù†Ø§Ù…Ø¹ØªØ¨Ø±</div>
            <div class="test-desc">unsubscribe ÛŒÚ© listener Ú†Ù†Ø¯ Ø¨Ø§Ø±</div>
            <button onclick="testInvalidUnsubscribe()">Ø§Ø¬Ø±Ø§ÛŒ ØªØ³Øª</button>
        </div>
    </div>

    <div class="test-section">
        <h2>ğŸŸ£ Ûµ. ØªØ³Øª Persistence</h2>
        
        <div class="test-case">
            <div class="test-title">Ø¢Ø²Ù…Ø§ÛŒØ´ Ûµ.Û±: Ø¯Ø§Ø¯Ù‡ Ø®Ø±Ø§Ø¨ Ø¯Ø± localStorage</div>
            <div class="test-desc">JSON Ù†Ø§Ù…Ø¹ØªØ¨Ø±ØŒ type mismatch</div>
            <button onclick="testCorruptedStorage()">Ø§Ø¬Ø±Ø§ÛŒ ØªØ³Øª</button>
        </div>

        <div class="test-case">
            <div class="test-title">Ø¢Ø²Ù…Ø§ÛŒØ´ Ûµ.Û²: Ø­Ø§ÙØ¸Ù‡ Ù¾Ø±/ØºÛŒØ±Ù‚Ø§Ø¨Ù„ Ù†ÙˆØ´ØªÙ†</div>
            <div class="test-desc">Ø´Ø¨ÛŒÙ‡â€ŒØ³Ø§Ø²ÛŒ Ø®Ø·Ø§ÛŒ QuotaExceeded</div>
            <button onclick="testStorageQuota()">Ø§Ø¬Ø±Ø§ÛŒ ØªØ³Øª</button>
        </div>
    </div>

    <div class="test-section">
        <h2>âš« Û¶. ØªØ³Øª Ù‡Ù…Ø²Ù…Ø§Ù†ÛŒ</h2>
        
        <div class="test-case">
            <div class="test-title">Ø¢Ø²Ù…Ø§ÛŒØ´ Û¶.Û±: setState Ù‡Ù…Ø²Ù…Ø§Ù†</div>
            <div class="test-desc">Û±Û°Û°Û° Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ù‡Ù…Ø²Ù…Ø§Ù† (Ø´Ø¨ÛŒÙ‡â€ŒØ³Ø§Ø²ÛŒ Ø´Ø¯Ù‡)</div>
            <button onclick="testConcurrentUpdates()">Ø§Ø¬Ø±Ø§ÛŒ ØªØ³Øª</button>
        </div>

        <div class="test-case">
            <div class="test-title">Ø¢Ø²Ù…Ø§ÛŒØ´ Û¶.Û²: getState Ø¯Ø± Ø­ÛŒÙ† setState</div>
            <div class="test-desc">Ø¨Ø±Ø±Ø³ÛŒ consistency</div>
            <button onclick="testGetDuringSet()">Ø§Ø¬Ø±Ø§ÛŒ ØªØ³Øª</button>
        </div>
    </div>

    <div class="console-output" id="console">
>>> Ù…Ù†ØªØ¸Ø± Ø§Ø¬Ø±Ø§ÛŒ ØªØ³Øªâ€ŒÙ‡Ø§...
    </div>

    <div class="footer">
        ğŸ§ª ØªØ³Øª Ù„Ø¨Ù‡â€ŒÙ‡Ø§ÛŒ State Manager | Ø·Ø±Ø§Ø­ÛŒ Ø¯Ø³ØªÛŒ Ø¨Ø§ Ø¯Ú©Ù…Ù‡ Ø¨Ø±Ø§ÛŒ Ø§Ø¬Ø±Ø§ÛŒ Ú©Ù†ØªØ±Ù„â€ŒØ´Ø¯Ù‡
    </div>

    <script>
        // ---------- State Manager Ù¾ÛŒØ§Ø¯Ù‡â€ŒØ³Ø§Ø²ÛŒ Ø³Ø§Ø¯Ù‡ ----------
        class StateManager {
            constructor(initialState = {}) {
                this._state = this._deepClone(initialState);
                this._listeners = [];
                this._middlewares = [];
                this._id = Math.random();
            }

            use(middleware) {
                if (typeof middleware === 'function') {
                    this._middlewares.push(middleware);
                }
                return this;
            }

            getState(path = null) {
                if (path === null) return this._deepClone(this._state);
                
                try {
                    const parts = Array.isArray(path) ? path : path.split('.');
                    let value = this._state;
                    for (const part of parts) {
                        if (value === null || value === undefined) return undefined;
                        value = value[part];
                    }
                    return this._deepClone(value);
                } catch (e) {
                    return undefined;
                }
            }

            setState(path, value) {
                // Ø§Ø¹Ù…Ø§Ù„ middlewareÙ‡Ø§
                let modifiedPath = path;
                let modifiedValue = value;
                
                for (const mw of this._middlewares) {
                    try {
                        const result = mw(modifiedPath, modifiedValue, this._state);
                        if (result && typeof result === 'object') {
                            modifiedPath = result.path ?? modifiedPath;
                            modifiedValue = result.value ?? modifiedValue;
                        }
                    } catch (e) {
                        console.error('Middleware error:', e);
                    }
                }

                // clone Ø¹Ù…ÛŒÙ‚
                const newState = this._deepClone(this._state);
                
                // Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ø¯Ø± Ù…Ø³ÛŒØ± Ù…Ø´Ø®Øµ
                try {
                    const parts = Array.isArray(modifiedPath) ? modifiedPath : modifiedPath.split('.');
                    let current = newState;
                    for (let i = 0; i < parts.length - 1; i++) {
                        const part = parts[i];
                        if (!current[part] || typeof current[part] !== 'object') {
                            current[part] = {};
                        }
                        current = current[part];
                    }
                    const lastPart = parts[parts.length - 1];
                    current[lastPart] = this._deepClone(modifiedValue);
                } catch (e) {
                    console.error('SetState error:', e);
                    return false;
                }

                // Ø§Ø¹Ù…Ø§Ù„ ØªØºÛŒÛŒØ±
                this._state = newState;
                
                // Ø§Ø·Ù„Ø§Ø¹ Ø¨Ù‡ listenerÙ‡Ø§
                this._notifyListeners(path, value);
                return true;
            }

            subscribe(listener) {
                if (typeof listener !== 'function') return () => {};
                this._listeners.push(listener);
                return () => {
                    this._listeners = this._listeners.filter(l => l !== listener);
                };
            }

            reset() {
                this._state = {};
                this._notifyListeners('reset', null);
            }

            _notifyListeners(path, value) {
                for (const listener of this._listeners) {
                    try {
                        listener(path, value, this._deepClone(this._state));
                    } catch (e) {
                        console.error('Listener error:', e);
                    }
                }
            }

            _deepClone(obj) {
                if (obj === null || obj === undefined) return obj;
                if (typeof obj !== 'object') return obj;
                if (obj instanceof Date) return new Date(obj);
                if (Array.isArray(obj)) return obj.map(item => this._deepClone(item));
                
                const cloned = {};
                for (const key in obj) {
                    if (Object.prototype.hasOwnProperty.call(obj, key)) {
                        cloned[key] = this._deepClone(obj[key]);
                    }
                }
                return cloned;
            }
        }

        // ---------- State Manager Global Ø¨Ø±Ø§ÛŒ ØªØ³Øª ----------
        let manager = new StateManager({
            user: { name: 'test', level: 1 },
            settings: { theme: 'dark', notifications: true },
            progress: {
                lessons: {
                    '1': { completed: false, score: 0 },
                    '2': { completed: true, score: 85 }
                },
                deep: {
                    level1: {
                        level2: {
                            level3: {
                                level4: {
                                    level5: {
                                        level6: {
                                            level7: {
                                                level8: {
                                                    level9: {
                                                        value: 'Ø¹Ù…ÛŒÙ‚'
                                                    }
                                                }
                                            }
                                        }
                                    }
                                }
                            }
                        }
                    }
                }
            }
        });

        let consoleElement = document.getElementById('console');
        let totalTests = 0;
        let passedTests = 0;
        
        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString('fa-IR');
            const prefix = type === 'success' ? 'âœ…' : (type === 'error' ? 'âŒ' : 'â¡ï¸');
            consoleElement.innerHTML += `\n[${timestamp}] ${prefix} ${message}`;
            consoleElement.scrollTop = consoleElement.scrollHeight;
        }

        function clearLog() {
            consoleElement.innerHTML = '>>> Ù„Ø§Ú¯ ØªØ³Øªâ€ŒÙ‡Ø§:\n';
        }

        function updateStats() {
            document.getElementById('totalTests').innerText = totalTests;
            document.getElementById('passedTests').innerText = passedTests;
            document.getElementById('failedTests').innerText = totalTests - passedTests;
        }

        function resetState() {
            manager = new StateManager({
                user: { name: 'test', level: 1 },
                settings: { theme: 'dark', notifications: true },
                progress: {
                    lessons: {
                        '1': { completed: false, score: 0 },
                        '2': { completed: true, score: 85 }
                    },
                    deep: {
                        level1: {
                            level2: {
                                level3: {
                                    level4: {
                                        level5: {
                                            level6: {
                                                level7: {
                                                    level8: {
                                                        level9: {
                                                            value: 'Ø¹Ù…ÛŒÙ‚'
                                                        }
                                                    }
                                                }
                                            }
                                        }
                                    }
                                }
                            }
                        }
                    }
                }
            });
            clearLog();
            log('State Ø±ÛŒØ³Øª Ø´Ø¯.', 'success');
        }

        // ---------- ØªØ³Øªâ€ŒÙ‡Ø§ ----------
        function testInvalidInitialState() {
            clearLog();
            totalTests++; 
            log('Ø¢Ø²Ù…Ø§ÛŒØ´ Û±.Û±: Ù…Ù‚Ø¯Ø§Ø±Ø¯Ù‡ÛŒ Ø¨Ø§ initialState Ù†Ø§Ù…Ø¹ØªØ¨Ø±');
            
            try {
                const m1 = new StateManager(null);
                log('âœ“ Ø§ÛŒØ¬Ø§Ø¯ Ø¨Ø§ null: Ù…ÙˆÙÙ‚', 'success');
                
                const m2 = new StateManager(undefined);
                log('âœ“ Ø§ÛŒØ¬Ø§Ø¯ Ø¨Ø§ undefined: Ù…ÙˆÙÙ‚', 'success');
                
                const m3 = new StateManager([1,2,3]);
                log('âœ“ Ø§ÛŒØ¬Ø§Ø¯ Ø¨Ø§ Ø¢Ø±Ø§ÛŒÙ‡: Ù…ÙˆÙÙ‚', 'success');
                
                const m4 = new StateManager(() => {});
                log('âœ“ Ø§ÛŒØ¬Ø§Ø¯ Ø¨Ø§ ØªØ§Ø¨Ø¹: Ù…ÙˆÙÙ‚', 'success');
                
                passedTests++;
                log('âœ… Ù‡Ù…Ù‡ Ù…ÙˆØ§Ø±Ø¯ Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø§ÛŒØ¬Ø§Ø¯ Ø´Ø¯Ù†Ø¯.', 'success');
            } catch (e) {
                log('âŒ Ø®Ø·Ø§: ' + e.message, 'error');
            }
            updateStats();
        }

        function testFunctionInState() {
            clearLog();
            totalTests++;
            log('Ø¢Ø²Ù…Ø§ÛŒØ´ Û±.Û²: initialState Ø­Ø§ÙˆÛŒ ØªØ§Ø¨Ø¹');
            
            try {
                const m = new StateManager({
                    normal: 'value',
                    func: function() { return 'test'; },
                    arrowFunc: () => 'test'
                });
                
                const state = m.getState();
                log('typeof func: ' + typeof state.func, 'info');
                log('typeof arrowFunc: ' + typeof state.arrowFunc, 'info');
                
                if (typeof state.func === 'function' && typeof state.arrowFunc === 'function') {
                    passedTests++;
                    log('âœ… ØªÙˆØ§Ø¨Ø¹ Ø¯Ø± state Ø­ÙØ¸ Ø´Ø¯Ù†Ø¯.', 'success');
                } else {
                    log('âš ï¸ ØªÙˆØ§Ø¨Ø¹ Ú©Ù„ÙˆÙ† Ù†Ø´Ø¯Ù†Ø¯.', 'warning');
                }
            } catch (e) {
                log('âŒ Ø®Ø·Ø§: ' + e.message, 'error');
            }
            updateStats();
        }

        function testInvalidPaths() {
            clearLog();
            totalTests++;
            log('Ø¢Ø²Ù…Ø§ÛŒØ´ Û².Û±: setState Ø¨Ø§ Ù…Ø³ÛŒØ± Ù†Ø§Ù…Ø¹ØªØ¨Ø±');
            
            try {
                const results = [];
                
                // Ù…Ø³ÛŒØ± Ø®Ø§Ù„ÛŒ
                results.push(manager.setState('', 'value'));
                log('Ù…Ø³ÛŒØ± Ø®Ø§Ù„ÛŒ: ' + results[0], 'info');
                
                // Ù…Ø³ÛŒØ± null
                results.push(manager.setState(null, 'value'));
                log('Ù…Ø³ÛŒØ± null: ' + results[1], 'info');
                
                // Ù…Ø³ÛŒØ± Ø¨Ø§ Ú©Ø§Ø±Ø§Ú©ØªØ± Ø®Ø§Øµ
                results.push(manager.setState('user..name', 'test'));
                log('Ù…Ø³ÛŒØ± Ø¨Ø§ Ù†Ù‚Ø·Ù‡ ØªÚ©Ø±Ø§Ø±ÛŒ: ' + results[2], 'info');
                
                // Ù…Ø³ÛŒØ± Ø¨Ø³ÛŒØ§Ø± Ø·ÙˆÙ„Ø§Ù†ÛŒ
                const longPath = 'a.b.c.d.e.f.g.h.i.j.k.l.m.n.o.p';
                results.push(manager.setState(longPath, 'value'));
                log('Ù…Ø³ÛŒØ± Ø·ÙˆÙ„Ø§Ù†ÛŒ: ' + results[3], 'info');
                
                const successCount = results.filter(r => r === true).length;
                if (successCount > 0) {
                    passedTests++;
                    log(`âœ… ${successCount} Ù…ÙˆØ±Ø¯ Ø§Ø² Ù…Ø³ÛŒØ±Ù‡Ø§ Ú©Ø§Ø± Ú©Ø±Ø¯.`, 'success');
                } else {
                    log('âš ï¸ Ù‡ÛŒÚ† Ù…Ø³ÛŒØ±ÛŒ Ú©Ø§Ø± Ù†Ú©Ø±Ø¯.', 'warning');
                }
            } catch (e) {
                log('âŒ Ø®Ø·Ø§: ' + e.message, 'error');
            }
            updateStats();
        }

        function testBorderValues() {
            clearLog();
            totalTests++;
            log('Ø¢Ø²Ù…Ø§ÛŒØ´ Û².Û²: setState Ø¨Ø§ Ù…Ù‚Ø§Ø¯ÛŒØ± border');
            
            try {
                manager.setState('test.nan', NaN);
                manager.setState('test.infinity', Infinity);
                manager.setState('test.undefined', undefined);
                manager.setState('test.null', null);
                
                const state = manager.getState('test');
                log('NaN: ' + state.nan, 'info');
                log('Infinity: ' + state.infinity, 'info');
                log('undefined: ' + state.undefined, 'info');
                log('null: ' + state.null, 'info');
                
                passedTests++;
                log('âœ… Ù‡Ù…Ù‡ Ù…Ù‚Ø§Ø¯ÛŒØ± border Ø°Ø®ÛŒØ±Ù‡ Ø´Ø¯Ù†Ø¯.', 'success');
            } catch (e) {
                log('âŒ Ø®Ø·Ø§: ' + e.message, 'error');
            }
            updateStats();
        }

        function testDeepPathUpdate() {
            clearLog();
            totalTests++;
            log('Ø¢Ø²Ù…Ø§ÛŒØ´ Û².Û³: Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ø¹Ù…ÛŒÙ‚');
            
            try {
                const before = manager.getState('progress.deep.level1.level2.level3.level4.level5.level6.level7.level8.level9.value');
                log('Ù…Ù‚Ø¯Ø§Ø± Ù‚Ø¨Ù„: ' + before, 'info');
                
                manager.setState('progress.deep.level1.level2.level3.level4.level5.level6.level7.level8.level9.value', 'ØªØºÛŒÛŒØ± Ø¹Ù…ÛŒÙ‚');
                
                const after = manager.getState('progress.deep.level1.level2.level3.level4.level5.level6.level7.level8.level9.value');
                log('Ù…Ù‚Ø¯Ø§Ø± Ø¨Ø¹Ø¯: ' + after, 'info');
                
                if (after === 'ØªØºÛŒÛŒØ± Ø¹Ù…ÛŒÙ‚') {
                    passedTests++;
                    log('âœ… Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ø¹Ù…ÛŒÙ‚ Ù…ÙˆÙÙ‚.', 'success');
                } else {
                    log('âŒ Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ø¹Ù…ÛŒÙ‚ Ù†Ø§Ù…ÙˆÙÙ‚.', 'error');
                }
            } catch (e) {
                log('âŒ Ø®Ø·Ø§: ' + e.message, 'error');
            }
            updateStats();
        }

        function testMiddlewareThrow() {
            clearLog();
            totalTests++;
            log('Ø¢Ø²Ù…Ø§ÛŒØ´ Û³.Û±: middleware Ù¾Ø±ØªØ§Ø¨â€ŒÚ©Ù†Ù†Ø¯Ù‡ Ø®Ø·Ø§');
            
            const testManager = new StateManager({ count: 0 });
            
            testManager.use((path, value, state) => {
                throw new Error('Middleware Ø®Ø·Ø§ Ø¯Ø§Ø¯!');
            });
            
            testManager.use((path, value, state) => {
                log('Ù…ÛŒØ§Ù†â€ŒØ§ÙØ²Ø§Ø± Ø¯ÙˆÙ… Ø§Ø¬Ø±Ø§ Ø´Ø¯.', 'info');
                return { value: value + 1 };
            });
            
            try {
                testManager.setState('count', 5);
                const result = testManager.getState('count');
                log('Ù…Ù‚Ø¯Ø§Ø± Ù†Ù‡Ø§ÛŒÛŒ count: ' + result, 'info');
                
                if (result === 6) {
                    passedTests++;
                    log('âœ… Ù…ÛŒØ§Ù†â€ŒØ§ÙØ²Ø§Ø± Ø¯ÙˆÙ… Ø¨Ø¹Ø¯ Ø§Ø² Ø®Ø·Ø§ Ù‡Ù… Ø§Ø¬Ø±Ø§ Ø´Ø¯.', 'success');
                } else {
                    log('âš ï¸ Ù…ÛŒØ§Ù†â€ŒØ§ÙØ²Ø§Ø± Ø¯ÙˆÙ… Ø§Ø¬Ø±Ø§ Ù†Ø´Ø¯.', 'warning');
                }
            } catch (e) {
                log('âŒ Ø®Ø·Ø§: ' + e.message, 'error');
            }
            updateStats();
        }

        function testMalformedMiddleware() {
            clearLog();
            totalTests++;
            log('Ø¢Ø²Ù…Ø§ÛŒØ´ Û³.Û²: middleware Ø¨Ø§ Ø®Ø±ÙˆØ¬ÛŒ Ù†Ø§Ù…Ù†Ø¸Ù…');
            
            const testManager = new StateManager({ value: 0 });
            
            testManager.use(() => 'string');
            testManager.use(() => 123);
            testManager.use(() => null);
            testManager.use(() => {
                // ØªØºÛŒÛŒØ± Ù…Ø³ØªÙ‚ÛŒÙ… state Ù…Ù…Ù†ÙˆØ¹!
                testManager._state.value = 999;
                return { value: 100 };
            });
            
            try {
                testManager.setState('value', 5);
                const result = testManager.getState('value');
                log('Ù…Ù‚Ø¯Ø§Ø± Ù†Ù‡Ø§ÛŒÛŒ: ' + result, 'info');
                
                if (result === 5) {
                    passedTests++;
                    log('âœ… middleware Ù†Ø§Ù…Ù†Ø¸Ù… ØªØ£Ø«ÛŒØ±ÛŒ Ù†Ø¯Ø§Ø´Øª.', 'success');
                } else {
                    log('âš ï¸ middleware Ù†Ø§Ù…Ù†Ø¸Ù… state Ø±Ø§ Ø®Ø±Ø§Ø¨ Ú©Ø±Ø¯.', 'warning');
                }
            } catch (e) {
                log('âŒ Ø®Ø·Ø§: ' + e.message, 'error');
            }
            updateStats();
        }

        function testMiddlewareOrder() {
            clearLog();
            totalTests++;
            log('Ø¢Ø²Ù…Ø§ÛŒØ´ Û³.Û³: ØªØ±ØªÛŒØ¨ middleware');
            
            const testManager = new StateManager({ value: 0 });
            const order = [];
            
            testManager.use((path, value) => {
                order.push(1);
                return { value: value + 1 };
            });
            
            testManager.use((path, value) => {
                order.push(2);
                return { value: value * 2 };
            });
            
            testManager.use((path, value) => {
                order.push(3);
                return { value: value - 3 };
            });
            
            testManager.setState('value', 5);
            const result = testManager.getState('value');
            
            log('ØªØ±ØªÛŒØ¨ Ø§Ø¬Ø±Ø§: ' + order.join(' â†’ '), 'info');
            log('Ù†ØªÛŒØ¬Ù‡ Ù†Ù‡Ø§ÛŒÛŒ: ' + result, 'info');
            
            if (order[0] === 1 && order[1] === 2 && order[2] === 3) {
                passedTests++;
                log('âœ… ØªØ±ØªÛŒØ¨ middleware Ø±Ø¹Ø§ÛŒØª Ø´Ø¯.', 'success');
            } else {
                log('âŒ ØªØ±ØªÛŒØ¨ middleware Ø±Ø¹Ø§ÛŒØª Ù†Ø´Ø¯.', 'error');
            }
            updateStats();
        }

        function testListenerError() {
            clearLog();
            totalTests++;
            log('Ø¢Ø²Ù…Ø§ÛŒØ´ Û´.Û±: listener Ø®Ø·Ø§Ø¯Ø§Ø±');
            
            const testManager = new StateManager({ count: 0 });
            let healthyListenerCalled = false;
            
            testManager.subscribe(() => {
                throw new Error('Ø®Ø·Ø§ Ø§Ø² listener Ø§ÙˆÙ„');
            });
            
            testManager.subscribe(() => {
                healthyListenerCalled = true;
                log('listener Ø¯ÙˆÙ… Ø³Ø§Ù„Ù… Ø§Ø¬Ø±Ø§ Ø´Ø¯.', 'success');
            });
            
            try {
                testManager.setState('count', 1);
                
                if (healthyListenerCalled) {
                    passedTests++;
                    log('âœ… listener Ø¯ÙˆÙ… Ø¨Ø¹Ø¯ Ø§Ø² Ø®Ø·Ø§ Ù‡Ù… Ø§Ø¬Ø±Ø§ Ø´Ø¯.', 'success');
                } else {
                    log('âš ï¸ listener Ø¯ÙˆÙ… Ø§Ø¬Ø±Ø§ Ù†Ø´Ø¯.', 'warning');
                }
            } catch (e) {
                log('âŒ Ø®Ø·Ø§: ' + e.message, 'error');
            }
            updateStats();
        }

        function testInvalidUnsubscribe() {
            clearLog();
            totalTests++;
            log('Ø¢Ø²Ù…Ø§ÛŒØ´ Û´.Û²: unsubscribe Ù†Ø§Ù…Ø¹ØªØ¨Ø±');
            
            const testManager = new StateManager({});
            let callCount = 0;
            
            const unsubscribe = testManager.subscribe(() => {
                callCount++;
            });
            
            // unsubscribe Ú†Ù†Ø¯Ø¨Ø§Ø±
            unsubscribe();
            unsubscribe();
            unsubscribe();
            
            testManager.setState('test', 'value');
            
            if (callCount === 0) {
                passedTests++;
                log('âœ… unsubscribe Ù…Ú©Ø±Ø± Ù…Ø´Ú©Ù„ Ø§ÛŒØ¬Ø§Ø¯ Ù†Ú©Ø±Ø¯.', 'success');
            } else {
                log('âš ï¸ listener Ù‡Ù†ÙˆØ² ÙØ¹Ø§Ù„ Ø§Ø³Øª.', 'warning');
            }
            updateStats();
        }

        function testCorruptedStorage() {
            clearLog();
            totalTests++;
            log('Ø¢Ø²Ù…Ø§ÛŒØ´ Ûµ.Û±: Ø¯Ø§Ø¯Ù‡ Ø®Ø±Ø§Ø¨ Ø¯Ø± localStorage');
            
            try {
                // Ø´Ø¨ÛŒÙ‡â€ŒØ³Ø§Ø²ÛŒ Ø¯Ø§Ø¯Ù‡ Ø®Ø±Ø§Ø¨
                localStorage.setItem('corrupt', '{name: "test"');
                localStorage.setItem('invalid', 'undefined');
                
                const corruptData = localStorage.getItem('corrupt');
                log('Ø¯Ø§Ø¯Ù‡ Ø®Ø±Ø§Ø¨: ' + corruptData, 'info');
                
                let parsed = null;
                try {
                    parsed = JSON.parse(corruptData);
                } catch (e) {
                    log('âœ“ Ø®Ø·Ø§ÛŒ JSON Ø´Ù†Ø§Ø³Ø§ÛŒÛŒ Ø´Ø¯.', 'success');
                }
                
                passedTests++;
                log('âœ… localStorage Ø®Ø±Ø§Ø¨ Ø¨Ø§Ø¹Ø« Ú©Ø±Ø´ Ù†Ø´Ø¯.', 'success');
            } catch (e) {
                log('âŒ Ø®Ø·Ø§: ' + e.message, 'error');
            }
            updateStats();
        }

        function testStorageQuota() {
            clearLog();
            totalTests++;
            log('Ø¢Ø²Ù…Ø§ÛŒØ´ Ûµ.Û²: Ø´Ø¨ÛŒÙ‡â€ŒØ³Ø§Ø²ÛŒ QuotaExceeded');
            
            try {
                // Ø´Ø¨ÛŒÙ‡â€ŒØ³Ø§Ø²ÛŒ quota exceeded
                let quotaError = false;
                try {
                    const bigString = 'x'.repeat(10 * 1024 * 1024); // 10MB
                    localStorage.setItem('big', bigString);
                } catch (e) {
                    if (e.name === 'QuotaExceededError' || e.code === 22) {
                        quotaError = true;
                        log('âœ“ Ø®Ø·Ø§ÛŒ QuotaExceeded Ø´Ù†Ø§Ø³Ø§ÛŒÛŒ Ø´Ø¯.', 'success');
                    }
                }
                
                if (quotaError) {
                    passedTests++;
                } else {
                    log('âš ï¸ Ø®Ø·Ø§ÛŒ quota Ø±Ø® Ù†Ø¯Ø§Ø¯ (Ù…Ø±ÙˆØ±Ú¯Ø± ÙØ¶Ø§ Ø¯Ø§Ø±Ø¯)', 'warning');
                }
            } catch (e) {
                log('âŒ Ø®Ø·Ø§: ' + e.message, 'error');
            }
            updateStats();
        }

        function testConcurrentUpdates() {
            clearLog();
            totalTests++;
            log('Ø¢Ø²Ù…Ø§ÛŒØ´ Û¶.Û±: Û±Û°Û°Û° Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ù‡Ù…Ø²Ù…Ø§Ù†');
            
            const testManager = new StateManager({ counter: 0 });
            const start = performance.now();
            
            for (let i = 0; i < 1000; i++) {
                testManager.setState('counter', i);
            }
            
            const end = performance.now();
            const duration = (end - start).toFixed(2);
            
            log(`Ø²Ù…Ø§Ù† Ø§Ø¬Ø±Ø§: ${duration}ms`, 'info');
            log(`Ù…Ù‚Ø¯Ø§Ø± Ù†Ù‡Ø§ÛŒÛŒ: ${testManager.getState('counter')}`, 'info');
            
            passedTests++;
            log('âœ… Û±Û°Û°Û° Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ù‡Ù…Ø²Ù…Ø§Ù† Ù¾Ø±Ø¯Ø§Ø²Ø´ Ø´Ø¯.', 'success');
            updateStats();
        }

        function testGetDuringSet() {
            clearLog();
            totalTests++;
            log('Ø¢Ø²Ù…Ø§ÛŒØ´ Û¶.Û²: getState Ø¯Ø± Ø­ÛŒÙ† setState');
            
            const testManager = new StateManager({ value: 0 });
            
            testManager.subscribe((path, value, state) => {
                const current = testManager.getState('value');
                log(`Ø¯Ø± listener: Ù…Ù‚Ø¯Ø§Ø± ÙØ¹Ù„ÛŒ = ${current}`, 'info');
            });
            
            testManager.setState('value', 5);
            testManager.setState('value', 10);
            testManager.setState('value', 15);
            
            passedTests++;
            log('âœ… getState Ø¯Ø± listener Ø¨Ø¯ÙˆÙ† Ù…Ø´Ú©Ù„ Ú©Ø§Ø± Ú©Ø±Ø¯.', 'success');
            updateStats();
        }

        // Ø§Ø¬Ø±Ø§ÛŒ Ø³Ø±ÛŒØ¹ Ú†Ù†Ø¯ ØªØ³Øª Ù¾Ø§ÛŒÙ‡
        log('âœ… State Manager Ø¨Ø±Ø§ÛŒ ØªØ³Øª Ø¢Ù…Ø§Ø¯Ù‡ Ø§Ø³Øª.', 'success');
        updateStats();
    </script>
</body>
  </html>
