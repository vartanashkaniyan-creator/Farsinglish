<!DOCTYPE html>
<html lang="fa">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Farsinglish - ØªØ³Øª Ù…Ø³ÛŒØ±ÛŒØ§Ø¨ÛŒ Ùˆ Navigation Guards</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif;
            background: linear-gradient(135deg, #2c3e50 0%, #4a6491 100%);
            color: #f5f5f5;
            min-height: 100vh;
            padding: 15px;
        }
        .container { 
            max-width: 850px; 
            margin: 0 auto;
            background: rgba(40, 44, 52, 0.95);
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.4);
            border: 1px solid rgba(100, 120, 150, 0.3);
        }
        h1 { 
            text-align: center; 
            margin-bottom: 25px;
            font-size: 1.8rem;
            color: #61dafb;
            text-shadow: 0 2px 5px rgba(0,0,0,0.5);
        }
        .test-section { 
            margin: 18px 0;
            padding: 16px;
            background: rgba(50, 55, 65, 0.8);
            border-radius: 10px;
            border-left: 4px solid #ffa726;
            transition: all 0.3s;
        }
        .test-section:hover {
            background: rgba(60, 65, 75, 0.9);
            transform: translateY(-2px);
        }
        .test-header { 
            display: flex; 
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
            flex-wrap: wrap;
        }
        .test-title { 
            font-size: 1rem; 
            font-weight: 600;
            color: #bb86fc;
            flex: 1;
        }
        .test-result { 
            padding: 5px 12px;
            border-radius: 12px;
            font-size: 0.8rem;
            font-weight: bold;
            min-width: 80px;
            text-align: center;
        }
        .pass { background: linear-gradient(45deg, #00c853, #64dd17); }
        .fail { background: linear-gradient(45deg, #d50000, #ff5252); }
        .details { 
            margin-top: 10px;
            padding: 12px;
            background: rgba(30, 35, 45, 0.9);
            border-radius: 8px;
            font-family: 'Consolas', monospace;
            font-size: 0.85rem;
            color: #a5d6a7;
            border: 1px solid rgba(80, 100, 120, 0.3);
            word-break: break-all;
            max-height: 200px;
            overflow-y: auto;
            white-space: pre-wrap;
        }
        .summary {
            margin-top: 25px;
            padding: 18px;
            background: rgba(35, 40, 50, 0.9);
            border-radius: 10px;
            text-align: center;
            font-size: 1rem;
            border: 1px solid rgba(100, 150, 200, 0.3);
        }
        button {
            background: linear-gradient(45deg, #2196f3, #21cbf3);
            color: white;
            border: none;
            padding: 10px 22px;
            border-radius: 8px;
            font-size: 0.9rem;
            cursor: pointer;
            margin: 6px;
            transition: all 0.3s;
            font-weight: 600;
        }
        button:hover { 
            transform: translateY(-2px); 
            box-shadow: 0 5px 15px rgba(33, 150, 243, 0.4);
        }
        .controls { text-align: center; margin-top: 20px; }
        .route-tag {
            display: inline-block;
            padding: 3px 8px;
            border-radius: 6px;
            font-size: 0.7rem;
            margin-left: 8px;
            background: rgba(97, 218, 251, 0.2);
            color: #61dafb;
            font-family: monospace;
        }
        .simulation-area {
            margin-top: 20px;
            padding: 15px;
            background: rgba(30, 35, 45, 0.9);
            border-radius: 10px;
            border: 1px dashed rgba(100, 150, 200, 0.4);
        }
        .simulation-controls {
            display: flex;
            gap: 10px;
            margin-top: 10px;
            flex-wrap: wrap;
        }
        .sim-btn {
            background: rgba(76, 175, 80, 0.2);
            border: 1px solid #4caf50;
            color: #4caf50;
            padding: 8px 15px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.85rem;
        }
        .sim-btn:hover {
            background: rgba(76, 175, 80, 0.4);
        }
        .current-route {
            font-family: monospace;
            color: #ffa726;
            margin-top: 10px;
            padding: 8px;
            background: rgba(0,0,0,0.3);
            border-radius: 6px;
        }
        @media (max-width: 600px) {
            .container { padding: 12px; }
            h1 { font-size: 1.5rem; }
            .test-header { flex-direction: column; align-items: flex-start; }
            .test-title { margin-bottom: 8px; }
            .simulation-controls { flex-direction: column; }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ§­ ØªØ³Øª Ù…Ø³ÛŒØ±ÛŒØ§Ø¨ÛŒ Ùˆ Navigation Guards - Farsinglish</h1>
        
        <div class="simulation-area">
            <h3>ğŸ® Ø´Ø¨ÛŒÙ‡â€ŒØ³Ø§Ø² Ù…Ø³ÛŒØ±ÛŒØ§Ø¨ÛŒ</h3>
            <div class="simulation-controls" id="sim-controls">
                <!-- Ø¯Ú©Ù…Ù‡â€ŒÙ‡Ø§ÛŒ Ø´Ø¨ÛŒÙ‡â€ŒØ³Ø§Ø²ÛŒ Ø§ÛŒÙ†Ø¬Ø§ Ø³Ø§Ø®ØªÙ‡ Ù…ÛŒâ€ŒØ´ÙˆÙ†Ø¯ -->
            </div>
            <div class="current-route">
                Ù…Ø³ÛŒØ± ÙØ¹Ù„ÛŒ: <span id="current-route">/</span>
            </div>
            <div class="current-route">
                ÙˆØ¶Ø¹ÛŒØª Ú©Ø§Ø±Ø¨Ø±: <span id="user-status">âŒ Ù„Ø§Ú¯ÛŒÙ† Ù†Ø´Ø¯Ù‡</span>
            </div>
        </div>
        
        <div id="test-results">
            <!-- Ù†ØªØ§ÛŒØ¬ ØªØ³Øªâ€ŒÙ‡Ø§ Ø§ÛŒÙ†Ø¬Ø§ Ù†Ù…Ø§ÛŒØ´ Ø¯Ø§Ø¯Ù‡ Ù…ÛŒâ€ŒØ´ÙˆÙ†Ø¯ -->
        </div>
        
        <div class="summary">
            <p id="summary-text">Ø¢Ù…Ø§Ø¯Ù‡ Ø§Ø¬Ø±Ø§ÛŒ Û±Û´ ØªØ³Øª Ù…Ø³ÛŒØ±ÛŒØ§Ø¨ÛŒ...</p>
        </div>
        
        <div class="controls">
            <button onclick="runAllTests()">ğŸš€ Ø§Ø¬Ø±Ø§ÛŒ ØªÙ…Ø§Ù… ØªØ³Øªâ€ŒÙ‡Ø§</button>
            <button onclick="runSimulationTests()">ğŸ® ØªØ³Øª Ø´Ø¨ÛŒÙ‡â€ŒØ³Ø§Ø²ÛŒ</button>
            <button onclick="clearTests()" style="background: linear-gradient(45deg, #757575, #9e9e9e);">â™»ï¸ Ø¨Ø§Ø²Ù†Ø´Ø§Ù†ÛŒ</button>
        </div>
    </div>

    <script>
        // ==================== Router Service ====================
        class RouterService {
            constructor() {
                this.routes = new Map();
                this.currentRoute = '/';
                this.history = [];
                this.guards = new Map();
                this.isAuthenticated = false;
                this.userRole = 'guest';
                
                this.initDefaultRoutes();
                this.initGuards();
            }
            
            initDefaultRoutes() {
                this.routes.set('/', {
                    name: 'Ø®Ø§Ù†Ù‡',
                    component: 'HomePage',
                    requiresAuth: false,
                    roles: ['guest', 'user', 'admin'],
                    meta: { title: 'Ø®Ø§Ù†Ù‡ - Farsinglish' }
                });
                
                this.routes.set('/login', {
                    name: 'ÙˆØ±ÙˆØ¯',
                    component: 'LoginPage',
                    requiresAuth: false,
                    roles: ['guest'],
                    meta: { title: 'ÙˆØ±ÙˆØ¯ Ø¨Ù‡ Ø­Ø³Ø§Ø¨' }
                });
                
                this.routes.set('/register', {
                    name: 'Ø«Ø¨Øªâ€ŒÙ†Ø§Ù…',
                    component: 'RegisterPage',
                    requiresAuth: false,
                    roles: ['guest'],
                    meta: { title: 'Ø«Ø¨Øªâ€ŒÙ†Ø§Ù…' }
                });
                
                this.routes.set('/dashboard', {
                    name: 'Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯',
                    component: 'DashboardPage',
                    requiresAuth: true,
                    roles: ['user', 'admin'],
                    meta: { title: 'Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯ Ú©Ø§Ø±Ø¨Ø±' }
                });
                
                this.routes.set('/lessons', {
                    name: 'Ø¯Ø±ÙˆØ³',
                    component: 'LessonsPage',
                    requiresAuth: true,
                    roles: ['user', 'admin'],
                    meta: { title: 'Ø¯Ø±ÙˆØ³ Ø¢Ù…ÙˆØ²Ø´ÛŒ' }
                });
                
                this.routes.set('/profile', {
                    name: 'Ù¾Ø±ÙˆÙØ§ÛŒÙ„',
                    component: 'ProfilePage',
                    requiresAuth: true,
                    roles: ['user', 'admin'],
                    meta: { title: 'Ù¾Ø±ÙˆÙØ§ÛŒÙ„ Ú©Ø§Ø±Ø¨Ø±' }
                });
                
                this.routes.set('/admin', {
                    name: 'Ù…Ø¯ÛŒØ±ÛŒØª',
                    component: 'AdminPage',
                    requiresAuth: true,
                    roles: ['admin'],
                    meta: { title: 'Ù¾Ù†Ù„ Ù…Ø¯ÛŒØ±ÛŒØª' }
                });
                
                this.routes.set('/404', {
                    name: 'ØµÙØ­Ù‡ ÛŒØ§ÙØª Ù†Ø´Ø¯',
                    component: 'NotFoundPage',
                    requiresAuth: false,
                    roles: ['guest', 'user', 'admin'],
                    meta: { title: 'ØµÙØ­Ù‡ ÛŒØ§ÙØª Ù†Ø´Ø¯' }
                });
            }
            
            initGuards() {
                // Guard Ø¨Ø±Ø§ÛŒ Ø§Ø­Ø±Ø§Ø² Ù‡ÙˆÛŒØª
                this.guards.set('auth', async (to, from) => {
                    if (to.requiresAuth && !this.isAuthenticated) {
                        console.log('Auth Guard: Ù†ÛŒØ§Ø² Ø¨Ù‡ ÙˆØ±ÙˆØ¯');
                        return { allowed: false, redirect: '/login' };
                    }
                    return { allowed: true };
                });
                
                // Guard Ø¨Ø±Ø§ÛŒ Ù†Ù‚Ø´ Ú©Ø§Ø±Ø¨Ø±
                this.guards.set('role', async (to, from) => {
                    if (to.roles && !to.roles.includes(this.userRole)) {
                        console.log(`Role Guard: Ù†Ù‚Ø´ ${this.userRole} Ù…Ø¬Ø§Ø² Ù†ÛŒØ³Øª`);
                        return { allowed: false, redirect: '/dashboard' };
                    }
                    return { allowed: true };
                });
                
                // Guard Ø¨Ø±Ø§ÛŒ Ø¬Ù„ÙˆÚ¯ÛŒØ±ÛŒ Ø§Ø² Ø¯Ø³ØªØ±Ø³ÛŒ Ø¨Ù‡ ØµÙØ­Ù‡ ÙˆØ±ÙˆØ¯ Ù¾Ø³ Ø§Ø² Ø§Ø­Ø±Ø§Ø²
                this.guards.set('guest', async (to, from) => {
                    if ((to.path === '/login' || to.path === '/register') && this.isAuthenticated) {
                        console.log('Guest Guard: Ú©Ø§Ø±Ø¨Ø± Ù‚Ø¨Ù„Ø§Ù‹ ÙˆØ§Ø±Ø¯ Ø´Ø¯Ù‡');
                        return { allowed: false, redirect: '/dashboard' };
                    }
                    return { allowed: true };
                });
            }
            
            async navigate(toPath, options = {}) {
                console.log(`ğŸ§­ Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ù…Ø³ÛŒØ±ÛŒØ§Ø¨ÛŒ Ø¨Ù‡: ${toPath}`);
                
                const from = {
                    path: this.currentRoute,
                    ...this.routes.get(this.currentRoute)
                };
                
                // Ø¨Ø±Ø±Ø³ÛŒ ÙˆØ¬ÙˆØ¯ Ù…Ø³ÛŒØ±
                if (!this.routes.has(toPath)) {
                    console.warn(`Ù…Ø³ÛŒØ± ${toPath} ÛŒØ§ÙØª Ù†Ø´Ø¯`);
                    return this.navigate('/404', { replace: true });
                }
                
                const to = {
                    path: toPath,
                    ...this.routes.get(toPath)
                };
                
                // Ø§Ø¬Ø±Ø§ÛŒ Guards
                for (const [guardName, guardFn] of this.guards) {
                    try {
                        const result = await guardFn(to, from);
                        if (!result.allowed) {
                            console.log(`Guard ${guardName} Ù…Ø³Ø¯ÙˆØ¯ Ú©Ø±Ø¯: ${result.message || ''}`);
                            
                            if (result.redirect) {
                                return this.navigate(result.redirect, { replace: true });
                            }
                            
                            return false;
                        }
                    } catch (error) {
                        console.error(`Ø®Ø·Ø§ Ø¯Ø± Ø§Ø¬Ø±Ø§ÛŒ guard ${guardName}:`, error);
                        return false;
                    }
                }
                
                // Ø§Ù†Ø¬Ø§Ù… Ù…Ø³ÛŒØ±ÛŒØ§Ø¨ÛŒ
                const previousRoute = this.currentRoute;
                this.currentRoute = toPath;
                
                if (!options.replace) {
                    this.history.push(previousRoute);
                    if (this.history.length > 50) {
                        this.history.shift(); // Ù…Ø­Ø¯ÙˆØ¯ÛŒØª ØªØ§Ø±ÛŒØ®Ú†Ù‡
                    }
                }
                
                // Ø´Ø¨ÛŒÙ‡â€ŒØ³Ø§Ø²ÛŒ ØªØºÛŒÛŒØ± Ø¹Ù†ÙˆØ§Ù† ØµÙØ­Ù‡
                if (to.meta?.title) {
                    document.title = to.meta.title;
                }
                
                console.log(`âœ… Ù…Ø³ÛŒØ±ÛŒØ§Ø¨ÛŒ Ù…ÙˆÙÙ‚: ${previousRoute} â†’ ${toPath}`);
                
                // Ø±ÙˆÛŒØ¯Ø§Ø¯ ØªØºÛŒÛŒØ± Ù…Ø³ÛŒØ±
                this.dispatchRouteChange(to, from);
                
                return true;
            }
            
            dispatchRouteChange(to, from) {
                const event = new CustomEvent('routechange', {
                    detail: { to, from, timestamp: Date.now() }
                });
                window.dispatchEvent(event);
            }
            
            goBack() {
                if (this.history.length > 0) {
                    const previous = this.history.pop();
                    return this.navigate(previous, { replace: true });
                }
                return false;
            }
            
            getCurrentRoute() {
                return this.routes.get(this.currentRoute);
            }
            
            addRoute(path, config) {
                if (this.routes.has(path)) {
                    console.warn(`Ù…Ø³ÛŒØ± ${path} Ù‚Ø¨Ù„Ø§Ù‹ ØªØ¹Ø±ÛŒÙ Ø´Ø¯Ù‡`);
                    return false;
                }
                
                this.routes.set(path, {
                    requiresAuth: false,
                    roles: ['guest', 'user', 'admin'],
                    meta: {},
                    ...config
                });
                
                return true;
            }
            
            removeRoute(path) {
                if (path === '/' || path === '/404') {
                    console.warn('Ù†Ù…ÛŒâ€ŒØªÙˆØ§Ù† Ù…Ø³ÛŒØ±Ù‡Ø§ÛŒ Ø³ÛŒØ³ØªÙ…ÛŒ Ø±Ø§ Ø­Ø°Ù Ú©Ø±Ø¯');
                    return false;
                }
                return this.routes.delete(path);
            }
            
            setAuthenticationStatus(authenticated, role = 'user') {
                this.isAuthenticated = authenticated;
                this.userRole = role;
                console.log(`ğŸ” ÙˆØ¶Ø¹ÛŒØª Ø§Ø­Ø±Ø§Ø²: ${authenticated ? 'Ù„Ø§Ú¯ÛŒÙ†' : 'Ù„Ø§Ú¯â€ŒØ§ÙˆØª'} | Ù†Ù‚Ø´: ${role}`);
            }
            
            getRouteParams(path) {
                // Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ù¾Ø§Ø±Ø§Ù…ØªØ±Ù‡Ø§ÛŒ Ø¯Ø§ÛŒÙ†Ø§Ù…ÛŒÚ© Ø§Ø² Ù…Ø³ÛŒØ±
                const route = this.routes.get(path);
                if (!route) return null;
                
                const paramPattern = /:([^\/]+)/g;
                const matches = path.match(paramPattern);
                
                if (!matches) return null;
                
                return matches.map(match => match.substring(1));
            }
            
            resolveDynamicPath(template, params) {
                // ØªØ¨Ø¯ÛŒÙ„ Ù…Ø³ÛŒØ± Ø¯Ø§ÛŒÙ†Ø§Ù…ÛŒÚ© Ø¨Ù‡ Ù…Ø³ÛŒØ± ÙˆØ§Ù‚Ø¹ÛŒ
                let resolved = template;
                for (const [key, value] of Object.entries(params)) {
                    resolved = resolved.replace(`:${key}`, value);
                }
                return resolved;
            }
        }

        // ==================== ØªØ³Øªâ€ŒÙ‡Ø§ÛŒ Ù…Ø³ÛŒØ±ÛŒØ§Ø¨ÛŒ ====================
        const routerTests = [
            {
                id: 1,
                title: "Ù…Ø³ÛŒØ±ÛŒØ§Ø¨ÛŒ Ø³Ø§Ø¯Ù‡ - ØµÙØ­Ù‡ Ø§ØµÙ„ÛŒ",
                route: "/",
                run: async (router) => {
                    const result = await router.navigate('/');
                    const current = router.getCurrentRoute();
                    return result && current?.name === 'Ø®Ø§Ù†Ù‡';
                }
            },
            {
                id: 2,
                title: "Guard Ø§Ø­Ø±Ø§Ø² Ù‡ÙˆÛŒØª - Ø¯Ø³ØªØ±Ø³ÛŒ Ø¨Ù‡ Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯ Ø¨Ø¯ÙˆÙ† Ù„Ø§Ú¯ÛŒÙ†",
                route: "/dashboard",
                run: async (router) => {
                    router.setAuthenticationStatus(false, 'guest');
                    const result = await router.navigate('/dashboard');
                    return !result && router.currentRoute === '/login';
                }
            },
            {
                id: 3,
                title: "Guard Ø§Ø­Ø±Ø§Ø² Ù‡ÙˆÛŒØª - Ø¯Ø³ØªØ±Ø³ÛŒ Ø¨Ù‡ Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯ Ø¨Ø§ Ù„Ø§Ú¯ÛŒÙ†",
                route: "/dashboard",
                run: async (router) => {
                    router.setAuthenticationStatus(true, 'user');
                    const result = await router.navigate('/dashboard');
                    return result && router.currentRoute === '/dashboard';
                }
            },
            {
                id: 4,
                title: "Guard Ù†Ù‚Ø´ Ú©Ø§Ø±Ø¨Ø± - Ø¯Ø³ØªØ±Ø³ÛŒ Ø¨Ù‡ Ø§Ø¯Ù…ÛŒÙ† Ø¨Ø§ Ù†Ù‚Ø´ Ø¹Ø§Ø¯ÛŒ",
                route: "/admin",
                run: async (router) => {
                    router.setAuthenticationStatus(true, 'user');
                    const result = await router.navigate('/admin');
                    return !result && router.currentRoute === '/dashboard';
                }
            },
            {
                id: 5,
                title: "Guard Ù†Ù‚Ø´ Ú©Ø§Ø±Ø¨Ø± - Ø¯Ø³ØªØ±Ø³ÛŒ Ø¨Ù‡ Ø§Ø¯Ù…ÛŒÙ† Ø¨Ø§ Ù†Ù‚Ø´ Ø§Ø¯Ù…ÛŒÙ†",
                route: "/admin",
                run: async (router) => {
                    router.setAuthenticationStatus(true, 'admin');
                    const result = await router.navigate('/admin');
                    return result && router.currentRoute === '/admin';
                }
            },
            {
                id: 6,
                title: "Guard Ù…Ù‡Ù…Ø§Ù† - Ø¯Ø³ØªØ±Ø³ÛŒ Ø¨Ù‡ ØµÙØ­Ù‡ ÙˆØ±ÙˆØ¯ Ù¾Ø³ Ø§Ø² Ù„Ø§Ú¯ÛŒÙ†",
                route: "/login",
                run: async (router) => {
                    router.setAuthenticationStatus(true, 'user');
                    const result = await router.navigate('/login');
                    return !result && router.currentRoute === '/dashboard';
                }
            },
            {
                id: 7,
                title: "ØªØ§Ø±ÛŒØ®Ú†Ù‡ Ù…Ø³ÛŒØ±ÛŒØ§Ø¨ÛŒ",
                route: "history",
                run: async (router) => {
                    router.setAuthenticationStatus(true, 'user');
                    
                    const routes = ['/', '/dashboard', '/lessons', '/profile'];
                    for (const route of routes) {
                        await router.navigate(route);
                    }
                    
                    const canGoBack = router.history.length === 3; // Û³ ØªØºÛŒÛŒØ± Ù…Ø³ÛŒØ± Ù‚Ø¨Ù„ÛŒ
                    const backResult = router.goBack();
                    
                    return canGoBack && backResult && router.currentRoute === '/lessons';
                }
            },
            {
                id: 8,
                title: "Ù…Ø³ÛŒØ± Û´Û°Û´ - ØµÙØ­Ù‡ ÛŒØ§ÙØª Ù†Ø´Ø¯",
                route: "/not-found",
                run: async (router) => {
                    const result = await router.navigate('/nonexistent-route');
                    return !result && router.currentRoute === '/404';
                }
            },
            {
                id: 9,
                title: "Ø§ÙØ²ÙˆØ¯Ù† Ùˆ Ø­Ø°Ù Ù…Ø³ÛŒØ± Ø¯Ø§ÛŒÙ†Ø§Ù…ÛŒÚ©",
                route: "/dynamic",
                run: async (router) => {
                    // Ø§ÙØ²ÙˆØ¯Ù† Ù…Ø³ÛŒØ± Ø¯Ø§ÛŒÙ†Ø§Ù…ÛŒÚ©
                    const added = router.addRoute('/user/:id/profile', {
                        name: 'Ù¾Ø±ÙˆÙØ§ÛŒÙ„ Ú©Ø§Ø±Ø¨Ø±',
                        component: 'UserProfilePage',
                        requiresAuth: true,
                        roles: ['user', 'admin']
                    });
                    
                    if (!added) return false;
                    
                    // Ø¨Ø±Ø±Ø³ÛŒ ÙˆØ¬ÙˆØ¯ Ù…Ø³ÛŒØ±
                    const routeExists = router.routes.has('/user/:id/profile');
                    
                    // Ø­Ø°Ù Ù…Ø³ÛŒØ±
                    const removed = router.removeRoute('/user/:id/profile');
                    
                    return added && routeExists && removed;
                }
            },
            {
                id: 10,
                title: "Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ù¾Ø§Ø±Ø§Ù…ØªØ±Ù‡Ø§ÛŒ Ù…Ø³ÛŒØ±",
                route: "/params",
                run: async (router) => {
                    router.addRoute('/lesson/:lessonId/step/:stepId', {
                        name: 'Ù…Ø±Ø­Ù„Ù‡ Ø¯Ø±Ø³',
                        component: 'LessonStepPage'
                    });
                    
                    const params = router.getRouteParams('/lesson/:lessonId/step/:stepId');
                    const hasLessonId = params?.includes('lessonId');
                    const hasStepId = params?.includes('stepId');
                    
                    router.removeRoute('/lesson/:lessonId/step/:stepId');
                    
                    return hasLessonId && hasStepId && params.length === 2;
                }
            },
            {
                id: 11,
                title: "ØªØ¨Ø¯ÛŒÙ„ Ù…Ø³ÛŒØ± Ø¯Ø§ÛŒÙ†Ø§Ù…ÛŒÚ© Ø¨Ù‡ ÙˆØ§Ù‚Ø¹ÛŒ",
                route: "/resolve",
                run: async (router) => {
                    const template = '/user/:userId/post/:postId';
                    const params = { userId: '123', postId: '456' };
                    
                    const resolved = router.resolveDynamicPath(template, params);
                    return resolved === '/user/123/post/456';
                }
            },
            {
                id: 12,
                title: "Ù…Ø³ÛŒØ±ÛŒØ§Ø¨ÛŒ Ø¨Ø§ replace (Ø¨Ø¯ÙˆÙ† Ø§ÙØ²ÙˆØ¯Ù† Ø¨Ù‡ ØªØ§Ø±ÛŒØ®Ú†Ù‡)",
                route: "/replace",
                run: async (router) => {
                    await router.navigate('/');
                    await router.navigate('/login');
                    const historyBefore = router.history.length;
                    
                    // Ù…Ø³ÛŒØ±ÛŒØ§Ø¨ÛŒ Ø¨Ø§ replace
                    await router.navigate('/register', { replace: true });
                    const historyAfter = router.history.length;
                    
                    return historyBefore === 1 && historyAfter === 1;
                }
            },
            {
                id: 13,
                title: "Ø±ÙˆÛŒØ¯Ø§Ø¯ ØªØºÛŒÛŒØ± Ù…Ø³ÛŒØ±",
                route: "/events",
                run: async (router) => {
                    return new Promise((resolve) => {
                        let eventFired = false;
                        
                        const handler = (e) => {
                            if (e.detail.to.path === '/dashboard') {
                                eventFired = true;
                                window.removeEventListener('routechange', handler);
                                resolve(eventFired);
                            }
                        };
                        
                        window.addEventListener('routechange', handler);
                        
                        router.setAuthenticationStatus(true, 'user');
                        router.navigate('/dashboard');
                        
                        // Timeout Ø¨Ø±Ø§ÛŒ Ø¬Ù„ÙˆÚ¯ÛŒØ±ÛŒ Ø§Ø² Ú¯ÛŒØ±Ú©Ø±Ø¯Ù†
                        setTimeout(() => resolve(false), 1000);
                    });
                }
            },
            {
                id: 14,
                title: "Ø§Ø¹ØªØ¨Ø§Ø±Ø³Ù†Ø¬ÛŒ Ù†Ù‚Ø´â€ŒÙ‡Ø§ÛŒ Ù…ØªØ¹Ø¯Ø¯",
                route: "/multi-role",
                run: async (router) => {
                    // Ø§ÙØ²ÙˆØ¯Ù† Ù…Ø³ÛŒØ± Ø¨Ø§ Ù†Ù‚Ø´â€ŒÙ‡Ø§ÛŒ Ù…Ø­Ø¯ÙˆØ¯
                    router.addRoute('/premium', {
                        name: 'Ù…Ø­ØªÙˆØ§ÛŒ ÙˆÛŒÚ˜Ù‡',
                        component: 'PremiumPage',
                        requiresAuth: true,
                        roles: ['premium', 'admin'] // Ù†Ù‚Ø´ Ø¹Ø§Ø¯ÛŒ user Ù…Ø¬Ø§Ø² Ù†ÛŒØ³Øª
                    });
                    
                    router.setAuthenticationStatus(true, 'user');
                    const userAccess = await router.navigate('/premium');
                    
                    router.setAuthenticationStatus(true, 'premium');
                    const premiumAccess = await router.navigate('/premium');
                    
                    router.removeRoute('/premium');
                    
                    return !userAccess && premiumAccess;
                }
            }
        ];

        // ==================== Ø§Ø¬Ø±Ø§ÛŒ ØªØ³Øªâ€ŒÙ‡Ø§ ====================
        const router = new RouterService();
        let passedTests = 0;
        let failedTests = 0;

        async function runAllTests() {
            passedTests = 0;
            failedTests = 0;
            const resultsDiv = document.getElementById('test-results');
            resultsDiv.innerHTML = '';
            
            // Ø±ÛŒØ³Øªâ€ŒÚ©Ø±Ø¯Ù† Ø±ÙˆØªØ± Ù‚Ø¨Ù„ Ø§Ø² Ù‡Ø± ØªØ³Øª
            const originalRouter = router;
            
            for (const test of routerTests) {
                try {
                    // Ø§ÛŒØ¬Ø§Ø¯ Ø±ÙˆØªØ± Ø¬Ø¯ÛŒØ¯ Ø¨Ø±Ø§ÛŒ Ù‡Ø± ØªØ³Øª (Ø§ÛŒØ²ÙˆÙ„Ù‡)
                    const testRouter = new RouterService();
                    
                    const result = await test.run(testRouter);
                    const testDiv = document.createElement('div');
                    testDiv.className = 'test-section';
                    
                    const testResult = result ? 'pass' : 'fail';
                    const resultText = result ? 'âœ… Ù…ÙˆÙÙ‚' : 'âŒ Ù†Ø§Ù…ÙˆÙÙ‚';
                    
                    if (result) passedTests++;
                    else failedTests++;
                    
                    testDiv.innerHTML = `
                        <div class="test-header">
                            <div class="test-title">
                                ${test.id}. ${test.title}
                                <span class="route-tag">${test.route}</span>
                            </div>
                            <div class="test-result ${testResult}">${resultText}</div>
                        </div>
                        ${!result ? '<div class="details">ØªØ³Øª Ù†Ø§Ù…ÙˆÙÙ‚ Ø¨ÙˆØ¯</div>' : ''}
                    `;
                    
                    resultsDiv.appendChild(testDiv);
                } catch (error) {
                    failedTests++;
                    const testDiv = document.createElement('div');
                    testDiv.className = 'test-section';
                    testDiv.innerHTML = `
                        <div class="test-header">
                            <div class="test-title">
                                ${test.id}. ${test.title}
                                <span class="route-tag">${test.route}</span>
                            </div>
                            <div class="test-result fail">âŒ Ø®Ø·Ø§</div>
                        </div>
                        <div class="details">${error.message}</div>
                    `;
                    resultsDiv.appendChild(testDiv);
                }
                
                updateSummary();
            }
        }

        async function runSimulationTests() {
            const simControls = document.getElementById('sim-controls');
            simControls.innerHTML = '';
            
            const routes = [
                { path: '/', label: 'ğŸ  Ø®Ø§Ù†Ù‡' },
                { path: '/login', label: 'ğŸ” ÙˆØ±ÙˆØ¯' },
                { path: '/register', label: 'ğŸ“ Ø«Ø¨Øªâ€ŒÙ†Ø§Ù…' },
                { path: '/dashboard', label: 'ğŸ“Š Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯' },
                { path: '/lessons', label: 'ğŸ“š Ø¯Ø±ÙˆØ³' },
                { path: '/profile', label: 'ğŸ‘¤ Ù¾Ø±ÙˆÙØ§ÛŒÙ„' },
                { path: '/admin', label: 'âš™ï¸ Ù…Ø¯ÛŒØ±ÛŒØª' }
            ];
            
            routes.forEach(route => {
                const btn = document.createElement('button');
                btn.className = 'sim-btn';
                btn.textContent = route.label;
                btn.onclick = () => router.navigate(route.path);
                simControls.appendChild(btn);
            });
            
            // Ø¯Ú©Ù…Ù‡â€ŒÙ‡Ø§ÛŒ Ú©Ù†ØªØ±Ù„ ÙˆØ¶Ø¹ÛŒØª
            const statusDiv = document.createElement('div');
            statusDiv.style.marginTop = '10px';
            statusDiv.innerHTML = `
                <button class="sim-btn" onclick="router.setAuthenticationStatus(true, 'user'); updateStatus()">
                    ğŸ‘¤ Ù„Ø§Ú¯ÛŒÙ† Ø¨Ù‡ Ø¹Ù†ÙˆØ§Ù† Ú©Ø§Ø±Ø¨Ø±
                </button>
                <button class="sim-btn" onclick="router.setAuthenticationStatus(true, 'admin'); updateStatus()">
                    ğŸ‘‘ Ù„Ø§Ú¯ÛŒÙ† Ø¨Ù‡ Ø¹Ù†ÙˆØ§Ù† Ø§Ø¯Ù…ÛŒÙ†
                </button>
                <button class="sim-btn" onclick="router.setAuthenticationStatus(false, 'guest'); updateStatus()">
                    ğŸšª Ø®Ø±ÙˆØ¬
                </button>
                <button class="sim-btn" onclick="router.goBack(); updateCurrentRoute()">
                    â†©ï¸ Ø¨Ø§Ø²Ú¯Ø´Øª
                </button>
            `;
            simControls.appendChild(statusDiv);
            
            // Ø§Ø¬Ø±Ø§ÛŒ Ú†Ù†Ø¯ ØªØ³Øª Ø´Ø¨ÛŒÙ‡â€ŒØ³Ø§Ø²ÛŒ
            await router.navigate('/');
            updateCurrentRoute();
            updateStatus();
        }

        function updateCurrentRoute() {
            document.getElementById('current-route').textContent = router.currentRoute;
            const routeInfo = router.getCurrentRoute();
            if (routeInfo) {
                document.title = routeInfo.meta?.title || 'Farsinglish Router Test';
            }
        }

        function updateStatus() {
            const statusEl = document.getElementById('user-status');
            if (router.isAuthenticated) {
                statusEl.innerHTML = `âœ… Ù„Ø§Ú¯ÛŒÙ† Ø´Ø¯Ù‡ (${router.userRole})`;
                statusEl.style.color = '#4caf50';
            } else {
                statusEl.innerHTML = 'âŒ Ù„Ø§Ú¯ÛŒÙ† Ù†Ø´Ø¯Ù‡ (Ù…Ù‡Ù…Ø§Ù†)';
                statusEl.style.color = '#f44336';
            }
        }

        function clearTests() {
            document.getElementById('test-results').innerHTML = '';
            passedTests = failedTests = 0;
            updateSummary();
        }

        function updateSummary() {
            const summary = document.getElementById('summary-text');
            const total = routerTests.length;
            const percentage = total > 0 ? Math.round((passedTests / total) * 100) : 0;
            
            let emoji = 'ğŸ¯';
            if (percentage >= 90) emoji = 'ğŸ†';
            else if (percentage >= 70) emoji = 'âœ…';
            else emoji = 'âš ï¸';
            
            summary.innerHTML = `
                <strong>${emoji} Ù†ØªÛŒØ¬Ù‡ ØªØ³Øªâ€ŒÙ‡Ø§ÛŒ Ù…Ø³ÛŒØ±ÛŒØ§Ø¨ÛŒ:</strong><br>
                âœ… ${passedTests} Ù…ÙˆÙÙ‚ | âŒ ${failedTests} Ù†Ø§Ù…ÙˆÙÙ‚ | ğŸ“Š ${percentage}% Ù‚Ø¨ÙˆÙ„ÛŒ
                ${percentage >= 90 ? 'ğŸ‰ Ù…Ø³ÛŒØ±ÛŒØ§Ø¨ÛŒ Ø¹Ø§Ù„ÛŒ' : percentage >= 70 ? 'âš ï¸ Ù†ÛŒØ§Ø² Ø¨Ù‡ Ø¨Ù‡Ø¨ÙˆØ¯' : 'ğŸš¨ Ù†ÛŒØ§Ø² Ø¨Ù‡ Ø¨Ø±Ø±Ø³ÛŒ'}
            `;
            
            summary.style.color = percentage >= 90 ? '#4caf50' : 
                                 percentage >= 70 ? '#ff9800' : '#f44336';
        }

        // Ø§Ø¬Ø±Ø§ÛŒ Ø®ÙˆØ¯Ú©Ø§Ø± ØªØ³Øªâ€ŒÙ‡Ø§
        window.onload = () => {
            updateSummary();
            setTimeout(runAllTests, 500);
            runSimulationTests();
        };
    </script>
</body>
</html>
