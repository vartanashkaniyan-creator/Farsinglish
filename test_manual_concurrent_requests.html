<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ØªØ³Øª Ø¯Ø³ØªÛŒ Ø¯Ø±Ø®ÙˆØ§Ø³Øªâ€ŒÙ‡Ø§ÛŒ Ù‡Ù…Ø²Ù…Ø§Ù† - Farsinglish</title>
    <style>
        body { font-family: Tahoma, Arial, sans-serif; max-width: 900px; margin: 0 auto; padding: 15px; background: #f5f5f5; }
        .header { background: #2c3e50; color: white; padding: 15px; border-radius: 10px; margin-bottom: 20px; text-align: center; }
        .header h1 { margin: 0; font-size: 1.8em; }
        .header p { margin: 5px 0 0; opacity: 0.9; }
        .section { background: white; border-radius: 12px; padding: 20px; margin-bottom: 25px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
        .section h2 { margin-top: 0; color: #2c3e50; border-bottom: 2px solid #ecf0f1; padding-bottom: 10px; }
        .btn-group { display: flex; flex-wrap: wrap; gap: 12px; margin: 20px 0; }
        .btn { padding: 12px 20px; border: none; border-radius: 8px; font-size: 15px; font-weight: bold; cursor: pointer; transition: 0.2s; flex: 1 0 200px; }
        .btn-primary { background: #3498db; color: white; }
        .btn-primary:hover { background: #2980b9; }
        .btn-success { background: #27ae60; color: white; }
        .btn-success:hover { background: #229954; }
        .btn-warning { background: #f39c12; color: white; }
        .btn-warning:hover { background: #e67e22; }
        .btn-danger { background: #e74c3c; color: white; }
        .btn-danger:hover { background: #c0392b; }
        .btn-info { background: #1abc9c; color: white; }
        .btn-info:hover { background: #16a085; }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; }
        
        .log-container { background: #1e272e; color: #d3dae0; padding: 15px; border-radius: 8px; font-family: 'Courier New', monospace; height: 300px; overflow-y: auto; font-size: 13px; line-height: 1.6; margin-top: 20px; direction: ltr; text-align: left; }
        .log-entry { border-bottom: 1px solid #3a4a5a; padding: 5px 0; }
        .log-success { color: #2ecc71; }
        .log-error { color: #e74c3c; }
        .log-warning { color: #f39c12; }
        .log-info { color: #3498db; }
        
        .result-badge { display: inline-block; padding: 4px 10px; border-radius: 20px; font-size: 13px; font-weight: bold; margin: 0 5px 5px 0; }
        .badge-success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .badge-danger { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .badge-warning { background: #fff3cd; color: #856404; border: 1px solid #ffeeba; }
        
        .request-item { background: #f8f9fa; padding: 12px; border-radius: 8px; margin-bottom: 10px; border-right: 4px solid #3498db; }
        .stats { display: flex; gap: 20px; flex-wrap: wrap; margin-top: 15px; }
        .stat-card { background: #ecf0f1; border-radius: 8px; padding: 15px; flex: 1; min-width: 120px; text-align: center; }
        .stat-number { font-size: 28px; font-weight: bold; color: #2c3e50; }
    </style>
</head>
<body>
    <div class="header">
        <h1>ğŸ”„ ØªØ³Øª Ø¯Ø³ØªÛŒ Ø¯Ø±Ø®ÙˆØ§Ø³Øªâ€ŒÙ‡Ø§ÛŒ Ù‡Ù…Ø²Ù…Ø§Ù† (Concurrent Requests)</h1>
        <p>Ø´Ø¨ÛŒÙ‡â€ŒØ³Ø§Ø²ÛŒ Ûµ Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ù‡Ù…Ø²Ù…Ø§Ù† Ø¨Ø§ Ø²Ù…Ø§Ù†â€ŒÙ‡Ø§ÛŒ Ù¾Ø§Ø³Ø® Ù…ØªÙØ§ÙˆØª | Ø§ÙˆÙ„ÙˆÛŒØª Û² - Ø´Ø¨Ú©Ù‡</p>
    </div>

    <div class="section">
        <h2>ğŸ§ª Ø³Ù†Ø§Ø±ÛŒÙˆÙ‡Ø§ÛŒ ØªØ³Øª</h2>
        <div class="btn-group">
            <button class="btn btn-primary" onclick="runConcurrentRequests()">ğŸš€ Ø§Ø¬Ø±Ø§ÛŒ Ûµ Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ù‡Ù…Ø²Ù…Ø§Ù†</button>
            <button class="btn btn-info" onclick="runSequentialRequests()">â±ï¸ Ø§Ø¬Ø±Ø§ÛŒ ØªØ±ØªÛŒØ¨ÛŒ (Ù…Ù‚Ø§ÛŒØ³Ù‡)</button>
            <button class="btn btn-warning" onclick="runWithPriority()">âš¡ Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ø¨Ø§ Ø§ÙˆÙ„ÙˆÛŒØª</button>
            <button class="btn btn-danger" onclick="clearLogs()">ğŸ—‘ï¸ Ù¾Ø§Ú© Ú©Ø±Ø¯Ù† Ù„Ø§Ú¯</button>
        </div>
        
        <div class="stats">
            <div class="stat-card">
                <div class="stat-number" id="totalRequests">Û°</div>
                <div>Ú©Ù„ Ø¯Ø±Ø®ÙˆØ§Ø³Øªâ€ŒÙ‡Ø§</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="successCount">Û°</div>
                <div>Ù…ÙˆÙÙ‚</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="failedCount">Û°</div>
                <div>Ù†Ø§Ù…ÙˆÙÙ‚</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="avgTime">Û°</div>
                <div>Ù…ÛŒØ§Ù†Ú¯ÛŒÙ† Ø²Ù…Ø§Ù† (ms)</div>
            </div>
        </div>
    </div>

    <div class="section">
        <h2>ğŸ“‹ Ø¬Ø²Ø¦ÛŒØ§Øª Ø¯Ø±Ø®ÙˆØ§Ø³Øªâ€ŒÙ‡Ø§</h2>
        <div id="requestDetails"></div>
    </div>

    <div class="section">
        <h2>ğŸ“œ Ù„Ø§Ú¯ Ø±ÙˆÛŒØ¯Ø§Ø¯Ù‡Ø§</h2>
        <div class="log-container" id="logContainer">
            <div class="log-entry log-info">âš¡ Ù…Ù†ØªØ¸Ø± Ø§Ø¬Ø±Ø§ÛŒ ØªØ³Øª...</div>
        </div>
    </div>

    <script>
        // ---------- Mock Request Simulator ----------
        class ConcurrentRequestTester {
            constructor() {
                this.logs = [];
                this.requests = [];
                this.stats = { total: 0, success: 0, failed: 0, totalTime: 0 };
                this.requestId = 0;
            }

            // Ø´Ø¨ÛŒÙ‡â€ŒØ³Ø§Ø²ÛŒ Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ø¨Ø§ Ø²Ù…Ø§Ù† Ù¾Ø§Ø³Ø® Ù…ØªØºÛŒØ±
            mockRequest(id, delay, shouldFail = false, priority = 1) {
                return new Promise((resolve, reject) => {
                    const startTime = Date.now();
                    this.addLog(`ğŸ”„ Ø¯Ø±Ø®ÙˆØ§Ø³Øª ${id} Ø´Ø±ÙˆØ¹ Ø´Ø¯ (delay: ${delay}ms, priority: ${priority})`, 'info');
                    
                    setTimeout(() => {
                        const endTime = Date.now();
                        const responseTime = endTime - startTime;
                        
                        if (shouldFail) {
                            this.stats.failed++;
                            this.addLog(`âŒ Ø¯Ø±Ø®ÙˆØ§Ø³Øª ${id} Ù†Ø§Ù…ÙˆÙÙ‚ (Ø®Ø·Ø§ÛŒ Ø´Ø¨ÛŒÙ‡â€ŒØ³Ø§Ø²ÛŒ Ø´Ø¯Ù‡)`, 'error');
                            reject({ id, error: 'Ø´Ø¨ÛŒÙ‡â€ŒØ³Ø§Ø²ÛŒ Ø®Ø·Ø§', time: responseTime });
                        } else {
                            this.stats.success++;
                            this.addLog(`âœ… Ø¯Ø±Ø®ÙˆØ§Ø³Øª ${id} Ù…ÙˆÙÙ‚ Ø¯Ø± ${responseTime}ms`, 'success');
                            
                            // Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ÛŒ Ù…Ø®ØªÙ„Ù Ø¨Ø±Ø§ÛŒ Ù‡Ø± Ø¯Ø±Ø®ÙˆØ§Ø³Øª
                            const mockData = {
                                1: { lesson: "Ù…Ù‚Ø¯Ù…Ø§ØªÛŒ", words: 10 },
                                2: { lesson: "Ù…ØªÙˆØ³Ø·", words: 15 },
                                3: { lesson: "Ù¾ÛŒØ´Ø±ÙØªÙ‡", words: 20 },
                                4: { lesson: "Ø§ØµØ·Ù„Ø§Ø­Ø§Øª", words: 12 },
                                5: { lesson: "Ú¯Ø±Ø§Ù…Ø±", words: 8 }
                            }[id] || { lesson: "Ø¹Ù…ÙˆÙ…ÛŒ", words: 5 };
                            
                            resolve({ 
                                id, 
                                data: mockData, 
                                time: responseTime,
                                priority 
                            });
                        }
                        
                        this.updateStats();
                        this.renderRequests();
                    }, delay);
                });
            }

            // Ø§Ø¬Ø±Ø§ÛŒ Ø¯Ø±Ø®ÙˆØ§Ø³Øªâ€ŒÙ‡Ø§ÛŒ Ù‡Ù…Ø²Ù…Ø§Ù†
            async runConcurrent() {
                this.addLog('ğŸš€ Ø´Ø±ÙˆØ¹ Ø§Ø¬Ø±Ø§ÛŒ Ûµ Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ù‡Ù…Ø²Ù…Ø§Ù†...', 'warning');
                this.stats.total += 5;
                
                const promises = [
                    this.mockRequest(1, 300).catch(e => ({ id: 1, error: e, failed: true })),
                    this.mockRequest(2, 600).catch(e => ({ id: 2, error: e, failed: true })),
                    this.mockRequest(3, 200).catch(e => ({ id: 3, error: e, failed: true })),
                    this.mockRequest(4, 800).catch(e => ({ id: 4, error: e, failed: true })),
                    this.mockRequest(5, 400, true).catch(e => ({ id: 5, error: e, failed: true })) // Ø§ÛŒÙ† ÛŒÚ©ÛŒ Ø®Ø·Ø§ Ù…ÛŒâ€ŒØ¯Ù‡Ø¯
                ];

                const results = await Promise.allSettled(promises);
                
                // Ø¨Ø±Ø±Ø³ÛŒ ØªØ±ØªÛŒØ¨ Ø§ØªÙ…Ø§Ù…
                const completionOrder = results.map((r, i) => {
                    const value = r.status === 'fulfilled' ? r.value : r.reason;
                    return { id: value?.id || i+1, status: r.status };
                });
                
                this.addLog('ğŸ“Š ØªØ±ØªÛŒØ¨ Ø§ØªÙ…Ø§Ù… Ø¯Ø±Ø®ÙˆØ§Ø³Øªâ€ŒÙ‡Ø§:', 'info');
                completionOrder.sort((a, b) => a.id - b.id).forEach(item => {
                    this.addLog(`   - Ø¯Ø±Ø®ÙˆØ§Ø³Øª ${item.id}: ${item.status === 'fulfilled' ? 'Ù…ÙˆÙÙ‚' : 'Ù†Ø§Ù…ÙˆÙÙ‚'}`, item.status === 'fulfilled' ? 'success' : 'error');
                });
                
                this.renderRequests();
            }

            // Ø§Ø¬Ø±Ø§ÛŒ ØªØ±ØªÛŒØ¨ÛŒ (Ø¨Ø±Ø§ÛŒ Ù…Ù‚Ø§ÛŒØ³Ù‡)
            async runSequential() {
                this.addLog('â±ï¸ Ø´Ø±ÙˆØ¹ Ø§Ø¬Ø±Ø§ÛŒ ØªØ±ØªÛŒØ¨ÛŒ Û³ Ø¯Ø±Ø®ÙˆØ§Ø³Øª...', 'warning');
                this.stats.total += 3;
                
                await this.mockRequest(1, 300);
                await this.mockRequest(2, 600);
                await this.mockRequest(3, 200).catch(e => ({ failed: true }));
                
                this.addLog('âœ… Ø§Ø¬Ø±Ø§ÛŒ ØªØ±ØªÛŒØ¨ÛŒ Ú©Ø§Ù…Ù„ Ø´Ø¯', 'success');
            }

            // Ø§Ø¬Ø±Ø§ Ø¨Ø§ Ø§ÙˆÙ„ÙˆÛŒØª (Ø¨Ø§ Promise.race)
            async runWithPriority() {
                this.addLog('âš¡ Ø§Ø¬Ø±Ø§ÛŒ Ø¯Ø±Ø®ÙˆØ§Ø³Øªâ€ŒÙ‡Ø§ Ø¨Ø§ Ø§ÙˆÙ„ÙˆÛŒØª (Ø³Ø±ÛŒØ¹â€ŒØªØ±ÛŒÙ† Ø¨Ø±Ù†Ø¯Ù‡)', 'warning');
                this.stats.total += 3;
                
                const promises = [
                    this.mockRequest(1, 500, false, 1),
                    this.mockRequest(2, 300, false, 2),
                    this.mockRequest(3, 700, false, 3)
                ];

                try {
                    const fastest = await Promise.race(promises);
                    this.addLog(`ğŸ† Ø³Ø±ÛŒØ¹â€ŒØªØ±ÛŒÙ† Ø¯Ø±Ø®ÙˆØ§Ø³Øª: Ø¯Ø±Ø®ÙˆØ§Ø³Øª ${fastest.id} Ø¯Ø± ${fastest.time}ms`, 'success');
                } catch (error) {
                    this.addLog(`âŒ Ø®Ø·Ø§ Ø¯Ø± Ù…Ø³Ø§Ø¨Ù‚Ù‡: ${error}`, 'error');
                }
            }

            addLog(message, type = 'info') {
                const timestamp = new Date().toLocaleTimeString('fa-IR');
                const logEntry = { message, type, timestamp };
                this.logs.unshift(logEntry);
                this.renderLogs();
            }

            renderLogs() {
                const container = document.getElementById('logContainer');
                container.innerHTML = this.logs.map(log => 
                    `<div class="log-entry log-${log.type}">[${log.timestamp}] ${log.message}</div>`
                ).join('');
            }

            updateStats() {
                document.getElementById('totalRequests').textContent = this.stats.total;
                document.getElementById('successCount').textContent = this.stats.success;
                document.getElementById('failedCount').textContent = this.stats.failed;
                
                const avg = this.stats.success > 0 ? (this.stats.totalTime / this.stats.success).toFixed(0) : 0;
                document.getElementById('avgTime').textContent = avg;
            }

            renderRequests() {
                // Ø§ÛŒÙ† Ø¨Ø®Ø´ Ù…ÛŒâ€ŒØªÙˆØ§Ù†Ø¯ Ø¨Ø±Ø§ÛŒ Ù†Ù…Ø§ÛŒØ´ Ø¬Ø²Ø¦ÛŒØ§Øª Ø¯Ø±Ø®ÙˆØ§Ø³Øªâ€ŒÙ‡Ø§ ØªÙˆØ³Ø¹Ù‡ ÛŒØ§Ø¨Ø¯
            }

            clearLogs() {
                this.logs = [{ message: 'ğŸ§¹ Ù„Ø§Ú¯ Ù¾Ø§Ú© Ø´Ø¯', type: 'info', timestamp: new Date().toLocaleTimeString('fa-IR') }];
                this.stats = { total: 0, success: 0, failed: 0, totalTime: 0 };
                this.updateStats();
                this.renderLogs();
                document.getElementById('requestDetails').innerHTML = '';
            }
        }

        // ---------- Ù†Ù…ÙˆÙ†Ù‡ ØªØ³Øªâ€ŒÙ‡Ø§ÛŒ Ø§Ø¶Ø§ÙÛŒ ----------
        function testRaceCondition() {
            const log = document.getElementById('logContainer');
            log.innerHTML += '<div class="log-entry log-warning">ğŸ§ª ØªØ³Øª Ø´Ø±Ø· Ù…Ø³Ø§Ø¨Ù‚Ù‡ (Race Condition):</div>';
            
            let sharedData = { value: 0 };
            
            // Ø´Ø¨ÛŒÙ‡â€ŒØ³Ø§Ø²ÛŒ Ø¯Ùˆ Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ù‡Ù…Ø²Ù…Ø§Ù† Ú©Ù‡ Ø¯Ø§Ø¯Ù‡ Ù…Ø´ØªØ±Ú© Ø±Ø§ ØªØºÛŒÛŒØ± Ù…ÛŒâ€ŒØ¯Ù‡Ù†Ø¯
            const requestA = new Promise(resolve => {
                setTimeout(() => {
                    sharedData.value += 5;
                    resolve('A');
                }, 100);
            });
            
            const requestB = new Promise(resolve => {
                setTimeout(() => {
                    sharedData.value *= 2;
                    resolve('B');
                }, 50);
            });
            
            Promise.all([requestA, requestB]).then(() => {
                log.innerHTML += `<div class="log-entry log-info">   Ù†ØªÛŒØ¬Ù‡ Ø´Ø±Ø· Ù…Ø³Ø§Ø¨Ù‚Ù‡: Ù…Ù‚Ø¯Ø§Ø± Ù†Ù‡Ø§ÛŒÛŒ = ${sharedData.value} (ÙˆØ§Ø¨Ø³ØªÙ‡ Ø¨Ù‡ ØªØ±ØªÛŒØ¨)</div>`;
            });
        }

        // ---------- Ø±Ø§Ù‡â€ŒØ§Ù†Ø¯Ø§Ø²ÛŒ ----------
        const tester = new ConcurrentRequestTester();

        function runConcurrentRequests() {
            tester.runConcurrent();
        }

        function runSequentialRequests() {
            tester.runSequential();
        }

        function runWithPriority() {
            tester.runWithPriority();
        }

        function clearLogs() {
            tester.clearLogs();
        }

        // ØªØ³Øª Ø§Ø¶Ø§ÙÛŒ Ø¨Ø§ Ø¯Ú©Ù…Ù‡ Ù…Ø¬Ø§Ø²ÛŒ (Ù…ÛŒâ€ŒØªÙˆØ§Ù†ÛŒØ¯ Ø¯Ú©Ù…Ù‡ Ø¬Ø¯Ø§ Ø¨Ø±Ø§ÛŒ Ø¢Ù† Ø¨Ø³Ø§Ø²ÛŒØ¯)
        window.testRaceCondition = testRaceCondition;
    </script>

    <!-- Ø¯Ú©Ù…Ù‡ ØªØ³Øª Ø´Ø±Ø· Ù…Ø³Ø§Ø¨Ù‚Ù‡ -->
    <div class="section">
        <h2>ğŸ§ª ØªØ³Øª Ø§Ø¶Ø§ÙÛŒ: Ø´Ø±Ø· Ù…Ø³Ø§Ø¨Ù‚Ù‡ (Race Condition)</h2>
        <button class="btn btn-info" onclick="testRaceCondition()">ğŸ Ø§Ø¬Ø±Ø§ÛŒ ØªØ³Øª Ø´Ø±Ø· Ù…Ø³Ø§Ø¨Ù‚Ù‡</button>
    </div>
</body>
</html>
