<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ØªØ³Øª Ø¯Ø³ØªÛŒ: ØµÙØ­Ù‡ Ù¾Ø±ÙˆÙØ§ÛŒÙ„ (State)</title>
    <style>
        body {
            font-family: Vazir, Tahoma, Arial, sans-serif;
            background: #f5f7fa;
            margin: 0;
            padding: 20px;
            color: #1e293b;
        }
        .container {
            max-width: 1000px;
            margin: 0 auto;
        }
        h1 {
            font-size: 1.8rem;
            margin-bottom: 20px;
            color: #0f172a;
            border-right: 5px solid #3b82f6;
            padding-right: 15px;
        }
        .test-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        .card {
            background: white;
            border-radius: 16px;
            padding: 20px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.05);
            border: 1px solid #e2e8f0;
        }
        .card h3 {
            margin-top: 0;
            margin-bottom: 15px;
            font-size: 1.2rem;
            display: flex;
            align-items: center;
            gap: 8px;
            color: #0f172a;
        }
        .btn {
            background: #3b82f6;
            color: white;
            border: none;
            padding: 10px 16px;
            border-radius: 30px;
            font-size: 0.9rem;
            font-weight: 500;
            cursor: pointer;
            width: 100%;
            transition: 0.2s;
            margin-bottom: 12px;
            border: 1px solid #2563eb;
        }
        .btn:hover {
            background: #2563eb;
            transform: translateY(-1px);
        }
        .btn.secondary {
            background: #f1f5f9;
            color: #1e293b;
            border: 1px solid #cbd5e1;
        }
        .btn.secondary:hover {
            background: #e2e8f0;
        }
        .log-container {
            background: #0f172a;
            color: #e2e8f0;
            padding: 20px;
            border-radius: 12px;
            font-family: 'Courier New', monospace;
            font-size: 0.85rem;
            direction: ltr;
            text-align: left;
            max-height: 400px;
            overflow-y: auto;
            margin-top: 20px;
            border: 1px solid #334155;
        }
        .log-entry {
            padding: 4px 0;
            border-bottom: 1px dotted #334155;
            color: #a5f3fc;
        }
        .log-entry.error {
            color: #fca5a5;
        }
        .log-entry.success {
            color: #86efac;
        }
        .flex-row {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }
        .badge {
            background: #e2e8f0;
            padding: 4px 12px;
            border-radius: 30px;
            font-size: 0.8rem;
            color: #334155;
        }
        hr {
            border: none;
            border-top: 1px solid #e2e8f0;
            margin: 20px 0;
        }
        .state-preview {
            background: #f8fafc;
            border: 1px solid #cbd5e1;
            border-radius: 8px;
            padding: 15px;
            font-family: monospace;
            direction: ltr;
            text-align: left;
            font-size: 0.8rem;
            margin-top: 15px;
        }
    </style>
</head>
<body>
<div class="container">
    <h1>ğŸ“‹ ØªØ³Øª Ø¯Ø³ØªÛŒ: ØµÙØ­Ù‡ Ù¾Ø±ÙˆÙØ§ÛŒÙ„ (Ù…Ø¯ÛŒØ±ÛŒØª State)</h1>
    <p style="margin-bottom: 20px;">Ø§ÛŒÙ† ØªØ³Øªâ€ŒÙ‡Ø§ ÙˆØ¶Ø¹ÛŒØª Ø¯Ø§Ø®Ù„ÛŒ ØµÙØ­Ù‡ Ù¾Ø±ÙˆÙØ§ÛŒÙ„ Ùˆ ØªØºÛŒÛŒØ±Ø§Øª Ø¢Ù† Ø±Ø§ Ø¨Ø¯ÙˆÙ† ÙˆØ§Ø¨Ø³ØªÚ¯ÛŒ Ø¨Ù‡ UI ÙˆØ§Ù‚Ø¹ÛŒ Ø¨Ø±Ø±Ø³ÛŒ Ù…ÛŒâ€ŒÚ©Ù†Ù†Ø¯.</p>

    <div class="test-grid">
        <!-- Ú©Ø§Ø±Øª Û±: Ù‡Ø³ØªÙ‡ State -->
        <div class="card">
            <h3>ğŸ”¹ Û±. Ù‡Ø³ØªÙ‡ State (immutability)</h3>
            <div class="flex-row">
                <button class="btn" id="testInitialState">âœ… ØªØ³Øª state Ø§ÙˆÙ„ÛŒÙ‡</button>
                <button class="btn secondary" id="testImmutability">ğŸ§ª ØªØ³Øª immutability</button>
            </div>
            <div class="badge">Ø§ÛŒØ²ÙˆÙ„Ù‡ Â· Ù‚Ø·Ø¹ÛŒ</div>
            <div style="margin-top: 15px; font-size: 0.9rem;">
                <span>state Ù¾ÛŒØ´â€ŒÙØ±Ø¶ Ø¨Ø§ÛŒØ¯ Ø´Ø§Ù…Ù„: userId, name, email, level, xp, streak, stats, settings</span>
            </div>
        </div>

        <!-- Ú©Ø§Ø±Øª Û²: Ø¨Ø±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ State -->
        <div class="card">
            <h3>ğŸ”¸ Û². Ø¨Ø±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ state</h3>
            <div class="flex-row">
                <button class="btn" id="testUpdateField">âœï¸ Ø¨Ø±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ ÙÛŒÙ„Ø¯</button>
                <button class="btn secondary" id="testNestedUpdate">ğŸ“¦ Ø¨Ø±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ ØªÙˆ Ø¯Ø± ØªÙˆ</button>
            </div>
            <div class="badge">ØªÚ©â€ŒØ§Ø¯Ø¹Ø§ Â· Ø¨Ø¯ÙˆÙ† Ø§Ø«Ø± Ø¬Ø§Ù†Ø¨ÛŒ</div>
            <div style="margin-top: 15px;">
                <button class="btn secondary" id="testBatchUpdate">âš¡ Ø¨Ø±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ú¯Ø±ÙˆÙ‡ÛŒ</button>
            </div>
        </div>

        <!-- Ú©Ø§Ø±Øª Û³: Ù…Ø­Ø§Ø³Ø¨Ø§Øª Ùˆ Ù…Ø´ØªÙ‚Ø§Øª -->
        <div class="card">
            <h3>ğŸ”¹ Û³. Ù…Ù‚Ø§Ø¯ÛŒØ± Ù…Ø´ØªÙ‚ (derived)</h3>
            <div class="flex-row">
                <button class="btn" id testNextLevel">ğŸ“ˆ Ù…Ø­Ø§Ø³Ø¨Ù‡ Ø³Ø·Ø­ Ø¨Ø¹Ø¯ÛŒ</button>
                <button class="btn secondary" id="testProgressPercent">ğŸ“Š Ø¯Ø±ØµØ¯ Ù¾ÛŒØ´Ø±ÙØª</button>
            </div>
            <div class="badge">Ù…Ù†Ø·Ù‚ Ù…Ø­Ø¶ Â· pure function</div>
            <div style="margin-top: 15px;">
                <button class="btn secondary" id="testStreakBonus">ğŸ”¥ Ù…Ø­Ø§Ø³Ø¨Ù‡ Ù¾Ø§Ø¯Ø§Ø´ Ø§Ø³ØªØ±ÛŒÚ©</button>
            </div>
        </div>

        <!-- Ú©Ø§Ø±Øª Û´: edge cases -->
        <div class="card">
            <h3>âš ï¸ Û´. Ù„Ø¨Ù‡â€ŒÙ‡Ø§ (edge cases)</h3>
            <div class="flex-row">
                <button class="btn" id="testNullField">ğŸ•³ï¸ ÙÛŒÙ„Ø¯ null/undefined</button>
                <button class="btn secondary" id="testInvalidType">ğŸš« Ù†ÙˆØ¹ Ù†Ø§Ù…Ø¹ØªØ¨Ø±</button>
            </div>
            <div class="badge">Ù…Ù‚Ø§ÙˆÙ… Â· fail safe</div>
            <div style="margin-top: 15px;">
                <button class="btn secondary" id="testResetState">ğŸ”„ Ø¨Ø§Ø²Ù†Ø´Ø§Ù†ÛŒ Ø¨Ù‡ initialState</button>
            </div>
        </div>
    </div>

    <!-- Ú©Ø§Ø±Øª Ûµ: Ø´Ø¨ÛŒÙ‡â€ŒØ³Ø§Ø²ÛŒ Ø¬Ø±ÛŒØ§Ù† Ú©Ø§Ø±Ø¨Ø± -->
    <div class="card" style="grid-column: 1/-1;">
        <h3>ğŸ§ª Ûµ. Ø´Ø¨ÛŒÙ‡â€ŒØ³Ø§Ø²ÛŒ Ø³Ù†Ø§Ø±ÛŒÙˆÛŒ Ú©Ø§Ø±Ø¨Ø± (flow simulation)</h3>
        <div class="flex-row">
            <button class="btn" id="testProfileLoad">ğŸ‘¤ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ù¾Ø±ÙˆÙØ§ÛŒÙ„</button>
            <button class="btn secondary" id="testProfileEdit">âœï¸ ÙˆÛŒØ±Ø§ÛŒØ´ Ùˆ Ø°Ø®ÛŒØ±Ù‡</button>
            <button class="btn secondary" id="testLevelUp">â¬†ï¸ Ø§Ø±ØªÙ‚Ø§ Ø³Ø·Ø­</button>
        </div>
        <div class="flex-row">
            <button class="btn secondary" id="testCompleteFlow">ğŸ”„ Ø§Ø¬Ø±Ø§ÛŒ Ú¯Ø§Ù…â€ŒØ¨Ù‡â€ŒÚ¯Ø§Ù… Ú©Ø§Ù…Ù„</button>
        </div>
        <div class="badge">Ø³Ù†Ø§Ø±ÛŒÙˆÛŒ Ø§Ù†Ø³Ø§Ù†ÛŒ Â· Ù„Ø§Ú¯ Ø´ÙØ§Ù</div>
    </div>

    <!-- Ù†Ù…Ø§ÛŒØ´Ú¯Ø± state ÙØ¹Ù„ÛŒ (Ø´Ø¨ÛŒÙ‡â€ŒØ³Ø§Ø²ÛŒ Ø´Ø¯Ù‡) -->
    <div class="state-preview" id="statePreview">
        <strong>ğŸ“Œ state ÙØ¹Ù„ÛŒ (Ø¨Ø±Ø§ÛŒ ØªØ³Øªâ€ŒÙ‡Ø§):</strong> <span id="stateDisplay">(Ù¾Ø³ Ø§Ø² Ù‡Ø± ØªØ³Øª Ø¨Ù‡â€ŒØ±ÙˆØ² Ù…ÛŒâ€ŒØ´ÙˆØ¯)</span>
    </div>

    <!-- Ù„Ø§Ú¯ Ù…Ø¬Ø§Ø²ÛŒ -->
    <div class="log-container" id="logContainer">
        <div class="log-entry">âœ… Ø¢Ù…Ø§Ø¯Ù‡â€ŒØ³Ø§Ø²ÛŒ ØªØ³Øªâ€ŒÙ‡Ø§ÛŒ state Ù¾Ø±ÙˆÙØ§ÛŒÙ„ ...</div>
    </div>
</div>

<script>
    (function() {
        // ----- Ø§ØµÙˆÙ„ Ø­Ø±ÙÙ‡â€ŒØ§ÛŒ: Tool-Agnostic, Deterministic, Isolated -----
        
        // Û±. ØªØ¹Ø±ÛŒÙ initialState (Ù…Ø­Ø¶ØŒ Ù‚Ø§Ø¨Ù„ Ù¾ÛŒØ´â€ŒØ¨ÛŒÙ†ÛŒ)
        const INITIAL_STATE = {
            userId: 'user_123',
            name: 'Ø¹Ù„ÛŒØ±Ø¶Ø§ Ú©Ø§Ø¸Ù…ÛŒ',
            email: 'alireza@example.com',
            level: 3,
            xp: 280,
            nextLevelXp: 400,
            streak: 7,
            stats: {
                lessonsCompleted: 24,
                totalReviews: 156,
                avgAccuracy: 78.5,
                perfectReviews: 12
            },
            settings: {
                darkMode: false,
                notifications: true,
                language: 'fa'
            },
            lastUpdated: '2026-02-18T10:30:00Z'
        };

        // state Ø¬Ø§Ø±ÛŒ (Ø¨Ø±Ø§ÛŒ ØªØ³Øªâ€ŒÙ‡Ø§ØŒ Ù‡Ø± Ø¨Ø§Ø± clone Ù…ÛŒâ€ŒÚ©Ù†ÛŒÙ… ØªØ§ Ø§ÛŒØ²ÙˆÙ„Ù‡ Ø¨Ù…Ø§Ù†Ø¯)
        let currentState = JSON.parse(JSON.stringify(INITIAL_STATE));
        
        // Ø§Ù„Ù…Ø§Ù†â€ŒÙ‡Ø§ÛŒ DOM
        const logContainer = document.getElementById('logContainer');
        const stateDisplay = document.getElementById('stateDisplay');
        
        // Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ù†Ù…Ø§ÛŒØ´ state
        function updateStatePreview() {
            stateDisplay.innerText = JSON.stringify(currentState, null, 2).substring(0, 150) + '...';
        }

        // ØªØ§Ø¨Ø¹ Ú©Ù…Ú©ÛŒ Ø¨Ø±Ø§ÛŒ clone Ø¹Ù…ÛŒÙ‚ (Ø¬Ø¯Ø§Ø³Ø§Ø²ÛŒ)
        function deepClone(obj) {
            return JSON.parse(JSON.stringify(obj));
        }

        // ØªØ§Ø¨Ø¹ Ù„Ø§Ú¯ (Ù‚Ø§Ø¨Ù„ Ù…Ø´Ø§Ù‡Ø¯Ù‡ Ø¯Ø± console Ù…Ø¬Ø§Ø²ÛŒ)
        function addLog(message, type = 'info') {
            const logDiv = document.createElement('div');
            logDiv.className = `log-entry ${type === 'error' ? 'error' : (type === 'success' ? 'success' : '')}`;
            logDiv.textContent = `> ${new Date().toLocaleTimeString('fa-IR')} â€“ ${message}`;
            logContainer.appendChild(logDiv);
            logContainer.scrollTop = logContainer.scrollHeight;
            // Ù‡Ù…Ø²Ù…Ø§Ù† Ø¯Ø± Ú©Ù†Ø³ÙˆÙ„ ÙˆØ§Ù‚Ø¹ÛŒ Ù‡Ù… Ù„Ø§Ú¯ Ù…ÛŒâ€ŒÚ©Ù†ÛŒÙ… (Ø´ÙØ§ÙÛŒØª)
            console.log(`[Profile State Test] ${message}`);
        }

        // ØªØ§Ø¨Ø¹ Ø±ÛŒØ³Øª state Ø¨Ù‡ initialState (Ø¨Ø±Ø§ÛŒ Ø§ÛŒØ²ÙˆÙ„Ù‡ Ø¨ÙˆØ¯Ù† ØªØ³Øªâ€ŒÙ‡Ø§)
        function resetState() {
            currentState = deepClone(INITIAL_STATE);
            addLog('state Ø¨Ù‡ initialState Ø¨Ø§Ø²Ù†Ø´Ø§Ù†ÛŒ Ø´Ø¯ (Ø§ÛŒØ²ÙˆÙ„Ù‡â€ŒØ³Ø§Ø²ÛŒ)', 'info');
            updateStatePreview();
        }

        // ----- ØªÙˆØ§Ø¨Ø¹ Ù…Ø­Ø¶ (pure) Ø¨Ø±Ø§ÛŒ ØªØ³Øª Ù…Ù†Ø·Ù‚ -----

        // Ù…Ø­Ø§Ø³Ø¨Ù‡ Ø³Ø·Ø­ Ø¨Ø¹Ø¯ÛŒ (pure)
        function getNextLevel(currentLevel, xp) {
            if (typeof currentLevel !== 'number' || typeof xp !== 'number') return null;
            const xpNeeded = (currentLevel + 1) * 100; // ÙØ±Ù…ÙˆÙ„ Ø³Ø§Ø¯Ù‡
            return {
                currentLevel,
                nextLevel: currentLevel + 1,
                xpNeeded,
                xpProgress: Math.min(100, Math.floor((xp / xpNeeded) * 100))
            };
        }

        // Ù…Ø­Ø§Ø³Ø¨Ù‡ Ø¯Ø±ØµØ¯ Ù¾ÛŒØ´Ø±ÙØª ØªØ§ Ø³Ø·Ø­ Ø¨Ø¹Ø¯ÛŒ (pure)
        function getProgressPercent(xp, nextLevelXp) {
            if (typeof xp !== 'number' || typeof nextLevelXp !== 'number' || nextLevelXp <= 0) return 0;
            return Math.min(100, Math.floor((xp / nextLevelXp) * 100));
        }

        // Ù…Ø­Ø§Ø³Ø¨Ù‡ Ù¾Ø§Ø¯Ø§Ø´ Ø§Ø³ØªØ±ÛŒÚ© (pure)
        function getStreakBonus(streak) {
            if (typeof streak !== 'number' || streak < 0) return 0;
            if (streak >= 30) return 50;
            if (streak >= 14) return 30;
            if (streak >= 7) return 15;
            if (streak >= 3) return 5;
            return 0;
        }

        // Ø¨Ø±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ø§ÛŒÙ…Ù† state (immutable)
        function updateState(state, updates) {
            // Ø¨Ø±Ø±Ø³ÛŒ ÙˆØ¬ÙˆØ¯ state
            if (!state || typeof state !== 'object') return deepClone(INITIAL_STATE);
            
            const newState = deepClone(state);
            let changed = false;

            // Ø§Ø¹Ù…Ø§Ù„ Ø¨Ø±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒâ€ŒÙ‡Ø§ÛŒ Ø³Ø§Ø¯Ù‡
            for (let key in updates) {
                if (updates.hasOwnProperty(key) && newState.hasOwnProperty(key)) {
                    // Ø§Ú¯Ø± Ù…Ù‚Ø¯Ø§Ø± Ø¬Ø¯ÛŒØ¯ undefined Ù†Ø¨Ø§Ø´Ø¯
                    if (updates[key] !== undefined) {
                        newState[key] = updates[key];
                        changed = true;
                    }
                }
            }
            return changed ? newState : state;
        }

        // Ø¨Ø±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ ØªÙˆ Ø¯Ø± ØªÙˆ (Ø§ÛŒÙ…Ù†)
        function updateNested(state, path, value) {
            if (!state || !path || path.length === 0) return state;
            const newState = deepClone(state);
            let current = newState;
            for (let i = 0; i < path.length - 1; i++) {
                if (!current[path[i]] || typeof current[path[i]] !== 'object') {
                    current[path[i]] = {};
                }
                current = current[path[i]];
            }
            const lastKey = path[path.length - 1];
            if (value === undefined) {
                delete current[lastKey];
            } else {
                current[lastKey] = value;
            }
            return newState;
        }

        // ----- ØªØ³Øªâ€ŒÙ‡Ø§ÛŒ Ø¯Ø³ØªÛŒ (Ø¨Ø§ Ø¯Ú©Ù…Ù‡) -----

        // Û±. ØªØ³Øª state Ø§ÙˆÙ„ÛŒÙ‡
        document.getElementById('testInitialState').addEventListener('click', () => {
            resetState(); // Ø§ÛŒØ²ÙˆÙ„Ù‡
            addLog('ØªØ³Øª state Ø§ÙˆÙ„ÛŒÙ‡:');
            addLog(`  Ù†Ø§Ù…: ${currentState.name} (ÙˆØ§Ù‚Ø¹ÛŒ)`);
            addLog(`  Ø§ÛŒÙ…ÛŒÙ„: ${currentState.email}`);
            addLog(`  Ø³Ø·Ø­: ${currentState.level}ØŒ XP: ${currentState.xp}`);
            addLog(`  Ø§Ø³ØªØ±ÛŒÚ©: ${currentState.streak} Ø±ÙˆØ²Ù‡`);
            addLog('âœ… state Ø§ÙˆÙ„ÛŒÙ‡ Ø¨Ù‡ Ø¯Ø±Ø³ØªÛŒ Ù…Ù‚Ø¯Ø§Ø±Ø¯Ù‡ÛŒ Ø´Ø¯Ù‡ Ø§Ø³Øª.', 'success');
        });

        // Û². ØªØ³Øª immutability (Ø¹Ø¯Ù… ØªØºÛŒÛŒØ± state Ø§ØµÙ„ÛŒ)
        document.getElementById('testImmutability').addEventListener('click', () => {
            resetState();
            const oldState = deepClone(currentState);
            // ØªÙ„Ø§Ø´ Ø¨Ø±Ø§ÛŒ ØªØºÛŒÛŒØ± Ù…Ø³ØªÙ‚ÛŒÙ… (Ú©Ù‡ Ù†Ø¨Ø§ÛŒØ¯ Ø§Ù†Ø¬Ø§Ù… Ø´ÙˆØ¯)
            const mutated = currentState;
            mutated.name = 'Ù†Ø§Ù… ØªØºÛŒÛŒØ± ÛŒØ§ÙØªÙ‡ (ØºÛŒØ±Ù…Ø¬Ø§Ø²)';
            
            // Ø¨Ø±Ø±Ø³ÛŒ Ù…ÛŒâ€ŒÚ©Ù†ÛŒÙ… Ú©Ù‡ Ø¢ÛŒØ§ state Ø§ØµÙ„ÛŒ ØªØºÛŒÛŒØ± Ú©Ø±Ø¯Ù‡ØŸ (Ø¯Ø± Ú©Ø¯ ÙˆØ§Ù‚Ø¹ÛŒ Ù†Ø¨Ø§ÛŒØ¯ Ø§ÛŒÙ† Ø§ØªÙØ§Ù‚ Ø¨ÛŒÙØªØ¯)
            if (currentState.name === oldState.name) {
                addLog('âœ… immutability Ø±Ø¹Ø§ÛŒØª Ø´Ø¯Ù‡: ØªØºÛŒÛŒØ± Ù…Ø³ØªÙ‚ÛŒÙ… Ø±ÙˆÛŒ state Ø§ØµÙ„ÛŒ ØªØ£Ø«ÛŒØ±ÛŒ Ù†Ú¯Ø°Ø§Ø´Øª.', 'success');
            } else {
                addLog('âŒ Ù…Ø´Ú©Ù„: state Ø§ØµÙ„ÛŒ ØªØºÛŒÛŒØ± Ú©Ø±Ø¯! (immutability Ù†Ù‚Ø¶ Ø´Ø¯)', 'error');
                // Ø¨Ø±Ú¯Ø±Ø¯Ø§Ù†Ø¯Ù† Ø¨Ù‡ Ø­Ø§Ù„Øª Ù‚Ø¨Ù„
                currentState = deepClone(oldState);
            }
            updateStatePreview();
        });

        // Û³. Ø¨Ø±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ ÙÛŒÙ„Ø¯
        document.getElementById('testUpdateField').addEventListener('click', () => {
            resetState();
            const newName = 'Ø±Ø¶Ø§ Ù…Ø­Ù…Ø¯ÛŒ';
            const newState = updateState(currentState, { name: newName, xp: 310 });
            
            addLog('Ø¨Ø±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ ÙÛŒÙ„Ø¯: name Ùˆ xp');
            addLog(`  Ù‚Ø¨Ù„ÛŒ: name=${currentState.name}, xp=${currentState.xp}`);
            
            currentState = newState;
            addLog(`  Ø¨Ø¹Ø¯ÛŒ: name=${currentState.name}, xp=${currentState.xp}`);
            
            if (currentState.name === newName && currentState.xp === 310) {
                addLog('âœ… Ø¨Ø±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ù…ÙˆÙÙ‚', 'success');
            } else {
                addLog('âŒ Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ', 'error');
            }
            updateStatePreview();
        });

        // Û´. Ø¨Ø±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ ØªÙˆ Ø¯Ø± ØªÙˆ
        document.getElementById('testNestedUpdate').addEventListener('click', () => {
            resetState();
            const oldAccuracy = currentState.stats.avgAccuracy;
            // Ø¨Ø±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ stats.avgAccuracy
            currentState = updateNested(currentState, ['stats', 'avgAccuracy'], 85.0);
            
            addLog('Ø¨Ø±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ ØªÙˆ Ø¯Ø± ØªÙˆ: stats.avgAccuracy');
            addLog(`  Ù‚Ø¨Ù„ÛŒ: ${oldAccuracy}%`);
            addLog(`  Ø¨Ø¹Ø¯ÛŒ: ${currentState.stats.avgAccuracy}%`);
            
            if (currentState.stats.avgAccuracy === 85.0) {
                addLog('âœ… Ø¨Ø±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ ØªÙˆ Ø¯Ø± ØªÙˆ Ù…ÙˆÙÙ‚', 'success');
            } else {
                addLog('âŒ Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ ØªÙˆ Ø¯Ø± ØªÙˆ', 'error');
            }
            updateStatePreview();
        });

        // Ûµ. Ø¨Ø±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ú¯Ø±ÙˆÙ‡ÛŒ (batch)
        document.getElementById('testBatchUpdate').addEventListener('click', () => {
            resetState();
            const updates = {
                level: 4,
                xp: 150,
                streak: 8,
                'stats.lessonsCompleted': 25  // Ø§ÛŒÙ† Ø³Ø§Ø¯Ù‡ Ø´Ø¯Ù‡ØŒ Ø¯Ø± ÙˆØ§Ù‚Ø¹ nested Ø¨Ø§ÛŒØ¯ Ø¬Ø¯Ø§Ú¯Ø§Ù†Ù‡ update Ø´ÙˆØ¯
            };
            // Ø¨Ø±Ø§ÛŒ Ø³Ø§Ø¯Ú¯ÛŒ Ø¯Ùˆ ØªØ§ nested Ø±Ø§ Ø¬Ø¯Ø§ Ù…ÛŒâ€ŒÚ©Ù†ÛŒÙ…
            currentState = updateState(currentState, { level: 4, xp: 150, streak: 8 });
            currentState = updateNested(currentState, ['stats', 'lessonsCompleted'], 25);
            
            addLog('Ø¨Ø±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ú¯Ø±ÙˆÙ‡ÛŒ (level, xp, streak, lessonsCompleted)');
            addLog(`  Ø³Ø·Ø­: ${currentState.level}, XP: ${currentState.xp}, Ø§Ø³ØªØ±ÛŒÚ©: ${currentState.streak}, Ø¯Ø±Ø³â€ŒÙ‡Ø§: ${currentState.stats.lessonsCompleted}`);
            
            if (currentState.level === 4 && currentState.stats.lessonsCompleted === 25) {
                addLog('âœ… Ø¨Ø±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ú¯Ø±ÙˆÙ‡ÛŒ Ù…ÙˆÙÙ‚', 'success');
            } else {
                addLog('âŒ Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ú¯Ø±ÙˆÙ‡ÛŒ', 'error');
            }
            updateStatePreview();
        });

        // Û¶. Ù…Ø­Ø§Ø³Ø¨Ù‡ Ø³Ø·Ø­ Ø¨Ø¹Ø¯ÛŒ
        document.getElementById('testNextLevel').addEventListener('click', () => {
            resetState();
            const next = getNextLevel(currentState.level, currentState.xp);
            addLog(`Ù…Ø­Ø§Ø³Ø¨Ù‡ Ø³Ø·Ø­ Ø¨Ø¹Ø¯ÛŒ: Ø³Ø·Ø­ ÙØ¹Ù„ÛŒ ${next.currentLevel}ØŒ Ø³Ø·Ø­ Ø¨Ø¹Ø¯ÛŒ ${next.nextLevel}`);
            addLog(`  Ù†ÛŒØ§Ø² Ø¨Ù‡ XP: ${next.xpNeeded}ØŒ Ù¾ÛŒØ´Ø±ÙØª: ${next.xpProgress}%`);
            if (next.xpNeeded > 0 && next.xpProgress < 100) {
                addLog('âœ… Ù…Ø­Ø§Ø³Ø¨Ù‡ Ø³Ø·Ø­ Ø¨Ø¹Ø¯ÛŒ ØµØ­ÛŒØ­ Ø§Ø³Øª', 'success');
            } else {
                addLog('âš ï¸ Ù…Ù‚Ø§Ø¯ÛŒØ± ØºÛŒØ±Ù…Ù†ØªØ¸Ø±Ù‡', 'error');
            }
        });

        // Û·. Ø¯Ø±ØµØ¯ Ù¾ÛŒØ´Ø±ÙØª
        document.getElementById('testProgressPercent').addEventListener('click', () => {
            resetState();
            const percent = getProgressPercent(currentState.xp, currentState.nextLevelXp);
            addLog(`Ø¯Ø±ØµØ¯ Ù¾ÛŒØ´Ø±ÙØª ØªØ§ Ø³Ø·Ø­ Ø¨Ø¹Ø¯ÛŒ: ${percent}% (XP: ${currentState.xp}/${currentState.nextLevelXp})`);
            if (percent >= 0 && percent <= 100) {
                addLog('âœ… Ù…Ø­Ø§Ø³Ø¨Ù‡ Ø¯Ø±ØµØ¯ Ù…Ø¹ØªØ¨Ø± Ø§Ø³Øª', 'success');
            } else {
                addLog('âŒ Ø¯Ø±ØµØ¯ Ø®Ø§Ø±Ø¬ Ø§Ø² Ù…Ø­Ø¯ÙˆØ¯Ù‡', 'error');
            }
        });

        // Û¸. Ù¾Ø§Ø¯Ø§Ø´ Ø§Ø³ØªØ±ÛŒÚ©
        document.getElementById('testStreakBonus').addEventListener('click', () => {
            resetState();
            const bonus = getStreakBonus(currentState.streak);
            addLog(`Ù¾Ø§Ø¯Ø§Ø´ Ø§Ø³ØªØ±ÛŒÚ© ${currentState.streak} Ø±ÙˆØ²Ù‡: ${bonus} Ø§Ù…ØªÛŒØ§Ø² Ø§Ø¶Ø§ÙÙ‡`);
            
            const testCases = [
                { streak: 2, expected: 0 },
                { streak: 5, expected: 5 },
                { streak: 10, expected: 15 },
                { streak: 20, expected: 30 },
                { streak: 40, expected: 50 }
            ];
            addLog('ØªØ³Øª Ù…ÙˆØ§Ø±Ø¯ Ù…Ø±Ø²ÛŒ:');
            testCases.forEach(tc => {
                const res = getStreakBonus(tc.streak);
                addLog(`  Ø§Ø³ØªØ±ÛŒÚ© ${tc.streak} â†’ ${res} (Ø§Ù†ØªØ¸Ø§Ø± ${tc.expected}) ${res === tc.expected ? 'âœ“' : 'âœ—'}`);
            });
        });

        // Û¹. ÙÛŒÙ„Ø¯ null/undefined
        document.getElementById('testNullField').addEventListener('click', () => {
            resetState();
            const oldName = currentState.name;
            // ØªÙ„Ø§Ø´ Ø¨Ø±Ø§ÛŒ set Ú©Ø±Ø¯Ù† undefined (Ø¨Ø§ÛŒØ¯ Ù†Ø§Ø¯ÛŒØ¯Ù‡ Ú¯Ø±ÙØªÙ‡ Ø´ÙˆØ¯)
            const newState = updateState(currentState, { name: undefined, xp: null });
            addLog('ØªØ³Øª ÙÛŒÙ„Ø¯ null/undefined: ØªÙ„Ø§Ø´ Ø¨Ø±Ø§ÛŒ set name=undefined, xp=null');
            addLog(`  name Ø¨Ø¹Ø¯ Ø§Ø² update: ${newState.name} (Ø¨Ø§ÛŒØ¯ unchanged Ø¨Ø§Ø´Ø¯)`);
            addLog(`  xp Ø¨Ø¹Ø¯ Ø§Ø² update: ${newState.xp} (Ø¨Ø§ÛŒØ¯ unchanged Ø¨Ø§Ø´Ø¯)`);
            
            if (newState.name === oldName && newState.xp === 280) {
                addLog('âœ… Ù…Ù‚Ø§Ø¯ÛŒØ± undefined/null Ù†Ø§Ø¯ÛŒØ¯Ù‡ Ú¯Ø±ÙØªÙ‡ Ø´Ø¯Ù†Ø¯', 'success');
            } else {
                addLog('âŒ state ØªØºÛŒÛŒØ± Ú©Ø±Ø¯ (Ù†Ø¨Ø§ÛŒØ¯)', 'error');
            }
        });

        // Û±Û°. Ù†ÙˆØ¹ Ù†Ø§Ù…Ø¹ØªØ¨Ø±
        document.getElementById('testInvalidType').addEventListener('click', () => {
            resetState();
            const oldLevel = currentState.level;
            // ØªÙ„Ø§Ø´ Ø¨Ø±Ø§ÛŒ set Ø³Ø·Ø­ Ø¨Ø§ string
            const newState = updateState(currentState, { level: 'Ù¾Ù†Ø¬' });
            addLog('ØªØ³Øª Ù†ÙˆØ¹ Ù†Ø§Ù…Ø¹ØªØ¨Ø±: ØªÙ„Ø§Ø´ Ø¨Ø±Ø§ÛŒ set level="Ù¾Ù†Ø¬" (string)');
            addLog(`  level Ø¨Ø¹Ø¯ Ø§Ø² update: ${newState.level} (Ø¨Ø§ÛŒØ¯ unchanged Ø¨Ø§Ø´Ø¯)`);
            
            if (newState.level === oldLevel) {
                addLog('âœ… Ù†ÙˆØ¹ Ù†Ø§Ù…Ø¹ØªØ¨Ø± Ù†Ø§Ø¯ÛŒØ¯Ù‡ Ú¯Ø±ÙØªÙ‡ Ø´Ø¯', 'success');
            } else {
                addLog('âŒ state Ø¨Ø§ Ù†ÙˆØ¹ Ù†Ø§Ù…Ø¹ØªØ¨Ø± ØªØºÛŒÛŒØ± Ú©Ø±Ø¯', 'error');
            }
        });

        // Û±Û±. Ø¨Ø§Ø²Ù†Ø´Ø§Ù†ÛŒ state
        document.getElementById('testResetState').addEventListener('click', () => {
            // Ø§ÙˆÙ„ state Ø±Ø§ ØªØºÛŒÛŒØ± Ù…ÛŒâ€ŒØ¯Ù‡ÛŒÙ…
            currentState = updateState(currentState, { name: 'Ù†Ø§Ù… Ù…ÙˆÙ‚Øª', level: 99 });
            addLog('state Ø¨Ù‡ Ù†Ø§Ù… Ù…ÙˆÙ‚Øª ØªØºÛŒÛŒØ± ÛŒØ§ÙØª');
            // Ø³Ù¾Ø³ Ø±ÛŒØ³Øª
            resetState();
            addLog('âœ… Ø¨Ø§Ø²Ù†Ø´Ø§Ù†ÛŒ Ø¨Ù‡ initialState Ø§Ù†Ø¬Ø§Ù… Ø´Ø¯', 'success');
        });

        // Û±Û². Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ù¾Ø±ÙˆÙØ§ÛŒÙ„ (Ø´Ø¨ÛŒÙ‡â€ŒØ³Ø§Ø²ÛŒ)
        document.getElementById('testProfileLoad').addEventListener('click', () => {
            resetState();
            addLog('Ø´Ø¨ÛŒÙ‡â€ŒØ³Ø§Ø²ÛŒ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ù¾Ø±ÙˆÙØ§ÛŒÙ„ Ø§Ø² Ø³Ø±ÙˆØ± (fake)');
            // ÙØ±Ø¶ Ù…ÛŒâ€ŒÚ©Ù†ÛŒÙ… Ø¯Ø§Ø¯Ù‡ Ø¬Ø¯ÛŒØ¯ Ø§Ø² Ø±Ø§Ù‡ Ø±Ø³ÛŒØ¯Ù‡
            const serverData = {
                ...currentState,
                name: 'Ø¹Ù„ÛŒ Ù†Ø§Ø¯Ø±ÛŒ',
                xp: 415,
                level: 4,
                streak: 14
            };
            currentState = deepClone(serverData);
            addLog(`  Ù†Ø§Ù…: ${currentState.name}, Ø³Ø·Ø­: ${currentState.level}, XP: ${currentState.xp}, Ø§Ø³ØªØ±ÛŒÚ©: ${currentState.streak}`);
            addLog('âœ… Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ù¾Ø±ÙˆÙØ§ÛŒÙ„ Ù…ÙˆÙÙ‚', 'success');
            updateStatePreview();
        });

        // Û±Û³. ÙˆÛŒØ±Ø§ÛŒØ´ Ùˆ Ø°Ø®ÛŒØ±Ù‡
        document.getElementById('testProfileEdit').addEventListener('click', () => {
            resetState();
            addLog('Ø´Ø¨ÛŒÙ‡â€ŒØ³Ø§Ø²ÛŒ ÙˆÛŒØ±Ø§ÛŒØ´ Ù¾Ø±ÙˆÙØ§ÛŒÙ„: ØªØºÛŒÛŒØ± name Ùˆ Ø§ÛŒÙ…ÛŒÙ„');
            const edits = {
                name: 'Ù…Ø­Ù…Ø¯ Ø§Ø­Ù…Ø¯ÛŒ',
                email: 'm.ahmadi@example.com'
            };
            currentState = updateState(currentState, edits);
            addLog(`  Ù†Ø§Ù… Ø¬Ø¯ÛŒØ¯: ${currentState.name}, Ø§ÛŒÙ…ÛŒÙ„ Ø¬Ø¯ÛŒØ¯: ${currentState.email}`);
            
            if (currentState.name === edits.name && currentState.email === edits.email) {
                addLog('âœ… ÙˆÛŒØ±Ø§ÛŒØ´ Ùˆ Ø°Ø®ÛŒØ±Ù‡ Ù…ÙˆÙÙ‚', 'success');
            } else {
                addLog('âŒ Ø®Ø·Ø§ Ø¯Ø± ÙˆÛŒØ±Ø§ÛŒØ´', 'error');
            }
            updateStatePreview();
        });

        // Û±Û´. Ø§Ø±ØªÙ‚Ø§ Ø³Ø·Ø­
        document.getElementById('testLevelUp').addEventListener('click', () => {
            resetState();
            const oldLevel = currentState.level;
            const oldXp = currentState.xp;
            // Ø´Ø¨ÛŒÙ‡â€ŒØ³Ø§Ø²ÛŒ Ø§Ø±ØªÙ‚Ø§ Ø³Ø·Ø­
            currentState = updateState(currentState, { 
                level: currentState.level + 1,
                xp: currentState.xp - 300  // ÙØ±Ø¶ Ú©Ù†ÛŒØ¯ 300 Ø®Ø±Ø¬ Ø´Ø¯Ù‡
            });
            addLog(`Ø§Ø±ØªÙ‚Ø§ Ø³Ø·Ø­: Ø³Ø·Ø­ ${oldLevel} â†’ ${currentState.level}`);
            addLog(`  XP Ù‚Ø¨Ù„ÛŒ: ${oldXp}, XP Ø¬Ø¯ÛŒØ¯: ${currentState.xp}`);
            
            if (currentState.level === oldLevel + 1) {
                addLog('âœ… Ø§Ø±ØªÙ‚Ø§ Ø³Ø·Ø­ Ù…ÙˆÙÙ‚', 'success');
            } else {
                addLog('âŒ Ø®Ø·Ø§ Ø¯Ø± Ø§Ø±ØªÙ‚Ø§ Ø³Ø·Ø­', 'error');
            }
            updateStatePreview();
        });

        // Û±Ûµ. Ø¬Ø±ÛŒØ§Ù† Ú©Ø§Ù…Ù„
        document.getElementById('testCompleteFlow').addEventListener('click', () => {
            resetState();
            addLog('ğŸ”¥ Ø´Ø±ÙˆØ¹ Ø´Ø¨ÛŒÙ‡â€ŒØ³Ø§Ø²ÛŒ Ø¬Ø±ÛŒØ§Ù† Ú©Ø§Ù…Ù„ Ú©Ø§Ø±Ø¨Ø± Ø¯Ø± ØµÙØ­Ù‡ Ù¾Ø±ÙˆÙØ§ÛŒÙ„');
            
            // Ú¯Ø§Ù… Û±: Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ù¾Ø±ÙˆÙØ§ÛŒÙ„
            addLog('Ú¯Ø§Ù… Û±: Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ù¾Ø±ÙˆÙØ§ÛŒÙ„ Ø§Ø² Ø¯ÛŒØªØ§Ø¨ÛŒØ³');
            // Ù‚Ø¨Ù„Ø§Ù‹ reset Ø´Ø¯Ù‡
            
            // Ú¯Ø§Ù… Û²: Ù†Ù…Ø§ÛŒØ´ Ø¢Ù…Ø§Ø±
            addLog(`Ú¯Ø§Ù… Û²: Ù†Ù…Ø§ÛŒØ´ Ø¢Ù…Ø§Ø± - Ø¯Ø±Ø³â€ŒÙ‡Ø§ÛŒ ØªÚ©Ù…ÛŒÙ„ Ø´Ø¯Ù‡: ${currentState.stats.lessonsCompleted}, Ø¯Ù‚Øª: ${currentState.stats.avgAccuracy}%`);
            
            // Ú¯Ø§Ù… Û³: ÙˆÛŒØ±Ø§ÛŒØ´ Ù¾Ø±ÙˆÙØ§ÛŒÙ„
            addLog('Ú¯Ø§Ù… Û³: ÙˆÛŒØ±Ø§ÛŒØ´ Ù¾Ø±ÙˆÙØ§ÛŒÙ„ (ØªØºÛŒÛŒØ± Ù†Ø§Ù…)');
            currentState = updateState(currentState, { name: 'Ú©Ø§Ø¸Ù… Ø±Ø¶Ø§ÛŒÛŒ' });
            
            // Ú¯Ø§Ù… Û´: Ø§Ø±ØªÙ‚Ø§ Ø³Ø·Ø­
            addLog('Ú¯Ø§Ù… Û´: Ø¯Ø±ÛŒØ§ÙØª XP Ùˆ Ø§Ø±ØªÙ‚Ø§ Ø³Ø·Ø­');
            currentState = updateState(currentState, { xp: currentState.xp + 150 });
            if (currentState.xp >= currentState.nextLevelXp) {
                currentState = updateState(currentState, { level: currentState.level + 1, xp: currentState.xp - currentState.nextLevelXp });
                addLog(`  Ø§Ø±ØªÙ‚Ø§ Ø¨Ù‡ Ø³Ø·Ø­ ${currentState.level} Ø¨Ø§ XP Ø¨Ø§Ù‚ÛŒÙ…Ø§Ù†Ø¯Ù‡ ${currentState.xp}`);
            }
            
            // Ú¯Ø§Ù… Ûµ: Ø§ÙØ²Ø§ÛŒØ´ Ø§Ø³ØªØ±ÛŒÚ©
            addLog('Ú¯Ø§Ù… Ûµ: Ø§ÙØ²Ø§ÛŒØ´ Ø§Ø³ØªØ±ÛŒÚ© Ø±ÙˆØ²Ø§Ù†Ù‡');
            currentState = updateState(currentState, { streak: currentState.streak + 1 });
            
            // Ú¯Ø§Ù… Û¶: Ø°Ø®ÛŒØ±Ù‡ Ù†Ù‡Ø§ÛŒÛŒ
            addLog('Ú¯Ø§Ù… Û¶: Ø°Ø®ÛŒØ±Ù‡ Ù†Ù‡Ø§ÛŒÛŒ state');
            
            addLog('âœ… Ø¬Ø±ÛŒØ§Ù† Ú©Ø§Ù…Ù„ Ù¾Ø±ÙˆÙØ§ÛŒÙ„ Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø´Ø¨ÛŒÙ‡â€ŒØ³Ø§Ø²ÛŒ Ø´Ø¯.', 'success');
            addLog(`  ÙˆØ¶Ø¹ÛŒØª Ù†Ù‡Ø§ÛŒÛŒ - Ù†Ø§Ù…: ${currentState.name}, Ø³Ø·Ø­: ${currentState.level}, XP: ${currentState.xp}, Ø§Ø³ØªØ±ÛŒÚ©: ${currentState.streak}`);
            
            updateStatePreview();
        });

        // Ù†Ù…Ø§ÛŒØ´ Ø§ÙˆÙ„ÛŒÙ‡
        resetState();
        addLog('âœ… Ù‡Ù…Ù‡ Ø¯Ú©Ù…Ù‡â€ŒÙ‡Ø§ Ø¢Ù…Ø§Ø¯Ù‡â€ŒØ§Ù†Ø¯. Ù‡Ø± ØªØ³Øª Ø§ÛŒØ²ÙˆÙ„Ù‡ Ùˆ Ù‚Ø§Ø¨Ù„ ØªÚ©Ø±Ø§Ø± Ø§Ø³Øª.', 'success');
    })();
</script>
</body>
</html>
