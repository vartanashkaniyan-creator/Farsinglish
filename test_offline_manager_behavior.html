<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ØªØ³Øª Ø¯Ø³ØªÛŒ: Offline Manager | Farsinglish</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            padding: 20px;
            background-color: #f5f5f5;
            color: #333;
            max-width: 800px;
            margin: 0 auto;
        }
        h1 {
            color: #6a1b9a;
            font-size: 1.6rem;
            border-bottom: 2px solid #6a1b9a;
            padding-bottom: 10px;
            margin-bottom: 20px;
        }
        h2 {
            font-size: 1.2rem;
            color: #444;
            margin-top: 25px;
            margin-bottom: 10px;
        }
        .test-container {
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
            padding: 20px;
            margin-bottom: 25px;
        }
        .button-group {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin: 15px 0;
        }
        button {
            background-color: #6a1b9a;
            color: white;
            border: none;
            border-radius: 8px;
            padding: 10px 16px;
            font-size: 1rem;
            cursor: pointer;
            transition: background-color 0.2s;
            flex: 1 0 auto;
            min-width: 140px;
        }
        button:hover {
            background-color: #8e24aa;
        }
        button.secondary {
            background-color: #f57c00;
        }
        button.secondary:hover {
            background-color: #ff9800;
        }
        button.warning {
            background-color: #c2185b;
        }
        button.warning:hover {
            background-color: #d81b60;
        }
        .console {
            background-color: #111;
            color: #0f0;
            font-family: 'Courier New', monospace;
            padding: 15px;
            border-radius: 8px;
            height: 250px;
            overflow-y: auto;
            font-size: 0.9rem;
            margin-top: 20px;
            direction: ltr;
            text-align: left;
        }
        .console p {
            margin: 2px 0;
            border-bottom: 1px solid #333;
            padding: 2px 0;
        }
        .status-badge {
            display: inline-block;
            padding: 6px 12px;
            border-radius: 20px;
            font-weight: bold;
            margin: 10px 0;
        }
        .online {
            background-color: #4caf50;
            color: white;
        }
        .offline {
            background-color: #f44336;
            color: white;
        }
        .unknown {
            background-color: #9e9e9e;
            color: white;
        }
        hr {
            border: 1px solid #eee;
            margin: 20px 0;
        }
        .note {
            background-color: #fff3cd;
            border-right: 4px solid #ffc107;
            padding: 10px;
            font-size: 0.9rem;
            margin-top: 10px;
        }
    </style>
</head>
<body>
    <h1>ğŸ“¶ ØªØ³Øª Ø¯Ø³ØªÛŒ: Offline Manager (core/offline/offline-manager.js)</h1>
    <p><strong>Ø§ØµÙˆÙ„ Ø±Ø¹Ø§ÛŒØªâ€ŒØ´Ø¯Ù‡:</strong> Ù…Ø³ØªÙ‚Ù„ Ø§Ø² Ø§Ø¨Ø²Ø§Ø±ØŒ Ø±ÙØªØ§Ø±Ú¯Ø±Ø§ØŒ Ù‚Ø·Ø¹ÛŒØŒ Ø§ÛŒØ²ÙˆÙ„Ù‡ØŒ ØªÚ©â€ŒØ§Ø¯Ø¹Ø§ØŒ Ø´Ø¨ÛŒÙ‡â€ŒØ³Ø§Ø² Ø¯Ø³ØªÛŒ</p>

    <!-- Ù…Ø­Ù„ÛŒ Ø¨Ø±Ø§ÛŒ Ù†Ù…Ø§ÛŒØ´ ÙˆØ¶Ø¹ÛŒØª Ø¢Ù†Ù„Ø§ÛŒÙ†/Ø¢ÙÙ„Ø§ÛŒÙ† Ø´Ø¨ÛŒÙ‡â€ŒØ³Ø§Ø²ÛŒâ€ŒØ´Ø¯Ù‡ -->
    <div class="test-container">
        <h2>ğŸ”Œ ÙˆØ¶Ø¹ÛŒØª Ú©Ù†ÙˆÙ†ÛŒ Ø´Ø¨Ú©Ù‡ (Ø´Ø¨ÛŒÙ‡â€ŒØ³Ø§Ø²)</h2>
        <div id="networkStatusBadge" class="status-badge online">âœ… Ø¢Ù†Ù„Ø§ÛŒÙ† (Ø´Ø¨ÛŒÙ‡â€ŒØ³Ø§Ø²ÛŒ)</div>
        <div class="button-group">
            <button id="setOnlineBtn" class="secondary">ğŸ“¡ Ø¢Ù†Ù„Ø§ÛŒÙ† Ú©Ù†</button>
            <button id="setOfflineBtn" class="warning">ğŸ“´ Ø¢ÙÙ„Ø§ÛŒÙ† Ú©Ù†</button>
            <button id="resetSimulationBtn">âŸ² Ø¨Ø§Ø²Ù†Ø´Ø§Ù†ÛŒ Ø´Ø¨ÛŒÙ‡â€ŒØ³Ø§Ø²</button>
        </div>
        <div class="note">
            <strong>ğŸ§ª ØªØ³Øª Ø¯Ø³ØªÛŒ:</strong> ÙˆØ¶Ø¹ÛŒØª Ø´Ø¨Ú©Ù‡ Ø´Ø¨ÛŒÙ‡â€ŒØ³Ø§Ø²ÛŒ Ù…ÛŒâ€ŒØ´ÙˆØ¯ (Ø¨Ø¯ÙˆÙ† ØªØºÛŒÛŒØ± ÙˆØ§Ù‚Ø¹ÛŒ Ù…Ø±ÙˆØ±Ú¯Ø±). 
            Ø³Ø±ÙˆÛŒØ³â€ŒØ¯Ù‡Ù†Ø¯Ù‡ Ø¨Ø§ÛŒØ¯ Ø¨Ù‡ Ø§ÛŒÙ† ØªØºÛŒÛŒØ±Ø§Øª ÙˆØ§Ú©Ù†Ø´ Ù†Ø´Ø§Ù† Ø¯Ù‡Ø¯.
        </div>
    </div>

    <!-- ØªØ³Øªâ€ŒÙ‡Ø§ÛŒ Ø§ØµÙ„ÛŒ Offline Manager -->
    <div class="test-container">
        <h2>ğŸ§ª Û±. ØªØ³Øª ØªØ´Ø®ÛŒØµ ÙˆØ¶Ø¹ÛŒØª (Status Detection)</h2>
        <div class="button-group">
            <button id="testInitialStatus">ğŸ” Ø¨Ø±Ø±Ø³ÛŒ ÙˆØ¶Ø¹ÛŒØª Ø§ÙˆÙ„ÛŒÙ‡</button>
            <button id="testAddRequest">â• Ø§ÙØ²ÙˆØ¯Ù† Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ø¨Ù‡ ØµÙ</button>
            <button id="testGetQueue">ğŸ“‹ Ù†Ù…Ø§ÛŒØ´ ØµÙ Ø¯Ø±Ø®ÙˆØ§Ø³Øªâ€ŒÙ‡Ø§</button>
        </div>

        <h2>ğŸ§ª Û². ØªØ³Øª Ø±ÙØªØ§Ø± Ø¯Ø± Ø¢ÙÙ„Ø§ÛŒÙ† (Queue & Persist)</h2>
        <div class="button-group">
            <button id="testOfflineAddRequest" class="secondary">ğŸ“´ Ø§ÙØ²ÙˆØ¯Ù† Ø¯Ø±Ø®ÙˆØ§Ø³Øª (Ø¢ÙÙ„Ø§ÛŒÙ†)</button>
            <button id="testProcessQueue">âš™ï¸ Ù¾Ø±Ø¯Ø§Ø²Ø´ ØµÙ (Ø´Ø¨ÛŒÙ‡â€ŒØ³Ø§Ø²ÛŒ)</button>
            <button id="testClearQueue">ğŸ—‘ï¸ Ù¾Ø§Ú© Ú©Ø±Ø¯Ù† ØµÙ</button>
        </div>

        <h2>ğŸ§ª Û³. ØªØ³Øª Edge Cases Ùˆ Failure</h2>
        <div class="button-group">
            <button id="testAddInvalidRequest">âš ï¸ Ø§ÙØ²ÙˆØ¯Ù† Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ù†Ø§Ù…Ø¹ØªØ¨Ø±</button>
            <button id="testProcessWithFailure">ğŸ’¥ Ù¾Ø±Ø¯Ø§Ø²Ø´ Ø¨Ø§ Ø´Ú©Ø³Øª Ø´Ø¨ÛŒÙ‡â€ŒØ³Ø§Ø²ÛŒâ€ŒØ´Ø¯Ù‡</button>
            <button id="testDoubleOnline">ğŸ” Ø¢Ù†Ù„Ø§ÛŒÙ†/Ø¢ÙÙ„Ø§ÛŒÙ† Ù¾Ø´Øªâ€ŒØ³Ø±Ù‡Ù…</button>
        </div>
    </div>

    <!-- Ø®Ø±ÙˆØ¬ÛŒ Ú©Ù†Ø³ÙˆÙ„ Ù…Ø¬Ø§Ø²ÛŒ -->
    <div class="test-container">
        <h2>ğŸ“‹ Ø®Ø±ÙˆØ¬ÛŒ Ú©Ù†Ø³ÙˆÙ„ (Log)</h2>
        <div class="button-group">
            <button id="clearLog">ğŸ§¹ Ù¾Ø§Ú© Ú©Ø±Ø¯Ù† Ù„Ø§Ú¯</button>
        </div>
        <div id="logConsole" class="console">
            <p>âœ¨ Ù…Ù†ØªØ¸Ø± Ø¯Ø³ØªÙˆØ± Ø´Ù…Ø§...</p>
        </div>
    </div>

    <script>
        // ---------- Ø´Ø¨ÛŒÙ‡â€ŒØ³Ø§Ø² OfflineManager (Fake Implementation) ----------
        // Ø§ÛŒÙ† Ù…Ø§Ú˜ÙˆÙ„ Ú©Ø§Ù…Ù„Ø§Ù‹ Ø§ÛŒØ²ÙˆÙ„Ù‡ Ùˆ Ù…Ø³ØªÙ‚Ù„ Ø§Ø² IndexedDB ÙˆØ§Ù‚Ø¹ÛŒ Ø§Ø³Øª (No Real IO)
        // ÙˆØ§Ø¨Ø³ØªÚ¯ÛŒâ€ŒÙ‡Ø§ ØªØ²Ø±ÛŒÙ‚ Ù…ÛŒâ€ŒØ´ÙˆÙ†Ø¯ (DI)
        
        class OfflineManager {
            constructor() {
                this._isOnline = true;               // ÙˆØ¶Ø¹ÛŒØª Ù¾ÛŒØ´â€ŒÙØ±Ø¶: Ø¢Ù†Ù„Ø§ÛŒÙ†
                this._requestQueue = [];              // ØµÙ Ø¯Ø±Ø®ÙˆØ§Ø³Øªâ€ŒÙ‡Ø§ Ø¨Ø±Ø§ÛŒ Ø¢ÙÙ„Ø§ÛŒÙ†
                this._listeners = [];                  // Ø¨Ø±Ø§ÛŒ Ø´Ø¨ÛŒÙ‡â€ŒØ³Ø§Ø²ÛŒ Ø±ÙˆÛŒØ¯Ø§Ø¯
                this._failureMode = false;             // Ø­Ø§Ù„Øª Ø´Ú©Ø³Øª Ø¨Ø±Ø§ÛŒ ØªØ³Øª Edge
            }

            // Ù…ØªØ¯ Ø§ØµÙ„ÛŒ Ø¨Ø±Ø§ÛŒ Ø¯Ø±ÛŒØ§ÙØª ÙˆØ¶Ø¹ÛŒØª
            isOnline() {
                return this._isOnline;
            }

            // ØªØºÛŒÛŒØ± ÙˆØ¶Ø¹ÛŒØª (Ø¨Ø±Ø§ÛŒ Ø´Ø¨ÛŒÙ‡â€ŒØ³Ø§Ø²ÛŒ)
            setOnline(online) {
                const previous = this._isOnline;
                this._isOnline = online;
                if (previous !== online) {
                    this._notifyListeners(online);
                }
                return this._isOnline;
            }

            // Ø§ÙØ²ÙˆØ¯Ù† Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ø¨Ù‡ ØµÙ (Ø¯Ø± Ø­Ø§Ù„Øª Ø¢ÙÙ„Ø§ÛŒÙ† Ø°Ø®ÛŒØ±Ù‡ Ù…ÛŒâ€ŒÚ©Ù†Ø¯)
            addRequest(request) {
                // Ø§Ø¹ØªØ¨Ø§Ø±Ø³Ù†Ø¬ÛŒ Ø³Ø§Ø¯Ù‡ (Edge)
                if (!request || typeof request !== 'object') {
                    return { success: false, error: 'Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ù†Ø§Ù…Ø¹ØªØ¨Ø±' };
                }
                if (!request.id || !request.url) {
                    return { success: false, error: 'Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ø¨Ø§ÛŒØ¯ Ø¯Ø§Ø±Ø§ÛŒ id Ùˆ url Ø¨Ø§Ø´Ø¯' };
                }

                if (!this._isOnline) {
                    // Ø¯Ø± Ø­Ø§Ù„Øª Ø¢ÙÙ„Ø§ÛŒÙ† Ø¨Ù‡ ØµÙ Ø§Ø¶Ø§ÙÙ‡ Ú©Ù†
                    this._requestQueue.push({
                        ...request,
                        timestamp: Date.now(),
                        status: 'queued'
                    });
                    return { success: true, queued: true, queueLength: this._requestQueue.length };
                } else {
                    // Ø¯Ø± Ø­Ø§Ù„Øª Ø¢Ù†Ù„Ø§ÛŒÙ†: Ø´Ø¨ÛŒÙ‡â€ŒØ³Ø§Ø²ÛŒ Ø§Ø±Ø³Ø§Ù„ ÙÙˆØ±ÛŒ
                    return { success: true, sent: true, message: 'Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ø¢Ù†Ù„Ø§ÛŒÙ† Ø§Ø±Ø³Ø§Ù„ Ø´Ø¯ (Ø´Ø¨ÛŒÙ‡â€ŒØ³Ø§Ø²ÛŒ)' };
                }
            }

            // Ø¯Ø±ÛŒØ§ÙØª Ú©Ù„ ØµÙ
            getQueue() {
                return [...this._requestQueue]; // Ú©Ù¾ÛŒ Ø¨Ø±Ø§ÛŒ Ø¬Ù„ÙˆÚ¯ÛŒØ±ÛŒ Ø§Ø² ØªØºÛŒÛŒØ± Ø®Ø§Ø±Ø¬ÛŒ
            }

            // Ù¾Ø±Ø¯Ø§Ø²Ø´ ØµÙ (Ø´Ø¨ÛŒÙ‡â€ŒØ³Ø§Ø²ÛŒ Ø§Ø±Ø³Ø§Ù„ Ø¯Ø±Ø®ÙˆØ§Ø³Øªâ€ŒÙ‡Ø§ÛŒ Ù…Ø¹ÙˆÙ‚)
            processQueue(options = {}) {
                if (this._failureMode && !options.ignoreFailure) {
                    return { success: false, error: 'Ø­Ø§Ù„Øª Ø´Ú©Ø³Øª ÙØ¹Ø§Ù„ Ø§Ø³Øª', processed: 0 };
                }
                if (!this._isOnline) {
                    return { success: false, error: 'Ø¯Ø³ØªÚ¯Ø§Ù‡ Ø¢ÙÙ„Ø§ÛŒÙ† Ø§Ø³ØªØŒ ØµÙ Ù¾Ø±Ø¯Ø§Ø²Ø´ Ù†Ø´Ø¯', queued: this._requestQueue.length };
                }
                const count = this._requestQueue.length;
                if (count === 0) {
                    return { success: true, processed: 0, message: 'ØµÙ Ø®Ø§Ù„ÛŒ Ø§Ø³Øª' };
                }
                // Ø´Ø¨ÛŒÙ‡â€ŒØ³Ø§Ø²ÛŒ Ù¾Ø±Ø¯Ø§Ø²Ø´ Ù…ÙˆÙÙ‚
                const processed = this._requestQueue.map(req => ({ ...req, status: 'sent' }));
                this._requestQueue = []; // Ø®Ø§Ù„ÛŒ Ú©Ø±Ø¯Ù† ØµÙ
                return { success: true, processed: count, details: processed };
            }

            // Ù¾Ø§Ú© Ú©Ø±Ø¯Ù† ØµÙ
            clearQueue() {
                this._requestQueue = [];
                return { success: true, queueLength: 0 };
            }

            // ÙØ¹Ø§Ù„/ØºÛŒØ±ÙØ¹Ø§Ù„ Ú©Ø±Ø¯Ù† Ø­Ø§Ù„Øª Ø´Ú©Ø³Øª Ø¨Ø±Ø§ÛŒ ØªØ³Øª
            setFailureMode(enable) {
                this._failureMode = enable;
            }

            // Ø«Ø¨Øª listener Ø¨Ø±Ø§ÛŒ ØªØºÛŒÛŒØ± ÙˆØ¶Ø¹ÛŒØª
            addListener(callback) {
                if (typeof callback === 'function') {
                    this._listeners.push(callback);
                }
            }

            _notifyListeners(isOnline) {
                this._listeners.forEach(fn => fn(isOnline));
            }

            // Ø±ÛŒØ³Øª Ú©Ø§Ù…Ù„ Ø¨Ù‡ Ø­Ø§Ù„Øª Ø§ÙˆÙ„ÛŒÙ‡
            reset() {
                this._isOnline = true;
                this._requestQueue = [];
                this._listeners = [];
                this._failureMode = false;
            }
        }

        // ---------- Ù†Ù…ÙˆÙ†Ù‡ Ø³Ø±ÙˆÛŒØ³ (Singleton Ø¨Ø±Ø§ÛŒ ØªØ³Øª) ----------
        const offlineManager = new OfflineManager();

        // ---------- Ø±Ø§Ù‡â€ŒØ§Ù†Ø¯Ø§Ø²ÛŒ Ù„Ø§Ú¯ Ù…Ø¬Ø§Ø²ÛŒ ----------
        const logConsole = document.getElementById('logConsole');
        function addLog(message, type = 'info') {
            const p = document.createElement('p');
            const timestamp = new Date().toLocaleTimeString('fa-IR', { hour12: false });
            
            let color = '#0f0';
            if (type === 'error') color = '#ff5252';
            if (type === 'warning') color = '#ffb74d';
            if (type === 'success') color = '#4caf50';
            
            p.innerHTML = `<span style="color: #888;">[${timestamp}]</span> <span style="color: ${color};">${message}</span>`;
            logConsole.appendChild(p);
            logConsole.scrollTop = logConsole.scrollHeight;
        }

        function clearLog() {
            logConsole.innerHTML = '<p>âœ¨ Ù„Ø§Ú¯ Ù¾Ø§Ú© Ø´Ø¯. Ù…Ù†ØªØ¸Ø± Ø¯Ø³ØªÙˆØ±...</p>';
        }

        // ---------- Ù†Ù…Ø§ÛŒØ´ ÙˆØ¶Ø¹ÛŒØª Ø´Ø¨Ú©Ù‡ Ø´Ø¨ÛŒÙ‡â€ŒØ³Ø§Ø²ÛŒâ€ŒØ´Ø¯Ù‡ ----------
        function updateNetworkBadge() {
            const badge = document.getElementById('networkStatusBadge');
            const isOnline = offlineManager.isOnline();
            badge.className = 'status-badge ' + (isOnline ? 'online' : 'offline');
            badge.innerText = isOnline ? 'âœ… Ø¢Ù†Ù„Ø§ÛŒÙ† (Ø´Ø¨ÛŒÙ‡â€ŒØ³Ø§Ø²ÛŒ)' : 'ğŸ“´ Ø¢ÙÙ„Ø§ÛŒÙ† (Ø´Ø¨ÛŒÙ‡â€ŒØ³Ø§Ø²ÛŒ)';
        }

        // ---------- Ø±ÙˆÛŒØ¯Ø§Ø¯Ù‡Ø§ÛŒ Ø¯Ú©Ù…Ù‡â€ŒÙ‡Ø§ (ØªØ³Øªâ€ŒÙ‡Ø§ÛŒ Ø¯Ø³ØªÛŒ) ----------

        // Ø¯Ú©Ù…Ù‡â€ŒÙ‡Ø§ÛŒ ØªØºÛŒÛŒØ± ÙˆØ¶Ø¹ÛŒØª Ø´Ø¨Ú©Ù‡
        document.getElementById('setOnlineBtn').addEventListener('click', () => {
            offlineManager.setOnline(true);
            updateNetworkBadge();
            addLog('ğŸŸ¢ ÙˆØ¶Ø¹ÛŒØª Ø´Ø¨Ú©Ù‡ Ø¨Ù‡ Ø¢Ù†Ù„Ø§ÛŒÙ† ØªØºÛŒÛŒØ± Ú©Ø±Ø¯ (Ø´Ø¨ÛŒÙ‡â€ŒØ³Ø§Ø²ÛŒ)', 'success');
        });

        document.getElementById('setOfflineBtn').addEventListener('click', () => {
            offlineManager.setOnline(false);
            updateNetworkBadge();
            addLog('ğŸ”´ ÙˆØ¶Ø¹ÛŒØª Ø´Ø¨Ú©Ù‡ Ø¨Ù‡ Ø¢ÙÙ„Ø§ÛŒÙ† ØªØºÛŒÛŒØ± Ú©Ø±Ø¯ (Ø´Ø¨ÛŒÙ‡â€ŒØ³Ø§Ø²ÛŒ)', 'warning');
        });

        document.getElementById('resetSimulationBtn').addEventListener('click', () => {
            offlineManager.reset();
            updateNetworkBadge();
            clearLog();
            addLog('ğŸ”„ Ø´Ø¨ÛŒÙ‡â€ŒØ³Ø§Ø² Ø¨Ù‡ Ø­Ø§Ù„Øª Ø§ÙˆÙ„ÛŒÙ‡ Ø¨Ø§Ø²Ú¯Ø´Øª (Ø¢Ù†Ù„Ø§ÛŒÙ†ØŒ ØµÙ Ø®Ø§Ù„ÛŒ)', 'info');
        });

        // ØªØ³Øª ÙˆØ¶Ø¹ÛŒØª Ø§ÙˆÙ„ÛŒÙ‡
        document.getElementById('testInitialStatus').addEventListener('click', () => {
            const status = offlineManager.isOnline() ? 'Ø¢Ù†Ù„Ø§ÛŒÙ†' : 'Ø¢ÙÙ„Ø§ÛŒÙ†';
            addLog(`ğŸ” ÙˆØ¶Ø¹ÛŒØª Ú©Ù†ÙˆÙ†ÛŒ Ø´Ø¨Ú©Ù‡: ${status}`, 'info');
        });

        // ØªØ³Øª Ø§ÙØ²ÙˆØ¯Ù† Ø¯Ø±Ø®ÙˆØ§Ø³Øª (ÙˆØ¶Ø¹ÛŒØª ÙØ¹Ù„ÛŒ Ù„Ø­Ø§Ø¸ Ù…ÛŒâ€ŒØ´ÙˆØ¯)
        document.getElementById('testAddRequest').addEventListener('click', () => {
            const request = {
                id: 'req_' + Math.floor(Math.random() * 1000),
                url: '/api/lesson/1',
                method: 'GET',
                data: { lessonId: 1 }
            };
            const result = offlineManager.addRequest(request);
            if (result.success) {
                if (result.queued) {
                    addLog(`â• Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ø¨Ù‡ ØµÙ Ø§Ø¶Ø§ÙÙ‡ Ø´Ø¯ (Ø·ÙˆÙ„ ØµÙ: ${result.queueLength})`, 'warning');
                } else if (result.sent) {
                    addLog(`ğŸ“¡ Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ø¢Ù†Ù„Ø§ÛŒÙ† Ø§Ø±Ø³Ø§Ù„ Ø´Ø¯ (Ø´Ø¨ÛŒÙ‡â€ŒØ³Ø§Ø²ÛŒ): ${request.url}`, 'success');
                }
            } else {
                addLog(`âŒ Ø®Ø·Ø§: ${result.error}`, 'error');
            }
        });

        // Ù†Ù…Ø§ÛŒØ´ ØµÙ
        document.getElementById('testGetQueue').addEventListener('click', () => {
            const queue = offlineManager.getQueue();
            if (queue.length === 0) {
                addLog('ğŸ“­ ØµÙ Ø¯Ø±Ø®ÙˆØ§Ø³Øªâ€ŒÙ‡Ø§ Ø®Ø§Ù„ÛŒ Ø§Ø³Øª.', 'info');
            } else {
                addLog(`ğŸ“‹ ØµÙ Ø¯Ø±Ø®ÙˆØ§Ø³Øªâ€ŒÙ‡Ø§ (${queue.length} Ù…ÙˆØ±Ø¯):`, 'info');
                queue.forEach((req, i) => {
                    addLog(`   ${i+1}. ID: ${req.id} | url: ${req.url} | ÙˆØ¶Ø¹ÛŒØª: ${req.status}`, 'info');
                });
            }
        });

        // Ø§ÙØ²ÙˆØ¯Ù† Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ø¯Ø± Ø­Ø§Ù„Øª Ø¢ÙÙ„Ø§ÛŒÙ† (ØªØ§Ú©ÛŒØ¯ Ø¨Ø± Ø±ÙØªØ§Ø±)
        document.getElementById('testOfflineAddRequest').addEventListener('click', () => {
            const wasOnline = offlineManager.isOnline();
            if (wasOnline) {
                addLog('âš ï¸ Ø¯Ø± Ø­Ø§Ù„ Ø­Ø§Ø¶Ù€Ø± Ø¢Ù†Ù„Ø§ÛŒÙ† Ù‡Ø³ØªÛŒØ¯. Ø¨Ø±Ø§ÛŒ ØªØ³Øª Ø¢ÙÙ„Ø§ÛŒÙ†ØŒ Ø§Ø¨ØªØ¯Ø§ ÙˆØ¶Ø¹ÛŒØª Ø±Ø§ Ø¨Ù‡ Ø¢ÙÙ„Ø§ÛŒÙ† ØªØºÛŒÛŒØ± Ø¯Ù‡ÛŒØ¯.', 'warning');
            } else {
                const request = {
                    id: 'off_req_' + Math.floor(Math.random() * 1000),
                    url: '/api/progress/save',
                    method: 'POST',
                    data: { lessonId: 5, score: 4 }
                };
                const result = offlineManager.addRequest(request);
                if (result.queued) {
                    addLog(`ğŸ“´ Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ø¢ÙÙ„Ø§ÛŒÙ† Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø¨Ù‡ ØµÙ Ø§Ø¶Ø§ÙÙ‡ Ø´Ø¯ (Ø·ÙˆÙ„ ØµÙ: ${result.queueLength})`, 'warning');
                } else {
                    addLog(`âŒ Ø®Ø·Ø§ Ø¯Ø± Ø§ÙØ²ÙˆØ¯Ù† Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ø¢ÙÙ„Ø§ÛŒÙ†: ${result.error}`, 'error');
                }
            }
        });

        // Ù¾Ø±Ø¯Ø§Ø²Ø´ ØµÙ
        document.getElementById('testProcessQueue').addEventListener('click', () => {
            const result = offlineManager.processQueue();
            if (result.success) {
                if (result.processed > 0) {
                    addLog(`âš™ï¸ ØµÙ Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ù¾Ø±Ø¯Ø§Ø²Ø´ Ø´Ø¯. ${result.processed} Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ø§Ø±Ø³Ø§Ù„ Ú¯Ø±Ø¯ÛŒØ¯.`, 'success');
                } else {
                    addLog(`âš™ï¸ ${result.message || 'ØµÙ Ù¾Ø±Ø¯Ø§Ø²Ø´ Ø´Ø¯ Ø§Ù…Ø§ Ø¯Ø±Ø®ÙˆØ§Ø³ØªÛŒ ÙˆØ¬ÙˆØ¯ Ù†Ø¯Ø§Ø´Øª'}`, 'info');
                }
            } else {
                addLog(`âŒ Ù¾Ø±Ø¯Ø§Ø²Ø´ ØµÙ Ù†Ø§Ù…ÙˆÙÙ‚: ${result.error}`, 'error');
            }
        });

        // Ù¾Ø§Ú© Ú©Ø±Ø¯Ù† ØµÙ
        document.getElementById('testClearQueue').addEventListener('click', () => {
            offlineManager.clearQueue();
            addLog('ğŸ—‘ï¸ ØµÙ Ø¯Ø±Ø®ÙˆØ§Ø³Øªâ€ŒÙ‡Ø§ Ù¾Ø§Ú© Ø´Ø¯.', 'info');
        });

        // Ø§ÙØ²ÙˆØ¯Ù† Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ù†Ø§Ù…Ø¹ØªØ¨Ø± (Edge)
        document.getElementById('testAddInvalidRequest').addEventListener('click', () => {
            const invalidReqs = [
                null,
                { id: 'no_url' },
                { url: '/no-id' },
                'string instead of object',
                123
            ];
            const randomInvalid = invalidReqs[Math.floor(Math.random() * invalidReqs.length)];
            const result = offlineManager.addRequest(randomInvalid);
            if (!result.success) {
                addLog(`âœ… [Edge] Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ù†Ø§Ù…Ø¹ØªØ¨Ø± Ø¨Ù‡ Ø¯Ø±Ø³ØªÛŒ Ø±Ø¯ Ø´Ø¯: ${result.error}`, 'success');
            } else {
                addLog(`âŒ [Edge] Ù…Ø´Ú©Ù„: Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ù†Ø§Ù…Ø¹ØªØ¨Ø± Ù¾Ø°ÛŒØ±ÙØªÙ‡ Ø´Ø¯!`, 'error');
            }
        });

        // Ù¾Ø±Ø¯Ø§Ø²Ø´ Ø¨Ø§ Ø´Ú©Ø³Øª Ø´Ø¨ÛŒÙ‡â€ŒØ³Ø§Ø²ÛŒâ€ŒØ´Ø¯Ù‡
        document.getElementById('testProcessWithFailure').addEventListener('click', () => {
            offlineManager.setFailureMode(true);
            // Ø§Ø¨ØªØ¯Ø§ ÛŒÚ© Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ø§Ø¶Ø§ÙÙ‡ Ù…ÛŒâ€ŒÚ©Ù†ÛŒÙ…
            const req = { id: 'fail_test', url: '/api/test', method: 'GET' };
            offlineManager.addRequest(req);
            const result = offlineManager.processQueue();
            if (!result.success && result.error === 'Ø­Ø§Ù„Øª Ø´Ú©Ø³Øª ÙØ¹Ø§Ù„ Ø§Ø³Øª') {
                addLog(`ğŸ’¥ [Failure] Ù¾Ø±Ø¯Ø§Ø²Ø´ Ø¨Ø§ Ø´Ú©Ø³Øª Ù…ÙˆØ§Ø¬Ù‡ Ø´Ø¯: ${result.error} (Ø±ÙØªØ§Ø± Ù…ÙˆØ±Ø¯ Ø§Ù†ØªØ¸Ø§Ø±)`, 'success');
            } else {
                addLog(`âŒ [Failure] Ø§Ù†ØªØ¸Ø§Ø± Ø®Ø·Ø§ Ø¯Ø§Ø´ØªÛŒÙ… ÙˆÙ„ÛŒ Ù¾Ø±Ø¯Ø§Ø²Ø´ Ø§Ù†Ø¬Ø§Ù… Ø´Ø¯.`, 'error');
            }
            offlineManager.setFailureMode(false); // Ø¨Ø±Ú¯Ø±Ø¯Ø§Ù†Ø¯Ù† Ø¨Ù‡ Ø­Ø§Ù„Øª Ø¹Ø§Ø¯ÛŒ
        });

        // ØªØ³Øª Ø¢Ù†Ù„Ø§ÛŒÙ†/Ø¢ÙÙ„Ø§ÛŒÙ† Ù¾Ø´Øªâ€ŒØ³Ø±Ù‡Ù… (Ø±ÙØªØ§Ø±)
        document.getElementById('testDoubleOnline').addEventListener('click', () => {
            addLog('ğŸ”„ Ø´Ø±ÙˆØ¹ ØªØ³Øª ØªØºÛŒÛŒØ±Ø§Øª Ù…ØªÙˆØ§Ù„ÛŒ ÙˆØ¶Ø¹ÛŒØª:', 'info');
            offlineManager.setOnline(false);
            addLog('   ÙˆØ¶Ø¹ÛŒØª: Ø¢ÙÙ„Ø§ÛŒÙ† (Û±)', 'warning');
            offlineManager.setOnline(true);
            addLog('   ÙˆØ¶Ø¹ÛŒØª: Ø¢Ù†Ù„Ø§ÛŒÙ† (Û²)', 'success');
            offlineManager.setOnline(false);
            addLog('   ÙˆØ¶Ø¹ÛŒØª: Ø¢ÙÙ„Ø§ÛŒÙ† (Û³)', 'warning');
            offlineManager.setOnline(true);
            addLog('   ÙˆØ¶Ø¹ÛŒØª: Ø¢Ù†Ù„Ø§ÛŒÙ† (Û´) - Ù¾Ø§ÛŒØ§Ù†', 'success');
            updateNetworkBadge();
        });

        // Ø¯Ú©Ù…Ù‡ Ù¾Ø§Ú© Ú©Ø±Ø¯Ù† Ù„Ø§Ú¯
        document.getElementById('clearLog').addEventListener('click', clearLog);

        // Ø«Ø¨Øª listener Ø¨Ø±Ø§ÛŒ Ù„Ø§Ú¯ Ø®ÙˆØ¯Ú©Ø§Ø± ØªØºÛŒÛŒØ± ÙˆØ¶Ø¹ÛŒØª (Ø§Ø®ØªÛŒØ§Ø±ÛŒ)
        offlineManager.addListener((isOnline) => {
            addLog(`ğŸ”„ [Ø±ÙˆÛŒØ¯Ø§Ø¯] ÙˆØ¶Ø¹ÛŒØª Ø´Ø¨Ú©Ù‡ ØªØºÛŒÛŒØ± Ú©Ø±Ø¯: ${isOnline ? 'Ø¢Ù†Ù„Ø§ÛŒÙ†' : 'Ø¢ÙÙ„Ø§ÛŒÙ†'}`, 'info');
        });

        // Ù…Ù‚Ø¯Ø§Ø±Ø¯Ù‡ÛŒ Ø§ÙˆÙ„ÛŒÙ‡
        updateNetworkBadge();
        addLog('ğŸš€ Ø³Ø±ÙˆÛŒØ³ OfflineManager Ø´Ø¨ÛŒÙ‡â€ŒØ³Ø§Ø²ÛŒ Ø´Ø¯. Ø¢Ù…Ø§Ø¯Ù‡ ØªØ³Øª Ø¯Ø³ØªÛŒ.', 'info');

        // ØªØ³Øª Ø§ÛŒØ²ÙˆÙ„Ù‡: Ù‡Ø± Ø¨Ø§Ø± Ú©Ù‡ ØµÙØ­Ù‡ Ù„ÙˆØ¯ Ù…ÛŒâ€ŒØ´ÙˆØ¯ØŒ ÙˆØ¶Ø¹ÛŒØª Ø±ÛŒØ³Øª Ù…ÛŒâ€ŒØ´ÙˆØ¯ (No Global State Leak)
        window.addEventListener('load', () => {
            // Ø§Ø·Ù…ÛŒÙ†Ø§Ù† Ø§Ø² Ø±ÛŒØ³Øª Ø¨ÙˆØ¯Ù† (Ø§ÛŒØ²ÙˆÙ„Ù‡ Ø¨ÙˆØ¯Ù† ØªØ³Øª)
            offlineManager.reset();
            updateNetworkBadge();
        });
    </script>
</body>
</html>
