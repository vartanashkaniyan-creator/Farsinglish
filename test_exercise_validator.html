<!DOCTYPE html>
<html lang="fa">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Farsinglish - Unit Test: Exercise Validator</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif;
            background: linear-gradient(135deg, #0b3d3f 0%, #1c5a5c 100%);
            color: #e0f2f1;
            padding: 20px;
        }
        .container { 
            max-width: 900px; 
            margin: 0 auto;
            background: rgba(20, 50, 55, 0.9);
            border-radius: 16px;
            padding: 24px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
        }
        h1, h2 { 
            text-align: center; 
            color: #b2dfdb;
            border-bottom: 2px solid #4db6ac;
            padding-bottom: 10px;
            margin-bottom: 20px;
        }
        .suite {
            background: rgba(38, 80, 85, 0.8);
            border-radius: 12px;
            padding: 16px;
            margin: 20px 0;
            border-right: 6px solid #009688;
        }
        .test-case {
            background: rgba(30, 60, 65, 0.9);
            margin: 12px 0;
            padding: 12px 16px;
            border-radius: 8px;
            border-left: 4px solid #ffb300;
        }
        .test-header {
            display: flex;
            justify-content: space-between;
            font-weight: 600;
            color: #ffe082;
        }
        .pass { background: #2e7d32; color: white; padding: 2px 12px; border-radius: 20px; }
        .fail { background: #c62828; color: white; padding: 2px 12px; border-radius: 20px; }
        .summary {
            background: #004d40;
            padding: 18px;
            border-radius: 10px;
            text-align: center;
            font-size: 1.1rem;
            margin-top: 25px;
            border: 1px solid #80cbc4;
        }
        button {
            background: #00695c;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 30px;
            font-size: 1rem;
            cursor: pointer;
            margin: 8px;
            font-weight: 600;
            transition: 0.2s;
        }
        button:hover { background: #00897b; transform: scale(1.02); }
        .controls { text-align: center; margin: 20px 0; }
        .log {
            background: #1e3a3f;
            padding: 12px;
            border-radius: 8px;
            font-family: monospace;
            font-size: 0.8rem;
            color: #b9f6ca;
            max-height: 200px;
            overflow-y: auto;
            margin-top: 20px;
            border: 1px solid #4db6ac;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ§ª Unit Test â€“ Exercise Validator</h1>
        <p style="text-align:center; color:#b2dfdb;">Ø§Ø¹ØªØ¨Ø§Ø±Ø³Ù†Ø¬ÛŒ ØªÙ…Ø±ÛŒÙ†â€ŒÙ‡Ø§ÛŒ Ú†Ù‡Ø§Ø±Ú¯Ø²ÛŒÙ†Ù‡â€ŒØ§ÛŒØŒ Ø¬Ø§ÛŒâ€ŒØ®Ø§Ù„ÛŒØŒ ØªØ±Ø¬Ù…Ù‡ Ùˆ ØªÙ„ÙØ¸</p>

        <div class="suite" id="suite-multiple-choice">
            <h2>âœ… Multiple Choice Validator</h2>
            <div id="tests-mc"></div>
        </div>
        <div class="suite" id="suite-fill-blank">
            <h2>ğŸ“ Fillâ€‘inâ€‘theâ€‘Blank Validator</h2>
            <div id="tests-fb"></div>
        </div>
        <div class="suite" id="suite-translation">
            <h2>ğŸŒ Translation Validator</h2>
            <div id="tests-tl"></div>
        </div>
        <div class="suite" id="suite-pronunciation">
            <h2>ğŸ¤ Pronunciation Validator</h2>
            <div id="tests-pr"></div>
        </div>
        <div class="suite" id="suite-integration">
            <h2>ğŸ”— Integration (Mock DB) â€“ Lesson Service</h2>
            <div id="tests-integration"></div>
        </div>

        <div class="summary" id="summary-box">
            â³ Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ ØªØ³Øªâ€ŒÙ‡Ø§...
        </div>

        <div class="controls">
            <button onclick="ExerciseValidatorTest.runAll()">ğŸš€ Ø§Ø¬Ø±Ø§ÛŒ ØªÙ…Ø§Ù… ØªØ³Øªâ€ŒÙ‡Ø§</button>
            <button onclick="ExerciseValidatorTest.reset()">ğŸ§¹ Ù¾Ø§Ú© Ú©Ø±Ø¯Ù† Ù†ØªØ§ÛŒØ¬</button>
        </div>

        <div class="log" id="log-panel">
            ğŸ“‹ Ù„Ø§Ú¯ Ú©Ù†Ø³ÙˆÙ„ Ø´Ø¨ÛŒÙ‡â€ŒØ³Ø§Ø²ÛŒâ€ŒØ´Ø¯Ù‡
        </div>
    </div>

    <script>
        // ===================================================================
        // 1ï¸âƒ£ Ú©Ù„Ø§Ø³ Ø§ØµÙ„ÛŒ Ø§Ø¹ØªØ¨Ø§Ø±Ø³Ù†Ø¬ÛŒ ØªÙ…Ø±ÛŒÙ† (Exercise Validator)
        //    Ù…Ù†Ø·Ù‚ Ù…Ø­Ø¶ â€“ Ø¨Ø¯ÙˆÙ† ÙˆØ§Ø¨Ø³ØªÚ¯ÛŒ Ø¨Ù‡ UI/DB
        // ===================================================================
        class ExerciseValidator {
            // ----- Ø§Ø¹ØªØ¨Ø§Ø±Ø³Ù†Ø¬ÛŒ Ú†Ù‡Ø§Ø±Ú¯Ø²ÛŒÙ†Ù‡â€ŒØ§ÛŒ -----
            static validateMultipleChoice(userAnswer, correctIndex, choices) {
                // ÙˆØ±ÙˆØ¯ÛŒ: Ø§Ù†Ø¯ÛŒØ³ Ø§Ù†ØªØ®Ø§Ø¨â€ŒØ´Ø¯Ù‡ ØªÙˆØ³Ø· Ú©Ø§Ø±Ø¨Ø±ØŒ Ø§Ù†Ø¯ÛŒØ³ ØµØ­ÛŒØ­ØŒ Ø¢Ø±Ø§ÛŒÙ‡ Ú¯Ø²ÛŒÙ†Ù‡â€ŒÙ‡Ø§
                if (!Array.isArray(choices) || choices.length === 0) return false;
                if (typeof userAnswer !== 'number' || userAnswer < 0 || userAnswer >= choices.length) return false;
                if (typeof correctIndex !== 'number' || correctIndex < 0 || correctIndex >= choices.length) return false;
                return userAnswer === correctIndex;
            }

            // ----- Ø§Ø¹ØªØ¨Ø§Ø±Ø³Ù†Ø¬ÛŒ Ø¬Ø§ÛŒâ€ŒØ®Ø§Ù„ÛŒ (Ù…Ù‚Ø§ÛŒØ³Ù‡ Ø±Ø´ØªÙ‡â€ŒØ§ÛŒ) -----
            static validateFillBlank(userAnswer, correctAnswer, caseInsensitive = true, trimSpaces = true) {
                if (typeof userAnswer !== 'string' || typeof correctAnswer !== 'string') return false;
                let processedUser = userAnswer;
                let processedCorrect = correctAnswer;
                if (trimSpaces) {
                    processedUser = processedUser.trim();
                    processedCorrect = processedCorrect.trim();
                }
                if (caseInsensitive) {
                    processedUser = processedUser.toLowerCase();
                    processedCorrect = processedCorrect.toLowerCase();
                }
                return processedUser === processedCorrect;
            }

            // ----- Ø§Ø¹ØªØ¨Ø§Ø±Ø³Ù†Ø¬ÛŒ ØªØ±Ø¬Ù…Ù‡ (Ø§Ù†Ú¯Ù„ÛŒØ³ÛŒ Ø¨Ù‡ ÙØ§Ø±Ø³ÛŒ / ÙØ§Ø±Ø³ÛŒ Ø¨Ù‡ Ø§Ù†Ú¯Ù„ÛŒØ³ÛŒ) -----
            static validateTranslation(userAnswer, expectedAnswer, direction = 'en2fa', tolerance = 0) {
                // tolerance: ØªØ¹Ø¯Ø§Ø¯ Ú©Ø§Ø±Ø§Ú©ØªØ± Ø§Ø®ØªÙ„Ø§Ù Ù…Ø¬Ø§Ø² (Ø¨Ø±Ø§ÛŒ ØºÙ„Ø·â€ŒÚ¯ÛŒØ±ÛŒ Ø§Ù…Ù„Ø§ÛŒÛŒ Ø³Ø§Ø¯Ù‡)
                if (typeof userAnswer !== 'string' || typeof expectedAnswer !== 'string') return false;
                const u = userAnswer.trim().toLowerCase();
                const e = expectedAnswer.trim().toLowerCase();
                if (u === e) return true;
                if (tolerance > 0) {
                    // ÙØ§ØµÙ„Ù‡ Ù„ÙˆÙ†Ø§Ø´ØªØ§ÛŒÙ† Ø³Ø§Ø¯Ù‡ (ØªÙØ§ÙˆØª Ú©Ø§Ø±Ø§Ú©ØªØ±ÛŒ)
                    const diff = Math.abs(u.length - e.length);
                    if (diff <= tolerance) return true;
                }
                return false;
            }

            // ----- Ø§Ø¹ØªØ¨Ø§Ø±Ø³Ù†Ø¬ÛŒ ØªÙ„ÙØ¸ (Ù…Ù‚Ø§ÛŒØ³Ù‡ ÙÙˆÙ†ØªÛŒÚ©) -----
            static validatePronunciation(userPhonetic, correctPhoneticList) {
                if (typeof userPhonetic !== 'string' || !Array.isArray(correctPhoneticList)) return false;
                const normalizedUser = userPhonetic.trim().replace(/[\/\s]/g, '');
                return correctPhoneticList.some(p => 
                    p.trim().replace(/[\/\s]/g, '') === normalizedUser
                );
            }

            // ----- Ø§Ø¹ØªØ¨Ø§Ø±Ø³Ù†Ø¬ÛŒ Ø§Ù…ØªÛŒØ§Ø² SRS (Ú©ÛŒÙÛŒØª Ù¾Ø§Ø³Ø®) -----
            static validateSrsQuality(userScore) {
                // Ú©ÛŒÙÛŒØª Ù¾Ø§Ø³Ø® Ø¨Ø§ÛŒØ¯ Ø¨ÛŒÙ† Û° ØªØ§ Ûµ Ø¨Ø§Ø´Ø¯
                return Number.isInteger(userScore) && userScore >= 0 && userScore <= 5;
            }
        }

        // ===================================================================
        // 2ï¸âƒ£ Mock Ø§Ø² IndexedDB Ø¨Ø±Ø§ÛŒ Integration Test (Lesson Service)
        // ===================================================================
        class MockLessonDB {
            constructor() {
                this.lessons = new Map();
                this.progress = new Map();
                console.log('ğŸ“ [MOCK DB] Ù†Ù…ÙˆÙ†Ù‡â€ŒØ³Ø§Ø²ÛŒ Ø´Ø¯');
            }

            async saveLesson(lesson) {
                if (!lesson.id) throw new Error('Ø¯Ø±Ø³ Ø¨Ø§ÛŒØ¯ id Ø¯Ø§Ø´ØªÙ‡ Ø¨Ø§Ø´Ø¯');
                this.lessons.set(lesson.id, { ...lesson, savedAt: Date.now() });
                return { success: true, id: lesson.id };
            }

            async getLesson(id) {
                return this.lessons.get(id) || null;
            }

            async saveProgress(userId, progress) {
                this.progress.set(userId, { ...progress, updatedAt: Date.now() });
                return { success: true };
            }

            async getProgress(userId) {
                return this.progress.get(userId) || null;
            }

            // Ù…ØªØ¯Ù‡Ø§ÛŒ Ú©Ù…Ú©ÛŒ Ø¨Ø±Ø§ÛŒ ØªØ³Øª
            clear() {
                this.lessons.clear();
                this.progress.clear();
            }
        }

        // ===================================================================
        // 3ï¸âƒ£ Ø³Ø±ÙˆÛŒØ³ Ø¯Ø±Ø³ Ú©Ù‡ Ø§Ø² Ø¯ÛŒØªØ§Ø¨ÛŒØ³ (Ø­Ù‚ÛŒÙ‚ÛŒ ÛŒØ§ Mock) Ø§Ø³ØªÙØ§Ø¯Ù‡ Ù…ÛŒâ€ŒÚ©Ù†Ø¯
        // ===================================================================
        class LessonService {
            constructor(db) {
                this.db = db; // ÙˆØ§Ø±ÙˆÙ†Ú¯ÛŒ ÙˆØ§Ø¨Ø³ØªÚ¯ÛŒ (DIP)
            }

            async submitExerciseResult(lessonId, userId, exerciseType, userAnswer, correctData) {
                // Ø§ÛŒÙ† Ù…ØªØ¯ ØªØ±Ú©ÛŒØ¨ÛŒ Ø§Ø² Ø§Ø¹ØªØ¨Ø§Ø±Ø³Ù†Ø¬ÛŒ + Ø°Ø®ÛŒØ±Ù‡â€ŒØ³Ø§Ø²ÛŒ Ø§Ø³Øª
                let isValid = false;
                switch (exerciseType) {
                    case 'multiple-choice':
                        isValid = ExerciseValidator.validateMultipleChoice(userAnswer, correctData.correctIndex, correctData.choices);
                        break;
                    case 'fill-blank':
                        isValid = ExerciseValidator.validateFillBlank(userAnswer, correctData.correctAnswer, true, true);
                        break;
                    case 'translation':
                        isValid = ExerciseValidator.validateTranslation(userAnswer, correctData.correctAnswer, correctData.direction, 1);
                        break;
                    case 'pronunciation':
                        isValid = ExerciseValidator.validatePronunciation(userAnswer, correctData.phoneticList);
                        break;
                    default: return { error: 'Ù†ÙˆØ¹ ØªÙ…Ø±ÛŒÙ† Ù†Ø§Ù…Ø´Ø®Øµ' };
                }

                // Ø°Ø®ÛŒØ±Ù‡ Ù†ØªÛŒØ¬Ù‡ Ø¯Ø± Ø¯ÛŒØªØ§Ø¨ÛŒØ³ (Ø§Ø² Ø·Ø±ÛŒÙ‚ mock)
                await this.db.saveProgress(userId, {
                    lessonId,
                    exerciseType,
                    isValid,
                    timestamp: Date.now()
                });

                return { success: true, isValid, saved: true };
            }
        }

        // ===================================================================
        // 4ï¸âƒ£ ÙˆØ§Ø­Ø¯ ØªØ³Øª â€“ Ø´Ø§Ù…Ù„ Unit Tests Ùˆ Integration Test
        // ===================================================================
        const ExerciseValidatorTest = {
            results: { total: 0, passed: 0, failed: 0 },
            log: [],

            async runAll() {
                this.reset();
                this.addLog('ğŸ§ª Ø´Ø±ÙˆØ¹ Ù…Ø¬Ù…ÙˆØ¹Ù‡ ØªØ³Øªâ€ŒÙ‡Ø§ÛŒ Exercise Validator');

                // ---- Unit Test Suites ----
                await this.testMultipleChoice();
                await this.testFillBlank();
                await this.testTranslation();
                await this.testPronunciation();
                await this.testSrsQuality();
                // ---- Integration Test ----
                await this.testLessonServiceIntegration();

                this.renderSummary();
                this.addLog(`âœ… ØªØ³Øªâ€ŒÙ‡Ø§ Ù¾Ø§ÛŒØ§Ù† ÛŒØ§ÙØª: ${this.results.passed}/${this.results.total} Ù…ÙˆÙÙ‚`);
            },

            // --------------------------------------------------------------
            // ØªØ³Øªâ€ŒÙ‡Ø§ÛŒ ÙˆØ§Ø­Ø¯ (Unit Tests) â€“ ÙˆØ±ÙˆØ¯ÛŒ Ù…Ø´Ø®Øµ â†’ Ø®Ø±ÙˆØ¬ÛŒ Ù…Ø´Ø®Øµ
            // --------------------------------------------------------------
            testMultipleChoice() {
                const suiteId = 'tests-mc';
                const container = document.getElementById(suiteId);
                container.innerHTML = '';

                // ØªØ³Øª 1: Ù¾Ø§Ø³Ø® Ú©Ø§Ù…Ù„Ø§Ù‹ Ø¯Ø±Ø³Øª
                this.assert(
                    () => ExerciseValidator.validateMultipleChoice(2, 2, ['cat','dog','bird','fish']),
                    true,
                    'MC-01: Ø§Ù†ØªØ®Ø§Ø¨ ØµØ­ÛŒØ­ Ø§Ù†Ø¯ÛŒØ³',
                    suiteId
                );
                // ØªØ³Øª 2: Ù¾Ø§Ø³Ø® Ù†Ø§Ø¯Ø±Ø³Øª
                this.assert(
                    () => ExerciseValidator.validateMultipleChoice(0, 2, ['cat','dog','bird','fish']),
                    false,
                    'MC-02: Ø§Ù†ØªØ®Ø§Ø¨ Ù†Ø§Ø¯Ø±Ø³Øª',
                    suiteId
                );
                // ØªØ³Øª 3: Ø§Ù†Ø¯ÛŒØ³ Ø®Ø§Ø±Ø¬ Ø§Ø² Ù…Ø­Ø¯ÙˆØ¯Ù‡
                this.assert(
                    () => ExerciseValidator.validateMultipleChoice(5, 2, ['cat','dog','bird','fish']),
                    false,
                    'MC-03: Ø§Ù†Ø¯ÛŒØ³ Ø®Ø§Ø±Ø¬ Ø§Ø² Ù…Ø­Ø¯ÙˆØ¯Ù‡',
                    suiteId
                );
                // ØªØ³Øª 4: Ø¢Ø±Ø§ÛŒÙ‡ Ú¯Ø²ÛŒÙ†Ù‡â€ŒÙ‡Ø§ Ø®Ø§Ù„ÛŒ
                this.assert(
                    () => ExerciseValidator.validateMultipleChoice(0, 0, []),
                    false,
                    'MC-04: Ú¯Ø²ÛŒÙ†Ù‡â€ŒÙ‡Ø§ Ø®Ø§Ù„ÛŒ',
                    suiteId
                );
            },

            testFillBlank() {
                const suiteId = 'tests-fb';
                const container = document.getElementById(suiteId);
                container.innerHTML = '';

                // ØªØ³Øª 1: ØªØ·Ø§Ø¨Ù‚ Ú©Ø§Ù…Ù„
                this.assert(
                    () => ExerciseValidator.validateFillBlank('book', 'book'),
                    true,
                    'FB-01: ØªØ·Ø§Ø¨Ù‚ Ú©Ø§Ù…Ù„',
                    suiteId
                );
                // ØªØ³Øª 2: case-insensitive
                this.assert(
                    () => ExerciseValidator.validateFillBlank('Book', 'book'),
                    true,
                    'FB-02: Ø¨Ø²Ø±Ú¯â€Œ/Ú©ÙˆÚ†Ú©â€ŒÙ†Ù…Ø§',
                    suiteId
                );
                // ØªØ³Øª 3: ÙØ¶Ø§ÛŒ Ø§Ø¶Ø§ÙÛŒ
                this.assert(
                    () => ExerciseValidator.validateFillBlank('  book  ', 'book'),
                    true,
                    'FB-03: Ø­Ø°Ù ÙØ§ØµÙ„Ù‡',
                    suiteId
                );
                // ØªØ³Øª 4: Ù¾Ø§Ø³Ø® ØºÙ„Ø·
                this.assert(
                    () => ExerciseValidator.validateFillBlank('cat', 'book'),
                    false,
                    'FB-04: Ù¾Ø§Ø³Ø® Ú©Ø§Ù…Ù„Ø§Ù‹ Ø§Ø´ØªØ¨Ø§Ù‡',
                    suiteId
                );
            },

            testTranslation() {
                const suiteId = 'tests-tl';
                const container = document.getElementById(suiteId);
                container.innerHTML = '';

                // ØªØ³Øª 1: ØªØ±Ø¬Ù…Ù‡ ØµØ­ÛŒØ­ Ø§Ù†Ú¯Ù„ÛŒØ³ÛŒâ†’ÙØ§Ø±Ø³ÛŒ
                this.assert(
                    () => ExerciseValidator.validateTranslation('water', 'Ø¢Ø¨', 'en2fa'),
                    false, // 'water' Ø¨Ø§ 'Ø¢Ø¨' Ø¨Ø±Ø§Ø¨Ø± Ù†ÛŒØ³Øª â€” Ù…Ù†Ø·Ù‚ÛŒ Ø§Ø³Øª
                    'TL-01: ØªØ±Ø¬Ù…Ù‡ ØºÙ„Ø·',
                    suiteId
                );
                // ØªØ³Øª 2: ØªØ±Ø¬Ù…Ù‡ ØµØ­ÛŒØ­ Ø¨Ø§ ØªØ³Ø§Ù…Ø­ Û± Ú©Ø§Ø±Ø§Ú©ØªØ± (Ø´Ø¨ÛŒÙ‡ ØºÙ„Ø·â€ŒÚ¯ÛŒØ±ÛŒ Ø§Ù…Ù„Ø§ÛŒÛŒ)
                this.assert(
                    () => ExerciseValidator.validateTranslation('Ø¢Ø¨', 'Ø¢Ø¨', 'fa2en', 0),
                    true,
                    'TL-02: ØªØ±Ø¬Ù…Ù‡ Ø¯Ù‚ÛŒÙ‚',
                    suiteId
                );
                // ØªØ³Øª 3: ØªØ³Ø§Ù…Ø­ Û± Ú©Ø§Ø±Ø§Ú©ØªØ± (Ú©Ø§Ø±Ø¨Ø± "Ú©Øª" Ù†ÙˆØ´ØªÙ‡ Ø¨Ù‡ Ø¬Ø§ÛŒ "Ú©ØªØ§Ø¨")
                this.assert(
                    () => ExerciseValidator.validateTranslation('Ú©Øª', 'Ú©ØªØ§Ø¨', 'fa2en', 1),
                    true,
                    'TL-03: ØºÙ„Ø·â€ŒÚ¯ÛŒØ±ÛŒ Ø§Ù…Ù„Ø§ÛŒÛŒ (ÙØ§ØµÙ„Ù‡ Û±)',
                    suiteId
                );
            },

            testPronunciation() {
                const suiteId = 'tests-pr';
                const container = document.getElementById(suiteId);
                container.innerHTML = '';

                const phoneticList = ['/hÉ™ËˆloÊŠ/', '/hÉ›ËˆloÊŠ/', '/hÉ™ËˆlÉ™ÊŠ/'];

                // ØªØ³Øª 1: ØªÙ„ÙØ¸ ØµØ­ÛŒØ­
                this.assert(
                    () => ExerciseValidator.validatePronunciation('/hÉ™ËˆloÊŠ/', phoneticList),
                    true,
                    'PR-01: ØªÙ„ÙØ¸ Ø¯Ø±Ø³Øª',
                    suiteId
                );
                // ØªØ³Øª 2: ØªÙ„ÙØ¸ Ø¨Ø§ ÙØ§ØµÙ„Ù‡ Ø§Ø¶Ø§ÙÛŒ
                this.assert(
                    () => ExerciseValidator.validatePronunciation('  /hÉ™ËˆloÊŠ/  ', phoneticList),
                    true,
                    'PR-02: ÙØ§ØµÙ„Ù‡ Ø§Ø¶Ø§ÙÛŒ',
                    suiteId
                );
                // ØªØ³Øª 3: ØªÙ„ÙØ¸ Ú©Ø§Ù…Ù„Ø§Ù‹ ØºÙ„Ø·
                this.assert(
                    () => ExerciseValidator.validatePronunciation('/bÃ¦d/', phoneticList),
                    false,
                    'PR-03: ØªÙ„ÙØ¸ ØºÙ„Ø·',
                    suiteId
                );
            },

            testSrsQuality() {
                // ØªØ³Øª Ú©Ù…Ú©ÛŒ Ø¨Ø±Ø§ÛŒ SRS (Ø§Ù„Ú¯ÙˆØ±ÛŒØªÙ… Ú©ÛŒÙÛŒØª)
                const suiteId = 'tests-mc'; // ÙÙ‚Ø· ÛŒÚ© Ø¯Ú©ÙˆØ±ÛŒØ´Ù†
                this.assert(
                    () => ExerciseValidator.validateSrsQuality(4),
                    true,
                    'SRS-01: Ú©ÛŒÙÛŒØª Û´ (Ù…Ø¹ØªØ¨Ø±)',
                    'tests-mc'
                );
                this.assert(
                    () => ExerciseValidator.validateSrsQuality(6),
                    false,
                    'SRS-02: Ú©ÛŒÙÛŒØª Û¶ (Ù†Ø§Ù…Ø¹ØªØ¨Ø±)',
                    'tests-mc'
                );
            },

            // --------------------------------------------------------------
            // ØªØ³Øª ÛŒÚ©Ù¾Ø§Ø±Ú†Ú¯ÛŒ (Integration Test) Ø¨Ø§ Mock DB
            // --------------------------------------------------------------
            async testLessonServiceIntegration() {
                const suiteId = 'tests-integration';
                const container = document.getElementById(suiteId);
                container.innerHTML = '';

                // Ø§ÛŒØ¬Ø§Ø¯ Mock Ùˆ Ø³Ø±ÙˆÛŒØ³
                const mockDb = new MockLessonDB();
                const lessonService = new LessonService(mockDb);

                // 1. Ø°Ø®ÛŒØ±Ù‡ ÛŒÚ© Ø¯Ø±Ø³ Ø¯Ø± Ø¯ÛŒØªØ§Ø¨ÛŒØ³ Ø¬Ø¹Ù„ÛŒ
                await mockDb.saveLesson({ id: 'L101', title: 'Ø­ÛŒÙˆØ§Ù†Ø§Øª', words: ['cat','dog'] });

                // 2. Ø«Ø¨Øª Ù†ØªÛŒØ¬Ù‡ ØªÙ…Ø±ÛŒÙ† Ú†Ù‡Ø§Ø±Ú¯Ø²ÛŒÙ†Ù‡â€ŒØ§ÛŒ
                const correctData = {
                    correctIndex: 1,
                    choices: ['Ú¯Ø±Ø¨Ù‡', 'Ø³Ú¯', 'Ù¾Ø±Ù†Ø¯Ù‡', 'Ù…Ø§Ù‡ÛŒ']
                };
                const result = await lessonService.submitExerciseResult(
                    'L101', 'user-001', 'multiple-choice', 1, correctData
                );

                // 3. Assertion
                const testPassed = result.success === true && result.isValid === true && result.saved === true;

                this.assert(
                    () => testPassed,
                    true,
                    'INT-01: Ø«Ø¨Øª Ù†ØªÛŒØ¬Ù‡ ØªÙ…Ø±ÛŒÙ† + Ø§Ø¹ØªØ¨Ø§Ø±Ø³Ù†Ø¬ÛŒ + Ø°Ø®ÛŒØ±Ù‡ Ø¯Ø± Mock',
                    suiteId
                );

                // 4. Ø¨Ø±Ø±Ø³ÛŒ Ø°Ø®ÛŒØ±Ù‡â€ŒØ³Ø§Ø²ÛŒ ÙˆØ§Ù‚Ø¹ÛŒ Ø¯Ø± Mock
                const progress = await mockDb.getProgress('user-001');
                this.assert(
                    () => progress && progress.lessonId === 'L101' && progress.isValid === true,
                    true,
                    'INT-02: Ø¯Ø§Ø¯Ù‡ Ø¯Ø± Mock DB Ø°Ø®ÛŒØ±Ù‡ Ø´Ø¯Ù‡',
                    suiteId
                );
            },

            // --------------------------------------------------------------
            // Ø§Ø¨Ø²Ø§Ø±Ù‡Ø§ÛŒ Ú©Ù…Ú©ÛŒ ØªØ³Øª
            // --------------------------------------------------------------
            assert(testFn, expected, name, suiteId) {
                this.results.total++;
                let passed = false;
                let error = null;
                try {
                    const actual = testFn();
                    passed = (actual === expected);
                } catch (e) {
                    error = e.message;
                    passed = false;
                }

                if (passed) this.results.passed++;
                else this.results.failed++;

                const container = document.getElementById(suiteId);
                if (!container) return;

                const testDiv = document.createElement('div');
                testDiv.className = 'test-case';
                testDiv.innerHTML = `
                    <div class="test-header">
                        <span>${name}</span>
                        <span class="${passed ? 'pass' : 'fail'}">${passed ? 'âœ” PASS' : 'âœ˜ FAIL'}</span>
                    </div>
                    ${error ? `<div style="color:#ffab91; margin-top:5px;">âš ï¸ ${error}</div>` : ''}
                `;
                container.appendChild(testDiv);
                this.addLog(`${passed ? 'âœ…' : 'âŒ'} ${name} â€” ${passed ? 'Ù…ÙˆÙÙ‚' : 'Ù†Ø§Ù…ÙˆÙÙ‚'}`);
            },

            addLog(message) {
                this.log.push(`[${new Date().toLocaleTimeString('fa-IR')}] ${message}`);
                const logPanel = document.getElementById('log-panel');
                if (logPanel) {
                    logPanel.innerHTML = 'ğŸ“‹ Ù„Ø§Ú¯ Ú©Ù†Ø³ÙˆÙ„ Ø´Ø¨ÛŒÙ‡â€ŒØ³Ø§Ø²ÛŒâ€ŒØ´Ø¯Ù‡<br>' + this.log.slice(-8).join('<br>');
                }
                console.log(message);
            },

            reset() {
                this.results = { total: 0, passed: 0, failed: 0 };
                this.log = [];
                const suites = ['tests-mc', 'tests-fb', 'tests-tl', 'tests-pr', 'tests-integration'];
                suites.forEach(id => {
                    const el = document.getElementById(id);
                    if (el) el.innerHTML = '';
                });
                document.getElementById('summary-box').innerHTML = 'â³ ØªØ³Øªâ€ŒÙ‡Ø§ Ø¨Ø§Ø²Ù†Ø´Ø§Ù†ÛŒ Ø´Ø¯Ù†Ø¯';
                document.getElementById('log-panel').innerHTML = 'ğŸ“‹ Ù„Ø§Ú¯ Ú©Ù†Ø³ÙˆÙ„ Ø´Ø¨ÛŒÙ‡â€ŒØ³Ø§Ø²ÛŒâ€ŒØ´Ø¯Ù‡';
                this.addLog('ğŸ§¹ Ù¾Ø§Ú©Ø³Ø§Ø²ÛŒ Ù†ØªØ§ÛŒØ¬');
            },

            renderSummary() {
                const total = this.results.total;
                const passed = this.results.passed;
                const failed = this.results.failed;
                const percent = total ? ((passed / total) * 100).toFixed(0) : 0;
                const box = document.getElementById('summary-box');
                box.innerHTML = `
                    âœ… <strong>${passed}</strong> Ù…ÙˆÙÙ‚ &nbsp;&nbsp; 
                    âŒ <strong>${failed}</strong> Ù†Ø§Ù…ÙˆÙÙ‚ &nbsp;&nbsp; 
                    ğŸ“Š <strong>${percent}%</strong> Ù‚Ø¨ÙˆÙ„ÛŒ<br>
                    ğŸ§ª Ù…Ø¬Ù…ÙˆØ¹ ØªØ³Øªâ€ŒÙ‡Ø§: ${total}
                `;
                box.style.background = failed === 0 ? '#1b5e20' : '#4a2c2c';
                box.style.color = 'white';
            }
        };

        // Ø§Ø¬Ø±Ø§ÛŒ Ø®ÙˆØ¯Ú©Ø§Ø± Ù¾Ø³ Ø§Ø² Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ
        window.onload = () => {
            setTimeout(() => ExerciseValidatorTest.runAll(), 300);
        };
    </script>
</body>
  </html>
