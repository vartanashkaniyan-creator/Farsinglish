<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ØªØ³Øª Ø¯Ø³ØªÛŒ: ØµÙØ­Ù‡ Ù¾Ø±ÙˆÙØ§ÛŒÙ„ (State) - Ù†Ø³Ø®Ù‡ Ù†Ù‡Ø§ÛŒÛŒ Ø¨Ø§ Ø±ÙØ¹ Ø®Ø·Ø§ÛŒ Ù†ÙˆØ¹ Ø¯Ø§Ø¯Ù‡</title>
    <style>
        body {
            font-family: Vazir, Tahoma, Arial, sans-serif;
            background: #f5f7fa;
            margin: 0;
            padding: 20px;
            color: #1e293b;
        }
        .container {
            max-width: 1000px;
            margin: 0 auto;
        }
        h1 {
            font-size: 1.8rem;
            margin-bottom: 20px;
            color: #0f172a;
            border-right: 5px solid #3b82f6;
            padding-right: 15px;
        }
        .test-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        .card {
            background: white;
            border-radius: 16px;
            padding: 20px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.05);
            border: 1px solid #e2e8f0;
        }
        .card h3 {
            margin-top: 0;
            margin-bottom: 15px;
            font-size: 1.2rem;
            display: flex;
            align-items: center;
            gap: 8px;
            color: #0f172a;
        }
        .btn {
            background: #3b82f6;
            color: white;
            border: none;
            padding: 10px 16px;
            border-radius: 30px;
            font-size: 0.9rem;
            font-weight: 500;
            cursor: pointer;
            width: 100%;
            transition: 0.2s;
            margin-bottom: 12px;
            border: 1px solid #2563eb;
        }
        .btn:hover {
            background: #2563eb;
            transform: translateY(-1px);
        }
        .btn.secondary {
            background: #f1f5f9;
            color: #1e293b;
            border: 1px solid #cbd5e1;
        }
        .btn.secondary:hover {
            background: #e2e8f0;
        }
        .log-container {
            background: #0f172a;
            color: #e2e8f0;
            padding: 20px;
            border-radius: 12px;
            font-family: 'Courier New', monospace;
            font-size: 0.85rem;
            direction: ltr;
            text-align: left;
            max-height: 400px;
            overflow-y: auto;
            margin-top: 20px;
            border: 1px solid #334155;
        }
        .log-entry {
            padding: 4px 0;
            border-bottom: 1px dotted #334155;
            color: #a5f3fc;
        }
        .log-entry.error {
            color: #fca5a5;
        }
        .log-entry.success {
            color: #86efac;
        }
        .log-entry.warning {
            color: #fbbf24;
        }
        .flex-row {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }
        .badge {
            background: #e2e8f0;
            padding: 4px 12px;
            border-radius: 30px;
            font-size: 0.8rem;
            color: #334155;
        }
        .state-preview {
            background: #f8fafc;
            border: 1px solid #cbd5e1;
            border-radius: 8px;
            padding: 15px;
            font-family: monospace;
            direction: ltr;
            text-align: left;
            font-size: 0.8rem;
            margin-top: 15px;
            white-space: pre-wrap;
            word-break: break-word;
        }
    </style>
</head>
<body>
<div class="container">
    <h1>ğŸ“‹ ØªØ³Øª Ø¯Ø³ØªÛŒ: ØµÙØ­Ù‡ Ù¾Ø±ÙˆÙØ§ÛŒÙ„ (Ù…Ø¯ÛŒØ±ÛŒØª State) - Ù†Ø³Ø®Ù‡ Ù†Ù‡Ø§ÛŒÛŒ Ø¨Ø§ Ø±ÙØ¹ Ø®Ø·Ø§ÛŒ Ù†ÙˆØ¹ Ø¯Ø§Ø¯Ù‡</h1>
    <p style="margin-bottom: 20px; color: #2563eb; font-weight: bold;">âœ… Ù…Ø´Ú©Ù„ Ù†ÙˆØ¹ Ù†Ø§Ù…Ø¹ØªØ¨Ø± (level: "Ù¾Ù†Ø¬") Ø¨Ø±Ø·Ø±Ù Ø´Ø¯ - Ø³ÛŒØ³ØªÙ… ÙˆØ±ÙˆØ¯ÛŒ Ø¨Ø§ Ù†ÙˆØ¹ Ø§Ø´ØªØ¨Ø§Ù‡ Ø±Ø§ Ø±Ø¯ Ù…ÛŒâ€ŒÚ©Ù†Ø¯</p>

    <div class="test-grid">
        <!-- Ú©Ø§Ø±Øª Û±: Ù‡Ø³ØªÙ‡ State -->
        <div class="card">
            <h3>ğŸ”¹ Û±. Ù‡Ø³ØªÙ‡ State (immutability)</h3>
            <div class="flex-row">
                <button class="btn" id="testInitialStateBtn">âœ… ØªØ³Øª state Ø§ÙˆÙ„ÛŒÙ‡</button>
                <button class="btn secondary" id="testImmutabilityBtn">ğŸ§ª ØªØ³Øª immutability</button>
            </div>
            <div class="badge">Ø§ÛŒØ²ÙˆÙ„Ù‡ Â· Ù‚Ø·Ø¹ÛŒ</div>
        </div>

        <!-- Ú©Ø§Ø±Øª Û²: Ø¨Ø±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ State -->
        <div class="card">
            <h3>ğŸ”¸ Û². Ø¨Ø±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ state</h3>
            <div class="flex-row">
                <button class="btn" id="testUpdateFieldBtn">âœï¸ Ø¨Ø±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ ÙÛŒÙ„Ø¯</button>
                <button class="btn secondary" id="testNestedUpdateBtn">ğŸ“¦ Ø¨Ø±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ ØªÙˆ Ø¯Ø± ØªÙˆ</button>
            </div>
            <div style="margin-top: 15px;">
                <button class="btn secondary" id="testBatchUpdateBtn">âš¡ Ø¨Ø±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ú¯Ø±ÙˆÙ‡ÛŒ</button>
            </div>
        </div>

        <!-- Ú©Ø§Ø±Øª Û³: Ù…Ø­Ø§Ø³Ø¨Ø§Øª Ùˆ Ù…Ø´ØªÙ‚Ø§Øª -->
        <div class="card">
            <h3>ğŸ”¹ Û³. Ù…Ù‚Ø§Ø¯ÛŒØ± Ù…Ø´ØªÙ‚ (derived)</h3>
            <div class="flex-row">
                <button class="btn" id="testNextLevelBtn">ğŸ“ˆ Ù…Ø­Ø§Ø³Ø¨Ù‡ Ø³Ø·Ø­ Ø¨Ø¹Ø¯ÛŒ</button>
                <button class="btn secondary" id="testProgressPercentBtn">ğŸ“Š Ø¯Ø±ØµØ¯ Ù¾ÛŒØ´Ø±ÙØª</button>
            </div>
            <div style="margin-top: 15px;">
                <button class="btn secondary" id="testStreakBonusBtn">ğŸ”¥ Ù…Ø­Ø§Ø³Ø¨Ù‡ Ù¾Ø§Ø¯Ø§Ø´ Ø§Ø³ØªØ±ÛŒÚ©</button>
            </div>
        </div>

        <!-- Ú©Ø§Ø±Øª Û´: edge cases (Ø§ØµÙ„Ø§Ø­ Ø´Ø¯Ù‡) -->
        <div class="card" style="border: 2px solid #10b981;">
            <h3>âœ… Û´. Ù„Ø¨Ù‡â€ŒÙ‡Ø§ (Ø±ÙØ¹ Ø®Ø·Ø§)</h3>
            <div class="flex-row">
                <button class="btn" id="testNullFieldBtn">ğŸ•³ï¸ ÙÛŒÙ„Ø¯ null/undefined</button>
                <button class="btn secondary" id="testInvalidTypeBtn" style="background: #10b981; color: white;">ğŸš« Ù†ÙˆØ¹ Ù†Ø§Ù…Ø¹ØªØ¨Ø± (Ø±ÙØ¹ Ø´Ø¯)</button>
            </div>
            <div style="margin-top: 15px;">
                <button class="btn secondary" id="testResetStateBtn">ğŸ”„ Ø¨Ø§Ø²Ù†Ø´Ø§Ù†ÛŒ Ø¨Ù‡ initialState</button>
            </div>
            <div class="badge" style="background: #10b981; color: white;">Ø§Ú©Ù†ÙˆÙ† ÙˆØ±ÙˆØ¯ÛŒ "Ù¾Ù†Ø¬" Ø±Ø§ Ø±Ø¯ Ù…ÛŒâ€ŒÚ©Ù†Ø¯</div>
        </div>
    </div>

    <!-- Ú©Ø§Ø±Øª Ûµ: Ø´Ø¨ÛŒÙ‡â€ŒØ³Ø§Ø²ÛŒ Ø¬Ø±ÛŒØ§Ù† Ú©Ø§Ø±Ø¨Ø± -->
    <div class="card">
        <h3>ğŸ§ª Ûµ. Ø´Ø¨ÛŒÙ‡â€ŒØ³Ø§Ø²ÛŒ Ø³Ù†Ø§Ø±ÛŒÙˆÛŒ Ú©Ø§Ø±Ø¨Ø±</h3>
        <div class="flex-row">
            <button class="btn" id="testProfileLoadBtn">ğŸ‘¤ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ù¾Ø±ÙˆÙØ§ÛŒÙ„</button>
            <button class="btn secondary" id="testProfileEditBtn">âœï¸ ÙˆÛŒØ±Ø§ÛŒØ´ Ùˆ Ø°Ø®ÛŒØ±Ù‡</button>
            <button class="btn secondary" id="testLevelUpBtn">â¬†ï¸ Ø§Ø±ØªÙ‚Ø§ Ø³Ø·Ø­</button>
        </div>
        <div class="flex-row">
            <button class="btn secondary" id="testCompleteFlowBtn">ğŸ”„ Ø§Ø¬Ø±Ø§ÛŒ Ú¯Ø§Ù…â€ŒØ¨Ù‡â€ŒÚ¯Ø§Ù… Ú©Ø§Ù…Ù„</button>
        </div>
    </div>

    <!-- Ù†Ù…Ø§ÛŒØ´Ú¯Ø± state ÙØ¹Ù„ÛŒ -->
    <div class="state-preview" id="statePreview">
        <strong>ğŸ“Œ state ÙØ¹Ù„ÛŒ:</strong>
        <span id="stateDisplay"></span>
    </div>

    <!-- Ù„Ø§Ú¯ Ù…Ø¬Ø§Ø²ÛŒ -->
    <div class="log-container" id="logContainer">
        <div class="log-entry">âœ… Ø¢Ù…Ø§Ø¯Ù‡â€ŒØ³Ø§Ø²ÛŒ ØªØ³Øªâ€ŒÙ‡Ø§ÛŒ state Ù¾Ø±ÙˆÙØ§ÛŒÙ„ (Ù†Ø³Ø®Ù‡ Ù†Ù‡Ø§ÛŒÛŒ Ø¨Ø§ Ø±ÙØ¹ Ø®Ø·Ø§) ...</div>
    </div>
</div>

<script>
    (function() {
        // ----- initialState -----
        const INITIAL_STATE = {
            userId: 'user_123',
            name: 'Ø¹Ù„ÛŒØ±Ø¶Ø§ Ú©Ø§Ø¸Ù…ÛŒ',
            email: 'alireza@example.com',
            level: 3,
            xp: 280,
            nextLevelXp: 400,
            streak: 7,
            stats: {
                lessonsCompleted: 24,
                totalReviews: 156,
                avgAccuracy: 78.5,
                perfectReviews: 12
            },
            settings: {
                darkMode: false,
                notifications: true,
                language: 'fa'
            },
            lastUpdated: '2026-02-18T10:30:00Z'
        };

        let currentState = JSON.parse(JSON.stringify(INITIAL_STATE));
        
        const logContainer = document.getElementById('logContainer');
        const stateDisplay = document.getElementById('stateDisplay');
        
        function updateStatePreview() {
            stateDisplay.innerText = JSON.stringify(currentState, null, 2);
        }

        function deepClone(obj) {
            return JSON.parse(JSON.stringify(obj));
        }

        function addLog(message, type = 'info') {
            const logDiv = document.createElement('div');
            logDiv.className = `log-entry ${type === 'error' ? 'error' : (type === 'success' ? 'success' : (type === 'warning' ? 'warning' : ''))}`;
            logDiv.textContent = `> ${new Date().toLocaleTimeString('fa-IR')} â€“ ${message}`;
            logContainer.appendChild(logDiv);
            logContainer.scrollTop = logContainer.scrollHeight;
            console.log(`[Profile State] ${message}`);
        }

        function resetState() {
            currentState = deepClone(INITIAL_STATE);
            addLog('state Ø¨Ù‡ initialState Ø¨Ø§Ø²Ù†Ø´Ø§Ù†ÛŒ Ø´Ø¯ (Ø§ÛŒØ²ÙˆÙ„Ù‡â€ŒØ³Ø§Ø²ÛŒ)', 'info');
            updateStatePreview();
            return currentState;
        }

        // ----- ØªÙˆØ§Ø¨Ø¹ Ù…Ø­Ø¶ -----
        function getNextLevel(currentLevel, xp) {
            if (typeof currentLevel !== 'number' || typeof xp !== 'number') return null;
            const xpNeeded = (currentLevel + 1) * 100;
            return {
                currentLevel,
                nextLevel: currentLevel + 1,
                xpNeeded,
                xpProgress: Math.min(100, Math.floor((xp / xpNeeded) * 100))
            };
        }

        function getProgressPercent(xp, nextLevelXp) {
            if (typeof xp !== 'number' || typeof nextLevelXp !== 'number' || nextLevelXp <= 0) return 0;
            return Math.min(100, Math.floor((xp / nextLevelXp) * 100));
        }

        function getStreakBonus(streak) {
            if (typeof streak !== 'number' || streak < 0) return 0;
            if (streak >= 30) return 50;
            if (streak >= 14) return 30;
            if (streak >= 7) return 15;
            if (streak >= 3) return 5;
            return 0;
        }

        // ========== ØªØ§Ø¨Ø¹ updateState Ø§ØµÙ„Ø§Ø­ Ø´Ø¯Ù‡ Ø¨Ø§ Ø¨Ø±Ø±Ø³ÛŒ Ù†ÙˆØ¹ Ø¯Ø§Ø¯Ù‡ ==========
        function updateState(state, updates) {
            if (!state || typeof state !== 'object') return deepClone(INITIAL_STATE);
            
            const newState = deepClone(state);
            let changed = false;

            for (let key in updates) {
                if (updates.hasOwnProperty(key) && newState.hasOwnProperty(key)) {
                    const currentValue = newState[key];
                    const newValue = updates[key];
                    
                    // Ø´Ø±Ø· 1: Ø§Ú¯Ø± newValue undefined ÛŒØ§ null Ø¨Ø§Ø´Ø¯ â†’ Ù†Ø§Ø¯ÛŒØ¯Ù‡ Ú¯Ø±ÙØªÙ‡ Ø´ÙˆØ¯
                    if (newValue === undefined || newValue === null) {
                        addLog(`âš ï¸ Ù…Ù‚Ø¯Ø§Ø± ${key} = ${newValue} Ù†Ø§Ø¯ÛŒØ¯Ù‡ Ú¯Ø±ÙØªÙ‡ Ø´Ø¯ (null/undefined)`, 'warning');
                        continue;
                    }
                    
                    // Ø´Ø±Ø· 2: Ø¨Ø±Ø±Ø³ÛŒ ØªØ·Ø§Ø¨Ù‚ Ù†ÙˆØ¹ Ø¯Ø§Ø¯Ù‡ (Ù…Ù‡Ù…ØªØ±ÛŒÙ† Ø¨Ø®Ø´ Ø¨Ø±Ø§ÛŒ Ø±ÙØ¹ Ø®Ø·Ø§)
                    const expectedType = typeof currentValue;
                    const actualType = typeof newValue;
                    
                    if (expectedType !== actualType) {
                        addLog(`âŒ Ø®Ø·Ø§ÛŒ Ù†ÙˆØ¹ Ø¯Ø§Ø¯Ù‡ Ø¨Ø±Ø§ÛŒ ${key}: expected ${expectedType}, Ø¯Ø±ÛŒØ§ÙØª Ø´Ø¯ ${actualType} (Ù…Ù‚Ø¯Ø§Ø±: "${newValue}")`, 'error');
                        addLog(`   Ø§ÛŒÙ† Ø¨Ø±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ù†Ø§Ø¯ÛŒØ¯Ù‡ Ú¯Ø±ÙØªÙ‡ Ø´Ø¯ ØªØ§ ÛŒÚ©Ù¾Ø§Ø±Ú†Ú¯ÛŒ state Ø­ÙØ¸ Ø´ÙˆØ¯`, 'warning');
                        continue; // Ù†Ø§Ø¯ÛŒØ¯Ù‡ Ú¯Ø±ÙØªÙ† Ù…Ù‚Ø¯Ø§Ø± Ø¨Ø§ Ù†ÙˆØ¹ Ø§Ø´ØªØ¨Ø§Ù‡
                    }
                    
                    // Ø§Ú¯Ø± Ø¨Ù‡ Ø§ÛŒÙ†Ø¬Ø§ Ø±Ø³ÛŒØ¯ØŒ Ù…Ù‚Ø¯Ø§Ø± Ù…Ø¹ØªØ¨Ø± Ø§Ø³Øª
                    newState[key] = newValue;
                    changed = true;
                }
            }
            return changed ? newState : state;
        }

        // Ø¨Ø±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ ØªÙˆ Ø¯Ø± ØªÙˆ (Ø¨Ø§ Ø¨Ø±Ø±Ø³ÛŒ Ù†ÙˆØ¹)
        function updateNested(state, path, value) {
            if (!state || !path || path.length === 0) return state;
            
            // Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ù…Ù‚Ø¯Ø§Ø± ÙØ¹Ù„ÛŒ Ø¨Ø±Ø§ÛŒ Ø¨Ø±Ø±Ø³ÛŒ Ù†ÙˆØ¹
            let current = state;
            for (let i = 0; i < path.length - 1; i++) {
                if (!current[path[i]]) return state;
                current = current[path[i]];
            }
            const lastKey = path[path.length - 1];
            const currentValue = current[lastKey];
            
            // Ø¨Ø±Ø±Ø³ÛŒ Ù†ÙˆØ¹
            if (value === undefined || value === null) {
                addLog(`âš ï¸ Ù…Ù‚Ø¯Ø§Ø± ${path.join('.')} = null/undefined Ù†Ø§Ø¯ÛŒØ¯Ù‡ Ú¯Ø±ÙØªÙ‡ Ø´Ø¯`, 'warning');
                return state;
            }
            
            if (typeof currentValue !== typeof value) {
                addLog(`âŒ Ø®Ø·Ø§ÛŒ Ù†ÙˆØ¹ Ø¨Ø±Ø§ÛŒ ${path.join('.')}: expected ${typeof currentValue}, Ø¯Ø±ÛŒØ§ÙØª Ø´Ø¯ ${typeof value}`, 'error');
                return state;
            }
            
            const newState = deepClone(state);
            current = newState;
            for (let i = 0; i < path.length - 1; i++) {
                current = current[path[i]];
            }
            current[lastKey] = value;
            return newState;
        }

        // ----- Ø±Ø§Ù‡â€ŒØ§Ù†Ø¯Ø§Ø²ÛŒ Ø±ÙˆÛŒØ¯Ø§Ø¯Ù‡Ø§ -----
        document.addEventListener('DOMContentLoaded', function() {
            // 1. state Ø§ÙˆÙ„ÛŒÙ‡
            document.getElementById('testInitialStateBtn').addEventListener('click', () => {
                resetState();
                addLog('ğŸ“‹ ØªØ³Øª state Ø§ÙˆÙ„ÛŒÙ‡:', 'info');
                addLog(`   Ù†Ø§Ù…: ${currentState.name}`, 'info');
                addLog(`   Ø§ÛŒÙ…ÛŒÙ„: ${currentState.email}`, 'info');
                addLog(`   Ø³Ø·Ø­: ${currentState.level}, XP: ${currentState.xp}`, 'info');
                addLog(`   Ø§Ø³ØªØ±ÛŒÚ©: ${currentState.streak} Ø±ÙˆØ²Ù‡`, 'info');
                addLog('âœ… state Ø§ÙˆÙ„ÛŒÙ‡ Ø¨Ù‡ Ø¯Ø±Ø³ØªÛŒ Ù…Ù‚Ø¯Ø§Ø±Ø¯Ù‡ÛŒ Ø´Ø¯Ù‡ Ø§Ø³Øª.', 'success');
            });

            // 2. immutability
            document.getElementById('testImmutabilityBtn').addEventListener('click', () => {
                resetState();
                const oldState = deepClone(currentState);
                const oldName = currentState.name;
                
                const newState = updateState(currentState, { name: 'Ù†Ø§Ù… ØªØºÛŒÛŒØ± ÛŒØ§ÙØªÙ‡ (ØªØ³Øª)' });
                
                if (currentState.name === oldName && newState.name === 'Ù†Ø§Ù… ØªØºÛŒÛŒØ± ÛŒØ§ÙØªÙ‡ (ØªØ³Øª)') {
                    addLog('âœ… immutability Ø±Ø¹Ø§ÛŒØª Ø´Ø¯Ù‡: state Ø§ØµÙ„ÛŒ unchanged Ù…Ø§Ù†Ø¯', 'success');
                    currentState = newState;
                } else {
                    addLog('âŒ Ù…Ø´Ú©Ù„: immutability Ù†Ù‚Ø¶ Ø´Ø¯', 'error');
                }
                updateStatePreview();
            });

            // 3. Ø¨Ø±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ ÙÛŒÙ„Ø¯
            document.getElementById('testUpdateFieldBtn').addEventListener('click', () => {
                resetState();
                const newName = 'Ø±Ø¶Ø§ Ù…Ø­Ù…Ø¯ÛŒ';
                const newXp = 310;
                const newState = updateState(currentState, { name: newName, xp: newXp });
                
                addLog('âœï¸ Ø¨Ø±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ ÙÛŒÙ„Ø¯:', 'info');
                addLog(`   Ù‚Ø¨Ù„ÛŒ: name="${currentState.name}", xp=${currentState.xp}`, 'info');
                
                currentState = newState;
                addLog(`   Ø¨Ø¹Ø¯ÛŒ: name="${currentState.name}", xp=${currentState.xp}`, 'info');
                
                if (currentState.name === newName && currentState.xp === newXp) {
                    addLog('âœ… Ø¨Ø±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ù…ÙˆÙÙ‚', 'success');
                }
                updateStatePreview();
            });

            // 4. Ø¨Ø±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ ØªÙˆ Ø¯Ø± ØªÙˆ
            document.getElementById('testNestedUpdateBtn').addEventListener('click', () => {
                resetState();
                const oldAccuracy = currentState.stats.avgAccuracy;
                const newAccuracy = 85.0;
                
                currentState = updateNested(currentState, ['stats', 'avgAccuracy'], newAccuracy);
                
                addLog('ğŸ“¦ Ø¨Ø±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ ØªÙˆ Ø¯Ø± ØªÙˆ:', 'info');
                addLog(`   stats.avgAccuracy: ${oldAccuracy}% â†’ ${currentState.stats.avgAccuracy}%`, 'info');
                
                if (currentState.stats.avgAccuracy === newAccuracy) {
                    addLog('âœ… Ø¨Ø±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ ØªÙˆ Ø¯Ø± ØªÙˆ Ù…ÙˆÙÙ‚', 'success');
                }
                updateStatePreview();
            });

            // 5. Ø¨Ø±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ú¯Ø±ÙˆÙ‡ÛŒ
            document.getElementById('testBatchUpdateBtn').addEventListener('click', () => {
                resetState();
                addLog('âš¡ Ø¨Ø±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ú¯Ø±ÙˆÙ‡ÛŒ:', 'info');
                
                let tempState = currentState;
                tempState = updateState(tempState, { level: 4, xp: 150, streak: 8 });
                tempState = updateNested(tempState, ['stats', 'lessonsCompleted'], 25);
                
                const oldState = deepClone(currentState);
                currentState = tempState;
                
                addLog(`   level: ${oldState.level} â†’ ${currentState.level}`, 'info');
                addLog(`   xp: ${oldState.xp} â†’ ${currentState.xp}`, 'info');
                addLog(`   streak: ${oldState.streak} â†’ ${currentState.streak}`, 'info');
                addLog(`   lessons: ${oldState.stats.lessonsCompleted} â†’ ${currentState.stats.lessonsCompleted}`, 'info');
                
                if (currentState.level === 4 && currentState.stats.lessonsCompleted === 25) {
                    addLog('âœ… Ø¨Ø±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ú¯Ø±ÙˆÙ‡ÛŒ Ù…ÙˆÙÙ‚', 'success');
                }
                updateStatePreview();
            });

            // 6. Ù…Ø­Ø§Ø³Ø¨Ù‡ Ø³Ø·Ø­ Ø¨Ø¹Ø¯ÛŒ
            document.getElementById('testNextLevelBtn').addEventListener('click', () => {
                resetState();
                const next = getNextLevel(currentState.level, currentState.xp);
                addLog(`ğŸ“ˆ Ù…Ø­Ø§Ø³Ø¨Ù‡ Ø³Ø·Ø­ Ø¨Ø¹Ø¯ÛŒ:`, 'info');
                addLog(`   Ø³Ø·Ø­ ÙØ¹Ù„ÛŒ: ${next.currentLevel}`, 'info');
                addLog(`   Ø³Ø·Ø­ Ø¨Ø¹Ø¯ÛŒ: ${next.nextLevel}`, 'info');
                addLog(`   XP Ù†ÛŒØ§Ø²: ${next.xpNeeded}`, 'info');
                addLog(`   Ù¾ÛŒØ´Ø±ÙØª: ${next.xpProgress}%`, 'info');
                addLog('âœ… Ù…Ø­Ø§Ø³Ø¨Ù‡ ØµØ­ÛŒØ­ Ø§Ø³Øª', 'success');
            });

            // 7. Ø¯Ø±ØµØ¯ Ù¾ÛŒØ´Ø±ÙØª
            document.getElementById('testProgressPercentBtn').addEventListener('click', () => {
                resetState();
                const percent = getProgressPercent(currentState.xp, currentState.nextLevelXp);
                addLog(`ğŸ“Š Ø¯Ø±ØµØ¯ Ù¾ÛŒØ´Ø±ÙØª: ${percent}% (${currentState.xp}/${currentState.nextLevelXp})`, 'info');
                addLog('âœ… Ù…Ø­Ø§Ø³Ø¨Ù‡ Ù…Ø¹ØªØ¨Ø± Ø§Ø³Øª', 'success');
            });

            // 8. Ù¾Ø§Ø¯Ø§Ø´ Ø§Ø³ØªØ±ÛŒÚ©
            document.getElementById('testStreakBonusBtn').addEventListener('click', () => {
                resetState();
                const bonus = getStreakBonus(currentState.streak);
                addLog(`ğŸ”¥ Ù¾Ø§Ø¯Ø§Ø´ Ø§Ø³ØªØ±ÛŒÚ© ${currentState.streak} Ø±ÙˆØ²Ù‡: ${bonus} Ø§Ù…ØªÛŒØ§Ø²`, 'info');
                
                const testCases = [2, 5, 7, 10, 14, 20, 30, 40];
                addLog('ğŸ“‹ Ù…ÙˆØ§Ø±Ø¯ Ù…Ø±Ø²ÛŒ:', 'info');
                testCases.forEach(s => {
                    const res = getStreakBonus(s);
                    addLog(`   Ø§Ø³ØªØ±ÛŒÚ© ${s} â†’ ${res} Ø§Ù…ØªÛŒØ§Ø²`, 'info');
                });
                addLog('âœ… Ù…Ø­Ø§Ø³Ø¨Ø§Øª Ú©Ø§Ù…Ù„ Ø´Ø¯', 'success');
            });

            // 9. ØªØ³Øª null/undefined (Ø¨Ø§ÛŒØ¯ Ù†Ø§Ø¯ÛŒØ¯Ù‡ Ú¯Ø±ÙØªÙ‡ Ø´ÙˆØ¯)
            document.getElementById('testNullFieldBtn').addEventListener('click', () => {
                resetState();
                const oldName = currentState.name;
                const oldXp = currentState.xp;
                
                const newState = updateState(currentState, { name: null, xp: undefined });
                
                addLog('ğŸ•³ï¸ ØªØ³Øª null/undefined:', 'info');
                addLog(`   name: "${oldName}" â†’ "${newState.name}" (Ø¨Ø¯ÙˆÙ† ØªØºÛŒÛŒØ±)`, 'info');
                addLog(`   xp: ${oldXp} â†’ ${newState.xp} (Ø¨Ø¯ÙˆÙ† ØªØºÛŒÛŒØ±)`, 'info');
                
                if (newState.name === oldName && newState.xp === oldXp) {
                    addLog('âœ… Ù…Ù‚Ø§Ø¯ÛŒØ± null/undefined Ù†Ø§Ø¯ÛŒØ¯Ù‡ Ú¯Ø±ÙØªÙ‡ Ø´Ø¯Ù†Ø¯', 'success');
                    currentState = newState;
                }
                updateStatePreview();
            });

            // ========== 10. ØªØ³Øª Ù†ÙˆØ¹ Ù†Ø§Ù…Ø¹ØªØ¨Ø± (Ø±ÙØ¹ Ø®Ø·Ø§ Ø´Ø¯Ù‡) ==========
            document.getElementById('testInvalidTypeBtn').addEventListener('click', () => {
                resetState();
                const oldLevel = currentState.level; // Ø¹Ø¯Ø¯ 3
                
                addLog('ğŸš« ØªØ³Øª Ù†ÙˆØ¹ Ù†Ø§Ù…Ø¹ØªØ¨Ø± Ø¨Ø§ Ù…Ù‚Ø¯Ø§Ø± level: "Ù¾Ù†Ø¬" (Ø±Ø´ØªÙ‡)', 'info');
                addLog(`   level Ù‚Ø¨Ù„ÛŒ: ${oldLevel} (Ø¹Ø¯Ø¯)`, 'info');
                
                // ØªÙ„Ø§Ø´ Ø¨Ø±Ø§ÛŒ Ø¨Ø±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ø¨Ø§ Ø±Ø´ØªÙ‡
                const newState = updateState(currentState, { level: 'Ù¾Ù†Ø¬' });
                
                addLog(`   level Ø¨Ø¹Ø¯ÛŒ: ${newState.level} (Ø¨Ø§ÛŒØ¯ unchanged Ø¨Ø§Ø´Ø¯)`, 'info');
                
                if (newState.level === oldLevel && typeof newState.level === 'number') {
                    addLog('âœ… Ù†ÙˆØ¹ Ù†Ø§Ù…Ø¹ØªØ¨Ø± Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø±Ø¯ Ø´Ø¯ - state ØªØºÛŒÛŒØ± Ù†Ú©Ø±Ø¯', 'success');
                    currentState = newState;
                } else {
                    addLog('âŒ Ø®Ø·Ø§: state Ø¨Ø§ Ù†ÙˆØ¹ Ù†Ø§Ù…Ø¹ØªØ¨Ø± ØªØºÛŒÛŒØ± Ú©Ø±Ø¯', 'error');
                }
                updateStatePreview();
            });

            // 11. Ø¨Ø§Ø²Ù†Ø´Ø§Ù†ÛŒ state
            document.getElementById('testResetStateBtn').addEventListener('click', () => {
                currentState = updateState(currentState, { name: 'Ù†Ø§Ù… Ù…ÙˆÙ‚Øª', level: 99 });
                addLog('ğŸ”„ state Ø¨Ù‡ "Ù†Ø§Ù… Ù…ÙˆÙ‚Øª" Ùˆ level=99 ØªØºÛŒÛŒØ± ÛŒØ§ÙØª', 'info');
                updateStatePreview();
                
                setTimeout(() => {
                    resetState();
                    addLog('âœ… Ø¨Ø§Ø²Ù†Ø´Ø§Ù†ÛŒ Ø¨Ù‡ initialState Ø§Ù†Ø¬Ø§Ù… Ø´Ø¯', 'success');
                }, 500);
            });

            // 12. Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ù¾Ø±ÙˆÙØ§ÛŒÙ„
            document.getElementById('testProfileLoadBtn').addEventListener('click', () => {
                resetState();
                addLog('ğŸ‘¤ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ù¾Ø±ÙˆÙØ§ÛŒÙ„:', 'info');
                
                const serverData = {
                    ...deepClone(currentState),
                    name: 'Ø¹Ù„ÛŒ Ù†Ø§Ø¯Ø±ÛŒ',
                    xp: 415,
                    level: 4,
                    streak: 14
                };
                
                currentState = serverData;
                addLog(`   Ù†Ø§Ù…: ${currentState.name}`, 'info');
                addLog(`   Ø³Ø·Ø­: ${currentState.level}, XP: ${currentState.xp}`, 'info');
                addLog(`   Ø§Ø³ØªØ±ÛŒÚ©: ${currentState.streak} Ø±ÙˆØ²Ù‡`, 'info');
                addLog('âœ… Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ù…ÙˆÙÙ‚', 'success');
                updateStatePreview();
            });

            // 13. ÙˆÛŒØ±Ø§ÛŒØ´ Ù¾Ø±ÙˆÙØ§ÛŒÙ„
            document.getElementById('testProfileEditBtn').addEventListener('click', () => {
                resetState();
                addLog('âœï¸ ÙˆÛŒØ±Ø§ÛŒØ´ Ù¾Ø±ÙˆÙØ§ÛŒÙ„:', 'info');
                
                const edits = {
                    name: 'Ù…Ø­Ù…Ø¯ Ø§Ø­Ù…Ø¯ÛŒ',
                    email: 'm.ahmadi@example.com'
                };
                
                const oldName = currentState.name;
                const oldEmail = currentState.email;
                currentState = updateState(currentState, edits);
                
                addLog(`   Ù†Ø§Ù…: "${oldName}" â†’ "${currentState.name}"`, 'info');
                addLog(`   Ø§ÛŒÙ…ÛŒÙ„: "${oldEmail}" â†’ "${currentState.email}"`, 'info');
                
                if (currentState.name === edits.name && currentState.email === edits.email) {
                    addLog('âœ… ÙˆÛŒØ±Ø§ÛŒØ´ Ù…ÙˆÙÙ‚', 'success');
                }
                updateStatePreview();
            });

            // 14. Ø§Ø±ØªÙ‚Ø§ Ø³Ø·Ø­
            document.getElementById('testLevelUpBtn').addEventListener('click', () => {
                resetState();
                const oldLevel = currentState.level;
                const oldXp = currentState.xp;
                
                currentState = updateState(currentState, { 
                    level: currentState.level + 1,
                    xp: currentState.xp + 150
                });
                
                addLog(`â¬†ï¸ Ø§Ø±ØªÙ‚Ø§ Ø³Ø·Ø­:`, 'info');
                addLog(`   Ø³Ø·Ø­: ${oldLevel} â†’ ${currentState.level}`, 'info');
                addLog(`   XP: ${oldXp} â†’ ${currentState.xp}`, 'info');
                
                if (currentState.level === oldLevel + 1) {
                    addLog('âœ… Ø§Ø±ØªÙ‚Ø§ Ù…ÙˆÙÙ‚', 'success');
                }
                updateStatePreview();
            });

            // 15. Ø¬Ø±ÛŒØ§Ù† Ú©Ø§Ù…Ù„
            document.getElementById('testCompleteFlowBtn').addEventListener('click', () => {
                resetState();
                addLog('ğŸ”¥ Ø´Ø¨ÛŒÙ‡â€ŒØ³Ø§Ø²ÛŒ Ø¬Ø±ÛŒØ§Ù† Ú©Ø§Ù…Ù„:', 'info');
                
                addLog('Ú¯Ø§Ù… 1: Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ù¾Ø±ÙˆÙØ§ÛŒÙ„', 'info');
                addLog('Ú¯Ø§Ù… 2: Ù†Ù…Ø§ÛŒØ´ Ø¢Ù…Ø§Ø±', 'info');
                addLog(`   Ø¯Ø±Ø³â€ŒÙ‡Ø§: ${currentState.stats.lessonsCompleted}, Ø¯Ù‚Øª: ${currentState.stats.avgAccuracy}%`, 'info');
                
                addLog('Ú¯Ø§Ù… 3: ÙˆÛŒØ±Ø§ÛŒØ´ Ù†Ø§Ù…', 'info');
                currentState = updateState(currentState, { name: 'Ú©Ø§Ø¸Ù… Ø±Ø¶Ø§ÛŒÛŒ' });
                
                addLog('Ú¯Ø§Ù… 4: Ø¯Ø±ÛŒØ§ÙØª XP', 'info');
                currentState = updateState(currentState, { xp: currentState.xp + 150 });
                
                if (currentState.xp >= currentState.nextLevelXp) {
                    const newLevel = currentState.level + 1;
                    const remainingXp = currentState.xp - currentState.nextLevelXp;
                    currentState = updateState(currentState, { 
                        level: newLevel,
                        xp: remainingXp
                    });
                    addLog(`   Ø§Ø±ØªÙ‚Ø§ Ø¨Ù‡ Ø³Ø·Ø­ ${newLevel}`, 'info');
                }
                
                addLog('Ú¯Ø§Ù… 5: Ø§ÙØ²Ø§ÛŒØ´ Ø§Ø³ØªØ±ÛŒÚ©', 'info');
                currentState = updateState(currentState, { streak: currentState.streak + 1 });
                
                addLog('Ú¯Ø§Ù… 6: Ø°Ø®ÛŒØ±Ù‡ Ù†Ù‡Ø§ÛŒÛŒ', 'info');
                addLog('âœ… Ø¬Ø±ÛŒØ§Ù† Ú©Ø§Ù…Ù„ Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø´Ø¨ÛŒÙ‡â€ŒØ³Ø§Ø²ÛŒ Ø´Ø¯', 'success');
                addLog(`   Ù†Ø§Ù…: "${currentState.name}", Ø³Ø·Ø­: ${currentState.level}, XP: ${currentState.xp}, Ø§Ø³ØªØ±ÛŒÚ©: ${currentState.streak}`, 'info');
                
                updateStatePreview();
            });

            // Ø´Ø±ÙˆØ¹
            resetState();
            addLog('âœ… Ù‡Ù…Ù‡ Ø¯Ú©Ù…Ù‡â€ŒÙ‡Ø§ Ø¢Ù…Ø§Ø¯Ù‡â€ŒØ§Ù†Ø¯. Ø®Ø·Ø§ÛŒ Ù†ÙˆØ¹ Ø¯Ø§Ø¯Ù‡ Ø¨Ø±Ø·Ø±Ù Ø´Ø¯Ù‡ Ø§Ø³Øª.', 'success');
        });
    })();
</script>
</body>
</html>
