<!DOCTYPE html>
<html lang="fa">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ØªØ³Øª JWT Ùˆ Token Management - Farsinglish</title>
    <style>
        :root {
            --primary: #4f46e5;
            --success: #10b981;
            --danger: #ef4444;
            --warning: #f59e0b;
            --dark: #1e293b;
            --light: #f8fafc;
            --border: #e2e8f0;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: system-ui, -apple-system, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            color: var(--dark);
        }
        
        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }
        
        .header {
            text-align: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 2px solid var(--border);
        }
        
        h1 {
            color: var(--dark);
            font-size: 24px;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }
        
        .subtitle {
            color: #64748b;
            font-size: 14px;
        }
        
        .controls {
            text-align: center;
            margin: 20px 0;
        }
        
        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            background: var(--primary);
            color: white;
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(79, 70, 229, 0.3);
        }
        
        .btn:active {
            transform: translateY(0);
        }
        
        .stats {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 15px;
            margin: 25px 0;
        }
        
        .stat-card {
            background: var(--light);
            border-radius: 10px;
            padding: 15px;
            text-align: center;
            border: 1px solid var(--border);
        }
        
        .stat-value {
            font-size: 28px;
            font-weight: bold;
            margin-bottom: 5px;
        }
        
        .stat-label {
            font-size: 12px;
            color: #64748b;
        }
        
        .test-container {
            margin: 25px 0;
        }
        
        .test-category {
            margin-bottom: 20px;
        }
        
        .category-title {
            font-size: 16px;
            font-weight: bold;
            color: var(--dark);
            margin-bottom: 10px;
            padding: 10px;
            background: var(--light);
            border-radius: 8px;
            border-right: 4px solid var(--primary);
        }
        
        .test-item {
            margin: 8px 0;
            padding: 12px;
            border-radius: 8px;
            border: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.3s;
        }
        
        .test-item:hover {
            background: var(--light);
            transform: translateX(5px);
        }
        
        .test-name {
            flex: 1;
            font-size: 14px;
        }
        
        .test-status {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: bold;
        }
        
        .status-pass {
            background: var(--success);
            color: white;
        }
        
        .status-fail {
            background: var(--danger);
            color: white;
        }
        
        .status-pending {
            background: var(--warning);
            color: white;
        }
        
        .details-btn {
            background: none;
            border: 1px solid var(--border);
            padding: 4px 12px;
            border-radius: 4px;
            font-size: 12px;
            cursor: pointer;
            margin-right: 10px;
            color: #64748b;
        }
        
        .details-btn:hover {
            background: var(--border);
        }
        
        .test-details {
            background: var(--light);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 12px;
            margin-top: 10px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            display: none;
            white-space: pre-wrap;
            word-break: break-all;
        }
        
        .test-item.expanded .test-details {
            display: block;
        }
        
        .jwt-decoder {
            background: #1e293b;
            color: #e2e8f0;
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
            font-family: 'Courier New', monospace;
            font-size: 12px;
        }
        
        .jwt-title {
            color: #94a3b8;
            margin-bottom: 10px;
            font-weight: bold;
        }
        
        .jwt-part {
            margin: 8px 0;
            padding: 8px;
            background: #0f172a;
            border-radius: 4px;
            word-break: break-all;
        }
        
        .footer {
            text-align: center;
            margin-top: 30px;
            padding-top: 20px;
            border-top: 1px solid var(--border);
            color: #64748b;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ” ØªØ³Øª JWT Ùˆ Token Management</h1>
            <p class="subtitle">ØªÙˆÙ„ÛŒØ¯ØŒ Ø§Ø¹ØªØ¨Ø§Ø±Ø³Ù†Ø¬ÛŒ Ùˆ Ù…Ø¯ÛŒØ±ÛŒØª ØªÙˆÚ©Ù†â€ŒÙ‡Ø§ÛŒ Ø§Ù…Ù†</p>
        </div>

        <div class="controls">
            <button class="btn" onclick="runAllTests()">ğŸš€ Ø§Ø¬Ø±Ø§ÛŒ Ù‡Ù…Ù‡ ØªØ³Øªâ€ŒÙ‡Ø§</button>
            <button class="btn" onclick="decodeSampleJWT()" style="background: var(--warning); margin-left: 10px;">
                ğŸ” Ù…Ø´Ø§Ù‡Ø¯Ù‡ Ù†Ù…ÙˆÙ†Ù‡ JWT
            </button>
        </div>

        <div class="stats">
            <div class="stat-card">
                <div class="stat-value" id="totalTests">10</div>
                <div class="stat-label">Ú©Ù„ ØªØ³Øªâ€ŒÙ‡Ø§</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="passedTests">0</div>
                <div class="stat-label">Ù…ÙˆÙÙ‚</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="failedTests">0</div>
                <div class="stat-label">Ù†Ø§Ù…ÙˆÙÙ‚</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="duration">0.0</div>
                <div class="stat-label">Ø«Ø§Ù†ÛŒÙ‡</div>
            </div>
        </div>

        <div id="jwtDecoder" class="jwt-decoder" style="display: none;">
            <div class="jwt-title">ğŸ” Ø³Ø§Ø®ØªØ§Ø± Ù†Ù…ÙˆÙ†Ù‡ JWT:</div>
            <div id="jwtParts"></div>
        </div>

        <div class="test-container" id="testResults">
            <!-- ØªØ³Øªâ€ŒÙ‡Ø§ Ø§ÛŒÙ†Ø¬Ø§ Ù†Ù…Ø§ÛŒØ´ Ø¯Ø§Ø¯Ù‡ Ù…ÛŒâ€ŒØ´ÙˆÙ†Ø¯ -->
        </div>

        <div class="footer">
            <p>Farsinglish - JWT Test Suite | Ø¨Ø±Ø§ÛŒ SRS Ùˆ Ù…Ø¯ÛŒØ±ÛŒØª Session Ú©Ø§Ø±Ø¨Ø±Ø§Ù†</p>
        </div>
    </div>

    <script>
        // ==================== JWT Utility Class ====================
        class JWTManager {
            constructor(secret = 'farsinglish-secret-key') {
                this.secret = secret;
                this.tokenRefreshInterval = null;
            }

            // ØªÙˆÙ„ÛŒØ¯ JWT
            generateToken(userId, userData = {}, expiresInHours = 24) {
                const header = {
                    alg: 'HS256',
                    typ: 'JWT'
                };
                
                const now = Math.floor(Date.now() / 1000);
                const payload = {
                    sub: userId,
                    iat: now,
                    exp: now + (expiresInHours * 3600),
                    role: userData.role || 'user',
                    level: userData.level || 1,
                    xp: userData.xp || 0,
                    ...userData
                };
                
                // Ø¯Ø± ÙˆØ§Ù‚Ø¹ÛŒØª Ø§ÛŒÙ†Ø¬Ø§ signature ØªÙˆÙ„ÛŒØ¯ Ù…ÛŒâ€ŒØ´ÙˆØ¯
                const headerBase64 = btoa(JSON.stringify(header));
                const payloadBase64 = btoa(JSON.stringify(payload));
                const signature = this._generateSignature(headerBase64, payloadBase64);
                
                return `${headerBase64}.${payloadBase64}.${signature}`;
            }

            _generateSignature(header, payload) {
                // Ø´Ø¨ÛŒÙ‡â€ŒØ³Ø§Ø²ÛŒ signature (Ø¯Ø± ÙˆØ§Ù‚Ø¹ÛŒØª Ø¨Ø§ secret Ø§Ù…Ø¶Ø§ Ù…ÛŒâ€ŒØ´ÙˆØ¯)
                const data = header + '.' + payload + this.secret;
                let hash = 0;
                for (let i = 0; i < data.length; i++) {
                    hash = ((hash << 5) - hash) + data.charCodeAt(i);
                    hash = hash & hash;
                }
                return Math.abs(hash).toString(36) + 'sig';
            }

            // Parse Ùˆ Ø§Ø¹ØªØ¨Ø§Ø±Ø³Ù†Ø¬ÛŒ JWT
            parseToken(token) {
                try {
                    const parts = token.split('.');
                    if (parts.length !== 3) {
                        return { valid: false, error: 'ÙØ±Ù…Øª ØªÙˆÚ©Ù† Ù†Ø§Ù…Ø¹ØªØ¨Ø±' };
                    }

                    const [headerBase64, payloadBase64, signature] = parts;
                    
                    // Ø¨Ø±Ø±Ø³ÛŒ signature
                    const expectedSignature = this._generateSignature(headerBase64, payloadBase64);
                    if (signature !== expectedSignature) {
                        return { valid: false, error: 'Ø§Ù…Ø¶Ø§ Ù†Ø§Ù…Ø¹ØªØ¨Ø±' };
                    }

                    const header = JSON.parse(atob(headerBase64));
                    const payload = JSON.parse(atob(payloadBase64));
                    
                    // Ø¨Ø±Ø±Ø³ÛŒ Ø§Ù†Ù‚Ø¶Ø§
                    const now = Math.floor(Date.now() / 1000);
                    if (payload.exp < now) {
                        return { 
                            valid: false, 
                            error: 'ØªÙˆÚ©Ù† Ù…Ù†Ù‚Ø¶ÛŒ Ø´Ø¯Ù‡',
                            payload,
                            expired: true 
                        };
                    }

                    return {
                        valid: true,
                        header,
                        payload,
                        signature
                    };

                } catch (error) {
                    return { valid: false, error: error.message };
                }
            }

            // Ø¨Ø±Ø±Ø³ÛŒ Ø§Ø¹ØªØ¨Ø§Ø± ØªÙˆÚ©Ù†
            isTokenValid(token) {
                const result = this.parseToken(token);
                return result.valid === true;
            }

            // Ø¨Ø±Ø±Ø³ÛŒ Ø§Ù†Ù‚Ø¶Ø§ÛŒ ØªÙˆÚ©Ù†
            isTokenExpired(token) {
                const result = this.parseToken(token);
                return result.expired === true;
            }

            // Ø²Ù…Ø§Ù† Ø¨Ø§Ù‚ÛŒâ€ŒÙ…Ø§Ù†Ø¯Ù‡ ØªØ§ Ø§Ù†Ù‚Ø¶Ø§ (Ø«Ø§Ù†ÛŒÙ‡)
            getTimeToExpiry(token) {
                const result = this.parseToken(token);
                if (!result.valid || !result.payload) return 0;
                
                const now = Math.floor(Date.now() / 1000);
                return Math.max(0, result.payload.exp - now);
            }

            // ØªÙ…Ø¯ÛŒØ¯ ØªÙˆÚ©Ù†
            refreshToken(oldToken, newExpiryHours = 24) {
                const result = this.parseToken(oldToken);
                if (!result.valid) {
                    throw new Error('ØªÙˆÚ©Ù† Ù‚Ø¯ÛŒÙ…ÛŒ Ù†Ø§Ù…Ø¹ØªØ¨Ø± Ø§Ø³Øª');
                }

                return this.generateToken(
                    result.payload.sub,
                    result.payload,
                    newExpiryHours
                );
            }

            // Ø§ÛŒØ¬Ø§Ø¯ Refresh Token
            generateRefreshToken(userId) {
                const randomBytes = new Uint8Array(32);
                crypto.getRandomValues(randomBytes);
                const token = Array.from(randomBytes)
                    .map(b => b.toString(16).padStart(2, '0'))
                    .join('');
                
                return {
                    token: `rf_${userId}_${token}`,
                    expiresAt: Date.now() + (30 * 24 * 3600 * 1000) // 30 Ø±ÙˆØ²
                };
            }

            // Ø´Ø±ÙˆØ¹ ØªÙ…Ø¯ÛŒØ¯ Ø®ÙˆØ¯Ú©Ø§Ø±
            startAutoRefresh(token, callback, thresholdMinutes = 5) {
                this.stopAutoRefresh();
                
                const timeToExpiry = this.getTimeToExpiry(token);
                const refreshTime = Math.max(0, timeToExpiry - (thresholdMinutes * 60)) * 1000;
                
                if (refreshTime > 0) {
                    this.tokenRefreshInterval = setTimeout(() => {
                        try {
                            const newToken = this.refreshToken(token);
                            callback(newToken);
                            this.startAutoRefresh(newToken, callback, thresholdMinutes);
                        } catch (error) {
                            console.error('Ø®Ø·Ø§ Ø¯Ø± ØªÙ…Ø¯ÛŒØ¯ Ø®ÙˆØ¯Ú©Ø§Ø±:', error);
                        }
                    }, refreshTime);
                }
            }

            // ØªÙˆÙ‚Ù ØªÙ…Ø¯ÛŒØ¯ Ø®ÙˆØ¯Ú©Ø§Ø±
            stopAutoRefresh() {
                if (this.tokenRefreshInterval) {
                    clearTimeout(this.tokenRefreshInterval);
                    this.tokenRefreshInterval = null;
                }
            }

            // Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ú©Ø§Ø±Ø¨Ø± Ø§Ø² ØªÙˆÚ©Ù†
            getUserFromToken(token) {
                const result = this.parseToken(token);
                if (!result.valid) return null;
                
                return {
                    id: result.payload.sub,
                    role: result.payload.role,
                    level: result.payload.level,
                    xp: result.payload.xp,
                    issuedAt: new Date(result.payload.iat * 1000),
                    expiresAt: new Date(result.payload.exp * 1000)
                };
            }
        }

        // ==================== Test Suite ====================
        const tests = [
            // Ø¯Ø³ØªÙ‡ Û±: ØªÙˆÙ„ÛŒØ¯ ØªÙˆÚ©Ù†
            {
                category: 'ØªÙˆÙ„ÛŒØ¯ ØªÙˆÚ©Ù†',
                name: 'ØªÙˆÙ„ÛŒØ¯ JToken Ù…Ø¹ØªØ¨Ø±',
                description: 'ØªÙˆÚ©Ù† Ø¨Ø§ÛŒØ¯ Ø¨Ø§ Ø³Ø§Ø®ØªØ§Ø± Ø³Ù‡â€ŒØ¨Ø®Ø´ÛŒ ØªÙˆÙ„ÛŒØ¯ Ø´ÙˆØ¯',
                fn: async () => {
                    const jwt = new JWTManager();
                    const token = jwt.generateToken('user-123', { level: 5, xp: 1000 });
                    
                    const parts = token.split('.');
                    if (parts.length !== 3) {
                        return `ØªÙˆÚ©Ù† Ø¨Ø§ÛŒØ¯ Û³ Ø¨Ø®Ø´ Ø¯Ø§Ø´ØªÙ‡ Ø¨Ø§Ø´Ø¯ØŒ Ø§Ù…Ø§ ${parts.length} Ø¨Ø®Ø´ Ø¯Ø§Ø±Ø¯`;
                    }
                    
                    try {
                        JSON.parse(atob(parts[0])); // header
                        JSON.parse(atob(parts[1])); // payload
                    } catch (e) {
                        return `Ø¨Ø®Ø´â€ŒÙ‡Ø§ÛŒ ØªÙˆÚ©Ù† JSON Ù…Ø¹ØªØ¨Ø± Ù†ÛŒØ³ØªÙ†Ø¯: ${e.message}`;
                    }
                    
                    if (parts[2].length < 10) {
                        return `Ø§Ù…Ø¶Ø§ Ø®ÛŒÙ„ÛŒ Ú©ÙˆØªØ§Ù‡ Ø§Ø³Øª: ${parts[2]}`;
                    }
                    
                    return true;
                }
            },
            {
                category: 'ØªÙˆÙ„ÛŒØ¯ ØªÙˆÚ©Ù†',
                name: 'Payload Ø´Ø§Ù…Ù„ Ø¯Ø§Ø¯Ù‡ Ú©Ø§Ø±Ø¨Ø±',
                description: 'ØªÙˆÚ©Ù† Ø¨Ø§ÛŒØ¯ Ø´Ø§Ù…Ù„ ØªÙ…Ø§Ù… Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ÛŒ Ú©Ø§Ø±Ø¨Ø± Ø¨Ø§Ø´Ø¯',
                fn: async () => {
                    const jwt = new JWTManager();
                    const userData = {
                        level: 7,
                        xp: 2500,
                        role: 'premium',
                        name: 'Ø¹Ù„ÛŒ'
                    };
                    
                    const token = jwt.generateToken('user-456', userData);
                    const result = jwt.parseToken(token);
                    
                    if (!result.valid) {
                        return `ØªÙˆÚ©Ù† Ù†Ø§Ù…Ø¹ØªØ¨Ø±: ${result.error}`;
                    }
                    
                    const checks = [
                        result.payload.sub === 'user-456',
                        result.payload.level === 7,
                        result.payload.xp === 2500,
                        result.payload.role === 'premium',
                        result.payload.name === 'Ø¹Ù„ÛŒ',
                        result.payload.iat > 0,
                        result.payload.exp > result.payload.iat
                    ];
                    
                    if (!checks.every(c => c)) {
                        return 'Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ÛŒ Ú©Ø§Ø±Ø¨Ø± Ø¯Ø± payload Ø¨Ù‡ Ø¯Ø±Ø³ØªÛŒ Ø°Ø®ÛŒØ±Ù‡ Ù†Ø´Ø¯Ù‡â€ŒØ§Ù†Ø¯';
                    }
                    
                    return true;
                }
            },
            
            // Ø¯Ø³ØªÙ‡ Û²: Ø§Ø¹ØªØ¨Ø§Ø±Ø³Ù†Ø¬ÛŒ
            {
                category: 'Ø§Ø¹ØªØ¨Ø§Ø±Ø³Ù†Ø¬ÛŒ',
                name: 'Ø§Ø¹ØªØ¨Ø§Ø±Ø³Ù†Ø¬ÛŒ ØªÙˆÚ©Ù† Ù…Ø¹ØªØ¨Ø±',
                description: 'ØªÙˆÚ©Ù† Ù…Ø¹ØªØ¨Ø± Ø¨Ø§ÛŒØ¯ Ø¨Ù‡ Ø¯Ø±Ø³ØªÛŒ Ø§Ø¹ØªØ¨Ø§Ø±Ø³Ù†Ø¬ÛŒ Ø´ÙˆØ¯',
                fn: async () => {
                    const jwt = new JWTManager();
                    const token = jwt.generateToken('user-789');
                    
                    if (!jwt.isTokenValid(token)) {
                        return 'ØªÙˆÚ©Ù† Ù…Ø¹ØªØ¨Ø± Ø¨Ù‡ Ø¹Ù†ÙˆØ§Ù† Ù†Ø§Ù…Ø¹ØªØ¨Ø± Ø´Ù†Ø§Ø³Ø§ÛŒÛŒ Ø´Ø¯';
                    }
                    
                    const parsed = jwt.parseToken(token);
                    if (!parsed.valid) {
                        return `Ø§Ø¹ØªØ¨Ø§Ø±Ø³Ù†Ø¬ÛŒ Ù†Ø§Ù…ÙˆÙÙ‚: ${parsed.error}`;
                    }
                    
                    return true;
                }
            },
            {
                category: 'Ø§Ø¹ØªØ¨Ø§Ø±Ø³Ù†Ø¬ÛŒ',
                name: 'ØªØ´Ø®ÛŒØµ ØªÙˆÚ©Ù† Ù†Ø§Ù…Ø¹ØªØ¨Ø±',
                description: 'ØªÙˆÚ©Ù†â€ŒÙ‡Ø§ÛŒ Ø¯Ø³ØªÚ©Ø§Ø±ÛŒ Ø´Ø¯Ù‡ Ø¨Ø§ÛŒØ¯ Ø±Ø¯ Ø´ÙˆÙ†Ø¯',
                fn: async () => {
                    const jwt = new JWTManager();
                    const validToken = jwt.generateToken('user-999');
                    
                    // ØªÙˆÚ©Ù† Ø¯Ø³ØªÚ©Ø§Ø±ÛŒ Ø´Ø¯Ù‡
                    const parts = validToken.split('.');
                    const tamperedToken = parts[0] + '.' + parts[1] + '.tampered-signature';
                    
                    if (jwt.isTokenValid(tamperedToken)) {
                        return 'ØªÙˆÚ©Ù† Ø¯Ø³ØªÚ©Ø§Ø±ÛŒ Ø´Ø¯Ù‡ Ø¨Ù‡ Ø¹Ù†ÙˆØ§Ù† Ù…Ø¹ØªØ¨Ø± Ù¾Ø°ÛŒØ±ÙØªÙ‡ Ø´Ø¯';
                    }
                    
                    // ØªÙˆÚ©Ù† Ø¨Ø§ ÙØ±Ù…Øª Ù†Ø§Ø¯Ø±Ø³Øª
                    if (jwt.isTokenValid('not.a.jwt.token')) {
                        return 'ØªÙˆÚ©Ù† Ø¨Ø§ ÙØ±Ù…Øª Ù†Ø§Ø¯Ø±Ø³Øª Ù¾Ø°ÛŒØ±ÙØªÙ‡ Ø´Ø¯';
                    }
                    
                    // ØªÙˆÚ©Ù† Ø®Ø§Ù„ÛŒ
                    if (jwt.isTokenValid('')) {
                        return 'ØªÙˆÚ©Ù† Ø®Ø§Ù„ÛŒ Ù¾Ø°ÛŒØ±ÙØªÙ‡ Ø´Ø¯';
                    }
                    
                    return true;
                }
            },
            {
                category: 'Ø§Ø¹ØªØ¨Ø§Ø±Ø³Ù†Ø¬ÛŒ',
                name: 'ØªØ´Ø®ÛŒØµ Ø§Ù†Ù‚Ø¶Ø§ÛŒ ØªÙˆÚ©Ù†',
                description: 'ØªÙˆÚ©Ù†â€ŒÙ‡Ø§ÛŒ Ù…Ù†Ù‚Ø¶ÛŒ Ø´Ø¯Ù‡ Ø¨Ø§ÛŒØ¯ ØªØ´Ø®ÛŒØµ Ø¯Ø§Ø¯Ù‡ Ø´ÙˆÙ†Ø¯',
                fn: async () => {
                    const jwt = new JWTManager();
                    
                    // ØªÙˆÚ©Ù† Ù…Ù†Ù‚Ø¶ÛŒ Ø´Ø¯Ù‡
                    const expiredToken = jwt.generateToken('user-exp', {}, -1); // Ù…Ù†Ù‚Ø¶ÛŒ Ø¯Ø± Ú¯Ø°Ø´ØªÙ‡
                    
                    if (jwt.isTokenValid(expiredToken)) {
                        return 'ØªÙˆÚ©Ù† Ù…Ù†Ù‚Ø¶ÛŒ Ø´Ø¯Ù‡ Ø¨Ù‡ Ø¹Ù†ÙˆØ§Ù† Ù…Ø¹ØªØ¨Ø± Ø´Ù†Ø§Ø³Ø§ÛŒÛŒ Ø´Ø¯';
                    }
                    
                    if (!jwt.isTokenExpired(expiredToken)) {
                        return 'ØªÙˆÚ©Ù† Ù…Ù†Ù‚Ø¶ÛŒ Ø´Ø¯Ù‡ ØªØ´Ø®ÛŒØµ Ø¯Ø§Ø¯Ù‡ Ù†Ø´Ø¯';
                    }
                    
                    // ØªÙˆÚ©Ù† Ù…Ø¹ØªØ¨Ø± Ù†Ø¨Ø§ÛŒØ¯ Ù…Ù†Ù‚Ø¶ÛŒ Ø´Ø¯Ù‡ Ø¨Ø§Ø´Ø¯
                    const validToken = jwt.generateToken('user-valid', {}, 24);
                    if (jwt.isTokenExpired(validToken)) {
                        return 'ØªÙˆÚ©Ù† Ù…Ø¹ØªØ¨Ø± Ø¨Ù‡ Ø¹Ù†ÙˆØ§Ù† Ù…Ù†Ù‚Ø¶ÛŒ Ø´Ø¯Ù‡ Ø´Ù†Ø§Ø³Ø§ÛŒÛŒ Ø´Ø¯';
                    }
                    
                    return true;
                }
            },
            
            // Ø¯Ø³ØªÙ‡ Û³: Ù…Ø¯ÛŒØ±ÛŒØª ØªÙˆÚ©Ù†
            {
                category: 'Ù…Ø¯ÛŒØ±ÛŒØª ØªÙˆÚ©Ù†',
                name: 'ØªÙ…Ø¯ÛŒØ¯ ØªÙˆÚ©Ù†',
                description: 'ØªÙˆÚ©Ù† Ù‚Ø¯ÛŒÙ…ÛŒ Ø¨Ø§ÛŒØ¯ Ù‚Ø§Ø¨Ù„ ØªÙ…Ø¯ÛŒØ¯ Ø¨Ø§Ø´Ø¯',
                fn: async () => {
                    const jwt = new JWTManager();
                    const oldToken = jwt.generateToken('user-old', { level: 3 }, 1); // 1 Ø³Ø§Ø¹Øª
                    
                    const newToken = jwt.refreshToken(oldToken, 24); // 24 Ø³Ø§Ø¹Øª
                    
                    if (!jwt.isTokenValid(newToken)) {
                        return 'ØªÙˆÚ©Ù† Ø¬Ø¯ÛŒØ¯ Ù†Ø§Ù…Ø¹ØªØ¨Ø± Ø§Ø³Øª';
                    }
                    
                    const oldUser = jwt.getUserFromToken(oldToken);
                    const newUser = jwt.getUserFromToken(newToken);
                    
                    if (oldUser.id !== newUser.id) {
                        return `Ø´Ù†Ø§Ø³Ù‡ Ú©Ø§Ø±Ø¨Ø± ØªØºÛŒÛŒØ± Ú©Ø±Ø¯Ù‡: ${oldUser.id} â†’ ${newUser.id}`;
                    }
                    
                    if (oldUser.level !== newUser.level) {
                        return `Ø³Ø·Ø­ Ú©Ø§Ø±Ø¨Ø± ØªØºÛŒÛŒØ± Ú©Ø±Ø¯Ù‡: ${oldUser.level} â†’ ${newUser.level}`;
                    }
                    
                    // Ø²Ù…Ø§Ù† Ø§Ù†Ù‚Ø¶Ø§ÛŒ Ø¬Ø¯ÛŒØ¯ Ø¨Ø§ÛŒØ¯ Ø¨ÛŒØ´ØªØ± Ø¨Ø§Ø´Ø¯
                    if (newUser.expiresAt <= oldUser.expiresAt) {
                        return 'Ø²Ù…Ø§Ù† Ø§Ù†Ù‚Ø¶Ø§ ØªÙ…Ø¯ÛŒØ¯ Ù†Ø´Ø¯Ù‡ Ø§Ø³Øª';
                    }
                    
                    return true;
                }
            },
            {
                category: 'Ù…Ø¯ÛŒØ±ÛŒØª ØªÙˆÚ©Ù†',
                name: 'ØªÙˆÙ„ÛŒØ¯ Refresh Token',
                description: 'Refresh Token Ø¨Ø§ÛŒØ¯ Ø§Ù…Ù† Ùˆ Ù…Ù†Ø­ØµØ± Ø¨Ù‡ ÙØ±Ø¯ Ø¨Ø§Ø´Ø¯',
                fn: async () => {
                    const jwt = new JWTManager();
                    const userId = 'user-777';
                    
                    const rt1 = jwt.generateRefreshToken(userId);
                    const rt2 = jwt.generateRefreshToken(userId);
                    
                    // Refresh Token Ø¨Ø§ÛŒØ¯ Ù…Ù†Ø­ØµØ± Ø¨Ù‡ ÙØ±Ø¯ Ø¨Ø§Ø´Ø¯
                    if (rt1.token === rt2.token) {
                        return 'Refresh Tokenâ€ŒÙ‡Ø§ÛŒ ÛŒÚ©Ø³Ø§Ù† ØªÙˆÙ„ÛŒØ¯ Ø´Ø¯Ù‡â€ŒØ§Ù†Ø¯';
                    }
                    
                    // Ø³Ø§Ø®ØªØ§Ø± Ø¨Ø§ÛŒØ¯ Ø¯Ø±Ø³Øª Ø¨Ø§Ø´Ø¯
                    if (!rt1.token.startsWith('rf_')) {
                        return `Ù¾ÛŒØ´ÙˆÙ†Ø¯ Ù†Ø§Ø¯Ø±Ø³Øª: ${rt1.token}`;
                    }
                    
                    if (!rt1.token.includes(userId)) {
                        return `Ø´Ù†Ø§Ø³Ù‡ Ú©Ø§Ø±Ø¨Ø± Ø¯Ø± ØªÙˆÚ©Ù† Ù†ÛŒØ³Øª: ${rt1.token}`;
                    }
                    
                    if (rt1.token.length < 50) {
                        return `ØªÙˆÚ©Ù† Ø®ÛŒÙ„ÛŒ Ú©ÙˆØªØ§Ù‡: ${rt1.token.length} Ú©Ø§Ø±Ø§Ú©ØªØ±`;
                    }
                    
                    // Ø²Ù…Ø§Ù† Ø§Ù†Ù‚Ø¶Ø§ Ø¨Ø§ÛŒØ¯ Ø¯Ø± Ø¢ÛŒÙ†Ø¯Ù‡ Ø¨Ø§Ø´Ø¯
                    if (rt1.expiresAt <= Date.now()) {
                        return 'Ø²Ù…Ø§Ù† Ø§Ù†Ù‚Ø¶Ø§ Ø¯Ø± Ú¯Ø°Ø´ØªÙ‡ Ø§Ø³Øª';
                    }
                    
                    return true;
                }
            },
            
            // Ø¯Ø³ØªÙ‡ Û´: Ø²Ù…Ø§Ù†â€ŒØ¨Ù†Ø¯ÛŒ
            {
                category: 'Ø²Ù…Ø§Ù†â€ŒØ¨Ù†Ø¯ÛŒ',
                name: 'Ù…Ø­Ø§Ø³Ø¨Ù‡ Ø²Ù…Ø§Ù† Ø¨Ø§Ù‚ÛŒâ€ŒÙ…Ø§Ù†Ø¯Ù‡',
                description: 'Ø²Ù…Ø§Ù† Ø¨Ø§Ù‚ÛŒâ€ŒÙ…Ø§Ù†Ø¯Ù‡ ØªØ§ Ø§Ù†Ù‚Ø¶Ø§ Ø¨Ø§ÛŒØ¯ Ø¯Ù‚ÛŒÙ‚ Ù…Ø­Ø§Ø³Ø¨Ù‡ Ø´ÙˆØ¯',
                fn: async () => {
                    const jwt = new JWTManager();
                    const token = jwt.generateToken('user-time', {}, 2); // 2 Ø³Ø§Ø¹Øª
                    
                    const timeToExpiry = jwt.getTimeToExpiry(token);
                    
                    // Ø¨Ø§ÛŒØ¯ Ø¨ÛŒÙ† 7190 ØªØ§ 7200 Ø«Ø§Ù†ÛŒÙ‡ Ø¨Ø§Ø´Ø¯ (Û² Ø³Ø§Ø¹Øª Ù…Ù†ÙÛŒ Ú†Ù†Ø¯ Ø«Ø§Ù†ÛŒÙ‡)
                    if (timeToExpiry < 7100 || timeToExpiry > 7200) {
                        return `Ø²Ù…Ø§Ù† Ø¨Ø§Ù‚ÛŒâ€ŒÙ…Ø§Ù†Ø¯Ù‡ Ù†Ø§Ù…Ø¹ØªØ¨Ø±: ${timeToExpiry} Ø«Ø§Ù†ÛŒÙ‡ (Ù…ÙˆØ±Ø¯ Ø§Ù†ØªØ¸Ø§Ø±: ~7200)`;
                    }
                    
                    // Ø¨Ø±Ø§ÛŒ ØªÙˆÚ©Ù† Ù…Ù†Ù‚Ø¶ÛŒ Ø´Ø¯Ù‡ Ø¨Ø§ÛŒØ¯ Û° Ø¨Ø§Ø´Ø¯
                    const expiredToken = jwt.generateToken('user-expired', {}, -1);
                    const expiredTime = jwt.getTimeToExpiry(expiredToken);
                    if (expiredTime !== 0) {
                        return `Ø²Ù…Ø§Ù† Ø¨Ø§Ù‚ÛŒâ€ŒÙ…Ø§Ù†Ø¯Ù‡ Ø¨Ø±Ø§ÛŒ ØªÙˆÚ©Ù† Ù…Ù†Ù‚Ø¶ÛŒ Ø´Ø¯Ù‡: ${expiredTime} (Ù…ÙˆØ±Ø¯ Ø§Ù†ØªØ¸Ø§Ø±: 0)`;
                    }
                    
                    return true;
                }
            },
            {
                category: 'Ø²Ù…Ø§Ù†â€ŒØ¨Ù†Ø¯ÛŒ',
                name: 'Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ú©Ø§Ø±Ø¨Ø±',
                description: 'Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ú©Ø§Ø±Ø¨Ø± Ø¨Ø§ÛŒØ¯ Ø§Ø² ØªÙˆÚ©Ù† Ù‚Ø§Ø¨Ù„ Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø¨Ø§Ø´Ø¯',
                fn: async () => {
                    const jwt = new JWTManager();
                    const issueTime = Math.floor(Date.now() / 1000);
                    const token = jwt.generateToken('user-info', { level: 10, xp: 5000, role: 'admin' });
                    
                    const user = jwt.getUserFromToken(token);
                    
                    if (!user) {
                        return 'Ú©Ø§Ø±Ø¨Ø± Ø§Ø² ØªÙˆÚ©Ù† Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ù†Ø´Ø¯';
                    }
                    
                    const checks = [
                        user.id === 'user-info',
                        user.level === 10,
                        user.xp === 5000,
                        user.role === 'admin',
                        user.issuedAt instanceof Date,
                        user.expiresAt instanceof Date,
                        user.expiresAt > user.issuedAt,
                        Math.abs(user.issuedAt.getTime() / 1000 - issueTime) < 2 // Ø­Ø¯Ø§Ú©Ø«Ø± Û² Ø«Ø§Ù†ÛŒÙ‡ Ø§Ø®ØªÙ„Ø§Ù
                    ];
                    
                    if (!checks.every(c => c)) {
                        return 'Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ú©Ø§Ø±Ø¨Ø± Ø¨Ù‡ Ø¯Ø±Ø³ØªÛŒ Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ù†Ø´Ø¯';
                    }
                    
                    return true;
                }
            },
            
            // Ø¯Ø³ØªÙ‡ Ûµ: Ø§Ù…Ù†ÛŒØª
            {
                category: 'Ø§Ù…Ù†ÛŒØª',
                name: 'Ø§Ù…Ù†ÛŒØª Ø¯Ø± Ø¨Ø±Ø§Ø¨Ø± ØªØºÛŒÛŒØ±Ø§Øª',
                description: 'ØªØºÛŒÛŒØ± Ú©ÙˆÚ†Ú© Ø¯Ø± ØªÙˆÚ©Ù† Ø¨Ø§ÛŒØ¯ Ø¢Ù† Ø±Ø§ Ù†Ø§Ù…Ø¹ØªØ¨Ø± Ú©Ù†Ø¯',
                fn: async () => {
                    const jwt = new JWTManager();
                    const token = jwt.generateToken('user-secure');
                    
                    // ØªØºÛŒÛŒØ± ÛŒÚ© Ú©Ø§Ø±Ø§Ú©ØªØ± Ø¯Ø± payload
                    const parts = token.split('.');
                    const payload = JSON.parse(atob(parts[1]));
                    payload.sub = 'hacker'; // ØªØºÛŒÛŒØ± Ø´Ù†Ø§Ø³Ù‡ Ú©Ø§Ø±Ø¨Ø±
                    const tamperedPayload = btoa(JSON.stringify(payload));
                    const tamperedToken = parts[0] + '.' + tamperedPayload + '.' + parts[2];
                    
                    if (jwt.isTokenValid(tamperedToken)) {
                        return 'ØªÙˆÚ©Ù† ØªØºÛŒÛŒØ± ÛŒØ§ÙØªÙ‡ Ù¾Ø°ÛŒØ±ÙØªÙ‡ Ø´Ø¯ (Ø§Ù…Ù†ÛŒØª Ù¾Ø§ÛŒÛŒÙ†)';
                    }
                    
                    // ØªØºÛŒÛŒØ± signature
                    const anotherTampered = parts[0] + '.' + parts[1] + '.fake-signature-123';
                    if (jwt.isTokenValid(anotherTampered)) {
                        return 'ØªÙˆÚ©Ù† Ø¨Ø§ signature Ø¬Ø¹Ù„ÛŒ Ù¾Ø°ÛŒØ±ÙØªÙ‡ Ø´Ø¯';
                    }
                    
                    return true;
                }
            }
        ];

        // ==================== Test Runner ====================
        let testResults = [];
        let startTime = null;

        function updateStats() {
            const passed = testResults.filter(r => r && r.success).length;
            const failed = testResults.filter(r => r && !r.success).length;
            
            document.getElementById('passedTests').textContent = passed;
            document.getElementById('failedTests').textContent = failed;
            
            if (startTime) {
                const duration = ((Date.now() - startTime) / 1000).toFixed(1);
                document.getElementById('duration').textContent = duration;
            }
        }

        function createTestElement(test, index, result = null) {
            const container = document.getElementById('testResults');
            
            // Ø§Ú¯Ø± Ø¯Ø³ØªÙ‡â€ŒØ¨Ù†Ø¯ÛŒ Ù‡Ù†ÙˆØ² Ø³Ø§Ø®ØªÙ‡ Ù†Ø´Ø¯Ù‡
            let categoryDiv = document.querySelector(`[data-category="${test.category}"]`);
            if (!categoryDiv) {
                categoryDiv = document.createElement('div');
                categoryDiv.className = 'test-category';
                categoryDiv.setAttribute('data-category', test.category);
                
                const title = document.createElement('div');
                title.className = 'category-title';
                title.textContent = test.category;
                categoryDiv.appendChild(title);
                
                container.appendChild(categoryDiv);
            }
            
            // Ø§ÛŒØ¬Ø§Ø¯ Ø§Ù„Ù…Ø§Ù† ØªØ³Øª
            const testDiv = document.createElement('div');
            testDiv.className = 'test-item';
            testDiv.id = `test-${index}`;
            
            const nameSpan = document.createElement('span');
            nameSpan.className = 'test-name';
            nameSpan.textContent = test.name;
            
            const statusSpan = document.createElement('span');
            statusSpan.className = `test-status ${result ? (result.success ? 'status-pass' : 'status-fail') : 'status-pending'}`;
            statusSpan.textContent = result ? (result.success ? 'âœ…' : 'âŒ') : 'â³';
            
            const detailsBtn = document.createElement('button');
            detailsBtn.className = 'details-btn';
            detailsBtn.textContent = 'Ø¬Ø²Ø¦ÛŒØ§Øª';
            detailsBtn.onclick = () => {
                testDiv.classList.toggle('expanded');
            };
            
            testDiv.appendChild(nameSpan);
            testDiv.appendChild(detailsBtn);
            testDiv.appendChild(statusSpan);
            
            // Ø¬Ø²Ø¦ÛŒØ§Øª ØªØ³Øª
            if (result) {
                const detailsDiv = document.createElement('div');
                detailsDiv.className = 'test-details';
                
                let detailsText = `${test.description}\n\n`;
                detailsText += `Ø²Ù…Ø§Ù† Ø§Ø¬Ø±Ø§: ${result.duration || 0}ms\n`;
                
                if (result.success) {
                    detailsText += '\nâœ… ØªØ³Øª Ù…ÙˆÙÙ‚ÛŒØªâ€ŒØ¢Ù…ÛŒØ² Ø¨ÙˆØ¯';
                } else {
                    detailsText += `\nâŒ ØªØ³Øª Ù†Ø§Ù…ÙˆÙÙ‚\n`;
                    if (result.error) {
                        detailsText += `Ø®Ø·Ø§: ${result.error.message}\n`;
                    } else if (result.message) {
                        detailsText += `Ù¾ÛŒØ§Ù…: ${result.message}`;
                    }
                }
                
                detailsDiv.textContent = detailsText;
                testDiv.appendChild(detailsDiv);
            }
            
            // Ø§Ø¶Ø§ÙÙ‡ Ú©Ø±Ø¯Ù† Ø¨Ù‡ Ø¯Ø³ØªÙ‡â€ŒØ¨Ù†Ø¯ÛŒ
            categoryDiv.appendChild(testDiv);
            
            return testDiv;
        }

        async function runTest(test, index) {
            const testElement = createTestElement(test, index);
            const startTime = Date.now();
            
            try {
                const result = await test.fn();
                const duration = Date.now() - startTime;
                
                const testResult = {
                    success: result === true,
                    duration,
                    message: result === true ? undefined : result,
                    test: test.name
                };
                
                testResults[index] = testResult;
                createTestElement(test, index, testResult);
                testElement.remove();
                
                return testResult;
                
            } catch (error) {
                const duration = Date.now() - startTime;
                const testResult = {
                    success: false,
                    duration,
                    error: error,
                    test: test.name
                };
                
                testResults[index] = testResult;
                createTestElement(test, index, testResult);
                testElement.remove();
                
                return testResult;
            }
        }

        async function runAllTests() {
            startTime = Date.now();
            testResults = new Array(tests.length);
            
            document.getElementById('testResults').innerHTML = '';
            
            for (let i = 0; i < tests.length; i++) {
                await runTest(tests[i], i);
                updateStats();
                await new Promise(resolve => setTimeout(resolve, 100));
            }
            
            const passed = testResults.filter(r => r && r.success).length;
            const total = tests.length;
            
            if (passed === total) {
                console.log(`ğŸ‰ Ù‡Ù…Ù‡ ${total} ØªØ³Øª JWT Ù…ÙˆÙÙ‚ Ø¨ÙˆØ¯Ù†Ø¯!`);
            } else {
                console.log(`âš ï¸ ${passed} Ø§Ø² ${total} ØªØ³Øª Ù…ÙˆÙÙ‚ Ø¨ÙˆØ¯Ù†Ø¯`);
            }
        }

        function decodeSampleJWT() {
            const jwt = new JWTManager();
            const token = jwt.generateToken('sample-user', { 
                level: 5, 
                xp: 1200, 
                role: 'user',
                name: 'Ù†Ù…ÙˆÙ†Ù‡ Ú©Ø§Ø±Ø¨Ø±'
            });
            
            const decoder = document.getElementById('jwtDecoder');
            const partsDiv = document.getElementById('jwtParts');
            
            const parts = token.split('.');
            const header = JSON.parse(atob(parts[0]));
            const payload = JSON.parse(atob(parts[1]));
            
            partsDiv.innerHTML = `
                <div class="jwt-part"><strong>Header:</strong> ${JSON.stringify(header, null, 2)}</div>
                <div class="jwt-part"><strong>Payload:</strong> ${JSON.stringify(payload, null, 2)}</div>
                <div class="jwt-part"><strong>Signature:</strong> ${parts[2]}</div>
                <div class="jwt-part"><strong>Ú©Ù„ ØªÙˆÚ©Ù†:</strong> ${token}</div>
            `;
            
            decoder.style.display = 'block';
        }

        // Ø§Ø¬Ø±Ø§ÛŒ Ø®ÙˆØ¯Ú©Ø§Ø±
        setTimeout(() => {
            console.log('ØªØ³Øªâ€ŒÙ‡Ø§ÛŒ JWT Ø¢Ù…Ø§Ø¯Ù‡ Ø§Ø¬Ø±Ø§ Ù‡Ø³ØªÙ†Ø¯...');
        }, 500);
    </script>
</body>
</html>
