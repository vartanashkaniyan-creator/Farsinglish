<!DOCTYPE html>
<html lang="fa">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ØªØ³Øª JWT (Ø§ØµÙ„Ø§Ø­ Ø´Ø¯Ù‡) - Farsinglish</title>
    <style>
        body {
            font-family: system-ui, -apple-system, sans-serif;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        .container {
            max-width: 800px;
            margin: auto;
            background: white;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }
        h1 {
            text-align: center;
            color: #1e293b;
            margin-bottom: 10px;
        }
        .subtitle {
            text-align: center;
            color: #64748b;
            margin-bottom: 20px;
        }
        .btn {
            display: block;
            margin: 20px auto;
            padding: 12px 24px;
            background: #4f46e5;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            cursor: pointer;
        }
        .btn:hover {
            background: #4338ca;
        }
        .test {
            margin: 15px 0;
            padding: 15px;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            background: #f8fafc;
        }
        .test.pass { border-left: 4px solid #10b981; }
        .test.fail { border-left: 4px solid #ef4444; }
        .test.pending { border-left: 4px solid #f59e0b; }
        .test-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
        }
        .test-name {
            font-weight: bold;
            color: #1e293b;
        }
        .test-status {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: bold;
        }
        .status-pass { background: #10b981; color: white; }
        .status-fail { background: #ef4444; color: white; }
        .status-pending { background: #f59e0b; color: white; }
        .test-details {
            background: white;
            padding: 10px;
            margin-top: 10px;
            border-radius: 5px;
            font-family: monospace;
            font-size: 12px;
            white-space: pre-wrap;
            display: none;
        }
        .test.expanded .test-details {
            display: block;
        }
        .toggle-btn {
            background: none;
            border: 1px solid #cbd5e0;
            padding: 4px 12px;
            border-radius: 4px;
            font-size: 12px;
            cursor: pointer;
            margin-top: 10px;
            color: #64748b;
        }
        .stats {
            display: flex;
            justify-content: space-around;
            margin: 20px 0;
            padding: 15px;
            background: #f1f5f9;
            border-radius: 10px;
        }
        .stat {
            text-align: center;
        }
        .stat-value {
            font-size: 24px;
            font-weight: bold;
        }
        .stat-label {
            font-size: 12px;
            color: #64748b;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ” ØªØ³Øª JWT (Ø§ØµÙ„Ø§Ø­ Ø´Ø¯Ù‡)</h1>
        <p class="subtitle">Ø±ÙØ¹ Ø®Ø·Ø§Ù‡Ø§ÛŒ ØªÙˆÙ„ÛŒØ¯ ØªÙˆÚ©Ù†ØŒ payload Ùˆ ØªÙ…Ø¯ÛŒØ¯</p>
        
        <div class="stats">
            <div class="stat">
                <div class="stat-value" id="totalTests">7</div>
                <div class="stat-label">Ú©Ù„ ØªØ³Øªâ€ŒÙ‡Ø§</div>
            </div>
            <div class="stat">
                <div class="stat-value" id="passedTests">0</div>
                <div class="stat-label">Ù…ÙˆÙÙ‚</div>
            </div>
            <div class="stat">
                <div class="stat-value" id="failedTests">0</div>
                <div class="stat-label">Ù†Ø§Ù…ÙˆÙÙ‚</div>
            </div>
        </div>
        
        <button class="btn" onclick="runTests()">Ø§Ø¬Ø±Ø§ÛŒ ØªØ³Øªâ€ŒÙ‡Ø§</button>
        
        <div id="testResults"></div>
    </div>

    <script>
        // ==================== JWT Manager (Ø§ØµÙ„Ø§Ø­ Ø´Ø¯Ù‡) ====================
        class JWTManager {
            constructor() {
                this.secret = 'farsinglish-secure-key-' + Date.now();
            }

            // Ø§ØµÙ„Ø§Ø­ Û±: ØªÙˆÙ„ÛŒØ¯ ØªÙˆÚ©Ù† Ø¨Ø§ encodeURIComponent Ø¨Ø±Ø§ÛŒ Ù¾Ø´ØªÛŒØ¨Ø§Ù†ÛŒ Ø§Ø² ÙØ§Ø±Ø³ÛŒ
            generateToken(userId, userData = {}, expiresInHours = 24) {
                const header = {
                    alg: 'HS256',
                    typ: 'JWT'
                };
                
                const now = Math.floor(Date.now() / 1000);
                const payload = {
                    sub: userId,
                    iat: now,
                    exp: now + (expiresInHours * 3600),
                    role: userData.role || 'user',
                    level: userData.level || 1,
                    xp: userData.xp || 0,
                    ...userData
                };
                
                // Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø§Ø² encodeURIComponent + btoa Ø¨Ø±Ø§ÛŒ Ù¾Ø´ØªÛŒØ¨Ø§Ù†ÛŒ Ø§Ø² Unicode
                const headerBase64 = btoa(encodeURIComponent(JSON.stringify(header)));
                const payloadBase64 = btoa(encodeURIComponent(JSON.stringify(payload)));
                const signature = this._createSignature(headerBase64, payloadBase64);
                
                return `${headerBase64}.${payloadBase64}.${signature}`;
            }

            _createSignature(header, payload) {
                // Ø§ÛŒØ¬Ø§Ø¯ signature Ø³Ø§Ø¯Ù‡ Ø§Ù…Ø§ Ù…Ù†Ø­ØµØ± Ø¨Ù‡ ÙØ±Ø¯
                const str = header + payload + this.secret;
                let hash = 0;
                for (let i = 0; i < str.length; i++) {
                    const char = str.charCodeAt(i);
                    hash = ((hash << 5) - hash) + char;
                    hash = hash & hash;
                }
                return Math.abs(hash).toString(36).padStart(10, '0');
            }

            // Ø§ØµÙ„Ø§Ø­ Û²: parseToken Ø¨Ø§ decodeURIComponent
            parseToken(token) {
                try {
                    if (!token || typeof token !== 'string') {
                        return { valid: false, error: 'ØªÙˆÚ©Ù† Ù†Ø§Ù…Ø¹ØªØ¨Ø± Ø§Ø³Øª' };
                    }
                    
                    const parts = token.split('.');
                    if (parts.length !== 3) {
                        return { valid: false, error: 'ÙØ±Ù…Øª ØªÙˆÚ©Ù† Ù†Ø§Ù…Ø¹ØªØ¨Ø±' };
                    }

                    const [headerBase64, payloadBase64, signature] = parts;
                    
                    // Ø¨Ø±Ø±Ø³ÛŒ signature
                    const expectedSignature = this._createSignature(headerBase64, payloadBase64);
                    if (signature !== expectedSignature) {
                        return { valid: false, error: 'Ø§Ù…Ø¶Ø§ÛŒ ØªÙˆÚ©Ù† Ù†Ø§Ù…Ø¹ØªØ¨Ø±' };
                    }

                    // decode Ø¨Ø§ decodeURIComponent
                    const headerStr = decodeURIComponent(atob(headerBase64));
                    const payloadStr = decodeURIComponent(atob(payloadBase64));
                    
                    const header = JSON.parse(headerStr);
                    const payload = JSON.parse(payloadStr);
                    
                    // Ø¨Ø±Ø±Ø³ÛŒ Ø²Ù…Ø§Ù† Ø§Ù†Ù‚Ø¶Ø§
                    const now = Math.floor(Date.now() / 1000);
                    if (payload.exp < now) {
                        return { 
                            valid: false, 
                            error: 'ØªÙˆÚ©Ù† Ù…Ù†Ù‚Ø¶ÛŒ Ø´Ø¯Ù‡',
                            payload,
                            expired: true 
                        };
                    }

                    return {
                        valid: true,
                        header,
                        payload,
                        signature
                    };

                } catch (error) {
                    return { valid: false, error: `Ø®Ø·Ø§ Ø¯Ø± Ù¾Ø±Ø¯Ø§Ø²Ø´ ØªÙˆÚ©Ù†: ${error.message}` };
                }
            }

            isTokenValid(token) {
                const result = this.parseToken(token);
                return result.valid === true;
            }

            // Ø§ØµÙ„Ø§Ø­ Û³: ØªÙ…Ø¯ÛŒØ¯ ØªÙˆÚ©Ù† - Ø§ÛŒØ¬Ø§Ø¯ ØªÙˆÚ©Ù† Ø¬Ø¯ÛŒØ¯ Ø¨Ø§ Ù‡Ù…Ø§Ù† Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§
            refreshToken(oldToken, newExpiryHours = 24) {
                const result = this.parseToken(oldToken);
                if (!result.valid) {
                    throw new Error(`ØªÙˆÚ©Ù† Ù‚Ø¯ÛŒÙ…ÛŒ Ù†Ø§Ù…Ø¹ØªØ¨Ø±: ${result.error}`);
                }

                // Ø§ÛŒØ¬Ø§Ø¯ ØªÙˆÚ©Ù† Ø¬Ø¯ÛŒØ¯ Ø¨Ø§ Ù‡Ù…Ø§Ù† payload Ø§Ù…Ø§ Ø²Ù…Ø§Ù† Ø§Ù†Ù‚Ø¶Ø§ÛŒ Ø¬Ø¯ÛŒØ¯
                const newPayload = { ...result.payload };
                const now = Math.floor(Date.now() / 1000);
                newPayload.iat = now;
                newPayload.exp = now + (newExpiryHours * 3600);
                
                // Ø­Ø°Ù ÙÛŒÙ„Ø¯Ù‡Ø§ÛŒ Ø³ÛŒØ³ØªÙ…ÛŒ Ø§Ø² userData
                const userData = { ...newPayload };
                delete userData.sub;
                delete userData.iat;
                delete userData.exp;
                delete userData.role; // role Ø±Ø§ Ù‡Ù… Ù†Ú¯Ù‡ Ù…ÛŒâ€ŒØ¯Ø§Ø±ÛŒÙ…
                
                return this.generateToken(result.payload.sub, userData, newExpiryHours);
            }

            getTimeToExpiry(token) {
                const result = this.parseToken(token);
                if (!result.valid || !result.payload) return 0;
                
                const now = Math.floor(Date.now() / 1000);
                return Math.max(0, result.payload.exp - now);
            }

            getUserFromToken(token) {
                const result = this.parseToken(token);
                if (!result.valid) return null;
                
                return {
                    id: result.payload.sub,
                    role: result.payload.role,
                    level: result.payload.level,
                    xp: result.payload.xp,
                    issuedAt: new Date(result.payload.iat * 1000),
                    expiresAt: new Date(result.payload.exp * 1000)
                };
            }
        }

        // ==================== ØªØ³Øªâ€ŒÙ‡Ø§ÛŒ Ø§ØµÙ„ÛŒ (Ø§ØµÙ„Ø§Ø­ Ø´Ø¯Ù‡) ====================
        const tests = [
            {
                name: 'ØªÙˆÙ„ÛŒØ¯ JToken Ù…Ø¹ØªØ¨Ø±',
                description: 'ØªÙˆÚ©Ù† Ø¨Ø§ÛŒØ¯ Ø¨Ø§ Ø³Ø§Ø®ØªØ§Ø± Ø³Ù‡â€ŒØ¨Ø®Ø´ÛŒ Ùˆ Ø¯Ø§Ø¯Ù‡ ÙØ§Ø±Ø³ÛŒ ØªÙˆÙ„ÛŒØ¯ Ø´ÙˆØ¯',
                fn: async () => {
                    const jwt = new JWTManager();
                    const token = jwt.generateToken('user-123', { 
                        name: 'Ø¹Ù„ÛŒ Ø±Ø¶Ø§ÛŒÛŒ',
                        level: 5 
                    });
                    
                    // Ø¨Ø±Ø±Ø³ÛŒ Ø³Ø§Ø®ØªØ§Ø±
                    const parts = token.split('.');
                    if (parts.length !== 3) {
                        return `ØªÙˆÚ©Ù† Ø¨Ø§ÛŒØ¯ Û³ Ø¨Ø®Ø´ Ø¯Ø§Ø´ØªÙ‡ Ø¨Ø§Ø´Ø¯ØŒ Ø§Ù…Ø§ ${parts.length} Ø¨Ø®Ø´ Ø¯Ø§Ø±Ø¯`;
                    }
                    
                    // Ø¨Ø±Ø±Ø³ÛŒ Ø·ÙˆÙ„ Ø¨Ø®Ø´â€ŒÙ‡Ø§
                    if (parts[0].length < 10) return 'header Ø®ÛŒÙ„ÛŒ Ú©ÙˆØªØ§Ù‡ Ø§Ø³Øª';
                    if (parts[1].length < 10) return 'payload Ø®ÛŒÙ„ÛŒ Ú©ÙˆØªØ§Ù‡ Ø§Ø³Øª';
                    if (parts[2].length < 8) return 'signature Ø®ÛŒÙ„ÛŒ Ú©ÙˆØªØ§Ù‡ Ø§Ø³Øª';
                    
                    // Ø¨Ø±Ø±Ø³ÛŒ Ø§Ø¹ØªØ¨Ø§Ø±
                    if (!jwt.isTokenValid(token)) {
                        return 'ØªÙˆÚ©Ù† ØªÙˆÙ„ÛŒØ¯ Ø´Ø¯Ù‡ Ù…Ø¹ØªØ¨Ø± Ù†ÛŒØ³Øª';
                    }
                    
                    return true;
                }
            },
            {
                name: 'Payload Ø¨Ø§ Ø¯Ø§Ø¯Ù‡ ÙØ§Ø±Ø³ÛŒ',
                description: 'ØªÙˆÚ©Ù† Ø¨Ø§ÛŒØ¯ Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ÛŒ ÙØ§Ø±Ø³ÛŒ Ø±Ø§ Ø¯Ø± payload Ù†Ú¯Ù‡ Ø¯Ø§Ø±Ø¯',
                fn: async () => {
                    const jwt = new JWTManager();
                    const userData = {
                        name: 'Ù…Ø­Ù…Ø¯ Ø­Ø³ÛŒÙ†ÛŒ',
                        city: 'ØªÙ‡Ø±Ø§Ù†',
                        level: 7,
                        xp: 2500
                    };
                    
                    const token = jwt.generateToken('user-fa', userData);
                    const result = jwt.parseToken(token);
                    
                    if (!result.valid) {
                        return `ØªÙˆÚ©Ù† Ù†Ø§Ù…Ø¹ØªØ¨Ø±: ${result.error}`;
                    }
                    
                    // Ø¨Ø±Ø±Ø³ÛŒ Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ÛŒ ÙØ§Ø±Ø³ÛŒ
                    if (result.payload.name !== 'Ù…Ø­Ù…Ø¯ Ø­Ø³ÛŒÙ†ÛŒ') {
                        return `Ù†Ø§Ù… Ú©Ø§Ø±Ø¨Ø± Ø§Ø´ØªØ¨Ø§Ù‡: ${result.payload.name}`;
                    }
                    
                    if (result.payload.city !== 'ØªÙ‡Ø±Ø§Ù†') {
                        return `Ø´Ù‡Ø± Ú©Ø§Ø±Ø¨Ø± Ø§Ø´ØªØ¨Ø§Ù‡: ${result.payload.city}`;
                    }
                    
                    if (result.payload.level !== 7) {
                        return `Ø³Ø·Ø­ Ú©Ø§Ø±Ø¨Ø± Ø§Ø´ØªØ¨Ø§Ù‡: ${result.payload.level}`;
                    }
                    
                    if (result.payload.xp !== 2500) {
                        return `ØªØ¬Ø±Ø¨Ù‡ Ú©Ø§Ø±Ø¨Ø± Ø§Ø´ØªØ¨Ø§Ù‡: ${result.payload.xp}`;
                    }
                    
                    // Ø¨Ø±Ø±Ø³ÛŒ ÙˆØ¬ÙˆØ¯ ÙÛŒÙ„Ø¯Ù‡Ø§ÛŒ Ø¶Ø±ÙˆØ±ÛŒ
                    if (!result.payload.sub || !result.payload.iat || !result.payload.exp) {
                        return 'ÙÛŒÙ„Ø¯Ù‡Ø§ÛŒ Ø¶Ø±ÙˆØ±ÛŒ ØªÙˆÚ©Ù† ÙˆØ¬ÙˆØ¯ Ù†Ø¯Ø§Ø±Ù†Ø¯';
                    }
                    
                    return true;
                }
            },
            {
                name: 'Ø§Ø¹ØªØ¨Ø§Ø±Ø³Ù†Ø¬ÛŒ ØªÙˆÚ©Ù† Ù…Ø¹ØªØ¨Ø±',
                description: 'ØªÙˆÚ©Ù† Ù…Ø¹ØªØ¨Ø± Ø¨Ø§ÛŒØ¯ Ù¾Ø°ÛŒØ±ÙØªÙ‡ Ø´ÙˆØ¯',
                fn: async () => {
                    const jwt = new JWTManager();
                    const token = jwt.generateToken('user-valid');
                    
                    const isValid = jwt.isTokenValid(token);
                    if (!isValid) {
                        return 'ØªÙˆÚ©Ù† Ù…Ø¹ØªØ¨Ø± Ø±Ø¯ Ø´Ø¯';
                    }
                    
                    const parsed = jwt.parseToken(token);
                    if (!parsed.valid) {
                        return `Ø§Ø¹ØªØ¨Ø§Ø±Ø³Ù†Ø¬ÛŒ Ù†Ø§Ù…ÙˆÙÙ‚: ${parsed.error}`;
                    }
                    
                    if (parsed.payload.sub !== 'user-valid') {
                        return `Ø´Ù†Ø§Ø³Ù‡ Ú©Ø§Ø±Ø¨Ø± Ø§Ø´ØªØ¨Ø§Ù‡: ${parsed.payload.sub}`;
                    }
                    
                    return true;
                }
            },
            {
                name: 'ØªØ´Ø®ÛŒØµ ØªÙˆÚ©Ù† Ù†Ø§Ù…Ø¹ØªØ¨Ø±',
                description: 'ØªÙˆÚ©Ù† Ø¯Ø³ØªÚ©Ø§Ø±ÛŒ Ø´Ø¯Ù‡ Ø¨Ø§ÛŒØ¯ Ø±Ø¯ Ø´ÙˆØ¯',
                fn: async () => {
                    const jwt = new JWTManager();
                    const validToken = jwt.generateToken('user-test');
                    
                    // ØªØºÛŒÛŒØ± signature
                    const parts = validToken.split('.');
                    const fakeToken = parts[0] + '.' + parts[1] + '.fake-signature-12345';
                    
                    if (jwt.isTokenValid(fakeToken)) {
                        return 'ØªÙˆÚ©Ù† Ø¨Ø§ signature Ø¬Ø¹Ù„ÛŒ Ù¾Ø°ÛŒØ±ÙØªÙ‡ Ø´Ø¯';
                    }
                    
                    // ØªÙˆÚ©Ù† Ø¨Ø§ ÙØ±Ù…Øª Ù†Ø§Ø¯Ø±Ø³Øª
                    if (jwt.isTokenValid('not.a.valid.token')) {
                        return 'ØªÙˆÚ©Ù† Ø¨Ø§ ÙØ±Ù…Øª Ù†Ø§Ø¯Ø±Ø³Øª Ù¾Ø°ÛŒØ±ÙØªÙ‡ Ø´Ø¯';
                    }
                    
                    // ØªÙˆÚ©Ù† Ø®Ø§Ù„ÛŒ
                    if (jwt.isTokenValid('')) {
                        return 'ØªÙˆÚ©Ù† Ø®Ø§Ù„ÛŒ Ù¾Ø°ÛŒØ±ÙØªÙ‡ Ø´Ø¯';
                    }
                    
                    // ØªÙˆÚ©Ù† null
                    if (jwt.isTokenValid(null)) {
                        return 'ØªÙˆÚ©Ù† null Ù¾Ø°ÛŒØ±ÙØªÙ‡ Ø´Ø¯';
                    }
                    
                    return true;
                }
            },
            {
                name: 'ØªÙ…Ø¯ÛŒØ¯ ØªÙˆÚ©Ù† (Ø±ÙØ¹ Ø®Ø·Ø§)',
                description: 'ØªÙˆÚ©Ù† Ù‚Ø¯ÛŒÙ…ÛŒ Ø¨Ø§ÛŒØ¯ Ù‚Ø§Ø¨Ù„ ØªÙ…Ø¯ÛŒØ¯ Ø¨Ø§Ø´Ø¯',
                fn: async () => {
                    const jwt = new JWTManager();
                    
                    // Ø§ÛŒØ¬Ø§Ø¯ ØªÙˆÚ©Ù† Ø¨Ø§ Ù…Ø¯Øª Ú©Ù…
                    const oldToken = jwt.generateToken('user-old', { level: 3, xp: 100 }, 0.1); // 6 Ø¯Ù‚ÛŒÙ‚Ù‡
                    
                    // ØµØ¨Ø± Ú©Ù† ØªØ§ Ù…Ø·Ù…Ø¦Ù† Ø´ÙˆÛŒÙ… ØªÙˆÚ©Ù† Ù‡Ù†ÙˆØ² Ù…Ø¹ØªØ¨Ø± Ø§Ø³Øª
                    await new Promise(resolve => setTimeout(resolve, 100));
                    
                    // ØªÙ…Ø¯ÛŒØ¯ ØªÙˆÚ©Ù†
                    let newToken;
                    try {
                        newToken = jwt.refreshToken(oldToken, 24); // 24 Ø³Ø§Ø¹Øª
                    } catch (error) {
                        return `Ø®Ø·Ø§ Ø¯Ø± ØªÙ…Ø¯ÛŒØ¯ ØªÙˆÚ©Ù†: ${error.message}`;
                    }
                    
                    // Ø¨Ø±Ø±Ø³ÛŒ ØªÙˆÚ©Ù† Ø¬Ø¯ÛŒØ¯
                    if (!jwt.isTokenValid(newToken)) {
                        return 'ØªÙˆÚ©Ù† Ø¬Ø¯ÛŒØ¯ Ù†Ø§Ù…Ø¹ØªØ¨Ø± Ø§Ø³Øª';
                    }
                    
                    // Ø¨Ø±Ø±Ø³ÛŒ Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ÛŒ Ú©Ø§Ø±Ø¨Ø±
                    const oldUser = jwt.getUserFromToken(oldToken);
                    const newUser = jwt.getUserFromToken(newToken);
                    
                    if (!oldUser || !newUser) {
                        return 'Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ú©Ø§Ø±Ø¨Ø± Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ù†Ø´Ø¯';
                    }
                    
                    if (oldUser.id !== newUser.id) {
                        return `Ø´Ù†Ø§Ø³Ù‡ Ú©Ø§Ø±Ø¨Ø± ØªØºÛŒÛŒØ± Ú©Ø±Ø¯: ${oldUser.id} â†’ ${newUser.id}`;
                    }
                    
                    if (oldUser.level !== newUser.level) {
                        return `Ø³Ø·Ø­ Ú©Ø§Ø±Ø¨Ø± ØªØºÛŒÛŒØ± Ú©Ø±Ø¯: ${oldUser.level} â†’ ${newUser.level}`;
                    }
                    
                    if (oldUser.xp !== newUser.xp) {
                        return `ØªØ¬Ø±Ø¨Ù‡ Ú©Ø§Ø±Ø¨Ø± ØªØºÛŒÛŒØ± Ú©Ø±Ø¯: ${oldUser.xp} â†’ ${newUser.xp}`;
                    }
                    
                    // ØªÙˆÚ©Ù† Ø¬Ø¯ÛŒØ¯ Ø¨Ø§ÛŒØ¯ Ø²Ù…Ø§Ù† Ø§Ù†Ù‚Ø¶Ø§ÛŒ Ø¨ÛŒØ´ØªØ±ÛŒ Ø¯Ø§Ø´ØªÙ‡ Ø¨Ø§Ø´Ø¯
                    if (newUser.expiresAt <= oldUser.expiresAt) {
                        return `Ø²Ù…Ø§Ù† Ø§Ù†Ù‚Ø¶Ø§ ØªÙ…Ø¯ÛŒØ¯ Ù†Ø´Ø¯\nÙ‚Ø¯ÛŒÙ…ÛŒ: ${oldUser.expiresAt}\nØ¬Ø¯ÛŒØ¯: ${newUser.expiresAt}`;
                    }
                    
                    return true;
                }
            },
            {
                name: 'Ø²Ù…Ø§Ù† Ø§Ù†Ù‚Ø¶Ø§ÛŒ ØªÙˆÚ©Ù†',
                description: 'Ø²Ù…Ø§Ù† Ø¨Ø§Ù‚ÛŒâ€ŒÙ…Ø§Ù†Ø¯Ù‡ ØªØ§ Ø§Ù†Ù‚Ø¶Ø§ Ø¨Ø§ÛŒØ¯ Ø¯Ø±Ø³Øª Ù…Ø­Ø§Ø³Ø¨Ù‡ Ø´ÙˆØ¯',
                fn: async () => {
                    const jwt = new JWTManager();
                    
                    // ØªÙˆÚ©Ù† Ø¨Ø§ 1 Ø³Ø§Ø¹Øª Ø§Ø¹ØªØ¨Ø§Ø±
                    const token = jwt.generateToken('user-time', {}, 1);
                    const timeToExpiry = jwt.getTimeToExpiry(token);
                    
                    // Ø¨Ø§ÛŒØ¯ Ø­Ø¯ÙˆØ¯ 3600 Ø«Ø§Ù†ÛŒÙ‡ Ø¨Ø§Ø´Ø¯ (Ø¨Ø§ Ø§Ø®ØªÙ„Ø§Ù Ûµ Ø«Ø§Ù†ÛŒÙ‡)
                    if (timeToExpiry < 3595 || timeToExpiry > 3605) {
                        return `Ø²Ù…Ø§Ù† Ø¨Ø§Ù‚ÛŒâ€ŒÙ…Ø§Ù†Ø¯Ù‡ Ø§Ø´ØªØ¨Ø§Ù‡: ${timeToExpiry} Ø«Ø§Ù†ÛŒÙ‡ (Ù…ÙˆØ±Ø¯ Ø§Ù†ØªØ¸Ø§Ø±: ~3600)`;
                    }
                    
                    // ØªÙˆÚ©Ù† Ù…Ù†Ù‚Ø¶ÛŒ Ø´Ø¯Ù‡
                    const expiredToken = jwt.generateToken('user-expired', {}, -0.1); // Ù…Ù†Ù‚Ø¶ÛŒ Ø´Ø¯Ù‡
                    const expiredTime = jwt.getTimeToExpiry(expiredToken);
                    
                    if (expiredTime !== 0) {
                        return `Ø²Ù…Ø§Ù† Ø¨Ø§Ù‚ÛŒâ€ŒÙ…Ø§Ù†Ø¯Ù‡ Ø¨Ø±Ø§ÛŒ ØªÙˆÚ©Ù† Ù…Ù†Ù‚Ø¶ÛŒ Ø´Ø¯Ù‡: ${expiredTime} (Ù…ÙˆØ±Ø¯ Ø§Ù†ØªØ¸Ø§Ø±: 0)`;
                    }
                    
                    return true;
                }
            },
            {
                name: 'Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ú©Ø§Ø±Ø¨Ø±',
                description: 'Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ú©Ø§Ø±Ø¨Ø± Ø¨Ø§ÛŒØ¯ Ø§Ø² ØªÙˆÚ©Ù† Ù‚Ø§Ø¨Ù„ Ø®ÙˆØ§Ù†Ø¯Ù† Ø¨Ø§Ø´Ø¯',
                fn: async () => {
                    const jwt = new JWTManager();
                    const token = jwt.generateToken('user-info', { 
                        level: 8, 
                        xp: 3000, 
                        role: 'premium',
                        name: 'ÙØ§Ø·Ù…Ù‡ Ù…Ø­Ù…Ø¯ÛŒ'
                    });
                    
                    const user = jwt.getUserFromToken(token);
                    
                    if (!user) {
                        return 'Ú©Ø§Ø±Ø¨Ø± Ø§Ø² ØªÙˆÚ©Ù† Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ù†Ø´Ø¯';
                    }
                    
                    // Ø¨Ø±Ø±Ø³ÛŒ ØªÙ…Ø§Ù… ÙÛŒÙ„Ø¯Ù‡Ø§
                    const checks = [
                        user.id === 'user-info',
                        user.level === 8,
                        user.xp === 3000,
                        user.role === 'premium',
                        user.issuedAt instanceof Date,
                        user.expiresAt instanceof Date,
                        user.expiresAt > user.issuedAt,
                        Math.abs((Date.now() - user.issuedAt.getTime())) < 5000 // Ø­Ø¯Ø§Ú©Ø«Ø± Ûµ Ø«Ø§Ù†ÛŒÙ‡ Ø§Ø®ØªÙ„Ø§Ù
                    ];
                    
                    const failedChecks = checks.map((c, i) => c ? null : i).filter(i => i !== null);
                    
                    if (failedChecks.length > 0) {
                        return `Ø¨Ø±Ø±Ø³ÛŒâ€ŒÙ‡Ø§ÛŒ ${failedChecks.join(',')} Ù†Ø§Ù…ÙˆÙÙ‚ Ø¨ÙˆØ¯Ù†Ø¯`;
                    }
                    
                    return true;
                }
            }
        ];

        // ==================== Test Runner ====================
        let passedTests = 0;
        let failedTests = 0;

        async function runTests() {
            const resultsDiv = document.getElementById('testResults');
            resultsDiv.innerHTML = '';
            passedTests = 0;
            failedTests = 0;

            for (let i = 0; i < tests.length; i++) {
                const test = tests[i];
                
                // Ø§ÛŒØ¬Ø§Ø¯ Ø§Ù„Ù…Ø§Ù† ØªØ³Øª
                const testDiv = document.createElement('div');
                testDiv.className = 'test pending';
                testDiv.id = `test-${i}`;
                
                const header = document.createElement('div');
                header.className = 'test-header';
                
                const name = document.createElement('div');
                name.className = 'test-name';
                name.textContent = `${i + 1}. ${test.name}`;
                
                const status = document.createElement('div');
                status.className = 'test-status status-pending';
                status.textContent = 'â³';
                
                header.appendChild(name);
                header.appendChild(status);
                testDiv.appendChild(header);
                
                resultsDiv.appendChild(testDiv);
                
                // Ø§Ø¬Ø±Ø§ÛŒ ØªØ³Øª
                try {
                    const result = await test.fn();
                    const success = result === true;
                    
                    if (success) {
                        testDiv.className = 'test pass';
                        status.className = 'test-status status-pass';
                        status.textContent = 'âœ…';
                        passedTests++;
                    } else {
                        testDiv.className = 'test fail';
                        status.className = 'test-status status-fail';
                        status.textContent = 'âŒ';
                        failedTests++;
                        
                        // Ø§Ø¶Ø§ÙÙ‡ Ú©Ø±Ø¯Ù† Ø¯Ú©Ù…Ù‡ Ù†Ù…Ø§ÛŒØ´ Ø¬Ø²Ø¦ÛŒØ§Øª
                        const toggleBtn = document.createElement('button');
                        toggleBtn.className = 'toggle-btn';
                        toggleBtn.textContent = 'Ù†Ù…Ø§ÛŒØ´ Ø®Ø·Ø§';
                        toggleBtn.onclick = () => {
                            const details = testDiv.querySelector('.test-details');
                            if (details) {
                                details.style.display = details.style.display === 'block' ? 'none' : 'block';
                                toggleBtn.textContent = details.style.display === 'block' ? 'Ù¾Ù†Ù‡Ø§Ù† Ú©Ø±Ø¯Ù†' : 'Ù†Ù…Ø§ÛŒØ´ Ø®Ø·Ø§';
                            }
                        };
                        testDiv.appendChild(toggleBtn);
                        
                        // Ø§Ø¶Ø§ÙÙ‡ Ú©Ø±Ø¯Ù† Ø¬Ø²Ø¦ÛŒØ§Øª Ø®Ø·Ø§
                        const details = document.createElement('div');
                        details.className = 'test-details';
                        details.textContent = `Ø®Ø·Ø§: ${result}\n\n${test.description}`;
                        testDiv.appendChild(details);
                    }
                    
                } catch (error) {
                    testDiv.className = 'test fail';
                    status.className = 'test-status status-fail';
                    status.textContent = 'âŒ';
                    failedTests++;
                    
                    const toggleBtn = document.createElement('button');
                    toggleBtn.className = 'toggle-btn';
                    toggleBtn.textContent = 'Ù†Ù…Ø§ÛŒØ´ Ø®Ø·Ø§';
                    toggleBtn.onclick = () => {
                        const details = testDiv.querySelector('.test-details');
                        if (details) {
                            details.style.display = details.style.display === 'block' ? 'none' : 'block';
                            toggleBtn.textContent = details.style.display === 'block' ? 'Ù¾Ù†Ù‡Ø§Ù† Ú©Ø±Ø¯Ù†' : 'Ù†Ù…Ø§ÛŒØ´ Ø®Ø·Ø§';
                        }
                    };
                    testDiv.appendChild(toggleBtn);
                    
                    const details = document.createElement('div');
                    details.className = 'test-details';
                    details.textContent = `Ø®Ø·Ø§ÛŒ ØºÛŒØ±Ù…Ù†ØªØ¸Ø±Ù‡: ${error.message}\n${error.stack}`;
                    testDiv.appendChild(details);
                }
                
                // Ø¢Ù¾Ø¯ÛŒØª Ø¢Ù…Ø§Ø±
                document.getElementById('passedTests').textContent = passedTests;
                document.getElementById('failedTests').textContent = failedTests;
                
                // ØªØ§Ø®ÛŒØ± Ú©ÙˆØªØ§Ù‡ Ø¨Ø±Ø§ÛŒ Ù†Ù…Ø§ÛŒØ´ Ø¨Ù‡ØªØ±
                await new Promise(resolve => setTimeout(resolve, 300));
            }
            
            // Ù†Ù…Ø§ÛŒØ´ Ù†ØªÛŒØ¬Ù‡ Ù†Ù‡Ø§ÛŒÛŒ
            const finalDiv = document.createElement('div');
            finalDiv.style.cssText = 'margin-top: 20px; padding: 15px; border-radius: 8px; text-align: center; font-weight: bold;';
            
            if (failedTests === 0) {
                finalDiv.style.background = '#10b981';
                finalDiv.style.color = 'white';
                finalDiv.textContent = `ğŸ‰ Ø¹Ø§Ù„ÛŒ! Ù‡Ù…Ù‡ ${passedTests} ØªØ³Øª Ù…ÙˆÙÙ‚ Ø¨ÙˆØ¯Ù†Ø¯!`;
            } else {
                finalDiv.style.background = '#ef4444';
                finalDiv.style.color = 'white';
                finalDiv.textContent = `âš ï¸ ${passedTests} Ù…ÙˆÙÙ‚ØŒ ${failedTests} Ù†Ø§Ù…ÙˆÙÙ‚`;
            }
            
            resultsDiv.appendChild(finalDiv);
        }

        // Ø¢Ù¾Ø¯ÛŒØª Ø¢Ù…Ø§Ø± Ø§ÙˆÙ„ÛŒÙ‡
        document.getElementById('totalTests').textContent = tests.length;
    </script>
</body>
</html>
