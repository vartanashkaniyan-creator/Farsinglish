<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.5, user-scalable=yes">
    <title>ØªØ³Øª Ø¯Ø³ØªÛŒ Ø¬Ø±ÛŒØ§Ù† Ø¯Ø±Ø³ - Farsinglish</title>
    <style>
        * {
            box-sizing: border-box;
            font-family: 'Tahoma', 'Vazir', 'Segoe UI', sans-serif;
        }
        body {
            margin: 0;
            padding: 15px;
            background: #f8fafc;
            color: #1e293b;
            line-height: 1.6;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            border-radius: 24px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.05);
            padding: 20px;
        }
        h1 {
            font-size: 1.8rem;
            margin-top: 0;
            margin-bottom: 8px;
            color: #0f172a;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        h1 span {
            background: #2563eb;
            color: white;
            font-size: 1rem;
            padding: 4px 12px;
            border-radius: 30px;
        }
        .badge {
            background: #e2e8f0;
            padding: 6px 14px;
            border-radius: 30px;
            font-size: 0.85rem;
            display: inline-block;
            margin-bottom: 20px;
        }
        .step-indicator {
            display: flex;
            justify-content: space-between;
            margin: 30px 0 20px;
            position: relative;
        }
        .step {
            flex: 1;
            text-align: center;
            padding: 10px 5px;
            background: #f1f5f9;
            margin: 0 3px;
            border-radius: 12px;
            font-weight: bold;
            color: #475569;
            border: 1px solid #cbd5e1;
        }
        .step.active {
            background: #2563eb;
            color: white;
            border-color: #1e40af;
        }
        .card {
            background: #ffffff;
            border: 1px solid #e2e8f0;
            border-radius: 20px;
            padding: 20px;
            margin-bottom: 25px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.02);
        }
        .lesson-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px dashed #cbd5e1;
            padding-bottom: 12px;
            margin-bottom: 16px;
        }
        .lesson-title {
            font-size: 1.3rem;
            font-weight: bold;
            color: #0f172a;
        }
        .progress-area {
            background: #f1f5f9;
            border-radius: 16px;
            padding: 15px;
            margin-top: 15px;
        }
        .btn {
            border: none;
            padding: 14px 22px;
            border-radius: 14px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.15s;
            margin: 6px 4px;
            border: 1px solid transparent;
        }
        .btn-primary {
            background: #2563eb;
            color: white;
            box-shadow: 0 4px 6px -2px rgba(37,99,235,0.3);
        }
        .btn-success {
            background: #16a34a;
            color: white;
        }
        .btn-warning {
            background: #ca8a04;
            color: white;
        }
        .btn-outline {
            background: white;
            border: 1px solid #94a3b8;
            color: #1e293b;
        }
        .btn:active {
            transform: scale(0.97);
        }
        .exercise-box {
            background: #fef9c3;
            border-right: 6px solid #eab308;
            padding: 18px;
            border-radius: 14px;
            margin: 20px 0;
            direction: ltr;
            text-align: left;
            font-size: 1.2rem;
        }
        .options-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            margin: 15px 0;
        }
        .option-item {
            background: white;
            border: 2px solid #e2e8f0;
            border-radius: 16px;
            padding: 14px;
            text-align: center;
            font-weight: 500;
            cursor: pointer;
            transition: 0.08s;
        }
        .option-item.selected {
            background: #2563eb;
            color: white;
            border-color: #1e40af;
        }
        .log-panel {
            background: #0f172a;
            color: #e2e8f0;
            border-radius: 16px;
            padding: 18px;
            font-family: 'Courier New', monospace;
            font-size: 0.85rem;
            margin-top: 25px;
            max-height: 280px;
            overflow-y: auto;
            direction: ltr;
            text-align: left;
        }
        .log-entry {
            border-bottom: 1px solid #334155;
            padding: 8px 0;
            color: #cbd5e1;
        }
        .flex-row {
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
            align-items: center;
        }
        .stat-item {
            background: #f8fafc;
            border-radius: 12px;
            padding: 10px 16px;
            border: 1px solid #e2e8f0;
            flex: 1 0 180px;
        }
        hr {
            border: none;
            border-top: 2px solid #e2e8f0;
            margin: 25px 0;
        }
        .footer-note {
            color: #64748b;
            font-size: 0.75rem;
            text-align: center;
            margin-top: 20px;
        }
    </style>
</head>
<body>
<div class="container">
    <h1>
        ğŸ“˜ Farsinglish
        <span>Ø¯Ø³ØªÛŒ</span>
    </h1>
    <div class="badge">ğŸ§ª ØªØ³Øª Ø¬Ø±ÛŒØ§Ù† Ú©Ø§Ù…Ù„ Ø¯Ø±Ø³ | Manual Flow Test</div>
    
    <!-- Ù†Ù…Ø§ÛŒØ´ Ú¯Ø§Ù…â€ŒÙ‡Ø§ -->
    <div class="step-indicator">
        <div class="step" id="step1">Û±. Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ</div>
        <div class="step" id="step2">Û². Ù†Ù…Ø§ÛŒØ´ Ø¯Ø±Ø³</div>
        <div class="step" id="step3">Û³. ØªÙ…Ø±ÛŒÙ†</div>
        <div class="step" id="step4">Û´. Ù¾Ø§Ø³Ø®</div>
        <div class="step" id="step5">Ûµ. SRS</div>
    </div>

    <!-- Ú©Ø§Ø±Øª Ø§ØµÙ„ÛŒ Ø¯Ø±Ø³ -->
    <div class="card" id="lessonCard">
        <div class="lesson-header">
            <span class="lesson-title" id="lessonName">Ø¯Ø±Ø³ Ù†Ù…ÙˆÙ†Ù‡: Ù…Ù‚Ø¯Ù…Ø§ØªÛŒ Û±</span>
            <span id="progressBadge" style="background: #dbeafe; padding: 6px 14px; border-radius: 30px; color: #1e40af;">ğŸ“Š Ù¾ÛŒØ´Ø±ÙØª Û°Ùª</span>
        </div>
        
        <!-- Ø¨Ø®Ø´ Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø³Ø§Ø®ØªÚ¯ÛŒ -->
        <div id="lessonContent">
            <p style="font-size: 1.1rem;">ğŸ“– ÙˆØ§Ú˜Ú¯Ø§Ù† Ø§ÛŒÙ† Ø¯Ø±Ø³:</p>
            <ul style="background: #f1f5f9; padding: 16px 30px; border-radius: 14px;">
                <li><strong>Apple</strong> - Ø³ÛŒØ¨</li>
                <li><strong>Cat</strong> - Ú¯Ø±Ø¨Ù‡</li>
                <li><strong>Run</strong> - Ø¯ÙˆÛŒØ¯Ù†</li>
                <li><strong>Blue</strong> - Ø¢Ø¨ÛŒ</li>
            </ul>
        </div>

        <!-- ÙˆØ¶Ø¹ÛŒØª SRS (Ù†Ù…Ø§ÛŒØ´ÛŒ) -->
        <div class="progress-area">
            <div style="display: flex; justify-content: space-between;">
                <span>ğŸ”„ ÙˆØ¶Ø¹ÛŒØª Ù…Ø±ÙˆØ±:</span>
                <span id="srsState">Ø¯Ø±Ø³ Ø¬Ø¯ÛŒØ¯ â€¢ Ø¨Ø¯ÙˆÙ† Ù…Ø±ÙˆØ± Ù‚Ø¨Ù„ÛŒ</span>
            </div>
            <div style="display: flex; justify-content: space-between; margin-top: 10px;">
                <span>âš¡ Ø¹Ø§Ù…Ù„ Ø³Ù‡ÙˆÙ„Øª:</span>
                <span id="easeFactorValue">Û².ÛµÛ°</span>
            </div>
            <div style="display: flex; justify-content: space-between;">
                <span>ğŸ“… ÙØ§ØµÙ„Ù‡ Ù…Ø±ÙˆØ±:</span>
                <span id="intervalValue">Û± Ø±ÙˆØ²</span>
            </div>
        </div>
    </div>

    <!-- Ø¨Ø®Ø´ ØªÙ…Ø±ÛŒÙ† ÙØ¹Ø§Ù„ -->
    <div class="card" style="background: #f0f9ff; border: 1px solid #bae6fd;">
        <h3 style="margin-top: 0; display: flex; gap: 10px;">âœï¸ ØªÙ…Ø±ÛŒÙ† ÙØ¹Ø§Ù„</h3>
        <div id="exerciseArea">
            <div class="exercise-box" id="questionText">
                Ù…Ø¹Ù†ÛŒ Ú©Ù„Ù…Ù‡ 'Apple' Ú†ÛŒØ³ØªØŸ
            </div>
            <div class="options-grid" id="optionsContainer">
                <div class="option-item" onclick="selectOption(this, 'Ø³ÛŒØ¨')">Ø³ÛŒØ¨</div>
                <div class="option-item" onclick="selectOption(this, 'Ù¾Ø±ØªÙ‚Ø§Ù„')">Ù¾Ø±ØªÙ‚Ø§Ù„</div>
                <div class="option-item" onclick="selectOption(this, 'Ù…ÙˆØ²')">Ù…ÙˆØ²</div>
                <div class="option-item" onclick="selectOption(this, 'Ø§Ù†Ú¯ÙˆØ±')">Ø§Ù†Ú¯ÙˆØ±</div>
            </div>
            <div style="display: flex; gap: 12px; margin-top: 20px;">
                <button class="btn btn-success" id="checkAnswerBtn" onclick="checkAnswer()" disabled>âœ… Ø¨Ø±Ø±Ø³ÛŒ Ù¾Ø§Ø³Ø®</button>
                <button class="btn btn-outline" onclick="nextExercise()">â© ØªÙ…Ø±ÛŒÙ† Ø¨Ø¹Ø¯ÛŒ</button>
            </div>
            <p id="feedbackMessage" style="font-size: 0.95rem; margin-top: 12px; padding: 8px; border-radius: 8px;"></p>
        </div>
    </div>

    <!-- Ú©Ù†ØªØ±Ù„â€ŒÙ‡Ø§ÛŒ Ø¯Ø³ØªÛŒ ØªØ³ØªØ± -->
    <div class="card" style="background: #fefce8;">
        <h3 style="margin-top: 0;">ğŸ§ª Ø§Ø¨Ø²Ø§Ø±Ù‡Ø§ÛŒ ØªØ³Øª Ø¯Ø³ØªÛŒ</h3>
        <div class="flex-row">
            <button class="btn btn-outline" onclick="loadSampleLesson()">ğŸ“‚ Û±. Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø¯Ø±Ø³</button>
            <button class="btn btn-outline" onclick="startExercise()">ğŸ” Û². Ø´Ø±ÙˆØ¹ ØªÙ…Ø±ÛŒÙ†</button>
            <button class="btn btn-warning" onclick="simulateAnswer(5)">â­ Û³. Ù¾Ø§Ø³Ø® Ø¹Ø§Ù„ÛŒ (Ú©ÛŒÙÛŒØª Ûµ)</button>
            <button class="btn btn-warning" onclick="simulateAnswer(2)">âš ï¸ Ù¾Ø§Ø³Ø® Ø¶Ø¹ÛŒÙ (Ú©ÛŒÙÛŒØª Û²)</button>
            <button class="btn btn-primary" onclick="saveProgress()">ğŸ’¾ Û´. Ø°Ø®ÛŒØ±Ù‡ Ù¾ÛŒØ´Ø±ÙØª</button>
            <button class="btn btn-success" onclick="resetTest()">ğŸ”„ Ø±ÛŒØ³Øª Ú©Ø§Ù…Ù„</button>
        </div>
        <p style="margin-bottom: 0; color: #713f12; font-size: 0.9rem; margin-top: 15px;">
            âš¡ ØªØ³Øª Ø¯Ø³ØªÛŒ: Ù…Ø±Ø§Ø­Ù„ Ø±Ø§ Ø¨Ù‡ ØªØ±ØªÛŒØ¨ Ø§Ù†Ø¬Ø§Ù… Ø¯Ù‡ÛŒØ¯ Ùˆ Ø®Ø±ÙˆØ¬ÛŒ Ø±Ø§ Ø¯Ø± Ù„Ø§Ú¯ Ù¾Ø§ÛŒÛŒÙ† Ø¨Ø±Ø±Ø³ÛŒ Ú©Ù†ÛŒØ¯.
        </p>
    </div>

    <!-- Ù¾Ù†Ù„ Ù„Ø§Ú¯ Ø±ÙˆÛŒØ¯Ø§Ø¯Ù‡Ø§ -->
    <div class="log-panel" id="logPanel">
        <div style="color: #facc15; margin-bottom: 10px;">ğŸ“‹ Ú©Ù†Ø³ÙˆÙ„ Ù…Ø¬Ø§Ø²ÛŒ (Virtual Console)</div>
        <div id="logContent">
            <div class="log-entry">â±ï¸ Ø¢Ù…Ø§Ø¯Ù‡â€ŒØ³Ø§Ø²ÛŒ ØªØ³Øª Ø¬Ø±ÛŒØ§Ù† Ø¯Ø±Ø³...</div>
        </div>
    </div>

    <!-- ÙˆØ¶Ø¹ÛŒØª Ø°Ø®ÛŒØ±Ù‡â€ŒØ´Ø¯Ù‡ -->
    <div style="display: flex; justify-content: space-between; flex-wrap: wrap; margin-top: 15px;">
        <div class="stat-item"><strong>ğŸ”¢ ØªÚ©Ø±Ø§Ø±:</strong> <span id="statReps">Û°</span></div>
        <div class="stat-item"><strong>ğŸ¯ EF:</strong> <span id="statEF">Û².ÛµÛ°</span></div>
        <div class="stat-item"><strong>ğŸ“† ÙØ§ØµÙ„Ù‡:</strong> <span id="statInterval">Û±</span> Ø±ÙˆØ²</div>
        <div class="stat-item"><strong>âœ… Ù¾Ø§Ø³Ø®â€ŒÙ‡Ø§:</strong> <span id="statCorrect">Û°</span></div>
    </div>
    <hr>
    <div class="footer-note">
        ğŸ§ª ØªÙ…Ø§Ù…ÛŒ Ø¹Ù…Ù„ÛŒØ§Øª Ø¨Ù‡â€ŒØµÙˆØ±Øª Ø¯Ø³ØªÛŒ Ùˆ Ø´Ø¨ÛŒÙ‡â€ŒØ³Ø§Ø²ÛŒ Ù…ÛŒâ€ŒØ´ÙˆØ¯. Ø§ÛŒÙ† ÙØ§ÛŒÙ„ Ù…Ø®ØµÙˆØµ ØªØ³Øª Ø¬Ø±ÛŒØ§Ù† Ú©Ø§Ø±Ø¨Ø± Ø¯Ø± Ù…Ø±ÙˆØ±Ú¯Ø± Ù…ÙˆØ¨Ø§ÛŒÙ„ Ø§Ø³Øª.
    </div>
</div>

<script>
    // -------------------- Ø­Ø§Ù„Øª Ø§Ù¾Ù„ÛŒÚ©ÛŒØ´Ù† (Ø´Ø¨ÛŒÙ‡â€ŒØ³Ø§Ø²ÛŒ) --------------------
    const AppState = {
        lessonLoaded: false,
        currentLesson: {
            id: 'L001',
            title: 'Ù…Ù‚Ø¯Ù…Ø§ØªÛŒ Û± - Ø­ÛŒÙˆØ§Ù†Ø§Øª Ùˆ Ø§Ø´ÛŒØ§',
            vocabulary: [
                { word: 'Apple', meaning: 'Ø³ÛŒØ¨', correct: 'Ø³ÛŒØ¨' },
                { word: 'Cat', meaning: 'Ú¯Ø±Ø¨Ù‡', correct: 'Ú¯Ø±Ø¨Ù‡' },
                { word: 'Run', meaning: 'Ø¯ÙˆÛŒØ¯Ù†', correct: 'Ø¯ÙˆÛŒØ¯Ù†' },
                { word: 'Blue', meaning: 'Ø¢Ø¨ÛŒ', correct: 'Ø¢Ø¨ÛŒ' }
            ]
        },
        progress: {
            lessonId: 'L001',
            repetitions: 0,
            easeFactor: 2.5,
            interval: 1,
            nextReview: null,
            correctCount: 0,
            totalAttempts: 0
        },
        currentExercise: {
            vocabIndex: 0,
            question: 'Ù…Ø¹Ù†ÛŒ Ú©Ù„Ù…Ù‡ \'Apple\' Ú†ÛŒØ³ØªØŸ',
            options: ['Ø³ÛŒØ¨', 'Ù¾Ø±ØªÙ‚Ø§Ù„', 'Ù…ÙˆØ²', 'Ø§Ù†Ú¯ÙˆØ±'],
            correctAnswer: 'Ø³ÛŒØ¨',
            selected: null
        },
        selectedOptionElement: null
    };

    // -------------------- Ø§Ø¨Ø²Ø§Ø± Ù„Ø§Ú¯ --------------------
    const VirtualLog = {
        log: function(message, type = 'info') {
            const logDiv = document.getElementById('logContent');
            const entry = document.createElement('div');
            entry.className = 'log-entry';
            const time = new Date().toLocaleTimeString('fa-IR', { hour12: false, hour: '2-digit', minute: '2-digit', second: '2-digit' });
            let icon = 'ğŸ“Œ';
            if (type === 'success') icon = 'âœ…';
            if (type === 'error') icon = 'âŒ';
            if (type === 'warning') icon = 'âš ï¸';
            if (type === 'step') icon = 'ğŸš€';
            entry.innerHTML = `${icon} [${time}] ${message}`;
            logDiv.appendChild(entry);
            logDiv.scrollTop = logDiv.scrollHeight;
        },
        clear: function() {
            document.getElementById('logContent').innerHTML = '<div class="log-entry">â±ï¸ Ù„Ø§Ú¯ Ù¾Ø§Ú© Ø´Ø¯. Ø¯ÙˆØ¨Ø§Ø±Ù‡ Ø´Ø±ÙˆØ¹ Ú©Ù†ÛŒØ¯...</div>';
            this.log('ØªØ³Øª Ø¯Ø³ØªÛŒ Ø¬Ø±ÛŒØ§Ù† Ø¯Ø±Ø³ Ø¢ØºØ§Ø² Ø´Ø¯', 'step');
        }
    };

    // -------------------- ØªÙˆØ§Ø¨Ø¹ Ø§ØµÙ„ÛŒ --------------------
    function loadSampleLesson() {
        AppState.lessonLoaded = true;
        AppState.progress = {
            lessonId: 'L001',
            repetitions: 0,
            easeFactor: 2.5,
            interval: 1,
            nextReview: null,
            correctCount: 0,
            totalAttempts: 0
        };
        document.getElementById('lessonName').innerText = AppState.currentLesson.title;
        document.getElementById('progressBadge').innerHTML = 'ğŸ“Š Ù¾ÛŒØ´Ø±ÙØª Û°Ùª';
        document.getElementById('srsState').innerText = 'Ø¯Ø±Ø³ Ø¬Ø¯ÛŒØ¯ â€¢ Ø¢Ù…Ø§Ø¯Ù‡ Ù…Ø±ÙˆØ±';
        document.getElementById('easeFactorValue').innerText = AppState.progress.easeFactor.toFixed(2);
        document.getElementById('intervalValue').innerText = AppState.progress.interval + ' Ø±ÙˆØ²';
        updateStatsUI();
        
        // ÙØ¹Ø§Ù„â€ŒØ³Ø§Ø²ÛŒ Ú¯Ø§Ù…
        document.querySelectorAll('.step').forEach(s => s.classList.remove('active'));
        document.getElementById('step1').classList.add('active');
        
        VirtualLog.log('Ø¯Ø±Ø³ Ù†Ù…ÙˆÙ†Ù‡ Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø´Ø¯: ' + AppState.currentLesson.title, 'success');
    }

    function startExercise() {
        if (!AppState.lessonLoaded) {
            VirtualLog.log('Ø§Ø¨ØªØ¯Ø§ Ø¯Ø±Ø³ Ø±Ø§ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ú©Ù†ÛŒØ¯!', 'error');
            alert('Ù„Ø·ÙØ§Ù‹ Ø§Ø¨ØªØ¯Ø§ Ø¯Ú©Ù…Ù‡ "Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø¯Ø±Ø³" Ø±Ø§ Ø¨Ø²Ù†ÛŒØ¯.');
            return;
        }
        // Ø§Ù†ØªØ®Ø§Ø¨ Ø§ÙˆÙ„ÛŒÙ† ÙˆØ§Ú˜Ù‡
        AppState.currentExercise.vocabIndex = 0;
        const vocab = AppState.currentLesson.vocabulary[0];
        AppState.currentExercise.question = `Ù…Ø¹Ù†ÛŒ Ú©Ù„Ù…Ù‡ '${vocab.word}' Ú†ÛŒØ³ØªØŸ`;
        AppState.currentExercise.correctAnswer = vocab.correct;
        AppState.currentExercise.options = [vocab.correct, 'Ù¾Ø±ØªÙ‚Ø§Ù„', 'Ù…ÙˆØ²', 'Ø§Ù†Ú¯ÙˆØ±'].sort(() => Math.random() - 0.5);
        AppState.currentExercise.selected = null;
        
        // Ø±Ù†Ø¯Ø± Ø³ÙˆØ§Ù„
        document.getElementById('questionText').innerText = AppState.currentExercise.question;
        const optsDiv = document.getElementById('optionsContainer');
        optsDiv.innerHTML = '';
        AppState.currentExercise.options.forEach(opt => {
            const div = document.createElement('div');
            div.className = 'option-item';
            div.innerText = opt;
            div.onclick = function() { selectOption(this, opt); };
            optsDiv.appendChild(div);
        });
        
        document.getElementById('checkAnswerBtn').disabled = true;
        document.getElementById('feedbackMessage').innerHTML = '';
        document.querySelectorAll('.step').forEach(s => s.classList.remove('active'));
        document.getElementById('step2').classList.add('active');
        document.getElementById('step3').classList.add('active');
        
        VirtualLog.log('ØªÙ…Ø±ÛŒÙ† Ø¬Ø¯ÛŒØ¯ Ø³Ø§Ø®ØªÙ‡ Ø´Ø¯: ' + vocab.word, 'info');
    }

    // Ø§Ù†ØªØ®Ø§Ø¨ Ú¯Ø²ÛŒÙ†Ù‡
    window.selectOption = function(element, value) {
        if (AppState.currentExercise.selected === value) {
            element.classList.remove('selected');
            AppState.currentExercise.selected = null;
            document.getElementById('checkAnswerBtn').disabled = true;
        } else {
            // Ù¾Ø§Ú© Ú©Ø±Ø¯Ù† Ø§Ù†ØªØ®Ø§Ø¨ Ù‚Ø¨Ù„ÛŒ
            document.querySelectorAll('.option-item').forEach(el => el.classList.remove('selected'));
            element.classList.add('selected');
            AppState.currentExercise.selected = value;
            document.getElementById('checkAnswerBtn').disabled = false;
        }
    };

    // Ø¨Ø±Ø±Ø³ÛŒ Ù¾Ø§Ø³Ø®
    window.checkAnswer = function() {
        if (!AppState.currentExercise.selected) {
            VirtualLog.log('Ù„Ø·ÙØ§Ù‹ ÛŒÚ© Ú¯Ø²ÛŒÙ†Ù‡ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯', 'warning');
            return;
        }
        const isCorrect = (AppState.currentExercise.selected === AppState.currentExercise.correctAnswer);
        const feedback = document.getElementById('feedbackMessage');
        
        if (isCorrect) {
            feedback.innerHTML = 'âœ… Ù¾Ø§Ø³Ø® Ø¯Ø±Ø³Øª! Ø¢ÙØ±ÛŒÙ†.';
            feedback.style.background = '#dcfce7';
            feedback.style.color = '#166534';
            VirtualLog.log(`Ù¾Ø§Ø³Ø® ØµØ­ÛŒØ­: ${AppState.currentExercise.selected}`, 'success');
            AppState.progress.correctCount += 1;
            // Ø´Ø¨ÛŒÙ‡â€ŒØ³Ø§Ø²ÛŒ Ú©ÛŒÙÛŒØª Ù¾Ø§Ø³Ø® Ø®ÙˆØ¨ (4)
            simulateAnswerQuality(4);
        } else {
            feedback.innerHTML = `âŒ Ù¾Ø§Ø³Ø® Ù†Ø§Ø¯Ø±Ø³Øª. Ú¯Ø²ÛŒÙ†Ù‡ ØµØ­ÛŒØ­: ${AppState.currentExercise.correctAnswer}`;
            feedback.style.background = '#fee2e2';
            feedback.style.color = '#991b1b';
            VirtualLog.log(`Ù¾Ø§Ø³Ø® Ù†Ø§Ø¯Ø±Ø³Øª: Ø§Ù†ØªØ®Ø§Ø¨ ${AppState.currentExercise.selected}ØŒ ØµØ­ÛŒØ­: ${AppState.currentExercise.correctAnswer}`, 'error');
            AppState.progress.totalAttempts += 1;
            // Ú©ÛŒÙÛŒØª Ù¾Ø§ÛŒÛŒÙ†
            simulateAnswerQuality(2);
        }
        document.getElementById('checkAnswerBtn').disabled = true;
        AppState.progress.totalAttempts += 1;
        updateStatsUI();
        document.getElementById('step4').classList.add('active');
    };

    // Ø´Ø¨ÛŒÙ‡â€ŒØ³Ø§Ø²ÛŒ Ù¾Ø§Ø³Ø® Ø¨Ø§ Ú©ÛŒÙÛŒØª Ù…Ø¹ÛŒÙ†
    function simulateAnswerQuality(quality) {
        // Ø§Ù„Ú¯ÙˆØ±ÛŒØªÙ… Ø³Ø§Ø¯Ù‡ SRS (SM-2)
        let { repetitions, easeFactor, interval } = AppState.progress;
        if (quality < 3) {
            interval = 1;
            repetitions = 0;
            easeFactor = Math.max(1.3, easeFactor - 0.2);
        } else {
            if (repetitions === 0) interval = 1;
            else if (repetitions === 1) interval = 6;
            else interval = Math.round(interval * easeFactor);
            repetitions += 1;
            easeFactor = easeFactor + (0.1 - (5 - quality) * (0.08 + (5 - quality) * 0.02));
            easeFactor = Math.min(3.0, Math.max(1.3, easeFactor));
        }
        AppState.progress.interval = interval;
        AppState.progress.repetitions = repetitions;
        AppState.progress.easeFactor = easeFactor;
        
        // Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ UI
        document.getElementById('easeFactorValue').innerText = easeFactor.toFixed(2);
        document.getElementById('intervalValue').innerText = interval + ' Ø±ÙˆØ²';
        document.getElementById('srsState').innerText = repetitions + ' ØªÚ©Ø±Ø§Ø± | ÙØ§ØµÙ„Ù‡ ' + interval + ' Ø±ÙˆØ²';
        
        VirtualLog.log(`SRS: Ú©ÛŒÙÛŒØª=${quality}, ØªÚ©Ø±Ø§Ø±=${repetitions}, EF=${easeFactor.toFixed(2)}, ÙØ§ØµÙ„Ù‡=${interval}`, 'info');
        document.getElementById('step5').classList.add('active');
    }

    // Ù¾Ø§Ø³Ø® Ø³Ø±ÛŒØ¹ Ø¹Ø§Ù„ÛŒ/Ø¶Ø¹ÛŒÙ
    window.simulateAnswer = function(quality) {
        if (!AppState.lessonLoaded) { alert('Ø§Ø¨ØªØ¯Ø§ Ø¯Ø±Ø³ Ø±Ø§ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ú©Ù†ÛŒØ¯'); return; }
        simulateAnswerQuality(quality);
        AppState.progress.correctCount += (quality >= 3 ? 1 : 0);
        updateStatsUI();
        VirtualLog.log(`Ø´Ø¨ÛŒÙ‡â€ŒØ³Ø§Ø²ÛŒ Ù¾Ø§Ø³Ø® Ø¨Ø§ Ú©ÛŒÙØª ${quality}`, 'warning');
    };

    // Ø°Ø®ÛŒØ±Ù‡ Ù¾ÛŒØ´Ø±ÙØª (Ù†Ù…Ø§ÛŒØ´ÛŒ)
    window.saveProgress = function() {
        VirtualLog.log('Ù¾ÛŒØ´Ø±ÙØª Ø¯Ø±Ø³ Ø¯Ø± IndexedDB (Ø´Ø¨ÛŒÙ‡â€ŒØ³Ø§Ø²) Ø°Ø®ÛŒØ±Ù‡ Ø´Ø¯.', 'success');
        VirtualLog.log(`EF: ${AppState.progress.easeFactor.toFixed(2)}, ØªÚ©Ø±Ø§Ø±: ${AppState.progress.repetitions}, ÙØ§ØµÙ„Ù‡: ${AppState.progress.interval}`, 'info');
        alert('Ù¾ÛŒØ´Ø±ÙØª Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø¯Ø± Ø­Ø§ÙØ¸Ù‡ Ù…Ø¬Ø§Ø²ÛŒ Ø°Ø®ÛŒØ±Ù‡ Ø´Ø¯.');
    };

    // ØªÙ…Ø±ÛŒÙ† Ø¨Ø¹Ø¯ÛŒ
    window.nextExercise = function() {
        let nextIdx = AppState.currentExercise.vocabIndex + 1;
        if (nextIdx >= AppState.currentLesson.vocabulary.length) {
            VirtualLog.log('ØªÙ…Ø§Ù… ÙˆØ§Ú˜Ú¯Ø§Ù† Ø§ÛŒÙ† Ø¯Ø±Ø³ ØªÙ…Ø±ÛŒÙ† Ø´Ø¯Ù†Ø¯!', 'info');
            alert('Ø¨Ù‡ Ù¾Ø§ÛŒØ§Ù† ÙˆØ§Ú˜Ú¯Ø§Ù† Ø¯Ø±Ø³ Ø±Ø³ÛŒØ¯ÛŒØ¯.');
            return;
        }
        AppState.currentExercise.vocabIndex = nextIdx;
        const vocab = AppState.currentLesson.vocabulary[nextIdx];
        AppState.currentExercise.question = `Ù…Ø¹Ù†ÛŒ Ú©Ù„Ù…Ù‡ '${vocab.word}' Ú†ÛŒØ³ØªØŸ`;
        AppState.currentExercise.correctAnswer = vocab.correct;
        AppState.currentExercise.options = [vocab.correct, 'Ù¾Ø±ØªÙ‚Ø§Ù„', 'Ù…ÙˆØ²', 'Ø§Ù†Ú¯ÙˆØ±'].sort(() => Math.random() - 0.5);
        AppState.currentExercise.selected = null;
        
        document.getElementById('questionText').innerText = AppState.currentExercise.question;
        const optsDiv = document.getElementById('optionsContainer');
        optsDiv.innerHTML = '';
        AppState.currentExercise.options.forEach(opt => {
            const div = document.createElement('div');
            div.className = 'option-item';
            div.innerText = opt;
            div.onclick = function() { selectOption(this, opt); };
            optsDiv.appendChild(div);
        });
        document.getElementById('checkAnswerBtn').disabled = true;
        document.getElementById('feedbackMessage').innerHTML = '';
        VirtualLog.log('Ø±ÙØªÙ† Ø¨Ù‡ ØªÙ…Ø±ÛŒÙ† Ø¨Ø¹Ø¯ÛŒ: ' + vocab.word, 'info');
    };

    // Ø±ÛŒØ³Øª
    window.resetTest = function() {
        AppState.lessonLoaded = false;
        AppState.progress = {
            lessonId: 'L001',
            repetitions: 0,
            easeFactor: 2.5,
            interval: 1,
            nextReview: null,
            correctCount: 0,
            totalAttempts: 0
        };
        updateStatsUI();
        document.getElementById('lessonName').innerText = 'Ø¯Ø±Ø³ Ù†Ù…ÙˆÙ†Ù‡: Ù…Ù‚Ø¯Ù…Ø§ØªÛŒ Û±';
        document.getElementById('progressBadge').innerHTML = 'ğŸ“Š Ù¾ÛŒØ´Ø±ÙØª Û°Ùª';
        document.getElementById('srsState').innerText = 'Ø¯Ø±Ø³ Ø¬Ø¯ÛŒØ¯ â€¢ Ø¨Ø¯ÙˆÙ† Ù…Ø±ÙˆØ± Ù‚Ø¨Ù„ÛŒ';
        document.getElementById('easeFactorValue').innerText = 'Û².ÛµÛ°';
        document.getElementById('intervalValue').innerText = 'Û± Ø±ÙˆØ²';
        document.querySelectorAll('.step').forEach(s => s.classList.remove('active'));
        VirtualLog.clear();
        VirtualLog.log('ØªØ³Øª Ø¨Ù‡ Ø­Ø§Ù„Øª Ø§ÙˆÙ„ÛŒÙ‡ Ø¨Ø±Ú¯Ø±Ø¯Ø§Ù†Ø¯Ù‡ Ø´Ø¯.', 'step');
    };

    function updateStatsUI() {
        document.getElementById('statReps').innerText = AppState.progress.repetitions;
        document.getElementById('statEF').innerText = AppState.progress.easeFactor.toFixed(2);
        document.getElementById('statInterval').innerText = AppState.progress.interval;
        document.getElementById('statCorrect').innerText = AppState.progress.correctCount;
        
        let percent = Math.min(100, Math.floor((AppState.progress.correctCount / 4) * 100));
        document.getElementById('progressBadge').innerHTML = `ğŸ“Š Ù¾ÛŒØ´Ø±ÙØª ${percent}Ùª`;
    }

    // Ù…Ù‚Ø¯Ø§Ø±Ø¯Ù‡ÛŒ Ø§ÙˆÙ„ÛŒÙ‡
    window.onload = function() {
        VirtualLog.clear();
        VirtualLog.log('âœ… ÙØ§ÛŒÙ„ ØªØ³Øª Ø¯Ø³ØªÛŒ Ø¬Ø±ÛŒØ§Ù† Ø¯Ø±Ø³ Ø¢Ù…Ø§Ø¯Ù‡ Ø§Ø³Øª. Ù…Ø±Ø§Ø­Ù„ Ø±Ø§ Ú¯Ø§Ù…â€ŒØ¨Ù‡â€ŒÚ¯Ø§Ù… Ø§Ù†Ø¬Ø§Ù… Ø¯Ù‡ÛŒØ¯.', 'step');
    };
</script>
</body>
</html>
