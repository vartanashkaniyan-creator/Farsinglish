<!DOCTYPE html>
<html lang="fa">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ØªØ³Øª Unit: Ù…ÙˆØªÙˆØ± SRS (SM-2)</title>
    <style>
        body { font-family: system-ui, sans-serif; max-width: 800px; margin: 0 auto; padding: 20px; background: #f5f5f5; }
        .test { background: white; padding: 15px; margin: 10px 0; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .pass { background: #e8f5e9; border-right: 6px solid #4caf50; }
        .fail { background: #ffebee; border-right: 6px solid #f44336; }
        h1 { color: #2c3e50; font-size: 1.5rem; }
        .summary { background: #2c3e50; color: white; padding: 15px; border-radius: 8px; margin-bottom: 20px; }
        pre { background: #f8f9fa; padding: 10px; border-radius: 4px; overflow-x: auto; font-size: 12px; }
    </style>
</head>
<body>
    <h1>ğŸ§  ØªØ³Øª Unit: Ù…ÙˆØªÙˆØ± SRS (Ø§Ù„Ú¯ÙˆØ±ÛŒØªÙ… SM-2)</h1>
    <div id="summary" class="summary">Ø¯Ø± Ø­Ø§Ù„ Ø§Ø¬Ø±Ø§ÛŒ ØªØ³Øªâ€ŒÙ‡Ø§...</div>
    <div id="results"></div>

    <script>
        // ------------------------------------------------------------
        // srs-engine.js - Ù‡Ø³ØªÙ‡ Ø§Ù„Ú¯ÙˆØ±ÛŒØªÙ… SM-2 Ø¨Ø±Ø§ÛŒ Ù…Ø±ÙˆØ± Ù‡ÙˆØ´Ù…Ù†Ø¯
        // ------------------------------------------------------------
        const SRS = {
            // Ù…Ø­Ø§Ø³Ø¨Ù‡ ÙØ§ØµÙ„Ù‡ Ù…Ø±ÙˆØ± Ø¨Ø¹Ø¯ÛŒ Ø¨Ø± Ø§Ø³Ø§Ø³ SM-2
            calculateNextReview: function(easeFactor, repetitions, quality) {
                if (quality < 0 || quality > 5) throw new Error('Ú©ÛŒÙÛŒØª Ø¨Ø§ÛŒØ¯ Ø¨ÛŒÙ† Û° ØªØ§ Ûµ Ø¨Ø§Ø´Ø¯');
                
                // Ú©ÛŒÙÛŒØª Ú©Ù…ØªØ± Ø§Ø² Û³ => Ø´Ú©Ø³Øª Ø®ÙˆØ±Ø¯Ù‡
                if (quality < 3) {
                    return {
                        interval: 1,
                        repetitions: 0,
                        easeFactor: Math.max(1.3, easeFactor - 0.2)
                    };
                }

                // Ù…Ø­Ø§Ø³Ø¨Ù‡ ÙØ§ØµÙ„Ù‡
                let interval;
                if (repetitions === 0) interval = 1;
                else if (repetitions === 1) interval = 6;
                else interval = Math.round((repetitions - 1) * easeFactor);

                // Ù…Ø­Ø§Ø³Ø¨Ù‡ Ø¹Ø§Ù…Ù„ Ø³Ù‡ÙˆÙ„Øª Ø¬Ø¯ÛŒØ¯
                let newEase = easeFactor + (0.1 - (5 - quality) * (0.08 + (5 - quality) * 0.02));
                newEase = Math.max(1.3, Math.min(2.5, newEase));

                return {
                    interval: interval,
                    repetitions: repetitions + 1,
                    easeFactor: newEase
                };
            },

            // ØªØ¹ÛŒÛŒÙ† Ø§ÛŒÙ†Ú©Ù‡ Ú©Ø§Ø±Øª Ø§Ù…Ø±ÙˆØ² Ù†ÛŒØ§Ø² Ø¨Ù‡ Ù…Ø±ÙˆØ± Ø¯Ø§Ø±Ø¯ØŸ
            isDue: function(lastReviewDate, intervalDays) {
                if (!lastReviewDate) return true;
                const now = new Date();
                const last = new Date(lastReviewDate);
                const diffDays = Math.floor((now - last) / (1000 * 60 * 60 * 24));
                return diffDays >= intervalDays;
            },

            // Ù…Ø­Ø§Ø³Ø¨Ù‡ Ù†Ù…Ø±Ù‡ Ø¨Ø± Ø§Ø³Ø§Ø³ Ø¯Ø±ØµØ¯ ØµØ­Øª
            calculateQuality: function(correctPercentage) {
                if (correctPercentage >= 95) return 5;
                if (correctPercentage >= 80) return 4;
                if (correctPercentage >= 60) return 3;
                if (correctPercentage >= 40) return 2;
                if (correctPercentage >= 20) return 1;
                return 0;
            },

            // Ø§ÙˆÙ„ÙˆÛŒØªâ€ŒØ¨Ù†Ø¯ÛŒ Ú©Ø§Ø±Øªâ€ŒÙ‡Ø§ÛŒ Ù‚Ø§Ø¨Ù„ Ù…Ø±ÙˆØ±
            prioritizeReviews: function(cards) {
                return [...cards].sort((a, b) => {
                    // Ø§ÙˆÙ„ÙˆÛŒØª: 1. Ú©Ø§Ø±Øªâ€ŒÙ‡Ø§ÛŒ Ø¬Ø¯ÛŒØ¯ (Ø¨Ø¯ÙˆÙ† Ù…Ø±ÙˆØ±) 2. Ú©Ø§Ø±Øªâ€ŒÙ‡Ø§ÛŒ Ø¨Ø§ ÙØ§ØµÙ„Ù‡ Ú©Ù…â€ŒØªØ±
                    if (!a.lastReviewDate && !b.lastReviewDate) return 0;
                    if (!a.lastReviewDate) return -1;
                    if (!b.lastReviewDate) return 1;
                    return (a.interval || 0) - (b.interval || 0);
                });
            }
        };

        // ------------------------------------------------------------
        // ØªØ³Øªâ€ŒÙ‡Ø§ÛŒ ÙˆØ§Ø­Ø¯ (Unit Tests)
        // ------------------------------------------------------------
        const tests = [
            {
                name: 'ØªØ³Øª Û±: Ù¾Ø§Ø³Ø® Ø¹Ø§Ù„ÛŒ (Ú©ÛŒÙÛŒØª Ûµ) - Ø¨Ø§Ø± Ø§ÙˆÙ„',
                fn: () => {
                    const result = SRS.calculateNextReview(2.5, 0, 5);
                    return result.interval === 1 && 
                           result.repetitions === 1 && 
                           Math.abs(result.easeFactor - 2.5) < 0.01;
                }
            },
            {
                name: 'ØªØ³Øª Û²: Ù¾Ø§Ø³Ø® Ø®ÙˆØ¨ (Ú©ÛŒÙÛŒØª Û´) - Ø¨Ø§Ø± Ø¯ÙˆÙ…',
                fn: () => {
                    const result = SRS.calculateNextReview(2.5, 1, 4);
                    return result.interval === 6 && 
                           result.repetitions === 2 && 
                           result.easeFactor > 2.3 && result.easeFactor < 2.5;
                }
            },
            {
                name: 'ØªØ³Øª Û³: Ù¾Ø§Ø³Ø® Ø¶Ø¹ÛŒÙ (Ú©ÛŒÙÛŒØª Û²) - Ú©Ø§Ù‡Ø´ EF',
                fn: () => {
                    const result = SRS.calculateNextReview(2.5, 2, 2);
                    return result.interval === 1 && 
                           result.repetitions === 0 && 
                           result.easeFactor < 2.5 && result.easeFactor > 1.3;
                }
            },
            {
                name: 'ØªØ³Øª Û´: Ø­Ø¯Ø§Ù‚Ù„ EF (Û±.Û³) - Ù†Ø¨Ø§ÛŒØ¯ Ú©Ù…â€ŒØªØ± Ø´ÙˆØ¯',
                fn: () => {
                    const result = SRS.calculateNextReview(1.3, 5, 2);
                    return result.easeFactor === 1.3;
                }
            },
            {
                name: 'ØªØ³Øª Ûµ: Ø­Ø¯Ø§Ú©Ø«Ø± EF (Û².Ûµ) - Ù†Ø¨Ø§ÛŒØ¯ Ø¨ÛŒØ´â€ŒØªØ± Ø´ÙˆØ¯',
                fn: () => {
                    const result = SRS.calculateNextReview(2.5, 5, 5);
                    return result.easeFactor <= 2.5;
                }
            },
            {
                name: 'ØªØ³Øª Û¶: Ù…Ø­Ø§Ø³Ø¨Ù‡ Ú©ÛŒÙÛŒØª Ø§Ø² Ø¯Ø±ØµØ¯',
                fn: () => {
                    return SRS.calculateQuality(100) === 5 &&
                           SRS.calculateQuality(85) === 4 &&
                           SRS.calculateQuality(65) === 3 &&
                           SRS.calculateQuality(45) === 2 &&
                           SRS.calculateQuality(25) === 1 &&
                           SRS.calculateQuality(10) === 0;
                }
            },
            {
                name: 'ØªØ³Øª Û·: ØªØ´Ø®ÛŒØµ Ú©Ø§Ø±Øª Ù†ÛŒØ§Ø² Ø¨Ù‡ Ù…Ø±ÙˆØ±',
                fn: () => {
                    const yesterday = new Date();
                    yesterday.setDate(yesterday.getDate() - 2);
                    return SRS.isDue(yesterday.toISOString(), 1) === true &&
                           SRS.isDue(new Date().toISOString(), 1) === false;
                }
            },
            {
                name: 'ØªØ³Øª Û¸: Ø§ÙˆÙ„ÙˆÛŒØªâ€ŒØ¨Ù†Ø¯ÛŒ - Ú©Ø§Ø±Øª Ø¬Ø¯ÛŒØ¯ Ù…Ù‚Ø¯Ù… Ø§Ø³Øª',
                fn: () => {
                    const cards = [
                        { id: 1, lastReviewDate: '2025-01-01', interval: 5 },
                        { id: 2, lastReviewDate: null, interval: null },
                        { id: 3, lastReviewDate: '2025-01-02', interval: 10 }
                    ];
                    const prioritized = SRS.prioritizeReviews(cards);
                    return prioritized[0].id === 2; // Ú©Ø§Ø±Øª Ø¬Ø¯ÛŒØ¯ Ø§ÙˆÙ„
                }
            },
            {
                name: 'ØªØ³Øª Û¹: Ø®Ø·Ø§ - Ú©ÛŒÙÛŒØª Ø®Ø§Ø±Ø¬ Ø§Ø² Ù…Ø­Ø¯ÙˆØ¯Ù‡',
                fn: () => {
                    try {
                        SRS.calculateNextReview(2.5, 0, 6);
                        return false;
                    } catch(e) {
                        return e.message.includes('Ø¨ÛŒÙ† Û° ØªØ§ Ûµ');
                    }
                }
            },
            {
                name: 'ØªØ³Øª Û±Û°: ÙØ§ØµÙ„Ù‡ Ù…Ø±ÙˆØ± ØªØµØ§Ø¹Ø¯ÛŒ',
                fn: () => {
                    let state = { interval: 1, repetitions: 1, easeFactor: 2.5 };
                    state = SRS.calculateNextReview(state.easeFactor, state.repetitions, 5);
                    const r2 = state.interval;
                    state = SRS.calculateNextReview(state.easeFactor, state.repetitions, 5);
                    const r3 = state.interval;
                    state = SRS.calculateNextReview(state.easeFactor, state.repetitions, 5);
                    const r4 = state.interval;
                    return r2 === 6 && r3 > r2 && r4 > r3; // 6, ~15, ~37
                }
            }
        ];

        // ------------------------------------------------------------
        // Ø§Ø¬Ø±Ø§ÛŒ ØªØ³Øªâ€ŒÙ‡Ø§
        // ------------------------------------------------------------
        function runTests() {
            const resultsDiv = document.getElementById('results');
            const summaryDiv = document.getElementById('summary');
            
            let passed = 0;
            let html = '';

            tests.forEach((test, index) => {
                try {
                    const result = test.fn();
                    if (result) {
                        passed++;
                        html += `<div class="test pass">âœ… ${test.name} <span style="float:left;">âœ“ Ù¾Ø§Ø³</span></div>`;
                    } else {
                        html += `<div class="test fail">âŒ ${test.name} <span style="float:left;">âœ— Failed</span></div>`;
                    }
                } catch(e) {
                    html += `<div class="test fail">âŒ ${test.name} <span style="float:left;">âš ï¸ Ø®Ø·Ø§: ${e.message}</span></div>`;
                }
            });

            summaryDiv.innerHTML = `ğŸ§  SRS Engine: âœ… ${passed} Ø§Ø² ${tests.length} ØªØ³Øª Ù¾Ø§Ø³ Ø´Ø¯`;
            resultsDiv.innerHTML = html;
            
            // Ø®Ù„Ø§ØµÙ‡ Ø¯Ø± console
            console.log(`ğŸ“Š SRS Unit Tests: ${passed}/${tests.length} passed`);
        }

        runTests();
    </script>
</body>
</html>
